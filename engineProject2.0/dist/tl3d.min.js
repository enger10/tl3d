!function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,i)};function i(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}var a=function(){function t(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=1),this.x=0,this.y=0,this.z=0,this.w=1,this.x=t,this.y=e,this.z=i,this.w=a}return t.prototype.normalize=function(){var t=this.length;0!=t&&this.scaleBy(1/t)},Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},enumerable:!1,configurable:!0}),t.prototype.scaleBy=function(t){this.x*=t,this.y*=t,this.z*=t,this.w*=t},t.prototype.divideScalar=function(t){0!=t?(this.x=this.x/t,this.y=this.y/t,this.z=this.z/t):(this.x=0,this.y=0,this.z=0)},t.prototype.distanceToSquared=function(e){return t.distance(this,e)},t.prototype.scaleByW=function(){this.x*=this.w,this.y*=this.w,this.z*=this.w},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.addByNum=function(t,e,i,a){void 0===a&&(a=0),this.x+=t,this.y+=e,this.z+=i,this.w+=a},t.prototype.setTo=function(t,e,i){this.x=t,this.y=e,this.z=i},t.prototype.setByte=function(t){this.x=t.readFloat(),this.y=t.readFloat(),this.z=t.readFloat()},t.prototype.cross=function(e){return new t(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.prototype.clone=function(){return new t(this.x,this.y,this.z)},t.distance=function(t,e){var i=t.x-e.x,a=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+a*a+r*r)},t.prototype.toString=function(){return"Vector3D("+String(this.x)+","+String(this.y)+","+String(this.z)+","+String(this.w)+")"},t.X_AXIS=new t(1,0,0),t.Y_AXIS=new t(0,1,0),t.Z_AXIS=new t(0,0,1),t}(),r=function(){function t(){}return Object.defineProperty(t,"viewMatrx3D",{get:function(){return t._viewMatrx3D},set:function(e){t._viewMatrx3D=e},enumerable:!1,configurable:!0}),t.sceneViewHW=500,t.fileRoot="res/",t.verticalScene=!1,t.effectsLev=2,t.camFar=1e3,t.frameTime=1e3/60,t.MAX_NUMBER=1e7,t.user=0,t.scaleLight=[2],t.useByte=!0,t.fogColor=[0,0,0],t.fogData=[1e3,.003],t.gameAngle=0,t.sceneNumId=0,t.supportBlob=!0,t.SCALE_Z=1/Math.sin(30*Math.PI/180),t}(),n=function(){function t(){}return t.LITTLE_ENDIAN="littleEndian",t.BIG_ENDIAN="bigEndian",t}(),s=function(){function t(t){this.BUFFER_EXT_SIZE=0,this.optcode=0,this.EOF_byte=-1,this.EOF_code_point=-1,this._setArrayBuffer(t||new ArrayBuffer(this.BUFFER_EXT_SIZE)),this.endian=n.BIG_ENDIAN}return t.prototype._setArrayBuffer=function(t){this.write_position=t.byteLength,this.data=new DataView(t),this._position=0},t.prototype.setdata=function(t){this._setArrayBuffer(t.buffer)},Object.defineProperty(t.prototype,"buffer",{get:function(){return this.data.buffer},set:function(t){this.data=new DataView(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dataView",{get:function(){return this.data},set:function(t){this.data=t,this.write_position=t.byteLength},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bufferOffset",{get:function(){return this.data.byteOffset},enumerable:!1,configurable:!0}),t.prototype.getByte=function(t){return this.data.getUint8(t)},t.prototype.setByte=function(t,e){this.data.setUint8(t,e)},Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t,this.write_position=t>this.write_position?t:this.write_position},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this.clear()},Object.defineProperty(t.prototype,"length",{get:function(){return this.write_position},set:function(t){this.validateBuffer(t,!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bytesAvailable",{get:function(){return this.data.byteLength-this._position},enumerable:!1,configurable:!0}),t.prototype.clear=function(){this._setArrayBuffer(new ArrayBuffer(this.BUFFER_EXT_SIZE))},t.prototype.readBoolean=function(){return 0!=this.data.getUint8(this.position++)},t.prototype.readByte=function(){return this.data.getInt8(this.position++)},t.prototype.readBytes=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);for(var a=0;a<i;a++)t.data.setUint8(a+e,this.data.getUint8(this.position++))},t.prototype.readDouble=function(){var e=this.data.getFloat64(this.position,this.endian==n.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_FLOAT64,e},t.prototype.readFloat=function(){var e=this.data.getFloat32(this.position,this.endian==n.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_FLOAT32,e},t.prototype.readInt=function(){var e=this.data.getInt32(this.position,this.endian==n.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_INT32,e},t.prototype.getInt=function(){return this.data.getInt32(this.position,this.endian==n.LITTLE_ENDIAN)},t.prototype.readInt32=function(){return this.readInt()},t.prototype.readShort=function(){this.position,this.data.byteLength;var e=this.data.getInt16(this.position,this.endian==n.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_INT16,e},t.prototype.readFloatTwoByte=function(t){return this.readShort()/t},t.prototype.readFloatOneByte=function(){return(this.readByte()+128)/256},t.prototype.readUnsignedByte=function(){return this.data.getUint8(this.position++)},t.prototype.readUint8=function(){return this.readUnsignedByte()},t.prototype.readInt8=function(){return this.readByte()},t.prototype.readUnsignedInt=function(){var e=this.data.getUint32(this.position,this.endian==n.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT32,e},t.prototype.readUint32=function(){return this.readUnsignedInt()},t.prototype.readUint64=function(){return this.readDouble()},t.prototype.readUnsignedShort=function(){var e=this.data.getUint16(this.position,this.endian==n.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT16,e},t.prototype.readUint16=function(){return this.readUnsignedShort()},t.prototype.readUTF=function(){var e=this.data.getUint16(this.position,this.endian==n.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT16,e>0?this.readUTFBytes(e):""},t.prototype.readString=function(){return this.readUTF()},t.prototype.readUTFBytes=function(t){var e=new Uint8Array(this.buffer,this.bufferOffset+this.position,t);return this.position+=t,this.decodeUTF8(e)},t.prototype.readStringByLen=function(t){return this.readUTFBytes(t)},t.prototype.writeBoolean=function(e){this.validateBuffer(t.SIZE_OF_BOOLEAN),this.data.setUint8(this.position++,e?1:0)},t.prototype.writeByte=function(e){this.validateBuffer(t.SIZE_OF_INT8),this.data.setInt8(this.position++,e)},t.prototype.writeUint8=function(t){this.writeByte(t)},t.prototype.writeInt8=function(t){this.writeByte(t)},t.prototype.writeBytes=function(t,e,i){var a;if(void 0===e&&(e=0),void 0===i&&(i=0),!(e<0)&&!(i<0)&&(a=0==i?t.length-e:Math.min(t.length-e,i))>0){this.validateBuffer(a);for(var r=new DataView(t.buffer),n=e;n<a+e;n++)this.data.setUint8(this.position++,r.getUint8(n))}},t.prototype.writeDouble=function(e){this.validateBuffer(t.SIZE_OF_FLOAT64),this.data.setFloat64(this.position,e,this.endian==n.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT64},t.prototype.writeFloat=function(e){this.validateBuffer(t.SIZE_OF_FLOAT32),this.data.setFloat32(this.position,e,this.endian==n.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT32},t.prototype.writeInt=function(e){this.validateBuffer(t.SIZE_OF_INT32),this.data.setInt32(this.position,e,this.endian==n.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT32},t.prototype.writeInt32=function(t){this.writeInt(t)},t.prototype.writeUnsignedShort=function(e){this.validateBuffer(t.SIZE_OF_INT16),this.data.setInt16(this.position,e,this.endian==n.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT16},t.prototype.writeUint16=function(t){this.writeUnsignedShort(t)},t.prototype.writeUint64=function(e){this.validateBuffer(t.SIZE_OF_FLOAT64),this.data.setFloat64(this.position,e,this.endian==n.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT64},t.prototype.writeShort=function(e){this.validateBuffer(t.SIZE_OF_INT16),this.data.setUint16(this.position,e,this.endian==n.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT16},t.prototype.writeUnsignedInt=function(e){this.validateBuffer(t.SIZE_OF_UINT32),this.data.setUint32(this.position,e,this.endian==n.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT32},t.prototype.writeUint32=function(t){this.writeUnsignedInt(t)},t.prototype.writeUTF=function(e){var i=this.encodeUTF8(e),a=i.length;this.validateBuffer(t.SIZE_OF_UINT16+a),this.data.setUint16(this.position,a,this.endian===n.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT16,this._writeUint8Array(i,!1)},t.prototype.writeString=function(e){var i=new t;i.writeUTFBytes(e),this.writeUint16(i.length+1),this.writeBytes(i,0,i.length),this.writeByte(0)},t.prototype.writeStringByLen=function(t,e){var i=this.position;this.writeUTFBytes(t),this.position=i+e,this.length=this.position+1},t.prototype.readVector3D=function(t){void 0===t&&(t=!1);var e=new a;return e.x=this.readFloat(),e.y=this.readFloat(),e.z=this.readFloat(),t&&(e.w=this.readFloat()),e},t.prototype.writeUTFBytes=function(t){this._writeUint8Array(this.encodeUTF8(t))},t.prototype.toString=function(){return"[ByteArray] length:"+this.length+", bytesAvailable:"+this.bytesAvailable},t.prototype._writeUint8Array=function(t,e){void 0===e&&(e=!0),e&&this.validateBuffer(this.position+t.length);for(var i=0;i<t.length;i++)this.data.setUint8(this.position++,t[i])},t.prototype.validate=function(t){if(this.data.byteLength>0&&this._position+t<=this.data.byteLength)return!0},t.prototype.validateBuffer=function(t,e){if(void 0===e&&(e=!1),this.write_position=t>this.write_position?t:this.write_position,t+=this._position,this.data.byteLength<t||e){var i=new Uint8Array(new ArrayBuffer(t+this.BUFFER_EXT_SIZE)),a=Math.min(this.data.buffer.byteLength,t+this.BUFFER_EXT_SIZE);i.set(new Uint8Array(this.data.buffer,0,a)),this.buffer=i.buffer}},t.prototype.encodeUTF8=function(t){for(var e=0,i=this.stringToCodePoints(t),a=[];i.length>e;){var r=i[e++];if(this.inRange(r,55296,57343))this.encoderError(r);else if(this.inRange(r,0,127))a.push(r);else{var n,s;for(this.inRange(r,128,2047)?(n=1,s=192):this.inRange(r,2048,65535)?(n=2,s=224):this.inRange(r,65536,1114111)&&(n=3,s=240),a.push(this.div(r,Math.pow(64,n))+s);n>0;){var o=this.div(r,Math.pow(64,n-1));a.push(128+o%64),n-=1}}}return new Uint8Array(a)},t.prototype.decodeUTF8=function(t){for(var e,i=0,a="",r=0,n=0,s=0,o=0;t.length>i;){var h=t[i++];if(h===this.EOF_byte)e=0!==n?this.decoderError(!1):this.EOF_code_point;else if(0===n)this.inRange(h,0,127)?e=h:(this.inRange(h,194,223)?(n=1,o=128,r=h-192):this.inRange(h,224,239)?(n=2,o=2048,r=h-224):this.inRange(h,240,244)?(n=3,o=65536,r=h-240):this.decoderError(!1),r*=Math.pow(64,n),e=null);else if(this.inRange(h,128,191))if(s+=1,r+=(h-128)*Math.pow(64,n-s),s!==n)e=null;else{var c=r,l=o;r=0,n=0,s=0,o=0,e=this.inRange(c,l,1114111)&&!this.inRange(c,55296,57343)?c:this.decoderError(!1,h)}else r=0,n=0,s=0,o=0,i--,e=this.decoderError(!1,h);null!==e&&e!==this.EOF_code_point&&(e<=65535?e>0&&(a+=String.fromCharCode(e)):(e-=65536,a+=String.fromCharCode(55296+(e>>10&1023)),a+=String.fromCharCode(56320+(1023&e))))}return a},t.prototype.encoderError=function(t){},t.prototype.decoderError=function(t,e){return e||65533},t.prototype.inRange=function(t,e,i){return e<=t&&t<=i},t.prototype.div=function(t,e){return Math.floor(t/e)},t.prototype.stringToCodePoints=function(t){for(var e=[],i=0,a=t.length;i<t.length;){var r=t.charCodeAt(i);if(this.inRange(r,55296,57343))if(this.inRange(r,56320,57343))e.push(65533);else if(i===a-1)e.push(65533);else{var n=t.charCodeAt(i+1);if(this.inRange(n,56320,57343)){var s=1023&r,o=1023&n;i+=1,e.push(65536+(s<<10)+o)}else e.push(65533)}else e.push(r);i+=1}return e},t.SIZE_OF_BOOLEAN=1,t.SIZE_OF_INT8=1,t.SIZE_OF_INT16=2,t.SIZE_OF_INT32=4,t.SIZE_OF_UINT8=1,t.SIZE_OF_UINT16=2,t.SIZE_OF_UINT32=4,t.SIZE_OF_FLOAT32=4,t.SIZE_OF_FLOAT64=8,t}(),o=function(){function t(){}return t.float2int=function(t){return 0|t},t.radian2angle=function(t){return t/Math.PI*180},t.angle2radian=function(t){return t/180*Math.PI},t.getChiNum=function(e){return t.keyChi[e]},t.hexToArgb=function(t,e,i){return void 0===e&&(e=!0),void 0===i&&(i=null),i||(i=new a),i.w=e?t>>24&255:0,i.x=t>>16&255,i.y=t>>8&255,i.z=255&t,i},t.hexToArgbNum=function(e,i,a){return void 0===i&&(i=!0),void 0===a&&(a=null),(a=t.hexToArgb(e,i,a)).scaleBy(1/255),a},t.getBaseUrl=function(){return r.supportBlob?"":"_base"},t.strokeFilter=function(e,i,a,r){for(var n=t.hexToArgb(r),s=e.getImageData(0,0,i,a),o=s.data,h=new Array,c=1;c<i-1;c++)for(var l=0;l<a-1;l++){var u=p(c,l);0==o[u+3]&&d(c,l)&&h.push(u)}for(c=0;c<h.length;c++)o[h[c]]=n.x,o[h[c]+1]=n.y,o[h[c]+2]=n.z,o[h[c]+3]=n.w;function p(t,e){return 4*(e*i+t)}function d(t,e){var i;return i=p(t-1,e),o[i+3]>0||(i=p(t+1,e),o[i+3]>0||(i=p(t,e+1),o[i+3]>0||(i=p(t,e-1),o[i+3]>0)))}e.putImageData(s,0,0)},t.trim=function(e){return t.trimRight(t.trimLeft(e))},t.trimLeft=function(t){if(null==t)return"";var e=new String(" \t\n\r"),i=new String(t);if(-1!=e.indexOf(i.charAt(0))){for(var a=0,r=i.length;a<r&&-1!=e.indexOf(i.charAt(a));)a++;i=i.substring(a,r)}return i},t.trimRight=function(t){if(null==t)return"";var e=new String(" \t\n\r"),i=new String(t);if(-1!=e.indexOf(i.charAt(i.length-1))){for(var a=i.length-1;a>=0&&-1!=e.indexOf(i.charAt(a));)a--;i=i.substring(0,a+1)}return i},t.TweenMoveTo=function(t,e,i){},t.getScencdStr=function(t){var e=Math.floor(t/60%60),i=Math.floor(t%60);return String(e<10?"0":"")+String(e)+":"+String(i<10?"0":"")+String(i)},t.random=function(t){return Math.floor(Math.random()*t)},t.randomByItem=function(e){return e[t.random(e.length)]},t.makeArray=function(t,e){for(var i=0;i<t.length;i++)e.push(t[i])},t.unZip=function(t){var e=new Uint8Array(t);return new Zlib.Inflate(e).decompress().buffer},t.getZipByte=function(e){var i=e.readInt(),a=e.buffer.slice(e.position,e.position+i);e.position+=i;var r=t.unZip(a);return new s(r)},t.getUrlParam=function(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=window.location.search.substr(1).match(e);return null!=i?decodeURI(i[2]):null},t.copy2clipboard=function(t){var e=document.createElement("textarea");e.style.fontSize="12pt",e.style.position="absolute",e.style["z-index"]=-1,e.style.background="transparent",e.style.border="transparent",e.style.color="white",e.setAttribute("readonly",""),document.body.appendChild(e),e.value=t,e.select(),e.setSelectionRange(0,e.value.length);try{document.execCommand("copy")}catch(t){alert("不支持复制")}setTimeout((function(){document.body.removeChild(e)}),1e3)},t.getBit=function(t,e){return Boolean(t>>(31&e)&1)},t.keyChi=["零","一","二","三","四","五","六","七","八","九","十","十一","十二","十三","十四","十五"],t}(),h=function(){function t(){}return t.getTimer=function(){return Date.now()-t.START_TIME},t.getTimerSecond=function(){return t.getTimer()/1e3},t.saveNowTime=function(){this.lastTime=this.getTimer()},t.getUseTime=function(){return this.getTimer()-this.lastTime},t.getZeroTime=function(t){var e=new Date(1e3*t);return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.getTime()/1e3},t.getLocalTime=function(t){var e=new Date(1e3*t);return e.toLocaleDateString().replace(/\//g,"-")+" "+e.toTimeString().substr(0,5)},t.getLocalTime0=function(t){return new Date(1e3*t).toLocaleDateString().replace(/\//g,"-")},t.getLocalTime1=function(t){var e=new Date(1e3*t);return e.toLocaleDateString().replace(/\//g,"-")+" "+e.toTimeString().substr(0,8)},t.getLocalTime2=function(t){return new Date(1e3*t).toTimeString().substr(0,8)},t.getLocalTime6=function(t){return new Date(1e3*t).toTimeString().substr(0,5)},t.getLocalTime3=function(t){return new Date(1e3*t).toTimeString().substr(3,5)},t.getLocalTime4=function(t){return o.float2int(t/60)+"分"+t%60+"秒"},t.getLocalTime5=function(t){var e=new Date(1e3*t).toTimeString().substr(0,8).split(":");return e[0]+"时"+e[1]+"分"+e[2]+"秒"},t.getDiffTime1=function(t){var e=o.float2int(t/this.dayTime);t-=e*this.dayTime;var i=o.float2int(t/this.HourTime);t-=i*this.HourTime;var a=o.float2int(t/this.MinuteTime);return e+"天"+i+"时"+a+"分"+(t-=a*this.MinuteTime)+"秒"},t.getDiffTime2=function(t){var e=o.float2int(t/this.HourTime);t-=e*this.HourTime;var i=o.float2int(t/this.MinuteTime);return t-=i*this.MinuteTime,this.zeroStr(e)+":"+this.zeroStr(i)+":"+this.zeroStr(t)},t.zeroStr=function(t){return t>9?String(t):"0"+t},t.getDelayTimeStr=function(t){var e=Math.floor(t/3600);return e>24?Math.floor(e/24)+"天前":e>=1?e+"小时前":"刚刚"},t.compareTime=function(t,e){return!1},t.init=function(){t.START_TIME=Date.now()},t.addTimeTick=function(e,i,a){void 0===a&&(a=0);var r=new c;r.alltime=e,r.fun=i,r.time=e-a,t.timefunAry.push(r)},t.removeTimeTick=function(e){for(var i=0;i<t.timefunAry.length;i++)if(t.timefunAry[i]&&t.timefunAry[i].fun==e){t.timefunAry[i]=null;break}},t.addTimeOut=function(e,i){if(!this.hasTimeOut(i)){var a=new l;a.alltime=e,a.fun=i,a.time=0,t.outTimeFunAry.push(a)}},t.removeTimeOut=function(e){for(var i=0;i<t.outTimeFunAry.length;i++)if(t.outTimeFunAry[i]&&t.outTimeFunAry[i].fun==e){t.outTimeFunAry[i]=null;break}},t.hasTimeOut=function(e){for(var i=0;i<t.outTimeFunAry.length;i++)if(t.outTimeFunAry[i]&&t.outTimeFunAry[i].fun==e)return!0;return!1},t.addFrameTick=function(e){-1==t.funAry.indexOf(e)&&t.funAry.push(e)},t.hasFrameTick=function(e){return-1!=t.funAry.indexOf(e)},t.removeFrameTick=function(e){var i=t.funAry.indexOf(e);-1!=i&&(t.funAry[i]=null)},t.update=function(){for(var e=t.getTimer()-t.time,i=0;i<t.funAry.length;i++)t.funAry[i]&&t.funAry[i](e);for(i=0;i<t.timefunAry.length;i++)t.timefunAry[i]&&t.timefunAry[i].update(e);for(i=t.outTimeFunAry.length-1;i>=0;i--)t.outTimeFunAry[i]&&t.outTimeFunAry[i].update(e)&&(t.outTimeFunAry[i]=null);for(i=t.funAry.length-1;i>=0;i--)t.funAry[i]||t.funAry.splice(i,1);for(i=t.timefunAry.length-1;i>=0;i--)t.timefunAry[i]||t.timefunAry.splice(i,1);for(i=t.outTimeFunAry.length-1;i>=0;i--)t.outTimeFunAry[i]||t.outTimeFunAry.splice(i,1);t.time=t.getTimer()},t.funAry=new Array,t.timefunAry=new Array,t.outTimeFunAry=new Array,t.time=0,t.lastTime=0,t.dayTime=86400,t.HourTime=3600,t.MinuteTime=60,t}(),c=function(){function t(){this.alltime=0,this.time=0}return t.prototype.update=function(t){this.time+=t,this.time>=this.alltime&&(this.fun(),this.time=0)},t}(),l=function(){function t(){this.alltime=0,this.time=0}return t.prototype.update=function(t){return this.time+=t,this.time>=this.alltime&&(this.fun(),!0)},t}(),u=function(){function t(){}return t.init=function(t){},t.resetSize=function(t,e){},t.resetViewMatrx3D=function(){},t.unload=function(){},t.needVertical=!0,t.needInputTxt=!1,t.sceneCamScale=1.76,t}(),p=function(){function t(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=1),this.x=0,this.y=0,this.z=0,this.w=1,this.x=t,this.y=e,this.z=i,this.w=a}return t.prototype.print=function(){alert(String(this.x)+" "+String(this.y)+" "+String(this.z)+" "+String(this.w))},t.prototype.toEulerAngles=function(t){void 0===t&&(t=null),t||(t=new a);var e=this.x,i=this.y,r=this.z,n=this.w;return t.x=Math.atan2(2*(n*e+i*r),1-2*(e*e+i*i)),t.y=Math.asin(2*(n*i-r*e)),t.z=Math.atan2(2*(n*r+e*i),1-2*(i*i+r*r)),t},t.prototype.toMatrix3D=function(t){void 0===t&&(t=null),t||(t=new d);var e=t.m,i=this.x,a=this.y,r=this.z,n=this.w,s=i+i,o=a+a,h=r+r,c=i*s,l=a*s,u=a*o,p=r*s,f=r*o,y=r*h,m=n*s,v=n*o,g=n*h;return e[0]=1-u-y,e[1]=l+g,e[2]=p-v,e[3]=0,e[4]=l-g,e[5]=1-c-y,e[6]=f+m,e[7]=0,e[8]=p+v,e[9]=f-m,e[10]=1-c-u,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,t},t.prototype.fromAxisAngle=function(t,e){var i=Math.sin(e/2),a=Math.cos(e/2);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=a,this.normalize()},t.prototype.normalize=function(t){void 0===t&&(t=1);var e=t/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);this.x*=e,this.y*=e,this.z*=e,this.w*=e},t.prototype.fromMatrix=function(t){var e=[0,0,0,0,0,0,0,0,0];e[0]=t.m[0],e[1]=t.m[1],e[2]=t.m[2],e[3]=t.m[4],e[4]=t.m[5],e[5]=t.m[6],e[6]=t.m[8],e[7]=t.m[9],e[8]=t.m[10];var i,a=e[0]+e[4]+e[8],r=[0,0,0,0];if(a>0)i=Math.sqrt(a+1),r[3]=.5*i,i=.5/i,r[0]=(e[5]-e[7])*i,r[1]=(e[6]-e[2])*i,r[2]=(e[1]-e[3])*i;else{var n=0;e[4]>e[0]&&(n=1),e[8]>e[3*n+n]&&(n=2);var s=(n+1)%3,o=(n+2)%3;i=Math.sqrt(e[3*n+n]-e[3*s+s]-e[3*o+o]+1),r[n]=.5*i,i=.5/i,r[3]=(e[3*s+o]-e[3*o+s])*i,r[s]=(e[3*s+n]+e[3*n+s])*i,r[o]=(e[3*o+n]+e[3*n+o])*i}this.x=r[0],this.y=r[1],this.z=r[2],this.w=r[3]},t.prototype.setMd5W=function(){this.w=1-(this.x*this.x+this.y*this.y+this.z*this.z),this.w<0?this.w=0:this.w=-Math.sqrt(this.w)},t.prototype.slerp=function(t,e,i){var a=t.w,r=t.x,n=t.y,s=t.z,o=e.w,h=e.x,c=e.y,l=e.z,u=a*o+r*h+n*c+s*l;if(u<0&&(u=-u,o=-o,h=-h,c=-c,l=-l),u<.95){var p=Math.acos(u),d=1/Math.sin(p),f=Math.sin(p*(1-i))*d,y=Math.sin(p*i)*d;this.w=a*f+o*y,this.x=r*f+h*y,this.y=n*f+c*y,this.z=s*f+l*y}else{this.w=a+i*(o-a),this.x=r+i*(h-r),this.y=n+i*(c-n),this.z=s+i*(l-s);var m=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=m,this.x*=m,this.y*=m,this.z*=m}},t}(),d=function(){function t(){this.isIdentity=!0;this.m=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return t.prototype.clone=function(e){return void 0===e&&(e=null),e||(e=new t),e.m[0]=this.m[0],e.m[1]=this.m[1],e.m[2]=this.m[2],e.m[3]=this.m[3],e.m[4]=this.m[4],e.m[5]=this.m[5],e.m[6]=this.m[6],e.m[7]=this.m[7],e.m[8]=this.m[8],e.m[9]=this.m[9],e.m[10]=this.m[10],e.m[11]=this.m[11],e.m[12]=this.m[12],e.m[13]=this.m[13],e.m[14]=this.m[14],e.m[15]=this.m[15],e},Object.defineProperty(t.prototype,"position",{get:function(){return new a(this.m[12],this.m[13],this.m[14],this.m[15])},enumerable:!1,configurable:!0}),t.prototype.copyTo=function(t){t.m[0]=this.m[0],t.m[1]=this.m[1],t.m[2]=this.m[2],t.m[3]=this.m[3],t.m[4]=this.m[4],t.m[5]=this.m[5],t.m[6]=this.m[6],t.m[7]=this.m[7],t.m[8]=this.m[8],t.m[9]=this.m[9],t.m[10]=this.m[10],t.m[11]=this.m[11],t.m[12]=this.m[12],t.m[13]=this.m[13],t.m[14]=this.m[14],t.m[15]=this.m[15]},t.prototype.identity=function(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=1,this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=1,this.m[11]=0,this.m[12]=0,this.m[13]=0,this.m[14]=0,this.m[15]=1},t.prototype.invert=function(){var t=this.m,e=t[0],i=t[1],a=t[2],r=t[3],n=t[4],s=t[5],o=t[6],h=t[7],c=t[8],l=t[9],u=t[10],p=t[11],d=t[12],f=t[13],y=t[14],m=t[15],v=e*s-i*n,g=e*o-a*n,_=e*h-r*n,x=i*o-a*s,b=i*h-r*s,D=a*h-r*o,w=c*f-l*d,A=c*y-u*d,T=c*m-p*d,M=l*y-u*f,P=l*m-p*f,S=u*m-p*y,I=v*S-g*P+_*M+x*T-b*A+D*w;if(!I)return null;I=1/I,this.m[0]=(s*S-o*P+h*M)*I,this.m[1]=(a*P-i*S-r*M)*I,this.m[2]=(f*D-y*b+m*x)*I,this.m[3]=(u*b-l*D-p*x)*I,this.m[4]=(o*T-n*S-h*A)*I,this.m[5]=(e*S-a*T+r*A)*I,this.m[6]=(y*_-d*D-m*g)*I,this.m[7]=(c*D-u*_+p*g)*I,this.m[8]=(n*P-s*T+h*w)*I,this.m[9]=(i*T-e*P-r*w)*I,this.m[10]=(d*b-f*_+m*v)*I,this.m[11]=(l*_-c*b-p*v)*I,this.m[12]=(s*A-n*M-o*w)*I,this.m[13]=(e*M-i*A+a*w)*I,this.m[14]=(f*g-d*x-y*v)*I,this.m[15]=(c*x-l*g+u*v)*I},t.prototype.invertToMatrix=function(t){var e=this.m,i=e[0],a=e[1],r=e[2],n=e[3],s=e[4],o=e[5],h=e[6],c=e[7],l=e[8],u=e[9],p=e[10],d=e[11],f=e[12],y=e[13],m=e[14],v=e[15],g=i*o-a*s,_=i*h-r*s,x=i*c-n*s,b=a*h-r*o,D=a*c-n*o,w=r*c-n*h,A=l*y-u*f,T=l*m-p*f,M=l*v-d*f,P=u*m-p*y,S=u*v-d*y,I=p*v-d*m,B=g*I-_*S+x*P+b*M-D*T+w*A;if(!B)return null;B=1/B,t.m[0]=(o*I-h*S+c*P)*B,t.m[1]=(r*S-a*I-n*P)*B,t.m[2]=(y*w-m*D+v*b)*B,t.m[3]=(p*D-u*w-d*b)*B,t.m[4]=(h*M-s*I-c*T)*B,t.m[5]=(i*I-r*M+n*T)*B,t.m[6]=(m*x-f*w-v*_)*B,t.m[7]=(l*w-p*x+d*_)*B,t.m[8]=(s*S-o*M+c*A)*B,t.m[9]=(a*M-i*S-n*A)*B,t.m[10]=(f*D-y*x+v*g)*B,t.m[11]=(u*x-l*D-d*g)*B,t.m[12]=(o*T-s*P-h*A)*B,t.m[13]=(i*P-a*T+r*A)*B,t.m[14]=(y*_-f*b-m*g)*B,t.m[15]=(l*b-u*_+p*g)*B},t.prototype.appendTranslation=function(e,i,a){t.tempM.identity(),t.tempM.prependTranslation(e,i,a),this.append(t.tempM)},t.prototype.prependTranslation=function(t,e,i){var a=this.m;a[12]=a[0]*t+a[4]*e+a[8]*i+a[12],a[13]=a[1]*t+a[5]*e+a[9]*i+a[13],a[14]=a[2]*t+a[6]*e+a[10]*i+a[14],a[15]=a[3]*t+a[7]*e+a[11]*i+a[15]},t.prototype.transformVector=function(t){var e=new a;return e.x=this.m[0]*t.x+this.m[4]*t.y+this.m[8]*t.z+this.m[12]*t.w,e.y=this.m[1]*t.x+this.m[5]*t.y+this.m[9]*t.z+this.m[13]*t.w,e.z=this.m[2]*t.x+this.m[6]*t.y+this.m[10]*t.z+this.m[14]*t.w,e.w=this.m[3]*t.x+this.m[7]*t.y+this.m[11]*t.z+this.m[15]*t.w,e},t.prototype.append=function(e){t.tempM.m[0]=e.m[0],t.tempM.m[1]=e.m[1],t.tempM.m[2]=e.m[2],t.tempM.m[3]=e.m[3],t.tempM.m[4]=e.m[4],t.tempM.m[5]=e.m[5],t.tempM.m[6]=e.m[6],t.tempM.m[7]=e.m[7],t.tempM.m[8]=e.m[8],t.tempM.m[9]=e.m[9],t.tempM.m[10]=e.m[10],t.tempM.m[11]=e.m[11],t.tempM.m[12]=e.m[12],t.tempM.m[13]=e.m[13],t.tempM.m[14]=e.m[14],t.tempM.m[15]=e.m[15],t.tempM.prepend(this),this.m[0]=t.tempM.m[0],this.m[1]=t.tempM.m[1],this.m[2]=t.tempM.m[2],this.m[3]=t.tempM.m[3],this.m[4]=t.tempM.m[4],this.m[5]=t.tempM.m[5],this.m[6]=t.tempM.m[6],this.m[7]=t.tempM.m[7],this.m[8]=t.tempM.m[8],this.m[9]=t.tempM.m[9],this.m[10]=t.tempM.m[10],this.m[11]=t.tempM.m[11],this.m[12]=t.tempM.m[12],this.m[13]=t.tempM.m[13],this.m[14]=t.tempM.m[14],this.m[15]=t.tempM.m[15]},t.prototype.prepend=function(t){var e=t.m,i=this.m,a=this.m,r=a[0],n=a[1],s=a[2],o=a[3],h=a[4],c=a[5],l=a[6],u=a[7],p=a[8],d=a[9],f=a[10],y=a[11],m=a[12],v=a[13],g=a[14],_=a[15],x=e[0],b=e[1],D=e[2],w=e[3];i[0]=x*r+b*h+D*p+w*m,i[1]=x*n+b*c+D*d+w*v,i[2]=x*s+b*l+D*f+w*g,i[3]=x*o+b*u+D*y+w*_,x=e[4],b=e[5],D=e[6],w=e[7],i[4]=x*r+b*h+D*p+w*m,i[5]=x*n+b*c+D*d+w*v,i[6]=x*s+b*l+D*f+w*g,i[7]=x*o+b*u+D*y+w*_,x=e[8],b=e[9],D=e[10],w=e[11],i[8]=x*r+b*h+D*p+w*m,i[9]=x*n+b*c+D*d+w*v,i[10]=x*s+b*l+D*f+w*g,i[11]=x*o+b*u+D*y+w*_,x=e[12],b=e[13],D=e[14],w=e[15],i[12]=x*r+b*h+D*p+w*m,i[13]=x*n+b*c+D*d+w*v,i[14]=x*s+b*l+D*f+w*g,i[15]=x*o+b*u+D*y+w*_},t.prototype.appendRotation=function(e,i){t.tempM.identity(),t.tempM.prependRotation(e,i),this.append(t.tempM)},t.prototype.tomat3=function(){var t=Array.prototype.concat.apply([],arguments);t=[1,0,0,0,1,0,0,0,1];var e=new Float32Array(t);return e[0]=this.m[0],e[1]=this.m[1],e[2]=this.m[2],e[3]=this.m[4],e[4]=this.m[5],e[5]=this.m[6],e[6]=this.m[8],e[7]=this.m[9],e[8]=this.m[10],e},t.prototype.getRotaion=function(t){t[0]=this.m[0],t[1]=this.m[1],t[2]=this.m[2],t[3]=this.m[4],t[4]=this.m[5],t[5]=this.m[6],t[6]=this.m[8],t[7]=this.m[9],t[8]=this.m[10]},t.prototype.identityPostion=function(){this.m[12]=0,this.m[13]=0,this.m[14]=0},Object.defineProperty(t.prototype,"x",{get:function(){return this.m[12]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.m[13]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this.m[14]},enumerable:!1,configurable:!0}),t.prototype.prependRotation=function(t,e){var i,a,r,n,s,o,h,c,l,u,p,d,f,y,m,v,g,_,x,b,D,w,A,T,M=this.m,P=this.m,S=e.x,I=e.y,B=e.z,R=Math.sqrt(S*S+I*I+B*B);return Math.abs(R)<1e-6?null:(S*=R=1/R,I*=R,B*=R,i=Math.sin(t*Math.PI/180),r=1-(a=Math.cos(t*Math.PI/180)),n=P[0],s=P[1],o=P[2],h=P[3],c=P[4],l=P[5],u=P[6],p=P[7],d=P[8],f=P[9],y=P[10],m=P[11],v=S*S*r+a,g=I*S*r+B*i,_=B*S*r-I*i,x=S*I*r-B*i,b=I*I*r+a,D=B*I*r+S*i,w=S*B*r+I*i,A=I*B*r-S*i,T=B*B*r+a,M[0]=n*v+c*g+d*_,M[1]=s*v+l*g+f*_,M[2]=o*v+u*g+y*_,M[3]=h*v+p*g+m*_,M[4]=n*x+c*b+d*D,M[5]=s*x+l*b+f*D,M[6]=o*x+u*b+y*D,M[7]=h*x+p*b+m*D,M[8]=n*w+c*A+d*T,M[9]=s*w+l*A+f*T,M[10]=o*w+u*A+y*T,M[11]=h*w+p*A+m*T,P!==M&&(M[12]=P[12],M[13]=P[13],M[14]=P[14],M[15]=P[15]),M)},t.prototype.prependScale=function(t,e,i){var a=this.m,r=this.m;return r[0]=a[0]*t,r[1]=a[1]*t,r[2]=a[2]*t,r[3]=a[3]*t,r[4]=a[4]*e,r[5]=a[5]*e,r[6]=a[6]*e,r[7]=a[7]*e,r[8]=a[8]*i,r[9]=a[9]*i,r[10]=a[10]*i,r[11]=a[11]*i,r[12]=a[12],r[13]=a[13],r[14]=a[14],r[15]=a[15],r},t.prototype.appendScale=function(e,i,a){t.tempM.identity(),t.tempM.prependScale(e,i,a),this.append(t.tempM)},t.prototype.perspectiveFieldOfViewLH=function(t,e,i,a){var r=1/Math.tan(t/2),n=r/e,s=this.m;s[0]=n,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=r,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=a/(a-i),s[11]=1,s[12]=0,s[13]=0,s[14]=i*a/(i-a),s[15]=0},t.prototype.fromVtoV=function(t,e){var i=t.cross(e);i.normalize();var a=Math.acos(t.dot(e)),r=new p;r.fromAxisAngle(i,a),r.toMatrix3D(this)},t.prototype.buildLookAtLH=function(t,e,i){var r=this.m,n=new a;n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z,n.normalize();var s=i.cross(n);s.normalize();var o=n.cross(s);r[0]=s.x,r[1]=o.x,r[2]=n.x,r[3]=0,r[4]=s.y,r[5]=o.y,r[6]=n.y,r[7]=0,r[8]=s.z,r[9]=o.z,r[10]=n.z,r[11]=0,r[12]=-s.dot(t),r[13]=-o.dot(t),r[14]=-n.dot(t),r[15]=1},t.mul=function(t,e,i){var a=e[0],r=e[1],n=e[2],s=e[3],o=e[4],h=e[5],c=e[6],l=e[7],u=e[8],p=e[9],d=e[10],f=e[11],y=e[12],m=e[13],v=e[14];e=e[15];var g=i[0],_=i[1],x=i[2],b=i[3];return t[0]=g*a+_*o+x*u+b*y,t[1]=g*r+_*h+x*p+b*m,t[2]=g*n+_*c+x*d+b*v,t[3]=g*s+_*l+x*f+b*e,g=i[4],_=i[5],x=i[6],b=i[7],t[4]=g*a+_*o+x*u+b*y,t[5]=g*r+_*h+x*p+b*m,t[6]=g*n+_*c+x*d+b*v,t[7]=g*s+_*l+x*f+b*e,g=i[8],_=i[9],x=i[10],b=i[11],t[8]=g*a+_*o+x*u+b*y,t[9]=g*r+_*h+x*p+b*m,t[10]=g*n+_*c+x*d+b*v,t[11]=g*s+_*l+x*f+b*e,g=i[12],_=i[13],x=i[14],b=i[15],t[12]=g*a+_*o+x*u+b*y,t[13]=g*r+_*h+x*p+b*m,t[14]=g*n+_*c+x*d+b*v,t[15]=g*s+_*l+x*f+b*e,t},t.prototype.toEulerAngles=function(t){void 0===t&&(t=null);var e=new p;return e.fromMatrix(this),e.toEulerAngles(t)},t.tempM=new t,t}(),f=function(){function t(){this._eventsMap=null}return t.prototype.addEventListener=function(t,e,i){this._eventsMap||(this._eventsMap=new Object);var a=this._eventsMap[t];a||(a=this._eventsMap[t]=[]);for(var r={listener:e,thisObject:i},n=0;n<a.length;n++){var s=a[n];if(s.listener==e&&s.thisObject==i)return}a.push(r)},t.prototype.removeEventListener=function(t,e,i){if(null!=this._eventsMap)for(var a=this._eventsMap[t],r=0;a&&r<a.length;r++){var n=a[r];if(n.listener==e&&n.thisObject==i)return void a.splice(r,1)}},t.prototype.dispatchEvent=function(t){var e=this._eventsMap;if(!e)return!0;var i=e[t.type];if(!i)return!0;var a=i.length;if(0==a)return!0;t.target=this;for(var r=0;r<a;r++){var n=i[r];n.listener.call(n.thisObject,t)}},t}(),y=function(t){function e(e,i,a){void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=0);var r=t.call(this)||this;return r._x=e,r._y=i,r._z=a,r._scaleX=1,r._scaleY=1,r._scaleZ=1,r._rotationX=0,r._rotationY=0,r._rotationZ=0,r.posMatrix=new d,r}return i(e,t),e.prototype.toStringout=function(){return"Object3D("+String(this._x)+","+String(this._y)+","+String(this._z)+")"},Object.defineProperty(e.prototype,"x",{get:function(){return this._x},set:function(t){this._x=t,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._y},set:function(t){this._y=t,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this._z},set:function(t){this._z=t,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{set:function(t){this._scaleX=this._scaleY=this._scaleZ=t,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scaleX",{get:function(){return this._scaleX},set:function(t){this._scaleX=t,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scaleY",{get:function(){return this._scaleY},set:function(t){this._scaleY=t,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scaleZ",{get:function(){return this._scaleZ},set:function(t){this._scaleZ=t,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationX",{get:function(){return this._rotationX},set:function(t){this._rotationX=t,this.updateMatrix(),this.updateRotationMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationY",{get:function(){return this._rotationY},set:function(t){this._rotationY=t,this.updateMatrix(),this.updateRotationMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationZ",{get:function(){return this._rotationZ},set:function(t){this._rotationZ=t,this.updateMatrix(),this.updateRotationMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"px",{get:function(){return 0},set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"py",{get:function(){return 0},set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pz",{get:function(){return 0},set:function(t){},enumerable:!1,configurable:!0}),e.prototype.updateMatrix=function(){this.posMatrix.identity(),this.posMatrix.appendScale(this._scaleX,this._scaleY,this._scaleZ),this.posMatrix.appendRotation(this._rotationX,a.X_AXIS),this.posMatrix.appendRotation(this._rotationY,a.Y_AXIS),this.posMatrix.appendRotation(this._rotationZ,a.Z_AXIS),this.posMatrix.appendTranslation(this._x,this._y,this._z)},e.prototype.updateRotationMatrix=function(){},e}(f),m=function(t){function e(){var e=t.call(this)||this;return e.sceneVisible=!0,e._hasDestory=!1,e._onStage=!1,e}return i(e,t),e.prototype.update=function(){},Object.defineProperty(e.prototype,"onStage",{get:function(){return this._onStage},enumerable:!1,configurable:!0}),e.prototype.addStage=function(){this._onStage=!0},e.prototype.removeStage=function(){this._onStage=!1},e.prototype.resize=function(){},e.prototype.destory=function(){this.objData&&this.objData.useNum--},e}(y),v=function(){function t(){}return t.prototype.destory=function(){},t}(),g=function(){function t(){}return t.prototype.update=function(t){this.target&&this.target.setDynamic(this)},Object.defineProperty(t.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t},enumerable:!1,configurable:!0}),t.prototype.setTargetInfo=function(t,e,i){this.target=t,this.paramName=e,this.type=i,this.target&&this.target.setDynamicOffset(this),this.currentValue=new Array(i)},t.prototype.setCurrentVal=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var i=0;i<t.length;i++)this.currentValue[i]=t[i]},t}(),_=function(){function t(){}return t.prototype.destory=function(){this.textureRes&&this.textureRes.useNum--,this.target=null},Object.defineProperty(t.prototype,"texture",{get:function(){return this.textureRes?this.textureRes.texture:null},enumerable:!1,configurable:!0}),t}(),x=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._useNum=0,e.idleTime=0,e}return i(e,t),Object.defineProperty(e.prototype,"useNum",{get:function(){return this._useNum},set:function(t){this._useNum=t,0==this._useNum&&(this.idleTime=0)},enumerable:!1,configurable:!0}),e.prototype.clearUseNum=function(){this._useNum--,this._useNum<=0&&(this.idleTime=e.GCTime)},e.GCTime=4,e}(v),b=function(){function t(){var t=this;this._dic=new Object,h.addTimeTick(6e4,(function(){t.gc()}))}return t.prototype.gc=function(){for(var t in this._dic){var e=this._dic[t];e.useNum<=0&&(e.idleTime++,e.idleTime>=x.GCTime&&(e.destory(),delete this._dic[t]))}},t}(),D=function(){function t(){}return t.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t.encode=function(t){var e,i=new Uint8Array(t),a=i.length,r="";for(e=0;e<a;e+=3)r+=this.chars[i[e]>>2],r+=this.chars[(3&i[e])<<4|i[e+1]>>4],r+=this.chars[(15&i[e+1])<<2|i[e+2]>>6],r+=this.chars[63&i[e+2]];return a%3==2?r=r.substring(0,r.length-1)+"=":a%3==1&&(r=r.substring(0,r.length-2)+"=="),r},t.decode=function(t){var e,i,a,r,n,s=.75*t.length,o=t.length,h=0;"="===t[t.length-1]&&(s--,"="===t[t.length-2]&&s--);var c=new ArrayBuffer(s),l=new Uint8Array(c);for(e=0;e<o;e+=4)i=this.chars.indexOf(t[e]),a=this.chars.indexOf(t[e+1]),r=this.chars.indexOf(t[e+2]),n=this.chars.indexOf(t[e+3]),l[h++]=i<<2|a>>4,l[h++]=(15&a)<<4|r>>2,l[h++]=(3&r)<<6|63&n;return c},t}(),w=function(){function t(){this._loadThreadList=new Array,this._waitLoadList=new Array;for(var t=0;t<10;t++)this._loadThreadList.push(new A)}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.getVersion=function(t){return""},t.prototype.load=function(e,i,a,n,s){if(void 0===n&&(n=null),void 0===s&&(s=null),e&&!(e.length<1)&&-1==e.search("undefined")){var o="/"+e.replace(r.fileRoot,""),h=t.getVersion(o);h&&""!=h||(h="0");var c=new T(e,i,a,n,s);c.version=h;for(var l=0;l<this._loadThreadList.length;l++)if(this._loadThreadList[l].idle)return void this._loadThreadList[l].load(c);this._waitLoadList.push(c)}},t.prototype.loadWaitList=function(){if(!(this._waitLoadList.length<=0))for(var t=0;t<this._loadThreadList.length;t++)if(this._loadThreadList[t].idle)return void this._loadThreadList[t].load(this._waitLoadList.shift())},t.BYTE_TYPE="BYTE_TYPE",t.IMG_TYPE="IMG_TYPE",t.XML_TYPE="XML_TYPE",t}(),A=function(){function t(){var t=this;this._xhr=new XMLHttpRequest,this._xhr.onreadystatechange=function(){t._xhr&&4===t._xhr.readyState&&(0===t._xhr.status||200===t._xhr.status?t.loadByteXML():t.loadError())},this._xhr.onprogress=function(e){t._loadInfo.progressFun&&t._loadInfo.progressFun(e.loaded/e.total)},this._xhr.onerror=function(){t.loadError()},this._img=new Image,this._img.onload=function(){t.loadImg()},this._img.onerror=function(){t.loadError()},this.idle=!0}return t.prototype.load=function(t){this._loadInfo=t,this.idle=!1,this._url=t.url,this._loadInfo.type==w.BYTE_TYPE?(this._xhr.open("GET",t.vurl,!0),this._xhr.responseType="arraybuffer",this._xhr.send()):this._loadInfo.type==w.XML_TYPE?(this._xhr.open("GET",t.vurl,!0),this._xhr.responseType="text",this._xhr.send()):this._loadInfo.type==w.IMG_TYPE&&(this._img.url==t.vurl?this.loadImg():(this._img.url=t.vurl,this._img.src=t.vurl))},t.prototype.loadError=function(){this.idle=!0,this._loadInfo=null,w.getInstance().loadWaitList()},t.prototype.loadByteXML=function(){this._loadInfo.info?this._loadInfo.fun(this._xhr.response,this._loadInfo.info):this._loadInfo.fun(this._xhr.response),this.idle=!0,this._loadInfo=null,w.getInstance().loadWaitList()},t.prototype.loadByteImg=function(){this._img.src="data:image/png;base64,"+D.encode(this._xhr.response)},t.prototype.loadImg=function(){this._loadInfo.info?this._loadInfo.fun(this._img,this._loadInfo.info):this._loadInfo.fun(this._img),this.idle=!0,this._loadInfo=null,w.getInstance().loadWaitList()},t}(),T=function(){function t(t,e,i,a,r){void 0===a&&(a=null),void 0===r&&(r=null),this.url=t,this.type=e,this.fun=i,this.info=a,this.progressFun=r}return Object.defineProperty(t.prototype,"vurl",{get:function(){return this.url},enumerable:!1,configurable:!0}),t}(),M=function(){function t(){this._canvas=document.createElement("canvas"),this._canvas.style.zIndex="3",this._canvas.width=200,this._canvas.height=200,this._canvas.style.left=200,this._canvas.style.top=300,this._ctx=this._canvas.getContext("2d"),this._ctx.textBaseline="top"}return t.getInstance=function(){var e=this;return this._instance||(this._instance=new t,t.popClikNameFun=function(t,i){void 0===i&&(i=0),e.uiClikName(t,i)}),this._instance},t.uiClikName=function(t,e){},t.prototype.getContext2D=function(t,e,i){return void 0===i&&(i=!0),this._canvas.width=t,this._canvas.height=e,this._ctx.clearRect(0,0,t,e),(i=!0)&&(this._ctx.textBaseline="top",this._ctx.textAlign="left"),this._ctx},t.prototype.getGrayImageDatabyImg=function(e){var i=t.getInstance().getContext2D(e.width,e.height,!1);i.drawImage(e,0,0);for(var a,r=i.getImageData(0,0,e.width,e.height),n=0;n<r.data.length;n+=4)a=Math.floor(.3*r.data[n+0])+Math.floor(.59*r.data[n+1])+Math.floor(.11*r.data[n+2]),r.data[n+0]=a,r.data[n+1]=a,r.data[n+2]=a;return r},t.prototype.makeCtxToGray=function(t,e){for(var i,a=t.getImageData(e.x,e.y,e.width,e.height),r=0;r<a.data.length;r+=4)i=.5*(i=Math.floor(.3*a.data[r+0])+Math.floor(.59*a.data[r+1])+Math.floor(.11*a.data[r+2]))+.5,a.data[r+0]=i,a.data[r+1]=i,a.data[r+2]=i;t.putImageData(a,e.x,e.y)},t.prototype.showCanvas=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this._canvas.style.left=t,this._canvas.style.top=e,document.getElementById("root").appendChild(this._canvas)},t.cando=!0,t}(),P=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.destory=function(){r.context3D.deleteTexture(this.texture)},e}(x),S=Laya.WebGLContext,I=function(t){function e(){var e=t.call(this)||this;return e._loadDic=new Object,e._resDic=new Object,e.initDefaultLightMapTexture(),e}return i(e,t),e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.hasTexture=function(t){return!!this._dic[t]},e.prototype.getTexture=function(t,e,i,a,r,n){var s=this;if(void 0===i&&(i=0),void 0===a&&(a=null),void 0===r&&(r=0),void 0===n&&(n=0),this._dic[t])return a?e(this._dic[t],a):e(this._dic[t]),void this._dic[t].useNum++;var o=new B(e,a,t,i,r,n);this._loadDic[t]?this._loadDic[t].push(o):(this._loadDic[t]=new Array,this._loadDic[t].push(o),this._resDic[t]?(this.loadTextureCom(this._resDic[t],o),delete this._resDic[t]):w.getInstance().load(t,w.IMG_TYPE,(function(t,e){s.loadTextureCom(t,e)}),o))},e.prototype.getImageData=function(t,e){w.getInstance().load(t,w.IMG_TYPE,(function(t){var i=M.getInstance().getContext2D(t.width,t.height,!1);i.drawImage(t,0,0,t.width,t.height);var a=i.getImageData(0,0,t.width,t.height);e(a)}))},e.prototype.getImgResByurl=function(t){return this._resDic[t]},e.prototype.addRes=function(t,e){this._dic[t]||this._resDic[t]||(this._resDic[t]=e)},e.prototype.addImgRes=function(t,e){this._resDic[t]=e;var i=r.context3D.getTexture(e),a=new P;a.texture=i,a.width=e.width,a.height=e.height,a.useNum++,this._dic[t]=a},e.prototype.getCanvasTexture=function(t){var e=new P,i=r.context3D.getTexture(t.canvas,0,0);return e.texture=i,e},e.prototype.getImageDataTexture=function(t){return r.context3D.getTexture(t,0,0)},e.prototype.getTextureRes=function(t){var e=new P,i=r.context3D.getTexture(t,0,0);return e.texture=i,e},e.prototype.updateTexture=function(t,e,i,a){r.context3D.updateTexture(t,e,i,a.canvas)},e.prototype.loadCubeTexture=function(t,e){(new R).loadCube(t,(function(t){e(t)}))},e.prototype.loadTextureCom=function(t,e){var i=r.context3D.getTexture(t,e.wrap,e.filter,e.mipmap),a=new P;a.texture=i,a.width=t.width,a.height=t.height;for(var n=this._loadDic[e.url],s=0;s<n.length;s++)n[s].info?n[s].fun(a,n[s].info):n[s].fun(a),a.useNum++;delete this._loadDic[e.url],this._dic[e.url]=a},e.prototype.initDefaultLightMapTexture=function(){var t=document.createElement("canvas"),e=t.getContext("2d");t.width=32,t.height=32,e.fillStyle="rgb(51,51,51)",e.fillRect(0,0,32,32),this.defaultLightMap=r.context3D.getTexture(t)},e.prototype.gc=function(){t.prototype.gc.call(this)},e}(b),B=function(t,e,i,a,r,n){this.fun=t,this.info=e,this.url=i,this.wrap=a,this.filter=r,this.mipmap=n},R=function(){function t(){this.ary=new Array(6),this.flagNum=0}return t.prototype.loadCube=function(t,e){var i=this;this.fun=e;for(var a=0;a<6;a++){var r=t+"0"+(a+1)+".jpg";w.getInstance().load(r,w.IMG_TYPE,(function(t,e){i.loadCom(t,e)}),{id:a})}},t.prototype.loadCom=function(t,e){var i=t.width/4,a=document.createElement("canvas"),n=a.getContext("2d");a.width=i,a.height=i;var s=r.context3D.renderContext,o=s.createTexture();s.bindTexture(S.TEXTURE_CUBE_MAP,o),n.drawImage(t,2*i,i,i,i,0,0,i,i),s.texImage2D(S.TEXTURE_CUBE_MAP_POSITIVE_X,0,S.RGBA,S.RGBA,S.UNSIGNED_BYTE,a),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MAG_FILTER,S.LINEAR),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MIN_FILTER,S.LINEAR),n.drawImage(t,0,i,i,i,0,0,i,i),s.texImage2D(S.TEXTURE_CUBE_MAP_NEGATIVE_X,0,S.RGBA,S.RGBA,S.UNSIGNED_BYTE,a),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MAG_FILTER,S.LINEAR),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MIN_FILTER,S.LINEAR),n.drawImage(t,i,0,i,i,0,0,i,i),s.texImage2D(S.TEXTURE_CUBE_MAP_POSITIVE_Y,0,S.RGBA,S.RGBA,S.UNSIGNED_BYTE,a),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MAG_FILTER,S.LINEAR),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MIN_FILTER,S.LINEAR),n.drawImage(t,i,2*i,i,i,0,0,i,i),s.texImage2D(S.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,S.RGBA,S.RGBA,S.UNSIGNED_BYTE,a),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MAG_FILTER,S.LINEAR),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MIN_FILTER,S.LINEAR),n.drawImage(t,i,i,i,i,0,0,i,i),s.texImage2D(S.TEXTURE_CUBE_MAP_POSITIVE_Z,0,S.RGBA,S.RGBA,S.UNSIGNED_BYTE,a),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MAG_FILTER,S.LINEAR),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MIN_FILTER,S.LINEAR),n.drawImage(t,3*i,i,i,i,0,0,i,i),s.texImage2D(S.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,S.RGBA,S.RGBA,S.UNSIGNED_BYTE,a),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MAG_FILTER,S.LINEAR),s.texParameteri(S.TEXTURE_CUBE_MAP,S.TEXTURE_MIN_FILTER,S.LINEAR),this.ary[e.id]=o,this.flagNum++,6==this.flagNum&&this.fun(this.ary)},t}(),F=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.destory=function(){for(var t=0;t<this.dynamicTexList.length;t++)this.dynamicTexList[t].destory();this.dynamicTexList=null,this.dynamicConstList=null},e.prototype.update=function(){if(this.material&&this.dynamicConstList)for(var t=0;t<this.dynamicConstList.length;t++)this.dynamicConstList[t].update()},e.prototype.setData=function(t,e){this.material=t,this.dynamicConstList=new Array,this.dynamicTexList=new Array;for(var i=t.constList,a=t.texList,n=0;n<e.length;n++){var s=e[n];if(0==s.type){var o=new _;o.paramName=s.name;for(var h=0;h<a.length;h++)if(o.paramName==a[h].paramName){o.target=a[h];break}var c=0;o.target&&(c=o.target.mipmap),c=0,I.getInstance().getTexture(r.fileRoot+s.url,(function(t){o.textureRes=t}),0,null,0,c),this.dynamicTexList.push(o)}else{var l=s.name,u=null;for(h=0;h<i.length;h++)if(l==i[h].paramName0||l==i[h].paramName1||l==i[h].paramName2||l==i[h].paramName3){u=i[h];break}var p=new g;p.setTargetInfo(u,l,s.type),1==s.type?p.setCurrentVal(s.x):2==s.type?p.setCurrentVal(s.x,s.y):p.setCurrentVal(s.x,s.y,s.z),this.dynamicConstList.push(p)}}},e}(v),L=function(t){function e(){var e=t.call(this)||this;return e.vertices=new Array,e.uvs=new Array,e.indexs=new Array,e.lightuvs=new Array,e.normals=new Array,e.tangents=new Array,e.bitangents=new Array,e.treNum=0,e.compressBuffer=!1,e.hasdispose=!1,e}return i(e,t),e.prototype.destory=function(){this.vertices.length=0,this.vertices=null,this.uvs.length=0,this.uvs=null,this.indexs.length=0,this.indexs=null,this.lightuvs.length=0,this.lightuvs=null,this.normals.length=0,this.normals=null,this.tangents.length=0,this.tangents=null,this.bitangents.length=0,this.bitangents=null,this.vertexBuffer&&(r.context3D.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null),this.uvBuffer&&(r.context3D.deleteBuffer(this.uvBuffer),this.uvBuffer=null),this.indexBuffer&&(r.context3D.deleteBuffer(this.indexBuffer),this.indexBuffer=null),this.lightUvBuffer&&(r.context3D.deleteBuffer(this.lightUvBuffer),this.lightUvBuffer=null),this.normalsBuffer&&(r.context3D.deleteBuffer(this.normalsBuffer),this.normalsBuffer=null),this.tangentBuffer&&(r.context3D.deleteBuffer(this.tangentBuffer),this.tangentBuffer=null),this.bitangentBuffer&&(r.context3D.deleteBuffer(this.bitangentBuffer),this.bitangentBuffer=null),this.hasdispose=!0},e}(x),C=function(){function t(){}return t.prototype.destory=function(){this.textureRes&&this.textureRes.clearUseNum()},Object.defineProperty(t.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t,this.name="fs"+t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"texture",{get:function(){return this.textureRes?this.textureRes.texture:null},enumerable:!1,configurable:!0}),t.LIGHTMAP=1,t.LTUMAP=2,t.CUBEMAP=3,t.HEIGHTMAP=4,t.REFRACTIONMAP=5,t}(),E=function(){function t(){this.value=new a,this.offset=0}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t,this.name="fc"+t,this.offset=4*t},enumerable:!1,configurable:!0}),t.prototype.creat=function(t){this.vecNum=t,this.vecNum[0+this.offset]=this.value.x,this.vecNum[1+this.offset]=this.value.y,this.vecNum[2+this.offset]=this.value.z,this.vecNum[3+this.offset]=this.value.w},t.prototype.setData=function(t){this.id=t.id,this.value=new a(t.value.x,t.value.y,t.value.z,t.value.w),this.paramName0=t.paramName0,this.param0Type=t.param0Type,this.param0Index=t.param0Index,this.paramName1=t.paramName1,this.param1Type=t.param1Type,this.param1Index=t.param1Index,this.paramName2=t.paramName2,this.param2Type=t.param2Type,this.param2Index=t.param2Index,this.paramName3=t.paramName3,this.param3Type=t.param3Type,this.param3Index=t.param3Index},t.prototype.setDynamicOffset=function(t){this.paramName0==t.paramName?t.targetOffset=this.param0Index+this.offset:this.paramName1==t.paramName?t.targetOffset=this.param1Index+this.offset:this.paramName2==t.paramName?t.targetOffset=this.param2Index+this.offset:this.paramName3==t.paramName&&(t.targetOffset=this.param3Index+this.offset)},t.prototype.setDynamicDirect=function(t,e){this.vecNum.set(t,e)},t.prototype.setDynamic=function(t){try{this.vecNum.set(t.currentValue,t.targetOffset)}catch(t){}},t}(),z=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.texList=new Array,e.constList=new Array,e.killNum=0,e.writeZbuffer=!0,e.fogMode=0,e.fcNum=0,e}return i(e,t),e.prototype.update=function(t){this.updateTime(t),this.updateScene()},e.prototype.updateTime=function(t){this.hasTime&&(this.fcData[1]=t)},e.prototype.updateCam=function(t,e,i){if(this.usePbr||1==this.fogMode){var a=4*this.fcIDAry[0];this.fcData[0+a]=t,this.fcData[1+a]=e,this.fcData[2+a]=i}},e.prototype.updateScene=function(){if(this.sceneNumId!=r.sceneNumId){if(this.sceneNumId=r.sceneNumId,0!=this.fogMode){var t=4*this.fcIDAry[1];this.fcData[0+t]=r.fogColor[0],this.fcData[1+t]=r.fogColor[1],this.fcData[2+t]=r.fogColor[2]}if(this.scaleLightMap){t=4*this.fcIDAry[2];this.fcData[0+t]=r.scaleLight[0]}}},e.prototype.initFcData=function(){if(this.fcData=new Float32Array(4*this.fcNum),!(this.fcNum<=0)){if(this.sceneNumId=r.sceneNumId,(this.hasTime||this.useKill||0!=this.fogMode)&&(this.useKill&&(this.fcData[0]=this.killNum),0!=this.fogMode&&(this.fcData[2]=r.fogData[0],this.fcData[3]=r.fogData[1])),this.usePbr||1==this.fogMode){var t=4*this.fcIDAry[0];this.fcData[0+t]=r.cam3D.x/100,this.fcData[1+t]=r.cam3D.y/100,this.fcData[2+t]=r.cam3D.z/100}if(0!=this.fogMode){t=4*this.fcIDAry[1];this.fcData[0+t]=r.fogColor[0],this.fcData[1+t]=r.fogColor[1],this.fcData[2+t]=r.fogColor[2]}if(this.scaleLightMap){t=4*this.fcIDAry[2];this.fcData[0+t]=r.scaleLight[0]}}},e.prototype.setCompileData=function(t){if(t){if(this.shaderStr=t.shaderStr,this.hasTime=t.hasTime,this.timeSpeed=t.timeSpeed,this.blendMode=t.blendMode,this.backCull=t.backCull,this.killNum=t.killNum,this.hasVertexColor=t.hasVertexColor,this.usePbr=t.usePbr,this.useNormal=t.useNormal,this.roughness=t.roughness,this.writeZbuffer=t.writeZbuffer,this.hasFresnel=t.hasFresnel,this.useDynamicIBL=t.useDynamicIBL,this.normalScale=t.normalScale,this.lightProbe=t.lightProbe,this.useKill=t.useKill,this.directLight=t.directLight,this.noLight=t.noLight,this.scaleLightMap=t.scaleLightMap,this.fogMode=t.fogMode,this.hasParticleColor=!1,this.initFcData(),t.texList){var e=t.texList;this.texList=new Array;for(var i=0;i<e.length;i++){var a=new C;a.id=e[i].id,a.url=e[i].url,a.isDynamic=e[i].isDynamic,a.paramName=e[i].paramName,a.isMain=e[i].isMain,a.isParticleColor=e[i].isParticleColor,a.type=e[i].type,a.wrap=e[i].wrap,a.filter=e[i].filter,a.mipmap=e[i].mipmap,this.texList.push(a),a.isParticleColor&&(this.hasParticleColor=!0)}}if(t.constList)for(e=t.constList,this.constList=new Array,i=0;i<e.length;i++){var r=new E;r.setData(e[i]),r.creat(this.fcData),this.constList.push(r)}}},e.prototype.setByteData=function(t){var e=t,i=e.readInt();if(this.shaderStr=e.readUTF(),this.hasTime=e.readBoolean(),this.timeSpeed=e.readFloat(),this.blendMode=e.readFloat(),this.backCull=e.readBoolean(),this.killNum=e.readFloat(),this.hasVertexColor=e.readBoolean(),this.usePbr=e.readBoolean(),this.useNormal=e.readBoolean(),this.roughness=e.readFloat(),this.writeZbuffer=e.readBoolean(),this.hasFresnel=e.readBoolean(),this.useDynamicIBL=e.readBoolean(),this.normalScale=e.readFloat(),this.lightProbe=e.readBoolean(),this.useKill=e.readBoolean(),this.directLight=e.readBoolean(),this.noLight=e.readBoolean(),this.scaleLightMap=e.readBoolean(),i>2&&(this.fogMode=e.readInt()),i>=22){this.fcNum=e.readByte();var a=e.readByte();this.fcIDAry=new Array;for(var r=0;r<a;r++)this.fcIDAry.push(e.readByte())}this.hasParticleColor=!1,this.initFcData(),this.readTexList(e),this.readConstLis(e)},e.prototype.readConstLis=function(t){var e=t.readInt();this.constList=new Array;for(var i=0;i<e;i++){var r=new E;r.id=t.readFloat(),r.value=new a(t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat()),r.paramName0=t.readUTF(),r.param0Type=t.readFloat(),r.param0Index=t.readFloat(),r.paramName1=t.readUTF(),r.param1Type=t.readFloat(),r.param1Index=t.readFloat(),r.paramName2=t.readUTF(),r.param2Type=t.readFloat(),r.param2Index=t.readFloat(),r.paramName3=t.readUTF(),r.param3Type=t.readFloat(),r.param3Index=t.readFloat(),r.creat(this.fcData),this.constList.push(r)}},e.prototype.readTexList=function(t){var e=t.readInt();this.texList=new Array;for(var i=0;i<e;i++){var a=new C;a.id=t.readFloat(),a.url=t.readUTF(),a.isDynamic=t.readBoolean(),a.paramName=t.readUTF(),a.isMain=t.readBoolean(),a.isParticleColor=t.readBoolean(),a.type=t.readFloat(),a.wrap=t.readFloat(),a.filter=t.readFloat(),a.mipmap=t.readFloat(),a.isParticleColor&&(this.hasParticleColor=!0),this.texList.push(a)}},e.prototype.destory=function(){for(var t=0;t<this.texList.length;t++)this.texList[t].destory();this.texList=null,this.constList=null,this.shader&&this.shader.clearUseNum()},e}(x),V=function(t){function e(){return t.call(this)||this}return i(e,t),e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.getProgram=function(t){return this._dic[t]?this._dic[t]:(alert("please registe Program=>"+t),null)},e.prototype.registe=function(t,e){this._dic[t]||(e.encode(),e.useNum=1,e.name=t,this._dic[t]=e)},e.prototype.getMaterialProgram=function(t,e,i,a,r){void 0===a&&(a=null),void 0===r&&(r=!1);var n=t+"_"+i.url;if(a){for(var s=0;s<a.length;s++)n+="_"+a[s];n+=r?"true_":"false_"}if(this._dic[n])return this._dic[n].useNum++,this._dic[n];r&&(a=[i.usePbr,i.useNormal,i.hasFresnel,i.useDynamicIBL,i.lightProbe,i.directLight,i.noLight,i.fogMode]);var o=new e;o.paramAry=a,o.fragment=i.shaderStr;o.encode();return o.useNum++,this._dic[n]=o,o},e.prototype.outShader=function(t){for(var e=t.split("\n"),i=0;i<e.length;i++){e[i],i<e.length-1?("\\n",'"',"+"):'"'}},e.prototype.gc=function(){t.prototype.gc.call(this)},e}(b),N=function(t){function e(){var e=t.call(this)||this;return e._loadDic=new Object,e._resDic=new Object,e._regDic=new Object,e}return i(e,t),e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.getMaterialByte=function(t,e,i,a,r,n){var s=this;if(void 0===i&&(i=null),void 0===a&&(a=!1),void 0===r&&(r=null),void 0===n&&(n=null),this._dic[t])return i?e(this._dic[t],i):e(this._dic[t]),void this._dic[t].useNum++;var o=new k(e,i,t,a,r,n);this._loadDic[t]?this._loadDic[t].push(o):(this._loadDic[t]=new Array,this._loadDic[t].push(o),this._resDic[t]?(this.meshByteMaterialByt(this._resDic[t],o),this._regDic[t]&&(this._dic[t].useNum+=this._regDic[t],delete this._regDic[t]),delete this._resDic[t]):w.getInstance().load(t,w.BYTE_TYPE,(function(t,e){s.loadMaterialByteCom(t,e)}),o))},e.prototype.meshByteMaterialByt=function(t,e){var i=new z;i.setByteData(t),i.url=e.url,this.loadMaterial(i),e.autoReg&&(i.shader=V.getInstance().getMaterialProgram(e.regName,e.shader3D,i,null,!0),i.program=i.shader.program);for(var a=this._loadDic[e.url],r=0;r<a.length;r++)a[r].info?a[r].fun(i,a[r].info):a[r].fun(i),i.useNum++;delete this._loadDic[e.url],this._dic[e.url]=i},e.prototype.loadMaterialByteCom=function(t,e){var i=new s(t);this.meshByteMaterialByt(i,e)},e.prototype.addResByte=function(t,e){this._dic[t]||this._resDic[t]||(this._resDic[t]=e)},e.prototype.registerUrl=function(t){t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this._dic[t]?this._dic[t].useNum++:this._regDic[t]?this._regDic[t]++:this._regDic[t]},e.prototype.releaseUrl=function(t){t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this._dic[t]&&this._dic[t].clearUseNum()},e.prototype.loadMaterial=function(t){for(var e=t.texList,i=0;i<e.length;i++)e[i].isParticleColor||e[i].isDynamic||0!=e[i].type||I.getInstance().getTexture(r.fileRoot+e[i].url,(function(t,e){e.textureRes=t}),e[i].wrap,e[i],e[i].filter,e[i].mipmap)},e.prototype.loadDynamicTexUtil=function(t){for(var e=t.dynamicTexList,i=0;i<e.length;i++)e[i].isParticleColor?e[i].creatTextureByCurve():I.getInstance().getTexture(r.fileRoot+e[i].url,(function(t,e){e.textureRes=t}),0,e[i],0,1)},e.prototype.gc=function(){t.prototype.gc.call(this)},e}(b),k=function(t,e,i,a,r,n){this.fun=t,this.info=e,this.url=i,this.autoReg=a,this.regName=r,this.shader3D=n},U=function(){function t(t){this.type=t}return t.COMPLETE="complete",t}(),O=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=0,this.y=0,this.x=t,this.y=e}return t.prototype.normalize=function(){var t=this.length;0!=t&&this.scaleBy(1/t)},Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},enumerable:!1,configurable:!0}),t.prototype.scaleBy=function(t){this.x*=t,this.y*=t},t.prototype.sub=function(e){return new t(e.x-this.x,e.y-this.y)},t.prototype.add=function(e){return new t(e.x+this.x,e.y+this.y)},t.prototype.toString=function(){return"Vector2D("+String(this.x)+","+String(this.y)+")"},t.distance=function(t,e){var i=t.x-e.x,a=t.y-e.y;return Math.sqrt(i*i+a*a)},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)},t}(),j=function(){function t(){this._canvas=document.createElement("canvas"),this._cxt=this._canvas.getContext("2d"),this._gnt=this._cxt.createLinearGradient(0,0,128,0),this._canvas.style.zIndex="1"}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getImageData=function(t){for(var e=t.pos.length,i=new a,r=0;r<e;r++)o.hexToArgb(t.color[r],!1,i),this._gnt.addColorStop(t.pos[r]/255,"rgba("+i.x+","+i.y+","+i.z+","+t.alpha[r]+")");return this._cxt.fillStyle=this._gnt,this._cxt.fillRect(0,0,128,2),this._cxt.getImageData(0,0,128,2)},t.prototype.getImageDataByVec=function(t,e){for(var i,a,r=this._cxt.createImageData(64,1),n=0;n<64;n++)i=4*n,a=4*o.float2int(n/64*e),r.data[i]=t[a],r.data[i+1]=t[a+1],r.data[i+2]=t[a+2],r.data[i+3]=t[a+3];return r},t.prototype.setData=function(){},t}(),X=function(){function t(){this.valueV3d=[1,1,1,1]}return t.prototype.getValue=function(t){if(!this.valueVec||-1==this.begintFrame)return this.valueV3d;var e=o.float2int(t/r.frameTime-this.begintFrame);return e<0?e=0:e>this.maxFrame-this.begintFrame&&(e=this.maxFrame-this.begintFrame),this.valueVec[e]},t.prototype.setData=function(t){this.type=t.type,this.maxFrame=t.maxFrame,t.items.length?this.begintFrame=t.items[0].frame:this.begintFrame=-1;for(var e=t.values[0].length,i=new Array,a=0;a<e;a++){var r=new Array;if(1==this.type)r.push(t.values[0][a]);else if(2==this.type)r.push(t.values[0][a],t.values[1][a]);else if(3==this.type)r.push(t.values[0][a],t.values[1][a],t.values[2][a]);else if(4==this.type){var n=t.values[3][a];r.push(t.values[0][a]*n,t.values[1][a]*n,t.values[2][a]*n,n)}i.push(r)}this.valueVec=i},t}(),W=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.destory=function(){t.prototype.destory.call(this),this._textureDynamic&&r.context3D.deleteTexture(this._textureDynamic),this.target=null},e.prototype.initCurve=function(t){this.curve=new X,this.curve.type=t},Object.defineProperty(e.prototype,"texture",{get:function(){return this._textureDynamic?this._textureDynamic:this.textureRes?this.textureRes.texture:null},enumerable:!1,configurable:!0}),e.prototype.creatTextureByCurve=function(){var t=0,e=this.curve.valueVec.length-1,i=new Array;for(t=0;t<this.life;t++)if(t<this.curve.begintFrame)i.push(255*this.curve.valueVec[0][0],255*this.curve.valueVec[0][1],255*this.curve.valueVec[0][2],255*this.curve.valueVec[0][3]);else if(t>this.curve.maxFrame)0==this.curve.maxFrame&&this.curve.begintFrame<0?i.push(255,255,255,255):i.push(255*this.curve.valueVec[e][0],255*this.curve.valueVec[e][1],255*this.curve.valueVec[e][2],255*this.curve.valueVec[e][3]);else if(this.curve.begintFrame<0)i.push(255,255,255,255);else{var a=t-this.curve.begintFrame;i.push(255*this.curve.valueVec[a][0],255*this.curve.valueVec[a][1],255*this.curve.valueVec[a][2],255*this.curve.valueVec[a][3])}var n=j.getInstance().getImageDataByVec(i,this.life);this._textureDynamic=r.context3D.getTexture(n)},Object.defineProperty(e.prototype,"life",{get:function(){return this._life},set:function(t){this._life=t},enumerable:!1,configurable:!0}),e}(_),Y=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.update=function(t){void 0===t&&(t=0),this.currentValue=this.curve.getValue(t),this.target.setDynamic(this)},Object.defineProperty(e.prototype,"type",{set:function(t){this._type=t,this.curve=new X,this.curve.type=t},enumerable:!1,configurable:!0}),e}(g),G=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.destory=function(){this.material.useNum--,this.shader.useNum--,t.prototype.destory.call(this)},e.prototype.setMaterial=function(t){this.material=t,this.materialUrl=t.url,this.dynamicTexList=new Array,this.dynamicConstList=new Array,this.setTexList(),this.setConstList()},e.prototype.setLife=function(t){for(var e=0;e<this.dynamicTexList.length;e++)this.dynamicTexList[e].isParticleColor&&(this.dynamicTexList[e].life=t)},e.prototype.setTexList=function(){for(var t=this.material.texList,e=0;e<t.length;e++){var i;t[e].isParticleColor?((i=new W).target=t[e],i.paramName=t[e].paramName,i.initCurve(4),this.dynamicTexList.push(i),i.isParticleColor=!0):t[e].isDynamic&&((i=new W).target=t[e],i.paramName=t[e].paramName,this.dynamicTexList.push(i))}},e.prototype.setConstList=function(){for(var t=this.material.constList,e=0;e<t.length;e++){var i,a=t[e];0!=a.param0Type&&((i=new Y).setTargetInfo(a,a.paramName0,a.param0Type),this.dynamicConstList.push(i)),0!=a.param1Type&&((i=new Y).setTargetInfo(a,a.paramName1,a.param1Type),this.dynamicConstList.push(i)),0!=a.param2Type&&((i=new Y).setTargetInfo(a,a.paramName2,a.param2Type),this.dynamicConstList.push(i)),0!=a.param3Type&&((i=new Y).setTargetInfo(a,a.paramName3,a.param3Type),this.dynamicConstList.push(i))}},e.prototype.setTextObj=function(t){for(var e=0;e<t.length;e++)for(var i=t[e],a=0;a<this.dynamicTexList.length;a++)if(this.dynamicTexList[a].paramName==i.paramName){this.dynamicTexList[a].isParticleColor?this.dynamicTexList[a].curve.setData(i.curve):this.dynamicTexList[a].url=i.url;break}},e.prototype.setConstObj=function(t){for(var e=0;e<t.length;e++)for(var i=t[e],a=0;a<this.dynamicConstList.length;a++)if(this.dynamicConstList[a].paramName==i.paramName){this.dynamicConstList[a].curve.setData(i.curve);break}},e}(F),Z=function(){function t(){this.dataAry=new Array}return t.prototype.destory=function(){this.dataAry=null},t.prototype.setByteData=function(t){for(var e=t.readFloat(),i=0;i<e;i++){var a=t.readFloat(),n=this.addKeyFrame(a);n.frameNum=a,n.baseValue=new Array;for(var s=0;s<10;s++)n.baseValue.push(t.readFloat());var o=t.readFloat();if(n.animData=new Array,o>0)for(var h=0;h<o;h++)n.animData.push(this.getByteDataTemp(t))}this.maxFrameNum=this.dataAry[this.dataAry.length-1].frameNum,this.beginTime=this.dataAry[0].frameNum*r.frameTime},t.prototype.addKeyFrame=function(t){var e=new Object;return e.frameNum=t,this.dataAry.push(e),e},t.prototype.getByteDataTemp=function(t){var e=new Object,i=t.readInt(),r=t.readInt();e.data=new Array,e.dataByte=new Array;for(var n=0;n<r;n++){var s=new Object;if(s.type=t.readInt(),1==s.type){var o=t.readFloat();e.dataByte.push(o)}if(2==s.type){var h=new a;h.x=t.readFloat(),h.y=t.readFloat(),h.z=t.readFloat(),e.dataByte.push(h)}}return e.type=i,e},t}(),H=function(){},q=function(){function t(){this.baseNum=0,this.num=0,this.time=0,this.speed=0,this.aSpeed=0,this.beginTime=0,this.lastTime=0,this.baseTime=0}return t.prototype.BaseAnim=function(){},t.prototype.update=function(t){this._isDeath||(this.time=t-this.baseTime,this._isActiva?(this.time=this.time-this.beginTime,this.time>this.lastTime&&(this.time=this.lastTime-this.beginTime,this._isDeath=!0),this.coreCalculate()):this.time>=this.beginTime&&(this.time>=this.lastTime?(this.time=this.lastTime-this.beginTime,this.coreCalculate(),this._isDeath=!0):(this.time=this.time-this.beginTime,this.coreCalculate()),this._isActiva=!0))},t.prototype.coreCalculate=function(){this.num=this.speed*this.time+this.aSpeed*this.time*this.time+this.baseNum},t.prototype.reset=function(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.num=0},t.prototype.depthReset=function(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.baseNum=0,this.num=0},Object.defineProperty(t.prototype,"data",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isDeath",{get:function(){return this._isDeath},set:function(t){this._isDeath=t},enumerable:!1,configurable:!0}),t.prototype.getAllNum=function(t){t=Math.min(t,this.lastTime),t-=this.beginTime;var e=this.speed*t+this.aSpeed*t*t;this.baseNum+=e},t}(),K=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),Object.defineProperty(e.prototype,"data",{set:function(t){this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=r.MAX_NUMBER:this.lastTime=Number(t[1].value),this.speed=.1*Number(t[2].value),this.aSpeed=.1*Number(t[3].value)},enumerable:!1,configurable:!0}),e.prototype.dataByte=function(t,e){this.beginTime=e[0],-1==e[1]?this.lastTime=r.MAX_NUMBER:this.lastTime=e[1],this.speed=.1*e[2],this.aSpeed=.1*e[3]},e}(q),Q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),Object.defineProperty(e.prototype,"data",{set:function(t){this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=r.MAX_NUMBER:this.lastTime=Number(t[1].value);var e=String(t[2].value).split("|");this.axis=new a(Number(e[0]),Number(e[1]),Number(e[2])),e=String(t[3].value).split("|"),this.axisPos=new a(100*Number(e[0]),100*Number(e[1]),100*Number(e[2])),this.speed=.1*Number(t[4].value),this.aSpeed=.1*Number(t[5].value)},enumerable:!1,configurable:!0}),e.prototype.dataByte=function(t,e){this.beginTime=Number(e[0]),-1==Number(e[1])?this.lastTime=r.MAX_NUMBER:this.lastTime=Number(e[1]),this.axis=e[2],this.axisPos=e[3],this.speed=.1*e[4],this.aSpeed=.1*e[5]},e}(q),J=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),Object.defineProperty(e.prototype,"data",{set:function(t){this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=r.MAX_NUMBER:this.lastTime=Number(t[1].value);var e=t[2].value.split("|");this.axis=new a(Number(e[0]),Number(e[1]),Number(e[2])),this.axis.normalize(),this.speed=.1*Number(t[3].value),this.aSpeed=.001*Number(t[4].value)},enumerable:!1,configurable:!0}),e.prototype.dataByte=function(t,e){this.beginTime=e[0],-1==e[1]?this.lastTime=r.MAX_NUMBER:this.lastTime=e[1],this.axis=e[2],this.axis.normalize(),this.speed=.1*e[3],this.aSpeed=.001*e[4]},e}(q),$=function(t){function e(){var e=t.call(this)||this;return e.num=1,e}return i(e,t),e.prototype.coreCalculate=function(){this.num=1+this.speed*this.time+this.baseNum,this.num<this.minNum?this.num=this.minNum:this.num>this.maxNum&&(this.num=this.maxNum)},Object.defineProperty(e.prototype,"data",{set:function(t){this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=r.MAX_NUMBER:this.lastTime=Number(t[1].value),this.speed=.001*Number(t[2].value),this.minNum=.01*Number(t[3].value),this.maxNum=.01*Number(t[4].value)},enumerable:!1,configurable:!0}),e.prototype.dataByte=function(t,e){this.beginTime=e[0],-1==e[1]?this.lastTime=r.MAX_NUMBER:this.lastTime=e[1],this.speed=.001*e[2],this.minNum=.01*e[3],this.maxNum=.01*e[4]},e.prototype.getAllNum=function(t){t=Math.min(t,this.lastTime),t-=this.beginTime;var e=this.speed*t;this.baseNum+=e,this.baseNum<this.minNum?this.baseNum=this.minNum:e>this.maxNum&&(this.baseNum=this.maxNum)},e.prototype.reset=function(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.num=1},e.prototype.depthReset=function(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.baseNum=0,this.num=1},e}(q),tt=function(t){function e(){var e=t.call(this)||this;return e.num=1,e}return i(e,t),e.prototype.update=function(t){this._isDeath||(this.time=t-this.baseTime,this._isActiva?(this.coreCalculate(),this.time>this.lastTime&&(this._isDeath=!0)):this.time>=this.beginTime&&(this._isActiva=!0))},e.prototype.coreCalculate=function(){var t=o.float2int(this.time/r.frameTime);t>=this.numAry.length?this.num=this.numAry[this.numAry.length-1]:this.num=this.numAry[t]},e.prototype.reset=function(){t.prototype.reset.call(this),this.num=1},e.prototype.depthReset=function(){t.prototype.depthReset.call(this),this.num=1},Object.defineProperty(e.prototype,"data",{set:function(t){this.numAry=new Array,this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=r.MAX_NUMBER:this.lastTime=Number(t[1].value),this.beginScale=Number(t[2].value),this.scaleNum=Number(t[3].value),this.scaleAry=new Array;for(var e,i=0,a=4;a<4+2*this.scaleNum;a+=2){var n=new Object;n.value=Number(t[a].value),n.time=Number(t[a+1].value),i+=n.time,n.beginTime=this.beginTime+i,this.scaleAry.push(n)}var s=0,o=1;this.scaleAry.length?(e=(this.scaleAry[this.scaleAry.length-1].beginTime+this.scaleAry[this.scaleAry.length-1].time)/r.frameTime,o=this.scaleAry[0].beginTime,this._currentTarget=this.scaleAry[0]):e=0;var h=0;for(a=0;a<e;a++){var c=r.frameTime*a;c>=this._currentTarget.beginTime&&(this.beginScale=this._currentTarget.value,s=this._currentTarget.beginTime,h==this.scaleAry.length-1?this._currentTarget=this.scaleAry[this.scaleAry.length-1]:(h++,this._currentTarget=this.scaleAry[h]),o=this._currentTarget.time);var l=(c-s)/o*(this._currentTarget.value-this.beginScale)+this.beginScale;this.numAry.push(l)}this._currentTarget=this.scaleAry[0]},enumerable:!1,configurable:!0}),e.prototype.dataByte=function(t,e){this.numAry=new Array,this.beginTime=e[0],-1==e[1]?this.lastTime=r.MAX_NUMBER:this.lastTime=e[1],this.beginScale=e[2],this.scaleNum=e[3],this.scaleAry=new Array;for(var i,a=0,n=4;n<4+2*this.scaleNum;n+=2){var s=new Object;s.value=e[n],s.time=e[n+1],a+=s.time,s.beginTime=this.beginTime+a,this.scaleAry.push(s)}var o=0,h=1;this.scaleAry.length?(i=(this.scaleAry[this.scaleAry.length-1].beginTime+this.scaleAry[this.scaleAry.length-1].time)/r.frameTime,h=this.scaleAry[0].beginTime,this._currentTarget=this.scaleAry[0]):i=0;var c=0;for(n=0;n<i;n++){var l=r.frameTime*n;l>=this._currentTarget.beginTime&&(this.beginScale=this._currentTarget.value,o=this._currentTarget.beginTime,c==this.scaleAry.length-1?this._currentTarget=this.scaleAry[this.scaleAry.length-1]:(c++,this._currentTarget=this.scaleAry[c]),h=this._currentTarget.time);var u=(l-o)/h*(this._currentTarget.value-this.beginScale)+this.beginScale;this.numAry.push(u)}this._currentTarget=this.scaleAry[0]},e.prototype.getAllNum=function(t){t=Math.min(t,this.lastTime+this.beginTime);var e=this.scaleAry[this.scaleAry.length-1];if(t>=e.beginTime+e.time)this.baseNum=e.value;else{for(var i,a=0;a<this.scaleAry.length;a++)t>this.scaleAry[a].this.beginTime&&(this._currentTarget=this.scaleAry[a],this.beginTime=this._currentTarget.this.beginTime,this.beginScale=this._currentTarget.value,i=a);i++,this._currentTarget=this.scaleAry[i],this.baseNum=(this._currentTarget.value-this.beginScale)/this._currentTarget.this.time*(t-this.beginTime)+this.beginScale}},e}(q),et=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.coreCalculate=function(){this.num=this.amplitude+this.amplitude*Math.sin(this.speed*this.time)},Object.defineProperty(e.prototype,"data",{set:function(t){this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=r.MAX_NUMBER:this.lastTime=Number(t[1].value),this.amplitude=Number(t[2].value),this.speed=.01*Number(t[3].value)},enumerable:!1,configurable:!0}),e.prototype.dataByte=function(t,e){this.beginTime=e[0],-1==e[1]?this.lastTime=r.MAX_NUMBER:this.lastTime=e[1],this.amplitude=e[2],this.speed=.01*e[3]},e.prototype.getAllNum=function(t){this.baseNum=this.amplitude+this.amplitude*Math.sin(this.speed*t)},e}(q),it=function(t){function e(){var e=t.call(this)||this;return e._time=0,e.targetFlag=-1,e.beginTime=0,e.isByteData=!1,e.targetFlag=-1,e.visible=!1,e.maxFrameNum=0,e._time=0,e._keyFrameAry=new Array,e}return i(e,t),e.prototype.updateMatrix=function(t,e){this._axisMove&&t.prependTranslation(this._axisMove.axis.x*this._axisMove.num,this._axisMove.axis.y*this._axisMove.num,this._axisMove.axis.z*this._axisMove.num),this._axisRotaion&&t.prependRotation(this._axisRotaion.num,this._axisRotaion.axis),t.prependTranslation(e.data.center.x,e.data.center.y,e.data.center.z),this._scaleChange?t.prependScale(e.data._widthFixed?1:this._scaleChange.num,e.data._heightFixed?1:this._scaleChange.num,e.data._widthFixed?1:this._scaleChange.num):this._scaleNosie?t.prependScale(e.data._widthFixed?1:1+this._scaleNosie.num,e.data._heightFixed?1:1+this._scaleNosie.num,e.data._widthFixed?1:1+this._scaleNosie.num):this._scaleAnim&&t.prependScale(e.data._widthFixed?1:this._scaleAnim.num,e.data._heightFixed?1:this._scaleAnim.num,e.data._widthFixed?1:this._scaleAnim.num),t.prependRotation(e.data.rotationV3d.z,a.Z_AXIS),t.prependRotation(e.data.rotationV3d.y,a.Y_AXIS),t.prependRotation(e.data.rotationV3d.x,a.X_AXIS)},e.prototype.inverAxisRotation=function(t){this._axisRotaion&&t.prependRotation(-this._axisRotaion.num,this._axisRotaion.axis)},e.prototype.applySelfRotation=function(t,e){this._selfRotaion&&t.prependRotation(this._selfRotaion.num,e)},e.prototype.addKeyFrame=function(t){var e=new H;return e.frameNum=t,this._keyFrameAry.push(e),e},e.prototype.updateTime=function(t){this._currentKeyFrame&&(this._time=t,this.getTarget(),this._axisRotaion&&this._axisRotaion.update(this._time),this._selfRotaion&&this._selfRotaion.update(this._time),this._axisMove&&this._axisMove.update(this._time),this._scaleChange?this._scaleChange.update(this._time):this._scaleNosie?this._scaleNosie.update(this._time):this._scaleAnim&&this._scaleAnim.update(this._time))},e.prototype.getTarget=function(){for(var t=-1,e=0;e<this._keyFrameAry.length&&this._keyFrameAry[e].frameNum*r.frameTime<this._time;e++)t=e;t!=this.targetFlag&&(this._currentKeyFrame=this._keyFrameAry[t],this.targetFlag=t,t>=this._keyFrameAry.length-1||!this._currentKeyFrame?(this.visible=!1,this._currentKeyFrame=null):(this.visible=!0,this.enterKeyFrame(this._currentKeyFrame.animData,this._currentKeyFrame.frameNum*r.frameTime,this._currentKeyFrame.baseValue)))},e.prototype.enterKeyFrame=function(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=null),null!=i){for(var a=0;a<10;a++)if(i[a])switch(a){case 1:this._selfRotaion||(this._selfRotaion=new K),this._selfRotaion.num=this._selfRotaion.baseNum=i[a];break;case 2:this._axisRotaion||(this._axisRotaion=new Q),this._axisRotaion.num=this._axisRotaion.baseNum=i[a];break;case 6:this._scaleChange||(this._scaleChange=new $),this._scaleChange.num=this._scaleChange.baseNum=i[a];break;case 7:this._scaleAnim||(this._scaleAnim=new tt),this._scaleAnim.num=this._scaleAnim.baseNum=i[a];break;case 8:this._scaleNosie||(this._scaleNosie=new et),this._scaleNosie.num=this._scaleNosie.baseNum=i[a];break;case 9:this._axisMove||(this._axisMove=new J),this._axisMove.num=this._axisMove.baseNum=i[a]}this._selfRotaion&&(this._selfRotaion.isDeath=!0),this._axisRotaion&&(this._axisRotaion.isDeath=!0),this._scaleChange&&(this._scaleChange.isDeath=!0),this._scaleAnim&&(this._scaleAnim.isDeath=!0),this._scaleNosie&&(this._scaleNosie.isDeath=!0),this._axisMove&&(this._axisMove.isDeath=!0),t&&this.setBaseTimeByte(t,e,i)}},e.prototype.reset=function(){this._time=0,this._currentKeyFrame=this._keyFrameAry[0],this.visible=!1,this.targetFlag=-1},e.prototype.setAllByteInfo=function(t,e){this.isByteData=!0;for(var i=t.readFloat(),a=0;a<i;a++){var n=t.readFloat(),s=this.addKeyFrame(n);s.frameNum=n,s.baseValue=new Array;for(var o=0;o<10;o++)s.baseValue.push(t.readFloat());var h=t.readFloat();if(s.animData=new Array,h>0)for(var c=0;c<h;c++)s.animData.push(this.getByteDataTemp(t))}this.maxFrameNum=this._keyFrameAry[this._keyFrameAry.length-1].frameNum,this.beginTime=this._keyFrameAry[0].frameNum*r.frameTime,this._currentKeyFrame=this._keyFrameAry[0]},e.prototype.setAllDataInfo=function(t){this.isByteData=!0;for(var e=t.dataAry.length,i=0;i<e;i++){var a=this.addKeyFrame(t.dataAry[i].frameNum);a.baseValue=t.dataAry[i].baseValue,a.animData=t.dataAry[i].animData}this.maxFrameNum=t.maxFrameNum,this.beginTime=t.beginTime,this._currentKeyFrame=this._keyFrameAry[0]},e.prototype.setBaseTimeByte=function(t,e,i){void 0===e&&(e=0);for(var a=0;a<t.length;a++)1==t[a].type?(this._selfRotaion?this._selfRotaion.reset():this._selfRotaion=new K,this._selfRotaion.dataByte(t[a].data,t[a].dataByte),this._selfRotaion.baseTime=e):2==t[a].type?(this._axisRotaion?this._axisRotaion.reset():this._axisRotaion=new Q,this._axisRotaion.dataByte(t[a].data,t[a].dataByte),this._axisRotaion.baseTime=e):6==t[a].type?(this._scaleChange?this._scaleChange.reset():this._scaleChange=new $,this._scaleChange.dataByte(t[a].data,t[a].dataByte),this._scaleChange.baseTime=e):7==t[a].type?(this._scaleAnim?this._scaleAnim.reset():this._scaleAnim=new tt,this._scaleAnim.dataByte(t[a].data,t[a].dataByte),this._scaleAnim.baseTime=e):8==t[a].type?(this._scaleNosie?this._scaleNosie.reset():this._scaleNosie=new et,this._scaleNosie.dataByte(t[a].data,t[a].dataByte),this._scaleNosie.baseTime=e):9==t[a].type&&(this._axisMove?this._axisMove.reset():this._axisMove=new J,this._axisMove.dataByte(t[a].data,t[a].dataByte),this._axisMove.baseTime=e)},e.prototype.getByteDataTemp=function(t){var e=new Object,i=t.readInt(),r=t.readInt();e.data=new Array,e.dataByte=new Array;for(var n=0;n<r;n++){var s=new Object;if(s.type=t.readInt(),1==s.type){var o=t.readFloat();e.dataByte.push(o)}if(2==s.type){var h=new a;h.x=t.readFloat(),h.y=t.readFloat(),h.z=t.readFloat(),e.dataByte.push(h)}}return e.type=i,e},e.prototype.getMaxFrame=function(){return this._keyFrameAry[this._keyFrameAry.length-1].frameNum},e.prototype.dispose=function(){},e}(f),at=function(){function t(){this._delayedTime=0,this._width=100,this._height=100,this._originWidthScale=.5,this._originHeightScale=.5,this._eyeDistance=0,this._watchEye=!1,this._isZiZhuan=!1,this.overAllScale=1}return t.prototype.destory=function(){this.objData&&this.objData.destory(),this.materialParam.destory(),this.timelineData.destory(),this.timelineData=null},t.prototype.uploadGpu=function(){},t.prototype.regShader=function(){},t.prototype.initVcData=function(){},t.prototype.creatPartilce=function(){var t=this.getParticle();t.data=this;var e=new it;return e.setAllDataInfo(this.timelineData),t.setTimeLine(e),t.onCreated(),t},t.prototype.getParticle=function(){return null},t.prototype.setAllByteInfo=function(t){this.timelineData=new Z,this.timelineData.setByteData(t),this._beginTime=this.timelineData.beginTime,this.version>=15&&(this._delayedTime=t.readFloat()),this._width=t.readFloat(),this._height=t.readFloat(),this._widthFixed=t.readBoolean(),this._heightFixed=t.readBoolean(),this._originWidthScale=t.readFloat(),this._originHeightScale=t.readFloat(),this._eyeDistance=t.readFloat(),this._alphaMode=t.readFloat(),this._uSpeed=t.readFloat(),this._vSpeed=t.readFloat(),this._animLine=t.readFloat(),this._animRow=t.readFloat(),this._animInterval=t.readFloat(),this._renderPriority=t.readFloat(),this._distortion=t.readBoolean(),this._isUV=t.readBoolean(),this._isU=t.readBoolean(),this._isV=t.readBoolean(),this._life=t.readFloat(),this._life=this._life>1e4?r.MAX_NUMBER:this._life,this._watchEye=t.readBoolean(),this._ziZhuanAngly=new a,this._ziZhuanAngly.x=t.readFloat(),this._ziZhuanAngly.y=t.readFloat(),this._ziZhuanAngly.z=t.readFloat(),this._ziZhuanAngly.w=t.readFloat(),this.rotationV3d=new a,this.rotationV3d.x=t.readFloat(),this.rotationV3d.y=t.readFloat(),this.rotationV3d.z=t.readFloat(),this.center=new a,this.center.x=t.readFloat(),this.center.y=t.readFloat(),this.center.z=t.readFloat(),this.center.w=t.readFloat(),this.overAllScale=t.readFloat(),!this._ziZhuanAngly||0==this._ziZhuanAngly.x&&0==this._ziZhuanAngly.y&&0==this._ziZhuanAngly.z||(this._isZiZhuan=!0),this.readMaterialPara(t);var e=t.readUTF();e=(e=e.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this.materialByteUrl=e},Object.defineProperty(t.prototype,"materialByteUrl",{set:function(t){var e=this;this._materialUrl!=t&&(this._materialUrl=t,N.getInstance().getMaterialByte(r.fileRoot+t,(function(t){e.onMaterialLoad(t)})))},enumerable:!1,configurable:!0}),t.prototype.onMaterialLoad=function(t){this.materialParam=new G,this.materialParam.setMaterial(t),this.materialParam.setLife(this._life),this.materialParamData&&(this.materialParam.setTextObj(this.materialParamData.texAry),this.materialParam.setConstObj(this.materialParamData.conAry)),N.getInstance().loadDynamicTexUtil(this.materialParam),this.regShader()},t.prototype.readMaterialPara=function(t){this.materialParamData=new Object;t.readUTF();var e=t.readInt();this.materialParamData.texAry=new Array;for(var i=0;i<e;i++){var a=new Object;a.isParticleColor=t.readBoolean(),a.paramName=t.readUTF(),a.url=t.readUTF(),a.isParticleColor&&(a.curve=new Object,this.readTempCurve(t,a.curve)),this.materialParamData.texAry.push(a)}this.readMaterialParaConAry(t)},t.prototype.readTempCurve=function(t,e){e.values=new Array;var i=!1;if(this.version>=12){var a=t.readInt();if(a>0)var r=t.readFloat();for(var n=0;n<a;n++){for(var s=t.readInt(),o=new Array,h=0;h<s;h++)o.push(t.readByte()/127*r);e.values.push(o)}i=!0}e.type=t.readFloat(),e.maxFrame=t.readFloat(),e.sideType=t.readBoolean(),e.speedType=t.readBoolean(),e.useColorType=t.readBoolean(),e.items=this.readItems(t),i||this.makeCurveData(e)},t.prototype.readItems=function(t){for(var e=new Array,i=t.readInt(),a=0;a<i;a++){var r=new Object;r.frame=t.readInt(),r.vec3=t.readVector3D(!0),r.rotation=t.readVector3D(!0),r.rotationLeft=t.readVector3D(!0),e.push(r)}return e},t.prototype.makeCurveData=function(t){for(var e=t.items,i=new Array,a=new Array,r=new Array,n=new Array,s=0;s<e.length;s++)if(s==e.length-1)i.push(e[s].vec3.x),a.push(e[s].vec3.y),r.push(e[s].vec3.z),n.push(e[s].vec3.w);else{var o=e[s+1].frame-e[s].frame,h=e[s].vec3,c=e[s+1].vec3,l=t.items[s].rotation,u=t.items[s+1].rotationLeft;i=i.concat(this.getBzData(h.x,c.x,l.x,u.x,o)),a=a.concat(this.getBzData(h.y,c.y,l.y,u.y,o)),r=r.concat(this.getBzData(h.z,c.z,l.z,u.z,o)),n=n.concat(this.getBzData(h.w,c.w,l.w,u.w,o))}t.values=new Array,t.values[0]=i,t.values[1]=a,t.values[2]=r,t.values[3]=n},t.prototype.getBzData=function(t,e,i,r,n){var s=new O(0,10*t),o=new O(n,10*e),h=new d,c=new a;h.identity(),h.appendRotation(-i,a.Z_AXIS),c=h.transformVector(new a(n/2,0,0));var l=new O(n/2,s.y+c.y);h.identity(),h.appendRotation(-r,a.Z_AXIS),c=h.transformVector(new a(-n/2,0,0));for(var u=[s,l,new O(n/2,o.y+c.y),o],p=new Array,f=1;f<3*n;f++)p.push(this.drawbezier(u,f/(3*n)));var y=new Array;for(f=0;f<n;f++)for(var m=0;m<p.length;m++)if(p[m].x>=f){y.push(p[m].y/10);break}return y},t.prototype.drawbezier=function(t,e){var i=new Array;if(0==t.length)return new O;for(var a in t)i.push(new O(t[a].x,t[a].y));for(;i.length>1;){for(var r=0;r<i.length-1;r++)this.mathmidpoint(i[r],i[r+1],e);i.pop()}return i[0]},t.prototype.mathmidpoint=function(t,e,i){var a,r;a=t.x+(e.x-t.x)*i,r=t.y+(e.y-t.y)*i,t.x=a,t.y=r},t.prototype.readMaterialParaConAry=function(t){for(var e=new Array,i=t.readInt(),a=0;a<i;a++){var r=new Object;r.type=t.readFloat(),r.indexID=t.readFloat(),r.paramName=t.readUTF(),r.curve=new Object,this.readTempCurve(t,r.curve),e.push(r)}this.materialParamData.conAry=e},t.prototype.setFloat32Vec=function(t,e){},t.prototype.setFloat32Mat=function(t,e){},t}(),rt=function(t){function e(){var e=t.call(this)||this;return e.isInGroup=!1,e.visible=!0,e._rotationMatrix=new d,e.modelMatrix=new d,e}return i(e,t),e.prototype.onCreated=function(){},e.prototype.setBind=function(t,e,i,a,r){this.bindVecter3d=t,this.bindMatrix=e,this.bindScale=i,this.invertBindMatrix=a,this.groupMatrix=r},e.prototype.getMulBindList=function(){return null},e.prototype.updateMatrix=function(){this.bindMatrix&&(this.modelMatrix.identity(),this.groupMatrix.isIdentity||this.posMatrix.append(this.groupMatrix),this.modelMatrix.append(this.posMatrix),this.modelMatrix.append(this.bindMatrix),this.modelMatrix.appendTranslation(this.bindVecter3d.x,this.bindVecter3d.y,this.bindVecter3d.z))},Object.defineProperty(e.prototype,"cantUseEffectsLev",{get:function(){return!(this.data._renderPriority<=r.effectsLev)},enumerable:!1,configurable:!0}),e.prototype.updateTime=function(t){this.cantUseEffectsLev||(this._time=t-this._beginTime,this._time+=this.data._delayedTime,this.timeline.updateTime(t),this.visible=this.timeline.visible,this.posMatrix.identity(),this.posMatrix.prependScale(.1*this._scaleX*this.bindScale.x*this.data.overAllScale,.1*this._scaleY*this.bindScale.y*this.data.overAllScale,.1*this._scaleZ*this.bindScale.z*this.data.overAllScale),this.timeline.updateMatrix(this.posMatrix,this))},e.prototype.reset=function(){this.timeline.reset(),this.updateTime(0)},e.prototype.clearAllAnim=function(){},e.prototype.update=function(){this.cantUseEffectsLev||this.visible&&this.data.materialParam&&(0==this.data._alphaMode&&(this.data._alphaMode=-1),r.context3D.setBlendParticleFactors(this.data._alphaMode),r.context3D.cullFaceBack(this.data.materialParam.material.backCull),this.data.materialParam&&r.context3D.setProgram(this.data.materialParam.program),this.updateMatrix(),this.setVc(),this.setVa(),this.resetVa())},e.prototype.setVc=function(){},e.prototype.pushVc=function(){r.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData)},e.prototype.setVa=function(){},e.prototype.resetVa=function(){},e.prototype.setMaterialVc=function(){if(this.data.materialParam){for(var t=this.data.materialParam.dynamicConstList,e=this._time%(r.frameTime*this.data._life),i=0;i<t.length;i++)t[i].update(e);this.data.materialParam.material.fcNum<=0||(e*=this.data.materialParam.material.timeSpeed,this.data.materialParam.material.update(e),r.context3D.setVc4fv(this.data.materialParam.shader,"fc",this.data.materialParam.material.fcData))}},e.prototype.setMaterialTexture=function(){if(this.data.materialParam){for(var t=this.data.materialParam.material.texList,e=0;e<t.length;e++)t[e].isDynamic||r.context3D.setRenderTexture(this.data.materialParam.shader,t[e].name,t[e].texture,t[e].id,!0);var i=this.data.materialParam.dynamicTexList;for(e=0;e<i.length;e++)r.context3D.setRenderTexture(this.data.materialParam.shader,i[e].target.name,i[e].texture,i[e].target.id,!0)}},e.prototype.inverBind=function(){this.invertBindMatrix.isIdentity||this._rotationMatrix.prepend(this.invertBindMatrix)},e.prototype.resetPos=function(){},e.prototype.resetMulPos=function(t){},e.prototype.getVector3DByObject=function(t){return t?new a(t.x,t.y,t.z,t.w):null},e.prototype.clone=function(){return null},e.prototype.setAllByteInfo=function(t,e){void 0===e&&(e=0),this.creatData(),this.data.version=e,this.data.setAllByteInfo(t),this.timeline=new it,this.timeline.setAllDataInfo(this.data.timelineData),this._beginTime=this.timeline.beginTime},e.prototype.creatData=function(){this.data=new at},e.prototype.setTimeLine=function(t){this.timeline=t,this._beginTime=t.beginTime},e.prototype.destory=function(){this.timeline=null,this.bindMatrix=null,this.bindVecter3d=null,this.bindScale=null,this.invertBindMatrix=null,this.groupMatrix=null,this._rotationMatrix=null,this.modelMatrix=null,this.groupPos=null,this.groupScale=null,this.groupRotation=null},e}(y),nt=function(t){function e(){var e=t.call(this)||this;return e.fragment=e.getFragmentShaderString(),e}return i(e,t),e.prototype.encode=function(){this.vertex=this.getVertexShaderString();var t=r.context3D.renderContext;this.program=t.createProgram(),this.vShader=t.createShader(Laya.WebGLContext.VERTEX_SHADER),this.fShader=t.createShader(Laya.WebGLContext.FRAGMENT_SHADER),t.shaderSource(this.vShader,this.vertex),t.shaderSource(this.fShader,this.fragment),t.compileShader(this.vShader),t.compileShader(this.fShader),t.attachShader(this.program,this.vShader),t.attachShader(this.program,this.fShader),this.binLocation(t),t.linkProgram(this.program),this.localDic=new Object;var e=t.getProgramInfoLog(this.program),i=t.getShaderInfoLog(this.vShader),a=t.getShaderInfoLog(this.fShader);return""==e||""==i&&""==a},e.prototype.getWebGLUniformLocation=function(t){var e=this.localDic[t];return e||(this.localDic[t]=r.context3D.getLocation(this.program,t),this.localDic[t])},e.prototype.binLocation=function(t){},e.prototype.getVertexShaderString=function(){return""},e.prototype.getFragmentShaderString=function(){return""},e.prototype.destory=function(){this.vertex=null,this.fragment=null,this.name=null,this.localDic=null,r.context3D.deleteShader(this)},e}(x),st=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2TexCoord")},e.prototype.getMat4Str=function(t){return"vcmat["+e.shader_mat4[t]+"]"},e.prototype.getVec4Str=function(t){return"vcmat["+e.shader_vec4[t][0]+"]["+e.shader_vec4[t][1]+"]"},e.getVcSize=function(){return 5},e.prototype.getVertexShaderString=function(){return"attribute vec4 v3Position;\nattribute vec2 v2TexCoord;\nuniform mat4 vcmat["+e.getVcSize()+"];\nvarying vec2 v0;\nvoid main(void){\n   v0 = v2TexCoord + vec2("+this.getVec4Str("uvMove")+".xy);\n   gl_Position = "+this.getMat4Str("viewMatrix3D")+"  * "+this.getMat4Str("camMatrix3D")+" * "+this.getMat4Str("posMatrix3D")+" * "+this.getMat4Str("rotationMatrix3D")+" * v3Position;\n}"},e.prototype.getFragmentShaderString=function(){return" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}"},e.Display3D_Facet_Shader="Display3DFacetShader",e.shader_mat4={viewMatrix3D:0,camMatrix3D:1,rotationMatrix3D:2,posMatrix3D:3},e.shader_vec4={uvMove:[4,0]},e}(nt),ot=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._isCycle=!1,e}return i(e,t),e.prototype.setAllByteInfo=function(e){this._maxAnimTime=e.readFloat(),this._isCycle=e.readBoolean(),this._lockx=e.readBoolean(),this._locky=e.readBoolean(),t.prototype.setAllByteInfo.call(this,e),this.initVcData(),this.uploadGpu()},e.prototype.getParticle=function(){return new ht},e.prototype.uploadGpu=function(){this.objData=new L,this.makeRectangleData(this._width,this._height,this._originWidthScale,this._originHeightScale,this._isUV,this._isU,this._isV,this._animLine,this._animRow)},e.prototype.makeRectangleData=function(t,e,i,a,n,s,o,h,c){void 0===i&&(i=.5),void 0===a&&(a=.5),void 0===n&&(n=!1),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===h&&(h=1),void 0===c&&(c=1);var l=new Array,u=new Array,p=new Array;if(p.push(new O(0,0)),p.push(new O(0,1/c)),p.push(new O(1/h,1/c)),p.push(new O(1/h,0)),s)for(var d=0;d<p.length;d++)p[d].x=-p[d].x;if(o)for(d=0;d<p.length;d++)p[d].y=-p[d].y;n&&p.push(p.shift());for(d=0;d<p.length;d++)l.push(p[d].x,p[d].y);u.push(-i*t,e-a*e,0),u.push(p[0].x,p[0].y),u.push(t-i*t,e-a*e,0),u.push(p[1].x,p[1].y),u.push(t-i*t,-a*e,0),u.push(p[2].x,p[2].y),u.push(-i*t,-a*e,0),u.push(p[3].x,p[3].y);var f=new Array;f.push(0,1,2,0,2,3),this.objData.stride=20,this.objData.vertexBuffer=r.context3D.uploadBuff3D(u),this.objData.indexBuffer=r.context3D.uploadIndexBuff3D(f),this.objData.treNum=f.length},e.prototype.initVcData=function(){this.vcmatData=new Float32Array(16*st.getVcSize())},e.prototype.setFloat32Vec=function(t,e){var i=st.shader_vec4[t],a=16*i[0]+4*i[1];this.vcmatData.set(e,a)},e.prototype.setFloat32Mat=function(t,e){var i=16*st.shader_mat4[t];this.vcmatData.set(e,i)},e.prototype.regShader=function(){this.materialParam.shader=V.getInstance().getMaterialProgram(st.Display3D_Facet_Shader,st,this.materialParam.material),this.materialParam.program=this.materialParam.shader.program},e}(at),ht=function(t){function e(){var e=t.call(this)||this;return e._lifeVisible=!0,e._resultUvVec=new Array(2),e}return i(e,t),Object.defineProperty(e.prototype,"facetdata",{get:function(){return this.data},enumerable:!1,configurable:!0}),e.prototype.creatData=function(){this.data=new ot},e.prototype.update=function(){this._lifeVisible&&t.prototype.update.call(this)},e.prototype.reset=function(){t.prototype.reset.call(this),this._lifeVisible=!0},e.prototype.setVc=function(){this.updateRotaionMatrix(),this.updateUV(),this.data.vcmatData.set(r.viewMatrx3D.m,0),this.data.vcmatData.set(r.cam3D.cameraMatrix.m,16),this.data.vcmatData.set(this.modelMatrix.m,48),this.data.vcmatData.set(this._rotationMatrix.m,32),this.data.vcmatData.set(this._resultUvVec,64),this.setMaterialVc(),!this.facetdata._isCycle&&this._time/r.frameTime>this.data._life-2&&(this._lifeVisible=!1),r.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData)},e.prototype.setVa=function(){r.context3D.pushVa(this.data.objData.vertexBuffer)||(r.context3D.setVaOffset(0,3,this.data.objData.stride,0),r.context3D.setVaOffset(1,2,this.data.objData.stride,12)),this.setMaterialTexture(),r.context3D.drawCall(this.data.objData.indexBuffer,this.data.objData.treNum)},e.prototype.updateRotaionMatrix=function(){this._rotationMatrix.identity(),this.data._watchEye&&(this.timeline.inverAxisRotation(this._rotationMatrix),this.facetdata._locky||this.facetdata._lockx||this.inverBind(),this.facetdata._locky||this._rotationMatrix.prependRotation(-r.cam3D.rotationY,a.Y_AXIS),this.facetdata._lockx||this._rotationMatrix.prependRotation(-r.cam3D.rotationX,a.X_AXIS)),this.data._isZiZhuan&&this.timeline.applySelfRotation(this._rotationMatrix,this.data._ziZhuanAngly)},e.prototype.updateUV=function(){var t=o.float2int(this._time/r.frameTime);t=(t=t>this.facetdata._maxAnimTime?this.facetdata._maxAnimTime:t)/this.data._animInterval%(this.data._animLine*this.data._animRow),this._resultUvVec[0]=o.float2int(t%this.data._animLine)/this.data._animLine+this._time/r.frameTime*this.data._uSpeed,this._resultUvVec[1]=o.float2int(t/this.data._animLine)/this.data._animRow+this._time/r.frameTime*this.data._vSpeed},e}(rt),ct=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"vPosition"),t.bindAttribLocation(this.program,1,"texcoord"),t.bindAttribLocation(this.program,2,"basePos"),t.bindAttribLocation(this.program,3,"speed"),this.paramAry[3]&&t.bindAttribLocation(this.program,4,"rotation"),this.paramAry[1]&&t.bindAttribLocation(this.program,5,"color")},e.prototype.getMat4Str=function(t){return"vcmat["+e.shader_mat4[t]+"]"},e.prototype.getVec4Str=function(t){return"vcmat["+e.shader_vec4[t][0]+"]["+e.shader_vec4[t][1]+"]"},e.getVcSize=function(){return 7},e.prototype.getVertexShaderString=function(){var t,i,a,r,n,s,o,h,c,l;l="attribute vec4 vPosition;\nattribute vec3 texcoord;\nattribute vec4 basePos;\nattribute vec3 speed;\nuniform mat4 vcmat["+e.getVcSize()+"];\nvarying vec2 v0;\n",t="float ctime = "+this.getVec4Str("time")+".x - basePos.w;\nif ("+this.getVec4Str("time")+".w > 0.0 && ctime >= 0.0) {\n    ctime = fract(ctime / "+this.getVec4Str("time")+".z) * "+this.getVec4Str("time")+".z;\n}\nvec4 pos = vPosition;\n",i="float stime = ctime - "+this.getVec4Str("scale")+".w;\nstime = max(stime,0.0);\nfloat sf = "+this.getVec4Str("scale")+".x * stime;\nif ("+this.getVec4Str("scale")+".y != 0.0 && "+this.getVec4Str("scale")+".z != 0.0) {\n    sf += sin("+this.getVec4Str("scale")+".y * stime) * "+this.getVec4Str("scale")+".z;\n}\nif (sf > "+this.getVec4Str("scaleCtrl")+".z) {\n    sf = "+this.getVec4Str("scaleCtrl")+".z;\n} else if (sf < "+this.getVec4Str("scaleCtrl")+".w) {\n    sf = "+this.getVec4Str("scaleCtrl")+".w;\n}\nvec2 sv2 = vec2("+this.getVec4Str("scaleCtrl")+".x * sf, "+this.getVec4Str("scaleCtrl")+".y * sf);\nsv2 = sv2 + 1.0;\npos.x *= sv2.x;\npos.y *= sv2.y;\n",a="vec3 addPos = speed * ctime;\nvec3 uspeed = vec3(0,0,0);\nif (ctime < 0.0 || ctime >= "+this.getVec4Str("time")+".z) {\n    addPos.y = addPos.y + 100000.0;\n}\n",r="if("+this.getVec4Str("time")+".y != 0.0 && length(speed) != 0.0) {\n    uspeed = vec3(speed.x, speed.y, speed.z);\n    uspeed = normalize(uspeed);\n    uspeed = uspeed * "+this.getVec4Str("time")+".y;\n    uspeed.xyz = uspeed.xyz + "+this.getVec4Str("force")+".xyz;\n} else {\n    uspeed = vec3("+this.getVec4Str("force")+".x, "+this.getVec4Str("force")+".y, "+this.getVec4Str("force")+".z);\n}\naddPos.xyz = addPos.xyz + uspeed.xyz * ctime * ctime;\n",n="uspeed = speed + uspeed * ctime * 2.0;\nuspeed = normalize(uspeed);\nvec4 tempMul = "+this.getMat4Str("rotationMatrix")+" * vec4(uspeed,1.0);\nuspeed.xyz = tempMul.xyz;\nuspeed = normalize(uspeed);\nvec3 cPos = addPos;\ntempMul = "+this.getMat4Str("rotationMatrix")+" * vec4(cPos,1.0);\ncPos.xyz = tempMul.xyz; \ncPos.xyz = "+this.getVec4Str("worldPos")+".xyz + cPos.xyz;\ncPos.xyz = "+this.getVec4Str("camPos")+".xyz - cPos.xyz;\ncPos = normalize(cPos);\ncPos = cross(uspeed, cPos);\ncPos = normalize(cPos);\nuspeed = uspeed * pos.x;\ncPos = cPos * pos.y;\npos.xyz = uspeed.xyz + cPos.xyz;\n",s="pos = "+this.getMat4Str("watheye")+" * pos;\npos.xyz = pos.xyz + basePos.xyz + addPos.xyz;\ngl_Position = "+this.getMat4Str("viewMatrix3D")+" * "+this.getMat4Str("camMatrix3D")+" * "+this.getMat4Str("modelMatrix")+" * pos;\n",o="vec2 uv = vec2(texcoord.x,texcoord.y);\nfloat animframe = floor(ctime / "+this.getVec4Str("animCtrl")+".z);\nanimframe = animframe / "+this.getVec4Str("animCtrl")+".x;\nuv.x += animframe;\nanimframe = floor(animframe);\nuv.y += animframe / "+this.getVec4Str("animCtrl")+".y;\nv0.xy = uv.xy;\n",h="vec2 uv = vec2("+this.getVec4Str("uvCtrl")+".x,"+this.getVec4Str("uvCtrl")+".y);\nuv.xy = uv.xy * ctime + texcoord.xy;\nv0.xy = uv.xy;\n",c="v1 = vec2(ctime/"+this.getVec4Str("time")+".z,1.0);\n";var u=this.paramAry[0],p=this.paramAry[1],d=this.paramAry[2],f=this.paramAry[3],y=this.paramAry[4],m=this.paramAry[5],v=this.paramAry[6],g="",_="";return g+=t,_+=l,y&&(g+=i,_+=""),f&&(g+="float angle = rotation.x + rotation.y * ctime;\nvec4 np = vec4(sin(angle), cos(angle), 0, 0);\nnp.z = np.x * pos.y + np.y * pos.x;\nnp.w = np.y * pos.y - np.x * pos.x;\npos.xy = np.zw;\n",_+="attribute vec2 rotation;\n"),g+=a,m&&(g+=r,_+=""),d&&(g+=n,_+=""),g+=s,1==v?(g+=o,_+=""):2==v?(g+=h,_+=""):g+="v0 = vec2(texcoord.x,texcoord.y);\n",p&&(g+="v2 = color;\n",_+="attribute vec4 color;\nvarying vec4 v2;\n"),u&&(g+=c,_+="varying vec2 v1;\n"),_+"void main(){\n"+g+"}"},e.prototype.getFragmentShaderString=function(){return" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}"},e.Display3D_Ball_Shader="Display3DBallShader",e.shader_mat4={viewMatrix3D:0,camMatrix3D:1,modelMatrix:2,watheye:3,rotationMatrix:4},e.shader_vec4={time:[5,0],scale:[5,1],scaleCtrl:[5,2],force:[5,3],worldPos:[6,0],camPos:[6,1],animCtrl:[6,2],uvCtrl:[6,3]},e}(nt),lt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(L),ut=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.destory=function(){t.prototype.destory.call(this),this.basePos&&(this.basePos.length=0,this.basePos=null,this.basePosBuffer&&(r.context3D.deleteBuffer(this.basePosBuffer),this.basePosBuffer=null)),this.beMove&&(this.beMove.length=0,this.beMove=null,this.beMoveBuffer&&(r.context3D.deleteBuffer(this.beMoveBuffer),this.beMoveBuffer=null)),this.randomColor&&(this.randomColor.length=0,this.randomColor=null,this.randomColorBuffer&&(r.context3D.deleteBuffer(this.randomColorBuffer),this.randomColorBuffer=null)),this.baseRotation&&(this.baseRotation.length=0,this.baseRotation=null,this.baseRotationBuffer&&(r.context3D.deleteBuffer(this.baseRotationBuffer),this.baseRotationBuffer=null))},e}(lt),pt=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._totalNum=1,e._acceleration=.2,e._toscale=0,e._shootAngly=new a(1,0,0),e._shootSpeed=0,e._isRandom=!1,e._isSendRandom=!1,e._isSendAngleRandom=!1,e._paticleMaxScale=1,e._paticleMinScale=1,e._addforce=new a(0,0,0),e._lixinForce=new a(0,0,0),e._waveform=new a(0,0,0,0),e._round=new a,e._is3Dlizi=!1,e._speed=1,e._isLoop=!1,e._basePositon=new a(0,0,0),e._baseRandomAngle=0,e._shapeType=0,e._playSpeed=1,e._beginScale=0,e}return i(e,t),e.prototype.getParticle=function(){return new dt},e.prototype.setAllByteInfo=function(e){this._totalNum=e.readFloat(),this._acceleration=e.readFloat(),this._toscale=e.readFloat(),this._shootSpeed=e.readFloat(),this._isRandom=e.readBoolean(),this._isSendRandom=e.readBoolean(),this._round.x=e.readFloat(),this._round.y=e.readFloat(),this._round.z=e.readFloat(),this._round.w=e.readFloat(),this._is3Dlizi=e.readBoolean(),this._halfCircle=e.readBoolean(),this._shootAngly.x=e.readFloat(),this._shootAngly.y=e.readFloat(),this._shootAngly.z=e.readFloat(),this._shootAngly.w=e.readFloat(),this._shootAngly.normalize(),this._speed=e.readFloat(),this._isLoop=e.readBoolean(),this._isSendAngleRandom=e.readBoolean(),this._waveform.x=e.readFloat(),this._waveform.y=e.readFloat(),this._waveform.z=e.readFloat(),this._waveform.w=e.readFloat(),this._closeSurface=e.readBoolean(),this._isEven=e.readBoolean(),this._paticleMaxScale=e.readFloat(),this._paticleMinScale=e.readFloat(),this._basePositon.x=e.readFloat(),this._basePositon.y=e.readFloat(),this._basePositon.z=e.readFloat(),this._basePositon.w=e.readFloat(),this._baseRandomAngle=e.readFloat(),this._shapeType=e.readFloat(),this._lockX=e.readBoolean(),this._lockY=e.readBoolean(),this._addforce.x=e.readFloat(),this._addforce.y=e.readFloat(),this._addforce.z=e.readFloat(),this._addforce.w=e.readFloat(),this._addforce.scaleByW(),this._lixinForce.x=e.readFloat(),this._lixinForce.y=e.readFloat(),this._lixinForce.z=e.readFloat(),this._lixinForce.w=e.readFloat(),this._islixinAngly=e.readBoolean(),this._particleRandomScale=new a,this._particleRandomScale.x=e.readFloat(),this._particleRandomScale.y=e.readFloat(),this._particleRandomScale.z=e.readFloat(),this._particleRandomScale.w=e.readFloat(),this._playSpeed=e.readFloat(),this.facez=e.readBoolean(),this._beginScale=e.readFloat(),this._widthFixed=e.readBoolean(),this._heightFixed=e.readBoolean(),this.readRandomColor(e),0!=this._acceleration||0!=this._addforce.x||0!=this._addforce.y||0!=this._addforce.z?(this._needAddSpeed=!0,this._addSpeedVec=[this._addforce.x,this._addforce.y,this._addforce.z]):this._needAddSpeed=!1,0!=this._toscale||0!=this._waveform.x||0!=this._waveform.y?(this._needScale=!0,this._scaleVec=[this._toscale,this._waveform.x,this._waveform.y,this._beginScale],this._scaleCtrlVec=[this._widthFixed?0:1,this._heightFixed?0:1,this._paticleMaxScale-1,this._paticleMinScale-1]):this._needScale=!1,t.prototype.setAllByteInfo.call(this,e),this._timeVec=[0,this._acceleration,this._life,this._isLoop?1:-1],this._is3Dlizi&&(this._wordPosVec=[0,0,0],this._caramPosVec=[0,0,0],this._allRotationMatrix=new d),this.initVcData()},e.prototype.readRandomColor=function(t){var e=t.readInt(),i=new Object;i.alpha=new Array,i.color=new Array,i.pos=new Array;for(var a=0;a<e;a++)i.alpha.push(t.readFloat()),i.color.push(t.readFloat()),i.pos.push(t.readFloat());this._textureRandomColorInfo=i},Object.defineProperty(e.prototype,"objBallData",{get:function(){return this.objData},enumerable:!1,configurable:!0}),e.prototype.uploadGpu=function(){this.objData=new ut,this.initBaseData(),this.initBasePos(),this.initSpeed(),this.initSelfRotaion(),this._needRandomColor&&this.initBaseColor(),this.pushToGpu()},e.prototype.initBaseData=function(){for(var t=new Array,e=new Array,i=new Array,a=0;a<this._totalNum;a++)this.makeRectangleData(t,e,this._width,this._height,this._originWidthScale,this._originHeightScale,this._isUV,this._isU,this._isV,this._animLine,this._animRow,a),i.push(0+4*a,1+4*a,2+4*a,0+4*a,2+4*a,3+4*a);this.objBallData.vertices=t,this.objBallData.uvs=e,this.objBallData.indexs=i},e.prototype.makeRectangleData=function(t,e,i,a,r,n,s,o,h,c,l,u){void 0===r&&(r=.5),void 0===n&&(n=.5),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===h&&(h=!1),void 0===c&&(c=1),void 0===l&&(l=1),void 0===u&&(u=0);var p=Math.random()*(this._particleRandomScale.x-this._particleRandomScale.y)+this._particleRandomScale.y;t.push(-r*i*p,(a-n*a)*p,0),t.push((i-r*i)*p,(a-n*a)*p,0),t.push((i-r*i)*p,-n*a*p,0),t.push(-r*i*p,-n*a*p,0);var d=new Array;if(d.push(new O(0,0)),d.push(new O(0,1/l)),d.push(new O(1/c,1/l)),d.push(new O(1/c,0)),o)for(var f=0;f<d.length;f++)d[f].x=-d[f].x;if(h)for(f=0;f<d.length;f++)d[f].y=-d[f].y;s&&d.push(d.shift());for(f=0;f<d.length;f++)e.push(d[f].x,d[f].y,u)},e.prototype.initBasePos=function(){for(var t=new Array,e=0;e<this._totalNum;e++){var i,r;if(this._isRandom){var n=new a(this._round.x*this._round.w,this._round.y*this._round.w,this._round.z*this._round.w);this._isEven?this._closeSurface?(i=new a(0,0,n.z),(r=new d).appendRotation(360*Math.random(),a.Y_AXIS),(i=r.transformVector(i)).y=n.y*Math.random()*2-n.y):(i=new a(0,0,n.z*Math.random()*2-n.z),(r=new d).appendRotation(360*Math.random(),a.Y_AXIS),(i=r.transformVector(i)).y=n.y*Math.random()*2-n.y):this._closeSurface?(i=new a(0,0,n.z),r=new d,this._halfCircle?r.appendRotation(180*-Math.random(),a.X_AXIS):r.appendRotation(360*Math.random(),a.X_AXIS),r.appendRotation(360*Math.random(),a.Y_AXIS),i=r.transformVector(i)):i=this._halfCircle?new a(n.x*Math.random()*2-n.x,n.y*Math.random(),n.z*Math.random()*2-n.z):new a(n.x*Math.random()*2-n.x,n.y*Math.random()*2-n.y,n.z*Math.random()*2-n.z)}else i=new a;i=i.add(this._basePositon);for(var s=0;s<4;s++)t.push(i.x,i.y,i.z,e*this._shootSpeed)}this.objBallData.basePos=t},e.prototype.initSpeed=function(){for(var t=new Array,e=0;e<this._totalNum;e++){var i=new a,r=new a;if(0!=this._shootAngly.x||0!=this._shootAngly.y||0!=this._shootAngly.z){var n=Math.tan(this._shootAngly.w*Math.PI/180*Math.random()),s=360*Math.PI/180*Math.random();r=new a(Math.sin(s)*n,Math.cos(s)*n,1);var o=new d;if(o.fromVtoV(new a(0,.0101,.99994),new a(this._shootAngly.x,this._shootAngly.y,this._shootAngly.z)),r=o.transformVector(r),isNaN(r.x))throw new Error("发射锥角，可能有问题，确定是否有取膜");r.normalize(),i=i.add(r)}0==this._lixinForce.x&&0==this._lixinForce.y&&0==this._lixinForce.z||((r=new a(Math.random()>.5?-this._lixinForce.x:this._lixinForce.x,Math.random()>.5?-this._lixinForce.y:this._lixinForce.y,Math.random()>.5?-this._lixinForce.z:this._lixinForce.z)).normalize(),i=i.add(r)),this._islixinAngly&&((r=this._isEven?new a(this.objBallData.basePos[16*e],0,this.objBallData.basePos[16*e+2]):new a(this.objBallData.basePos[16*e],this.objBallData.basePos[16*e+1],this.objBallData.basePos[16*e+2])).normalize(),i=i.add(r)),i.normalize(),this._isSendRandom?i.scaleBy(this._speed*Math.random()):i.scaleBy(this._speed);this._baseRandomAngle,Math.random(),Math.PI;for(var h=0;h<4;h++)t.push(i.x,i.y,i.z)}this.objBallData.beMove=t},e.prototype.initSelfRotaion=function(){var t=0,e=0;if(0!=this._ziZhuanAngly.x||0!=this._ziZhuanAngly.y||0!=this._ziZhuanAngly.z||0!=this._ziZhuanAngly.w)if(this._is3Dlizi)this._needSelfRotation=!1;else{this._needSelfRotation=!0;for(var i=new Array,a=0;a<this._totalNum;)t=this._ziZhuanAngly.x,1==this._ziZhuanAngly.y&&(t*=Math.random()),e=this._ziZhuanAngly.z,1==this._ziZhuanAngly.w?e*=Math.random():-1==this._ziZhuanAngly.w&&(e*=2*Math.random()-1),i.push(t,e),i.push(t,e),i.push(t,e),i.push(t,e),a++;this.objBallData.baseRotation=i}else this._needSelfRotation=!1},e.prototype.initBaseColor=function(){for(var t=j.getInstance().getImageData(this._textureRandomColorInfo).data,e=new Array,i=0;i<this._totalNum;i++){var r=4*o.float2int(128*Math.random()),n=new a(t[r],t[r+1],t[r+2],t[r+3]);n.scaleBy(1/255),e.push(n.x,n.y,n.z,n.w),e.push(n.x,n.y,n.z,n.w),e.push(n.x,n.y,n.z,n.w),e.push(n.x,n.y,n.z,n.w)}this.objBallData.randomColor=e},e.prototype.pushToGpu=function(){this.compressVertex()},e.prototype.compressVertex=function(){var t=this.objBallData.vertices.length/3,e=13;this._needSelfRotation&&(e+=2),this._needRandomColor&&(this.objBallData.randomOffset=4*e,e+=4),this.objBallData.stride=4*e;for(var i=new Array,a=0;a<t;a++){for(var n=0;n<3;n++)i.push(this.objBallData.vertices[3*a+n]);for(n=0;n<3;n++)i.push(this.objBallData.uvs[3*a+n]);for(n=0;n<4;n++)i.push(this.objBallData.basePos[4*a+n]);for(n=0;n<3;n++)i.push(this.objBallData.beMove[3*a+n]);if(this._needSelfRotation)for(n=0;n<2;n++)i.push(this.objBallData.baseRotation[2*a+n]);if(this._needRandomColor)for(n=0;n<4;n++)i.push(this.objBallData.randomColor[4*a+n])}this.objBallData.vertexBuffer=r.context3D.uploadBuff3D(i),this.objBallData.indexBuffer=r.context3D.uploadIndexBuff3D(this.objBallData.indexs),this.objBallData.treNum=this.objBallData.indexs.length},e.prototype.setFloat32Vec=function(t,e){var i=ct.shader_vec4[t],a=16*i[0]+4*i[1];this.vcmatData.set(e,a)},e.prototype.setFloat32Mat=function(t,e){var i=16*ct.shader_mat4[t];this.vcmatData.set(e,i)},e.prototype.initVcData=function(){this.vcmatData=new Float32Array(16*ct.getVcSize()),this.setFloat32Vec("time",this._timeVec),this._needAddSpeed&&this.setFloat32Vec("force",this._addSpeedVec),this._needScale&&(this.setFloat32Vec("scale",this._scaleVec),this.setFloat32Vec("scaleCtrl",this._scaleCtrlVec)),1==this._uvType?this.setFloat32Vec("animCtrl",this._animCtrlVec):2==this._uvType&&this.setFloat32Vec("uvCtrl",this._uvCtrlVec)},e.prototype.regShader=function(){if(this.materialParam){var t=this.getShaderParam();this.materialParam.shader=V.getInstance().getMaterialProgram(ct.Display3D_Ball_Shader,ct,this.materialParam.material,t),this.materialParam.program=this.materialParam.shader.program}},e.prototype.getShaderParam=function(){1!=this._animRow||1!=this._animLine?(this._uvType=1,this._animCtrlVec=[this._animLine,this._animRow,this._animInterval]):0!=this._uSpeed||0!=this._vSpeed?(this._uvType=2,this._uvCtrlVec=[this._uSpeed,this._vSpeed]):this._uvType=0;var t=this.materialParam.material.hasParticleColor;return this._needRandomColor=this.materialParam.material.hasVertexColor,this.uploadGpu(),[t?1:0,this._needRandomColor?1:0,this._is3Dlizi?1:0,this._needSelfRotation?1:0,this._needScale?1:0,this._needAddSpeed?1:0,this._uvType]},e}(at),dt=function(t){function e(){return t.call(this)||this}return i(e,t),Object.defineProperty(e.prototype,"balldata",{get:function(){return this.data},enumerable:!1,configurable:!0}),e.prototype.creatData=function(){this.data=new pt},e.prototype.setVa=function(){this.setVaCompress(),this.setMaterialTexture(),r.context3D.drawCall(this.data.objData.indexBuffer,this.data.objData.treNum)},e.prototype.setVaCompress=function(){r.context3D.pushVa(this.data.objData.vertexBuffer)||(r.context3D.setVaOffset(0,3,this.data.objData.stride,0),r.context3D.setVaOffset(1,3,this.data.objData.stride,12),r.context3D.setVaOffset(2,4,this.data.objData.stride,24),r.context3D.setVaOffset(3,3,this.data.objData.stride,40),this.balldata._needSelfRotation&&r.context3D.setVaOffset(4,2,this.data.objData.stride,52),this.balldata._needRandomColor&&r.context3D.setVaOffset(5,4,this.particleBallData.stride,this.particleBallData.randomOffset))},e.prototype.resetVa=function(){r.context3D.clearTexture()},e.prototype.setVc=function(){this.updateWatchCaramMatrix(),this.balldata.vcmatData.set(r.viewMatrx3D.m,0),this.balldata.vcmatData.set(r.cam3D.cameraMatrix.m,16),this.balldata.vcmatData.set(this.modelMatrix.m,32),this.balldata.vcmatData.set(this._rotationMatrix.m,48),this.balldata._timeVec[0]=this._time/r.frameTime*this.balldata._playSpeed,this.balldata.vcmatData.set(this.balldata._timeVec,80),this.balldata._is3Dlizi&&(this.updateAllRotationMatrix(),this.balldata._wordPosVec[0]=this.bindVecter3d.x,this.balldata._wordPosVec[1]=this.bindVecter3d.y,this.balldata._wordPosVec[2]=this.bindVecter3d.z,this.balldata._caramPosVec[0]=r.cam3D.x,this.balldata._caramPosVec[1]=r.cam3D.y,this.balldata._caramPosVec[2]=r.cam3D.z,this.balldata.vcmatData.set(this.balldata._allRotationMatrix.m,64),this.balldata.vcmatData.set(this.balldata._wordPosVec,96),this.balldata.vcmatData.set(this.balldata._caramPosVec,100)),r.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.balldata.vcmatData),this.setMaterialVc()},e.prototype.updateWatchCaramMatrix=function(){this._rotationMatrix.identity(),this.balldata.facez?this._rotationMatrix.prependRotation(90,a.X_AXIS):this.balldata._is3Dlizi?(this.timeline.inverAxisRotation(this._rotationMatrix),this.inverBind()):this.balldata._watchEye&&(this.timeline.inverAxisRotation(this._rotationMatrix),this.inverBind(),this._rotationMatrix.prependRotation(-r.cam3D.rotationY,a.Y_AXIS),this._rotationMatrix.prependRotation(-r.cam3D.rotationX,a.X_AXIS))},e.prototype.updateAllRotationMatrix=function(){this.balldata._allRotationMatrix.identity(),this.balldata._allRotationMatrix.prependScale(this.data.overAllScale*this._scaleX*.1*this.bindScale.x,this.data.overAllScale*this._scaleY*.1*this.bindScale.y,this.data.overAllScale*this._scaleZ*.1*this.bindScale.z),this.timeline.inverAxisRotation(this._rotationMatrix),this.isInGroup&&(this.balldata._allRotationMatrix.appendRotation(this.groupRotation.x,a.X_AXIS),this.balldata._allRotationMatrix.appendRotation(this.groupRotation.y,a.Y_AXIS),this.balldata._allRotationMatrix.appendRotation(this.groupRotation.z,a.Z_AXIS)),this.bindMatrix&&this.balldata._allRotationMatrix.append(this.bindMatrix)},Object.defineProperty(e.prototype,"particleBallData",{get:function(){return this.data.objData},enumerable:!1,configurable:!0}),e}(rt),ft=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2TexCoord"),this.paramAry[0]&&t.bindAttribLocation(this.program,2,"v3Normal")},e.prototype.getMat4Str=function(t){return"vcmat["+e.shader_mat4[t]+"]"},e.prototype.getVec4Str=function(t){return"vcmat["+e.shader_vec4[t][0]+"]["+e.shader_vec4[t][1]+"]"},e.getVcSize=function(){return 4},e.prototype.getVertexShaderString=function(){var t="attribute vec4 v3Position;\nattribute vec2 v2TexCoord;\nuniform mat4 vcmat["+st.getVcSize()+"];\nvarying vec2 v0;\nvarying vec4 v2;\n",e="   vec2 tempv0 = v2TexCoord;\n   tempv0.x -= "+this.getVec4Str("uvMove")+".x;\n",i="   tempv0.xy *= "+this.getVec4Str("isUv")+".xy;\n   if("+this.getVec4Str("isUv")+".z >= 0.0){\n   vec2 tempv1 = tempv0;\n   tempv0.y = tempv1.x;\n   tempv0.x = tempv1.y;}\n   v0 = tempv0;\n",a="   float alpha = tempv0.x/"+this.getVec4Str("uvMove")+".y;\n   alpha = 1.0 - clamp(abs(alpha),0.0,1.0);\n   float kill = -tempv0.x;\n   kill *= tempv0.x - "+this.getVec4Str("uvMove")+".z;\n   v2 = vec4(kill,0.0,0.0,alpha);\n",r="   gl_Position = "+this.getMat4Str("viewMatrix3D")+"  * "+this.getMat4Str("camMatrix3D")+" * "+this.getMat4Str("posMatrix3D")+" * v3Position;\n",n="   vec4 tempPos = "+this.getMat4Str("posMatrix3D")+" * v3Position;\n   vec3 mulPos = vec3(tempPos.x,tempPos.y,tempPos.z);\n   vec3 normals = vec3(v3Normal.x,v3Normal.y,v3Normal.z);\n   mulPos = normalize(vec3("+this.getVec4Str("camPos")+".xyz) - mulPos);\n   mulPos = cross(mulPos, normals);\n   mulPos = normalize(mulPos);\n   mulPos *= v3Normal.w;\n   tempPos.xyz = mulPos.xyz + v3Position.xyz;\n   gl_Position = "+this.getMat4Str("viewMatrix3D")+"  * "+this.getMat4Str("camMatrix3D")+" * "+this.getMat4Str("posMatrix3D")+" * tempPos;\n",s=this.paramAry[0],o=this.paramAry[1],h=this.paramAry[2],c=t;s&&(c+="attribute vec4 v3Normal;\n"),o&&(c+=""),h&&(c+="varying vec2 v1;\n");var l=e+a;return h&&(l+="   v1 = v2TexCoord;\n"),l+=o?i:"   v0 = tempv0;\n",c+"void main(void){\n"+(l+=s?n:r)+"}"},e.prototype.getFragmentShaderString=function(){return" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}"},e.Display3D_Locus_Shader="Display3DLocusShader",e.shader_mat4={viewMatrix3D:0,camMatrix3D:1,posMatrix3D:2},e.shader_vec4={uvMove:[3,0],camPos:[3,1],isUv:[3,2]},e}(nt),yt=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._speed=1,e._isLoop=!1,e}return i(e,t),e.prototype.getParticle=function(){return new mt},e.prototype.setAllByteInfo=function(e){this._isLoop=e.readBoolean(),this._speed=e.readFloat(),this._density=e.readFloat(),this._isEnd=e.readBoolean(),this.objData=new L;var i=e.getInt(),a=new ArrayBuffer(9*i*4),n=new DataView(a);Ot.readBytes2ArrayBuffer(e,n,3,0,9,4),Ot.readBytes2ArrayBuffer(e,n,4,3,9,4),Ot.readBytes2ArrayBuffer(e,n,2,7,9,4);for(var s=e.readInt(),o=0;o<s;o++)this.objData.indexs.push(e.readInt());this.objData.stride=36,t.prototype.setAllByteInfo.call(this,e),this.initUV(),this._watchEye&&(this._caramPosVec=[0,0,0]),this._uvVec=[this._isU?-1:1,this._isV?-1:1,this._isUV?1:-1],this.initVcData(),this.objData.vertexBuffer=r.context3D.uploadBuff3DArrayBuffer(a),this.objData.indexBuffer=r.context3D.uploadIndexBuff3D(this.objData.indexs),this.objData.treNum=this.objData.indexs.length},e.prototype.initUV=function(){this._resultUvVec=new Array(3);var t,e=this._life/100,i=0*this._speed/this._density/10;this._isEnd&&(i=Math.min(1,i)),t=this._isLoop?this._life?new a(i%=e+1,e,-e):new a((i%=1)+1,99,-2):this._life?new a(i,e,-1):new a(i,99,-1),this._resultUvVec[0]=t.x,this._resultUvVec[1]=t.y,this._resultUvVec[2]=t.z},e.prototype.uploadGpu=function(){this.objData.vertexBuffer=r.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=r.context3D.uploadBuff3D(this.objData.uvs),this._watchEye&&(this.objData.normalsBuffer=r.context3D.uploadBuff3D(this.objData.normals)),this.objData.indexBuffer=r.context3D.uploadIndexBuff3D(this.objData.indexs),this.objData.treNum=this.objData.indexs.length},e.prototype.regShader=function(){if(this.materialParam){var t,e=this._watchEye?1:0,i=0,a=this.materialParam.material.hasParticleColor;this._isU||this._isV||this._isUV?(i=1,this._changUv=!0):this._changUv=!1,t=[e,i,a?1:0],this.materialParam.shader=V.getInstance().getMaterialProgram(ft.Display3D_Locus_Shader,ft,this.materialParam.material,t),this.materialParam.program=this.materialParam.shader.program}},e.prototype.initVcData=function(){this.vcmatData=new Float32Array(16*ft.getVcSize())},e.prototype.setFloat32Vec=function(t,e){var i=ft.shader_vec4[t],a=16*i[0]+4*i[1];this.vcmatData.set(e,a)},e.prototype.setFloat32Mat=function(t,e){var i=16*ft.shader_mat4[t];this.vcmatData.set(e,i)},e}(at),mt=function(t){function e(){return t.call(this)||this}return i(e,t),Object.defineProperty(e.prototype,"locusdata",{get:function(){return this.data},enumerable:!1,configurable:!0}),e.prototype.creatData=function(){this.data=new yt},e.prototype.setVa=function(){r.context3D.pushVa(this.data.objData.vertexBuffer)||(r.context3D.setVaOffset(0,3,this.data.objData.stride,0),r.context3D.setVaOffset(1,2,this.data.objData.stride,28),this.data._watchEye&&r.context3D.setVaOffset(2,4,this.data.objData.stride,12)),this.setMaterialTexture(),r.context3D.drawCall(this.data.objData.indexBuffer,this.data.objData.treNum)},e.prototype.setVc=function(){this.updateUV(),this.data.vcmatData.set(r.viewMatrx3D.m,0),this.data.vcmatData.set(r.cam3D.cameraMatrix.m,16),this.data.vcmatData.set(this.modelMatrix.m,32),this.data.vcmatData.set(this.locusdata._resultUvVec,48),this.data._watchEye&&(this.locusdata._caramPosVec[0]=r.cam3D.x,this.locusdata._caramPosVec[1]=r.cam3D.y,this.locusdata._caramPosVec[2]=r.cam3D.z,this.data.vcmatData.set(this.locusdata._caramPosVec,52)),this.locusdata._changUv&&this.data.setFloat32Vec("isUv",this.locusdata._uvVec),r.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData),this.setMaterialVc()},e.prototype.updateUV=function(){var t=this._time/r.frameTime,e=this.data._life/100,i=this.locusdata._speed*t/this.locusdata._density/10;this.locusdata._isEnd&&(i=Math.min(1,i)),this.locusdata._isLoop&&(this.locusdata._life?i%=e+1:i%=1),this.locusdata._resultUvVec[0]=i},e}(rt),vt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.getParticle=function(){return new gt},e.prototype.initBasePos=function(){for(var t=new Array,e=0;e<this._totalNum;e++){var i,r=3*e;if(this._isRandom){var n=new a(this._round.x*this._round.w,this._round.y*this._round.w,this._round.z*this._round.w);i=new a(this._posAry[r]+Math.random()*n.x,this._posAry[r+1]+Math.random()*n.y,this._posAry[r+2]+Math.random()*n.z)}else i=new a(this._posAry[r],this._posAry[r+1],this._posAry[r+2]);i=i.add(this._basePositon);for(var s=0;s<4;s++)t.push(i.x,i.y,i.z,e*this._shootSpeed)}this.objBallData.basePos=t},e.prototype.initSpeed=function(){for(var t=new Array,e=0;e<this._totalNum;e++){var i=new a;if(0==this._tangentSpeed)i.addByNum(this._angleAry[3*e],this._angleAry[3*e+1],this._angleAry[3*e+2]);else if(2==this._tangentSpeed)i.setTo(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1);else{var r=new a(this._tangentAry[3*e],this._tangentAry[3*e+1],this._tangentAry[3*e+2]);r.scaleBy(this._tangentSpeed),i=i.add(r)}i.normalize(),this._isSendRandom?i.scaleBy(this._speed*Math.random()):i.scaleBy(this._speed);for(var n=0;n<4;n++)t.push(i.x,i.y,i.z)}this.objBallData.beMove=t},e.prototype.setAllByteInfo=function(e){this._tangentSpeed=e.readFloat(),this._posAry=JSON.parse(e.readUTF()),this._angleAry=JSON.parse(e.readUTF()),this._tangentAry=JSON.parse(e.readUTF()),t.prototype.setAllByteInfo.call(this,e),this.uploadGpu()},e}(pt),gt=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.creatData=function(){this.data=new vt},e}(dt),_t=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.getParticle=function(){return new xt},e.prototype.setAllByteInfo=function(e){this.objData=new L,this._maxAnimTime=e.readFloat();var i=e.getInt(),a=new ArrayBuffer(5*i*4),n=new DataView(a);Ot.readBytes2ArrayBuffer(e,n,3,0,5,4),Ot.readBytes2ArrayBuffer(e,n,2,3,5,4);for(var s=e.readInt(),o=0;o<s;o++)this.objData.indexs.push(e.readInt());this.objData.stride=20,this.version>=36&&(this._depthMode=e.readInt()),t.prototype.setAllByteInfo.call(this,e),this.initVcData(),this.objData.vertexBuffer=r.context3D.uploadBuff3DArrayBuffer(a),this.objData.indexBuffer=r.context3D.uploadIndexBuff3D(this.objData.indexs),this.objData.treNum=this.objData.indexs.length},e.prototype.initVcData=function(){this.vcmatData=new Float32Array(16*st.getVcSize())},e.prototype.uploadGpu=function(){this.objData.vertexBuffer=r.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=r.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=r.context3D.uploadIndexBuff3D(this.objData.indexs),this.objData.treNum=this.objData.indexs.length},e.prototype.regShader=function(){this.materialParam.shader=V.getInstance().getMaterialProgram(st.Display3D_Facet_Shader,st,this.materialParam.material),this.materialParam.program=this.materialParam.shader.program},e.prototype.setFloat32Vec=function(t,e){var i=st.shader_vec4[t],a=16*i[0]+4*i[1];this.vcmatData.set(e,a)},e.prototype.setFloat32Mat=function(t,e){var i=16*st.shader_mat4[t];this.vcmatData.set(e,i)},e}(at),xt=function(t){function e(){var e=t.call(this)||this;return e._resultUvVec=new Array(2),e}return i(e,t),Object.defineProperty(e.prototype,"modeldata",{get:function(){return this.data},enumerable:!1,configurable:!0}),e.prototype.creatData=function(){this.data=new _t},e.prototype.setVc=function(){this.updateWatchCaramMatrix(),this.updateUV(),this.data.vcmatData.set(r.viewMatrx3D.m,0),this.data.vcmatData.set(r.cam3D.cameraMatrix.m,16),this.data.vcmatData.set(this.modelMatrix.m,48),this.data.vcmatData.set(this._rotationMatrix.m,32),this.data.vcmatData.set(this._resultUvVec,64),r.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData),this.setMaterialVc()},e.prototype.setVa=function(){r.context3D.setWriteDepth(1==this.data._depthMode),r.context3D.pushVa(this.data.objData.vertexBuffer)||(r.context3D.setVaOffset(0,3,this.data.objData.stride,0),r.context3D.setVaOffset(1,2,this.data.objData.stride,12)),this.setMaterialTexture(),r.context3D.drawCall(this.data.objData.indexBuffer,this.data.objData.treNum),r.context3D.setWriteDepth(!1)},e.prototype.updateWatchCaramMatrix=function(){this._rotationMatrix.identity(),this.data._watchEye&&(this.timeline.inverAxisRotation(this._rotationMatrix),this._rotationMatrix.prependRotation(-r.cam3D.rotationY,a.Y_AXIS),this._rotationMatrix.prependRotation(-r.cam3D.rotationX,a.X_AXIS)),this.data._isZiZhuan&&this.timeline.applySelfRotation(this._rotationMatrix,this.data._ziZhuanAngly)},e.prototype.updateUV=function(){var t=Math.floor(this._time/r.frameTime/this.data._animInterval);this.data._animLine,this.data._animRow;this._resultUvVec[0]=Math.floor(t%this.data._animLine)/this.data._animLine,this._resultUvVec[1]=Math.floor(t/this.data._animLine)/this.data._animRow,this._resultUvVec[0]+=this._time/r.frameTime*this.data._uSpeed,this._resultUvVec[1]+=this._time/r.frameTime*this.data._vSpeed},e}(rt),bt=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.update=function(){this._depthMode&&r.context3D.setDepthTest(!0),t.prototype.update.call(this),this._depthMode&&r.context3D.setDepthTest(!1)},e}(xt),Dt=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.updateUV=function(){var t=this._time/r.frameTime;t=(t=t>this.modeldata._maxAnimTime?this.modeldata._maxAnimTime:t)/this.data._animInterval%(this.data._animLine*this.data._animRow),this._resultUvVec[0]=o.float2int(t%this.data._animLine)/this.data._animLine+this._time/r.frameTime*this.data._uSpeed,this._resultUvVec[1]=o.float2int(t/this.data._animLine)/this.data._animRow+this._time/r.frameTime*this.data._vSpeed},e}(xt),wt=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"vPosition"),t.bindAttribLocation(this.program,1,"texcoord"),t.bindAttribLocation(this.program,2,"basePos"),t.bindAttribLocation(this.program,3,"speed"),this.paramAry[3]&&t.bindAttribLocation(this.program,4,"rotation"),this.paramAry[1]&&t.bindAttribLocation(this.program,5,"color")},e.prototype.getMat4Str=function(t){return"vcmat["+ct.shader_mat4[t]+"]"},e.prototype.getVec4Str=function(t){return"vcmat["+ct.shader_vec4[t][0]+"]["+ct.shader_vec4[t][1]+"]"},e.getVcSize=function(){return 7},e.prototype.getVertexShaderString=function(){var t,e,i,a,r,n,s,o,h,c;c="attribute vec4 vPosition;\nattribute vec3 texcoord;\nattribute vec4 basePos;\nattribute vec3 speed;\nuniform mat4 vcmat["+ct.getVcSize()+"];\nuniform vec3 bindpos[30];\nvarying vec2 v0;\n",t="float ctime = "+this.getVec4Str("time")+".x - basePos.w;\nif ("+this.getVec4Str("time")+".w > 0.0 && ctime >= 0.0) {\n    ctime = fract(ctime / "+this.getVec4Str("time")+".z) * "+this.getVec4Str("time")+".z;\n}\nvec4 pos = vPosition;\n",e="float stime = ctime - "+this.getVec4Str("scale")+".w;\nstime = max(stime,0.0);\nfloat sf = "+this.getVec4Str("scale")+".x * stime;\nif ("+this.getVec4Str("scale")+".y != 0.0 && "+this.getVec4Str("scale")+".z != 0.0) {\n    sf += sin("+this.getVec4Str("scale")+".y * stime) * "+this.getVec4Str("scale")+".z;\n}\nif (sf > "+this.getVec4Str("scaleCtrl")+".z) {\n    sf = "+this.getVec4Str("scaleCtrl")+".z;\n} else if (sf < "+this.getVec4Str("scaleCtrl")+".w) {\n    sf = "+this.getVec4Str("scaleCtrl")+".w;\n}\nvec2 sv2 = vec2("+this.getVec4Str("scaleCtrl")+".x * sf, "+this.getVec4Str("scaleCtrl")+".y * sf);\nsv2 = sv2 + 1.0;\npos.x *= sv2.x;\npos.y *= sv2.y;\n",i="vec3 addPos = speed * ctime;\nvec3 uspeed = vec3(0,0,0);\nif (ctime < 0.0 || ctime >= "+this.getVec4Str("time")+".z) {\n    addPos.y = addPos.y + 100000.0;\n}\n",a="if("+this.getVec4Str("time")+".y != 0.0 && length(speed) != 0.0) {\n    uspeed = vec3(speed.x, speed.y, speed.z);\n    uspeed = normalize(uspeed);\n    uspeed = uspeed * "+this.getVec4Str("time")+".y;\n    uspeed.xyz = uspeed.xyz + "+this.getVec4Str("force")+".xyz;\n} else {\n    uspeed = vec3("+this.getVec4Str("force")+".x, "+this.getVec4Str("force")+".y, "+this.getVec4Str("force")+".z);\n}\naddPos.xyz = addPos.xyz + uspeed.xyz * ctime * ctime;\n",r="uspeed = speed + uspeed * ctime * 2.0;\nuspeed = normalize(uspeed);\nvec4 tempMul = "+this.getMat4Str("rotationMatrix")+" * vec4(uspeed,1.0);\nuspeed.xyz = tempMul.xyz;\nuspeed = normalize(uspeed);\nvec3 cPos = addPos;\ntempMul = "+this.getMat4Str("rotationMatrix")+" * vec4(cPos,1.0);\ncPos.xyz = tempMul.xyz; \ncPos.xyz = "+this.getVec4Str("worldPos")+".xyz + cPos.xyz;\ncPos.xyz = "+this.getVec4Str("camPos")+".xyz - cPos.xyz;\ncPos = normalize(cPos);\ncPos = cross(uspeed, cPos);\ncPos = normalize(cPos);\nuspeed = uspeed * pos.x;\ncPos = cPos * pos.y;\npos.xyz = uspeed.xyz + cPos.xyz;\n",n="pos = "+this.getMat4Str("watheye")+" * pos;\npos.xyz = pos.xyz + basePos.xyz + addPos.xyz;\npos = "+this.getMat4Str("modelMatrix")+" * pos;\npos.xyz = pos.xyz + bindpos[int(texcoord.z)].xyz;\ngl_Position = "+this.getMat4Str("viewMatrix3D")+" * "+this.getMat4Str("camMatrix3D")+" * pos;\n",s="vec2 uv = vec2(texcoord.x,texcoord.y);\nfloat animframe = floor(ctime / "+this.getVec4Str("animCtrl")+".z);\nanimframe = animframe / "+this.getVec4Str("animCtrl")+".x;\nuv.x += animframe;\nanimframe = floor(animframe);\nuv.y += animframe / "+this.getVec4Str("animCtrl")+".y;\nv0.xy = uv.xy;\n",o="vec2 uv = vec2("+this.getVec4Str("uvCtrl")+".x,"+this.getVec4Str("uvCtrl")+".y);\nuv.xy = uv.xy * ctime + texcoord.xy;\nv0.xy = uv.xy;\n",h="v1 = vec2(ctime/"+this.getVec4Str("time")+".z,1.0);\n";var l=this.paramAry[0],u=this.paramAry[1],p=this.paramAry[2],d=this.paramAry[3],f=this.paramAry[4],y=this.paramAry[5],m=this.paramAry[6],v="",g="";return v+=t,g+=c,f&&(v+=e,g+=""),d&&(v+="float angle = rotation.x + rotation.y * ctime;\nvec4 np = vec4(sin(angle), cos(angle), 0, 0);\nnp.z = np.x * pos.y + np.y * pos.x;\nnp.w = np.y * pos.y - np.x * pos.x;\npos.xy = np.zw;\n",g+="attribute vec2 rotation;\n"),v+=i,y&&(v+=a,g+=""),p&&(v+=r,g+=""),v+=n,1==m?(v+=s,g+=""):2==m?(v+=o,g+=""):v+="v0 = vec2(texcoord.x,texcoord.y);\n",u&&(v+="v2 = color;\n",g+="attribute vec4 color;\nvarying vec4 v2;\n"),l&&(v+=h,g+="varying vec2 v1;\n"),g+"void main(){\n"+v+"}"},e.prototype.getFragmentShaderString=function(){return" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}"},e.Display3D_Follow_Shader="Display3DFollowShader",e.shader_mat4={viewMatrix3D:0,camMatrix3D:1,modelMatrix:2,watheye:3,rotationMatrix:4},e.shader_vec4={time:[5,0],scale:[5,1],scaleCtrl:[5,2],force:[5,3],worldPos:[6,0],camPos:[6,1],animCtrl:[6,2],uvCtrl:[6,3]},e}(nt),At=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.getParticle=function(){return new Tt},e.prototype.setAllByteInfo=function(e){t.prototype.setAllByteInfo.call(this,e),this.uploadGpu()},e.prototype.regShader=function(){if(this.materialParam){var t=this.getShaderParam();this.materialParam.shader=V.getInstance().getMaterialProgram(wt.Display3D_Follow_Shader,wt,this.materialParam.material,t),this.materialParam.program=this.materialParam.shader.program}},e}(pt),Tt=function(t){function e(){var e=t.call(this)||this;return e.flag=0,e}return i(e,t),Object.defineProperty(e.prototype,"followdata",{get:function(){return this.data},enumerable:!1,configurable:!0}),e.prototype.creatData=function(){this.data=new At},e.prototype.onCreated=function(){this.initBingMatrixAry()},e.prototype.setVc=function(){t.prototype.setVc.call(this),this.updateBind(),r.context3D.setVc3fv(this.data.materialParam.shader,"bindpos",this._bindMatrixAry)},e.prototype.initBingMatrixAry=function(){this._bindMatrixAry=new Float32Array(120),this._bindFlagAry=new Array;for(var t=0;t<this.followdata._totalNum;t++)this._bindFlagAry.push(0)},e.prototype.updateBind=function(){for(var t=this._time/r.frameTime,e=this.flag;e<this.followdata._totalNum;e++){if((t-e*this.followdata._shootSpeed)/this.followdata._life>=this._bindFlagAry[e]){var i=3*e;this._bindMatrixAry[i]=this.bindVecter3d.x,this._bindMatrixAry[i+1]=this.bindVecter3d.y,this._bindMatrixAry[i+2]=this.bindVecter3d.z,this._bindFlagAry[e]++}}},e.prototype.updateMatrix=function(){this.bindMatrix&&(this.modelMatrix.identity(),this.groupMatrix.isIdentity||this.posMatrix.append(this.groupMatrix),this.modelMatrix.append(this.posMatrix))},e.prototype.updateAllRotationMatrix=function(){this.followdata._allRotationMatrix.identity(),this.followdata._allRotationMatrix.prependScale(this.followdata.overAllScale*this._scaleX*.1*this.bindScale.x,this.followdata.overAllScale*this._scaleY*.1*this.bindScale.y,this.followdata.overAllScale*this._scaleZ*.1*this.bindScale.z),this.isInGroup&&(this.followdata._allRotationMatrix.appendRotation(this.groupRotation.x,a.X_AXIS),this.followdata._allRotationMatrix.appendRotation(this.groupRotation.y,a.Y_AXIS),this.followdata._allRotationMatrix.appendRotation(this.groupRotation.z,a.Z_AXIS))},e.prototype.reset=function(){t.prototype.reset.call(this);for(var e=0;e<this.followdata._totalNum;e++)this._bindMatrixAry[3*e]=0,this._bindMatrixAry[3*e+1]=0,this._bindMatrixAry[3*e+2]=0,this._bindFlagAry[e]=0},e.prototype.updateWatchCaramMatrix=function(){this._rotationMatrix.identity(),this.followdata.facez?this._rotationMatrix.prependRotation(90,a.X_AXIS):this.followdata._watchEye&&(this._rotationMatrix.prependRotation(-r.cam3D.rotationY,a.Y_AXIS),this._rotationMatrix.prependRotation(-r.cam3D.rotationX,a.X_AXIS))},e}(dt),Mt=function(t){function e(){var e=t.call(this)||this;return e._maxTime=1e6,e._rotationX=0,e._rotationY=0,e._rotationZ=0,e.hasMulItem=!1,e.sceneVisible=!0,e.dynamic=!1,e.hasDestory=!1,e._displayAry=new Array,e._time=0,e.bindMatrix=new d,e.invertBindMatrix=new d,e.bindVecter3d=new a,e.bindScale=new a(1,1,1),e.groupMatrix=new d,e.groupRotationMatrix=new d,e}return i(e,t),Object.defineProperty(e.prototype,"displayAry",{get:function(){return this._displayAry},set:function(t){this._displayAry=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"maxTime",{set:function(t){this._maxTime=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bindTarget",{set:function(t){this._bindTarget=t,this.invertBindMatrix.isIdentity=!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bindSocket",{set:function(t){this._bindSocket=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"x",{get:function(){return this.bindVecter3d.x},set:function(t){this.bindVecter3d.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.bindVecter3d.y},set:function(t){this.bindVecter3d.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this.bindVecter3d.z},set:function(t){this.bindVecter3d.z=t},enumerable:!1,configurable:!0}),e.prototype.setPos=function(t,e,i){this.bindVecter3d.setTo(t,e,i);for(var a=0;a<this._displayAry.length;a++)this._displayAry[a].resetPos()},e.prototype.setMulPos=function(t){for(var e=0;e<this._displayAry.length;e++)this._displayAry[e].resetMulPos(t)},Object.defineProperty(e.prototype,"scaleX",{set:function(t){this.bindScale.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scaleY",{set:function(t){this.bindScale.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scaleZ",{set:function(t){this.bindScale.z=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationX",{set:function(t){this._rotationX=t,this.applyRotation()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationY",{set:function(t){this._rotationY=t,this.applyRotation()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationZ",{set:function(t){this._rotationZ=t,this.applyRotation()},enumerable:!1,configurable:!0}),e.prototype.applyRotation=function(){this.bindMatrix.identity(),this.bindMatrix.appendRotation(this._rotationX,a.X_AXIS),this.bindMatrix.appendRotation(this._rotationY,a.Y_AXIS),this.bindMatrix.appendRotation(this._rotationZ,a.Z_AXIS),this.bindMatrix.copyTo(this.invertBindMatrix),this.invertBindMatrix.invert(),this.invertBindMatrix.isIdentity=!1},e.prototype.setGroup=function(t,e,i){this._isInGroup=!0,this._groupPos=t,this._groupRotation=e,this._groupScale=i,this.groupMatrix.isIdentity=!1,this.groupMatrix.identity(),this.groupMatrix.appendScale(i.x,i.y,i.z),this.groupMatrix.appendRotation(e.x,a.X_AXIS),this.groupMatrix.appendRotation(e.y,a.Y_AXIS),this.groupMatrix.appendRotation(e.z,a.Z_AXIS),this.groupMatrix.appendTranslation(t.x,t.y,t.z),this.groupRotationMatrix.isIdentity=!1,this.groupRotationMatrix.identity(),this.groupRotationMatrix.prependRotation(e.z,a.Z_AXIS),this.groupRotationMatrix.prependRotation(e.y,a.Y_AXIS),this.groupRotationMatrix.prependRotation(e.x,a.X_AXIS)},e.prototype.setDataByte=function(t){t.position=0;var e=t.readInt(),i=t.readInt();this._maxTime=0,this._displayAry=new Array;for(var a=0;a<i;a++){var n=t.readInt(),s=this.getDisplay3DById(n);s.setAllByteInfo(t,e),s.setBind(this.bindVecter3d,this.bindMatrix,this.bindScale,this.invertBindMatrix,this.groupMatrix),this._displayAry.push(s),s.timeline.maxFrameNum>this._maxTime&&(this._maxTime=s.timeline.maxFrameNum)}this._maxTime*=r.frameTime},e.prototype.addPrticleItem=function(t){t.visible=!1,t.setBind(this.bindVecter3d,this.bindMatrix,this.bindScale,this.invertBindMatrix,this.groupMatrix),this._displayAry.push(t)},e.prototype.getDisplay3DById=function(t){var e=new Object;return e.particleType=t,this.getDisplay3D(e)},e.prototype.updateTime=function(t){if(this._time+=t,this._displayAry){for(var e=0;e<this._displayAry.length;e++)this._displayAry[e].updateTime(this._time);this.updateBind(),this._time>=this._maxTime&&this.dispatchEvent(new U(U.COMPLETE))}},e.prototype.updateBind=function(){this._bindTarget&&(this._bindTarget.getSocket(this._bindSocket,this.bindMatrix),this.bindVecter3d.setTo(this.bindMatrix.x,this.bindMatrix.y,this.bindMatrix.z),this.bindMatrix.identityPostion(),this.groupRotationMatrix.isIdentity?this.bindMatrix.invertToMatrix(this.invertBindMatrix):(this.bindMatrix.copyTo(this.invertBindMatrix),this.invertBindMatrix.prepend(this.groupRotationMatrix),this.invertBindMatrix.invert()))},e.prototype.reset=function(){this._time=0;for(var t=0;t<this._displayAry.length;t++)this._displayAry[t].reset()},e.prototype.update=function(){if(this.sceneVisible&&this._displayAry)for(var t=0;t<this._displayAry.length;t++)this._displayAry[t].update()},e.prototype.updateItem=function(t){if(this.sceneVisible&&!this.hasDestory){var e=this._displayAry[t];e&&e.update()}},Object.defineProperty(e.prototype,"size",{get:function(){return this._displayAry?this._displayAry.length:0},enumerable:!1,configurable:!0}),e.prototype.getDisplay3D=function(t){var e;switch(t.particleType){case 1:e=new ht;break;case 18:e=new dt;break;case 3:e=new mt;break;case 14:e=new gt;break;case 9:e=new bt;break;case 4:e=new xt;break;case 7:e=new Dt;break;case 8:e=new Tt}return e.visible=!1,e},e.prototype.destory=function(){this.sourceData&&this.sourceData.useNum--;for(var t=0;t<this._displayAry.length;t++)this._displayAry[t].destory();this._displayAry.length=0,this._displayAry=null,this.bindMatrix=null,this.bindVecter3d=null,this.bindScale=null,this.invertBindMatrix=null,this._bindTarget=null,this._bindSocket=null,this._groupPos=null,this._groupRotation=null,this._groupScale=null,this.groupMatrix=null,this.groupRotationMatrix=null,this.hasDestory=!0},e}(f),Pt=function(t){function e(){var e=t.call(this)||this;return e.flag=0,e._caramPosVec=[0,0,0],e}return i(e,t),Object.defineProperty(e.prototype,"followlocusdata",{get:function(){return this.data},enumerable:!1,configurable:!0}),e.prototype.creatData=function(){this.data=new It},e.prototype.onCreated=function(){this.initBindMatrixAry()},e.prototype.initBindMatrixAry=function(){this._bindPosAry=new Array,this._gpuVc=new Float32Array(6*this.followlocusdata._fenduanshu);for(var t=0;t<=this.followlocusdata._fenduanshu;t++)this._bindPosAry.push([0,0,5*t]),this._bindPosAry.push([0,0,1])},e.prototype.setVa=function(){r.context3D.pushVa(this.data.objData.vertexBuffer)||(r.context3D.setVaOffset(0,3,this.data.objData.stride,0),r.context3D.setVaOffset(1,2,this.data.objData.stride,12)),this.setMaterialTexture(),r.context3D.drawCall(this.data.objData.indexBuffer,this.data.objData.treNum)},e.prototype.setVc=function(){this.updateMatrix(),this.updateBind(),this.data.vcmatData.set(r.viewMatrx3D.m,0),this.data.vcmatData.set(r.cam3D.cameraMatrix.m,16),this._caramPosVec[0]=r.cam3D.x,this._caramPosVec[1]=r.cam3D.y,this._caramPosVec[2]=r.cam3D.z,this.data.vcmatData.set(this._caramPosVec,32),r.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData),this.setBindPosVc(),this.setMaterialVc()},e.prototype.setBindPosVc=function(){for(var t=0;t<this._bindPosAry.length;t++)r.context3D.setVc3fv(this.data.materialParam.shader,"bindpos["+t+"]",this._bindPosAry[t])},e.prototype.reset=function(){this.resetPos(),t.prototype.reset.call(this)},e.prototype.updateMatrix=function(){this.modelMatrix.identity(),this.modelMatrix.prepend(this.posMatrix)},e.prototype.resetPos=function(){for(var t=0;t<this._bindPosAry.length;t+=2)this._bindPosAry[t][0]=this.bindVecter3d.x,this._bindPosAry[t][1]=this.bindVecter3d.y,this._bindPosAry[t][2]=this.bindVecter3d.z;this.flag=h.getTimer()},e.prototype.updateBind=function(){var t=h.getTimer();if(t-this.flag>=e.waitCdTime){var i=this._bindPosAry.pop(),r=this._bindPosAry.pop();r[0]=this.bindVecter3d.x,r[1]=this.bindVecter3d.y,r[2]=this.bindVecter3d.z;var n=this._bindPosAry[0],s=this._bindPosAry[1],o=new a(r[0]-n[0],r[1]-n[1],r[2]-n[2]);o.normalize(),s[0]=o.x,i[0]=o.x,s[1]=o.y,i[1]=o.y,s[2]=o.z,i[2]=o.z,this._bindPosAry.unshift(i),this._bindPosAry.unshift(r),this.flag=t}},e.waitCdTime=35,e}(rt),St=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2TexCoord")},e.prototype.getMat4Str=function(t){return"vcmat["+e.shader_mat4[t]+"]"},e.prototype.getVec4Str=function(t){return"vcmat["+e.shader_vec4[t][0]+"]["+e.shader_vec4[t][1]+"]"},e.getVcSize=function(){return 3},e.prototype.getVertexShaderString=function(){return"attribute vec3 v3Position;\nattribute vec2 v2TexCoord;\nuniform mat4 vcmat["+st.getVcSize()+"];\nuniform vec3 bindpos[30];\nvarying vec2 v0;\n"+"void main(){\n"+("   vec3 cpos = bindpos[int(v3Position.x)];\n   vec3 mulPos = normalize(vec3("+this.getVec4Str("camPos")+".xyz) - cpos);\n   vec3 normals = bindpos[int(v3Position.y)];\n   mulPos = cross(mulPos, normals);\n   mulPos = normalize(mulPos);\n   mulPos *= v3Position.z;\n   cpos += mulPos;\n   gl_Position = "+this.getMat4Str("viewMatrix3D")+"  * "+this.getMat4Str("camMatrix3D")+" * vec4(cpos,1.0);\n")+"v0 = v2TexCoord;\n}"},e.prototype.getFragmentShaderString=function(){return" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}"},e.Display3D_FollowLocus_Shader="Display3DFollowLocusShader",e.shader_mat4={viewMatrix3D:0,camMatrix3D:1},e.shader_vec4={camPos:[2,0]},e}(nt),It=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.getParticle=function(){return new Pt},e.prototype.setAllByteInfo=function(e){this._fenduanshu=e.readFloat(),t.prototype.setAllByteInfo.call(this,e),this.uploadGpu(),this.initVcData()},e.prototype.uploadGpu=function(){this.objData=new L,this.objData.vertices=new Array,this.objData.uvs=new Array,this.objData.indexs=new Array;for(var t=0;t<=this._fenduanshu;t++){var e=new O(t/this._fenduanshu,0),i=new O(t/this._fenduanshu,1);e.scaleBy(.9),i.scaleBy(.9),this._isU&&(e.x=-e.x,i.x=-i.x),this._isV&&(e.y=-e.y,i.y=-i.y);var a=2*t;this.objData.vertices.push(a,a+1,-this._originWidthScale*this._width/100),this._isUV?this.objData.vertices.push(e.y,e.x):this.objData.vertices.push(e.x,e.y),this.objData.vertices.push(a,a+1,(1-this._originWidthScale)*this._width/100),this._isUV?this.objData.vertices.push(i.y,i.x):this.objData.vertices.push(i.x,i.y)}for(t=0;t<this._fenduanshu;t++)this.objData.indexs.push(0+2*t,1+2*t,2+2*t,1+2*t,3+2*t,2+2*t);this.pushToGpu()},e.prototype.pushToGpu=function(){this.objData.vertexBuffer=r.context3D.uploadBuff3D(this.objData.vertices),this.objData.indexBuffer=r.context3D.uploadIndexBuff3D(this.objData.indexs),this.objData.stride=20,this.objData.treNum=this.objData.indexs.length},e.prototype.initVcData=function(){this.vcmatData=new Float32Array(16*St.getVcSize())},e.prototype.regShader=function(){if(this.materialParam){new St;this.materialParam.shader=V.getInstance().getMaterialProgram(St.Display3D_FollowLocus_Shader,St,this.materialParam.material),this.materialParam.program=this.materialParam.shader.program}},e}(at),Bt=function(t){function e(){var e=t.call(this)||this;return e.name="Material_Anim_shader",e}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"pos"),t.bindAttribLocation(this.program,1,"v2Uv"),t.bindAttribLocation(this.program,2,"boneID"),t.bindAttribLocation(this.program,3,"boneWeight");var e=this.paramAry[0],i=this.paramAry[1],a=this.paramAry[4],r=this.paramAry[5];e?(t.bindAttribLocation(this.program,4,"normal"),i&&(t.bindAttribLocation(this.program,5,"tangent"),t.bindAttribLocation(this.program,6,"bitangent"))):(a||r)&&t.bindAttribLocation(this.program,4,"normal")},e.getMd5M44Str=function(){return"vec4 qdv(vec4 q,vec3 d, vec3 v ){\nvec3 t = 2.0 * cross(q.xyz, v);\nvec3 f = v + q.w * t + cross(q.xyz, t);\nreturn  vec4(f.x+d.x,f.y+d.y,f.z+d.z,1.0);\n }\nvec4 getQDdata(vec3 vdata){\nvec4 tempnum = qdv(boneQ[int(boneID.x)],boneD[int(boneID.x)],vdata) * boneWeight.x;\ntempnum += qdv(boneQ[int(boneID.y)],boneD[int(boneID.y)],vdata) * boneWeight.y;\ntempnum += qdv(boneQ[int(boneID.z)],boneD[int(boneID.z)],vdata)* boneWeight.z;\ntempnum += qdv(boneQ[int(boneID.w)],boneD[int(boneID.w)],vdata) * boneWeight.w;\ntempnum.x = tempnum.x*-1.0;\nreturn  tempnum;\n }\n"},e.getMd5M44NrmStr=function(){return"vec4 qdvNrm(vec4 q, vec3 v ){\nvec3 t = 2.0 * cross(q.xyz, v);\nvec3 f = v + q.w * t + cross(q.xyz, t);\nreturn  vec4(f.x,f.y,f.z,1.0);\n }\nvec4 getQDdataNrm(vec3 vdata){\nvec4 tempnum = qdvNrm(boneQ[int(boneID.x)],vdata) * boneWeight.x;\ntempnum += qdvNrm(boneQ[int(boneID.y)],vdata) * boneWeight.y;\ntempnum += qdvNrm(boneQ[int(boneID.z)],vdata)* boneWeight.z;\ntempnum += qdvNrm(boneQ[int(boneID.w)],vdata) * boneWeight.w;\ntempnum.x = tempnum.x*-1.0;\ntempnum.xyz = normalize(tempnum.xyz);\nreturn  tempnum;\n }\n"},e.prototype.getVertexShaderString=function(){var t=this.paramAry[0],i=this.paramAry[1],a=(this.paramAry[2],this.paramAry[3],this.paramAry[4]),r=this.paramAry[5],n=this.paramAry[6],s="attribute vec4 pos;\nattribute vec2 v2Uv;\nattribute vec4 boneID;\nattribute vec4 boneWeight;\nvarying vec2 v0;\nuniform vec4 boneQ[54];\nuniform vec3 boneD[54];\nuniform mat4 vpMatrix3D;\nuniform mat4 posMatrix3D;\n";return a?s+="uniform vec3 sh[9];\nvarying vec3 v2;\n":r?s+="uniform vec3 sunDirect;\nuniform vec3 sunColor;\nuniform vec3 ambientColor;\nvarying vec3 v2;\n":n||(s+="varying vec2 v2;\n"),t?(s+="attribute vec4 normal;\nuniform mat4 rotationMatrix3D;\nvarying vec3 v1;\n",s+=i?"varying mat3 v4;\n":"varying vec3 v4;\n",i&&(s+="attribute vec4 tangent;\nattribute vec4 bitangent;\n")):(a||r)&&(s+="attribute vec4 normal;\nuniform mat4 rotationMatrix3D;\n"),s+=e.getMd5M44Str()+e.getMd5M44NrmStr()+"void main(void){\nv0 = v2Uv;\nvec4 vt0 = getQDdata(vec3(pos.x,pos.y,pos.z));\nvt0.xyz = vt0.xyz*1.0;\nvt0 = posMatrix3D * vt0;\n",t&&(s+="v1 = vec3(vt0.x,vt0.y,vt0.z);\n"),s+="vt0 = vpMatrix3D * vt0;\ngl_Position = vt0;\n",t?s+=i?"vec4 vt2 = getQDdataNrm(vec3(tangent.x,tangent.y,tangent.z));\nvt2 = rotationMatrix3D * vt2;\nvt2.xyz = normalize(vt2.xyz);\nvec4 vt1 = getQDdataNrm(vec3(bitangent.x,bitangent.y,bitangent.z));\nvt1 = rotationMatrix3D * vt1;\nvt1.xyz = normalize(vt1.xyz);\nvt0 = getQDdataNrm(vec3(normal.x,normal.y,normal.z));\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\nv4 = mat3(vec3(vt2.x,vt2.y,vt2.z),vec3(vt1.x,vt1.y,vt1.z),vec3(vt0.x,vt0.y,vt0.z));\n":"vt0 = getQDdataNrm(vec3(normal.x,normal.y,normal.z));\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\nv4 = vec3(vt0.x,vt0.y,vt0.z);\n":(a||r)&&(s+="vt0 = getQDdataNrm(vec3(normal.x,normal.y,normal.z));\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\n"),a?s+="vec3 lpb = sh[0] * 0.28209479177387814;\nlpb += sh[1] * (vt0.y * -0.4886025119029199);\nlpb += sh[2] * (vt0.z * 0.4886025119029199);\nlpb += sh[3] * (vt0.x * -0.4886025119029199);\nlpb += sh[4] * (vt0.x * vt0.y * 1.0925484305920792);\nlpb += sh[5] * (vt0.z * vt0.y * -1.0925484305920792);\nlpb += sh[6] * ((3.0 * vt0.z * vt0.z - 1.0) * 0.31539156525252005);\nlpb += sh[7] * (vt0.z * vt0.x * -1.0925484305920792);\nlpb += sh[8] * ((vt0.x * vt0.x - vt0.y * vt0.y) * 0.5462742152960396);\nv2 = lpb;\n":r?s+="float suncos = dot(vt0.xyz,sunDirect.xyz);\nsuncos = clamp(suncos,0.0,1.0);\nv2 = sunColor * suncos + ambientColor;":n||(s+="v2 = v2Uv;\n"),s+="}"},e.prototype.getFragmentShaderString=function(){return"uniform sampler2D s_texture1;\nuniform vec4 testconst;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz = testconst.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}"},e.MATERIAL_ANIM_SHADER="Material_Anim_shader",e}(nt),Rt=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"pos"),t.bindAttribLocation(this.program,1,"v2uv"),t.bindAttribLocation(this.program,2,"boneWeight"),t.bindAttribLocation(this.program,3,"boneID")},e.prototype.getMat4Str=function(t){return"vcmat["+e.shader_mat4[t]+"]"},e.getVcSize=function(){return 3},e.prototype.getVertexShaderString=function(){return"attribute vec3 pos;attribute vec2 v2uv;attribute vec4 boneWeight;attribute vec4 boneID;uniform vec4 boneQ[54];\nuniform vec3 boneD[54];\nuniform mat4 vcmat["+e.getVcSize()+"];\nvarying vec2 v0;\n"+Bt.getMd5M44Str()+"void main(void){v0 = v2uv;\nvec4 vt0 = getQDdata(vec3(pos.x,pos.y,pos.z));\n gl_Position = "+this.getMat4Str("viewMatrix3D")+" * "+this.getMat4Str("camMatrix3D")+" *"+this.getMat4Str("posMatrix3D")+"* vt0;}"},e.prototype.getFragmentShaderString=function(){return"precision mediump float;\nvarying vec2 v0;\nvoid main(void)\n{\ngl_FragColor = vec4(1.0,0.0,1.0,1.0);\n}"},e.Display3DBoneShader="Display3DBoneShader",e.shader_mat4={viewMatrix3D:0,camMatrix3D:1,posMatrix3D:2},e}(nt),Ft=function(t){function e(){var e=t.call(this)||this;return e.skipNum=0,e}return i(e,t),Object.defineProperty(e.prototype,"modeldata",{get:function(){return this.data},enumerable:!1,configurable:!0}),e.prototype.creatData=function(){this.data=new Nt},e.prototype.update=function(){r.context3D.setWriteDepth(!1),t.prototype.update.call(this)},e.prototype.setVc=function(){var t=o.float2int(this._time/r.frameTime/2);this.data.vcmatData.set(r.viewMatrx3D.m,0),this.data.vcmatData.set(r.cam3D.cameraMatrix.m,16),this.data.vcmatData.set(this.modelMatrix.m,32),r.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData);var e=this.modeldata.animData.boneQPAry[0],i=e[t%e.length];r.context3D.setVc4fv(this.data.materialParam.shader,"boneQ",i.quat),r.context3D.setVc3fv(this.data.materialParam.shader,"boneD",i.pos),this.setMaterialVc()},e.prototype.setVa=function(){r.context3D.pushVa(this.modeldata.meshData.vertexBuffer)||(r.context3D.setVaOffset(0,3,this.modeldata.meshData.stride,0),r.context3D.setVaOffset(1,2,this.modeldata.meshData.stride,12),r.context3D.setVaOffset(3,4,this.modeldata.meshData.stride,20),r.context3D.setVaOffset(2,4,this.modeldata.meshData.stride,36)),this.setMaterialTexture(),r.context3D.drawCall(this.modeldata.meshData.indexBuffer,this.modeldata.meshData.treNum)},e.prototype.resetVa=function(){t.prototype.resetVa.call(this)},e}(rt),Lt=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.boneIDAry=new Array,e.boneWeightAry=new Array,e.boneNewIDAry=new Array,e.particleAry=new Array,e}return i(e,t),e.prototype.getBindPosMatrix=function(){for(var t=new Array,e=new Array,i=0;i<this.bindPosAry.length;i++){var a=this.bindPosAry[i],r=new p(a[0],a[1],a[2]);r.setMd5W();var n=r.toMatrix3D();n.appendTranslation(a[3],a[4],a[5]),e.push(n.clone()),n.invert(),t.push(n)}this.bindPosMatrixAry=t,this.bindPosInvertMatrixAry=e},e.prototype.destory=function(){t.prototype.destory.call(this),this.materialParam&&(this.materialParam.destory(),this.materialParam=null,this.materialParamData=null),this.boneIDAry.length=0,this.boneWeightAry.length=0,this.boneNewIDAry.length=0,this.boneIDAry=null,this.boneWeightAry=null,this.boneNewIDAry=null,this.boneWeightBuffer&&(r.context3D.deleteBuffer(this.boneWeightBuffer),this.boneWeightBuffer=null),this.boneIdBuffer&&(r.context3D.deleteBuffer(this.boneIdBuffer),this.boneIdBuffer=null),this.material&&this.material.clearUseNum(),this.particleAry.length=0,this.particleAry=null},e}(L),Ct=function(t,e){this.url=t,this.socketName=e},Et=function(){function t(t){this._keys=new Array,this._values=new Array;for(var e=0;t&&e<t.length;e++)this[t[e].key]=t[e].value,this._keys.push(t[e].key),this._values.push(t[e].value)}return t.prototype.add=function(t,e){this[t]=e,this._keys.push(t),this._values.push(e)},t.prototype.has=function(t){return!!this[t]},t.prototype.remove=function(t){var e=this._keys.indexOf(t,0);this._keys.splice(e,1),this._values.splice(e,1),delete this[t]},t.prototype.keys=function(){return this._keys},t.prototype.values=function(){return this._values},t.prototype.containsKey=function(t){return void 0!==this[t]},t.prototype.toLookup=function(){return this},t}(),zt=function(){},Vt=function(){function t(){this.inLoop=0,this.inter=new Array,this.bounds=new Array,this.nameHeight=0,this.posAry=new Array,this.hasProcess=!1}return t.prototype.processMesh=function(t){this.hasProcess||(this.makeArrBoneQPAry(t),this.hasProcess=!0)},t.prototype.makeArrBoneQPAry=function(t){this.meshBoneQPAryDic=new Et([]);for(var e=0;e<t.meshAry.length;e++){for(var i=this.conleMatrixArr(),a=0;a<i.length;a++)for(var r=i[a],n=0;n<r.length;n++)t.meshAry[e].bindPosMatrixAry[n]&&r[n].prepend(t.meshAry[e].bindPosMatrixAry[n]);var s=this.makeFrameDualQuatFloatArray(t,i);this.meshBoneQPAryDic[t.meshAry[e].uid]=s,this.boneQPAry=s}this.matrixAry=i},t.prototype.getBoneQPAryByMesh=function(t){return this.meshBoneQPAryDic[t.uid]},t.prototype.conleMatrixArr=function(){for(var t=new Array,e=0;e<this.matrixAry.length;e++){for(var i=this.matrixAry[e],a=new Array,r=0;r<i.length;r++)a.push(i[r].clone());t.push(a)}return t},t.prototype.makeFrameDualQuatFloatArray=function(t,e){for(var i=new Array,a=new d,r=0;r<t.meshAry.length;r++){for(var n=new Array,s=t.meshAry[r].boneNewIDAry,o=0;o<e.length;o++){var h=e[o],c=new zt;c.quat=new Float32Array(4*s.length),c.pos=new Float32Array(3*s.length);for(var l=0;l<s.length;l++){var u=h[s[l]].clone(a);u.appendScale(-1,1,1);var f=new p;f.fromMatrix(u);var y=u.position;c.quat[4*l+0]=f.x,c.quat[4*l+1]=f.y,c.quat[4*l+2]=f.z,c.quat[4*l+3]=f.w,c.pos[3*l+0]=y.x,c.pos[3*l+1]=y.y,c.pos[3*l+2]=y.z}n.push(c)}i.push(n)}return i},t}(),Nt=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.objScale=1,e}return i(e,t),e.prototype.getParticle=function(){return new Ft},e.prototype.destory=function(){t.prototype.destory.call(this),this.meshData.destory(),this.animData=null},e.prototype.setAllByteInfo=function(e){this.meshData=new Lt,this.animData=new Vt,this.objScale=e.readFloat();var i=e.getInt(),a=new ArrayBuffer(i*=52),n=new DataView(a);Ot.readBytes2ArrayBuffer(e,n,3,0,13),Ot.readBytes2ArrayBuffer(e,n,2,3,13),Ot.readIntForTwoByte(e,this.meshData.indexs),Ot.readBytes2ArrayBuffer(e,n,4,5,13,2),Ot.readBytes2ArrayBuffer(e,n,4,9,13,3),this.meshData.stride=52,this.readFrameQua(e),t.prototype.setAllByteInfo.call(this,e),this.initVcData(),this.meshData.vertexBuffer=r.context3D.uploadBuff3DArrayBuffer(a),this.meshData.indexBuffer=r.context3D.uploadIndexBuff3D(this.meshData.indexs),this.meshData.treNum=this.meshData.indexs.length},e.prototype.initVcData=function(){this.vcmatData=new Float32Array(16*Rt.getVcSize())},e.prototype.setFloat32Mat=function(t,e){var i=16*Rt.shader_mat4[t];this.vcmatData.set(e,i)},e.prototype.readFrameQua=function(t){for(var e=t.readFloat(),i=t.readInt(),a=new Array,r=0;r<i;r++){var n=t.readInt(),s=new zt;s.quat=new Float32Array(4*n),s.pos=new Float32Array(3*n);for(var o=0;o<n;o++)s.quat[4*o+0]=t.readShort()/32767,s.quat[4*o+1]=t.readShort()/32767,s.quat[4*o+2]=t.readShort()/32767,s.quat[4*o+3]=t.readShort()/32767,s.pos[3*o+0]=t.readShort()/32767*e,s.pos[3*o+1]=t.readShort()/32767*e,s.pos[3*o+2]=t.readShort()/32767*e;a.push(s)}this.animData.boneQPAry=new Array,this.animData.boneQPAry.push(a)},e.prototype.uploadGpu=function(){this.uploadMesh(this.meshData)},e.prototype.uploadMesh=function(t){t.vertexBuffer=r.context3D.uploadBuff3D(t.vertices),t.uvBuffer=r.context3D.uploadBuff3D(t.uvs),t.boneIdBuffer=r.context3D.uploadBuff3D(t.boneIDAry),t.boneWeightBuffer=r.context3D.uploadBuff3D(t.boneWeightAry),t.indexBuffer=r.context3D.uploadIndexBuff3D(t.indexs),t.treNum=t.indexs.length},e.prototype.regShader=function(){this.materialParam.shader=V.getInstance().getMaterialProgram(Rt.Display3DBoneShader,Rt,this.materialParam.material),this.materialParam.program=this.materialParam.shader.program},e}(at),kt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.destory=function(){for(var t=0;t<this.dataAry.length;t++)this.dataAry[t].destory()},e.prototype.getCombineParticle=function(){var t=new Mt;t.maxTime=this.maxTime;for(var e=0;e<this.dataAry.length;e++){var i=this.dataAry[e].creatPartilce();t.addPrticleItem(i)}return t.sourceData=this,this.useNum++,t},e.prototype.setDataByte=function(t){t.position=0;var e=t.readInt(),i=t.readInt();this.maxTime=0,this.dataAry=new Array;for(var a=0;a<i;a++){var n=t.readInt(),s=this.getParticleDataType(n);s.version=e,s.setAllByteInfo(t),this.dataAry.push(s),s.timelineData.maxFrameNum>this.maxTime&&(this.maxTime=s.timelineData.maxFrameNum)}this.maxTime*=r.frameTime},e.prototype.getParticleDataType=function(t){var e;switch(t){case 1:e=new ot;break;case 18:e=new pt;break;case 3:e=new yt;break;case 14:e=new vt;break;case 9:case 4:case 7:e=new _t;break;case 8:e=new At;break;case 12:e=new It;break;case 13:e=new Nt}return e},e}(x),Ut=function(t){function e(){var e=t.call(this)||this;return e._time=0,e.renderDic=new Object,e._particleList=new Array,e}return i(e,t),e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.getParticleByte=function(t){t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt");var e=new Mt,i=t;this._dic[i]&&(e=this._dic[i].getCombineParticle());return e.url=i,e},e.prototype.registerUrl=function(t){(t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this._dic[t])&&this._dic[t].useNum++},e.prototype.releaseUrl=function(t){(t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this._dic[t])&&this._dic[t].clearUseNum()},e.prototype.addResByte=function(t,e){if(!this._dic[t]){var i=new kt;i.setDataByte(e),this._dic[t]=i}},e.prototype.update=function(){this.updateRenderDic(),this.clearPaticleVa()},e.prototype.clearPaticleVa=function(){r.context3D.clearVa(2),r.context3D.clearVa(3),r.context3D.clearVa(4),r.context3D.clearVa(5)},e.prototype.setHide=function(){for(var t=0;t<this._particleList.length;t++)this._particleList[t].dynamic},Object.defineProperty(e.prototype,"particleList",{get:function(){return this._particleList},enumerable:!1,configurable:!0}),e.prototype.updateTime=function(){for(var t=h.getTimer(),e=t-this._time,i=0;i<this._particleList.length;i++)this._particleList[i].sceneVisible&&this._particleList[i].updateTime(e);this._time=t},e.prototype.addRenderDic=function(t){var e=t.url;this.renderDic[e]||(this.renderDic[e]=new Array),this.renderDic[e].push(t)},e.prototype.removeRenderDic=function(t){var e=t.url,i=this.renderDic[e].indexOf(t);-1!=i&&(this.renderDic[e].splice(i,1),0==this.renderDic[e].length&&delete this.renderDic[e])},e.prototype.updateRenderDic=function(){for(var t in this.renderDic){var e=this.renderDic[t];if(1==e.length)e[0].update();else for(var i=e[0].size,a=0;a<i;a++)for(var r=0;r<e.length;r++)e[r].updateItem(a)}},e.prototype.addParticle=function(t){-1==this._particleList.lastIndexOf(t)&&(this._particleList.push(t),this.addRenderDic(t))},e.prototype.removeParticle=function(t){var e=this._particleList.indexOf(t);-1!=e&&(this._particleList.splice(e,1),this.removeRenderDic(t))},e.prototype.gc=function(){t.prototype.gc.call(this)},e}(b),Ot=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.allImgBytes=1e7,e}return i(e,t),e.prototype.read=function(t){void 0===t&&(t=null),this._imgFun=t;var i=this._byte.readInt();i==e.IMG_TYPE?r.supportBlob?this.readImg():this.readImgLow():i==e.OBJS_TYPE?this.readObj(this._byte):i==e.MATERIAL_TYPE?this.readMaterial():i==e.PARTICLE_TYPE?this.readParticle():i==e.ZIP_OBJS_TYPE&&this.readZipObj()},e.prototype.readZipObj=function(){var t=this._byte.readInt(),e=this._byte.buffer.slice(this._byte.position,this._byte.position+t);this._byte.position+=t;var i=o.unZip(e),a=new s(i);this.readObj(a)},e.prototype.readImg=function(){var t=this;this.imgNum=this._byte.readInt(),this.imgLoadNum=0;for(var e=0;e<this.imgNum;e++){var i=r.fileRoot+this._byte.readUTF(),a=this._byte.readInt();if(-1==i.search(".jpng")){var n=this._byte.buffer.slice(this._byte.position,this._byte.position+a);this._byte.position+=a;var s=new Image;s.url=i,s.onload=function(e){t.loadImg(e.target);e.target};i.substr(i.lastIndexOf(".")+1).toLocaleLowerCase();"jpg",console.log(i+"readImgdata:image/jpg;base64,"),s.src="data:image/jpg;base64,"+D.encode(n)}else this.readJpngImg(i)}},e.prototype.readJpngImg=function(t){var e=this,i=this._byte.readInt(),a=this._byte.buffer.slice(this._byte.position,this._byte.position+i);this._byte.position+=i;var r=this._byte.readInt(),n=this._byte.buffer.slice(this._byte.position,this._byte.position+r);this._byte.position+=r;var s=new Image,o=new Image,h=0,c=function(i){if(!(++h<2)){var a=M.getInstance().getContext2D(s.width,s.height);a.drawImage(s,0,0);var r=a.getImageData(0,0,s.width,s.height);a.clearRect(0,0,s.width,s.height),a.drawImage(o,0,0);for(var n=a.getImageData(0,0,s.width,s.height),c=0;c<r.data.length;c+=4){n.data[c];r.data[c+3]=n.data[c]}e.addImg(t.replace(".jpng",".png"),r)}};s.onload=c,o.onload=c,s.src="data:image/png;base64,"+D.encode(a),o.src="data:image/png;base64,"+D.encode(n)},e.prototype.readImgLow=function(){var t=this;this.imgNum=this._byte.readInt(),this.imgLoadNum=0;h.getTimer();for(var e=0,i=0;i<this.imgNum;i++){var a=r.fileRoot+this._byte.readUTF();e+=this._byte.readInt();var n=new Image;n.url=a,n.onload=function(e){t.loadImg(e.target)},n.src=a}this.allImgBytes=e},e.prototype.loadImg=function(t){I.getInstance().addRes(t.url,t),this.countImg()},e.prototype.addImg=function(t,e){I.getInstance().addRes(t,e),this.countImg()},e.prototype.countImg=function(){this.imgLoadNum++,this.imgLoadNum==this.imgNum&&(this._imgComplete=!0,this.allResCom())},e.prototype.readObj=function(t){for(var e=t.readInt(),i=0;i<e;i++){var a=r.fileRoot+t.readUTF(),n=t.readInt(),o=new s;o.length=n,t.readBytes(o,0,n);Wt.getInstance().loadObjCom(o.buffer,a)}this._imgFun&&this._imgFun()},e.prototype.readMaterial=function(){for(var t=this._byte.readInt(),e=(h.getTimer(),0);e<t;e++){var i=r.fileRoot+this._byte.readUTF(),a=this._byte.readInt(),n=new s;n.length=a,this._byte.readBytes(n,0,a),N.getInstance().addResByte(i,n)}},e.prototype.readParticle=function(){for(var t=this._byte.readInt(),e=(h.getTimer(),0);e<t;e++){var i=r.fileRoot+this._byte.readUTF(),a=this._byte.readInt(),n=new s;n.length=a,this._byte.readBytes(n,0,a),Ut.getInstance().addResByte(i,n)}},e.prototype.readMaterialInfo=function(){var t=this._byte.readInt();if(t>0){for(var e=new Array,i=0;i<t;i++){var a=new Object;a.type=this._byte.readInt(),a.name=this._byte.readUTF(),0==a.type&&(a.url=this._byte.readUTF()),1==a.type&&(a.x=this._byte.readFloat()),2==a.type&&(a.x=this._byte.readFloat(),a.y=this._byte.readFloat()),3==a.type&&(a.x=this._byte.readFloat(),a.y=this._byte.readFloat(),a.z=this._byte.readFloat()),e.push(a)}return e}return null},e.readFloatTwoByte=function(t,e){var i=t.readInt();if(i>0){var a=t.readFloat();e.length=0;for(var r=0;r<i;r++)e.push(t.readFloatTwoByte(a))}},e.readFloatOneByte=function(t,e){var i=t.readInt();if(i>0)for(var a=0;a<i;a++)e.push((t.readByte()+128)/256)},e.readIntForTwoByte=function(t,e){for(var i=t.readInt(),a=0;a<i;a++)e.push(t.readShort())},e.readIntForOneByte=function(t,e){for(var i=t.readInt(),a=0;a<i;a++)e.push(t.readByte())},e.readBytes2ArrayBuffer=function(t,e,i,a,r,n){void 0===n&&(n=0);var s=t.readInt();if(!(s<=0)){var o;0==n&&(o=t.readFloat());for(var h,c=s/i,l=0;l<c;l++)for(var u=r*l+a,p=0;p<i;p++)0==n?h=t.readFloatTwoByte(o):1==n?h=t.readFloatOneByte():2==n?h=t.readByte():3==n?h=(t.readByte()+128)/255:4==n&&(h=t.readFloat()),e.setFloat32(4*(u+p),h,!0)}},e.readMaterialParamData=function(t){var e=t.readInt();if(e>0){for(var i=new Array,a=0;a<e;a++){var r=new Object;r.name=t.readUTF(),r.type=t.readByte(),0==r.type?r.url=t.readUTF():1==r.type?r.x=t.readFloat():2==r.type?(r.x=t.readFloat(),r.y=t.readFloat()):3==r.type&&(r.x=t.readFloat(),r.y=t.readFloat(),r.z=t.readFloat()),i.push(r)}return i}return null},e.prototype.allResCom=function(){this._imgFun&&this._imgFun()},e.IMG_TYPE=1,e.OBJS_TYPE=2,e.MATERIAL_TYPE=3,e.PARTICLE_TYPE=4,e.SCENE_TYPE=5,e.ZIP_OBJS_TYPE=6,e.PREFAB_TYPE=1,e.SCENE_PARTICLE_TYPE=11,e}(x),jt=function(t){function e(e,i,a){return t.call(this)||this}return i(e,t),e}(y),Xt=function(){},Wt=function(t){function e(){var e=t.call(this)||this;return e._loadList=new Object,e}return i(e,t),e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.getObjData=function(t,e){var i=this;if(this._dic[t])return e(this._dic[t]),void this._dic[t].useNum++;this._loadList[t]||(this._loadList[t]=new Array,w.getInstance().load(t,w.BYTE_TYPE,(function(e){i.loadObjCom(e,t)}))),this._loadList[t].push(e)},e.prototype.registerUrl=function(t){this._dic[t]&&this._dic[t].useNum++},e.prototype.releaseUrl=function(t){this._dic[t]&&this._dic[t].clearUseNum()},e.prototype.gc=function(){t.prototype.gc.call(this)},e.prototype.readFloatNrm=function(t,e){var i=t.readInt();if(i>0)for(var a=0;a<i;a++)e.push(t.readFloat())},e.prototype.readcollisionItem=function(t,e){var i=t.readInt();if(i>0){e.collision=new Xt,e.collision.collisionItem=new Array;for(var a=0;a<i;a++){var r=JSON.parse(t.readUTF()),n=new jt;n.scaleX=r.scale_x,n.scaleY=r.scale_y,n.scaleZ=r.scale_z,n.x=r.x,n.y=r.y,n.z=r.z,n.rotationX=r.rotationX,n.rotationY=r.rotationY,n.rotationZ=r.rotationZ,n.scaleX=this.getFloadNum(n.scaleX),n.scaleY=this.getFloadNum(n.scaleY),n.scaleZ=this.getFloadNum(n.scaleZ),n.rotationX=this.getFloadNum(n.rotationX),n.rotationY=this.getFloadNum(n.rotationY),n.rotationZ=this.getFloadNum(n.rotationZ),n.type=r.type,n.data=r.data,e.collision.collisionItem.push(n)}}},e.prototype.getFloadNum=function(t){return Math.floor(1e3*t)/1e3},e.prototype.loadObjCom=function(t,e){if(!this._dic[e]){var i=new L,a=new s(t),n=a.readInt();a.readUTF();n>=20?(this.readObj2OneBuffer(a,i),n>=37&&a.position<a.length&&this.readcollisionItem(a,i)):(Ot.readFloatTwoByte(a,i.vertices),Ot.readFloatTwoByte(a,i.uvs),Ot.readFloatOneByte(a,i.lightuvs),Ot.readFloatTwoByte(a,i.normals),Ot.readIntForTwoByte(a,i.indexs),Ot.readFloatTwoByte(a,i.tangents),Ot.readFloatTwoByte(a,i.bitangents),i.vertexBuffer=r.context3D.uploadBuff3D(i.vertices),i.uvBuffer=r.context3D.uploadBuff3D(i.uvs),i.lightUvBuffer=r.context3D.uploadBuff3D(i.lightuvs),i.normalsBuffer=r.context3D.uploadBuff3D(i.normals)),i.treNum=i.indexs.length,i.indexBuffer=r.context3D.uploadIndexBuff3D(i.indexs),this._dic[e]=i;var o=this._loadList[e];if(o){for(var h=0;h<o.length;h++)o[h](i);delete this._loadList[e]}return i}},e.prototype.readObj2OneBuffer=function(t,e){for(var i,a=new Array,n=(a=new Array,0),s=0;s<6;s++){var o=t.readBoolean();if(a.push(o),o)switch(s){case 1:case 2:n+=2;break;default:n+=3}}i=t.readFloat(),i*=4*n;var h=new ArrayBuffer(i),c=new DataView(h),l=a[2]?7:5,u=l+3,p=u+3;Ot.readBytes2ArrayBuffer(t,c,3,0,n),Ot.readBytes2ArrayBuffer(t,c,2,3,n),Ot.readBytes2ArrayBuffer(t,c,2,5,n,1),Ot.readBytes2ArrayBuffer(t,c,3,l,n),Ot.readBytes2ArrayBuffer(t,c,3,u,n),Ot.readBytes2ArrayBuffer(t,c,3,p,n),Ot.readIntForTwoByte(t,e.indexs),e.vertexBuffer=r.context3D.uploadBuff3DArrayBuffer(h),e.compressBuffer=!0,e.uvsOffsets=12,e.lightuvsOffsets=20,e.normalsOffsets=4*l,e.tangentsOffsets=4*u,e.bitangentsOffsets=4*p,e.stride=4*n},e.prototype.creatTBNBuffer=function(t){t.tangentBuffer=r.context3D.uploadBuff3D(t.tangents),t.bitangentBuffer=r.context3D.uploadBuff3D(t.bitangents)},e}(b),Yt=function(t){function e(){var e=t.call(this)||this;return e.name="Material_shader",e}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2CubeTexST");var e=this.paramAry[0],i=this.paramAry[1],a=(this.paramAry[4],this.paramAry[5]),r=this.paramAry[6];a||r||t.bindAttribLocation(this.program,2,"v2lightuv"),e?(t.bindAttribLocation(this.program,3,"v3Normal"),i&&(t.bindAttribLocation(this.program,4,"v3Tangent"),t.bindAttribLocation(this.program,5,"v3Bitangent"))):a&&t.bindAttribLocation(this.program,3,"v3Normal")},e.prototype.getVertexShaderString=function(){var t=this.paramAry[0],e=this.paramAry[1],i=(this.paramAry[2],this.paramAry[3],this.paramAry[4],this.paramAry[5]),a=this.paramAry[6],r=this.paramAry[7],n="attribute vec3 v3Position;\nattribute vec2 v2CubeTexST;\nvarying vec2 v0;\n";return i?n+="varying vec3 v2;\n":a||(n+="attribute vec2 v2lightuv;\nvarying vec2 v2;\n"),t?(n+="attribute vec3 v3Normal;\nvarying vec3 v1;\n",n+=e?"varying mat3 v4;\n":"varying vec3 v4;\n"):0!=r&&(n+="varying vec3 v1;\n"),e&&(n+="attribute vec3 v3Tangent;\nattribute vec3 v3Bitangent;\n"),i&&(t||(n+="attribute vec3 v3Normal;\n"),n+="uniform vec3 sunDirect;\nuniform vec3 sunColor;\nuniform vec3 ambientColor;\n"),n+="uniform mat4 vpMatrix3D;\nuniform mat4 posMatrix3D;\nuniform mat3 rotationMatrix3D;\n",n+="void main(void){\nv0 = vec2(v2CubeTexST.x, v2CubeTexST.y);\nvec4 vt0= vec4(v3Position, 1.0);\nvt0 = posMatrix3D * vt0;\n",i||a||(n+="v2 = vec2(v2lightuv.x, v2lightuv.y);\n"),(t||0!=r)&&(n+="v1 = vec3(vt0.x,vt0.y,vt0.z);\n"),n+="vt0 = vpMatrix3D * vt0;\n",t&&(n+=e?"v4 = mat3(rotationMatrix3D * v3Tangent,rotationMatrix3D * v3Bitangent, rotationMatrix3D * v3Normal);\n":"v4 = rotationMatrix3D * v3Normal;\n"),i&&(n+=t?"float suncos = dot(v4.xyz,sunDirect.xyz);\n":"vec3 n = rotationMatrix3D * v3Normal;\nfloat suncos = dot(n.xyz,sunDirect.xyz);\n",n+="suncos = clamp(suncos,0.0,1.0);\nv2 = sunColor * suncos + ambientColor;"),n+="gl_Position = vt0;}"},e.prototype.outstr=function(t){for(var e=t.split(";"),i=0;i<e.length;i++)String(o.trim(e[i]))},e.prototype.getFragmentShaderString=function(){return"uniform sampler2D s_texture1;\nuniform vec4 testconst;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz = testconst.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}"},e.MATERIAL_SHADER="Material_shader",e}(nt),Gt=function(t){function e(){var e=t.call(this)||this;return e.time=0,e.dynamic=!1,e._rotationMatrix=new d,e}return i(e,t),Object.defineProperty(e.prototype,"aabbVect",{get:function(){if(!this._aabbVect){var t=this.aabb,e=t.x,i=t.y,r=t.z,n=t.width,s=t.height,o=t.depth;this._aabbVect=new Array,this._aabbVect.push(new a(e,i,r)),this._aabbVect.push(new a(e+n,i,r)),this._aabbVect.push(new a(e,i+s,r)),this._aabbVect.push(new a(e,i,r+o)),this._aabbVect.push(new a(e+n,i+s,r)),this._aabbVect.push(new a(e+n,i,r+o)),this._aabbVect.push(new a(e,i+s,r+o)),this._aabbVect.push(new a(e+n,i+s,r+o))}return this._aabbVect},enumerable:!1,configurable:!0}),e.prototype.setObjUrl=function(t){var e=this;this.objurl=t,Wt.getInstance().getObjData(r.fileRoot+t,(function(t){e.objData=t,e.material&&(e.objData.tangentBuffer||Wt.getInstance().creatTBNBuffer(e.objData))}))},e.prototype.setPicUrl=function(t){var e=this;this.picUrl=t,I.getInstance().getTexture(r.fileRoot+t,(function(t){e.baseTexture=t}))},e.prototype.setLightMapUrl=function(t){var e=this;if(t&&""!=t){var i=r.fileRoot+t;I.getInstance().getTexture(i,(function(t){e.lightMapTextureRes=t}))}},Object.defineProperty(e.prototype,"lightMapTexture",{get:function(){return this.lightMapTextureRes,this.lightMapTextureRes.texture},enumerable:!1,configurable:!0}),e.prototype.setMaterialUrl=function(t,e){var i=this;void 0===e&&(e=null),t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this.materialUrl=r.fileRoot+t,N.getInstance().getMaterialByte(this.materialUrl,(function(t){i.material=t,i.material.useNormal&&i.objData&&!i.objData.tangentBuffer&&Wt.getInstance().creatTBNBuffer(i.objData),(i.material.usePbr||i.material.directLight)&&(i._rotationData=new Float32Array(9),i.updateRotationMatrix()),e&&(i.materialParam=new F,i.materialParam.setData(i.material,e))}),null,!0,Yt.MATERIAL_SHADER,Yt)},Object.defineProperty(e.prototype,"lightProbe",{get:function(){return this._lightProbe},set:function(t){if(this._lightProbe=t,this._lightProbe&&!this.resultSHVec){this.resultSHVec=new Array;for(var e=[.4444730390920146,-.3834955622240026,-.33124467509627725,.09365654209093091,-.05673310882817577,.2120523322966496,.02945768486978205,-.04965996229802928,-.1136529129285836],i=0;i<9;i++)this.resultSHVec.push(new a(e[i],e[i],e[i]))}},enumerable:!1,configurable:!0}),e.prototype.update=function(){this.dynamic&&!this.sceneVisible||this.updateMaterial()},e.prototype.updateMaterial=function(){this.material&&this.objData&&(r.context3D.setBlendParticleFactors(this.material.blendMode),r.context3D.cullFaceBack(this.material.backCull),this.updateBind(),r.context3D.setProgram(this.material.program),r.context3D.setWriteDepth(this.material.writeZbuffer),r.context3D.setVcMatrix4fv(this.material.shader,"posMatrix3D",this.posMatrix.m),this.setCam(),this.setMaterialVc(this.material,this.materialParam),this.setMaterialTexture(this.material,this.materialParam),this.setDirectLight(this.material),this.setMaterialVa(),r.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum))},e.prototype.setMaterialVa=function(){this.objData.compressBuffer?this.setMaterialVaCompress():this.setMaterialVaIndependent()},e.prototype.setMaterialVaIndependent=function(){r.context3D.setVa(0,3,this.objData.vertexBuffer),r.context3D.setVa(1,2,this.objData.uvBuffer),this.material.directLight||this.material.noLight||r.context3D.setVa(2,2,this.objData.lightUvBuffer),(this.material.usePbr||this.material.directLight)&&(r.context3D.setVa(3,3,this.objData.normalsBuffer),r.context3D.setVcMatrix3fv(this.material.shader,"rotationMatrix3D",this._rotationData)),this.material.useNormal&&(r.context3D.setVa(4,3,this.objData.tangentBuffer),r.context3D.setVa(5,3,this.objData.bitangentBuffer))},e.prototype.setMaterialVaCompress=function(){r.context3D.pushVa(this.objData.vertexBuffer)||(r.context3D.setVaOffset(0,3,this.objData.stride,0),r.context3D.setVaOffset(1,2,this.objData.stride,this.objData.uvsOffsets),this.material.directLight||this.material.noLight||r.context3D.setVaOffset(2,2,this.objData.stride,this.objData.lightuvsOffsets),(this.material.usePbr||this.material.directLight)&&(r.context3D.setVaOffset(3,3,this.objData.stride,this.objData.normalsOffsets),r.context3D.setVcMatrix3fv(this.material.shader,"rotationMatrix3D",this._rotationData)),this.material.useNormal&&(r.context3D.setVaOffset(4,3,this.objData.stride,this.objData.tangentsOffsets),r.context3D.setVaOffset(5,3,this.objData.stride,this.objData.bitangentsOffsets)))},e.prototype.setDirectLight=function(t){t.directLight&&(r.context3D.setVc3fv(t.shader,"ambientColor",r.light.ambientColor),r.context3D.setVc3fv(t.shader,"sunDirect",r.light.sunDirect),r.context3D.setVc3fv(t.shader,"sunColor",r.light.sunColor))},e.prototype.setCam=function(){r.context3D.setVpMatrix(this.material.shader,r.vpMatrix.m)},e.prototype.setBind=function(t,e){this.bindTarget=t,this.bindSocket=e,this.bindMatrix=new d},e.prototype.setGroup=function(t,e,i){this._isInGroup=!0,this._groupPos=t,this._groupRotation=e,this._groupScale=i,this.groupMatrix=new d,this.groupRotationMatrix=new d,this.groupMatrix.isIdentity=!1,this.groupMatrix.identity(),this.groupMatrix.appendScale(i.x,i.y,i.z),this.groupMatrix.appendRotation(e.x,a.X_AXIS),this.groupMatrix.appendRotation(e.y,a.Y_AXIS),this.groupMatrix.appendRotation(e.z,a.Z_AXIS),this.groupMatrix.appendTranslation(t.x,t.y,t.z),this.groupRotationMatrix.isIdentity=!1,this.groupRotationMatrix.identity(),this.groupRotationMatrix.prependRotation(e.z,a.Z_AXIS),this.groupRotationMatrix.prependRotation(e.y,a.Y_AXIS),this.groupRotationMatrix.prependRotation(e.x,a.X_AXIS)},e.prototype.updateBind=function(){this.bindTarget&&(this.posMatrix.identity(),this.posMatrix.appendScale(this._scaleX,this._scaleY,this._scaleZ),this._isInGroup&&this.posMatrix.append(this.groupMatrix),this.bindTarget.getSocket(this.bindSocket,this.bindMatrix),this.posMatrix.append(this.bindMatrix),this.bindMatrix.copyTo(this._rotationMatrix),this._rotationMatrix.identityPostion(),this._isInGroup&&this._rotationMatrix.prepend(this.groupRotationMatrix),this.sceneVisible=this.bindTarget.visible)},e.prototype.setBaseMaterialVc=function(t){var e=0;t.hasTime&&(e=(h.getTimer()-this.time)%1e5*.001),(t.hasTime||t.usePbr||t.useKill)&&r.context3D.setVc4fv(t.shader,"fc0",[1,0,t.killNum,e]),t.scaleLightMap&&r.context3D.setVcFloat(t.shader,"scalelight",r.scaleLight),(t.usePbr||1==t.fogMode)&&this.setCamPos(t),0!=t.fogMode&&(r.context3D.setVc2fv(t.shader,"fogdata",r.fogData),r.context3D.setVc3fv(t.shader,"fogcolor",r.fogColor))},e.prototype.setCamPos=function(t){t.updateCam(r.cam3D.x/100,r.cam3D.y/100,r.cam3D.z/100)},e.prototype.setMaterialVc=function(t,e){if(void 0===e&&(e=null),!(t.fcNum<=0)){var i=0;t.hasTime&&(i=(h.getTimer()-this.time)%1e5*.001),t.update(i),this.setCamPos(t),e&&e.update(),r.context3D.setVc4fv(t.shader,"fc",t.fcData)}},e.prototype.setMaterialTexture=function(t,e){void 0===e&&(e=null);for(var i=t.texList,a=0;a<i.length;a++)if(i[a].type==C.LIGHTMAP)r.context3D.setRenderTexture(t.shader,i[a].name,this.lightMapTexture,i[a].id);else if(i[a].type==C.LTUMAP&&r.pubLut)r.context3D.setRenderTexture(t.shader,i[a].name,r.pubLut,i[a].id);else if(i[a].type==C.CUBEMAP)if(t.useDynamicIBL);else{var n=Math.floor(5*t.roughness);if(r.skyCubeMap){var s=r.skyCubeMap[n];r.context3D.setRenderTextureCube(t.program,i[a].name,s,i[a].id)}}else i[a].texture&&r.context3D.setRenderTexture(t.shader,i[a].name,i[a].texture,i[a].id);if(e)for(a=0;a<e.dynamicTexList.length;a++)e.dynamicTexList[a].target&&r.context3D.setRenderTexture(t.shader,e.dynamicTexList[a].target.name,e.dynamicTexList[a].texture,e.dynamicTexList[a].target.id)},e.prototype.checkMaterialTexture=function(t){for(var e=t.texList,i=0;i<e.length;i++)if(e[i].type==C.LIGHTMAP){if(!this.lightMapTexture)return!1}else if(e[i].type==C.LTUMAP){if(!r.pubLut)return!1}else if(e[i].type==C.CUBEMAP){if(t.useDynamicIBL);else if(!r.skyCubeMap)return!1}else if(!e[i].texture)return!1;return!0},e.prototype.updateRotationMatrix=function(){try{this._rotationMatrix.identity(),this._rotationMatrix.appendRotation(this._rotationX,a.X_AXIS),this._rotationMatrix.appendRotation(this._rotationY,a.Y_AXIS),this._rotationMatrix.appendRotation(this._rotationZ,a.Z_AXIS),this._rotationData&&this._rotationMatrix.getRotaion(this._rotationData)}catch(t){}},e.prototype.setPos=function(t){this.x=t.x,this.y=t.y+10,this.z=t.z},e.prototype.destory=function(){t.prototype.destory.call(this),this.name=null,this.objurl=null,this.picUrl=null,this.materialUrl=null,this.material&&this.material.useNum--,this.materialParam&&(this.materialParam.destory(),this.materialParam=null),this.lightMapTextureRes&&this.lightMapTextureRes.clearUseNum(),this._rotationMatrix=null,this._rotationData=null,this.bindMatrix=null,this.bindTarget=null,this.bindSocket=null,this._groupPos=null,this._groupRotation=null,this._groupScale=null,this.groupMatrix=null,this.groupRotationMatrix=null},e}(m),Zt=function(){function t(t,e){this.width=t,this.height=e;var i=M.getInstance().getContext2D(this.width,this.height,!1);this.imgData=i.getImageData(0,0,this.width,this.height);for(var a=0;a<this.imgData.data.length;a+=4)this.imgData.data[a+0]=255,this.imgData.data[a+1]=255,this.imgData.data[a+2]=255,this.imgData.data[a+3]=255}return t.prototype.getIndexByPos=function(t,e){return 4*(e*this.width+t)},t.prototype.setRgb=function(t,e,i){t=Math.round(t),e=Math.round(e);var a=this.getIndexByPos(t,e);this.imgData.data[a+0]=255*i.x,this.imgData.data[a+1]=255*i.y,this.imgData.data[a+2]=255*i.z,this.imgData.data[a+3]=255},t.prototype.getRgb=function(t,e){t=Math.round(t),e=Math.round(e);var i=new a,r=this.getIndexByPos(t,e);return i.x=this.imgData.data[r+0]/255,i.y=this.imgData.data[r+1]/255,i.z=this.imgData.data[r+2]/255,i.w=1,i},t}(),Ht=function(){function t(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=1),void 0===a&&(a=1),this.x=0,this.y=0,this.width=0,this.height=1,this.x=t,this.y=e,this.width=i,this.height=a}return t.prototype.sets=function(t,e,i,a){this.x=t,this.y=e,this.width=i,this.height=a},t.prototype.setRec=function(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},t.prototype.isHitByPoint=function(t,e){return t>=this.x&&e>=this.y&&t<=this.x+this.width&&e<=this.y+this.height},t}(),qt=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2TexCoord")},e.prototype.getVertexShaderString=function(){return"attribute vec3 v3Position;attribute vec2 v2TexCoord;\nuniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec2 v0;\nvoid main(void){ v0 = v2TexCoord;   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"},e.prototype.getFragmentShaderString=function(){return"precision mediump float;uniform sampler2D idmaptexture;uniform sampler2D infotexture;uniform sampler2D sixtexture;uniform sampler2D lightexture;vec4 qdvNrm(float indx ,vec2 uvpos){vec2 sixuvTx=uvpos; float ccavid= floor(indx*255.0);if (ccavid==0.0) {\n} else  if (ccavid==1.0){\nsixuvTx.x=sixuvTx.x+0.5;} else  if (ccavid==2.0){sixuvTx.y=sixuvTx.y+0.5;}else{sixuvTx.x=sixuvTx.x+0.5;sixuvTx.y=sixuvTx.y+0.5;}; sixuvTx.x=sixuvTx.x+0.001;sixuvTx.y=sixuvTx.y+0.001;vec4 sixUvColor = texture2D(sixtexture, sixuvTx.xy);\nreturn  sixUvColor;\n }\nvarying vec2 v0;void main(void){vec4 idUv = texture2D(idmaptexture, v0.xy);\nvec4 infoUv = texture2D(infotexture, v0.xy);\nvec4 sixUv = texture2D(sixtexture, v0.xy);\nvec4 lightUv = texture2D(lightexture, v0*0.995+0.0025);\nvec2 sixuv=fract(v0*10.0);  sixuv=sixuv*0.498; vec4 tempnumA = qdvNrm(idUv.x,sixuv) * infoUv.x;\nvec4 tempnumB = qdvNrm(idUv.y,sixuv) * infoUv.y;\nvec4 tempnumC = qdvNrm(idUv.z,sixuv) * infoUv.z;\nvec4 tempnumD = tempnumA+tempnumB+tempnumC;\n tempnumD.xyz=tempnumD.xyz*lightUv.xyz*2.0; gl_FragColor = tempnumD;}"},e.TerrainDisplay3DShader="TerrainDisplay3DShader",e}(nt),Kt=function(){function t(){}return t.prototype.mekeUseTexture=function(t){var e=new Ht(0,0,Math.pow(2,Math.ceil(Math.log(t.width)/Math.log(2))),Math.pow(2,Math.ceil(Math.log(t.height)/Math.log(2))));if(e.width!=t.width||e.height!=t.height){for(var i=new Zt(e.width,e.height),a=0;a<i.width;a++)for(var r=0;r<i.height;r++){var n=t.getRgb(a/i.width*t.width,r/i.height*t.height);i.setRgb(a,r,n)}return i}return t},t.prototype.calibration=function(){this.idBitmap=this.mekeUseTexture(this.idBitmap),this.infoBitmap=this.mekeUseTexture(this.infoBitmap)},t.meshAllgroundData=function(e){for(var i=e.readInt(),r=e.readInt(),n=new Array,s=0;s<i;s++)for(var o=0;o<r;o++){var h=e.readInt(),c=e.readInt(),l=e.readInt(),u=e.readInt(),p=new t;p.idBitmap=new Zt(l,u),p.infoBitmap=new Zt(l,u),p.tx=h,p.ty=c,n.push(p);for(var d=0;d<l;d++)for(var f=0;f<u;f++){var y;switch(e.readByte()){case 0:y=new a(0,1,2);break;case 1:y=new a(0,1,3);break;case 2:y=new a(0,2,3);break;case 3:y=new a(1,2,3);break;default:throw new Error("信息索引没有编入")}p.idBitmap.setRgb(d,f,new a(y.x/255,y.y/255,y.z/255,1));var m=new a;m.x=e.readByte()+128,m.y=e.readByte()+128,m.z=255-m.x-m.y,p.infoBitmap.setRgb(d,f,new a(m.x/255,m.y/255,m.z/255,1))}p.calibration()}for(var v=e.readUTF(),g=0;g<n.length;g++)n[g].sixurl=v;return n},t}(),Qt=function(t){function e(){var e=t.call(this)||this;return V.getInstance().registe(qt.TerrainDisplay3DShader,new qt),e.groundShader=V.getInstance().getProgram(qt.TerrainDisplay3DShader),e}return i(e,t),e.prototype.update=function(){this.groundShader&&this.baseSixteenRes&&this.idMapPicDataTexture?this.upDataToDraw():t.prototype.update.call(this)},e.prototype.upDataToDraw=function(){this.groundShader&&this.baseSixteenRes&&(r.context3D.cullFaceBack(!1),r.context3D.setProgram(this.groundShader.program),r.context3D.setVcMatrix4fv(this.groundShader,"viewMatrix3D",r.viewMatrx3D.m),r.context3D.setVcMatrix4fv(this.groundShader,"camMatrix3D",r.cam3D.cameraMatrix.m),r.context3D.setVcMatrix4fv(this.groundShader,"posMatrix3D",this.posMatrix.m),r.context3D.setVc4fv(this.groundShader,"colorData",[1,0,1,1]),r.context3D.pushVa(this.objData.vertexBuffer)||(r.context3D.setVaOffset(0,3,this.objData.stride,0),r.context3D.setVaOffset(1,2,this.objData.stride,this.objData.uvsOffsets)),r.context3D.setRenderTexture(this.groundShader,"idmaptexture",this.idMapPicDataTexture,0),r.context3D.setRenderTexture(this.groundShader,"infotexture",this.infoMapPicDataTexture,1),r.context3D.setRenderTexture(this.groundShader,"sixtexture",this.baseSixteenRes.texture,2),r.context3D.setRenderTexture(this.groundShader,"lightexture",this.lightMapTexture,3),r.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum))},e.prototype.setGrounDataMesh=function(t){var e=this;this.idMapPicDataTexture=r.context3D.getTexture(t.idBitmap.imgData,0,1),this.infoMapPicDataTexture=r.context3D.getTexture(t.infoBitmap.imgData,0,1);var i=t.sixurl;I.getInstance().getTexture(r.fileRoot+i,(function(t){e.baseSixteenRes=t}))},e}(Gt),Jt=function(){function t(){this._dic=new Object}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getAnimData=function(t,e){var i=this;this._dic[t]?e(this._dic[t]):w.getInstance().load(t,w.BYTE_TYPE,(function(e,a){a(i.readData(new s(e),t))}),e)},t.prototype.getAnimDataImmediate=function(t){return this._dic[t]},t.prototype.clearAnim=function(t){delete this._dic[t]},t.prototype.readData=function(t,e){var i=new Array,a=new Array,r=new Vt;r.inLoop=t.readInt();for(var n=t.readInt(),s=0;s<n;s++)r.inter.push(t.readInt());n=t.readInt();for(s=0;s<n;s++)r.bounds.push(t.readVector3D());r.nameHeight=t.readInt(),n=t.readInt();for(s=0;s<n;s++){var o=new te;o.father=t.readInt(),o.changtype=t.readInt(),o.startIndex=t.readInt(),o.tx=t.readFloat(),o.ty=t.readFloat(),o.tz=t.readFloat(),o.qx=t.readFloat(),o.qy=t.readFloat(),o.qz=t.readFloat(),i.push(o)}this.readFrameData(t,a),n=t.readInt();for(s=0;s<n;s++)r.posAry.push(t.readVector3D());return r.matrixAry=this.processFrame(a,i),this._dic[e]=r,r},t.prototype.readFrameData=function(t,e){for(var i=this.readFrameTypeData(t),a=t.readBoolean(),r=t.readFloat(),n=t.readInt(),s=0;s<n;s++){var o=t.readInt(),h=new Array;e.push(h);for(var c=0;c<o;c++)i[c]?h.push(t.readFloatTwoByte(r)):a?h.push(t.readFloat()):h.push(t.readShort()/32767)}},t.prototype.readFrameTypeData=function(t){for(var e=new Array,i=t.readInt(),a=0;a<i;a++)e.push(t.readBoolean());return e},t.prototype.processFrame=function(t,e){for(var i=new Array,a=0;a<t.length;a++)i.push(this.frameToBone(t[a],e));return this.setFrameToMatrix(i)},t.prototype.frameToBone=function(t,e){for(var i=new Array,a=0;a<e.length;a++){var r=new $t;r.father=e[a].father;var n=0;1&e[a].changtype?(r.tx=t[e[a].startIndex+n],++n):r.tx=e[a].tx,2&e[a].changtype?(r.ty=t[e[a].startIndex+n],++n):r.ty=e[a].ty,4&e[a].changtype?(r.tz=t[e[a].startIndex+n],++n):r.tz=e[a].tz,8&e[a].changtype?(r.qx=t[e[a].startIndex+n],++n):r.qx=e[a].qx,16&e[a].changtype?(r.qy=t[e[a].startIndex+n],++n):r.qy=e[a].qy,32&e[a].changtype?(r.qz=t[e[a].startIndex+n],++n):r.qz=e[a].qz,i.push(r)}return i},t.prototype.setFrameToMatrix=function(t){for(var e=new Array,i=0;i<t.length;i++){var r=t[i],n=new p,s=new d,o=new Array;e.push(o);for(var h=0;h<r.length;h++){var c=r[h];if((n=new p(c.qx,c.qy,c.qz)).w=this.getW(n.x,n.y,n.z),-1==c.father)(s=n.toMatrix3D()).appendTranslation(c.tx,c.ty,c.tz),s.appendRotation(-90,a.X_AXIS),o.push(s);else{r[c.father];(s=n.toMatrix3D()).appendTranslation(c.tx,c.ty,c.tz),s.append(o[c.father]),o.push(s)}}for(h=0;h<o.length;h++)o[h].appendScale(-1,1,1)}return e},t.prototype.getW=function(t,e,i){var a=1-(t*t+e*e+i*i);return a=a<0?0:-Math.sqrt(a)},t}(),$t=function(){},te=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.clone=function(){var t=new e;return t.tx=this.tx,t.ty=this.ty,t.tz=this.tz,t.tw=this.tw,t.qx=this.qx,t.qy=this.qy,t.qz=this.qz,t.qw=this.qw,t.changtype=this.changtype,t.name=this.name,t.father=this.father,t.startIndex=this.startIndex,t.matrix=this.matrix,t},e}($t),ee=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.meshAry=new Array,e.fileScale=1,e.tittleHeight=0,e.hitBox=new O(0,0),e.type=0,e.animDic=new Object,e.ready=!1,e.hasDestory=!1,e}return i(e,t),e.prototype.makeHitBoxItem=function(){this.hitPosItem=new Array;var t=this.hitBox.x,e=this.hitBox.y,i=new a(-t,0,-t),r=new a(t,0,-t),n=new a(t,0,t),s=new a(-t,0,t);this.hitPosItem.push(i),this.hitPosItem.push(r),this.hitPosItem.push(n),this.hitPosItem.push(s);var o=new a(-t,e,-t),h=new a(t,e,-t),c=new a(t,e,t),l=new a(-t,e,t);this.hitPosItem.push(o),this.hitPosItem.push(h),this.hitPosItem.push(c),this.hitPosItem.push(l)},e.prototype.addMesh=function(t){t.uid=this.meshAry.length,this.meshAry.push(t)},e.prototype.loadParticle=function(){},e.prototype.loadMaterial=function(t){void 0===t&&(t=null);for(var e=0;e<this.meshAry.length;e++)this.loadByteMeshDataMaterial(this.meshAry[e],t)},e.prototype.loadByteMeshDataMaterial=function(t,e){void 0===e&&(e=null);var i=r.fileRoot+t.materialUrl;i=(i=i.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),N.getInstance().getMaterialByte(i,(function(i){t.material=i,i.usePbr?ae.getInstance().uploadPbrMesh(t,i.useNormal):(i.lightProbe||i.directLight)&&ae.getInstance().uploadPbrMesh(t,!1),t.materialParamData&&(t.materialParam=new F,t.materialParam.setData(t.material,t.materialParamData)),e&&e(i)}),null,!0,Bt.MATERIAL_ANIM_SHADER,Bt)},e.prototype.setAction=function(t,e){this.animUrlAry=new Array;for(var i=0;i<t.length;i++){var a=t[i],r=e+t[i],n=Jt.getInstance().getAnimDataImmediate(r);n.processMesh(this),this.animDic[a]=n,this.animUrlAry.push(r)}},e.prototype.destory=function(){if(this.allParticleDic){for(var t in this.allParticleDic)Ut.getInstance().releaseUrl(t);this.allParticleDic=null}for(var e=0;e<this.meshAry.length;e++)this.meshAry[e].destory();this.meshAry.length=0,this.meshAry=null,this.boneSocketDic=null;for(e=0;e<this.animUrlAry.length;e++)Jt.getInstance().clearAnim(this.animUrlAry[e]);for(var t in this.animDic)delete this.animDic[t];this.animDic=null,this.hasDestory=!0},e}(x),ie=function(){},ae=function(t){function e(){var e=t.call(this)||this;return e._loadDic=new Object,e}return i(e,t),e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.getMeshData=function(t,e,i){var a=this;if(void 0===i&&(i=1),this._dic[t]&&this._dic[t].ready)return e(this._dic[t]),void this._dic[t].useNum++;this._loadDic[t]?this._loadDic[t].push(e):((this._loadDic[t]=[]).push(e),ye.getInstance().loadRoleRes(r.fileRoot+t,(function(t){a.roleResCom(t,e)}),i))},e.prototype.roleResCom=function(t,e){var i=t.roleUrl,a=this._dic[i];a.loadMaterial(),a.setAction(t.actionAry,i),a.url=i,t.ambientLightColor&&(a.lightData=[[t.ambientLightColor.x,t.ambientLightColor.y,t.ambientLightColor.z],[t.nrmDircet.x,t.nrmDircet.y,t.nrmDircet.z],[t.sunLigthColor.x,t.sunLigthColor.y,t.sunLigthColor.z]]);var r=this._loadDic[i];console.assert(null!=r,"找不到定义");for(var n=0;n<r.length;n++)r[n](a),a.useNum++;delete this._loadDic[i],a.ready=!0},e.prototype.gc=function(){t.prototype.gc.call(this)},e.prototype.readData=function(t,e,i,a){var r=new ee;r.fileScale=t.readFloat(),r.tittleHeight=a>=19?t.readFloat():50,r.hitBox=new O(20,20),a>=23&&(r.hitBox.x=t.readFloat(),r.hitBox.y=t.readFloat()),r.makeHitBoxItem();for(var n=t.readInt(),s=new Object,o=0;o<n;o++){var h=new Lt;a>=35&&(h.bindPosAry=this.readBindPosByte(t),h.getBindPosMatrix()),a>=21?this.readMesh2OneBuffer(t,h):(Ot.readFloatTwoByte(t,h.vertices),Ot.readFloatTwoByte(t,h.tangents),Ot.readFloatTwoByte(t,h.bitangents),Ot.readFloatTwoByte(t,h.normals),Ot.readFloatTwoByte(t,h.uvs),Ot.readIntForOneByte(t,h.boneIDAry),Ot.readFloatOneByte(t,h.boneWeightAry),Ot.readIntForTwoByte(t,h.indexs),Ot.readIntForTwoByte(t,h.boneNewIDAry),this.uploadMesh(h)),h.treNum=h.indexs.length,h.materialUrl=t.readUTF(),h.materialParamData=Ot.readMaterialParamData(t);for(var c=t.readInt(),l=0;l<c;l++){var u=new Ct(t.readUTF(),t.readUTF());h.particleAry.push(u),s[u.url]=!0}r.addMesh(h)}for(var p in s)Ut.getInstance().registerUrl(p);if(r.allParticleDic=s,a<35)for(var d=this.readBindPosByte(t),f=0;f<r.meshAry.length;f++)r.meshAry[f].bindPosAry=d,r.meshAry[f].getBindPosMatrix();var y=t.readInt();r.boneSocketDic=new Object;for(l=0;l<y;l++){var m=new ie;m.name=t.readUTF(),m.boneName=t.readUTF(),m.index=t.readInt(),m.x=t.readFloat(),m.y=t.readFloat(),m.z=t.readFloat(),m.rotationX=t.readFloat(),m.rotationY=t.readFloat(),m.rotationZ=t.readFloat(),r.boneSocketDic[m.name]=m}return this._dic[i]=r,r},e.prototype.readBindPosByte=function(t){for(var e=t.readInt(),i=new Array,a=0;a<e;a++){var r=new Array(t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat());i.push(r)}return i},e.prototype.readMesh2OneBuffer=function(t,e){for(var i=t.readInt(),a=new Array,n=0,s=0;s<5;s++){var o=t.readBoolean();a.push(o),o&&(n+=1==s?2:3)}i*=4*(n+=8);var h,c=(h=a[2]?a[4]?14:8:5)+4,l=new ArrayBuffer(i),u=new DataView(l);Ot.readBytes2ArrayBuffer(t,u,3,0,n),Ot.readBytes2ArrayBuffer(t,u,2,3,n),Ot.readBytes2ArrayBuffer(t,u,3,5,n),Ot.readBytes2ArrayBuffer(t,u,3,8,n),Ot.readBytes2ArrayBuffer(t,u,3,11,n),Ot.readBytes2ArrayBuffer(t,u,4,h,n,2),Ot.readBytes2ArrayBuffer(t,u,4,c,n,1),Ot.readIntForTwoByte(t,e.indexs),Ot.readIntForTwoByte(t,e.boneNewIDAry),e.compressBuffer=!0,e.uvsOffsets=12,e.normalsOffsets=20,e.tangentsOffsets=32,e.bitangentsOffsets=44,e.boneIDOffsets=4*h,e.boneWeightOffsets=4*c,e.stride=4*n,e.vertexBuffer=r.context3D.uploadBuff3DArrayBuffer(l),e.indexBuffer=r.context3D.uploadIndexBuff3D(e.indexs)},e.prototype.cloneMeshData=function(t,e){var i=t.vertices,a=t.normals,r=t.uvs,n=t.boneIDAry,s=t.boneWeightAry,o=t.indexs;t.vertices=new Array,t.normals=new Array,t.uvs=new Array,t.boneIDAry=new Array,t.boneWeightAry=new Array,t.indexs=new Array;for(var h=i.length/3,c=0;c<e;c++){t.vertices=t.vertices.concat(i),t.normals=t.normals.concat(a),t.boneIDAry=t.boneIDAry.concat(n),t.boneWeightAry=t.boneWeightAry.concat(s);for(var l=0;l<r.length;l+=2)t.uvs.push(r[l],r[l+1],c);for(l=0;l<o.length;l++)t.indexs.push(o[l]+c*h)}t.treNum=t.indexs.length},e.prototype.uploadMesh=function(t){t.vertexBuffer=r.context3D.uploadBuff3D(t.vertices),t.uvBuffer=r.context3D.uploadBuff3D(t.uvs),t.boneIdBuffer=r.context3D.uploadBuff3D(t.boneIDAry),t.boneWeightBuffer=r.context3D.uploadBuff3D(t.boneWeightAry),t.indexBuffer=r.context3D.uploadIndexBuff3D(t.indexs)},e.prototype.uploadPbrMesh=function(t,e){t.normalsBuffer=r.context3D.uploadBuff3D(t.normals),e&&(t.tangentBuffer=r.context3D.uploadBuff3D(t.tangents),t.bitangentBuffer=r.context3D.uploadBuff3D(t.bitangents))},e.prototype.preLoad=function(t){this.getMeshData(t,(function(t){t.loadMaterial()}))},e}(b),re=function(t){function e(){var e=t.call(this)||this;return e.actionNum=0,e.actionIndex=0,e.resState="none",e.NONE="none",e.READ_MESH="read_mesh",e.READ_ACTION="read_action",e.READ_IMAGE="read_image",e.READ_IMAGE_LOADING="read_image_loading",e.READ_MATERIAL="read_material",e.READ_PARTICLE="read_particle",e.READ_COMPLETE="read_complete",e.updateTick=function(){e.updateState()},e.meshBatchNum=1,e}return i(e,t),e.prototype.load=function(t,e){var i=this;this._fun=e,w.getInstance().load(t,w.BYTE_TYPE,(function(t){i.loadComplete(t)}))},e.prototype.updateState=function(){switch(this.resState){case this.READ_MESH:this.readMesh();break;case this.READ_ACTION:this.readAction();break;case this.READ_IMAGE:this.resState=this.READ_IMAGE_LOADING,this.read();break;case this.READ_MATERIAL:case this.READ_PARTICLE:this.read();break;case this.READ_COMPLETE:h.removeFrameTick(this.updateTick),this._fun&&(this._fun(),this._fun=null)}},e.prototype.loadComplete=function(t){this._byte=new s(t),this._byte.position=0,this.version=this._byte.readInt(),this.resState=this.READ_MESH,h.addFrameTick(this.updateTick)},e.prototype.readMesh=function(){this.roleUrl=this._byte.readUTF(),this.version>=16&&(this.ambientLightColor=new a,this.sunLigthColor=new a,this.nrmDircet=new a,this.ambientLightColor.x=this._byte.readFloat(),this.ambientLightColor.y=this._byte.readFloat(),this.ambientLightColor.z=this._byte.readFloat(),this.ambientLightIntensity=this._byte.readFloat(),this.ambientLightColor.scaleBy(this.ambientLightIntensity),this.sunLigthColor.x=this._byte.readFloat(),this.sunLigthColor.y=this._byte.readFloat(),this.sunLigthColor.z=this._byte.readFloat(),this.sunLigthIntensity=this._byte.readFloat(),this.sunLigthColor.scaleBy(this.sunLigthIntensity),this.nrmDircet.x=this._byte.readFloat(),this.nrmDircet.y=this._byte.readFloat(),this.nrmDircet.z=this._byte.readFloat()),ae.getInstance().readData(this._byte,this.meshBatchNum,this.roleUrl,this.version),this.readActions()},e.prototype.readActions=function(){this.version>=30?this.actionByte=o.getZipByte(this._byte):this.actionByte=this._byte,this.actionAry=new Array,this.actionNum=this.actionByte.readInt(),this.resState=this.READ_ACTION},e.prototype.readAction=function(){if(this.actionIndex>=this.actionNum)this.resState=this.READ_IMAGE;else{var t=this.actionByte.readUTF();Jt.getInstance().readData(this.actionByte,this.roleUrl+t),this.actionAry.push(t),this.actionIndex++}},e.prototype.allResCom=function(){this.resState=this.READ_MATERIAL,this.actionByte=null,this.actionNum=0,this.actionIndex=0},e.prototype.readMaterial=function(){t.prototype.readMaterial.call(this),this.resState=this.READ_PARTICLE},e.prototype.readParticle=function(){t.prototype.readParticle.call(this),this.resState=this.READ_COMPLETE},e}(Ot),ne=function(){function t(){this.frame=0}return t.prototype.setData=function(t){this.frame=t.frame,this.url=t.url},t}(),se=function(){function t(){}return t.prototype.setData=function(t){this.time=t.time*r.frameTime,this.lasttime=t.lasttime*r.frameTime,this.amp=t.amp},t}(),oe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.setData=function(e){t.prototype.setData.call(this,e),this.hasSocket=e.hasSocket,this.hasSocket?this.socket=e.socket:(this.pos=new a(e.pos.x,e.pos.y,e.pos.z),this.rotation=new a(e.rotation.x,e.rotation.y,e.rotation.z))},e}(ne),he=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.setData=function(e){t.prototype.setData.call(this,e),this.beginType=e.beginType,0==this.beginType?this.beginPos=new a(e.beginPos.x,e.beginPos.y,e.beginPos.z):1==this.beginType&&(this.beginSocket=e.beginSocket),this.speed=e.speed,e.hitSocket&&(this.hitSocket=e.hitSocket),e.endParticle&&(this.endParticleUrl=e.endParticle),this.multype=e.multype},e}(ne),ce=function(){function t(){}return t.prototype.setData=function(t){this.keyAry=new Array,this.action=t.action,this.skillname=t.skillname,this.bloodTime=t.blood,this.types=t.type,this.types==le.FixEffect?this.keyAry=this.getFixEffect(t.data):this.types!=le.TrajectoryDynamicTarget&&this.types!=le.TrajectoryDynamicPoint||(this.keyAry=this.getTrajectoryDynamicTarget(t.data)),t.sound&&(this.sound=new ne,this.sound.frame=t.sound.time*r.frameTime,this.sound.url=t.sound.name),t.shock&&(this.shockAry=this.getShockAry(t.shock))},t.prototype.getShockAry=function(t){for(var e=new Array,i=0;i<t.length;i++){var a=new se;a.setData(t[i]),e.push(a)}return e},t.prototype.getFixEffect=function(t){for(var e=new Array,i=0;i<t.length;i++){var a=new oe;a.setData(t[i]),e.push(a)}return e},t.prototype.getTrajectoryDynamicTarget=function(t){for(var e=new Array,i=0;i<t.length;i++){var a=new he;a.setData(t[i]),e.push(a)}return e},t.defaultBloodTime=250,t}(),le=function(){function t(){}return t.TrajectoryDynamicTarget=1,t.FixEffect=4,t.TrajectoryDynamicPoint=3,t}(),ue=function(t){function e(){var e=t.call(this)||this;return e.meshBatchNum=1,e}return i(e,t),e.prototype.load=function(t,e){var i=this;this._fun=e,w.getInstance().load(t,w.BYTE_TYPE,(function(t){i.loadComplete(t)}))},e.prototype.loadComplete=function(t){var e=this;this._byte=new s(t),this._byte.position=0,this.version=this._byte.readInt(),this.skillUrl=this._byte.readUTF(),this.read((function(){e.readNext()}))},e.prototype.readNext=function(){if(this.read(),this.read(),this.version<27)this._byte.readUTF();this.data=this.readData(this._byte),this._fun()},e.prototype.readData=function(t){for(var e=t.readInt(),i=new Object,r=0;r<e;r++){var n=new Object,s=t.readUTF(),o=t.readUTF();if(n.skillname=s,n.action=o,n.type=t.readFloat(),this.version>=26?(n.blood=t.readInt(),0==n.blood&&(n.blood=ce.defaultBloodTime)):n.blood=ce.defaultBloodTime,this.version>=32){var h=t.readInt();if(h>0){var c=t.readUTF();n.sound={time:h,name:c}}}if(this.version>=33){var l=t.readInt();if(l){for(var u=new Array,p=0;p<l;p++){var d=new Object;d.time=t.readInt(),d.lasttime=t.readInt(),d.amp=t.readFloat(),u.push(d)}n.shock=u}}n.data=new Array;for(var f=t.readInt(),y=0;y<f;y++){var m=new Object;switch(m.url=t.readUTF(),m.frame=t.readFloat(),n.type){case 1:m.beginType=t.readInt(),0==m.beginType?(m.beginPos=new a,m.beginPos.x=t.readFloat(),m.beginPos.y=t.readFloat(),m.beginPos.z=t.readFloat()):1==m.beginType&&(m.beginSocket=t.readUTF()),m.hitSocket=t.readUTF(),m.endParticle=t.readUTF(),m.multype=t.readInt(),m.speed=t.readFloat();break;case 3:m.beginSocket=t.readUTF(),m.beginType=t.readFloat(),m.multype=t.readFloat(),m.speed=t.readFloat();break;case 4:if(this.version>=27){var v=t.readBoolean();m.hasSocket=v,v?m.socket=t.readUTF():(m.pos=this.readV3d(t),m.rotation=this.readV3d(t))}else m.hasSocket=!1,m.pos=this.readV3d(t),m.rotation=this.readV3d(t);break;default:alert("没有类型readData")}n.data.push(m)}i[s]=n}return i},e.prototype.readV3d=function(t){var e=new a;return e.x=t.readFloat(),e.y=t.readFloat(),e.z=t.readFloat(),e.w=t.readFloat(),e},e}(Ot),pe=function(){function t(){}return t.getUItittleUrl=function(t){return"ui/load/tittle/"+t+".png"},t.getSkillUrl=function(t){return!t||t.length,("skill/"+t+o.getBaseUrl()+".txt").replace(".txt","_byte.txt")},t.getModelUrl=function(t){return"model/"+t+o.getBaseUrl()+".txt"},t.getModelUIUrl=function(t){return"model/"+t+o.getBaseUrl()+".txt"},t.getMapUrl=function(t){return"map/"+t+".txt"},t.getRoleUrl=function(t){return"role/"+t+o.getBaseUrl()+".txt"},t.getZipMapUrl=function(t){return"map/"+t+"/"},t.Snum=function(t){return"123"},t.getEffectUIUrl=function(t){return"ui/load/effect/"+t+".png"},t.getKeyProById=function(t){return"cc"},t}(),de=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.load=function(t,i,a,n){var s=this;if(this.sceneData)this.isNeedReload()?(i(),a(1),this.applyByteArray()):(i(),a(1),n(this.sceneData));else{this._completeFun=i,this._readDataFun=n,this._progressFun=a;var o=e.sceneConfigData;o&&o[t]?this.loadZipMap(t,o[t].len):(t=r.fileRoot+pe.getMapUrl(t),w.getInstance().load(t,w.BYTE_TYPE,(function(t){s.loadComplete(t)}),null,a))}},e.prototype.loadZipMap=function(t,e){for(var i=this,a=new Array,n=new Array,s=0,o=new Array,h=0;h<e;h++)o[h]=0;var c=function(t){var e=t.response,r=a.indexOf(t);if(n[r]=e,++s==a.length){for(var o=0,h=0;h<n.length;h++)o+=n[h].byteLength;var c=new Uint8Array(o),l=0;for(h=0;h<n.length;h++)c.set(new Uint8Array(n[h]),l),l+=n[h].byteLength;i.loadComplete(c.buffer)}},l=function(t,r){var n=a.indexOf(t);o[n]=r;for(var s=0,h=0;h<e;h++)s+=o[h];s/=e,i._progressFun(s)};for(h=0;h<e;h++){var u=new XMLHttpRequest;u.onreadystatechange=function(t){var e=t.target;200==e.status&&4==e.readyState&&c(e)},u.onprogress=function(t){var e=t.target;l(e,t.loaded/t.total)};var p=r.fileRoot+pe.getZipMapUrl(t)+h+".txt";a.push(u),u.open("GET",p,!0),u.responseType="arraybuffer",u.send()}},e.prototype.isNeedReload=function(){for(var t=this.sceneData.buildItem,e=0;e<t.length;e++)if(t[e].type==Ot.PREFAB_TYPE&&t[e].lighturl){var i=r.fileRoot+t[e].lighturl;return!I.getInstance().hasTexture(i)}return x.GCTime-this.idleTime<10},e.prototype.loadComplete=function(t){this._byte=new s(t),this._completeFun(),this.applyByteArray()},e.prototype.applyByteArray=function(){var t=this;this._byte.position=0,this.version=this._byte.readInt(),this.read((function(){t.readNext()}))},e.prototype.readNext=function(){this.read(),this.read(),this.read(),this.readScene(),this._readDataFun(this.sceneData)},e.prototype.readScene=function(){this._byte.readInt();this.readAstat(),this.version>=28&&this.readTerrainIdInfoBitmapData(this._byte);var t=this._byte.readInt();this.sceneData=JSON.parse(this._byte.readUTFBytes(t)),this.sceneData.astar=this._astarDataMesh,this.sceneData.terrain=this._terrainDataItem},e.prototype.readTerrainIdInfoBitmapData=function(t){var e=t.readInt();if(e){var i=e,a=t.buffer.slice(t.position,t.position+i);t.position+=i;var r=o.unZip(a),n=new s(r);this._terrainDataItem=Kt.meshAllgroundData(n)}},e.prototype.readAstat=function(){if(this._byte.readBoolean()){var t,e;this._astarDataMesh=new fe,this._astarDataMesh.aPos=new a,this._astarDataMesh.astarItem=new Array,this._astarDataMesh.heightItem=new Array,this._astarDataMesh.jumpItem=new Array,this._astarDataMesh.midu=this._byte.readFloat(),this._astarDataMesh.aPos.x=this._byte.readFloat(),this._astarDataMesh.aPos.y=this._byte.readFloat(),this._astarDataMesh.aPos.z=this._byte.readFloat();var i=this._byte.readInt(),r=this._byte.readInt();if(this._astarDataMesh.width=i,this._astarDataMesh.height=r,this.version<25){for(t=0;t<r;t++){var n=new Array;for(e=0;e<i;e++)n.push(this._byte.readFloat());this._astarDataMesh.astarItem.push(n)}for(t=0;t<r;t++){var s=new Array;for(e=0;e<i;e++)s.push(this._byte.readFloat());this._astarDataMesh.heightItem.push(s)}}else{var o=this._byte.readFloat(),h=this.readAstarFromByte(this._byte),c=this.readAstarFromByte(this._byte),l=0,u=0;for(t=0;t<r;t++){n=new Array;var p=new Array;for(e=0;e<i;e++){var d=h[l++];if(n.push(d),1==d){var f=c[u++];p.push(f)}else p.push(0)}this._astarDataMesh.astarItem.push(n),this._astarDataMesh.jumpItem.push(p)}for(this._astarDataMesh.jumpItem,t=0;t<r;t++){s=new Array;for(e=0;e<i;e++)s.push(this._byte.readShort()/o);this._astarDataMesh.heightItem.push(s)}}}},e.prototype.readAstarFromByte=function(t){for(var e=t.readUnsignedInt(),i=Math.ceil(e/32),a=new Array,r=0;r<i;r++)for(var n=t.readUnsignedInt(),s=0;s<32;s++){var o=1&n;a.length<e&&a.push(o),n>>=1}return a},e}(Ot),fe=function(){},ye=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.loadRoleRes=function(t,e,i){var a=new re;a.meshBatchNum=i,a.load(t,(function(){e(a)}))},e.prototype.loadSkillRes=function(t,e){var i=new ue;i.load(t,(function(){e(i)}))},e.prototype.loadSceneRes=function(t,e,i,a){var r;return this._dic[t]?r=this._dic[t]:(r=new de,this._dic[t]=r),r.load(t,e,i,a),this.clearSceneUse(r),r},e.prototype.clearSceneUse=function(t){for(var e in this._dic){var i=this._dic[e];i.useNum>0&&i!=t&&(i.useNum=0)}t.useNum=1},e.prototype.gc=function(){for(var t in this._dic){var e=this._dic[t];e.useNum<=0&&(e.idleTime++,e.idleTime>=x.GCTime&&(e.destory(),delete this._dic[t]))}},e}(b),me=function(){function t(t,e,i,a,r,n){this.x=t,this.y=e,this.z=i,this.width=a,this.height=r,this.depth=n}return t.prototype.testViewFrustum=function(t,e){if(this.sun&&1==this.sun.length)this.sun[0].testViewFrustum(t,e);else if(this.testViewFrustumResult(t)&&(this.target&&(this.target.isPerspective&&this.testRay(e)||(this.target.sceneVisible=!0)),this.sun))for(var i=0;i<this.sun.length;i++)this.sun[i].testViewFrustum(t,e)},t.prototype.testViewFrustumResult=function(t){for(var e=new a(this.x,this.y,this.z),i=new a(this.width,this.height,this.depth),r=!0,n=0;n<t.length;n++){var s=e,o=e.add(i),h=new a;if(t[n].x>0?h.x=o.x:h.x=s.x,t[n].y>0?h.y=o.y:h.y=s.y,t[n].z>0?h.z=o.z:h.z=s.z,t[n].dot(h)+t[n].w<0){r=!1;break}}return r},t.prototype.testRay=function(t){var e,i,a,r,n,s,o=t.o.x,h=t.o.y,c=t.o.z,l=t.d.x,u=t.d.y,p=t.d.z,d=this.x,f=this.y,y=this.z,m=this.x+this.width,v=this.y+this.height,g=this.z+this.depth,_=1/l;_>=0?(e=(d-o)*_,r=(m-o)*_):(e=(m-o)*_,r=(d-o)*_);var x=1/u;x>=0?(i=(f-h)*x,n=(v-h)*x):(i=(v-h)*x,n=(f-h)*x);var b,D,w=1/p;w>=0?(a=(y-c)*w,s=(g-c)*w):(a=(g-c)*w,s=(y-c)*w),a>(b=e>i?e:i)&&(b=a),s<(D=r<n?r:n)&&(D=s);return b<D&&D>1e-4&&((b>1e-4?b:D)<t.baseT||void 0)},t}(),ve=function(){function t(){this.o=new a,this.d=new a,this.baseT=500}return t.prototype.setPos=function(t,e,i){this.o.x=t,this.o.y=e,this.o.z=i},t.prototype.setTarget=function(t,e,i){this.d.x=t-this.o.x,this.d.y=e-this.o.y,this.d.z=i-this.o.z,this.d.normalize()},t}(),ge=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.setData(t,e,i)}return t.prototype.setData=function(t,e,i){this.x=t,this.y=e,this.radius=i},t.prototype.setPos=function(t,e){this.x=t,this.y=e},Object.defineProperty(t.prototype,"x",{get:function(){return this._x},set:function(t){this._x=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._y},set:function(t){this._y=t},enumerable:!1,configurable:!0}),t.prototype.setRadius=function(t){this.radius=t},t.prototype.testPoint=function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)<this.radius},t}(),_e=function(){function t(){}return t.getCamView=function(t,e){var i=new d;i.appendRotation(-e.rotationX,a.X_AXIS),i.appendTranslation(e.x,e.y,e.z);var r=i.transformVector(new a(0,0,-t.distance));return t.x=r.x,t.y=r.y,t.z=r.z,t.rotationX=e.rotationX,t.cameraMatrix.identity(),t.cameraMatrix.prependTranslation(0,0,t.distance),t.cameraMatrix.prependRotation(t.rotationX,a.X_AXIS),t.cameraMatrix.prependTranslation(-e.x,-e.y,-e.z),this.updateVp(),t.cameraMatrix.m},t.updateVp=function(){r.vpMatrix.identity(),r.vpMatrix.prepend(r.viewMatrx3D),r.vpMatrix.prepend(r.cam3D.cameraMatrix)},t.GetViewHitBoxDataCopy=function(t){this.viewBoxVecItem||(this.viewBoxVecItem=new Array,this.viewBoxVecItem.push(new a),this.viewBoxVecItem.push(new a),this.viewBoxVecItem.push(new a),this.viewBoxVecItem.push(new a));var e=t/(r.sceneViewHW/2),i=r.sceneViewHW/2*e,n=r.stageWidth,s=r.stageHeight,o=new d;o.prependRotation(-r.cam3D.rotationY,a.Y_AXIS),o.prependRotation(-r.cam3D.rotationX,a.X_AXIS);var h=r.viewMatrx3D.transformVector(new a(500,0,500)),c=h.x/h.w,l=n/2/c*e*.8,u=s/2/c*e*.8;this.viewBoxVecItem[0]=this.gettempPos(new a(-l,-u,i),o),this.viewBoxVecItem[1]=this.gettempPos(new a(+l,-u,i),o),this.viewBoxVecItem[2]=this.gettempPos(new a(+l,+u,i),o),this.viewBoxVecItem[3]=this.gettempPos(new a(-l,+u,i),o)},t.gettempPos=function(t,e){var i=e.transformVector(t);return i=i.add(new a(r.cam3D.x,r.cam3D.y,r.cam3D.z))},t.math_distance=function(t,e,i,a){return Math.sqrt((a-e)*(a-e)+(i-t)*(i-t))},t}(),xe=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v3Color")},e.prototype.getVertexShaderString=function(){return"attribute vec3 v3Position;attribute vec3 v3Color;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec4 colorData;void main(void){   vec4 vt0= vec4(v3Position, 1.0);   colorData =vec4(v3Color,1) ;   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"},e.prototype.getFragmentShaderString=function(){return" precision mediump float;\nvarying vec4 colorData;\nvoid main(void)\n{\ngl_FragColor =colorData;\n}"},e.LineShader="LineShader",e}(nt),be=function(t){function e(){var e=t.call(this)||this;return e.baseColor=new a(1,0,0),e.objData=new L,e.shader=V.getInstance().getProgram(xe.LineShader),e.program=e.shader.program,e.makeLineMode(new a(0,0,0),new a(100,0,0),new a),e.makeLineMode(new a(0,0,0),new a(100,0,100),new a),e.makeLineMode(new a(100,0,0),new a(100,0,100),new a),e.upToGpu(),e}return i(e,t),e.prototype.makeLineMode=function(t,e,i){void 0===i&&(i=null),this.lineVecPos&&this.lineIndex||this.clear(),i&&(this.baseColor=i),this.lineVecPos.push(t.x,t.y,t.z),this.lineVecPos.push(e.x,e.y,e.z),this.lineColor.push(this.baseColor.x,this.baseColor.y,this.baseColor.z),this.lineColor.push(this.baseColor.x,this.baseColor.y,this.baseColor.z),this.lineIndex.push(this.lineIndex.length+0,this.lineIndex.length+1)},e.prototype.clear=function(){this.lineVecPos=new Array,this.lineIndex=new Array,this.lineColor=new Array,this.objData.indexBuffer&&(this.objData.indexBuffer=null)},e.prototype.upToGpu=function(){this.lineIndex.length&&(this.objData.treNum=this.lineIndex.length,this.objData.vertexBuffer=r.context3D.uploadBuff3D(this.lineVecPos),this.objData.normalsBuffer=r.context3D.uploadBuff3D(this.lineColor),this.objData.indexBuffer=r.context3D.uploadIndexBuff3D(this.lineIndex))},e.prototype.update=function(){this.objData&&this.objData.indexBuffer&&(r.context3D.setProgram(this.program),r.context3D.setVcMatrix4fv(this.shader,"viewMatrix3D",r.viewMatrx3D.m),r.context3D.setVcMatrix4fv(this.shader,"camMatrix3D",r.cam3D.cameraMatrix.m),r.context3D.setVcMatrix4fv(this.shader,"posMatrix3D",this.posMatrix.m),r.context3D.setVa(0,3,this.objData.vertexBuffer),r.context3D.setVa(1,3,this.objData.normalsBuffer),r.context3D.drawLine(this.objData.indexBuffer,this.objData.treNum))},e}(m),De=(function(t){function e(){var e=t.call(this)||this;return e.itemSprite||(e.itemSprite=new Array),e}i(e,t),e.prototype.makeLineMode=function(e,i,a){void 0===a&&(a=null),t.prototype.makeLineMode.call(this,e,i,a),this.getSprite().makeLineMode(e,i,a)},e.prototype.getSprite=function(){var t=Math.floor(this.lineIndex.length/1e4);if(!this.itemSprite[t]){var e=new be;e.clear(),e.baseColor=this.baseColor,this.itemSprite.push(e)}return this.itemSprite[t]},e.prototype.update=function(){for(var t=0;t<this.itemSprite.length;t++)this.itemSprite[t].posMatrix=this.posMatrix,this.itemSprite[t].update()},e.prototype.upToGpu=function(){for(var t=0;t<this.itemSprite.length;t++)this.itemSprite[t].upToGpu()},e.prototype.clear=function(){t.prototype.clear.call(this),this.itemSprite||(this.itemSprite=new Array);for(var e=0;this.itemSprite&&e<this.itemSprite.length;e++)this.itemSprite[e].clear()}}(be),function(t){function e(){var e=t.call(this)||this;return e.makeGridData(),e}i(e,t),e.prototype.makeGridData=function(){var t,e,i=100;this.clear(),t=new a(0,0,100),e=new a(0,0,-i),this.makeLineMode(t,e,new a(0,0,1,1)),t=new a(100,0,0),e=new a(-i,0,0),this.makeLineMode(t,e,new a(1,0,0,1)),this.baseColor=new a(128/255,128/255,128/255,1);for(var r=1;r<=10;r++)t=new a(10*+r,0,100),e=new a(10*+r,0,-i),this.makeLineMode(t,e),t=new a(10*-r,0,100),e=new a(10*-r,0,-i),this.makeLineMode(t,e),t=new a(100,0,10*+r),e=new a(-i,0,10*+r),this.makeLineMode(t,e),t=new a(100,0,10*-r),e=new a(-i,0,10*-r),this.makeLineMode(t,e);this.upToGpu()}}(be),function(){function t(){this.needUpdata=!1,this.panleAry=new Array}return t.prototype.init=function(t,e){this._circle=new ge(1e4,1e4),this._sceneDic=e,this._rootNode=this.getNode(t),this._ray=new ve},t.prototype.getNode=function(t){var e=new me(t.x,t.y,t.z,t.width,t.height,t.depth);if(t.data){e.sun||(e.sun=new Array);for(var i=0;i<t.data.length;i++){var a,r=new me(t.data[i].x,t.data[i].y,t.data[i].z,t.data[i].width,t.data[i].height,t.data[i].depth);1==t.data[i].type?a="build"+t.data[i].id:11==t.data[i].type?a="particle"+t.data[i].id:14==t.data[i].type&&(a="ground"+t.data[i].id),r.target=this._sceneDic[a],r.target.aabb=r,e.sun.push(r)}}if(t.sun){e.sun||(e.sun=new Array);for(i=0;i<t.sun.length;i++)e.sun.push(this.getNode(t.sun[i]))}return e},t.prototype.setCircle=function(t,e,i){var a=t-this._circle.x,r=e-this._circle.y;Math.sqrt(a*a+r*r)<10?this.needUpdata=!1:(this._circle.setData(t,e,i),this.needUpdata=!0)},t.prototype.update=function(){_e.GetViewHitBoxDataCopy(r.cam3D.distance);var t=new a(r.cam3D.x,r.cam3D.y,r.cam3D.z),e=_e.viewBoxVecItem;this.panleAry.length=0,this.panleAry.push(this.getPanelByVec(t,e[0],e[1])),this.panleAry.push(this.getPanelByVec(t,e[1],e[2])),this.panleAry.push(this.getPanelByVec(t,e[2],e[3])),this.panleAry.push(this.getPanelByVec(t,e[3],e[0])),this._ray.setPos(r.cam3D.x,r.cam3D.y,r.cam3D.z),this._ray.setTarget(r.focus3D.x,r.focus3D.y,r.focus3D.z),this._ray.baseT=r.cam3D.distance,this._rootNode.testViewFrustum(this.panleAry,this._ray)},t.prototype.getPanelByVec=function(t,e,i){var a=e.subtract(t),r=i.subtract(t);return(a=a.cross(r)).normalize(),a.w=-a.dot(t),a},t.prototype.updateDraw=function(){this.capsuleLineSprite?(this.capsuleLineSprite.x=r.focus3D.x,this.capsuleLineSprite.y=r.focus3D.y+50,this.capsuleLineSprite.z=r.focus3D.z,this.capsuleLineSprite.update()):(this.capsuleLineSprite=new be,this.capsuleLineSprite.clear(),this.capsuleLineSprite.baseColor=new a(1,0,0,1),this.drawCylinder(this._circle.radius,10),this.capsuleLineSprite.upToGpu())},t.prototype.drawCylinder=function(t,e){var i,r,n,s=t,o=e;for(n=0;n<12;n++){var h=new a(s,0,0),c=new a(s,+o,0),l=new d;l.appendRotation(30*n,a.Y_AXIS);var u=l.transformVector(h),p=l.transformVector(c);this.capsuleLineSprite.makeLineMode(u,p),this.capsuleLineSprite.makeLineMode(p,new a(0,+o,0)),11==n&&(this.capsuleLineSprite.makeLineMode(u,h),this.capsuleLineSprite.makeLineMode(p,c)),(i||r)&&(this.capsuleLineSprite.makeLineMode(u,i),this.capsuleLineSprite.makeLineMode(p,r)),i=u.clone(),r=p.clone()}},t}()),we=function(){function t(){}return t.prototype.init=function(){this.capsuleLineSprite=new be,Re.getInstance().addDisplay(this.capsuleLineSprite)},t.prototype.setCam=function(){var t=r.cam3D.cameraMatrix.clone();t.append(r.viewMatrx3D);var e=t.m,i=e[0],a=e[1],n=e[2],s=e[3],o=e[4],h=e[5],c=e[6],l=e[7],u=e[8],p=e[9],d=e[10],f=e[11],y=e[12],m=e[13],v=e[14],g=e[15];this.panleAry=new Array;this.getPanle(-u+y,-p+m,-d+v,-f+g),this.getPanle(o+y,h+m,c+v,l+g),this.getPanle(-o+y,-h+m,-c+v,-l+g),this.getPanle(i+y,a+m,n+v,s+g),this.getPanle(-i+y,-a+m,-n+v,-s+g)},t.prototype.getPanle=function(t,e,i,r){var n=new a(t,e,i,r);return n.normalize(),n},t.prototype.getPanelByVec=function(t,e,i){var a=e.subtract(t),r=i.subtract(t);return(a=a.cross(r)).normalize(),a.w=-a.dot(t),a},t.prototype.setData=function(t){this.dataAry=t},t.prototype.setViewFrustum=function(){this.capsuleLineSprite||this.init(),this.setCam(),this.capsuleLineSprite.clear(),this.capsuleLineSprite.baseColor=new a(0,0,1,1),_e.GetViewHitBoxDataCopy(r.cam3D.distance);var t=new a(r.cam3D.x,r.cam3D.y,r.cam3D.z),e=_e.viewBoxVecItem;this.panleAry.push(this.getPanelByVec(t,e[0],e[1])),this.panleAry.push(this.getPanelByVec(t,e[1],e[2])),this.panleAry.push(this.getPanelByVec(t,e[2],e[3])),this.panleAry.push(this.getPanelByVec(t,e[3],e[0]));for(var i=0;i<this.dataAry.length;i++){for(var n=this.dataAry[i],s=new a(n.x,n.y,n.z),o=new a(n.width,n.height,n.depth),h=!1,c=0;c<this.panleAry.length;c++){var l=s,u=s.add(o),p=new a;if(this.panleAry[c].x>0?p.x=u.x:p.x=l.x,this.panleAry[c].y>0?p.y=u.y:p.y=l.y,this.panleAry[c].z>0?p.z=u.z:p.z=l.z,this.panleAry[c].dot(p)+this.panleAry[c].w<0){h=!0;break}}this.capsuleLineSprite.baseColor=h?new a(1,0,0,1):new a(0,0,1,1),this.capsuleLineSprite.makeLineMode(s,new a(s.x+o.x,s.y,s.z)),this.capsuleLineSprite.makeLineMode(s,new a(s.x,s.y,s.z+o.z)),this.capsuleLineSprite.makeLineMode(new a(s.x+o.x,s.y,s.z),new a(s.x+o.x,s.y,s.z+o.z)),this.capsuleLineSprite.makeLineMode(new a(s.x,s.y,s.z+o.z),new a(s.x+o.x,s.y,s.z+o.z)),this.capsuleLineSprite.makeLineMode(new a(s.x,s.y+o.y,s.z),new a(s.x+o.x,s.y+o.y,s.z)),this.capsuleLineSprite.makeLineMode(new a(s.x,s.y+o.y,s.z),new a(s.x,s.y+o.y,s.z+o.z)),this.capsuleLineSprite.makeLineMode(new a(s.x+o.x,s.y+o.y,s.z),new a(s.x+o.x,s.y+o.y,s.z+o.z)),this.capsuleLineSprite.makeLineMode(new a(s.x,s.y+o.y,s.z+o.z),new a(s.x+o.x,s.y+o.y,s.z+o.z)),this.capsuleLineSprite.makeLineMode(new a(s.x,s.y,s.z),new a(s.x,s.y+o.y,s.z)),this.capsuleLineSprite.makeLineMode(new a(s.x+o.x,s.y,s.z),new a(s.x+o.x,s.y+o.y,s.z)),this.capsuleLineSprite.makeLineMode(new a(s.x,s.y,s.z+o.z),new a(s.x,s.y+o.y,s.z+o.z)),this.capsuleLineSprite.makeLineMode(new a(s.x+o.x,s.y,s.z+o.z),new a(s.x+o.x,s.y+o.y,s.z+o.z))}this.capsuleLineSprite.upToGpu()},t}(),Ae=function(){this.a=0,this.b=0,this.c=0,this.d=0},Te=function(){function t(){}return t._PanelEquationFromThreePt=function(t,e,i){var a=(e.y-t.y)*(i.z-t.z)-(e.z-t.z)*(i.y-t.y),r=(e.z-t.z)*(i.x-t.x)-(e.x-t.x)*(i.z-t.z),n=(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x),s=0-(a*t.x+r*t.y+n*t.z),o=new Ae;return o.a=a,o.b=r,o.c=n,o.d=s,o},t.calPlaneLineIntersectPoint=function(t,e,i,r){var n=new a,s=t.x,o=t.y,h=t.z,c=e.x,l=e.y,u=e.z,p=i.x-r.x,d=i.y-r.y,f=i.z-r.z,y=r.x,m=r.y,v=r.z,g=p*s+d*o+f*h;if(0==g)return null;var _=((c-y)*s+(l-m)*o+(u-v)*h)/g;return n.x=y+p*_,n.y=m+d*_,n.z=v+f*_,n},t}(),Me=function(){function t(){}return t.mathDisplay2Dto3DWorldPos=function(t,e){void 0===e&&(e=300);var i=e/(r.sceneViewHW/2),n=r.sceneViewHW/2*i,s=r.stageWidth,o=r.stageHeight,h=new d;h.prependRotation(-r.cam3D.rotationY,a.Y_AXIS),h.prependRotation(-r.cam3D.rotationX,a.X_AXIS);var c=r.viewMatrx3D.transformVector(new a(500,0,500)),l=c.x/c.w,u=s/2/l*i,p=o/2/l*i,f=t.x/s*u*2,y=t.y/o*p*2;return this.gettempPos(new a(-u+f,+p-y,n),h)},t.gettempPos=function(t,e){var i=e.transformVector(t);return i=i.add(new a(r.cam3D.x,r.cam3D.y,r.cam3D.z))},t.math3DWorldtoDisplay2DPos=function(t){var e=r.cam3D.cameraMatrix.clone();e.append(r.viewMatrx3D.clone());var i=r.stageWidth,a=r.stageHeight,n=e.transformVector(t),s=new O;return s.x=(n.x/n.w+1)*(i/2),s.y=(-n.y/n.w+1)*(a/2),s},t.argbToHex=function(t,e,i,a){return t<<24|e<<16|i<<8|a},t.hexToArgb=function(t){var e=new a;return e.w=t>>24&255,e.x=t>>16&255,e.y=t>>8&255,e.z=255&t,e},t.getLineAndPlaneIntersectPoint=function(t,e,i,r){var n=new a(t.x-e.x,t.y-e.y,t.z-e.z);n.normalize();var s=n.x*r.x+n.y*r.y+n.z*r.z,o=((i.x-t.x)*r.x+(i.y-t.y)*r.y+(i.z-t.z)*r.z)/s,h=new a;return h.setTo(t.x+n.x*o,t.y+n.y*o,t.z+n.z*o),h},t.lookAt=function(t,e){var i=new d;return i.buildLookAtLH(t,e,a.Y_AXIS),i},t.getTowPointsAngle2=function(t,e,i,a){var r=Math.atan2(a-e,i-t);return r<0&&(r+=2*Math.PI),180*r/Math.PI|0},t.getTowPointsAngle=function(t,e){var i=Math.atan2(e.y-t.y,e.x-t.x);return i<0&&(i+=2*Math.PI),180*i/Math.PI},t.getDisSquare=function(t,e,i,a){return Math.sqrt((t-i)*(t-i)+(e-a)*(e-a))},t}(),Pe=function(){function t(){}return t.getGroundPos=function(t,e){if(!this._plantObjectMath){var i=new a(0,-500,500),n=new a(-500,-500,0),s=new a(500,-500,0);this._plantObjectMath=Te._PanelEquationFromThreePt(i,n,s),this._plantnormal=new a(this._plantObjectMath.a,this._plantObjectMath.b,this._plantObjectMath.c),this._plantnormal.normalize(),this._plane_a=new a(i.x,i.y,i.z)}var o=Me.mathDisplay2Dto3DWorldPos(new O(t,e),500),h=new a(r.cam3D.x,r.cam3D.y,r.cam3D.z);return Te.calPlaneLineIntersectPoint(this._plantnormal,this._plane_a,o,h)},t}(),Se=function(){function t(){}return t.setData=function(t){this.navmeshData=t,this.heightItem=this.navmeshData.heightItem,this.jumpItem=this.navmeshData.jumpItem,this.midu=this.navmeshData.midu,this.aPos=new a(this.navmeshData.aPos.x,this.navmeshData.aPos.y,this.navmeshData.aPos.z),this.makeStarGraph(this.navmeshData.astarItem),this.astarWidth=this.heightItem[0].length,this.astarHeight=this.heightItem.length,Re.getInstance().fixAstart(new O(this.aPos.x,this.midu*this.astarHeight+this.aPos.z)),this.mathAreaRect(),this.mathMinMapRect()},Object.defineProperty(t,"sceneVectList",{set:function(t){this._sceneVectList=t,this._frist=!0},enumerable:!1,configurable:!0}),t.getJumpDataByV2d=function(t,e){return!!(this.jumpItem&&this.jumpItem.length&&this.jumpItem[e]&&1==this.jumpItem[e][t])},t.mathMinMapRect=function(){t.navmeshData.midu;var e=t.navmeshData.astarItem[0].length,i=t.navmeshData.astarItem.length,a=t.navmeshData.aPos.x+e*t.navmeshData.midu,r=t.navmeshData.aPos.z+i*t.navmeshData.midu;a=Math.max(Math.abs(t.navmeshData.aPos.x),Math.abs(a)),r=Math.max(Math.abs(t.navmeshData.aPos.z),Math.abs(r));var n=Math.max(a,r);n+=100,n=Math.round(n);var s=new Ht;s.x=-n,s.y=-n,s.width=2*n,s.height=2*n,s.x-=1,s.y-=1,s.width+=2,s.height+=2,s.width/=2,s.height/=2,this.minMapRect=s},t.mathAreaRect=function(){this.areaRect=new Ht,this.areaRect.x=this.aPos.x,this.areaRect.y=this.aPos.z,this.areaRect.width=this.astarWidth*this.midu,this.areaRect.height=this.astarHeight*this.midu},t.clear=function(){this.navmeshData&&(this._bakData=this.navmeshData,this.aPos.setTo(0,0,0),this.navmeshData=null)},t.porcessBak=function(t){t&&this.setData(this._bakData)},t.getHeightByPos=function(t){if(this.heightItem){var e=t.subtract(this.aPos).add(new a(this.midu/2,0,this.midu/2)),i=(this.astarWidth-1)*this.midu,r=(this.astarHeight-1)*this.midu;if(e.x>0&&e.x<=i&&e.z>0&&e.z<=r)return this.getBaseHeightByBitmapdata(e.x/this.midu,e.z/this.midu)}return-500},t.getBaseHeightByBitmapdata=function(t,e){var i=t-o.float2int(t),a=e-o.float2int(e);return(1-i)*(1-a)*this.getBitmapDataHight(o.float2int(t),o.float2int(e))+(1-i)*a*this.getBitmapDataHight(o.float2int(t),Math.ceil(e))+i*(1-a)*this.getBitmapDataHight(Math.ceil(t),o.float2int(e))+i*a*this.getBitmapDataHight(Math.ceil(t),Math.ceil(e))},t.getBitmapDataHight=function(t,e){return this.heightItem[this.heightItem.length-1-e][t]},t.findPath=function(t,e){return null},t.Path2dTo3d=function(t){for(var e=new Array,i=0;i<t.length;i++)e.push(this.getWorldPosByStart2D(t[i]));return e},t.getWorldPosByStart2D=function(t){if(this.navmeshData){var e=new a(t.x*this.midu,3,t.y*this.midu);return e.x=e.x+this.aPos.x+this.midu/2,e.z=this.aPos.z+this.midu*this.astarHeight-e.z-this.midu/2,e}return new a(10*t.x+this.midu/2,0,10*t.y-this.midu/2)},t.findPath3D=function(e,i){if(this.navmeshData){t.getPosIsCanMove(i)||(i=this.findNearLinePoint(e,i));var a=this.getGrapIndexByPos(e),r=this.getGrapIndexByPos(i);return this.getJumpDataByV2d(r.x,r.y)?null:this.isGridCanWalk(r)&&a?this.findStraightLine(a,r)?[a,r]:this.findPath2D(a,r):null}return[this.getGrapIndexByPos(e),this.getGrapIndexByPos(i)]},t.findStraightLine=function(t,e){var i=new O(e.x-t.x,e.y-t.y);i.normalize();for(var a=Math.round(O.distance(t,e)),r=new O,n=0;n<a;n++){if(r.x=Math.floor(t.x+n*i.x),r.y=Math.floor(t.y+n*i.y),!this.isGridCanWalk(r))return!1;if(r.x=Math.ceil(t.x+n*i.x),r.y=Math.ceil(t.y+n*i.y),!this.isGridCanWalk(r))return!1;if(r.x=Math.round(t.x+n*i.x),r.y=Math.round(t.y+n*i.y),!this.isGridCanWalk(r))return!1}return!0},t.isGridCanWalk=function(t){return!!t&&(!!this.graphData.grid[t.y]&&(!!this.graphData.grid[t.y][t.x]&&0!=this.graphData.grid[t.y][t.x].weight))},t.findPath2D=function(t,e){return null},t.turnLineAstar=function(t){if(t.length<2)return t;for(var e=[t[0]],i=2;i<t.length;i++)this.findStraightLine(e[e.length-1],t[i])||e.push(t[i-1]);return e.push(t[t.length-1]),t.length!=e.length?this.turnLineAstar(e):e},t.simplifyAstar=function(t){var e=0;if(t.length,t.length>2){var i=new Array;i.push(t[0]);for(var a=2;a<t.length;a++){var r=i[i.length-1],n=t[a-1],s=t[a];Math.atan2(n.y-r.y,n.x-r.x)!=Math.atan2(s.y-r.y,s.x-r.x)||e>126?i.push(n):e++}return i.push(t[t.length-1]),i}return t},t.findNearLinePoint=function(e,i){for(;a.distance(e,i)>5;)if(i=this.moveA2B(i,e,1),t.getPosIsCanMove(i))return i;return i},t.moveA2B=function(t,e,i){var a=e.subtract(t);return a.normalize(),a.scaleBy(i),a=a.add(t)},t.getPosIsCanMove=function(t){if(!this.graphData||!this.graphData.grid)return!1;var e=this.getGrapIndexByPos(t);return this.isGridCanWalk(e)},t.makeStarGraph=function(t){},t.blockAry=function(t){for(var e=new Array,i=0;i<t.length;i++)e.push([new O(t[i][0],t[i][1]),new O(t[i][2],t[i][3])]);this.blockList(e)},t.blockList=function(t){this.blockBakData&&this.unblock(),this.blockBakData=new Array;for(var e=0;e<t.length;e++)this.blockPoint(t[e][0],t[e][1])},t.blockPoint=function(t,e){var i=new Ht;i.y=Math.min(t.x,e.x),i.x=Math.min(t.y,e.y),i.height=Math.abs(t.x-e.x),i.width=Math.abs(t.y-e.y),this.blockRec(i)},t.blockRec=function(t){for(var e=0;e<t.width;e++){for(var i=new Array,a=0;a<t.height;a++){var r=e+t.x,n=a+t.y,s=this.graphData.grid[r][n];i.push({i:r,j:n,w:s.weight}),s.weight=0}this.blockBakData.push(i)}},t.unblock=function(){if(this.blockBakData){for(var t=0;t<this.blockBakData.length;t++)for(var e=0;e<this.blockBakData[t].length;e++){var i=this.blockBakData[t][e];this.graphData.grid[i.i][i.j].weight=i.w}this.blockBakData=null}},t.getGrapIndexByPos=function(t){if(!this.navmeshData)return new O(o.float2int(t.x/this.midu),o.float2int(t.z/this.midu));var e=t.subtract(this.aPos).add(new a(0,0,this.midu/2)),i=this.astarWidth*this.midu,r=this.astarHeight*this.midu;return e.x>0&&e.x<i&&e.z>0&&e.z<r?new O(o.float2int(e.x/this.midu),o.float2int(this.astarHeight-e.z/this.midu)):null},t.getScenePos=function(t,e){var i=Pe.getGroundPos(t,e);return this.getLookAtPos(i)},t.getLookAtPos=function(e){var i=new a(r.cam3D.x,r.cam3D.y,r.cam3D.z),n=e.subtract(i);n.normalize();for(var s,o=0;;){o+=2;var h=n.clone();h.scaleBy(o);var c=i.add(h);if(t.getHeightByPos(c)>c.y){s=c;break}if(o>1e3){s=null;break}}return s},t.aPos=new a,t.midu=10,t.astarWidth=0,t.astarHeight=0,t._frist=!1,t.canwalkItem=[],t}(),Ie=function(){function t(){this._defaultVec=new Array;for(var t=[.4444730390920146,-.3834955622240026,-.33124467509627725,.09365654209093091,-.05673310882817577,.2120523322966496,.02945768486978205,-.04965996229802928,-.1136529129285836],e=0;e<9;e++)this._defaultVec.push(new a(t[e],t[e],t[e]))}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.setLightProbeData=function(t){this._dataAry=t},t.prototype.clear=function(){this._dataAry=null},t.prototype.getData=function(t){if(!this._dataAry)return this._defaultVec;for(var e=0;e<this._dataAry.length;e++){var i=this._dataAry[e];if(this.testPoint(i,t)){var a=i.postion,r=t.subtract(a);return this.getResultData(i.posItem,o.float2int(r.x/i.betweenNum),o.float2int(r.z/i.betweenNum),o.float2int(r.y/i.betweenNum),i.betweenNum,r)}}return this._defaultVec},t.prototype.testPoint=function(t,e){var i=(t.cubeVec.x-1)*t.betweenNum,a=(t.cubeVec.y-1)*t.betweenNum,r=(t.cubeVec.z-1)*t.betweenNum,n=e.x-t.postion.x,s=e.y-t.postion.y,o=e.z-t.postion.z;return n>=0&&n<i&&s>=0&&s<a&&o>=0&&o<r},t.prototype.getResultData=function(t,e,i,r,n,s){var o=new Array;o.push(new Be(t[e][i][r],s)),o.push(new Be(t[e+1][i][r],s)),o.push(new Be(t[e][i+1][r],s)),o.push(new Be(t[e+1][i+1][r],s)),o.push(new Be(t[e][i][r+1],s)),o.push(new Be(t[e+1][i][r+1],s)),o.push(new Be(t[e][i+1][r+1],s)),o.push(new Be(t[e+1][i+1][r+1],s));for(var h=0,c=0;c<o.length;c++)h+=o[c].dis;for(c=0;c<o.length;c++)o[c].setBais(h);var l=0;for(c=0;c<o.length;c++)l+=o[c].bais;for(c=0;c<o.length;c++)o[c].bais=o[c].bais/l;var u=new Array;for(c=0;c<9;c++){for(var p=new a,d=0;d<o.length;d++){var f=new a(o[d].vecNum[c].x,o[d].vecNum[c].y,o[d].vecNum[c].z);f.scaleBy(o[d].bais),p=p.add(f)}u.push(p)}return u},t}(),Be=function(){function t(t,e){this.pos=new a(t.x,t.y,t.z),this.vecNum=t.resultSHVec,this.dis=a.distance(this.pos,e)}return t.prototype.setBais=function(t){this.bais=this.dis/t*(this.dis/t),this.bais=1/this.bais},t}(),Re=function(){function t(){this._ready=!1,this.render=!0,this._displayList=new Array,this._displaySpriteList=new Array,this._displayRoleList=new Array,this._display2DList=new Array,this._sceneParticleList=new Array,this._time=h.getTimer(),this._sceneDic=new Object,this.initScene(),this.viewFrustum=new we}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},Object.defineProperty(t.prototype,"displayList",{get:function(){return this._displayList},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"displayRoleList",{get:function(){return this._displayRoleList},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"displaySpriteList",{get:function(){return this._displaySpriteList},enumerable:!1,configurable:!0}),t.prototype.clearScene=function(){this._displayRoleList.length=0},t.prototype.clearStaticScene=function(){for(var t in this._sceneDic){var e=this._sceneDic[t];e instanceof Mt?(Ut.getInstance().removeParticle(e),e.destory()):e instanceof Gt&&(e.removeStage(),e.destory())}this._ready=!1,this._sceneDic=null,this._sceneQuadTree=null,this._displayList.length=0,this._sceneParticleList.length=0,Se.porcessBak(!1)},t.prototype.testUrl=function(t){return this._currentUrl==t},t.prototype.loadScene=function(t,e,i,a){var r=this;if(this._currentUrl==t)return Se.porcessBak(!0),this._ready=!0,e(),void a();this.clearStaticScene(),this._ready=!1,ye.getInstance().loadSceneRes(t,e,i,(function(t){r.loadSceneConfigCom(t),a()})),this._currentUrl=t},t.prototype.getDisplayByID=function(t,e){return 0==t?this._sceneDic["build"+e]:1==t?this._sceneDic["particle"+e]:void 0},t.prototype.fixAstart=function(t){for(var e=0;e<this._displayRoleList.length;e++)this._displayRoleList[e].fixAstartData(t)},t.prototype.loadSceneConfigCom=function(t){this._sceneDic=new Object;var e=t.groundItem,i=t.buildItem;r.fogColor=[t.fogColor.x/255,t.fogColor.y/255,t.fogColor.z/255];var a=1*t.fogDistance,n=t.fogAttenuation;r.gameAngle=isNaN(t.gameAngle)?0:t.gameAngle,r.focus3D.rotationY=r.gameAngle,r.fogData=[a*n,1/((1-n)*a)],r.sceneNumId++;for(var s=0;e&&s<e.length;s++){var o=this.getGroundSprite(e[s],t.terrain);this.addDisplay(o)}for(var h=0;h<i.length;h++){var c=i[h];if(c.type==Ot.PREFAB_TYPE){var l=this.getBuildSprite(c);this.addDisplay(l)}else if(c.type==Ot.SCENE_PARTICLE_TYPE){var u=this.getParticleSprite(c);Ut.getInstance().addParticle(u),this._sceneParticleList.push(u)}}r.light.setData(t.SunNrm,t.SunLigth,t.AmbientLight),Ie.getInstance().setLightProbeData(t.lightProbeItem),Se.setData(t.astar),this._ready=!0,t.quadTreeData?(this._sceneQuadTree=new De,this._sceneQuadTree.init(t.quadTreeData,this._sceneDic)):this._sceneQuadTree=null},t.prototype.getGroundSprite=function(t,e){var i=new Qt;return i.setObjUrl(t.objsurl),i.setMaterialUrl(t.materialurl,t.materialInfoArr),i.materialInfoArr=t.materialInfoArr,i.setLightMapUrl(t.lighturl),i.scaleX=t.scaleX,i.scaleY=t.scaleY,i.scaleZ=t.scaleZ,i.x=t.x,i.y=t.y,i.z=t.z,i.rotationX=t.rotationX,i.rotationY=t.rotationY,i.rotationZ=t.rotationZ,i.objData.lightuvsOffsets=i.objData.uvsOffsets,e&&i.setGrounDataMesh(e[t.id]),this._sceneDic["ground"+t.id]=i,i},t.prototype.makeCollisioin=function(t){},Object.defineProperty(t.prototype,"ready",{get:function(){return this._ready},set:function(t){this._ready=t},enumerable:!1,configurable:!0}),t.prototype.getBuildSprite=function(t){var e=new Gt;return e.setObjUrl(t.objsurl),e.setMaterialUrl(t.materialurl,t.materialInfoArr),e.materialInfoArr=t.materialInfoArr,e.setLightMapUrl(t.lighturl),e.scaleX=t.scaleX,e.scaleY=t.scaleY,e.scaleZ=t.scaleZ,e.x=t.x,e.y=t.y,e.z=t.z,e.rotationX=t.rotationX,e.rotationY=t.rotationY,e.rotationZ=t.rotationZ,e.isPerspective=t.isPerspective,e.type=0,e.id=t.id,this._sceneDic["build"+t.id]=e,e},t.prototype.getParticleSprite=function(t){var e;return(e=Ut.getInstance().getParticleByte(r.fileRoot+t.url)).scaleX=t.scaleX,e.scaleY=t.scaleY,e.scaleZ=t.scaleZ,e.x=t.x,e.y=t.y,e.z=t.z,e.rotationX=t.rotationX,e.rotationY=t.rotationY,e.rotationZ=t.rotationZ,e.type=0,this._sceneDic["particle"+t.id]=e,e},t.prototype.initScene=function(){},t.prototype.addDisplay=function(t){-1==this._displayList.indexOf(t)&&(this._displayList.push(t),t.addStage())},t.prototype.removeDisplay=function(t){var e=this._displayList.indexOf(t);-1!=e&&this._displayList.splice(e,1),t.removeStage()},t.prototype.addSpriteDisplay=function(t){if(-1==this._displaySpriteList.indexOf(t)){t.addStage();for(var e=0;e<this._displaySpriteList.length;e++)if(this._displaySpriteList[e].materialUrl==t.materialUrl)return void this._displaySpriteList.splice(e,0,t);this._displaySpriteList.push(t)}},t.prototype.removeSpriteDisplay=function(t){var e=this._displaySpriteList.indexOf(t);-1!=e&&this._displaySpriteList.splice(e,1),t.removeStage()},t.prototype.addMovieDisplay=function(t){this._displayRoleList.push(t),t.addStage()},t.prototype.addMovieDisplayTop=function(t){this._displayRoleList.unshift(t),t.addStage()},t.prototype.removeMovieDisplay=function(t){var e=this._displayRoleList.indexOf(t);-1!=e&&this._displayRoleList.splice(e,1),t.removeStage()},t.prototype.setParticleVisible=function(){for(var t=Ut.getInstance().particleList,e=0;t&&e<t.length;e++)if(!t[e].dynamic&&t[e].bindVecter3d){var i=a.distance(new a(r.focus3D.x,r.focus3D.y,r.focus3D.z),new a(t[e].x,t[e].y,t[e].z));t[e].sceneVisible=i<1e3}},t.prototype.addDisplay2DList=function(t){this._display2DList.push(t)},t.prototype.mathCamFar=function(){for(var t=new a,e=0,i=0;i<this._displayList.length;i++){var n=this._displayList[i];if(n.sceneVisible&&n.aabb){n.posMatrix.clone().append(r.cam3D.cameraMatrix);for(var s=n.aabbVect,o=0;o<s.length;o++)(t=r.cam3D.cameraMatrix.transformVector(s[o])).z>e&&(e=t.z)}}r.camFar=Math.max(500,e+100),u.resetViewMatrx3D()},t.prototype.updateStaticDiplay=function(){for(var t=0;t<this._displayList.length;t++)this._displayList[t].update()},t.prototype.updateStaticBind=function(){},t.prototype.updateSpriteDisplay=function(){for(var t=0;t<this._displaySpriteList.length;t++)this._displaySpriteList[t].update()},t.prototype.updateMovieDisplay=function(){for(var t=0;t<this._displayRoleList.length;t++)this._displayRoleList[t].update();this._displayRoleList.length&&r.context3D.setVa(1,3,null)},t.prototype.updateMovieFrame=function(){var t=h.getTimer(),e=t-this._time;this._time=t;for(var i=0;i<this._displayRoleList.length;i++)this._displayRoleList[i].updateFrame(e)},t}(),Fe=function(){function t(){this._currentDirect=new a}return t.prototype.update=function(t){if(this.time=t,this.hasReached)return this.endTime+=t,void(this.endTime>200&&this.applyArrive());if(this.skillTrajectory.setCurrentPos()&&(this._currentDirect.x=this.currentTargetPos.x-this.currentPos.x,this._currentDirect.y=this.currentTargetPos.y-this.currentPos.y,this._currentDirect.z=this.currentTargetPos.z-this.currentPos.z,this._currentDirect.normalize(),this._currentDirect.scaleBy(this.speed),this.setRotationMatrix(this.currentTargetPos.subtract(this.currentPos)),0==this._currentDirect.length))this.arrive();else{var e=this._currentDirect.length*this.time;if(!this.hasReached){var i=a.distance(this.currentPos,this.currentTargetPos);this.currentPos.x+=this._currentDirect.x*this.time,this.currentPos.y+=this._currentDirect.y*this.time,this.currentPos.z+=this._currentDirect.z*this.time}e>i&&this.arrive()}},t.prototype.setRotationMatrix=function(t){t.normalize();var e=new a(0,0,1),i=e.cross(t);i.normalize();var r=Math.acos(t.dot(e)),n=new p;n.fromAxisAngle(i,r),n.toMatrix3D(this.rotationMatrix)},t.prototype.arrive=function(){this.hasReached=!0},t.prototype.applyArrive=function(){this.endFun(),this.bloodFun&&this.bloodFun()},t.prototype.reset=function(){this.hasReached=!1,this._currentDirect.setTo(0,0,0),this.endTime=0},t.prototype.add=function(){},t.prototype.setData=function(t,e,i,a,r,n){this.skillTrajectory=t,this.currentPos=i,this.rotationMatrix=a,this.currentTargetPos=r,this.endFun=e,this.bloodFun=n},t}(),Le=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.basePos=new a,e}return i(e,t),e.prototype.add=function(){this.skillTrajectory.setCurrentPos();var t=new a;t.x=this.currentTargetPos.x-this.currentPos.x,t.y=this.currentTargetPos.y-this.currentPos.y,t.z=this.currentTargetPos.z-this.currentPos.z,this.basePos.setTo(this.currentPos.x,this.currentPos.y,this.currentPos.z),this.alltime=t.length/this.speed},e.prototype.update=function(t){if(this.time=t,this.lastTime+=t,this.hasReached)return this.endTime+=t,void(this.endTime>200&&this.applyArrive());this.skillTrajectory.setCurrentPos();var e=this.lastTime/this.alltime;e>1&&(e=1);var i=this.getOffset(e);if(this._currentDirect.x=this.currentTargetPos.x-this.basePos.x,this._currentDirect.y=this.currentTargetPos.y-this.basePos.y,this._currentDirect.z=this.currentTargetPos.z-this.basePos.z,this._currentDirect.normalize(),this._currentDirect.scaleBy(this.speed),this.setRotationMatrix(this.currentTargetPos.subtract(this.basePos)),0!=this._currentDirect.length){var r=this._currentDirect.length*this.time;if(!this.hasReached){var n=a.distance(this.basePos,this.currentTargetPos);this.basePos.x+=this._currentDirect.x*this.time,this.basePos.y+=this._currentDirect.y*this.time,this.basePos.z+=this._currentDirect.z*this.time,this.setApplyPos(i)}r>n&&this.arrive()}else this.arrive()},e.prototype.setApplyPos=function(t){this.currentPos.x=this.basePos.x+t.x,this.currentPos.y=this.basePos.y+t.y,this.currentPos.z=this.basePos.z+t.z},e.prototype.getOffset=function(t){return t=100*Math.sin(t*Math.PI),this._currentDirect.cross(new a(0,1,0)).scaleBy(t),new a},e.prototype.reset=function(){t.prototype.reset.call(this),this.lastTime=0},e}(Fe),Ce=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.getOffset=function(t){return t=300*(t-t*t),this._currentDirect.cross(new a(0,-1,0)).scaleBy(t),new a},e}(Le),Ee=function(){function t(){}return t.reg=function(t,e){this.dic[t]=e},t.getNewPath=function(t){return new(0,this.dic[t])},t.init=function(){this.dic[0]=Fe,this.dic[1]=Le,this.dic[2]=Ce},t.dic=new Object,t}(),ze=function(){function t(){this.time=0}return t.prototype.addToRender=function(){this.particle&&(this.particle.reset(),this.particle.sceneVisible=!0,Ut.getInstance().addParticle(this.particle))},t.prototype.setInfo=function(t){this.time=t.frame*r.frameTime,this.particle=Ut.getInstance().getParticleByte(r.fileRoot+t.url)},t.prototype.reset=function(){this.particle.reset(),Ut.getInstance().removeParticle(this.particle)},t.prototype.destory=function(){this.particle.destory(),this.particle=null,this.removeCallFun=null},t}(),Ve=function(t){function e(){var e=t.call(this)||this;return e._currentPos=new a,e.rotationMatrix=new d,e._socketMaxrix=new d,e._currentTargetPos=new a,e}return i(e,t),e.prototype.update=function(t){this.path.update(t)},e.prototype.reset=function(){t.prototype.reset.call(this),this.endParticle&&(Ut.getInstance().addParticle(this.endParticle),this.endParticle.reset(),this.endParticle.setPos(this._currentTargetPos.x,this._currentTargetPos.y,this._currentTargetPos.z)),this.removeCallFun&&this.removeCallFun(this)},e.prototype.endPlayFun=function(t){Ut.getInstance().removeParticle(this.endParticle),this.endParticle.removeEventListener(U.COMPLETE,this.endPlayFun,this)},e.prototype.setCurrentPos=function(){if(this.data.hitSocket){var t=this.target;return t&&(t.getSocket(this.data.hitSocket,this._socketMaxrix),this._currentTargetPos.setTo(this._socketMaxrix.position.x,this._socketMaxrix.position.y,this._socketMaxrix.position.z)),!0}return(this._currentTargetPos.x!=this.target.x||this._currentTargetPos.y!=this.target.y||this._currentTargetPos.z!=this.target.z)&&(this._currentTargetPos.setTo(this.target.x,this.target.y,this.target.z),!0)},e.prototype.addToRender=function(){var e;if(t.prototype.addToRender.call(this),0==this.data.beginType){var i=new d;i.appendRotation(this.active.rotationY,a.Y_AXIS),e=i.transformVector(this.data.beginPos),this._currentPos.setTo(this.active.x+e.x,this.active.y+e.y,this.active.z+e.z)}else if(1==this.data.beginType){var r=new d;this.active.getSocket(this.data.beginSocket,r),e=r.position,this._currentPos.setTo(e.x,e.y,e.z)}this.particle.setPos(this._currentPos.x,this._currentPos.y,this._currentPos.z),this.path.add()},e.prototype.getSocket=function(t,e){e.identity(),e.append(this.rotationMatrix),e.appendTranslation(this._currentPos.x,this._currentPos.y,this._currentPos.z)},e.prototype.getSunType=function(){return 0},e.prototype.setInfo=function(e){t.prototype.setInfo.call(this,e),this.particle.bindTarget=this,this.data=e,this.data.endParticleUrl&&(this.endParticle=Ut.getInstance().getParticleByte(r.fileRoot+this.data.endParticleUrl),this.endParticle.addEventListener(U.COMPLETE,this.endPlayFun,this))},e.prototype.setPlayData=function(t,e,i,a,r){var n=this;void 0===r&&(r=null),this.active=t,this.target=e,this.removeCallFun=i,this._currentPos.setTo(0,0,0),this.rotationMatrix.identity(),this._socketMaxrix.identity(),this._currentTargetPos.setTo(0,0,0),this.path||(this.path=Ee.getNewPath(2),this.path.setData(this,(function(){n.reset()}),this._currentPos,this.rotationMatrix,this._currentTargetPos,r),this.path.speed=this.data.speed),this.path.reset()},e.prototype.destory=function(){t.prototype.destory.call(this),this.active=null,this.target=null,this.data=null,this._currentPos=null,this.rotationMatrix=null,this._socketMaxrix=null,this._currentTargetPos=null,this.path=null},e}(ze),Ne=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Pos"),t.bindAttribLocation(this.program,1,"v2uv")},e.prototype.getVertexShaderString=function(){return"attribute vec3 v3Pos;attribute vec3 v2uv;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform vec4 pos[30];varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(v2uv.x, v2uv.y);   vec3 vt1= vec3(v3Pos.xyz * pos[int(v2uv.z)].w + pos[int(v2uv.z)].xyz);   vec4 vt0= vec4(vt1, 1.0);   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"},e.prototype.getFragmentShaderString=function(){return" precision mediump float;\nuniform sampler2D s_texture;\nvarying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz *= infoUv.w;\ngl_FragColor = infoUv;\n}"},e.Display3DShadowShader="Display3DShadowShader",e}(nt),ke=function(t){function e(){var e=t.call(this)||this;return e.needUpdate=!1,e.locationFloat32=new Float32Array(0),e.shadowList=new Array,e.objData=new L,e.shader=V.getInstance().getProgram(Ne.Display3DShadowShader),e.program=e.shader.program,e.posProLocation=r.context3D.getLocation(e.program,"pos"),e}return i(e,t),e.prototype.addShadow=function(t){this.shadowList.push(t),t.display=this,this.applyObjData()},e.prototype.removeShadow=function(t){var e=this.shadowList.indexOf(t);-1!=e&&(this.shadowList.splice(e,1),this.applyObjData()),this.shadowList.length},e.prototype.stateChage=function(){for(var t=0;t<this.shadowList.length&&!this.shadowList[t].visible;t++);t==this.shadowList.length?this.needUpdate=!1:this.needUpdate=!0},e.prototype.hasIdle=function(){return this.shadowList.length<30},e.prototype.applyObjData=function(){this.objData.vertices.length=0,this.objData.uvs.length=0,this.objData.indexs.length=0;for(var t=0;t<this.shadowList.length;t++)this.objData.vertices.push(-1,0,1,1,0,1,1,0,-1,-1,0,-1),this.objData.uvs.push(0,0,t,0,1,t,1,1,t,1,0,t),this.objData.indexs.push(4*t,1+4*t,2+4*t,4*t,2+4*t,3+4*t);this.objData.treNum=6*this.shadowList.length,this.objData.vertexBuffer?(r.context3D.uploadBuff3DByBuffer(this.objData.vertexBuffer,this.objData.vertices),r.context3D.uploadBuff3DByBuffer(this.objData.uvBuffer,this.objData.uvs),r.context3D.uploadIndexBuff3DByBuffer(this.objData.indexBuffer,this.objData.indexs)):(this.objData.vertexBuffer=r.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=r.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=r.context3D.uploadIndexBuff3D(this.objData.indexs))},e.prototype.update=function(){if(this.needUpdate&&0!=this.shadowList.length&&this.objData.treNum){r.context3D.setBlendParticleFactors(0),r.context3D.setProgram(this.program),r.context3D.setVcMatrix4fv(this.shader,"viewMatrix3D",r.viewMatrx3D.m),r.context3D.setVcMatrix4fv(this.shader,"camMatrix3D",r.cam3D.cameraMatrix.m),this.locationFloat32.length!=4*this.shadowList.length&&(this.locationFloat32=new Float32Array(4*this.shadowList.length));for(var t=0;t<this.shadowList.length;t++)this.shadowList[t].visible?(this.locationFloat32[4*t+0]=this.shadowList[t].data[0],this.locationFloat32[4*t+1]=this.shadowList[t].data[1],this.locationFloat32[4*t+2]=this.shadowList[t].data[2],this.locationFloat32[4*t+3]=this.shadowList[t].data[3]):(this.locationFloat32[4*t+0]=0,this.locationFloat32[4*t+1]=1e4,this.locationFloat32[4*t+2]=0,this.locationFloat32[4*t+3]=0);r.context3D.setVc4fvLocation(this.posProLocation,this.locationFloat32),r.context3D.setVa(0,3,this.objData.vertexBuffer),r.context3D.setVa(1,3,this.objData.uvBuffer),r.context3D.setRenderTexture(this.shader,"s_texture",e.texture,0),r.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)}},e}(m),Ue=function(){function t(){this._visible=!1,this.data=[0,0,0,5]}return Object.defineProperty(t.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible=t,this.display.stateChage()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this.data[0]},set:function(t){this.data[0]=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.data[1]},set:function(t){this.data[1]=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this.data[2]},set:function(t){this.data[2]=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this.data[3]},set:function(t){this.data[3]=t},enumerable:!1,configurable:!0}),t}(),Oe=function(){function t(){this._displayList=new Array,V.getInstance().registe(Ne.Display3DShadowShader,new Ne)}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.addShadow=function(){var t=this.getIdleShadow(),e=new Ue;return t.addShadow(e),e},t.prototype.removeShadow=function(t){t.display.removeShadow(t)},t.prototype.update=function(){if(this._displayList.length){r.context3D.setWriteDepth(!1);for(var t=0;t<this._displayList.length;t++)this._displayList[t].update();r.context3D.setWriteDepth(!0)}},t.prototype.getIdleShadow=function(){for(var t=0;t<this._displayList.length;t++)if(this._displayList[t].hasIdle())return this._displayList[t];var e=new ke;return this._displayList.push(e),e},t}(),je=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.load=function(t,e){var i=this;this._fun=e,w.getInstance().load(t,w.BYTE_TYPE,(function(t){i.loadComplete(t)}))},e.prototype.loadComplete=function(t){var e=this;this.dataAry=new Array,this._byte=new s(t),this._byte.position=0,this.version=this._byte.readInt(),this.read((function(){e.readNext()}))},e.prototype.readNext=function(){if(this.read(),this.read(),this.read(),this._byte.readBoolean())for(var t=this._byte.readInt(),e=0;e<t;e++)this.readItem(!0);else this.readItem(!1);this._fun(),this._fun=null,this._byte=null},e.prototype.readItem=function(t){var e=this._byte.readInt(),i=new Xe;i.isGroup=t,t&&(i.x=this._byte.readFloat(),i.y=this._byte.readFloat(),i.z=this._byte.readFloat(),i.scaleX=this._byte.readFloat(),i.scaleY=this._byte.readFloat(),i.scaleZ=this._byte.readFloat(),i.rotationX=this._byte.readFloat(),i.rotationY=this._byte.readFloat(),i.rotationZ=this._byte.readFloat()),e==Ot.PREFAB_TYPE?(i.objUrl=this._byte.readUTF(),i.materialUrl=this._byte.readUTF(),this.version>=4&&(i.materialInfoArr=this.readMaterialInfo()),i.types=Ot.PREFAB_TYPE):e==Ot.SCENE_PARTICLE_TYPE&&(i.particleUrl=this._byte.readUTF(),i.types=Ot.SCENE_PARTICLE_TYPE),this.dataAry.push(i)},e.prototype.initReg=function(){this._objDic=new Object,this._materialDic=new Object,this._particleDic=new Object;for(var t=0;t<this.dataAry.length;t++){var e=this.dataAry[t];e.objUrl&&(this._objDic[r.fileRoot+e.objUrl]=!0),e.materialUrl&&(this._materialDic[r.fileRoot+e.materialUrl]=!0),e.particleUrl&&(this._particleDic[r.fileRoot+e.particleUrl]=!0)}for(var i in this._objDic)Wt.getInstance().registerUrl(i);for(var i in this._materialDic)N.getInstance().registerUrl(i);for(var i in this._particleDic)Ut.getInstance().registerUrl(i)},e.prototype.destory=function(){for(var e in t.prototype.destory.call(this),this._objDic)Wt.getInstance().releaseUrl(e);for(var e in this._materialDic)N.getInstance().releaseUrl(e);for(var e in this._particleDic)Ut.getInstance().releaseUrl(e);this.dataAry=null,this._objDic=null,this._particleDic=null,this._materialDic=null},e}(Ot),Xe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(y),We=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._loadDic=new Object,e}return i(e,t),e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.getGroupData=function(t,e){var i=this;if(this._dic[t]){var a=this._dic[t];return a.useNum++,void e(a)}if(this._loadDic[t])this._loadDic[t].push(e);else{this._loadDic[t]=new Array,this._loadDic[t].push(e);var r=new je;r.load(t,(function(){for(var e=i._loadDic[t],a=0;a<e.length;a++){(0,e[a])(r)}i._dic[t]=r,delete i._loadDic[t],r.initReg()}))}},e}(b),Ye=function(t){function e(){var e=t.call(this)||this;return e._completeState=0,e._defaultAction="idle",e._curentFrame=0,e._actionTime=0,e._fileScale=1,e._hasDestory=!1,e._isSinging=!1,e.meshVisible=!0,e._nextScale=1,e.locationDic=new Object,e._animDic=new Object,e._partDic=new Object,e._partUrl=new Object,e._preLoadActionDic=new Object,e._waitLoadActionDic=new Object,e.showCapsule=!1,e._enablePhysics=!1,e}return i(e,t),Object.defineProperty(e.prototype,"isSinging",{get:function(){return this._isSinging},set:function(t){this._isSinging=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"curentAction",{get:function(){return this._curentAction},set:function(t){this._curentAction=t},enumerable:!1,configurable:!0}),e.prototype.fixAstartData=function(t){},e.prototype.setRoleUrl=function(t){var e=this;this.clearMesh(),ae.getInstance().getMeshData(t,(function(t){e._hasDestory?t.useNum--:(e._skinMesh=t,e.fileScale=t.fileScale,e.onStage&&e.addSkinMeshParticle(),e._animDic=t.animDic,e.onMeshLoaded())}))},e.prototype.onMeshLoaded=function(){this.dispatchEvent(new U(U.COMPLETE))},e.prototype.clearMesh=function(){this.removeSkinMeshParticle(),this._skinMesh&&this._skinMesh.useNum--,this._skinMesh=null,this._animDic=new Object},e.prototype.addSkinMeshParticle=function(){if(this._skinMesh){var t=new Array;this._partDic.mesh=t;var e=this._skinMesh.meshAry;if(e)for(var i=0;i<e.length;i++)for(var a=e[i].particleAry,n=0;n<a.length;n++){var s,o=a[n];(s=Ut.getInstance().getParticleByte(r.fileRoot+o.url)).sourceData||console.log("particle.sourceData error"),s.dynamic=!0,s.bindSocket=o.socketName,t.push(s),s.bindTarget=this,Ut.getInstance().addParticle(s)}}},e.prototype.removeSkinMeshParticle=function(){var t=this._partDic.mesh;if(t){for(var e=0;e<t.length;e++)Ut.getInstance().removeParticle(t[e]),t[e].destory();this._partDic.mesh=null}},e.prototype.roleResCom=function(t,e){},e.prototype.setMeshUrl=function(t,e){var i=this;void 0===e&&(e=1),this._meshUrl=r.fileRoot+t,ae.getInstance().getMeshData(this._meshUrl,(function(t){for(var a in i._skinMesh=t,1!=e&&(i._skinMesh.type=1),i._animDic)i.processAnimByMesh(i._animDic[a]);t.loadMaterial((function(t){i.loadMaterialCom(t)})),i.fileScale=t.fileScale}),e)},Object.defineProperty(e.prototype,"scale",{get:function(){return this._nextScale},set:function(t){this._nextScale=t,this._scaleX=t*this._fileScale,this._scaleY=t*this._fileScale,this._scaleZ=t*this._fileScale,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fileScale",{set:function(t){this._fileScale=t,this._scaleX=this._nextScale*t,this._scaleY=this._nextScale*t,this._scaleZ=this._nextScale*t,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shadow",{set:function(t){t?this._shadow||(this._shadow=Oe.getInstance().addShadow()):this._shadow&&Oe.getInstance().removeShadow(this._shadow)},enumerable:!1,configurable:!0}),e.prototype.setShadowSize=function(t){this._shadow&&(this._shadow.size=t)},e.prototype.addStage=function(){t.prototype.addStage.call(this),this.addSkinMeshParticle(),this._shadow&&(this._shadow.visible=!0)},e.prototype.removeStage=function(){for(var e in t.prototype.removeStage.call(this),this._shadow&&Oe.getInstance().removeShadow(this._shadow),this._partDic)for(var i=this._partDic[e],a=0;a<i.length;a++)i[a]instanceof Mt?Ut.getInstance().removeParticle(i[a]):i[a]instanceof Gt&&Re.getInstance().removeSpriteDisplay(i[a])},e.prototype.loadMaterialCom=function(t){t.lightProbe&&(this.lightProbe=!0)},e.prototype.setCollision=function(t,e){},e.prototype.applyVisible=function(){},e.prototype.removePart=function(t){var e=this._partDic[t];if(e){for(var i=0;i<e.length;i++)e[i]instanceof Mt?(Ut.getInstance().removeParticle(e[i]),e[i].destory()):e[i]instanceof Gt&&(Re.getInstance().removeSpriteDisplay(e[i]),e[i].destory());this._partDic[t]=null,this._partUrl[t]=null,delete this._partDic[t],delete this._partUrl[t]}},e.prototype.addPart=function(t,e,i){var a=this;if(this._partUrl[t]!=i){this._partUrl[t]&&this.removePart(t),this._partDic[t]||(this._partDic[t]=new Array),this._partUrl[t]=i;var n=this._partDic[t];We.getInstance().getGroupData(r.fileRoot+i,(function(t){a.loadPartRes(e,t,n)}))}},e.prototype.loadPartRes=function(t,e,i){if(!this._hasDestory){for(var n=0;n<e.dataAry.length;n++){var s,o,h,c=e.dataAry[n];if(c.isGroup&&(s=new a(c.x,c.y,c.z),o=new a(c.rotationX,c.rotationY,c.rotationZ),h=new a(c.scaleX,c.scaleY,c.scaleZ)),c.types==Ot.SCENE_PARTICLE_TYPE){var l=Ut.getInstance().getParticleByte(r.fileRoot+c.particleUrl);i.push(l),l.bindTarget=this,l.bindSocket=t,l.dynamic=!0,Ut.getInstance().addParticle(l),c.isGroup&&l.setGroup(s,o,h)}else if(c.types==Ot.PREFAB_TYPE){var u=new Gt;u.setObjUrl(c.objUrl),u.setMaterialUrl(c.materialUrl,c.materialInfoArr),u.dynamic=!0,i.push(u),u.setBind(this,t),Re.getInstance().addSpriteDisplay(u),c.isGroup&&u.setGroup(s,o,h)}}this.applyVisible()}},e.prototype.getSocket=function(t,e){if(e.identity(),this._skinMesh)if(this._skinMesh.boneSocketDic[t]){var i,r=this._skinMesh.boneSocketDic[t],n=r.index;i=this.getFrameMatrix(n),e.appendScale(1/this._scaleX,1/this._scaleY,1/this._scaleZ),e.appendRotation(r.rotationX,a.X_AXIS),e.appendRotation(r.rotationY,a.Y_AXIS),e.appendRotation(r.rotationZ,a.Z_AXIS),e.appendTranslation(r.x,r.y,r.z),i&&(e.append(this._skinMesh.meshAry[this._skinMesh.meshAry.length-1].bindPosInvertMatrixAry[n]),e.append(i)),e.append(this.posMatrix)}else(t="none")?e.appendTranslation(this._x,this._y,this._z):e.append(this.posMatrix);else e.append(this.posMatrix)},e.prototype.getSunType=function(){return 0},e.prototype.getFrameMatrix=function(t){if(this._animDic[this.curentAction]){var e=this._animDic[this.curentAction];return this._curentFrame>=e.matrixAry.length?e.matrixAry[0][t]:e.matrixAry[this._curentFrame][t]}return this._animDic[this._defaultAction]?(e=this._animDic[this._defaultAction]).matrixAry[this._curentFrame][t]:null},e.prototype.addAction=function(t,e,i){void 0===i&&(i=!1),this._preLoadActionDic[t]=e,(t==this._defaultAction||t==this.curentAction||i)&&this.setAnimUrl(t,e)},e.prototype.setAnimUrl=function(t,e){var i=this;this._waitLoadActionDic[t]=!0,Jt.getInstance().getAnimData(e,(function(e){i._animDic[t]=e,i.processAnimByMesh(e),i._waitLoadActionDic[t]=!1}))},e.prototype.play=function(t,e,i){if(void 0===e&&(e=0),this.curentAction!=t)return this.curentAction=t,this._completeState=e,this._actionTime=0,this.updateFrame(0),!!this._animDic.hasOwnProperty(t)||(!this._waitLoadActionDic[t]&&this._preLoadActionDic[t]&&this.setAnimUrl(t,this._preLoadActionDic[t]),!1)},e.prototype.processAnimByMesh=function(t){if(this._skinMesh&&!t.hasProcess){for(var e=0;e<t.matrixAry.length;e++)for(var i=t.matrixAry[e],a=0;a<i.length;a++)i[a].prepend(this._skinMesh.meshAry[0].bindPosMatrixAry[a]);t.hasProcess=!0}},e.prototype.update=function(){if(this._skinMesh){if(this.lightProbe&&(this.resultSHVec=Ie.getInstance().getData(new a(this.x,this.y+10,this.z))),this.updateBind(),this.meshVisible)for(var t=0;t<this._skinMesh.meshAry.length;t++)this.updateMaterialMesh(this._skinMesh.meshAry[t]);this.showCapsule&&this.updateShowCapsule()}},e.prototype.updateFrame=function(t){var e;if(this._actionTime+=t,this.curentAction&&this._animDic[this.curentAction])e=this.curentAction;else{if(!this._animDic[this._defaultAction])return;e=this._defaultAction}var i=this._animDic[e];this._curentFrame=o.float2int(this._actionTime/(2*r.frameTime)),this._curentFrame>=i.matrixAry.length&&(0==this._completeState?(this._actionTime=0,this._curentFrame=0):1==this._completeState?this._curentFrame=i.matrixAry.length-1:2==this._completeState?(this._curentFrame=0,this._completeState=0,this.changeAction(this.curentAction)):this._completeState)},e.prototype.changeAction=function(t){this.curentAction=this._defaultAction},e.prototype.destory=function(){for(var e in t.prototype.destory.call(this),this._skinMesh&&this._skinMesh.useNum--,this._partDic)for(var i=this._partDic[e],a=0;a<i.length;a++)(i[a]instanceof Mt||i[a]instanceof Gt)&&i[a].destory();this._partDic=null,this._hasDestory=!0},e.prototype.updateShowCapsule=function(){this.capsuleLineSprite?(this.capsuleLineSprite.x=this.x,this.capsuleLineSprite.y=this.y+this._capsule.radius,this.capsuleLineSprite.z=this.z,this.capsuleLineSprite.update()):(this.capsuleLineSprite=new be,this.capsuleLineSprite.clear(),this.capsuleLineSprite.baseColor=new a(1,0,0,1),this.drawCylinder(this._capsule.radius,this._capsule.height),this.drawBall(this._capsule.radius),this.capsuleLineSprite.upToGpu())},e.prototype.drawBall=function(t){var e,i,r,n,s,o,h,c=t;for(s=0;s<=12;s++)for(r=null,n=6;n<12;n++)e=new a(c,0,0),(i=new d).appendRotation(30*n,a.Z_AXIS),e=i.transformVector(e),(o=new d).appendRotation(30*s,a.Y_AXIS),e=o.transformVector(e),r&&this.capsuleLineSprite.makeLineMode(r,e),r=e.clone();for(s=1;s<=4;s++)for((o=new d).appendRotation(-20*s,a.Z_AXIS),h=o.transformVector(new a(c,0,0)),r=null,n=0;n<12;n++)e=h.clone(),(i=new d).appendRotation(30*n,a.Y_AXIS),e=i.transformVector(e),r&&this.capsuleLineSprite.makeLineMode(r,e),11==n&&this.capsuleLineSprite.makeLineMode(h,e),r=e.clone()},e.prototype.drawCylinder=function(t,e){var i,r,n,s=t,o=e;for(n=0;n<12;n++){var h=new a(s,0,0),c=new a(s,+o,0),l=new d;l.appendRotation(30*n,a.Y_AXIS);var u=l.transformVector(h),p=l.transformVector(c);this.capsuleLineSprite.makeLineMode(u,p),this.capsuleLineSprite.makeLineMode(p,new a(0,+o,0)),11==n&&(this.capsuleLineSprite.makeLineMode(u,h),this.capsuleLineSprite.makeLineMode(p,c)),(i||r)&&(this.capsuleLineSprite.makeLineMode(u,i),this.capsuleLineSprite.makeLineMode(p,r)),i=u.clone(),r=p.clone()}},e.prototype.setVcMatrix=function(t){r.context3D.setVpMatrix(t.material.shader,r.vpMatrix.m),r.context3D.setVcMatrix4fv(t.material.shader,"posMatrix3D",this.posMatrix.m)},e.prototype.setVa=function(t){t.compressBuffer?this.setVaCompress(t):this.setVaIndependent(t)},e.prototype.setVaIndependent=function(t){r.context3D.setVa(0,3,t.vertexBuffer),r.context3D.setVa(1,2,t.uvBuffer),r.context3D.setVa(2,4,t.boneIdBuffer),r.context3D.setVa(3,4,t.boneWeightBuffer),t.material.usePbr?(r.context3D.setVa(4,4,t.normalsBuffer),r.context3D.setVcMatrix4fv(t.material.shader,"rotationMatrix3D",this._rotationMatrix.m),t.material.useNormal&&(r.context3D.setVa(5,4,t.tangentBuffer),r.context3D.setVa(6,4,t.bitangentBuffer))):(t.material.lightProbe||t.material.directLight)&&(r.context3D.setVa(4,4,t.normalsBuffer),r.context3D.setVcMatrix4fv(t.material.shader,"rotationMatrix3D",this._rotationMatrix.m))},e.prototype.setVaCompress=function(t){r.context3D.pushVa(t.vertexBuffer)||(r.context3D.setVaOffset(0,3,t.stride,0),r.context3D.setVaOffset(1,2,t.stride,t.uvsOffsets),r.context3D.setVaOffset(2,4,t.stride,t.boneIDOffsets),r.context3D.setVaOffset(3,4,t.stride,t.boneWeightOffsets),t.material.usePbr?(r.context3D.setVaOffset(4,3,t.stride,t.normalsOffsets),r.context3D.setVcMatrix4fv(t.material.shader,"rotationMatrix3D",this._rotationMatrix.m),t.material.useNormal&&(r.context3D.setVaOffset(5,3,t.stride,t.tangentsOffsets),r.context3D.setVaOffset(6,3,t.stride,t.bitangentsOffsets))):(t.material.lightProbe||t.material.directLight)&&(r.context3D.setVaOffset(4,3,t.stride,t.normalsOffsets),r.context3D.setVcMatrix4fv(t.material.shader,"rotationMatrix3D",this._rotationMatrix.m)))},e.prototype.clearVa=function(){r.context3D.clearVa(2),r.context3D.clearVa(3),r.context3D.clearVa(4),r.context3D.clearVa(5),r.context3D.clearVa(6)},e.prototype.updateMaterialMesh=function(t){t.material&&(r.context3D.setProgram(t.material.program),r.context3D.cullFaceBack(!1),r.context3D.setBlendParticleFactors(t.material.blendMode),this.setVcMatrix(t),this.setMaterialVc(t.material,t.materialParam),this.setMaterialTexture(t.material,t.materialParam),this.setVa(t),this.setDirectLight(t.material),this.setMeshVc(t),r.context3D.drawCall(t.indexBuffer,t.treNum))},e.prototype.setLightProbeVc=function(t){if(t.lightProbe)for(var e=0;e<this.resultSHVec.length;e++)r.context3D.setVc3fv(t.shader,"sh["+e+"]",[this.resultSHVec[e].x,this.resultSHVec[e].y,this.resultSHVec[e].z])},e.prototype.setMeshVc=function(t){var e;if(this._animDic[this.curentAction])e=this._animDic[this.curentAction];else{if(!this._animDic[this._defaultAction])return;e=this._animDic[this._defaultAction]}var i=e.getBoneQPAryByMesh(t)[t.uid][this._curentFrame];i&&(r.context3D.setVc4fv(t.material.shader,"boneQ",i.quat),r.context3D.setVc3fv(t.material.shader,"boneD",i.pos))},e.prototype.setPos=function(e){t.prototype.setPos.call(this,e),this._shadow&&(this._shadow.x=e.x,this._shadow.y=e.y+8,this._shadow.z=e.z)},Object.defineProperty(e.prototype,"x",{get:function(){return this._x},set:function(t){this._x=t,this.updateMatrix(),this._shadow&&(this._shadow.x=t),this.changePos()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._y},set:function(t){this._y=t,this.updateMatrix(),this._shadow&&(this._shadow.y=t),this.changePos()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this._z},set:function(t){this._z=t,this.updateMatrix(),this._shadow&&(this._shadow.z=t),this.changePos()},enumerable:!1,configurable:!0}),e.prototype.changePos=function(){},e}(Gt),Ge=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.addToRender=function(){t.prototype.addToRender.call(this),this.particle.addEventListener(U.COMPLETE,this.onPlayCom,this)},e.prototype.onPlayCom=function(t){this.particle.removeEventListener(U.COMPLETE,this.onPlayCom,this),Ut.getInstance().removeParticle(this.particle),this.removeCallFun(this)},e}(ze),Ze=function(){function t(){}return t.prototype.getSocket=function(t,e){this.bindMatrix.clone(e)},t.prototype.getSunType=function(){return 1},t}(),He=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.setInfo=function(e){t.prototype.setInfo.call(this,e);var i=e;this.pos=i.pos,this.rotation=i.rotation,this.hasSocket=i.hasSocket,this.socket=i.socket},e.prototype.addToRender=function(){if(t.prototype.addToRender.call(this),this.outPos)this.particle.x=this.outPos.x,this.particle.y=this.outPos.y,this.particle.z=this.outPos.z,this.particle.rotationX=this.rotation.x,this.particle.rotationY=this.rotation.y+this.active.rotationY,this.particle.rotationZ=this.rotation.z,this.particle.bindTarget=null;else if(this.hasSocket){var e=this.active;this.particle.bindTarget=e,this.particle.bindSocket=this.socket}else{var i=new d;i.appendRotation(this.active.rotationY,a.Y_AXIS);var r=i.transformVector(this.pos);r.x+=this.active.x,r.y+=this.active.y,r.z+=this.active.z;var n=new Ze;n.bindMatrix=new d,n.bindMatrix.appendRotation(this.rotation.x,a.X_AXIS),n.bindMatrix.appendRotation(this.rotation.y,a.Y_AXIS),n.bindMatrix.appendRotation(this.rotation.z,a.Z_AXIS),n.bindMatrix.appendRotation(this.active.rotationY,a.Y_AXIS),n.bindMatrix.appendTranslation(r.x,r.y,r.z),this.particle.bindTarget=n}},e}(Ge),qe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.update=function(t){this.pathMul.update(t)},e.prototype.getSunType=function(){return 1},e.prototype.addToRender=function(){if(this.particle){if(this.particle.reset(),Ut.getInstance().addParticle(this.particle),this.currentPosList)for(t=0;t<this.activeList.length;t++)this.currentPosList[t].setTo(this.activeList[t].x,this.activeList[t].y+10,this.activeList[t].z+5),this.currentPosList[t].w=0;else{this.currentPosList=new Array;for(var t=0;t<this.activeList.length;t++)this.currentPosList.push(new a(this.activeList[t].x,this.activeList[t].y+10,this.activeList[t].z+5));this.pathMul.setInitCurrentPos(this.currentPosList)}this.pathMul.add(),this.particle.setMulPos(this.pathMul.resultAry)}},e.prototype.setMulPlayData=function(t,e,i,a){var r=this;void 0===a&&(a=0),this.activeList=t,this.active=this.activeList[0],this.target=e,this.removeCallFun=i,this._currentPos.setTo(0,0,0),this.rotationMatrix.identity(),this._socketMaxrix.identity(),this._currentTargetPos.setTo(0,0,0),this.pathMul||(this.pathMul=Ee.getNewPath(a),this.pathMul.setData(this,(function(){r.reset()}),this._currentPos,this.rotationMatrix,this._currentTargetPos),this.pathMul.speed=this.data.speed),this.pathMul.reset()},e.prototype.getMulSocket=function(t){t&&this.pathMul.applyData(t)},e}(Ve),Ke=function(){function t(){this.init=!1,this._volume=1,this._skillSoundDic=new Object,this._skillVolume=1}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.playSound=function(){this.initSound(),this.audio.play()},t.prototype.initSound=function(){this.init||(this.audio=new Audio(r.fileRoot+"sound/sound_3521.mp3"),this.audio.loop=!0,this.audio.volume=this._volume,this.audio.play(),this.init=!0)},t.prototype.stopSound=function(){this.audio&&this.audio.pause()},t.prototype.setVolume=function(t){this._volume=t,this._volume>0?this.playSound():this.stopSound(),this.audio&&(this.audio.volume=this._volume)},t.prototype.setSkillVolume=function(t){for(var e in this._skillVolume=t,this._skillSoundDic)this._skillSoundDic[e].volume=this._skillVolume},t.prototype.playSkillSound=function(t){if(!(this._skillVolume<=0))if(this._skillSoundDic[t])this._skillSoundDic[t].play();else{var e=new Audio(r.fileRoot+"skill/sound/"+t);e.loop=!1,e.volume=this._skillVolume,e.play(),this._skillSoundDic[t]=e}},t}(),Qe=function(t){function e(){var e=t.call(this)||this;return e.isDeath=!0,e.src=!1,e.time=0,e.targetFlag=0,e.targetShockFlag=0,e.needSound=!1,e.hasDestory=!1,e.actionEnd=!1,e}return i(e,t),e.prototype.setData=function(t,e){this.hasDestory||(this.skillVo=new ce,this.skillVo.setData(t),this.setKeyAry(),this.trajectoryAry=new Array,this._skillData=e)},e.prototype.getBloodTime=function(){return this.skillVo?this.skillVo.bloodTime:ce.defaultBloodTime},e.prototype.play=function(){this.skillVo?this.active&&this.active instanceof Ye&&this.active.play(this.skillVo.action,this.actionEnd?1:2,!1):this.skillComplete()},e.prototype.setKeyAry=function(){var t=this;if(this.keyAry=new Array,this.skillVo.types==le.FixEffect)for(var e=0;e<this.skillVo.keyAry.length;e++){var i=new He;i.setInfo(this.skillVo.keyAry[e]),i.removeCallFun=function(e){t.removeKey(e)},i.active=this.active,this.keyAry.push(i)}else if(this.skillVo.types==le.TrajectoryDynamicTarget||this.skillVo.types==le.TrajectoryDynamicPoint)for(e=0;e<this.skillVo.keyAry.length;e++){var a;(a=1==this.skillVo.keyAry[e].multype?new qe:new Ve).setInfo(this.skillVo.keyAry[e]),this.keyAry.push(a)}},e.prototype.removeKey=function(t){this.completeNum++,this.completeNum==this.keyAry.length&&this.skillComplete()},e.prototype.removeSkillForce=function(){if(this.keyAry)for(var t=0;t<this.keyAry.length;t++)this.keyAry[t].reset();this.skillComplete(),this.reset()},e.prototype.skillComplete=function(){$e.getInstance().removeSkill(this),this.isDeath=!0,this.completeFun&&this.completeFun(),this.idleTime=0},e.prototype.reset=function(){this.time=0,this.completeNum=0,this.active=null,this.completeFun=null,this.targetFlag=0,this.targetShockFlag=0,this.soundPlay=!1,this.needSound=!1},e.prototype.update=function(t){this.time+=t,this.time>e.MaxTime&&this.skillComplete(),this.getKeyTarget(),this.getShockTarget(),this.updateTrajector(t)},e.prototype.updateTrajector=function(t){for(var e=0;e<this.trajectoryAry.length;e++)this.trajectoryAry[e].update(t)},e.prototype.getKeyTarget=function(){if(this.keyAry){for(var t=this.targetFlag;t<this.keyAry.length&&this.keyAry[t].time<this.time;t++){if(this.keyAry[t].addToRender(),this.skillVo.types==le.TrajectoryDynamicTarget||this.skillVo.types==le.TrajectoryDynamicPoint){var e=this.keyAry[t];this.trajectoryAry.push(e)}t++,this.targetFlag=t}this.getSound()}},e.prototype.getShockTarget=function(){if(this.skillVo.shockAry&&this.needSound)for(var t=this.targetShockFlag;t<this.skillVo.shockAry.length&&this.skillVo.shockAry[t].time<this.time;t++)ti.getInstance().shock(this.skillVo.shockAry[t].lasttime,this.skillVo.shockAry[t].amp),t++,this.targetShockFlag=t},e.prototype.getSound=function(){this.skillVo.sound&&!this.soundPlay&&this.needSound&&this.skillVo.sound.frame<this.time&&(Ke.getInstance().playSkillSound(this.skillVo.sound.url),this.soundPlay=!0)},e.prototype.configFixEffect=function(t,e,i){if(void 0===e&&(e=null),void 0===i&&(i=null),this.active=t,this.completeFun=e,this.keyAry)for(var a=0;a<this.keyAry.length;a++)if(this.skillVo.types==le.FixEffect){var r=this.keyAry[a];r.active=t,i&&i.length?a>i.length-1?r.outPos=i[i.length-1]:r.outPos=i[a]:r.outPos=null}},e.prototype.configTrajectory=function(t,e,i,a,r){var n=this;if(void 0===i&&(i=null),void 0===a&&(a=0),void 0===r&&(r=null),this.active=t,this.completeFun=i,this.completeNum=0,this.keyAry)for(var s=0;s<this.keyAry.length;s++){if(this.skillVo.types==le.TrajectoryDynamicTarget||this.skillVo.types==le.TrajectoryDynamicPoint)this.keyAry[s].setPlayData(t,e,(function(t){n.removeTrajectory(t)}),a,0==s?r:null)}},e.prototype.configMulTrajectory=function(t,e,i,a){var r=this;if(void 0===a&&(a=null),this.active=e,this.completeFun=a,this.completeNum=0,this.keyAry)for(var n=0;n<this.keyAry.length;n++){if(this.skillVo.types==le.TrajectoryDynamicTarget)this.keyAry[n].setMulPlayData(t,i,(function(t){r.removeTrajectory(t)}),2)}},e.prototype.removeTrajectory=function(t){var e=this.trajectoryAry.indexOf(t);-1!=e&&this.trajectoryAry.splice(e,1),this.completeNum++,this.completeNum==this.keyAry.length&&this.skillComplete()},e.prototype.destory=function(){if(this.skillVo=null,this.name=null,this.keyAry){for(var t=0;t<this.keyAry.length;t++)this.keyAry[t].destory();this.keyAry.length=0,this.keyAry=null}if(this.active=null,this.completeFun=null,this.trajectoryAry){for(t=0;t<this.trajectoryAry.length;t++)this.trajectoryAry[t].destory();this.trajectoryAry.length=0,this.trajectoryAry=null}this._skillData&&this._skillData.useNum--,this._skillData=null,this.hasDestory=!0},e.MaxTime=5e3,e}(x),Je=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.srcList=new Array,e}return i(e,t),e.prototype.addSrcSkill=function(t){this.srcList.push(t)},e.prototype.destory=function(){for(var t=0;t<this.srcList.length;t++)this.srcList[t].destory(),$e.getInstance().gcSkill(this.srcList[t])},e.prototype.testDestory=function(){for(var t=0;t<this.srcList.length;t++)if(!(this.srcList[t].isDeath&&this.srcList[t].idleTime>=x.GCTime))return!1;return!0},e}(x),$e=function(t){function e(){var e=t.call(this)||this;return e._time=0,e._skillDic=new Object,e._loadDic=new Object,e._skillAry=new Array,e._preLoadDic=new Object,e}return i(e,t),e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.update=function(){for(var t=h.getTimer(),e=t-this._time,i=0;i<this._skillAry.length;i++)this._skillAry[i].update(e);this._time=t},e.prototype.preLoadSkill=function(t){var e=this;this._dic[t]||this._preLoadDic[t]||(ye.getInstance().loadSkillRes(r.fileRoot+t,(function(i){var a=new Je;a.data=i.data,a.useNum++,e._dic[t]=a,e.addSrc(t,a)})),this._preLoadDic[t]=!0)},e.prototype.getSkill=function(t,e,i){var a,n=this;void 0===i&&(i=null);var s,o=t+e,h=this._skillDic[o];if(h)for(var c=0;c<h.length;c++)if((a=h[c]).isDeath&&0==a.useNum)return a.reset(),a.isDeath=!1,a;return(a=new Qe).name=e,a.isDeath=!1,this._skillDic[o]||(this._skillDic[o]=new Array),this._skillDic[o].push(a),this._dic[t]?(a.setData(this._dic[t].data[a.name],this._dic[t]),a.key=o,this._dic[t].useNum++,a):this._loadDic[t]?((s=new Object).name=e,s.skill=a,s.callback=i,this._loadDic[t].push(s),a):(this._loadDic[t]=new Array,(s=new Object).name=e,s.skill=a,s.callback=i,this._loadDic[t].push(s),ye.getInstance().loadSkillRes(r.fileRoot+t,(function(e){n.loadSkillCom(t,e)})),a)},e.prototype.loadSkillCom=function(t,e){var i=new Je;i.data=e.data;for(var a=0;a<this._loadDic[t].length;a++){(r=this._loadDic[t][a]).skill.hasDestory||(r.skill.setData(i.data[r.name],i),r.skill.key=t+r.name,i.useNum++)}this._dic[t]=i,this.addSrc(t,i);for(a=0;a<this._loadDic[t].length;a++){var r;(r=this._loadDic[t][a]).callback&&r.callback()}this._loadDic[t].length=0,this._loadDic[t]=null},e.prototype.addSrc=function(t,e){for(var i in e.data){var a=new Qe;a.name=i,a.isDeath=!0,a.src=!0,a.setData(e.data[i],e),e.addSrcSkill(a);var r=t+i;this._skillDic[r]||(this._skillDic[r]=new Array),this._skillDic[r].push(a)}},e.prototype.playSkill=function(t){this._skillAry.push(t),t.play()},e.prototype.removeSkill=function(t){var e=this._skillAry.indexOf(t);-1!=e&&this._skillAry.splice(e,1)},e.prototype.gcSkill=function(t){for(var e in this._skillDic){var i=this._skillDic[e],a=i.indexOf(t);-1!=a&&i.splice(a,1)}},e.prototype.gc=function(){for(var t in this._dic){var e=this._dic[t];e.useNum<=0&&(e.idleTime++,e.idleTime>=x.GCTime&&e.testDestory()&&(e.destory(),delete this._dic[t]))}for(var t in this._skillDic){for(var i=this._skillDic[t],a=i.length-1;a>=0;a--)i[a].isDeath&&i[a].useNum<=0&&(i[a].idleTime++,i[a].idleTime>=x.GCTime&&(i[a].src||(i[a].destory(),i.splice(a,1))));0==i.length&&delete this._skillDic[t]}},e}(b),ti=function(){function t(){var t=this;this.upFun=function(e){t.update(e)}}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.update=function(t){if(this.ctime+=t,this.ctime>this.time)return h.removeFrameTick(this.upFun),void r.cam3D.offset.setTo(0,0,0);var e=(Math.random()-.5)*this.amp,i=(Math.random()-.5)*this.amp,a=(Math.random()-.5)*this.amp;r.cam3D.offset.setTo(e,i,a)},t.prototype.shock=function(t,e){this.time=t,this.ctime=0,this.amp=e,h.addFrameTick(this.upFun)},t}(),ei=function(t){function e(){return t.call(this)||this}return i(e,t),e.initConfig=function(){Re._instance=new e},e.prototype.update=function(){_e.getCamView(r.cam3D,r.focus3D),r.context3D._contextSetTest.clear(),isNaN(this._time)&&(this._time=h.getTimer()),this.updateMovieFrame(),this._ready&&(Ut.getInstance().updateTime(),$e.getInstance().update(),this.render&&(r.context3D.cullFaceBack(!1),r.context3D.cullFaceBack(!0),r.context3D.cullFaceBack(!0),r.context3D.setWriteDepth(!0),r.context3D.setDepthTest(!0),this.updateStaticDiplay(),this.updateSpriteDisplay(),this.updateMovieDisplay(),r.context3D.setWriteDepth(!1),Ut.getInstance().update(),r.context3D.setBlendParticleFactors(0),r.context3D.setWriteDepth(!0)),r.context3D.setDepthTest(!1))},e}(Re),ii=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.getParticleByte=function(t){t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt");var e=new Mt,i=t;if(Ut.getInstance()._dic[i]){var a=Ut.getInstance()._dic[i];e=a.getCombineParticle()}else w.getInstance().load(i,w.BYTE_TYPE,(function(t){var i=new s(t);e.setDataByte(i)}));return e.url=i,e},e.prototype.registerUrl=function(t){(t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),Ut.getInstance()._dic[t])&&Ut.getInstance()._dic[t].useNum++},e.prototype.releaseUrl=function(t){(t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),Ut.getInstance()._dic[t])&&Ut.getInstance()._dic[t].clearUseNum()},e.prototype.addResByte=function(t,e){if(!Ut.getInstance()._dic[t]){var i=new kt;i.setDataByte(e),Ut.getInstance()._dic[t]=i}},e}(Ut),ai=function(t){function e(e){var i=t.call(this)||this;return i.skill=e,i}return i(e,t),e.prototype.onPlayCom=function(t){this.particle.removeEventListener(U.COMPLETE,this.onPlayCom,this),this.skill.skillManager.sceneManager.particleManager.removeParticle(this.particle),this.removeCallFun(this)},e.prototype.addToRender=function(){if(this.particle)if(this.particle.reset(),this.particle.sceneVisible=!0,this.skill.skillManager.sceneManager.particleManager.addParticle(this.particle),this.particle.addEventListener(U.COMPLETE,this.onPlayCom,this),this.outPos)this.particle.x=this.outPos.x,this.particle.y=this.outPos.y,this.particle.z=this.outPos.z,this.particle.rotationX=this.rotation.x,this.particle.rotationY=this.rotation.y+this.active.rotationY,this.particle.rotationZ=this.rotation.z,this.particle.bindTarget=null;else if(this.hasSocket){var t=this.active;this.particle.bindTarget=t,this.particle.bindSocket=this.socket}else{var e=new d;e.appendRotation(this.active.rotationY,a.Y_AXIS);var i=e.transformVector(this.pos);i.x+=this.active.x,i.y+=this.active.y,i.z+=this.active.z;var r=new Ze;r.bindMatrix=new d,r.bindMatrix.appendRotation(this.rotation.x,a.X_AXIS),r.bindMatrix.appendRotation(this.rotation.y,a.Y_AXIS),r.bindMatrix.appendRotation(this.rotation.z,a.Z_AXIS),r.bindMatrix.appendRotation(this.active.rotationY,a.Y_AXIS),r.bindMatrix.appendTranslation(i.x,i.y,i.z),this.particle.bindTarget=r}},e}(He),ri=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.reset=function(){this.particle.reset(),this.skill.skillManager.sceneManager.particleManager.removeParticle(this.particle),this.endParticle&&(this.endParticle.reset(),this.skill.skillManager.sceneManager.particleManager.addParticle(this.endParticle),this.endParticle.setPos(this._currentTargetPos.x,this._currentTargetPos.y,this._currentTargetPos.z)),this.removeCallFun&&this.removeCallFun(this)},e.prototype.addToRender=function(){if(this.particle){var t;if(this.particle.reset(),this.particle.sceneVisible=!0,this.skill.skillManager.sceneManager.particleManager.addParticle(this.particle),0==this.data.beginType){var e=new d;e.appendRotation(this.active.rotationY,a.Y_AXIS),t=e.transformVector(this.data.beginPos),this._currentPos.setTo(this.active.x+t.x,this.active.y+t.y,this.active.z+t.z)}else if(1==this.data.beginType){var i=new d;this.active.getSocket(this.data.beginSocket,i),t=i.position,this._currentPos.setTo(t.x,t.y,t.z)}this.particle.setPos(this._currentPos.x,this._currentPos.y,this._currentPos.z),this.path.add()}},e.prototype.endPlayFun=function(t){this.skill.skillManager.sceneManager.particleManager.removeParticle(this.endParticle),this.endParticle.removeEventListener(U.COMPLETE,this.endPlayFun,this)},e.prototype.setInfo=function(t){this.time=t.frame*r.frameTime,this.particle=this.skill.skillManager.sceneManager.particleManager.getParticleByte(r.fileRoot+t.url),this.particle.bindTarget=this,this.data=t,this.data.endParticleUrl&&(this.endParticle=this.skill.skillManager.sceneManager.particleManager.getParticleByte(r.fileRoot+this.data.endParticleUrl),this.endParticle.addEventListener(U.COMPLETE,this.endPlayFun,this))},e}(Ve),ni=function(t){function e(e){void 0===e&&(e=null);var i=t.call(this)||this;return i.baseName="OverrideSkill",i.skillManager=e,i}return i(e,t),e.prototype.skillComplete=function(){this.skillManager.removeSkill(this),this.isDeath=!0,this.completeFun&&this.completeFun(),this.idleTime=0},e.prototype.setData=function(t,e){this.hasDestory||(this.skillVo=new ce,this.skillVo.setData(t),this.setKeyAry(),this.trajectoryAry=new Array,this._skillData=e)},e.prototype.setKeyAry=function(){var t=this;if(this.keyAry=new Array,this.skillVo.types==le.FixEffect)for(var e=0;e<this.skillVo.keyAry.length;e++){var i=new ai(this);i.setInfo(this.skillVo.keyAry[e]),i.removeCallFun=function(e){t.removeKey(e)},i.active=this.active,this.keyAry.push(i)}else if(this.skillVo.types==le.TrajectoryDynamicTarget||this.skillVo.types==le.TrajectoryDynamicPoint)for(e=0;e<this.skillVo.keyAry.length;e++){var a;1==this.skillVo.keyAry[e].multype||((a=new ri).skill=this),a.setInfo(this.skillVo.keyAry[e]),this.keyAry.push(a)}},e}(Qe),si=function(t){function e(e){var i=t.call(this)||this;return i.sceneManager=e,i}return i(e,t),e.prototype.addSrc=function(t,e){for(var i in e.data){var a=new ni(this);a.name=i,a.isDeath=!0,a.src=!0,a.setData(e.data[i],e),e.addSrcSkill(a),$e.getInstance();var r=t+i;$e.getInstance()._skillDic[r]||($e.getInstance()._skillDic[r]=new Array),$e.getInstance()._skillDic[r].push(a)}},e.prototype.playSkill=function(e){e.skillManager=this,t.prototype.playSkill.call(this,e)},e.prototype.getSkill=function(t,e,i){var a,n=this;void 0===i&&(i=null);var s,o=t+e,h=$e.getInstance()._skillDic[o];if(h)for(var c=0;c<h.length;c++)if((a=h[c]).isDeath&&0==a.useNum)return a.reset(),a.isDeath=!1,a;return(a=new ni(this)).name=e,a.isDeath=!1,$e.getInstance()._skillDic[o]||($e.getInstance()._skillDic[o]=new Array),$e.getInstance()._skillDic[o].push(a),this._dic[t]?(a.setData(this._dic[t].data[a.name],this._dic[t]),a.key=o,this._dic[t].useNum++,a):$e.getInstance()._loadDic[t]?((s=new Object).name=e,s.skill=a,s.callback=i,$e.getInstance()._loadDic[t].push(s),a):($e.getInstance()._loadDic[t]=new Array,(s=new Object).name=e,s.skill=a,s.callback=i,$e.getInstance()._loadDic[t].push(s),ye.getInstance().loadSkillRes(r.fileRoot+t,(function(e){n.loadSkillCom(t,e)})),a)},e.prototype.loadSkillCom=function(t,e){var i=new Je;i.data=e.data;for(var a=0;a<$e.getInstance()._loadDic[t].length;a++){(r=$e.getInstance()._loadDic[t][a]).skill.hasDestory||(r.skill.setData(i.data[r.name],i),r.skill.key=t+r.name,i.useNum++)}this._dic[t]=i,this.addSrc(t,i);for(a=0;a<$e.getInstance()._loadDic[t].length;a++){var r;(r=$e.getInstance()._loadDic[t][a]).callback&&r.callback()}$e.getInstance()._loadDic[t].length=0,$e.getInstance()._loadDic[t]=null},e}($e),oi=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.readParticle=function(){for(var t=this._byte.readInt(),e=(h.getTimer(),0);e<t;e++){var i=r.fileRoot+this._byte.readUTF(),a=this._byte.readInt(),n=new s;n.length=a,this._byte.readBytes(n,0,a),this.scene.particleManager.addResByte(i,n)}},e}(je),hi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.getGroupData=function(t,e){var i=this;if(this._dic[t]){var a=this._dic[t];return a.useNum++,void e(a)}if(this._loadDic[t])this._loadDic[t].push(e);else{this._loadDic[t]=new Array,this._loadDic[t].push(e);var r=new oi;r.scene=this.scene,r.load(t,(function(){for(var e=i._loadDic[t],a=0;a<e.length;a++){(0,e[a])(r)}i._dic[t]=r,delete i._loadDic[t],r.initReg()}))}},e}(We),ci=function(t){function e(){var i=t.call(this)||this;return i.particleManager=new ii,i.skillManager=new si(i),i.groupDataManager=new hi,console.log("创建场景=>",e.sceneNum++),i}return i(e,t),e.initConfig=function(){Re._instance=new e},e.prototype.update=function(){_e.getCamView(r.cam3D,r.focus3D),this.upFrame()},e.prototype.addMovieDisplay=function(t){t._scene=this,this._displayRoleList.push(t),t.addStage()},e.prototype.loadSceneConfigCom=function(e){var i=r.focus3D.rotationY;t.prototype.loadSceneConfigCom.call(this,e),r.focus3D.rotationY=i},e.prototype.playLyf=function(t,e,i){var a=this;void 0===i&&(i=0),this.groupDataManager.scene=this,this.groupDataManager.getGroupData(r.fileRoot+t,(function(t){for(var n=0;n<t.dataAry.length;n++){var s=t.dataAry[n];if(s.types==Ot.SCENE_PARTICLE_TYPE){var o=a.particleManager.getParticleByte(r.fileRoot+s.particleUrl);o.x=e.x,o.y=e.y,o.z=e.z,o.rotationY=i,a.particleManager.addParticle(o),o.addEventListener(U.COMPLETE,a.onPlayCom,a)}else console.log("播放的不是单纯特效")}}))},e.prototype.onPlayCom=function(t){this.particleManager.removeParticle(t.target)},e.prototype.upFrame=function(){r.context3D._contextSetTest.clear(),isNaN(this._time)&&(this._time=h.getTimer()),this.updateMovieFrame(),this._ready&&(this.particleManager.updateTime(),this.skillManager.update(),this.render&&(r.context3D.setWriteDepth(!0),r.context3D.setDepthTest(!0),this.updateStaticDiplay(),this.updateSpriteDisplay(),this.updateMovieDisplay(),Oe.getInstance().update(),r.context3D.setWriteDepth(!1),this.particleManager.update(),r.context3D.setBlendParticleFactors(0),r.context3D.setWriteDepth(!0),r.context3D.setWriteDepth(!1)),r.context3D.setDepthTest(!1),this.cameraMatrix=r.cam3D.cameraMatrix.clone(),this.viewMatrx3D=r.viewMatrx3D)},e.sceneNum=0,e}(ei),li=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(re),ui=function(){function t(){this.sunDirect=new Array(0,1,0),this.sunColor=new Array(2,0,0),this.ambientColor=new Array(0,0,0)}return t.prototype.setData=function(t,e,i){this.sunDirect[0]=t.x,this.sunDirect[1]=t.y,this.sunDirect[2]=t.z,this.sunColor[0]=e.x,this.sunColor[1]=e.y,this.sunColor[2]=e.z,this.ambientColor[0]=i.x,this.ambientColor[1]=i.y,this.ambientColor[2]=i.z},t}(),pi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.load=function(t,e){var i=this;this._fun=e,w.getInstance().load(t,w.BYTE_TYPE,(function(t){i.loadComplete(t)}))},e.prototype.loadComplete=function(t){var e=this;this._byte=new s(t),this._byte.position=0,this.read((function(){e.readNexte()}))},e.prototype.readNexte=function(){this.read(),this.read(),this.objUrl=this._byte.readUTF(),this.materialUrl=this._byte.readUTF(),this._byte.readBoolean()&&(this.light=new ui,this.light.ambientColor[0]=this._byte.readFloat(),this.light.ambientColor[1]=this._byte.readFloat(),this.light.ambientColor[2]=this._byte.readFloat(),this.light.sunColor[0]=this._byte.readFloat(),this.light.sunColor[1]=this._byte.readFloat(),this.light.sunColor[2]=this._byte.readFloat(),this.light.sunDirect[0]=this._byte.readFloat(),this.light.sunDirect[1]=this._byte.readFloat(),this.light.sunDirect[2]=this._byte.readFloat()),this._fun()},e}(Ot),di=laya.webgl.WebGLContext,fi=function(){function t(){}return t.overrideMethods=function(){if(!this.inited){this.inited=!0;var t=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var a=r.context3D.renderContext,n=a.getParameter(Laya.WebGLContext.ARRAY_BUFFER_BINDING),s=a.getParameter(Laya.WebGLContext.ELEMENT_ARRAY_BUFFER_BINDING),o=t.apply(this,e);return a.bindBuffer(Laya.WebGLContext.ARRAY_BUFFER,n),a.bindBuffer(Laya.WebGLContext.ELEMENT_ARRAY_BUFFER,s),o},e=Nt.prototype.setAllByteInfo;Nt.prototype.setAllByteInfo=function(i){return t.call(this,e,i)};var i=ot.prototype.setAllByteInfo;ot.prototype.setAllByteInfo=function(e){return t.call(this,i,e)};var a=At.prototype.setAllByteInfo;At.prototype.setAllByteInfo=function(e){return t.call(this,a,e)};var n=It.prototype.setAllByteInfo;It.prototype.setAllByteInfo=function(e){return t.call(this,n,e)};var s=yt.prototype.setAllByteInfo;yt.prototype.setAllByteInfo=function(e){return t.call(this,s,e)};var o=vt.prototype.setAllByteInfo;vt.prototype.setAllByteInfo=function(e){return t.call(this,o,e)};var h=_t.prototype.setAllByteInfo;_t.prototype.setAllByteInfo=function(e){return t.call(this,h,e)};var c=pt.prototype.regShader;pt.prototype.regShader=function(){return t.call(this,c)};var l=ae.prototype.readData;ae.prototype.readData=function(e,i,a,r){return t.call(this,l,e,i,a,r)};var u=Wt.prototype.loadObjCom;Wt.prototype.loadObjCom=function(e,i){return t.call(this,u,e,i)};var p=ue.prototype.loadComplete;ue.prototype.loadComplete=function(e){t.call(this,p,e)};var d=re.prototype.loadComplete;re.prototype.loadComplete=function(e){t.call(this,d,e)};var f=li.prototype.loadComplete;li.prototype.loadComplete=function(e){t.call(this,f,e)};var y=pi.prototype.loadComplete;pi.prototype.loadComplete=function(e){t.call(this,y,e)};var m=je.prototype.loadComplete;je.prototype.loadComplete=function(e){t.call(this,m,e)};var v=ke.prototype.applyObjData;ke.prototype.applyObjData=function(){t.call(this,v)}}},t.inited=!1,t}(),yi=function(t){function e(){var i=t.call(this)||this;return i._layaRenderIndex=-1,e.add(i),i.initData(),i}return i(e,t),e.add=function(t){e._list.push(t);var i=Laya.Render.context;i.submitElement=function(t,a){var r=i._submits,n=r._length;if(a<0&&(a=r._length),t==a)e.forEach((function(t,e){t.testRenderPan3d(-1)}));else for(;t<a;){var s=r[t];t+=s.renderSubmit(),e.forEach((function(e,i){e.testRenderPan3d(t)}))}return n}},e.forEach=function(t){for(var e=0,i=this._list;e<i.length;e++){var a=i[e];t.call(null,a,0)}},e.prototype.testRenderPan3d=function(t){this._layaRenderIndex<0||0!=t&&t!=this._layaRenderIndex||(this._layaRenderIndex=-1,e.saveLayaWebGLContext(),this.upFrame(),r.context3D.setWriteDepth(!1),r.context3D.setDepthTest(!1),e.revertLayaWebGLContext(),Laya.Submit.preRender=null)},e.prototype.initData=function(){fi.overrideMethods(),this.init(null),this.tscene=new ci,this.tscene.ready=!0},e.prototype.init=function(t,e,i){var a=this;this.frameLoop(1,this,(function(){a.graphics.clear(),a.graphics.drawLine(0,0,1,0,"#000")})),this.customRenderEnable=!0,this.customRender=function(t,e,i){var r=t;a._layaRenderIndex=r._submits._length}},e.prototype.upFrame=function(){},e.saveLayaWebGLContext=function(){var t=laya.webgl.WebGL.mainContext;di._depthTest=Boolean(t.isEnabled(di.DEPTH_TEST)),di._depthMask=t.getParameter(di.DEPTH_WRITEMASK),di._depthFunc=t.getParameter(di.DEPTH_FUNC),di._blend=Boolean(t.isEnabled(di.BLEND)),di._sFactor=t.getParameter(di.BLEND_SRC_RGB),di._dFactor=t.getParameter(di.BLEND_DST_RGB),di._cullFace=Boolean(t.isEnabled(di.CULL_FACE)),di._cullFaceMode=t.getParameter(di.CULL_FACE_MODE),di._arrayBuffer=t.getParameter(di.ARRAY_BUFFER_BINDING),di._arrayBuffer&&t.bindBuffer(di.ARRAY_BUFFER,null),di._elementArrayBuffer=t.getParameter(di.ELEMENT_ARRAY_BUFFER_BINDING),di._elementArrayBuffer&&t.bindBuffer(di.ELEMENT_ARRAY_BUFFER,null),di._frameBuffer=t.getParameter(di.FRAMEBUFFER_BINDING),di._frameBuffer&&t.bindFramebuffer(di.FRAMEBUFFER,null),di._renderBuffer=t.getParameter(di.RENDERBUFFER_BINDING),di._renderBuffer&&t.bindRenderbuffer(di.RENDERBUFFER,null),di._bindTextureCubeMap=t.getParameter(di.TEXTURE_BINDING_CUBE_MAP),di._activeTexture=t.getParameter(di.ACTIVE_TEXTURE)},e.revertLayaWebGLContext=function(){var t=laya.webgl.WebGL.mainContext;di._depthTest?t.enable(di.DEPTH_TEST):t.disable(di.DEPTH_TEST),t.depthMask(di._depthMask),t.depthFunc(di._depthFunc),di._blend?t.enable(di.BLEND):t.disable(di.BLEND),t.blendFunc(di._sFactor,di._dFactor),di._cullFace?t.enable(di.CULL_FACE):t.disable(di.CULL_FACE),t.cullFace(di._cullFaceMode),t.frontFace(di._frontFace),t.bindBuffer(di.ARRAY_BUFFER,di._arrayBuffer),t.bindBuffer(di.ELEMENT_ARRAY_BUFFER,di._elementArrayBuffer),t.bindFramebuffer(di.FRAMEBUFFER,di._frameBuffer),t.bindRenderbuffer(di.RENDERBUFFER,di._renderBuffer),t.useProgram(di._useProgram),t.activeTexture(di._activedTextureID)},e._list=[],e}(Laya.Sprite),mi=Laya.WebGLContext,vi=function(){function t(){this.setTextureNum=0,this.setProgramNum=0}return t.prototype.init=function(t){this.renderContext=Laya.WebGL.mainContext,this._contextSetTest=new _i},t.prototype.resetSize=function(t,e){},t.prototype.uploadBuff3D=function(t){var e=this.renderContext.createBuffer();return this.renderContext.bindBuffer(mi.ARRAY_BUFFER,e),this.renderContext.bufferData(mi.ARRAY_BUFFER,new Float32Array(t),mi.STATIC_DRAW),e},t.prototype.uploadBuff3DArrayBuffer=function(t){var e=this.renderContext.createBuffer();return this.renderContext.bindBuffer(mi.ARRAY_BUFFER,e),this.renderContext.bufferData(mi.ARRAY_BUFFER,t,mi.STATIC_DRAW),e},t.prototype.uploadBuff3DByBuffer=function(t,e){this.renderContext.bindBuffer(mi.ARRAY_BUFFER,t),this.renderContext.bufferData(mi.ARRAY_BUFFER,new Float32Array(e),mi.STATIC_DRAW)},t.prototype.uploadIndexBuff3D=function(t){var e=this.renderContext.createBuffer();return this.renderContext.bindBuffer(mi.ELEMENT_ARRAY_BUFFER,e),this.renderContext.bufferData(mi.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),mi.STATIC_DRAW),e},t.prototype.uploadIndexBuff3DByBuffer=function(t,e){this.renderContext.bindBuffer(mi.ELEMENT_ARRAY_BUFFER,t),this.renderContext.bufferData(mi.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),mi.STATIC_DRAW)},t.prototype.clearContext=function(){this.renderContext.depthMask(!0),this.renderContext.clear(mi.COLOR_BUFFER_BIT|mi.DEPTH_BUFFER_BIT|mi.STENCIL_BUFFER_BIT)},t.prototype.updateFBO=function(t){this.renderContext.bindFramebuffer(mi.FRAMEBUFFER,t.frameBuffer),this.renderContext.clearColor(63/255,63/255,63/255,1),this.renderContext.clearDepth(1),this.renderContext.clearStencil(0),this.renderContext.enable(mi.DEPTH_TEST),this.renderContext.depthMask(!0),this.renderContext.enable(mi.BLEND),this.renderContext.frontFace(mi.CW),this.renderContext.clear(mi.COLOR_BUFFER_BIT|mi.DEPTH_BUFFER_BIT|mi.STENCIL_BUFFER_BIT),this.setBlendParticleFactors(0),this.renderContext.disable(mi.CULL_FACE)},t.prototype.setDepthTest=function(t){t?this.renderContext.enable(mi.DEPTH_TEST):this.renderContext.disable(mi.DEPTH_TEST)},t.prototype.setWriteDepth=function(t){this._contextSetTest.testZbuffer(t)||this.renderContext.depthMask(t)},t.prototype.setBlendParticleFactors=function(t){if(!this._contextSetTest.testBlend(t))switch(t){case 0:this.renderContext.blendFunc(mi.ONE,mi.ONE_MINUS_SRC_ALPHA);break;case 1:this.renderContext.blendFunc(mi.ONE,mi.ONE);break;case 2:this.renderContext.blendFunc(mi.DST_COLOR,mi.ZERO);break;case 3:this.renderContext.blendFunc(mi.ONE,mi.ONE_MINUS_SRC_COLOR);break;case 4:this.renderContext.blendFunc(mi.SRC_ALPHA,mi.ONE);break;case-1:this.renderContext.blendFunc(mi.SRC_ALPHA,mi.ONE_MINUS_SRC_ALPHA)}},t.prototype.setProgram=function(t){this._contextSetTest.testProgram(t)||(this.renderContext.useProgram(t),this.setProgramNum++)},t.prototype.getLocation=function(t,e){return this.renderContext.getUniformLocation(t,e)},t.prototype.setVcMatrix3fv=function(t,e,i){this.renderContext.uniformMatrix3fv(t.getWebGLUniformLocation(e),!1,i)},t.prototype.setVcMatrix4fv=function(t,e,i){this.renderContext.uniformMatrix4fv(t.getWebGLUniformLocation(e),!1,i)},t.prototype.setVpMatrix=function(t,e){this._contextSetTest.testVp()||this.renderContext.uniformMatrix4fv(t.getWebGLUniformLocation("vpMatrix3D"),!1,e)},t.prototype.setVc4fv=function(t,e,i){this.renderContext.uniform4fv(t.getWebGLUniformLocation(e),i)},t.prototype.setVc1fv=function(t,e,i){this.renderContext.uniform1fv(t.getWebGLUniformLocation(e),i)},t.prototype.setVc3fv=function(t,e,i){this.renderContext.uniform3fv(t.getWebGLUniformLocation(e),i)},t.prototype.setVc2fv=function(t,e,i){this.renderContext.uniform2fv(t.getWebGLUniformLocation(e),i)},t.prototype.setVcFloat=function(t,e,i){this.renderContext.uniform1fv(t.getWebGLUniformLocation(e),i)},t.prototype.setuniform3f=function(t,e,i,a,r){this.renderContext.uniform3f(t.getWebGLUniformLocation(e),i,a,r)},t.prototype.setVcMatrix4fvLocation=function(t,e){this.renderContext.uniformMatrix4fv(t,!1,e)},t.prototype.setVc2f=function(t,e,i,a){this.renderContext.uniform2f(t.getWebGLUniformLocation(e),i,a)},t.prototype.setVcMatrix2fvLocation=function(t,e){this.renderContext.uniformMatrix2fv(t,!1,e)},t.prototype.setVc4fvLocation=function(t,e){this.renderContext.uniform4fv(t,e)},t.prototype.setVa=function(t,e,i){this._contextSetTest.testVa(i),this.renderContext.bindBuffer(mi.ARRAY_BUFFER,i),i&&(this.renderContext.enableVertexAttribArray(t),this.renderContext.vertexAttribPointer(t,e,mi.FLOAT,!1,0,0))},t.prototype.pushVa=function(t){return!!this._contextSetTest.testVa(t)||(this.renderContext.bindBuffer(mi.ARRAY_BUFFER,t),!1)},t.prototype.setVaOffset=function(t,e,i,a){this._contextSetTest.enableVaAry[t]||(this.renderContext.enableVertexAttribArray(t),this._contextSetTest.enableVaAry[t]=!0),this.renderContext.vertexAttribPointer(t,e,mi.FLOAT,!1,i,a)},t.prototype.clearVa=function(t){this._contextSetTest.enableVaAry[t]=!1,this.renderContext.disableVertexAttribArray(t)},t.prototype.drawCall=function(t,e){this.renderContext.bindBuffer(mi.ELEMENT_ARRAY_BUFFER,t),this.renderContext.drawElements(mi.TRIANGLES,e,mi.UNSIGNED_SHORT,0),laya.utils.Stat.drawCall+=1},t.prototype.drawLine=function(t,e){this.renderContext.bindBuffer(mi.ELEMENT_ARRAY_BUFFER,t),this.renderContext.drawElements(mi.LINES,e,mi.UNSIGNED_SHORT,0)},t.prototype.setRenderTexture=function(t,e,i,a,r){void 0===r&&(r=!0),r&&this._contextSetTest.testTexture(e,i)||(0==a?mi.activeTexture(this.renderContext,mi.TEXTURE0):1==a?mi.activeTexture(this.renderContext,mi.TEXTURE1):2==a?this.renderContext.activeTexture(mi.TEXTURE2):3==a?this.renderContext.activeTexture(mi.TEXTURE3):4==a?this.renderContext.activeTexture(mi.TEXTURE4):5==a?this.renderContext.activeTexture(mi.TEXTURE5):6==a&&this.renderContext.activeTexture(mi.TEXTURE6),this.renderContext.bindTexture(mi.TEXTURE_2D,i),this.renderContext.uniform1i(t.getWebGLUniformLocation(e),a),this.setTextureNum++)},t.prototype.clearTexture=function(){},t.prototype.setRenderTextureCube=function(t,e,i,a){0==a?this.renderContext.activeTexture(mi.TEXTURE0):1==a?this.renderContext.activeTexture(mi.TEXTURE1):2==a?this.renderContext.activeTexture(mi.TEXTURE2):3==a?this.renderContext.activeTexture(mi.TEXTURE3):4==a?this.renderContext.activeTexture(mi.TEXTURE4):5==a?this.renderContext.activeTexture(mi.TEXTURE5):6==a&&this.renderContext.activeTexture(mi.TEXTURE6),this.renderContext.bindTexture(mi.TEXTURE_CUBE_MAP,i),this.renderContext.uniform1i(this.renderContext.getUniformLocation(t,e),a)},t.prototype.updateTexture=function(t,e,i,a){this.renderContext.bindTexture(mi.TEXTURE_2D,t),this.renderContext.texSubImage2D(mi.TEXTURE_2D,0,e,i,mi.RGBA,mi.UNSIGNED_BYTE,a)},t.prototype.getTexture=function(t,e,i,a){void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=0);var r=new Ht(0,0,Math.pow(2,Math.ceil(Math.log(t.width)/Math.log(2))),Math.pow(2,Math.ceil(Math.log(t.height)/Math.log(2))));if(r.width!=t.width||r.height!=t.height){var n=M.getInstance().getContext2D(r.width,r.height,!1);return n.drawImage(t,0,0,t.width,t.height,0,0,r.width,r.height),this.getTexture(n.canvas,0,0)}var s=this.renderContext.createTexture();return this.renderContext.bindTexture(mi.TEXTURE_2D,s),this.renderContext.texImage2D(mi.TEXTURE_2D,0,mi.RGBA,mi.RGBA,mi.UNSIGNED_BYTE,t),0==i?mi.LINEAR:mi.NEAREST,0==i?0==a?mi.LINEAR:1==a?mi.LINEAR_MIPMAP_LINEAR:2==a&&mi.LINEAR_MIPMAP_NEAREST:0==a?mi.NEAREST:1==a?mi.NEAREST_MIPMAP_LINEAR:2==a&&mi.NEAREST_MIPMAP_NEAREST,this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_MAG_FILTER,mi.LINEAR),this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_MIN_FILTER,mi.LINEAR),0==e?(this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_WRAP_S,mi.REPEAT),this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_WRAP_T,mi.REPEAT)):(this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_WRAP_S,mi.CLAMP_TO_EDGE),this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_WRAP_T,mi.CLAMP_TO_EDGE)),0!=a&&this.renderContext.generateMipmap(mi.TEXTURE_2D),s},t.prototype.creatTexture=function(t,e,i){void 0===i&&(i=0);var a=this.renderContext.createTexture();return this.renderContext.bindTexture(mi.TEXTURE_2D,a),this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_MAG_FILTER,mi.LINEAR),this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_MIN_FILTER,mi.LINEAR),0==i?(this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_WRAP_S,mi.REPEAT),this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_WRAP_T,mi.REPEAT)):(this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_WRAP_S,mi.CLAMP_TO_EDGE),this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_WRAP_T,mi.CLAMP_TO_EDGE)),this.renderContext.texImage2D(mi.TEXTURE_2D,0,mi.RGB,t,e,0,mi.RGB,mi.UNSIGNED_BYTE,null),a},t.prototype.createFramebuffer=function(){var t=this.renderContext.createFramebuffer();return this.renderContext.bindFramebuffer(mi.FRAMEBUFFER,t),t},t.prototype.deleteBuffer=function(t){this.renderContext.deleteBuffer(t),this.renderContext.getError()},t.prototype.deleteTexture=function(t){this.renderContext.deleteTexture(t)},t.prototype.deleteShader=function(t){this.renderContext.deleteShader(t.vShader),this.renderContext.deleteShader(t.fShader),this.renderContext.deleteProgram(t.program)},t.prototype.cullFaceBack=function(t){this._contextSetTest.testCull(t)||(t?(this.renderContext.enable(mi.CULL_FACE),this.renderContext.cullFace(mi.BACK)):this.renderContext.disable(mi.CULL_FACE))},t.prototype.getFBO=function(){var t=gi.fw,e=gi.fh,i=this.renderContext.createFramebuffer();this.renderContext.bindFramebuffer(mi.FRAMEBUFFER,i);var a=this.renderContext.createRenderbuffer();this.renderContext.bindRenderbuffer(mi.RENDERBUFFER,a),this.renderContext.renderbufferStorage(mi.RENDERBUFFER,mi.DEPTH_COMPONENT16,t,e),this.renderContext.framebufferRenderbuffer(mi.FRAMEBUFFER,mi.DEPTH_ATTACHMENT,mi.RENDERBUFFER,a);var r=this.renderContext.createTexture();this.renderContext.bindTexture(mi.TEXTURE_2D,r),this.renderContext.texImage2D(mi.TEXTURE_2D,0,mi.RGBA,t,e,0,mi.RGBA,mi.UNSIGNED_BYTE,null),this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_MAG_FILTER,mi.LINEAR),this.renderContext.texParameteri(mi.TEXTURE_2D,mi.TEXTURE_MIN_FILTER,mi.LINEAR),this.renderContext.framebufferTexture2D(mi.FRAMEBUFFER,mi.COLOR_ATTACHMENT0,mi.TEXTURE_2D,r,0),this.renderContext.bindTexture(mi.TEXTURE_2D,null),this.renderContext.bindRenderbuffer(mi.RENDERBUFFER,null),this.renderContext.bindFramebuffer(mi.FRAMEBUFFER,null);var n=new gi;return n.frameBuffer=i,n.depthBuffer=a,n.texture=r,n},t.prototype.clearTest=function(){this._contextSetTest.clear()},t}(),gi=function(){function t(){}return t.fw=512,t.fh=512,t}(),_i=function(){function t(){this.enableVaAry=new Array,this.vaAry=new Array,this._blendType=-1e3,this._cullType=!1,this._zbufferType=!0,this._vpMatrix=!1}return t.prototype.testTexture=function(t,e){return this._textureDic[t]==e||(this._textureDic[t]=e,!1)},t.prototype.testProgram=function(t){return this._program==t||(this._program=t,this._textureDic=new Object,this._vpMatrix=!1,!1)},t.prototype.testVa=function(t){return this._vabuffer==t||(this._vabuffer=t,!1)},t.prototype.clear=function(){this._blendType=-1e3,this._cullType=!1,this._vpMatrix=!1,this._program=null,this._vabuffer=null},t.prototype.testBlend=function(t){return this._blendType==t||(this._blendType=t,!1)},t.prototype.testCull=function(t){return this._cullType==t||(this._cullType=t,!1)},t.prototype.testZbuffer=function(t){return this._zbufferType==t||(this._zbufferType=t,!1)},t.prototype.testVp=function(){return!!this._vpMatrix||(this._vpMatrix=!0,!1)},t}(),xi=function(t){function e(){var e=t.call(this)||this;return e._distance=500,e.offset=new a,e.cameraMatrix=new d,e}return i(e,t),Object.defineProperty(e.prototype,"distance",{get:function(){return this._distance},set:function(t){this._distance=t},enumerable:!1,configurable:!0}),e}(y),bi=function(t){function e(){return t.call(this)||this}return i(e,t),e.resetSize=function(t,e){r.stageWidth=t,r.stageHeight=e,r.canvas3D.width=r.stageWidth,r.canvas3D.height=r.stageHeight,r.context3D.resetSize(r.stageWidth,r.stageHeight),u.resetViewMatrx3D()},e.init=function(t){r.vpMatrix=new d,r.canvas3D=t,r.context3D=new vi,r.context3D.init(t),r.cam3D=new xi,r.focus3D=new y,r.light=new ui,h.init(),r.supportBlob=!0},e}(u),Di=function(){function t(){this.tureMoveV2d=new O(0,0)}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.resetSize=function(){var t=r.SCALE_Z,e=Laya.stage.width/2,i=Laya.stage.height/2,a=r.focus3D;a.x=0+e,a.z=0-i*t,a.x-=this.tureMoveV2d.x,a.z+=this.tureMoveV2d.y*t},t.SCENE_2D_ROTATION_45=30,t}(),wi=function(t){function e(){return t.call(this)||this}return i(e,t),e.resetSize=function(t,e){isNaN(t)&&(t=document.body.clientWidth),isNaN(e)&&(e=document.body.clientHeight),r.stageWidth=t,r.stageHeight=e,r.context3D.resetSize(r.stageWidth,r.stageHeight),u.resetViewMatrx3D(),Di.getInstance().resetSize()},e.init=function(t){bi.init(t),r.focus3D.x=0,r.focus3D.y=0,r.focus3D.z=0},e.resetViewMatrx3D=function(){r.viewMatrx3D?r.viewMatrx3D.identity():r.viewMatrx3D=new d;var t=2/r.stageWidth,e=2/r.stageHeight;r.viewMatrx3D.appendScale(t,e,.001)},e}(bi),Ai=function(t){function e(){return t.call(this)||this}return i(e,t),e.initConfig=function(){u.init=function(t){wi.init(t)},u.resetSize=function(t,e){wi.resetSize(t,e)},u.resetViewMatrx3D=function(){wi.resetViewMatrx3D()}},e}(bi),Ti=function(){},Mi=function(){function t(){}return t.initData=function(){t.isConfig||(Ai.initConfig(),u.init(Ti.canvas),u.resetSize(Ti.canvas.width,Ti.canvas.height),t.isConfig=!0,Re.getInstance().ready=!0,this.sceneItem=new Array)},t.isConfig=!1,t}(),Pi=function(t){function e(){return Mi.isConfig||Mi.initData(),t.call(this)||this}return i(e,t),e.prototype.upFrame=function(){r.context3D.setWriteDepth(!0),r.context3D.setDepthTest(!0),h.update(),r.focus3D.rotationY=0,r.focus3D.rotationX=-Di.SCENE_2D_ROTATION_45,r.cam3D.distance=250,Di.getInstance().tureMoveV2d=new O(this.x,this.y),Di.getInstance().resetSize(),r.context3D.renderContext.clear(Laya.WebGLContext.DEPTH_BUFFER_BIT),_e.getCamView(r.cam3D,r.focus3D),r.context3D._contextSetTest.clear(),this.tscene.upFrame()},e}(yi),Si=function(t){function e(){var e=t.call(this)||this;return e._avatar=-1,e._visible=!0,e.changeColor=[1,1,1,1],e._alpha=1,e}return i(e,t),Object.defineProperty(e.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t,this.changeColor[0]=1,this.changeColor[1]=1,this.changeColor[2]=1,this.changeColor[3]=t},enumerable:!1,configurable:!0}),e.prototype.updateMaterialMesh=function(i){if(1!=this.changeColor[0]||1!=this.changeColor[1]||1!=this.changeColor[2]||1!=this.changeColor[3]){e.alphaShader||(e.alphaShader=this.makeAlphaShader());var a=i.material.shader;i.material.shader=e.alphaShader,r.context3D.setProgram(e.alphaShader.program),r.context3D.cullFaceBack(!1),r.context3D.setBlendParticleFactors(-1),this.setVcMatrix(i),this.setMaterialTextureAlpha(i.material,i.materialParam),this.setVa(i),r.context3D.setVc4fv(i.material.shader,"alphadata",this.changeColor),this.setMeshVc(i),r.context3D.drawCall(i.indexBuffer,i.treNum),i.material.shader=a}else t.prototype.updateMaterialMesh.call(this,i)},e.prototype.setMaterialTextureAlpha=function(t,e){void 0===e&&(e=null);for(var i=t.texList,a=0;a<i.length;a++)if(i[a].isMain){var n=i[a].texture;if(e)for(var s=0;s<e.dynamicTexList.length;s++)e.dynamicTexList[s].target&&e.dynamicTexList[s].target.name==i[a].name&&(n=e.dynamicTexList[s].texture);r.context3D.setRenderTexture(t.shader,"alphatexture",n,0)}},e.prototype.makeAlphaShader=function(){var t=new Bt;t.paramAry=[!1,!1,!1,!1,!1,!1,!1,0],t.fragment="precision mediump float;\nuniform sampler2D alphatexture;\nuniform vec4 alphadata;\nvarying vec2 v0;\nvoid main(void){\nvec4 ft0 = texture2D(alphatexture,v0);\ngl_FragColor =ft0*alphadata;\n}";t.encode();return t},e.prototype.setAvatar=function(t){this._avatar!=t&&(this._avatar=t,this.setRoleUrl(this.getSceneCharAvatarUrl(t)))},e.prototype.update=function(){this.visible&&t.prototype.update.call(this),this._shadow&&(this._shadow._visible=this.visible)},e.prototype.getSceneCharAvatarUrl=function(t){pe.getRoleUrl(t);return pe.getRoleUrl(t)},e.prototype.getSceneCharWeaponUrl=function(t,e){return void 0===e&&(e=""),pe.getModelUrl(String(t+e))},e.prototype.hasAnimation=function(t){return!!this._animDic[t]},e.prototype.getAnimationTotalDuration=function(t){return this.hasAnimation(t)?1e3*this._animDic[t].matrixAry.length/30|0:200},e.prototype.isPlaying=function(){return 1!=this._completeState||!this._curentFrame||this._curentFrame<this._animDic[this.curentAction].matrixAry.length-1},e.prototype.loadPartRes=function(t,e,i){if(!this._hasDestory){for(var n=0;n<e.dataAry.length;n++){var s,o,h,c=e.dataAry[n];if(c.isGroup&&(s=new a(c.x,c.y,c.z),o=new a(c.rotationX,c.rotationY,c.rotationZ),h=new a(c.scaleX,c.scaleY,c.scaleZ)),c.types==Ot.SCENE_PARTICLE_TYPE){var l=Ut.getInstance().getParticleByte(r.fileRoot+c.particleUrl);i.push(l),l.bindTarget=this,l.bindSocket=t,l.dynamic=!0,this._scene.particleManager.addParticle(l),c.isGroup&&l.setGroup(s,o,h)}else if(c.types==Ot.PREFAB_TYPE){var u=new Gt;u.setObjUrl(c.objUrl),u.setMaterialUrl(c.materialUrl,c.materialInfoArr),u.dynamic=!0,i.push(u),u.setBind(this,t),this._scene.addSpriteDisplay(u),c.isGroup&&u.setGroup(s,o,h)}}this.applyVisible()}},e.prototype.removeStage=function(){for(var t in this._onStage=!1,this._shadow&&Oe.getInstance().removeShadow(this._shadow),this._partDic)for(var e=this._partDic[t],i=0;i<e.length;i++)e[i]instanceof Mt?this._scene.particleManager.removeParticle(e[i]):e[i]instanceof Gt&&this._scene.removeSpriteDisplay(e[i])},Object.defineProperty(e.prototype,"px",{get:function(){return this.x},set:function(t){this.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"py",{get:function(){return this.y},set:function(t){this.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pz",{get:function(){return this.z},set:function(t){this.z=t},enumerable:!1,configurable:!0}),e.prototype.addSkinMeshParticle=function(){if(this._skinMesh){var t=new Array;this._partDic.mesh=t;var e=this._skinMesh.meshAry;if(e)for(var i=0;i<e.length;i++)for(var a=e[i].particleAry,n=0;n<a.length;n++){var s,o=a[n];(s=Ut.getInstance().getParticleByte(r.fileRoot+o.url)).sourceData||console.log("particle.sourceData error"),s.dynamic=!0,s.bindSocket=o.socketName,t.push(s),s.bindTarget=this,this._scene.particleManager.addParticle(s)}}},e}(Ye),Ii=function(){function t(){}return t.STANAD="stand",t.WALK="walk",t.DEATH="death",t.JUMP="jump",t.SIT="sit",t.ATTACK_01="attack_01",t.ATTACK_02="attack_02",t.ATTACK_03="attack_03",t.ATTACK_04="attack_04",t.ATTACK_05="attack_05",t.ATTACK_06="attack_06",t.ATTACK_010="attack_010",t.ATTACK_020="attack_020",t.STAND_MOUNT="stand_mount_01",t.WALK_MOUNT="walk_mount_01",t.s_attack_01="s_attack_01",t}(),Bi=function(t){function e(){var e=t.call(this)||this;return e.isMount=!1,e._px=0,e._py=0,e._pz=0,e._pRotationY=0,e.toRotationY=0,e._pScale=1,e.tittleHeight=50,e._optimization=!1,e._weaponNum=-1,e._resultVisible=!0,e._showHitBox=!1,e._triIndex=[0,1,2,0,2,3,4,5,6,4,6,7,0,4,5,0,5,1,1,5,6,1,6,2,2,6,7,2,7,3,3,7,4,3,4,0],e.skillitem=new Array,e}return i(e,t),Object.defineProperty(e.prototype,"forceRotationY",{set:function(t){this.pRotationY=t,this.rotationY=t,this.toRotationY=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRotationY",{get:function(){return this._pRotationY},set:function(t){this._pRotationY=t,this.isMount?this._mountChar.rotationY=t:this.rotationY=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScale",{get:function(){return this._pScale},set:function(t){this._pScale=t,this._mountChar&&(this._mountChar.scale=t),this._wingDisplay&&(this._wingDisplay.scale=t),this.scale=t,this._skinMesh&&(this.tittleHeight=this._skinMesh.tittleHeight*t)},enumerable:!1,configurable:!0}),e.prototype.setMount=function(t){return this.isMount=0!=t,this.isMount?(this._mountChar||(this._mountChar=new Si,this._mountChar.scale=this._pScale),this._mountChar.setRoleUrl(pe.getRoleUrl(t)),this.setBind(this._mountChar,e.MOUNT_SLOT),this._mountChar._scene=this._scene,this._scene&&this._scene.addMovieDisplay(this._mountChar)):(this.setBind(null,null),this._mountChar&&(this._mountChar=null)),this.isMount},e.prototype.setWing=function(t){t?(this._wingDisplay||(this._wingDisplay=new Si,this._wingDisplay.scale=this._pScale),this._wingDisplay.setRoleUrl(pe.getRoleUrl(t)),this._wingDisplay.setBind(this,e.WING_SLOT),this._wingDisplay._scene=this._scene,this._scene&&this._scene.addMovieDisplay(this._wingDisplay)):this._wingDisplay&&(this._wingDisplay.setBind(null,null),this._wingDisplay=null)},e.prototype.setWeapon=function(t){this._weaponNum!=t&&(this._weaponNum=t,t<=0?this.removePart(e.WEAPON_PART):this.setWeaponByAvatar(this._weaponNum))},e.prototype.setWeaponByAvatar=function(t,i){void 0===i&&(i=""),this.addPart(e.WEAPON_PART,e.WEAPON_DEFAULT_SLOT,this.getSceneCharWeaponUrl(t,i))},e.prototype.getSceneCharAvatarUrl=function(t){if(0==t)throw new Error("衣服为getSceneCharAvatarUrl");return pe.getRoleUrl(t)},e.prototype.onMeshLoaded=function(){this._skinMesh&&(this.tittleHeight=this._skinMesh.tittleHeight*this._pScale)},e.prototype.play=function(e,i,a){return void 0===i&&(i=0),void 0===a&&(a=!0),this.isMount?(this._mountChar.visible=Boolean(e!=Ii.JUMP),e==Ii.STANAD?t.prototype.play.call(this,Ii.STAND_MOUNT):e==Ii.WALK?t.prototype.play.call(this,Ii.WALK_MOUNT):this._mountChar.visible?t.prototype.play.call(this,Ii.STAND_MOUNT):t.prototype.play.call(this,Ii.JUMP),this._mountChar.play(e,i,a)):t.prototype.play.call(this,e,i,a)},e.prototype.getCurrentAction=function(){return this.isMount?this._mountChar.curentAction:this.curentAction},e.prototype.rotationToNew=function(t,e){void 0===e&&(e=1);var i=t-this.pRotationY;if(0!=i)if(i<1)this.pRotationY=t;else{var a=((t-this.pRotationY)%360+360)%360;a>180?this.pRotationY-=(360-a)/e:this.pRotationY+=a/e}},e.prototype.stopMove=function(){this.play(Ii.STANAD)},e.prototype.watch=function(t,e){if(t){var i=t.x-this.px,a=t.z-this.pz,r=Math.sqrt(i*i+a*a);i/=r,a/=r;var n=Math.asin(i)/Math.PI*180;a<=0&&(n=180-n),isNaN(n)||(this.forceRotationY=n)}},e.prototype.getCurrentPos=function(){return new a(this.px,this.py,this.pz)},e.prototype.msgSpellStop=function(){this.skillVo&&(this.skillVo.removeSkillForce(),this.changeAction(this._defaultAction),this.skillVo=null),this.isSinging=!1},e.prototype.destory=function(){this._hasDestory||(this.skillVo&&(this.skillVo.removeSkillForce(),this.skillVo=null),this._mountChar&&(this._mountChar.destory(),this._mountChar=null),this._wingDisplay&&(this._wingDisplay.destory(),this._wingDisplay=null),this._hasDestory=!0,t.prototype.destory.call(this))},Object.defineProperty(e.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible=t,this.applyVisible()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"optimization",{get:function(){return this._optimization},set:function(t){this._optimization=t,this.applyVisible()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"resultVisible",{get:function(){return this._resultVisible},enumerable:!1,configurable:!0}),e.prototype.applyVisible=function(){var t=this._visible;if(t=!!this._visible&&!this._optimization,this._partDic&&this._partDic[e.WEAPON_PART])for(var i=0,a=this._partDic[e.WEAPON_PART];i<a.length;i++){a[i].sceneVisible=t}this._resultVisible=t},Object.defineProperty(e.prototype,"isCamera2D",{set:function(t){this._isCamera2D=t},enumerable:!1,configurable:!0}),e.prototype.updateBind=function(){t.prototype.updateBind.call(this),this.updateWeaponScale()},e.prototype.updateWeaponScale=function(){if(this._partDic&&this._partDic.hasOwnProperty(e.WEAPON_PART)){var t=this._partDic[e.WEAPON_PART];if(t instanceof Array)for(var i=0;i<t.length;i++){var a=t[i];a instanceof Gt&&(a.scale=this._pScale)}}},Object.defineProperty(e.prototype,"px",{get:function(){return this._px},set:function(t){this._px=t,this._mountChar?this._mountChar.x=this._px:this.x=this.px},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pz",{get:function(){return this._pz},set:function(t){this._pz=t,this._mountChar?this._mountChar.z=this._pz:this.z=this.pz},enumerable:!1,configurable:!0}),e.prototype.update=function(){if(this._skinMesh&&!this._optimization&&(t.prototype.update.call(this),this._showHitBox)){if(!this.lineSprite){V.getInstance().registe(xe.LineShader,new xe),this.lineSprite=new be,this.lineSprite.clear();for(var e=0;e<this._triIndex.length/3;e++){var i=this._skinMesh.hitPosItem[this._triIndex[3*e+0]],a=this._skinMesh.hitPosItem[this._triIndex[3*e+1]],r=this._skinMesh.hitPosItem[this._triIndex[3*e+2]];this.lineSprite.makeLineMode(i,a),this.lineSprite.makeLineMode(a,r),this.lineSprite.makeLineMode(r,i)}this.lineSprite.upToGpu()}this.lineSprite.posMatrix=this.posMatrix.clone(),this.lineSprite.update()}},e.prototype.math_distance=function(t){return _e.math_distance(this.px,this.pz,t.x,t.z)},e.prototype.get2dPos=function(){var t=new O;return this._mountChar?(t.x=this._mountChar.px,t.y=this._mountChar.pz):(t.x=this.px,t.y=this.pz),t.x=t.x,t.y=t.y/-1/r.SCALE_Z,t},e.prototype.set2dPos=function(t,e){var i=t,a=e*r.SCALE_Z*-1;this._px=i,this._pz=a,this._mountChar?(this._mountChar.x=i,this._mountChar.z=a):(this.x=i,this.z=a)},e.prototype.mouseClik=function(t,e){return!1},e.prototype.removeStage=function(){t.prototype.removeStage.call(this),this._mountChar&&this._scene.removeMovieDisplay(this._mountChar),this._wingDisplay&&this._scene.removeMovieDisplay(this._wingDisplay)},e.prototype.addStage=function(){t.prototype.addStage.call(this),this._mountChar&&this._scene.addMovieDisplay(this._mountChar),this._wingDisplay&&this._scene.addMovieDisplay(this._wingDisplay)},e.BLOOD_COLOR_HP=0,e.BLOOD_COLOR_ANGER=1,e.Defaul_Man_Avatar=2002,e.Defaul_WoMan_Avater=2012,e.WEAPON_PART="weapon",e.WEAPON_DEFAULT_SLOT="w_01",e.MOUNT_SLOT="mount_01",e.WING_SLOT="wing_01",e.SEL_PART="select",e.QUEST_ICON="questicon",e.NONE_SLOT="none",e}(Si),Ri=function(){function t(){}return t.addEvents=function(e,i,a){for(var r=0;r<e.length;r++)t._instance.addEventListener(e[r].type,i,a)},t.dispatchEvent=function(e){t._instance.dispatchEvent(e)},t._instance=new f,t}(),Fi=function(){function t(){}return t.prototype.getName=function(){throw new Error("process必须复写命名")},t.prototype.receivedModuleEvent=function(t){},t.prototype.listenModuleEvents=function(){return null},t.prototype.registerEvents=function(){var t=this.listenModuleEvents();null!=t&&t.length>0&&Ri.addEvents(t,this.receivedModuleEvent,this)},t.prototype.getHanderMap=function(){return new Object},t}(),Li=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(Fi),Ci=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._avatar=-1,e._visible=!0,e}return i(e,t),Object.defineProperty(e.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible=t},enumerable:!1,configurable:!0}),e.prototype.setAvatar=function(t){this._avatar!=t&&(this._avatar=t,this.setRoleUrl(this.getSceneCharAvatarUrl(t)))},e.prototype.update=function(){this.visible&&t.prototype.update.call(this),this._shadow&&(this._shadow._visible=this.visible)},e.prototype.getSceneCharAvatarUrl=function(t){pe.getRoleUrl(t);return pe.getRoleUrl(t)},e.prototype.getSceneCharWeaponUrl=function(t,e){return void 0===e&&(e=""),pe.getModelUrl(String(t+e))},e}(Ye),Ei=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.setData=function(t,e){if(e>0){var i={}.mountID;this.setAvatar(i)}else if(t>0){i={}.mountID;this.setAvatar(i)}},e}(Ci),zi=function(){function t(t,e,i,a){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),void 0===a&&(a=.1),this.p1=t,this.p2=e,this.p3=i,this.precision=a}return t.prototype.setAllPoint=function(t,e,i){this.p1=t,this.p2=e,this.p3=i},t.prototype.checkPointIn=function(e){var i=this.getArea(),a=0;return a+=t.getAreaByPoints(e,this.p1,this.p2),a+=t.getAreaByPoints(e,this.p2,this.p3),(a+=t.getAreaByPoints(e,this.p3,this.p1))==i||Math.abs(a-i)<this.precision},t.prototype.getArea=function(){return t.getAreaByPoints(this.p1,this.p2,this.p3)},t.getAreaByPoints=function(t,e,i){var a=t.x-e.x,r=t.y-e.y,n=Math.sqrt(a*a+r*r);a=e.x-i.x,r=e.y-i.y;var s=Math.sqrt(a*a+r*r);a=i.x-t.x,r=i.y-t.y;var o=Math.sqrt(a*a+r*r),h=(n+s+o)/2,c=h*(h-n)*(h-s)*(h-o);return c>0?Math.sqrt(c):0},t.baseTri=new t,t}(),Vi=function(t){function e(){var e=t.call(this)||this;return e.speedTX=.075,e.life=0,e.isMount=!1,e._px=0,e._py=0,e._pz=0,e._pRotationY=0,e._isBoss=!1,e._optimization=!1,e._weaponNum=-1,e._wingID=-1,e.tittleHeight=50,e.toRotationY=0,e._resultVisible=!0,e._showHitBox=!1,e.triIndex=[0,1,2,0,2,3,4,5,6,4,6,7,0,4,5,0,5,1,1,5,6,1,6,2,2,6,7,2,7,3,3,7,4,3,4,0],e.shadow=!0,e.skillitem=new Array,e}return i(e,t),Object.defineProperty(e.prototype,"isDeath",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isBoss",{get:function(){return this._isBoss},set:function(t){this._isBoss=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"px",{get:function(){return this._px},set:function(t){this._px=t,this.isMount?(this.mountChar.x=t,this._shadow&&(this._shadow.x=t)):this.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"py",{get:function(){return this._py},set:function(t){this._py=t,this.isMount?(this.mountChar.y=t,this._shadow&&(this._shadow.y=t)):this.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pz",{get:function(){return this._pz},set:function(t){this._pz=t,this.isMount?(this.mountChar.z=t,this._shadow&&(this._shadow.z=t)):this.z=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"forceRotationY",{set:function(t){this.pRotationY=t,this.rotationY=t,this.toRotationY=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRotationY",{get:function(){return this._pRotationY},set:function(t){this._pRotationY=t,this.isMount?this.mountChar.rotationY=t:this.rotationY=t},enumerable:!1,configurable:!0}),e.prototype.play=function(e,i,a){return void 0===i&&(i=0),void 0===a&&(a=!0),!(!this.isSinging||(i=0,e!=Ii.WALK&&e!=Ii.STANAD))||(this.isMount?(this.mountChar.visible=Boolean(e!=Ii.JUMP),e==Ii.STANAD?t.prototype.play.call(this,Ii.STAND_MOUNT):e==Ii.WALK?t.prototype.play.call(this,Ii.WALK_MOUNT):this.mountChar.visible?t.prototype.play.call(this,Ii.STAND_MOUNT):t.prototype.play.call(this,Ii.JUMP),this.mountChar.play(e,i,a)):t.prototype.play.call(this,e,i,a))},e.prototype.getCurrentAction=function(){return this.isMount?this.mountChar.curentAction:this.curentAction},e.prototype.getSceneCharAvatarUrl=function(t){if(0==t)throw new Error("衣服为getSceneCharAvatarUrl");return pe.getRoleUrl(t)},e.prototype.setMount=function(){},e.prototype.setWeapon=function(t){this._weaponNum!=t&&(this._weaponNum=t,t<=0&&this.removePart(e.WEAPON_PART))},e.prototype.setWeaponByAvatar=function(t,e){},e.prototype.addTestWeapon=function(){this.addPart("test"+Math.random(),e.WEAPON_DEFAULT_SLOT,this.getSceneCharWeaponUrl(Math.random()>.5?5202:5201))},e.prototype.onMeshLoaded=function(){this._skinMesh&&(this.tittleHeight=this._skinMesh.tittleHeight)},Object.defineProperty(e.prototype,"walkPath",{set:function(t){0!=t.length&&(this.curentAction!=Ii.STANAD&&this.curentAction!=Ii.STAND_MOUNT||this.play(Ii.WALK),this._walkPath=t,this.setTarget(),this._speedDirect=null)},enumerable:!1,configurable:!0}),e.prototype.fixAstartData=function(t){if(this._walkPath)for(var e=0;e<this._walkPath.length;e++)this._walkPath[e].x+=t.x,this._walkPath[e].z=t.y-this._walkPath[e].z,this._walkPath[e].y=Se.getHeightByPos(this._walkPath[e]);this.px+=t.x,this.pz=t.y-this.pz,this._astatTopos&&(this._astatTopos.x+=t.x,this._astatTopos.z=t.y-this._astatTopos.z,this.setAstarNrmAndRotation()),this.refreshY()},e.prototype.applyWalk=function(t){if(t&&2==t.length&&t[0].x==t[1].x&&t[0].y==t[1].y){this._speedDirect=null,this._walkPath=null,this.curentAction==Ii.WALK&&this.play(Ii.STANAD);var e=Se.getWorldPosByStart2D(t[0]);return this.px=e.x,void(this.pz=e.z)}this.walkPath=Se.Path2dTo3d(t)},Object.defineProperty(e.prototype,"moveToPos2D",{set:function(t){this._walkPath=null,this.play(this._defaultAction);var e=Se.getWorldPosByStart2D(t);this.px=e.x,this.pz=e.z,this.refreshY()},enumerable:!1,configurable:!0}),e.prototype.stopToPos=function(t){var e=Se.getWorldPosByStart2D(t),i=new Array;i.push(e),this.walkPath=i},e.prototype.moveTile=function(t,e){this.moveToPos2D=new O(t,e)},e.prototype.refreshY=function(){this.py=Se.getHeightByPos(this.getCurrentPos())},e.prototype.refreshHP=function(){},e.prototype.rotationToNew=function(t,e){void 0===e&&(e=1);var i=t-this.pRotationY;if(0!=i)if(i<1)this.pRotationY=t;else{var a=((t-this.pRotationY)%360+360)%360;a>180?this.pRotationY-=(360-a)/e:this.pRotationY+=a/e}},Object.defineProperty(e.prototype,"speedUseTime",{set:function(t){this.speedTX=t/10*.01},enumerable:!1,configurable:!0}),e.prototype.refreshSpeed=function(){this.speedUseTime=1},e.prototype.walkAstar=function(t){var e=Math.min(t,50),i=a.distance(new a(this.px,0,this.pz),this._astatTopos);if(i>5){var r=e*this.speedTX;if(r>i){this.px=this._astatTopos.x,this.pz=this._astatTopos.z;var n=(r-i)/this.speedTX;this.walkAstar(n)}else this.px+=this._astarDirect.x*r,this.pz+=this._astarDirect.z*r}else this.setTarget(),this._walkPath?this.walkAstar(t):(this.px=this._astatTopos.x,this.pz=this._astatTopos.z,this.walkComplete())},e.prototype.walkComplete=function(){this.walkCompleteBackFun&&this.walkCompleteBackFun()},e.prototype.setTarget=function(){if(this._walkPath){if(0==this._walkPath.length)return this._walkPath=null,void this.play(Ii.STANAD);this._astatTopos=this._walkPath.shift(),this.setAstarNrmAndRotation()}},e.prototype.setAstarNrmAndRotation=function(){this._astatTopos&&(this._astarDirect=this._astatTopos.subtract(this.getCurrentPos()),this._astarDirect.y=0,this._astarDirect.normalize(),a.distance(this.getCurrentPos(),this._astatTopos)>10&&(this.toRotationY=this.mathAngle(this._astatTopos.z,this._astatTopos.x,this.pz,this.px)+180))},e.prototype.mathAngle=function(t,e,i,a){return 180*Math.atan2(a-e,i-t)/Math.PI},e.prototype.setSpeedDirect=function(t){this.isDeath||(this._speedDirect=t,this.curentAction!=Ii.STANAD&&this.curentAction!=Ii.STAND_MOUNT||this.play(Ii.WALK),this._walkPath=null)},e.prototype.stopMove=function(){this._speedDirect=null,this._walkPath=null,this.play(Ii.STANAD)},e.prototype.getEndWalkPathPos=function(){return this._walkPath?this._walkPath[this._walkPath.length-1]:null},e.prototype.watch=function(t,e){if(t){var i=t.x-this.px,a=t.z-this.pz,r=Math.sqrt(i*i+a*a);i/=r,a/=r;var n=Math.asin(i)/Math.PI*180;a<=0&&(n=180-n),isNaN(n)||(this.forceRotationY=n)}},e.prototype.getCurrentPos=function(){return new a(this.px,this.py,this.pz)},e.prototype.getAstarPos=function(){return Se.getGrapIndexByPos(this.getCurrentPos())},e.prototype.changeAction=function(e){switch(e){case Ii.ATTACK_01:this.play(Ii.ATTACK_010,2);break;case Ii.ATTACK_02:this.play(Ii.ATTACK_020,2);break;default:t.prototype.changeAction.call(this,e)}},e.prototype.playSkill=function(t){this._walkPath=null,$e.getInstance().playSkill(t),this.skillVo=t},e.prototype.msgSpellStop=function(){this.skillVo&&(this.skillVo.removeSkillForce(),this.changeAction(this._defaultAction),this.skillVo=null),this.isSinging=!1},e.prototype.destory=function(){this._hasDestory||(t.prototype.destory.call(this),this._isBoss,this.skillVo&&(this.skillVo.removeSkillForce(),this.skillVo=null),this._wingDisplay&&this._wingDisplay.destory(),this._hasDestory=!0)},e.prototype.removeStage=function(){t.prototype.removeStage.call(this),this.mountChar&&Re.getInstance().removeMovieDisplay(this.mountChar),this._wingDisplay&&Re.getInstance().removeMovieDisplay(this._wingDisplay)},e.prototype.addStage=function(){t.prototype.addStage.call(this),this.mountChar&&Re.getInstance().addMovieDisplay(this.mountChar),this._wingDisplay&&Re.getInstance().addMovieDisplay(this._wingDisplay)},e.prototype.math_distance=function(t){return _e.math_distance(this.px,this.pz,t.x,t.z)},Object.defineProperty(e.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible=t,this.applyVisible()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"optimization",{get:function(){return this._optimization},set:function(t){this._optimization=t,this.applyVisible()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"resultVisible",{get:function(){return this._resultVisible},enumerable:!1,configurable:!0}),e.prototype.applyVisible=function(){var t=this._visible;if(t=!!this._visible&&!this._optimization,this._partDic&&this._partDic[e.WEAPON_PART])for(var i=0,a=this._partDic[e.WEAPON_PART];i<a.length;i++){a[i].sceneVisible=t}this._wingDisplay&&(this._wingDisplay.visible=t),this.shadow=t,this._resultVisible=t},e.prototype.update=function(){if(this._skinMesh&&!this._optimization&&(t.prototype.update.call(this),this._showHitBox)){if(!this.lineSprite){V.getInstance().registe(xe.LineShader,new xe),this.lineSprite=new be,this.lineSprite.clear();for(var e=0;e<this.triIndex.length/3;e++){var i=this._skinMesh.hitPosItem[this.triIndex[3*e+0]],a=this._skinMesh.hitPosItem[this.triIndex[3*e+1]],r=this._skinMesh.hitPosItem[this.triIndex[3*e+2]];this.lineSprite.makeLineMode(i,a),this.lineSprite.makeLineMode(a,r),this.lineSprite.makeLineMode(r,i)}this.lineSprite.upToGpu()}this.lineSprite.posMatrix=this.posMatrix.clone(),this.lineSprite.update()}},e.prototype.mouseClik=function(t,e){if(r.cam3D.cameraMatrix.transformVector(this.getCurrentPos()).z<r.cam3D.distance/3)return null;var i=Me.math3DWorldtoDisplay2DPos(e);if(this._skinMesh){this.hitBox2DItem||(this.hitBox2DItem=new Array),this.hitBox2DItem.length=0;for(var a=0;a<this._skinMesh.hitPosItem.length;a++){var n=this.posMatrix.transformVector(this._skinMesh.hitPosItem[a]);this.hitBox2DItem.push(Me.math3DWorldtoDisplay2DPos(n))}for(var s=0;s<this.triIndex.length/3;s++)if(zi.baseTri.p1=this.hitBox2DItem[this.triIndex[3*s+0]],zi.baseTri.p2=this.hitBox2DItem[this.triIndex[3*s+1]],zi.baseTri.p3=this.hitBox2DItem[this.triIndex[3*s+2]],zi.baseTri.checkPointIn(i))return!0}else if(O.distance(i,Me.math3DWorldtoDisplay2DPos(this.posMatrix.position))<20)return!0;return!1},e.WEAPON_PART="weapon",e.WEAPON_DEFAULT_SLOT="w_01",e.MOUNT_SLOT="mount_01",e.WING_SLOT="wing_01",e.SEL_PART="select",e.QUEST_ICON="questicon",e.NONE_SLOT="none",e.Defaul_Man_Avatar=2002,e.Defaul_WoMan_Avater=2012,e}(Ci),Ni=function(){function t(){}return t.Orange7a2f21="[7a2f21]",t.Orange9a683f="[9a683f]",t.Orange853d07="[853d07]",t.Brown6a4936="[6a4936]",t.Brown623424="[623424]",t.Brownac8965="[ac8965]",t.Reddb4051="[db4051]",t.Redd92200="[d92200]",t.Redff0000="[ff0000]",t.Brownd8d49c="[d8d49c]",t.color843b11="[843b11]",t.colorb96d49="[b96d49]",t.colorcd2000="[cd2000]",t.colorfef3d7="[fef3d7]",t.color9a683f="[9a683f]",t.Brown7a2f21="[7a2f21]",t.Brown40120a="[40120a]",t.Brown491207="[491207]",t.Brown541616="[541616]",t.Brown5a2610="[5a2610]",t.Browndf9a68="[df9a68]",t.Browndb39264="[b39264]",t.Brownd662c0d="[662c0d]",t.colorefe4c4="[efe4c4]",t.color802626="[802626]",t.color9f7b4d="[9f7b4d]",t.color4b0808="[4b0808]",t.color5f5c59="[5f5c59]",t.color903713="[903713]",t.colorfdf6da="[fdf6da]",t.color73301c="[73301c]",t.colorffeeb5="[ffeeb5]",t.Green98ec2c="   ",t.Green56da35="[56da35]",t.Green20a200="[20a200]",t.Greenadff00="[adff00]",t.Green2ca937="[2ca937]",t.Green464b11="[464b11]",t.Green54db36="[54db36]",t.Yellowf7d253="[f7d253]",t.Yellowffecc6="[ffecc6]",t.Yellowffd500="[ffd500]",t.Yellowffe9b4="[ffe9b4]",t.Yellowedce7e="[edce7e]",t.color4c1c07="[4c1c07]",t.Whiteffffff="[ffffff]",t.Whitefffce6="[fffce6]",t.Whitefff7db="[fff7db]",t.White9A683F="[9A683F]",t.Black000000="[000000]",t.Whitefff4d6="[fff4d6]",t.Whiteffeed0="[ffeed0]",t.Whiteffeec9="[ffeec9]",t.Whiteffe9b4="[ffe9b4]",t.Whitefff0b4="[fff0b4]",t.Coffeeff9200="[ff9200]",t.Coffeefee87b="[fee87b]",t.color2daa35="[2daa35]",t.color4392ff="[4392ff]",t.colorb759ff="[b759ff]",t.colorff7200="[ff7200]",t.colorce0a00="[ce0a00]",t.coloraa874a="[aa874a]",t.colorffecc6="[ffecc6]",t.colorfde87e="[fde87e]",t.colord6e7ff="[d6e7ff]",t.colord27262e="[27262e]",t.colorffe9b4="[ffe9b4]",t.color9c9b9b="[9c9b9b]",t.colorfff2d3="[fff2d3]",t.color451800="[451800]",t}(),ki=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"u2Texture")},e.prototype.getVertexShaderString=function(){return"attribute vec3 v3Position;attribute vec2 u2Texture;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(u2Texture.x, u2Texture.y);   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"},e.prototype.getFragmentShaderString=function(){return"precision mediump float;\nuniform sampler2D s_texture;\nvarying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ngl_FragColor =infoUv;\n}"},e.BaseDiplay3dShader="BaseDiplay3dShader",e}(nt),Ui=function(t){function e(){var e=t.call(this)||this;return e.initData(),e.updateMatrix,e}return i(e,t),e.prototype.initData=function(){V.getInstance().registe(ki.BaseDiplay3dShader,new ki),this.shader=V.getInstance().getProgram(ki.BaseDiplay3dShader),this.program=this.shader.program,this.objData=new L,this.objData.vertices=new Array,this.objData.vertices.push(0,0,0),this.objData.vertices.push(100,0,0),this.objData.vertices.push(100,0,100),this.objData.uvs=new Array,this.objData.uvs.push(0,0),this.objData.uvs.push(1,0),this.objData.uvs.push(0,1),this.objData.indexs=new Array,this.objData.indexs.push(0,1,2),this.loadTexture(),this.upToGpu()},e.prototype.loadTexture=function(){var t=M.getInstance().getContext2D(128,128,!1);t.fillStyle="rgb(255,255,255)",t.fillRect(0,0,128,128),this._uvTextureRes=I.getInstance().getCanvasTexture(t)},e.prototype.upToGpu=function(){this.objData.indexs.length&&(this.objData.treNum=this.objData.indexs.length,this.objData.vertexBuffer=r.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=r.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=r.context3D.uploadIndexBuff3D(this.objData.indexs))},e.prototype.update=function(){this.objData&&this.objData.indexBuffer&&this._uvTextureRes&&(r.context3D.setProgram(this.program),r.context3D.setVcMatrix4fv(this.shader,"viewMatrix3D",r.viewMatrx3D.m),r.context3D.setVcMatrix4fv(this.shader,"camMatrix3D",r.cam3D.cameraMatrix.m),r.context3D.setVcMatrix4fv(this.shader,"posMatrix3D",this.posMatrix.m),r.context3D.setVa(0,3,this.objData.vertexBuffer),r.context3D.setVa(1,2,this.objData.uvBuffer),r.context3D.setRenderTexture(this.shader,"s_texture",this._uvTextureRes.texture,0),r.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum))},e}(m),Oi=function(t){function e(){var e=t.call(this)||this;return e.batchNum=0,e.batchPos=new Array,e}return i(e,t),Object.defineProperty(e.prototype,"fileScale",{set:function(t){this._fileScale=t;for(var e=0;e<this.batchPos.length;e++)this.batchPos[e].fileScale=t},enumerable:!1,configurable:!0}),e.prototype.addSun=function(t){this.batchPos.push(t),t.fileScale=this._fileScale},e.prototype.setVcMatrix=function(t){r.context3D.setVcMatrix4fv(t.material.shader,"viewMatrix3D",r.viewMatrx3D.m),r.context3D.setVcMatrix4fv(t.material.shader,"camMatrix3D",r.cam3D.cameraMatrix.m),r.context3D.setVcMatrix4fv(t.material.shader,"rotationMatrix3D",this._rotationMatrix.m);for(var e=0;e<this.batchPos.length;e++)r.context3D.setVcMatrix4fv(t.material.shader,"posMatrixAry["+e+"]",this.batchPos[e].posMatrix.m)},e.prototype.setLightProbeVc=function(t){},e.prototype.setVa=function(t){r.context3D.setVa(0,3,t.vertexBuffer),r.context3D.setVa(1,3,t.uvBuffer),r.context3D.setVa(2,4,t.boneIdBuffer),r.context3D.setVa(3,4,t.boneWeightBuffer),t.material.usePbr?(r.context3D.setVa(4,4,t.normalsBuffer),t.material.useNormal&&(r.context3D.setVa(5,4,t.tangentBuffer),r.context3D.setVa(6,4,t.bitangentBuffer))):(t.material.lightProbe||t.material.directLight)&&r.context3D.setVa(4,4,t.normalsBuffer)},e.prototype.addStage=function(){if(t.prototype.addStage.call(this),this.batchPos.length)for(var e=0;e<this.batchPos.length;e++)this.batchPos[e].add()},e.prototype.removeStage=function(){if(t.prototype.removeStage.call(this),this.batchPos.length)for(var e=0;e<this.batchPos.length;e++)this.batchPos[e].remove()},e}(Ye),ji=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.posData=[0,0,0,10],e.hasReach=!1,e._fileScale=1,e}i(e,t),Object.defineProperty(e.prototype,"shadow",{set:function(t){t&&(this._shadow||(this._shadow=Oe.getInstance().addShadow(),this._shadow.x=this._x,this._shadow.y=this._y,this._shadow.z=this._z))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fileScale",{set:function(t){this._fileScale=t,this._scaleX*=t,this._scaleY*=t,this._scaleZ*=t,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{set:function(t){this._scaleX=t*this._fileScale,this._scaleY=t*this._fileScale,this._scaleZ=t*this._fileScale,this.posData[3]=20*t,this.updateMatrix()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"x",{get:function(){return this._x},set:function(t){this._x=t,this.posData[0]=t,this.updateMatrix(),this._shadow&&(this.retinueShadowFix?this._shadow.x=t+this.retinueShadowFix.x:this._shadow.x=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._y},set:function(t){this._y=t,this.posData[1]=t,this.updateMatrix(),this._shadow&&(this.retinueShadowFix?this._shadow.y=t+this.retinueShadowFix.y+2:this._shadow.y=t+2)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this._z},set:function(t){this._z=t,this.posData[2]=t,this.updateMatrix(),this._shadow&&(this.retinueShadowFix?this._shadow.z=t+this.retinueShadowFix.z:this._shadow.z=t)},enumerable:!1,configurable:!0}),e.prototype.add=function(){this._shadow&&(this._shadow.visible=!0)},e.prototype.remove=function(){this._shadow&&(this._shadow.visible=!1)}}(y),function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v3Normal")},e.prototype.getVertexShaderString=function(){return"attribute vec3 v3Position;attribute vec3 v3Normal;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec3 vNormal;void main(void){   vNormal = vec3(v3Normal.x, v3Normal.y,v3Normal.z);   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"},e.prototype.getFragmentShaderString=function(){return"precision mediump float;\nuniform samplerCube s_texture;\nvarying vec3 vNormal;\nvoid main(void)\n{\nvec4 infoUv = textureCube(s_texture, vNormal);\ngl_FragColor = infoUv;\n}"},e.Sky_Shader="SkyShader",e}(nt)),Xi=function(t){function e(){var e=t.call(this)||this;return e.shader=V.getInstance().getProgram(ji.Sky_Shader),e.program=e.shader.program,e}return i(e,t),e.prototype.setObjUrl=function(t){var e=this;this.objurl=t,Wt.getInstance().getObjData(r.fileRoot+t,(function(t){e.objData=t}))},e.prototype.setCubeUrl=function(t){var e=this;I.getInstance().loadCubeTexture(t,(function(t){e.cubeTextList=t}))},e.prototype.update=function(){r.context3D.setProgram(this.program),r.context3D.setVcMatrix4fv(this.shader,"viewMatrix3D",r.viewMatrx3D.m),r.context3D.setVcMatrix4fv(this.shader,"camMatrix3D",r.cam3D.cameraMatrix.m),r.context3D.setVcMatrix4fv(this.shader,"posMatrix3D",this.posMatrix.m),this.cubeTextList&&r.context3D.setRenderTextureCube(this.program,"s_texture",this.cubeTextList[0],0),r.context3D.setVa(0,3,this.objData.vertexBuffer),r.context3D.setVa(1,3,this.objData.normalsBuffer),r.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)},e}(m),Wi=function(t){function e(){var e=t.call(this)||this;return e.uiMatrix=new d,e.uiMatrix.prependTranslation(0,0,600),e.uiMatrix.prependRotation(-15,a.X_AXIS),e.uiMatrix.prependRotation(0,a.Y_AXIS),e.uiViewMatrix=new d,e}return i(e,t),e.prototype.loadRes=function(t){var e=this;this.modelRes||(this.modelRes=new pi),this.modelRes.load(r.fileRoot+pe.getModelUrl(t),(function(){e.loadResComFinish()}))},e.prototype.loadResComFinish=function(){this.setObjUrl(this.modelRes.objUrl),this.setMaterialUrl(this.modelRes.materialUrl)},e.prototype.loadGroup=function(t){var e=this,i=new je;i.load(r.fileRoot+"model/"+t+".txt",(function(){e.loadPartRes(i)}))},e.prototype.loadPartRes=function(t){for(var e=0;e<t.dataAry.length;e++){var i=t.dataAry[e];i.types==Ot.SCENE_PARTICLE_TYPE||i.types==Ot.PREFAB_TYPE&&(this.setObjUrl(i.objUrl),this.setMaterialUrl(i.materialUrl,i.materialInfoArr))}},e.prototype.resize=function(){this.uiViewMatrix.identity(),this.uiViewMatrix.perspectiveFieldOfViewLH(1,1,500,5e3),this.uiViewMatrix.appendScale(1e3/r.stageWidth,1e3/r.stageHeight,1)},e.prototype.setCam=function(){r.context3D.setVcMatrix4fv(this.material.shader,"viewMatrix3D",this.uiViewMatrix.m),r.context3D.setVcMatrix4fv(this.material.shader,"camMatrix3D",this.uiMatrix.m)},e.prototype.update=function(){r.context3D.setWriteDepth(!0),r.context3D.setDepthTest(!0),t.prototype.update.call(this),r.context3D.setWriteDepth(!1),r.context3D.setDepthTest(!1)},e}(Gt),Yi=function(){function t(){this.drawNum=0,this.fpsStr=""}return t.update=function(){},t.prototype.getStr=function(){return t.fpsNowNum=Math.min(this.drawNum,600),this.fpsStr="Fps:"+String(t.fpsNowNum)+"-"+t.tipStr,this.fpsStr},t.addFps=0,t.fpsNowNum=0,t.tipStr="",t}(),Gi=function(){function t(){this.lastTime=0,this.cPos=new O(150,100)}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.init=function(t,e){var i=this;this.canvas2D=t,this.loadCav=e,this.fps=new Yi,this.canvasUi=this.canvas2D.getContext("2d"),this.loadCtx=this.loadCav.getContext("2d"),h.addFrameTick((function(){i.upData()}))},t.prototype.showLoadInfo=function(t){},t.prototype.removeShowLoad=function(){this.loadCav.parentElement&&this.loadCav.parentElement.removeChild(this.loadCav),t.showFps=!0},t.prototype.upData=function(){if(this.fps.drawNum++,!(this.lastTime>=h.getTimer()-1e3))if(this.lastTime=h.getTimer(),t.showFps){this.canvasUi.font="40px Helvetica";var e=this.canvasUi.measureText(this.fps.getStr()).width;this.canvas2D.width=e,this.canvas2D.height=30,this.canvasUi.clearRect(50,0,this.canvas2D.width-50,this.canvas2D.height),this.canvasUi.fillStyle="#000000",this.canvasUi.fillRect(50,0,this.canvas2D.width-50,this.canvas2D.height),this.canvasUi.font="30px Helvetica",this.canvasUi.fillStyle="#ffffff",this.canvasUi.textBaseline="top",this.canvasUi.textAlign="left",this.canvasUi.fillText(this.fps.getStr(),50,0),this.fps.drawNum=0}else this.canvasUi.clearRect(0,0,this.canvas2D.width,this.canvas2D.height)},t.prototype.makeXyzLine=function(){var t=new a(80,0,0),e=new a(0,70,0),i=new a(0,0,80),n=new d;n.appendRotation(r.cam3D.rotationY,a.Y_AXIS),n.appendRotation(r.cam3D.rotationX,a.X_AXIS),t=n.transformVector(t),e=n.transformVector(e),i=n.transformVector(i),this.drawLine(new O(0,0),new O(t.x,-t.y),"#ff0000"),this.drawLine(new O(0,0),new O(e.x,-e.y),"#00ff00"),this.drawLine(new O(0,0),new O(i.x,-i.y),"#0000ff"),this.canvasUi.font="12px Helvetica",this.canvasUi.fillStyle="#ff0000",this.canvasUi.fillText("x",t.x+this.cPos.x,-t.y+this.cPos.y),this.canvasUi.fillStyle="#00ff00",this.canvasUi.fillText("y",e.x+this.cPos.x,-e.y+this.cPos.y),this.canvasUi.fillStyle="#0000ff",this.canvasUi.fillText("z",i.x+this.cPos.x,-i.y+this.cPos.y)},t.prototype.drawLine=function(t,e,i){void 0===i&&(i="red"),this.canvasUi.beginPath(),this.canvasUi.lineWidth=2,this.canvasUi.strokeStyle=i,this.canvasUi.moveTo(t.x+this.cPos.x,t.y+this.cPos.y),this.canvasUi.lineTo(e.x+this.cPos.x,e.y+this.cPos.y),this.canvasUi.stroke()},t.prototype.resetSize=function(){this.cPos=new O(150,r.stageHeight-100)},t.showFps=!1,t}(),Zi=function(){},Hi=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2CubeTexST")},e.prototype.getVertexShaderString=function(){return"attribute vec3 v3Position;attribute vec2 v2CubeTexST;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(v2CubeTexST.x, v2CubeTexST.y);   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"},e.prototype.getFragmentShaderString=function(){return" precision mediump float;\nuniform sampler2D s_texture;\nuniform vec4 testconst;uniform vec4 testconst2;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\nvec4 test = vec4(0,0,0,1);\ntest.xyz = mix(vec3(1,1,1)*0.5,testconst.xyz,0.5);\ninfoUv.xyz = test.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}"},e.buildShader="BuildShader",e}(nt),qi=function(t){function e(){var e=t.call(this)||this;return e.name="Material_Batch_Anim_Shader",e}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"pos"),t.bindAttribLocation(this.program,1,"v2Uv"),t.bindAttribLocation(this.program,2,"boneID"),t.bindAttribLocation(this.program,3,"boneWeight");var e=this.paramAry[0],i=this.paramAry[1],a=this.paramAry[4],r=this.paramAry[5];e?(t.bindAttribLocation(this.program,4,"normal"),i&&(t.bindAttribLocation(this.program,5,"tangent"),t.bindAttribLocation(this.program,6,"bitangent"))):(a||r)&&t.bindAttribLocation(this.program,4,"normal")},e.prototype.getVertexShaderString=function(){var t=this.paramAry[0],e=this.paramAry[1],i=(this.paramAry[2],this.paramAry[3],this.paramAry[4]),a=this.paramAry[5],r=this.paramAry[6],n="precision mediump float;\nattribute vec4 pos;\nattribute vec3 v2Uv;\nattribute vec4 boneID;\nattribute vec4 boneWeight;\nvarying vec2 v0;\nuniform mat4 bone[19];\nuniform mat4 viewMatrix3D;\nuniform mat4 camMatrix3D;\nuniform mat4 posMatrixAry[6];\n";return i?n+="varying vec3 v2;\n":a?n+="uniform vec3 sunDirect;\nuniform vec3 sunColor;\nuniform vec3 ambientColor;\nvarying vec3 v2;\n":r||(n+="varying vec2 v2;\n"),t?(n+="attribute vec4 normal;\nuniform mat4 rotationMatrix3D;\nvarying vec3 v1;\n",n+=e?"varying mat3 v4;\n":"varying vec3 v4;\n",e&&(n+="attribute vec4 tangent;\nattribute vec4 bitangent;\n")):(i||a)&&(n+="attribute vec4 normal;\nuniform mat4 rotationMatrix3D;\n"),n+="void main(void){\nv0 = vec2(v2Uv.xy);\nvec4 vt0 = bone[int(boneID.x)] * pos * boneWeight.x;\nvt0 += bone[int(boneID.y)] * pos * boneWeight.y;\nvt0 += bone[int(boneID.z)] * pos * boneWeight.z;\nvt0 += bone[int(boneID.w)] * pos * boneWeight.w;\nvt0 = posMatrixAry[int(v2Uv.z)] * vt0;\n",t&&(n+="v1 = vec3(vt0.x,vt0.y,vt0.z);\n"),n+="vt0 = camMatrix3D * vt0;\nvt0 = viewMatrix3D * vt0;\ngl_Position = vt0;\n",t?n+=e?"vec4 vt2 = bone[int(boneID.x)] * tangent * boneWeight.x;\nvt2 += bone[int(boneID.y)] * tangent * boneWeight.y;\nvt2 += bone[int(boneID.z)] * tangent * boneWeight.z;\nvt2 += bone[int(boneID.w)] * tangent * boneWeight.w;\nvt2 = rotationMatrix3D * vt2;\nvt2.xyz = normalize(vt2.xyz);\nvec4 vt1 = bone[int(boneID.x)] * bitangent * boneWeight.x;\nvt1 += bone[int(boneID.y)] * bitangent * boneWeight.y;\nvt1 += bone[int(boneID.z)] * bitangent * boneWeight.z;\nvt1 += bone[int(boneID.w)] * bitangent * boneWeight.w;\nvt1 = rotationMatrix3D * vt1;\nvt1.xyz = normalize(vt1.xyz);\nvt0 = bone[int(boneID.x)] * normal * boneWeight.x;\nvt0 += bone[int(boneID.y)] * normal * boneWeight.y;\nvt0 += bone[int(boneID.z)] * normal * boneWeight.z;\nvt0 += bone[int(boneID.w)] * normal * boneWeight.w;\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\nv4 = mat3(vec3(vt2.x,vt2.y,vt2.z),vec3(vt1.x,vt1.y,vt1.z),vec3(vt0.x,vt0.y,vt0.z));\n":"vt0 = bone[int(boneID.x)] * normal * boneWeight.x;\nvt0 += bone[int(boneID.y)] * normal * boneWeight.y;\nvt0 += bone[int(boneID.z)] * normal * boneWeight.z;\nvt0 += bone[int(boneID.w)] * normal * boneWeight.w;\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\nv4 = vec3(vt0.x,vt0.y,vt0.z);\n":(i||a)&&(n+="vt0 = bone[int(boneID.x)] * normal * boneWeight.x;\nvt0 += bone[int(boneID.y)] * normal * boneWeight.y;\nvt0 += bone[int(boneID.z)] * normal * boneWeight.z;\nvt0 += bone[int(boneID.w)] * normal * boneWeight.w;\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\n"),i?n+="vec3 lpb = normalize(vec3(1.0,1.0,-1.0));\nfloat lp = min(0.0,dot(lpb,vec3(vt0.xyz)));\nlp = lp * 2.0 + 0.7;\nv2 = vec3(lp,lp,lp);\n":a?n+="float suncos = dot(vt0.xyz,sunDirect.xyz);\nsuncos = clamp(suncos,0.0,1.0);\nv2 = sunColor * suncos + ambientColor;":r||(n+="v2 = v2Uv;\n"),n+="}"},e.prototype.getFragmentShaderString=function(){return"uniform sampler2D s_texture1;\nuniform vec4 testconst;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz = testconst.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}"},e}(nt),Ki=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.lastTime=0,e}return i(e,t),e.prototype.setInitCurrentPos=function(t){this.currentPosAry=t,this.allTimeList=new Array;for(var e=0;e<t.length;e++)this.allTimeList.push(0)},e.prototype.add=function(){this.skillTrajectory.setCurrentPos(),this.directAry=new Array;for(var t=0,e=0;e<this.currentPosAry.length;e++){var i=new a;i.x=this.currentTargetPos.x-this.currentPosAry[e].x,i.y=this.currentTargetPos.y-this.currentPosAry[e].y,i.z=this.currentTargetPos.z-this.currentPosAry[e].z;var r=i.length;r>t&&(t=r,this.maxV3d=this.currentPosAry[e]),this.allTimeList[e]=r/this.speed,i.normalize(),i.scaleBy(this.speed),this.directAry.push(i)}this.alltime=t/this.speed,this.setAllData()},e.prototype.setAllData=function(){var t=o.float2int(this.alltime/33)+8;this.resultAry=new Array;for(var e=0;e<this.currentPosAry.length;e++){var i=new Array;this.resultAry.push(i);for(var a=this.directAry[e],r=0;r<6;r++)i.push([this.currentPosAry[e].x,this.currentPosAry[e].y,this.currentPosAry[e].z]);for(var n=0;n<t;n++){this.lastTime=33*n;var s,h,c=this.lastTime/this.allTimeList[e],l=c;if(c>=1?(l=0,s=[this.currentTargetPos.x,this.currentTargetPos.y,this.currentTargetPos.z]):(l-=l*l,l*=250,s=[a.x*this.lastTime+this.currentPosAry[e].x,a.y*this.lastTime+l+this.currentPosAry[e].y,a.z*this.lastTime+this.currentPosAry[e].z]),0==n)h=[0,1,0];else{var u=i[2*n-2];h=[s[0]-u[0],s[1]-u[1],s[2]-u[2]];var p=Math.sqrt(h[0]*h[0]+h[1]*h[1]+h[2]*h[2]);h[0]/=p,h[1]/=p,h[2]/=p}i.push(s,h)}}},e.prototype.update=function(t){if(this.time=t,this.lastTime+=t,this.hasReached)return this.endTime+=t,void(this.endTime>200&&this.applyArrive());this.skillTrajectory.setCurrentPos();for(var e=0;e<this.currentPosAry.length;e++){var i=this.lastTime/this.allTimeList[e];i-=i*i,i*=250;var r=this.currentPosAry[e];if(this._currentDirect.x=this.currentTargetPos.x-r.x,this._currentDirect.y=this.currentTargetPos.y-r.y,this._currentDirect.z=this.currentTargetPos.z-r.z,this._currentDirect.normalize(),this._currentDirect.scaleBy(this.speed),this.maxV3d==r&&(this.setRotationMatrix(this.currentTargetPos.subtract(r)),0==this._currentDirect.length))return void this.arrive();var n=this._currentDirect.length*this.time;if(!this.hasReached){var s=a.distance(r,this.currentTargetPos);r.x+=this._currentDirect.x*this.time,r.y+=this._currentDirect.y*this.time,r.z+=this._currentDirect.z*this.time,r.w=i}this.maxV3d==r&&n>s&&this.arrive()}this.currentPos.setTo(this.currentPosAry[0].x,this.currentPosAry[0].y+this.currentPosAry[0].w,this.currentPosAry[0].z)},e.prototype.setData=function(e,i,a,r,n){t.prototype.setData.call(this,e,i,a,r,n,null),this.skillMul=e},e.prototype.applyData=function(t){for(var e=0;e<t.length;e++)t[e].setTo(this.currentPosAry[e].x,this.currentPosAry[e].y+this.currentPosAry[e].w,this.currentPosAry[e].z)},e.prototype.reset=function(){t.prototype.reset.call(this),this.lastTime=0},e}(Fe),Qi=function(){function t(){}return t.LEFT="left",t.CENTER="center",t.RIGHT="right",t.TOP="top",t.MIDDLE="middle",t.BOTTOM="bottom",t}(),Ji=function(){function t(){}return t.A=65,t.B=66,t.C=67,t.D=68,t.E=69,t.F=70,t.G=71,t.H=72,t.I=73,t.J=74,t.K=75,t.L=76,t.M=77,t.N=78,t.O=79,t.P=80,t.Q=81,t.R=82,t.S=83,t.T=84,t.U=85,t.V=86,t.W=87,t.X=88,t.Y=89,t.Z=90,t.Left=37,t.Up=38,t.Right=39,t.Down=40,t.Delete=46,t.F1=112,t.F2=113,t}(),$i=function(t,e){this.radius=t,this.height=e},ta=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.setWeaponByAvatar=function(t,e){void 0===e&&(e=""),this.addPart(Vi.WEAPON_PART,Vi.WEAPON_DEFAULT_SLOT,this.getSceneCharWeaponUrl(t,e))},e.prototype.setWingByID=function(t){this._wingDisplay||(this._wingDisplay=new Ci),this._wingDisplay.setRoleUrl(pe.getRoleUrl(t)),this._wingDisplay.setBind(this,Vi.WING_SLOT),Re.getInstance().addMovieDisplay(this._wingDisplay)},e.prototype.setMountById=function(t){this.mountChar||(this.mountChar=new Ei),this.mountChar.setRoleUrl(pe.getRoleUrl(t)),this.setBind(this.mountChar,Vi.MOUNT_SLOT),Re.getInstance().addMovieDisplay(this.mountChar),this.isMount=!0},e}(Vi),ea=function(){function t(){this.addModelChar()}return t.prototype.addModelChar=function(){var t=new ta;t.setRoleUrl(pe.getRoleUrl(50003)),t.setWingByID(901),t.setMountById(4103),t.setWeaponByAvatar(50011),t.play(Ii.STAND_MOUNT),Re.getInstance().addMovieDisplay(t)},t}(),ia=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.onMeshLoaded=function(){t.prototype.onMeshLoaded.call(this),this.loadFinishFun&&this.loadFinishFun()},e.prototype.changeAction=function(t){this.curentAction=this._defaultAction,this.changeActionFun&&this.changeActionFun(t)},e.prototype.setWeaponByAvatar=function(t,e){},e}(Vi),aa=function(){function t(){this.skillFileName="jichu_1",this.charIdstr=50001,this.weaponNum=50011,this.skipId=1,this.skillEffectItem=["skill_01","skill_02","skill_03","m_skill_01","m_skill_02","m_skill_03"],this.initSkillPlay()}return t.prototype.initSkillPlay=function(){o.getUrlParam("id")?(this.makeUrlParam(),this.makeMainChar()):window.location.href="index.html?id="+o.random(10)},t.prototype.makeUrlParam=function(){this.paramId=Number(o.getUrlParam("id")),isNaN(this.paramId)&&(this.paramId=0),this.paramId=Math.floor(this.paramId),this.paramId=this.paramId%6+1,(this.paramId<=0||this.paramId>6)&&(this.paramId=1),3!=this.paramId&&4!=this.paramId||this.makeAttackChar(),this.skillFileName="jichu_"+Math.ceil(this.paramId/2),this.charIdstr=5e3+this.paramId,this.weaponNum=50010+this.paramId},t.prototype.makeAttackChar=function(){var t=new Vi;t.z=100,t.setRoleUrl(pe.getRoleUrl(7001)),Re.getInstance().addMovieDisplay(t),this.attackTarget=t,this.attackTarget.x=o.random(50)+30,this.attackTarget.z=o.random(50)+30},t.prototype.makeMainChar=function(){var t=this;$e.getInstance().preLoadSkill(pe.getSkillUrl(this.skillFileName));var e=new ia;e.setRoleUrl(pe.getRoleUrl(this.charIdstr)),Re.getInstance().addMovieDisplay(e),e.setWeaponByAvatar(this.weaponNum),this.mainChar=e,e.changeActionFun=function(){t.playSkill()},e.loadFinishFun=function(){ye.getInstance().loadSkillRes(r.fileRoot+pe.getSkillUrl(t.skillFileName),(function(e){$e.getInstance().preLoadSkill(pe.getSkillUrl(t.skillFileName)),h.addTimeOut(1e3,(function(){t.playSkill()})),console.log(h.getTimer())}))}},t.prototype.playSkill=function(){var t=this.skillEffectItem[this.skipId%this.skillEffectItem.length],e=$e.getInstance().getSkill(pe.getSkillUrl(this.skillFileName),t);if(e.keyAry){if(this.textPlaySkillFun&&(h.removeTimeTick(this.textPlaySkillFun),this.textPlaySkillFun=null),e&&(e.reset(),e.isDeath=!1),3==this.paramId||4==this.paramId){if("m_skill_01"==t)e.configFixEffect(this.mainChar);else{this.attackTarget.x=o.random(50)+30,this.attackTarget.z=o.random(50)+30;var i=new a(this.attackTarget.x,this.attackTarget.y,this.attackTarget.z),r=new Array;r.push(i),e.configFixEffect(this.mainChar,null,r)}this.mainChar.watch(this.attackTarget,!0)}else e.configFixEffect(this.mainChar);this.mainChar.playSkill(e),this.skipId++}},t}(),ra=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"u2Texture")},e.prototype.getVertexShaderString=function(){return"attribute vec3 v3Position;attribute vec2 u2Texture;uniform mat4 vpMatrix3D;uniform mat4 posMatrix3D;varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(u2Texture.x, u2Texture.y);   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = vpMatrix3D * vt0;   gl_Position = vt0;}"},e.prototype.getFragmentShaderString=function(){return"precision mediump float;\nuniform sampler2D s_texture;\nvarying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ngl_FragColor = vec4(gl_FragCoord.z,gl_FragCoord.z,0.1236,1);\n}"},e.BaseShadowShader="BaseShadowShader",e}(nt),na=function(){function t(){this.sunRotationX=-90,this.sunRotationY=0,this.sunDistens100=200,this.isNeedMake=!0,this._visible=!0}return t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.getFBO=function(){gi.fw=1024,gi.fh=1024,this.renderContext=r.context3D.renderContext;var t=r.context3D.renderContext,e=new gi;return e.texture=t.createTexture(),t.bindTexture(Laya.WebGLContext.TEXTURE_2D,e.texture),t.texImage2D(Laya.WebGLContext.TEXTURE_2D,0,Laya.WebGLContext.RGBA,gi.fw,gi.fh,0,Laya.WebGLContext.RGBA,Laya.WebGLContext.UNSIGNED_BYTE,null),t.texParameteri(Laya.WebGLContext.TEXTURE_2D,Laya.WebGLContext.TEXTURE_MIN_FILTER,Laya.WebGLContext.LINEAR),t.texParameteri(Laya.WebGLContext.TEXTURE_2D,Laya.WebGLContext.TEXTURE_MAG_FILTER,Laya.WebGLContext.LINEAR),e.frameBuffer=t.createFramebuffer(),e.depthBuffer=t.createRenderbuffer(),t.bindRenderbuffer(Laya.WebGLContext.RENDERBUFFER,e.depthBuffer),t.renderbufferStorage(Laya.WebGLContext.RENDERBUFFER,Laya.WebGLContext.DEPTH_COMPONENT16,gi.fw,gi.fh),e},t.prototype.updateDepthTexture=function(t){var e=r.context3D.renderContext;e.bindFramebuffer(Laya.WebGLContext.FRAMEBUFFER,t.frameBuffer),e.framebufferTexture2D(Laya.WebGLContext.FRAMEBUFFER,Laya.WebGLContext.COLOR_ATTACHMENT0,Laya.WebGLContext.TEXTURE_2D,t.texture,0),e.framebufferRenderbuffer(Laya.WebGLContext.FRAMEBUFFER,Laya.WebGLContext.DEPTH_ATTACHMENT,Laya.WebGLContext.RENDERBUFFER,t.depthBuffer)},t.prototype.makeUseShadowView=function(){r.viewMatrx3D.appendTranslation(1,1,1),r.viewMatrx3D.appendScale(.5,.5,.5),_e.updateVp(),t.shadowViewMatx3D=r.vpMatrix.clone()},t.prototype.setShowdowVisible=function(t){this._visible=t,console.log("开关阴影",this._visible)},t.prototype.updateDepth=function(e){if(t.getInstance().sunRotationY=45,e.fbo||(e.fbo=this.getFBO()),this._visible){var i=r.vpMatrix.clone(),n=r.viewMatrx3D.clone();this.updateDepthTexture(e.fbo),this.renderContext.viewport(0,0,gi.fw,gi.fh),this.renderContext.clearColor(1,1,1,1),this.renderContext.clearDepth(1),this.renderContext.enable(Laya.WebGLContext.DEPTH_TEST),this.renderContext.depthMask(!0),this.renderContext.frontFace(Laya.WebGLContext.CW),this.renderContext.clear(Laya.WebGLContext.COLOR_BUFFER_BIT|Laya.WebGLContext.DEPTH_BUFFER_BIT),r.context3D.setWriteDepth(!0),r.context3D.setDepthTest(!0),r.viewMatrx3D.identity(),r.viewMatrx3D.appendScale(.002,.002,1/600),r.cam3D.cameraMatrix.identity(),r.cam3D.cameraMatrix.prependRotation(this.sunRotationX,a.X_AXIS),r.cam3D.cameraMatrix.prependRotation(this.sunRotationY,a.Y_AXIS),r.cam3D.cameraMatrix.prependTranslation(-r.focus3D.x,0,-r.focus3D.z);var s=new a(0,0,-1),o=new d;o.appendRotation(-this.sunRotationX,a.X_AXIS),o.appendRotation(-this.sunRotationY,a.Y_AXIS),(s=o.transformVector(s)).normalize(),e.light.sunDirect[0]=s.x,e.light.sunDirect[1]=s.y,e.light.sunDirect[2]=s.z,_e.updateVp(),t.shadowViewMatx3D=r.vpMatrix.clone(),r.context3D.setProgram(null);for(var h=0;h<e.displaySpriteList.length;h++){var c=e.displaySpriteList[h];this.drawTempSprite(c.objData,c.posMatrix)}for(var l=0;l<e.displayList.length;l++){var u=e.displayList[l];if(u&&u.needScanShadow)for(var p=0;p<u.groupItem.length;p++)this.drawTempSprite(u.groupItem[p].objData,u.posMatrix)}var f=r.context3D.renderContext;f.bindFramebuffer(Laya.WebGLContext.FRAMEBUFFER,null),f.bindTexture(Laya.WebGLContext.TEXTURE_2D,null),f.bindRenderbuffer(Laya.WebGLContext.RENDERBUFFER,null),this.makeUseShadowView(),r.context3D.resetSize(r.stageWidth,r.stageHeight),r.vpMatrix=i,r.viewMatrx3D=n}},t.prototype.drawTempSprite=function(t,e){V.getInstance().registe(ra.BaseShadowShader,new ra);var i=V.getInstance().getProgram(ra.BaseShadowShader);if(!this._uvTextureRes){var a=M.getInstance().getContext2D(128,128,!1);a.fillStyle="rgb(255,0,255)",a.fillRect(0,0,128,128),this._uvTextureRes=I.getInstance().getCanvasTexture(a)}r.context3D.setProgram(i.program),r.context3D.setVcMatrix4fv(i,"vpMatrix3D",r.vpMatrix.m),r.context3D.setVcMatrix4fv(i,"posMatrix3D",e.m);r.context3D.pushVa(t.vertexBuffer);r.context3D.setVaOffset(0,3,t.stride,0),r.context3D.setVaOffset(1,2,t.stride,t.uvsOffsets),r.context3D.setRenderTexture(i,"s_texture",this._uvTextureRes.texture,0),r.context3D.drawCall(t.indexBuffer,t.treNum)},t}(),sa=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.binLocation=function(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2CubeTexST"),t.bindAttribLocation(this.program,2,"v3Normal")},e.prototype.getVertexShaderString=function(){return"attribute vec3 v3Position;attribute vec2 v2CubeTexST;varying vec2 v0;varying vec3 v_PositionFromLight;varying vec3 v2;varying float cosTheta;varying float onsunFace;varying vec3 ambientColorF;attribute vec3 v3Normal;uniform vec3 sunDirect;uniform vec3 sunColor;uniform vec3 ambientColor;uniform mat4 vpMatrix3D;uniform mat4 posMatrix3D;uniform mat4 shadowViewMatx3D;uniform mat3 rotationMatrix3D;void main(void){;ambientColorF =ambientColor;v0 = vec2(v2CubeTexST.x, v2CubeTexST.y); vec4 vt0= vec4(v3Position, 1.0);vt0 = posMatrix3D * vt0;vt0 = vpMatrix3D * vt0;   vec4 vt1= vec4(v3Position, 1.0);   vt1 = posMatrix3D * vt1;   vt1 = shadowViewMatx3D * vt1;   v_PositionFromLight = vec3(vt1.x, vt1.y,vt1.z);vec3 n = rotationMatrix3D * v3Normal;float suncos = dot(n.xyz,sunDirect.xyz);onsunFace = suncos;cosTheta =1.0-abs(suncos);suncos = clamp(suncos,0.0,1.0);v2 = sunColor * suncos ;gl_Position = vt0;}"},e.prototype.getFragmentShaderString=function(){return"precision mediump float;\nuniform sampler2D fs0;\nuniform sampler2D fs1;\nvarying vec2 v0;\nvarying vec3 v_PositionFromLight;\nvarying vec3 v2;varying float cosTheta;varying float onsunFace;varying vec3 ambientColorF;void main(void)\n{\nvec4 ft5 = texture2D(fs1, v_PositionFromLight.xy); float  bias  = 0.01*cosTheta; bias = clamp(bias, 0.003, 0.01); float visibility = (v_PositionFromLight.z > ft5.x + bias) ? 0.9 : 1.0;\nvisibility =onsunFace<0.0?1.0:visibility ; vec4 ft0 = texture2D(fs0, v0); vec4 ft1 = vec4(v2.xyz, 1.0); vec4 ft2 = vec4(1, 1, 1, 1); float isalp = (ft5.z >0.1254) ? 1.0 : 0.2;\ngl_FragColor = vec4((ft1.xyz*visibility+ambientColorF.xyz)*ft0.rgb , 1.0); }"},e.DirectShadowDisplay3DShader="DirectShadowDisplay3DShader",e}(nt),oa=function(t){function e(){var e=t.call(this)||this;return e.needScanShadow=!0,e.nrmFlag=0,e.initData(),e}return i(e,t),e.prototype.initData=function(){V.getInstance().registe(sa.DirectShadowDisplay3DShader,new sa),this.modelShder=V.getInstance().getProgram(sa.DirectShadowDisplay3DShader)},e.prototype.setObjUrl=function(t){var e=this;Wt.getInstance().getObjData(r.fileRoot+t,(function(t){e.objData=t}))},e.prototype.update=function(){50==this.y&&console.log("here");for(var t=0;t<this.groupItem.length;t++)this.drawTemp(this.groupItem[t])},e.prototype.drawTemp=function(t){if(this._scene.fbo&&na.shadowViewMatx3D){var e=t.objData,i=this.modelShder;e&&e.indexBuffer&&this._uvTextureRes&&(r.context3D.setProgram(i.program),r.context3D.setVc3fv(i,"sunDirect",this._scene.light.sunDirect),r.context3D.setVc3fv(i,"sunColor",this._scene.light.sunColor),r.context3D.setVc3fv(i,"ambientColor",this._scene.light.ambientColor),r.context3D.setVcMatrix4fv(i,"shadowViewMatx3D",na.shadowViewMatx3D.m),r.context3D.setVcMatrix3fv(i,"rotationMatrix3D",t._rotationData),r.context3D.setVcMatrix4fv(i,"vpMatrix3D",r.vpMatrix.m),r.context3D.setVcMatrix4fv(i,"posMatrix3D",this.posMatrix.m),r.context3D.renderContext.bindBuffer(Laya.WebGLContext.ARRAY_BUFFER,e.vertexBuffer),r.context3D.setVaOffset(0,3,e.stride,0),r.context3D.setVaOffset(1,2,e.stride,e.uvsOffsets),r.context3D.setVaOffset(2,3,e.stride,e.normalsOffsets),r.context3D.setRenderTexture(i,"fs0",this._uvTextureRes.texture,0),r.context3D.setRenderTexture(i,"fs1",this._scene.fbo.texture,1),r.context3D.drawCall(e.indexBuffer,e.treNum))}},e.prototype.updateRotationMatrix=function(){t.prototype.updateRotationMatrix.call(this);for(var e=0;this.groupItem&&e<this.groupItem.length;e++){var i=this.groupItem[e];i&&i._rotationData&&i._rotationData&&this._rotationMatrix.getRotaion(i._rotationData)}},e.prototype.setPicUrl=function(t){var e=this;I.getInstance().getTexture(r.fileRoot+t,(function(t){e._uvTextureRes=t}))},e.prototype.setModelById=function(t){var e=this;this.groupItem=new Array,We.getInstance().getGroupData(r.fileRoot+pe.getModelUrl(t),(function(t){for(var i=0;i<t.dataAry.length;i++){var a=t.dataAry[i];if(a.types==Ot.PREFAB_TYPE){var r=new Gt;r.setObjUrl(a.objUrl),r._rotationData=new Float32Array(9),e.groupItem.push(r),a.materialInfoArr&&a.materialInfoArr.length?e.setPicUrl(a.materialInfoArr[0].url):console.log("没有指定贴图")}}e.updateRotationMatrix()}))},e}(Gt);t.AnimData=Vt,t.AnimManager=Jt,t.AstarUtil=Se,t.AxisMove=J,t.AxisRotaion=Q,t.Base64=D,t.BaseAnim=q,t.BaseDiplay3dSprite=Ui,t.BaseEvent=U,t.BaseLaya3dSprite=Pi,t.BaseProcessor=Li,t.BaseRes=Ot,t.BitMapData=Zt,t.BoneSocketData=ie,t.BuildShader=Hi,t.Calculation=Te,t.Camera3D=xi,t.CanvasPostionModel=Di,t.CapsuleVo=$i,t.CharAction=Ii,t.CharModelShow=ea,t.CharSkillPlayModel=aa,t.Circle=ge,t.CollisionVo=jt,t.ColorTransition=j,t.ColorType=Ni,t.CombineParticle=Mt,t.CombineParticleData=kt,t.ConstItem=E,t.Context3D=vi,t.Curve=X,t.Dictionary=Et,t.DirectShadowDisplay3DSprite=oa,t.Display3D=m,t.Display3DBallPartilce=dt,t.Display3DBallShader=ct,t.Display3DBonePartilce=Ft,t.Display3DFacetParticle=ht,t.Display3DFacetShader=st,t.Display3DFollowLocusPartilce=Pt,t.Display3DFollowLocusShader=St,t.Display3DFollowPartilce=Tt,t.Display3DFollowShader=wt,t.Display3DLocusBallPartilce=gt,t.Display3DLocusPartilce=mt,t.Display3DLocusShader=ft,t.Display3DModelObjParticle=bt,t.Display3DModelPartilce=xt,t.Display3DParticle=rt,t.Display3DShadowShader=Ne,t.Display3DSky=Xi,t.Display3DSprite=Gt,t.Display3DUISprite=Wi,t.Display3dBatchMovie=Oi,t.Display3dModelAnimParticle=Dt,t.Display3dMovie=Ye,t.Display3dShadow=ke,t.DynamicBaseConstItem=g,t.DynamicBaseTexItem=_,t.DynamicConstItem=Y,t.DynamicTexItem=W,t.Engine=u,t.EventDispatcher=f,t.FpsStage=Gi,t.GC=v,t.Groundposition=Pe,t.GroupDataManager=We,t.GroupRes=je,t.KeyFrame=H,t.KeyboardType=Ji,t.LayaInsideSprite=yi,t.LayaOverride2dEngine=Ai,t.LayaOverride2dParticleManager=ii,t.LayaOverride2dSceneManager=ci,t.LayaOverride2dSkillManager=si,t.LayaOverrideGroupDataManager=hi,t.LayaScene2dInit=Mi,t.LayaSceneBaseChar=Si,t.LayaSceneChar=Bi,t.LightProbeManager=Ie,t.LightVo=ui,t.LineDisplayShader=xe,t.LineDisplaySprite=be,t.LoadManager=w,t.Material=z,t.MaterialAnimShader=Bt,t.MaterialBaseParam=F,t.MaterialBatchAnimShader=qi,t.MaterialManager=N,t.MaterialParam=G,t.MaterialShader=Yt,t.MathClass=_e,t.MathUtil=Me,t.Matrix3D=d,t.MeshData=Lt,t.MeshDataManager=ae,t.ModelRes=pi,t.ModelSceneChar=ta,t.ModuleEventManager=Ri,t.MountChar=Ei,t.ObjData=L,t.ObjDataManager=Wt,t.Object3D=y,t.Override2dEngine=wi,t.OverrideEngine=bi,t.OverrideSceneManager=ei,t.OverrideSkill=ni,t.OverrideSkillFixEffect=ai,t.OverrideSkillTrajectory=ri,t.Pan3dByteArray=s,t.ParticleBallData=pt,t.ParticleBallGpuData=ut,t.ParticleBoneData=Nt,t.ParticleData=at,t.ParticleFacetData=ot,t.ParticleFollowData=At,t.ParticleFollowLocusData=It,t.ParticleGpuData=lt,t.ParticleLocusData=yt,t.ParticleLocusballData=vt,t.ParticleManager=Ut,t.ParticleModelData=_t,t.PathManager=Ee,t.Processor=Fi,t.ProgramManager=V,t.QuadTreeNode=me,t.Quaternion=p,t.Rectangle=Ht,t.ResCount=x,t.ResGC=b,t.ResManager=ye,t.RoleRes=re,t.RoleResLow=li,t.ScaleAnim=tt,t.ScaleChange=$,t.ScaleNoise=et,t.SceneBaseChar=Ci,t.SceneChar=Vi,t.SceneManager=Re,t.SceneQuadTree=De,t.SceneRes=de,t.Scene_data=r,t.SelfRotation=K,t.Shader3D=nt,t.Shadow=Ue,t.ShadowManager=Oe,t.ShadowModel=na,t.Skill=Qe,t.SkillData=Je,t.SkillEffect=Ge,t.SkillFixEffect=He,t.SkillKey=ze,t.SkillKeyVo=ne,t.SkillManager=$e,t.SkillMulPath=Ki,t.SkillMulTrajectory=qe,t.SkillPath=Fe,t.SkillRes=ue,t.SkillSceneChar=ia,t.SkillSinPath=Le,t.SkillTrajectory=Ve,t.SkillVo=ce,t.SkinMesh=ee,t.SkyShader=ji,t.SoundManager=Ke,t.TerrainDisplay3DShader=qt,t.TerrainDisplay3DSprite=Qt,t.TestTriangle=zi,t.TexItem=C,t.TextAlign=Qi,t.TextureCube=Zi,t.TextureManager=I,t.TextureRes=P,t.TimeLine=it,t.TimeLineData=Z,t.TimeUtil=h,t.UIManager=M,t.UnitFunction=pe,t.Util=o,t.Vector2D=O,t.Vector3D=a,t.ViewFrustum=we,t.mainpan3d=Ti}(this.tl3d=this.tl3d||{});