!function(t){"use strict";class e extends Laya.BufferStateBase{constructor(){super()}applyVertexBuffer(t){if(Laya.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var e=Laya.LayaGL.instance,i=t.vertexDeclaration,a=i._shaderValues.getData();for(var s in this.vertexDeclaration=i,t.bind(),a){var r=parseInt(s),n=a[s];e.enableVertexAttribArray(r),e.vertexAttribPointer(r,n[0],n[1],!!n[2],n[3],n[4])}}applyVertexBuffers(t){if(Laya.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";Laya.LayaGL.instance;for(var e=0,i=t.length;e<i;e++){var a=t[e];a.vertexDeclaration;a.bind()}}applyIndexBuffer(t){if(Laya.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==t&&(t._bindForVAO(),this._bindedIndexBuffer=t)}}var i;(i=t.IndexFormat||(t.IndexFormat={}))[i.UInt8=0]="UInt8",i[i.UInt16=1]="UInt16",i[i.UInt32=2]="UInt32";class a extends Laya.Buffer{constructor(e,i,a=35044,s=!1){super(),this._indexType=e;let r=Laya.LayaGL.instance;switch(this._indexCount=i,this._bufferUsage=a,this._bufferType=r.ELEMENT_ARRAY_BUFFER,this._canRead=s,e){case t.IndexFormat.UInt32:this._indexTypeByteCount=4;break;case t.IndexFormat.UInt16:this._indexTypeByteCount=2;break;case t.IndexFormat.UInt8:this._indexTypeByteCount=1;break;default:throw new Error("unidentification index type.")}var n=this._indexTypeByteCount*i,h=Laya.BufferStateBase._curBindedBufferState;if(this._byteLength=n,h?h._bindedIndexBuffer===this?r.bufferData(this._bufferType,n,this._bufferUsage):(h.unBind(),this.bind(),r.bufferData(this._bufferType,n,this._bufferUsage),h.bind()):(this.bind(),r.bufferData(this._bufferType,n,this._bufferUsage)),s)switch(e){case t.IndexFormat.UInt32:this._buffer=new Uint32Array(i);break;case t.IndexFormat.UInt16:this._buffer=new Uint16Array(i);break;case t.IndexFormat.UInt8:this._buffer=new Uint8Array(i)}}get indexType(){return this._indexType}get indexTypeByteCount(){return this._indexTypeByteCount}get indexCount(){return this._indexCount}get canRead(){return this._canRead}_bindForVAO(){if(!Laya.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must bind current BufferState.";{let t=Laya.LayaGL.instance;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._glBuffer)}}bind(){if(Laya.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must unbind current BufferState.";if(Laya.Buffer._bindedIndexBuffer!==this._glBuffer){let t=Laya.LayaGL.instance;return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._glBuffer),Laya.Buffer._bindedIndexBuffer=this._glBuffer,!0}return!1}setData(e,i=0,a=0,s=4294967295){var r=this._indexTypeByteCount;if(0!==a||4294967295!==s)switch(this._indexType){case t.IndexFormat.UInt32:e=new Uint32Array(e.buffer,a*r,s);break;case t.IndexFormat.UInt16:e=new Uint16Array(e.buffer,a*r,s);break;case t.IndexFormat.UInt8:e=new Uint8Array(e.buffer,a*r,s)}let n=Laya.LayaGL.instance;var h=Laya.BufferStateBase._curBindedBufferState;if(h?h._bindedIndexBuffer===this?n.bufferSubData(this._bufferType,i*r,e):(h.unBind(),this.bind(),n.bufferSubData(this._bufferType,i*r,e),h.bind()):(this.bind(),n.bufferSubData(this._bufferType,i*r,e)),this._canRead)if(0!==i||0!==a||4294967295!==s){var o=this._buffer.length-i;s>o&&(s=o);for(var l=0;l<s;l++)this._buffer[i+l]=e[l]}else this._buffer=e}getData(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}destroy(){super.destroy(),this._buffer=null}}class s{constructor(){}static isZero(t){return Math.abs(t)<s.zeroTolerance}static nearEqual(t,e){return!!s.isZero(t-e)}static fastInvSqrt(t){return s.isZero(t)?t:1/Math.sqrt(t)}}s.zeroTolerance=1e-6,s.MaxValue=340282347e30,s.MinValue=-340282347e30,s.Deg2Rad=Math.PI/180;class r{constructor(t=0,e=0){this.x=t,this.y=e}setValue(t,e){this.x=t,this.y=e}static scale(t,e,i){i.x=t.x*e,i.y=t.y*e}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1]}cloneTo(t){var e=t;e.x=this.x,e.y=this.y}static dot(t,e){return t.x*e.x+t.y*e.y}static normalize(t,e){var i=t.x,a=t.y,s=i*i+a*a;s>0&&(s=1/Math.sqrt(s),e.x=i*s,e.y=a*s)}static scalarLength(t){var e=t.x,i=t.y;return Math.sqrt(e*e+i*i)}clone(){var t=new r;return this.cloneTo(t),t}forNativeElement(t=null){t?(this.elements=t,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1)}static rewriteNumProperty(t,e,i){Object.defineProperty(t,e,{get:function(){return this.elements[i]},set:function(t){this.elements[i]=t}})}}r.ZERO=new r(0,0),r.ONE=new r(1,1);class n{constructor(t=0,e=0,i=0,a=0){this.x=t,this.y=e,this.z=i,this.w=a}setValue(t,e,i,a){this.x=t,this.y=e,this.z=i,this.w=a}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3]}cloneTo(t){var e=t;e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w}clone(){var t=new n;return this.cloneTo(t),t}static lerp(t,e,i,a){var s=t.x,r=t.y,n=t.z,h=t.w;a.x=s+i*(e.x-s),a.y=r+i*(e.y-r),a.z=n+i*(e.z-n),a.w=h+i*(e.w-h)}static transformByM4x4(t,e,i){var a=t.x,s=t.y,r=t.z,n=t.w,h=e.elements;i.x=a*h[0]+s*h[4]+r*h[8]+n*h[12],i.y=a*h[1]+s*h[5]+r*h[9]+n*h[13],i.z=a*h[2]+s*h[6]+r*h[10]+n*h[14],i.w=a*h[3]+s*h[7]+r*h[11]+n*h[15]}static equals(t,e){return s.nearEqual(Math.abs(t.x),Math.abs(e.x))&&s.nearEqual(Math.abs(t.y),Math.abs(e.y))&&s.nearEqual(Math.abs(t.z),Math.abs(e.z))&&s.nearEqual(Math.abs(t.w),Math.abs(e.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(t,e){var i=t.length();if(i>0){var a=1/i;e.x=t.x*a,e.y=t.y*a,e.z=t.z*a,e.w=t.w*a}}static add(t,e,i){i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i.w=t.w+e.w}static subtract(t,e,i){i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i.w=t.w-e.w}static multiply(t,e,i){i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z,i.w=t.w*e.w}static scale(t,e,i){i.x=t.x*e,i.y=t.y*e,i.z=t.z*e,i.w=t.w*e}static Clamp(t,e,i,a){var s=t.x,r=t.y,n=t.z,h=t.w,o=e.x,l=e.y,c=e.z,d=e.w,u=i.x,m=i.y,p=i.z,y=i.w;s=(s=s>u?u:s)<o?o:s,r=(r=r>m?m:r)<l?l:r,n=(n=n>p?p:n)<c?c:n,h=(h=h>y?y:h)<d?d:h,a.x=s,a.y=r,a.z=n,a.w=h}static distanceSquared(t,e){var i=t.x-e.x,a=t.y-e.y,s=t.z-e.z,r=t.w-e.w;return i*i+a*a+s*s+r*r}static distance(t,e){var i=t.x-e.x,a=t.y-e.y,s=t.z-e.z,r=t.w-e.w;return Math.sqrt(i*i+a*a+s*s+r*r)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static min(t,e,i){i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i.z=Math.min(t.z,e.z),i.w=Math.min(t.w,e.w)}static max(t,e,i){i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i.z=Math.max(t.z,e.z),i.w=Math.max(t.w,e.w)}forNativeElement(t=null){t?(this.elements=t,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1),r.rewriteNumProperty(this,"z",2),r.rewriteNumProperty(this,"w",3)}}n.ZERO=new n,n.ONE=new n(1,1,1,1),n.UnitX=new n(1,0,0,0),n.UnitY=new n(0,1,0,0),n.UnitZ=new n(0,0,1,0),n.UnitW=new n(0,0,0,1);class h{constructor(t=0,e=0,i=0,a=null){this.x=t,this.y=e,this.z=i}static distanceSquared(t,e){var i=t.x-e.x,a=t.y-e.y,s=t.z-e.z;return i*i+a*a+s*s}static distance(t,e){var i=t.x-e.x,a=t.y-e.y,s=t.z-e.z;return Math.sqrt(i*i+a*a+s*s)}static min(t,e,i){i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i.z=Math.min(t.z,e.z)}static max(t,e,i){i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i.z=Math.max(t.z,e.z)}static transformQuat(t,e,i){var a=t.x,s=t.y,r=t.z,n=e.x,h=e.y,o=e.z,l=e.w,c=l*a+h*r-o*s,d=l*s+o*a-n*r,u=l*r+n*s-h*a,m=-n*a-h*s-o*r;i.x=c*l+m*-n+d*-o-u*-h,i.y=d*l+m*-h+u*-n-c*-o,i.z=u*l+m*-o+c*-h-d*-n}static scalarLength(t){var e=t.x,i=t.y,a=t.z;return Math.sqrt(e*e+i*i+a*a)}static scalarLengthSquared(t){var e=t.x,i=t.y,a=t.z;return e*e+i*i+a*a}static normalize(t,e){var i=t.x,a=t.y,s=t.z,r=i*i+a*a+s*s;r>0&&(r=1/Math.sqrt(r),e.x=i*r,e.y=a*r,e.z=s*r)}static multiply(t,e,i){i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z}static scale(t,e,i){i.x=t.x*e,i.y=t.y*e,i.z=t.z*e}static lerp(t,e,i,a){var s=t.x,r=t.y,n=t.z;a.x=s+i*(e.x-s),a.y=r+i*(e.y-r),a.z=n+i*(e.z-n)}static transformV3ToV3(t,e,i){var a=h._tempVector4;h.transformV3ToV4(t,e,a),i.x=a.x,i.y=a.y,i.z=a.z}static transformV3ToV4(t,e,i){var a=t.x,s=t.y,r=t.z,n=e.elements;i.x=a*n[0]+s*n[4]+r*n[8]+n[12],i.y=a*n[1]+s*n[5]+r*n[9]+n[13],i.z=a*n[2]+s*n[6]+r*n[10]+n[14],i.w=a*n[3]+s*n[7]+r*n[11]+n[15]}static TransformNormal(t,e,i){var a=t.x,s=t.y,r=t.z,n=e.elements;i.x=a*n[0]+s*n[4]+r*n[8],i.y=a*n[1]+s*n[5]+r*n[9],i.z=a*n[2]+s*n[6]+r*n[10]}static transformCoordinate(t,e,i){var a=t.x,s=t.y,r=t.z,n=e.elements,h=a*n[3]+s*n[7]+r*n[11]+n[15];i.x=(a*n[0]+s*n[4]+r*n[8]+n[12])/h,i.y=(a*n[1]+s*n[5]+r*n[9]+n[13])/h,i.z=(a*n[2]+s*n[6]+r*n[10]+n[14])/h}static Clamp(t,e,i,a){var s=t.x,r=t.y,n=t.z,h=e.x,o=e.y,l=e.z,c=i.x,d=i.y,u=i.z;s=(s=s>c?c:s)<h?h:s,r=(r=r>d?d:r)<o?o:r,n=(n=n>u?u:n)<l?l:n,a.x=s,a.y=r,a.z=n}static add(t,e,i){i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z}static subtract(t,e,i){i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z}static cross(t,e,i){var a=t.x,s=t.y,r=t.z,n=e.x,h=e.y,o=e.z;i.x=s*o-r*h,i.y=r*n-a*o,i.z=a*h-s*n}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static equals(t,e){return s.nearEqual(t.x,e.x)&&s.nearEqual(t.y,e.y)&&s.nearEqual(t.z,e.z)}setValue(t,e,i){this.x=t,this.y=e,this.z=i}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2]}cloneTo(t){var e=t;e.x=this.x,e.y=this.y,e.z=this.z}clone(){var t=new h;return this.cloneTo(t),t}toDefault(){this.x=0,this.y=0,this.z=0}forNativeElement(t=null){t?(this.elements=t,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z):this.elements=new Float32Array([this.x,this.y,this.z]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1),r.rewriteNumProperty(this,"z",2)}}h._tempVector4=new n,h._ZERO=new h(0,0,0),h._ONE=new h(1,1,1),h._NegativeUnitX=new h(-1,0,0),h._UnitX=new h(1,0,0),h._UnitY=new h(0,1,0),h._UnitZ=new h(0,0,1),h._ForwardRH=new h(0,0,-1),h._ForwardLH=new h(0,0,1),h._Up=new h(0,1,0);class o{constructor(){var t=this.elements=new Float32Array(9);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1}static createRotationQuaternion(t,e){var i=t.x,a=t.y,s=t.z,r=t.w,n=i*i,h=a*a,o=s*s,l=i*a,c=s*r,d=s*i,u=a*r,m=a*s,p=i*r,y=e.elements;y[0]=1-2*(h+o),y[1]=2*(l+c),y[2]=2*(d-u),y[3]=2*(l-c),y[4]=1-2*(o+n),y[5]=2*(m+p),y[6]=2*(d+u),y[7]=2*(m-p),y[8]=1-2*(h+n)}static createFromTranslation(t,e){var i=e.elements;i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=1,i[5]=0,i[6]=t.x,i[7]=t.y,i[8]=1}static createFromRotation(t,e){var i=e.elements,a=Math.sin(t),s=Math.cos(t);i[0]=s,i[1]=a,i[2]=0,i[3]=-a,i[4]=s,i[5]=0,i[6]=0,i[7]=0,i[8]=1}static createFromScaling(t,e){var i=e.elements;i[0]=t.x,i[1]=0,i[2]=0,i[3]=0,i[4]=t.y,i[5]=0,i[6]=0,i[7]=0,i[8]=t.z}static createFromMatrix4x4(t,e){var i=t.elements,a=e.elements;a[0]=i[0],a[1]=i[1],a[2]=i[2],a[3]=i[4],a[4]=i[5],a[5]=i[6],a[6]=i[8],a[7]=i[9],a[8]=i[10]}static multiply(t,e,i){var a=t.elements,s=e.elements,r=i.elements,n=a[0],h=a[1],o=a[2],l=a[3],c=a[4],d=a[5],u=a[6],m=a[7],p=a[8],y=s[0],x=s[1],v=s[2],g=s[3],_=s[4],f=s[5],D=s[6],b=s[7],w=s[8];r[0]=y*n+x*l+v*u,r[1]=y*h+x*c+v*b,r[2]=y*o+x*d+v*p,r[3]=g*n+_*l+f*u,r[4]=g*h+_*c+f*m,r[5]=g*o+_*d+f*p,r[6]=D*n+b*l+w*u,r[7]=D*h+b*c+w*m,r[8]=D*o+b*d+w*p}determinant(){var t=this.elements,e=t[0],i=t[1],a=t[2],s=t[3],r=t[4],n=t[5],h=t[6],o=t[7],l=t[8];return e*(l*r-n*o)+i*(-l*s+n*h)+a*(o*s-r*h)}translate(t,e){var i=e.elements,a=this.elements,s=a[0],r=a[1],n=a[2],h=a[3],o=a[4],l=a[5],c=a[6],d=a[7],u=a[8],m=t.x,p=t.y;i[0]=s,i[1]=r,i[2]=n,i[3]=h,i[4]=o,i[5]=l,i[6]=m*s+p*h+c,i[7]=m*r+p*o+d,i[8]=m*n+p*l+u}rotate(t,e){var i=e.elements,a=this.elements,s=a[0],r=a[1],n=a[2],h=a[3],o=a[4],l=a[5],c=a[6],d=a[7],u=a[8],m=Math.sin(t),p=Math.cos(t);i[0]=p*s+m*h,i[1]=p*r+m*o,i[2]=p*n+m*l,i[3]=p*h-m*s,i[4]=p*o-m*r,i[5]=p*l-m*n,i[6]=c,i[7]=d,i[8]=u}scale(t,e){var i=e.elements,a=this.elements,s=t.x,r=t.y;i[0]=s*a[0],i[1]=s*a[1],i[2]=s*a[2],i[3]=r*a[3],i[4]=r*a[4],i[5]=r*a[5],i[6]=a[6],i[7]=a[7],i[8]=a[8]}invert(t){var e=t.elements,i=this.elements,a=i[0],s=i[1],r=i[2],n=i[3],h=i[4],o=i[5],l=i[6],c=i[7],d=i[8],u=d*h-o*c,m=-d*n+o*l,p=c*n-h*l,y=a*u+s*m+r*p;y||(t=null),y=1/y,e[0]=u*y,e[1]=(-d*s+r*c)*y,e[2]=(o*s-r*h)*y,e[3]=m*y,e[4]=(d*a-r*l)*y,e[5]=(-o*a+r*n)*y,e[6]=p*y,e[7]=(-c*a+s*l)*y,e[8]=(h*a-s*n)*y}transpose(t){var e=t.elements,i=this.elements;if(t===this){var a=i[1],s=i[2],r=i[5];e[1]=i[3],e[2]=i[6],e[3]=a,e[5]=i[7],e[6]=s,e[7]=r}else e[0]=i[0],e[1]=i[3],e[2]=i[6],e[3]=i[1],e[4]=i[4],e[5]=i[7],e[6]=i[2],e[7]=i[5],e[8]=i[8]}identity(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1}cloneTo(t){var e,i,a;if((i=this.elements)!==(a=t.elements))for(e=0;e<9;++e)a[e]=i[e]}clone(){var t=new o;return this.cloneTo(t),t}static lookAt(t,e,i,a){h.subtract(t,e,o._tempV30),h.normalize(o._tempV30,o._tempV30),h.cross(i,o._tempV30,o._tempV31),h.normalize(o._tempV31,o._tempV31),h.cross(o._tempV30,o._tempV31,o._tempV32);var s=o._tempV30,r=o._tempV31,n=o._tempV32,l=a.elements;l[0]=r.x,l[3]=r.y,l[6]=r.z,l[1]=n.x,l[4]=n.y,l[7]=n.z,l[2]=s.x,l[5]=s.y,l[8]=s.z}}o.DEFAULT=new o,o._tempV30=new h,o._tempV31=new h,o._tempV32=new h;class l{constructor(t=0,e=0,i=0,a=1,s=null){this.x=t,this.y=e,this.z=i,this.w=a}static createFromYawPitchRoll(t,e,i,a){var s=.5*i,r=.5*e,n=.5*t,h=Math.sin(s),o=Math.cos(s),l=Math.sin(r),c=Math.cos(r),d=Math.sin(n),u=Math.cos(n);a.x=u*l*o+d*c*h,a.y=d*c*o-u*l*h,a.z=u*c*h-d*l*o,a.w=u*c*o+d*l*h}static multiply(t,e,i){var a=t.x,s=t.y,r=t.z,n=t.w,h=e.x,o=e.y,l=e.z,c=e.w,d=s*l-r*o,u=r*h-a*l,m=a*o-s*h,p=a*h+s*o+r*l;i.x=a*c+h*n+d,i.y=s*c+o*n+u,i.z=r*c+l*n+m,i.w=n*c-p}static arcTanAngle(t,e){return 0==t?1==e?Math.PI/2:-Math.PI/2:t>0?Math.atan(e/t):t<0?e>0?Math.atan(e/t)+Math.PI:Math.atan(e/t)-Math.PI:0}static angleTo(t,e,i){h.subtract(e,t,l.TEMPVector30),h.normalize(l.TEMPVector30,l.TEMPVector30),i.x=Math.asin(l.TEMPVector30.y),i.y=l.arcTanAngle(-l.TEMPVector30.z,-l.TEMPVector30.x)}static createFromAxisAngle(t,e,i){e*=.5;var a=Math.sin(e);i.x=a*t.x,i.y=a*t.y,i.z=a*t.z,i.w=Math.cos(e)}static slerp(t,e,i,a){var s,r,n,h,o,l=t.x,c=t.y,d=t.z,u=t.w,m=e.x,p=e.y,y=e.z,x=e.w;return(r=l*m+c*p+d*y+u*x)<0&&(r=-r,m=-m,p=-p,y=-y,x=-x),1-r>1e-6?(s=Math.acos(r),n=Math.sin(s),h=Math.sin((1-i)*s)/n,o=Math.sin(i*s)/n):(h=1-i,o=i),a.x=h*l+o*m,a.y=h*c+o*p,a.z=h*d+o*y,a.w=h*u+o*x,a}static lerp(t,e,i,a){var s=1-i;l.dot(t,e)>=0?(a.x=s*t.x+i*e.x,a.y=s*t.y+i*e.y,a.z=s*t.z+i*e.z,a.w=s*t.w+i*e.w):(a.x=s*t.x-i*e.x,a.y=s*t.y-i*e.y,a.z=s*t.z-i*e.z,a.w=s*t.w-i*e.w),a.normalize(a)}static add(t,e,i){i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i.w=t.w+e.w}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}scaling(t,e){e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t}normalize(t){var e=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;e>0&&(e=1/Math.sqrt(e),t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(t,e){t*=.5;var i=Math.sin(t),a=Math.cos(t);e.x=this.x*a+this.w*i,e.y=this.y*a+this.z*i,e.z=this.z*a-this.y*i,e.w=this.w*a-this.x*i}rotateY(t,e){t*=.5;var i=Math.sin(t),a=Math.cos(t);e.x=this.x*a-this.z*i,e.y=this.y*a+this.w*i,e.z=this.z*a+this.x*i,e.w=this.w*a-this.y*i}rotateZ(t,e){t*=.5;var i=Math.sin(t),a=Math.cos(t);e.x=this.x*a+this.y*i,e.y=this.y*a-this.x*i,e.z=this.z*a+this.w*i,e.w=this.w*a-this.z*i}invert(t){var e=this.x,i=this.y,a=this.z,s=this.w,r=e*e+i*i+a*a+s*s,n=r?1/r:0;t.x=-e*n,t.y=-i*n,t.z=-a*n,t.w=s*n}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3]}cloneTo(t){this!==t&&(t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w)}clone(){var t=new l;return this.cloneTo(t),t}equals(t){return s.nearEqual(this.x,t.x)&&s.nearEqual(this.y,t.y)&&s.nearEqual(this.z,t.z)&&s.nearEqual(this.w,t.w)}static rotationLookAt(t,e,i){l.lookAt(h._ZERO,t,e,i)}static lookAt(t,e,i,a){o.lookAt(t,e,i,l._tempMatrix3x3),l.rotationMatrix(l._tempMatrix3x3,a)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(t,e){var i=t.lengthSquared();s.isZero(i)||(i=1/i,e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i)}static rotationMatrix(t,e){var i,a,s=t.elements,r=s[0],n=s[1],h=s[2],o=s[3],l=s[4],c=s[5],d=s[6],u=s[7],m=s[8],p=r+l+m;p>0?(i=Math.sqrt(p+1),e.w=.5*i,i=.5/i,e.x=(c-u)*i,e.y=(d-h)*i,e.z=(n-o)*i):r>=l&&r>=m?(a=.5/(i=Math.sqrt(1+r-l-m)),e.x=.5*i,e.y=(n+o)*a,e.z=(h+d)*a,e.w=(c-u)*a):l>m?(a=.5/(i=Math.sqrt(1+l-r-m)),e.x=(o+n)*a,e.y=.5*i,e.z=(u+c)*a,e.w=(d-h)*a):(a=.5/(i=Math.sqrt(1+m-r-l)),e.x=(d+h)*a,e.y=(u+c)*a,e.z=.5*i,e.w=(n-o)*a)}forNativeElement(t=null){t?(this.elements=t,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1),r.rewriteNumProperty(this,"z",2),r.rewriteNumProperty(this,"w",3)}}l.TEMPVector30=new h,l.TEMPVector31=new h,l.TEMPVector32=new h,l.TEMPVector33=new h,l._tempMatrix3x3=new o,l.DEFAULT=new l,l.NAN=new l(NaN,NaN,NaN,NaN);class c{constructor(t=1,e=0,i=0,a=0,s=0,r=1,n=0,h=0,o=0,l=0,c=1,d=0,u=0,m=0,p=0,y=1,x=null){var v=this.elements=x||new Float32Array(16);v[0]=t,v[1]=e,v[2]=i,v[3]=a,v[4]=s,v[5]=r,v[6]=n,v[7]=h,v[8]=o,v[9]=l,v[10]=c,v[11]=d,v[12]=u,v[13]=m,v[14]=p,v[15]=y}static createRotationX(t,e){var i=e.elements,a=Math.sin(t),s=Math.cos(t);i[1]=i[2]=i[3]=i[4]=i[7]=i[8]=i[11]=i[12]=i[13]=i[14]=0,i[0]=i[15]=1,i[5]=i[10]=s,i[6]=a,i[9]=-a}static createRotationY(t,e){var i=e.elements,a=Math.sin(t),s=Math.cos(t);i[1]=i[3]=i[4]=i[6]=i[7]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[5]=i[15]=1,i[0]=i[10]=s,i[2]=-a,i[8]=a}static createRotationZ(t,e){var i=e.elements,a=Math.sin(t),s=Math.cos(t);i[2]=i[3]=i[6]=i[7]=i[8]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[10]=i[15]=1,i[0]=i[5]=s,i[1]=a,i[4]=-a}static createRotationYawPitchRoll(t,e,i,a){l.createFromYawPitchRoll(t,e,i,c._tempQuaternion),c.createRotationQuaternion(c._tempQuaternion,a)}static createRotationAxis(t,e,i){var a=t.x,s=t.y,r=t.z,n=Math.cos(e),h=Math.sin(e),o=a*a,l=s*s,c=r*r,d=a*s,u=a*r,m=s*r,p=i.elements;p[3]=p[7]=p[11]=p[12]=p[13]=p[14]=0,p[15]=1,p[0]=o+n*(1-o),p[1]=d-n*d+h*r,p[2]=u-n*u-h*s,p[4]=d-n*d-h*r,p[5]=l+n*(1-l),p[6]=m-n*m+h*a,p[8]=u-n*u+h*s,p[9]=m-n*m-h*a,p[10]=c+n*(1-c)}setRotation(t){var e=t.x,i=t.y,a=t.z,s=t.w,r=e*e,n=i*i,h=a*a,o=e*i,l=a*s,c=a*e,d=i*s,u=i*a,m=e*s,p=this.elements;p[0]=1-2*(n+h),p[1]=2*(o+l),p[2]=2*(c-d),p[4]=2*(o-l),p[5]=1-2*(h+r),p[6]=2*(u+m),p[8]=2*(c+d),p[9]=2*(u-m),p[10]=1-2*(n+r)}setPosition(t){var e=this.elements;e[12]=t.x,e[13]=t.y,e[14]=t.z}static createRotationQuaternion(t,e){var i=e.elements,a=t.x,s=t.y,r=t.z,n=t.w,h=a*a,o=s*s,l=r*r,c=a*s,d=r*n,u=r*a,m=s*n,p=s*r,y=a*n;i[3]=i[7]=i[11]=i[12]=i[13]=i[14]=0,i[15]=1,i[0]=1-2*(o+l),i[1]=2*(c+d),i[2]=2*(u-m),i[4]=2*(c-d),i[5]=1-2*(l+h),i[6]=2*(p+y),i[8]=2*(u+m),i[9]=2*(p-y),i[10]=1-2*(o+h)}static createTranslate(t,e){var i=e.elements;i[4]=i[8]=i[1]=i[9]=i[2]=i[6]=i[3]=i[7]=i[11]=0,i[0]=i[5]=i[10]=i[15]=1,i[12]=t.x,i[13]=t.y,i[14]=t.z}static createScaling(t,e){var i=e.elements;i[0]=t.x,i[5]=t.y,i[10]=t.z,i[1]=i[4]=i[8]=i[12]=i[9]=i[13]=i[2]=i[6]=i[14]=i[3]=i[7]=i[11]=0,i[15]=1}static multiply(t,e,i){var a=e.elements,s=t.elements,r=i.elements,n=a[0],h=a[1],o=a[2],l=a[3],c=a[4],d=a[5],u=a[6],m=a[7],p=a[8],y=a[9],x=a[10],v=a[11],g=a[12],_=a[13],f=a[14],D=a[15],b=s[0],w=s[1],A=s[2],M=s[3],T=s[4],S=s[5],P=s[6],I=s[7],R=s[8],L=s[9],B=s[10],C=s[11],F=s[12],z=s[13],E=s[14],V=s[15];r[0]=n*b+h*T+o*R+l*F,r[1]=n*w+h*S+o*L+l*z,r[2]=n*A+h*P+o*B+l*E,r[3]=n*M+h*I+o*C+l*V,r[4]=c*b+d*T+u*R+m*F,r[5]=c*w+d*S+u*L+m*z,r[6]=c*A+d*P+u*B+m*E,r[7]=c*M+d*I+u*C+m*V,r[8]=p*b+y*T+x*R+v*F,r[9]=p*w+y*S+x*L+v*z,r[10]=p*A+y*P+x*B+v*E,r[11]=p*M+y*I+x*C+v*V,r[12]=g*b+_*T+f*R+D*F,r[13]=g*w+_*S+f*L+D*z,r[14]=g*A+_*P+f*B+D*E,r[15]=g*M+_*I+f*C+D*V}static multiplyForNative(t,e,i){Laya.LayaGL.instance.matrix4x4Multiply(t.elements,e.elements,i.elements)}static createFromQuaternion(t,e){var i=e.elements,a=t.x,s=t.y,r=t.z,n=t.w,h=a+a,o=s+s,l=r+r,c=a*h,d=s*h,u=s*o,m=r*h,p=r*o,y=r*l,x=n*h,v=n*o,g=n*l;i[0]=1-u-y,i[1]=d+g,i[2]=m-v,i[3]=0,i[4]=d-g,i[5]=1-c-y,i[6]=p+x,i[7]=0,i[8]=m+v,i[9]=p-x,i[10]=1-c-u,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1}static createAffineTransformation(t,e,i,a){var s=a.elements,r=e.x,n=e.y,h=e.z,o=e.w,l=r+r,c=n+n,d=h+h,u=r*l,m=r*c,p=r*d,y=n*c,x=n*d,v=h*d,g=o*l,_=o*c,f=o*d,D=i.x,b=i.y,w=i.z;s[0]=(1-(y+v))*D,s[1]=(m+f)*D,s[2]=(p-_)*D,s[3]=0,s[4]=(m-f)*b,s[5]=(1-(u+v))*b,s[6]=(x+g)*b,s[7]=0,s[8]=(p+_)*w,s[9]=(x-g)*w,s[10]=(1-(u+y))*w,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1}static createLookAt(t,e,i,a){var s=a.elements,r=c._tempVector0,n=c._tempVector1,o=c._tempVector2;h.subtract(t,e,o),h.normalize(o,o),h.cross(i,o,r),h.normalize(r,r),h.cross(o,r,n),s[3]=s[7]=s[11]=0,s[15]=1,s[0]=r.x,s[4]=r.y,s[8]=r.z,s[1]=n.x,s[5]=n.y,s[9]=n.z,s[2]=o.x,s[6]=o.y,s[10]=o.z,s[12]=-h.dot(r,t),s[13]=-h.dot(n,t),s[14]=-h.dot(o,t)}static createPerspective(t,e,i,a,s){var r=1/Math.tan(.5*t),n=i/(r/e),h=i/r;c.createPerspectiveOffCenter(-n,n,-h,h,i,a,s)}static createPerspectiveOffCenter(t,e,i,a,s,r,n){var h=n.elements,o=r/(r-s);h[1]=h[2]=h[3]=h[4]=h[6]=h[7]=h[12]=h[13]=h[15]=0,h[0]=2*s/(e-t),h[5]=2*s/(a-i),h[8]=(t+e)/(e-t),h[9]=(a+i)/(a-i),h[10]=-o,h[11]=-1,h[14]=-s*o}static createOrthoOffCenter(t,e,i,a,s,r,n){var h=n.elements,o=1/(r-s);h[1]=h[2]=h[3]=h[4]=h[6]=h[8]=h[7]=h[9]=h[11]=0,h[15]=1,h[0]=2/(e-t),h[5]=2/(a-i),h[10]=-o,h[12]=(t+e)/(t-e),h[13]=(a+i)/(i-a),h[14]=-s*o}getElementByRowColumn(t,e){if(t<0||t>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*t+e]}setElementByRowColumn(t,e,i){if(t<0||t>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*t+e]=i}equalsOtherMatrix(t){var e=this.elements,i=t.elements;return s.nearEqual(e[0],i[0])&&s.nearEqual(e[1],i[1])&&s.nearEqual(e[2],i[2])&&s.nearEqual(e[3],i[3])&&s.nearEqual(e[4],i[4])&&s.nearEqual(e[5],i[5])&&s.nearEqual(e[6],i[6])&&s.nearEqual(e[7],i[7])&&s.nearEqual(e[8],i[8])&&s.nearEqual(e[9],i[9])&&s.nearEqual(e[10],i[10])&&s.nearEqual(e[11],i[11])&&s.nearEqual(e[12],i[12])&&s.nearEqual(e[13],i[13])&&s.nearEqual(e[14],i[14])&&s.nearEqual(e[15],i[15])}decomposeTransRotMatScale(t,e,i){var a=this.elements,r=t,n=e.elements,o=i;r.x=a[12],r.y=a[13],r.z=a[14];var l=a[0],d=a[1],u=a[2],m=a[4],p=a[5],y=a[6],x=a[8],v=a[9],g=a[10],_=o.x=Math.sqrt(l*l+d*d+u*u),f=o.y=Math.sqrt(m*m+p*p+y*y),D=o.z=Math.sqrt(x*x+v*v+g*g);if(s.isZero(_)||s.isZero(f)||s.isZero(D))return n[1]=n[2]=n[3]=n[4]=n[6]=n[7]=n[8]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[0]=n[5]=n[10]=n[15]=1,!1;var b=c._tempVector0;b.x=x/D,b.y=v/D,b.z=g/D;var w=c._tempVector1;w.x=l/_,w.y=d/_,w.z=u/_;var A=c._tempVector2;h.cross(b,w,A);var M=c._tempVector1;return h.cross(A,b,M),n[3]=n[7]=n[11]=n[12]=n[13]=n[14]=0,n[15]=1,n[0]=M.x,n[1]=M.y,n[2]=M.z,n[4]=A.x,n[5]=A.y,n[6]=A.z,n[8]=b.x,n[9]=b.y,n[10]=b.z,n[0]*l+n[1]*d+n[2]*u<0&&(o.x=-_),n[4]*m+n[5]*p+n[6]*y<0&&(o.y=-f),n[8]*x+n[9]*v+n[10]*g<0&&(o.z=-D),!0}decomposeYawPitchRoll(t){var e=Math.asin(-this.elements[9]);t.y=e,Math.cos(e)>s.zeroTolerance?(t.z=Math.atan2(this.elements[1],this.elements[5]),t.x=Math.atan2(this.elements[8],this.elements[10])):(t.z=Math.atan2(-this.elements[4],this.elements[0]),t.x=0)}normalize(){var t=this.elements,e=t[0],i=t[1],a=t[2],s=Math.sqrt(e*e+i*i+a*a);if(!s)return t[0]=0,t[1]=0,void(t[2]=0);1!=s&&(s=1/s,t[0]=e*s,t[1]=i*s,t[2]=a*s)}transpose(){var t,e;return e=(t=this.elements)[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}invert(t){var e=this.elements,i=t.elements,a=e[0],s=e[1],r=e[2],n=e[3],h=e[4],o=e[5],l=e[6],c=e[7],d=e[8],u=e[9],m=e[10],p=e[11],y=e[12],x=e[13],v=e[14],g=e[15],_=a*o-s*h,f=a*l-r*h,D=a*c-n*h,b=s*l-r*o,w=s*c-n*o,A=r*c-n*l,M=d*x-u*y,T=d*v-m*y,S=d*g-p*y,P=u*v-m*x,I=u*g-p*x,R=m*g-p*v,L=_*R-f*I+D*P+b*S-w*T+A*M;0!==Math.abs(L)&&(L=1/L,i[0]=(o*R-l*I+c*P)*L,i[1]=(r*I-s*R-n*P)*L,i[2]=(x*A-v*w+g*b)*L,i[3]=(m*w-u*A-p*b)*L,i[4]=(l*S-h*R-c*T)*L,i[5]=(a*R-r*S+n*T)*L,i[6]=(v*D-y*A-g*f)*L,i[7]=(d*A-m*D+p*f)*L,i[8]=(h*I-o*S+c*M)*L,i[9]=(s*S-a*I-n*M)*L,i[10]=(y*w-x*D+g*_)*L,i[11]=(u*D-d*w-p*_)*L,i[12]=(o*T-h*P-l*M)*L,i[13]=(a*P-s*T+r*M)*L,i[14]=(x*f-y*b-v*_)*L,i[15]=(d*b-u*f+m*_)*L)}static billboard(t,e,i,a,r,n){h.subtract(t,e,c._tempVector0);var o=h.scalarLengthSquared(c._tempVector0);s.isZero(o)?(h.scale(r,-1,c._tempVector1),c._tempVector1.cloneTo(c._tempVector0)):h.scale(c._tempVector0,1/Math.sqrt(o),c._tempVector0),h.cross(a,c._tempVector0,c._tempVector2),h.normalize(c._tempVector2,c._tempVector2),h.cross(c._tempVector0,c._tempVector2,c._tempVector3);var l=c._tempVector2,d=c._tempVector3,u=c._tempVector0,m=t,p=n.elements;p[0]=l.x,p[1]=l.y,p[2]=l.z,p[3]=0,p[4]=d.x,p[5]=d.y,p[6]=d.z,p[7]=0,p[8]=u.x,p[9]=u.y,p[10]=u.z,p[11]=0,p[12]=m.x,p[13]=m.y,p[14]=m.z,p[15]=1}identity(){var t=this.elements;t[1]=t[2]=t[3]=t[4]=t[6]=t[7]=t[8]=t[9]=t[11]=t[12]=t[13]=t[14]=0,t[0]=t[5]=t[10]=t[15]=1}cloneTo(t){var e,i,a;if((i=this.elements)!==(a=t.elements))for(e=0;e<16;++e)a[e]=i[e]}clone(){var t=new c;return this.cloneTo(t),t}static translation(t,e){var i=e.elements;i[0]=i[5]=i[10]=i[15]=1,i[12]=t.x,i[13]=t.y,i[14]=t.z}getTranslationVector(t){var e=this.elements;t.x=e[12],t.y=e[13],t.z=e[14]}setTranslationVector(t){var e=this.elements,i=t;e[12]=i.x,e[13]=i.y,e[14]=i.z}getForward(t){var e=this.elements;t.x=-e[8],t.y=-e[9],t.z=-e[10]}setForward(t){var e=this.elements;e[8]=-t.x,e[9]=-t.y,e[10]=-t.z}}c._tempMatrix4x4=new c,c.TEMPMatrix0=new c,c.TEMPMatrix1=new c,c._tempVector0=new h,c._tempVector1=new h,c._tempVector2=new h,c._tempVector3=new h,c._tempQuaternion=new l,c.DEFAULT=new c,c.ZERO=new c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);class d{constructor(){this._mask=[],this._length=0}_intersectionDefineDatas(t){for(var e=t._mask,i=this._mask,a=this._length-1;a>=0;a--){var s=i[a]&e[a];0==s&&a==this._length-1?this._length--:i[a]=s}}add(t){var e=t._index,i=e+1,a=this._mask,s=this._length;if(s<i){for(a.length<i&&(a.length=i);s<e;s++)a[s]=0;a[e]=t._value,this._length=i}else i>this._length?(a[e]=t._value,this._length=i):a[e]|=t._value}remove(t){var e=t._index,i=this._mask,a=this._length-1;if(!(e>a)){var s=i[e]&~t._value;e==a&&0===s?this._length--:i[e]=s}}addDefineDatas(t){var e=t._mask,i=t._length,a=this._mask,s=a.length;if(s<i){a.length=i;for(var r=0;r<s;r++)a[r]|=e[r];for(;s<i;s++)a[s]=e[s];this._length=i}else{for(r=0;r<i;r++)a[r]|=e[r];this._length=Math.max(this._length,i)}}removeDefineDatas(t){for(var e=t._mask,i=this._mask,a=this._length-1,s=t._length-1;s>=0;s--)if(!(s>a)){var r=i[s]&~e[s];s==a&&0===r?(a--,this._length--):i[s]=r}}has(t){var e=t._index;return!(e>=this._length)&&0!=(this._mask[e]&t._value)}clear(){this._length=0}cloneTo(t){var e=t,i=e._mask,a=this._mask,s=this._length;i.length=s;for(var r=0;r<s;r++)i[r]=a[r];e._length=s}clone(){var t=new d;return this.cloneTo(t),t}}var u=Laya.LayaGL;class m{constructor(t=null){this._ownerResource=null,this._data=null,this._defineDatas=new d,this._runtimeCopyValues=[],this._ownerResource=t,this._initData()}_initData(){this._data=new Object}getData(){return this._data}addDefine(t){this._defineDatas.add(t)}removeDefine(t){this._defineDatas.remove(t)}hasDefine(t){return this._defineDatas.has(t)}clearDefine(){this._defineDatas.clear()}getBool(t){return this._data[t]}setBool(t,e){this._data[t]=e}getInt(t){return this._data[t]}setInt(t,e){this._data[t]=e}getNumber(t){return this._data[t]}setNumber(t,e){this._data[t]=e}getVector2(t){return this._data[t]}setVector2(t,e){this._data[t]=e}getVector3(t){return this._data[t]}setVector3(t,e){this._data[t]=e}getVector(t){return this._data[t]}setVector(t,e){this._data[t]=e}getQuaternion(t){return this._data[t]}setQuaternion(t,e){this._data[t]=e}getMatrix4x4(t){return this._data[t]}setMatrix4x4(t,e){this._data[t]=e}getBuffer(t){return this._data[t]}setBuffer(t,e){this._data[t]=e}setTexture(t,e){var i=this._data[t];this._data[t]=e,this._ownerResource&&this._ownerResource.referenceCount>0&&(i&&i._removeReference(),e&&e._addReference())}getTexture(t){return this._data[t]}setAttribute(t,e){this._data[t]=e}getAttribute(t){return this._data[t]}getLength(){return this._data.length}setLength(t){this._data.length=t}cloneToForNative(t){var e=t;this._int32Data.length-e._int32Data.length>0&&e.needRenewArrayBufferForNative(this._int32Data.length),e._int32Data.set(this._int32Data,0);var i=e._nativeArray,a=this._nativeArray.length;i.length=a;for(var s=0;s<a;s++){var o=this._nativeArray[s];if(o)if("number"==typeof o)i[s]=o,e.setNumber(s,o);else if("number"==typeof o)i[s]=o,e.setInt(s,o);else if("boolean"==typeof o)i[s]=o,e.setBool(s,o);else if(o instanceof r){var l=i[s]||(i[s]=new r);o.cloneTo(l),i[s]=l,e.setVector2(s,l)}else if(o instanceof h){var d=i[s]||(i[s]=new h);o.cloneTo(d),i[s]=d,e.setVector3(s,d)}else if(o instanceof n){var u=i[s]||(i[s]=new n);o.cloneTo(u),i[s]=u,e.setVector(s,u)}else if(o instanceof c){var m=i[s]||(i[s]=new c);o.cloneTo(m),i[s]=m,e.setMatrix4x4(s,m)}else o instanceof Laya.BaseTexture&&(i[s]=o,e.setTexture(s,o))}this._defineDatas.cloneTo(e._defineDatas)}_initDataForNative(){this._frameCount=-1,this._runtimeCopyValues.length=0,this._nativeArray=[],this._data=new ArrayBuffer(32),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),u.instance.createArrayBufferRef(this._data,u.ARRAY_BUFFER_TYPE_DATA,!0)}needRenewArrayBufferForNative(t){if(t>=this._int32Data.length){var e=4*(t+1),i=this._int32Data,a=this._data.conchRef,s=this._data._ptrID;this._data=new ArrayBuffer(e),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),this._data.conchRef=a,this._data._ptrID=s,i&&this._int32Data.set(i,0);var r=u.instance;r.updateArrayBufferRef?r.updateArrayBufferRef(this._data._ptrID,a.isSyncToRender(),this._data):window.conch.updateArrayBufferRef(this._data._ptrID,a.isSyncToRender(),this._data)}}getDataForNative(){return this._nativeArray}getIntForNative(t){return this._int32Data[t]}setIntForNative(t,e){this.needRenewArrayBufferForNative(t),this._int32Data[t]=e,this._nativeArray[t]=e}getBoolForNative(t){return 1==this._int32Data[t]}setBoolForNative(t,e){this.needRenewArrayBufferForNative(t),this._int32Data[t]=e?1:0,this._nativeArray[t]=e}getNumberForNative(t){return this._float32Data[t]}setNumberForNative(t,e){this.needRenewArrayBufferForNative(t),this._float32Data[t]=e,this._nativeArray[t]=e}getMatrix4x4ForNative(t){return this._nativeArray[t]}setMatrix4x4ForNative(t,e){this.needRenewArrayBufferForNative(t),this._nativeArray[t]=e;var i=this.setReferenceForNative(e.elements);this._int32Data[t]=i}getVectorForNative(t){return this._nativeArray[t]}setVectorForNative(t,e){this.needRenewArrayBufferForNative(t),this._nativeArray[t]=e,e.elements||e.forNativeElement();var i=this.setReferenceForNative(e.elements);this._int32Data[t]=i}getVector2ForNative(t){return this._nativeArray[t]}setVector2ForNative(t,e){this.needRenewArrayBufferForNative(t),this._nativeArray[t]=e,e.elements||e.forNativeElement();var i=this.setReferenceForNative(e.elements);this._int32Data[t]=i}getVector3ForNative(t){return this._nativeArray[t]}setVector3ForNative(t,e){this.needRenewArrayBufferForNative(t),this._nativeArray[t]=e,e.elements||e.forNativeElement();var i=this.setReferenceForNative(e.elements);this._int32Data[t]=i}getQuaternionForNative(t){return this._nativeArray[t]}setQuaternionForNative(t,e){this.needRenewArrayBufferForNative(t),this._nativeArray[t]=e,e.elements||e.forNativeElement();var i=this.setReferenceForNative(e.elements);this._int32Data[t]=i}getBufferForNative(t){return this._nativeArray[t]}setBufferForNative(t,e){this.needRenewArrayBufferForNative(t),this._nativeArray[t]=e;var i=this.setReferenceForNative(e);this._int32Data[t]=i}getAttributeForNative(t){return this._nativeArray[t]}setAttributeForNative(t,e){this._nativeArray[t]=e,e._ptrID||u.instance.createArrayBufferRef(e,u.ARRAY_BUFFER_TYPE_DATA,!0),u.instance.syncBufferToRenderThread(e),this._int32Data[t]=e._ptrID}getTextureForNative(t){return this._nativeArray[t]}setTextureForNative(t,e){if(e){this.needRenewArrayBufferForNative(t);var i=this._nativeArray[t];this._nativeArray[t]=e;var a=e._getSource()||e.defaulteTexture._getSource();this._int32Data[t]=a.id,this._ownerResource&&this._ownerResource.referenceCount>0&&(i&&i._removeReference(),e&&e._addReference())}}setReferenceForNative(t){this.clearRuntimeCopyArray();var e=0,i=0;return m._SET_RUNTIME_VALUE_MODE_REFERENCE_?(u.instance.createArrayBufferRefs(t,u.ARRAY_BUFFER_TYPE_DATA,!0,u.ARRAY_BUFFER_REF_REFERENCE),e=0,i=t.getPtrID(e)):(u.instance.createArrayBufferRefs(t,u.ARRAY_BUFFER_TYPE_DATA,!0,u.ARRAY_BUFFER_REF_COPY),e=t.getRefNum()-1,i=t.getPtrID(e),this._runtimeCopyValues.push({obj:t,refID:e,ptrID:i})),u.instance.syncBufferToRenderThread(t,e),i}static setRuntimeValueMode(t){m._SET_RUNTIME_VALUE_MODE_REFERENCE_=t}clearRuntimeCopyArray(){var t=Laya.Stat.loopCount;if(this._frameCount!=t){this._frameCount=t;for(var e=0,i=this._runtimeCopyValues.length;e<i;e++){this._runtimeCopyValues[e].obj.clearRefNum()}this._runtimeCopyValues.length=0}}}m._SET_RUNTIME_VALUE_MODE_REFERENCE_=!0;class p extends Laya.Buffer{constructor(t,e,i=!1){super(),this._vertexDeclaration=null,this._float32Reader=null;var a=Laya.LayaGL.instance;this._bufferUsage=e,this._bufferType=a.ARRAY_BUFFER,this._canRead=i,this._byteLength=t,this.bind(),a.bufferData(this._bufferType,this._byteLength,this._bufferUsage),i&&(this._buffer=new Uint8Array(t),this._float32Reader=new Float32Array(this._buffer.buffer))}get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(t){this._vertexDeclaration=t}get canRead(){return this._canRead}bind(){if(Laya.Buffer._bindedVertexBuffer!==this._glBuffer){var t=Laya.LayaGL.instance;return t.bindBuffer(t.ARRAY_BUFFER,this._glBuffer),Laya.Buffer._bindedVertexBuffer=this._glBuffer,!0}return!1}orphanStorage(){this.bind(),Laya.LayaGL.instance.bufferData(this._bufferType,this._byteLength,this._bufferUsage)}setData(t,e=0,i=0,a=Number.MAX_SAFE_INTEGER){if(this.bind(),0!==i||a!==Number.MAX_SAFE_INTEGER){var s=new Uint8Array(t,i,a);Laya.LayaGL.instance.bufferSubData(this._bufferType,e,s),this._canRead&&this._buffer.set(s,e)}else Laya.LayaGL.instance.bufferSubData(this._bufferType,e,t),this._canRead&&this._buffer.set(new Uint8Array(t),e)}getUint8Data(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}getFloat32Data(){if(this._canRead)return this._float32Reader;throw new Error("Can't read data from VertexBuffer with only write flag!")}markAsUnreadbale(){this._canRead=!1,this._buffer=null,this._float32Reader=null}destroy(){super.destroy(),this._buffer=null,this._float32Reader=null,this._vertexDeclaration=null}}p.DATATYPE_FLOAT32ARRAY=0,p.DATATYPE_UINT8ARRAY=1;class y{static __init__(){var t=Laya.LayaGL.instance;y._elementInfos={single:[1,t.FLOAT,0],vector2:[2,t.FLOAT,0],vector3:[3,t.FLOAT,0],vector4:[4,t.FLOAT,0],color:[4,t.FLOAT,0],byte4:[4,t.UNSIGNED_BYTE,0],short2:[2,t.FLOAT,0],short4:[4,t.FLOAT,0],normalizedshort2:[2,t.FLOAT,0],normalizedshort4:[4,t.FLOAT,0],halfvector2:[2,t.FLOAT,0],halfvector4:[4,t.FLOAT,0]}}static getElementInfos(t){var e=y._elementInfos[t];if(e)return e;throw"VertexElementFormat: this vertexElementFormat is not implement."}}y.Single="single",y.Vector2="vector2",y.Vector3="vector3",y.Vector4="vector4",y.Color="color",y.Byte4="byte4",y.Short2="short2",y.Short4="short4",y.NormalizedShort2="normalizedshort2",y.NormalizedShort4="normalizedshort4",y.HalfVector2="halfvector2",y.HalfVector4="halfvector4";class x{constructor(t,e){this._id=++x._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=t,this._vertexElements=e;var i=e.length;this._shaderValues=new m(null);for(var a=0;a<i;a++){var s=e[a],r=s._elementUsage;this._vertexElementsDic[r]=s;var n=new Int32Array(5),h=y.getElementInfos(s._elementFormat);n[0]=h[0],n[1]=h[1],n[2]=h[2],n[3]=this._vertexStride,n[4]=s._offset,this._shaderValues.setAttribute(r,n)}}get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}getVertexElementByIndex(t){return this._vertexElements[t]}getVertexElementByUsage(t){return this._vertexElementsDic[t]}}x._uniqueIDCounter=1;class v{constructor(t,e,i){this._offset=t,this._elementFormat=e,this._elementUsage=i}get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}}class g{static __init__(){g.instanceWorldMatrixDeclaration=new x(64,[new v(0,y.Vector4,g.MESH_WORLDMATRIX_ROW0),new v(16,y.Vector4,g.MESH_WORLDMATRIX_ROW1),new v(32,y.Vector4,g.MESH_WORLDMATRIX_ROW2),new v(48,y.Vector4,g.MESH_WORLDMATRIX_ROW3)]),g.instanceMVPMatrixDeclaration=new x(64,[new v(0,y.Vector4,g.MESH_MVPMATRIX_ROW0),new v(16,y.Vector4,g.MESH_MVPMATRIX_ROW1),new v(32,y.Vector4,g.MESH_MVPMATRIX_ROW2),new v(48,y.Vector4,g.MESH_MVPMATRIX_ROW3)])}static getVertexDeclaration(t,e=!0){var i=g._vertexDeclarationMap[t+(e?"_0":"_1")];if(!i){for(var a=t.split(","),s=0,r=[],n=0,h=a.length;n<h;n++){var o;switch(a[n]){case"POSITION":o=new v(s,y.Vector3,g.MESH_POSITION0),s+=12;break;case"NORMAL":o=new v(s,y.Vector3,g.MESH_NORMAL0),s+=12;break;case"COLOR":o=new v(s,y.Vector4,g.MESH_COLOR0),s+=16;break;case"UV":o=new v(s,y.Vector2,g.MESH_TEXTURECOORDINATE0),s+=8;break;case"UV1":o=new v(s,y.Vector2,g.MESH_TEXTURECOORDINATE1),s+=8;break;case"BLENDWEIGHT":o=new v(s,y.Vector4,g.MESH_BLENDWEIGHT0),s+=16;break;case"BLENDINDICES":e?(o=new v(s,y.Vector4,g.MESH_BLENDINDICES0),s+=16):(o=new v(s,y.Byte4,g.MESH_BLENDINDICES0),s+=4);break;case"TANGENT":o=new v(s,y.Vector4,g.MESH_TANGENT0),s+=16;break;default:throw"VertexMesh: unknown vertex flag."}r.push(o)}i=new x(s,r),g._vertexDeclarationMap[t+(e?"_0":"_1")]=i}return i}}g.MESH_POSITION0=0,g.MESH_COLOR0=6,g.MESH_TEXTURECOORDINATE0=1,g.MESH_NORMAL0=4,g.MESH_TANGENT0=5,g.MESH_BLENDINDICES0=2,g.MESH_BLENDWEIGHT0=3,g.MESH_TEXTURECOORDINATE1=7,g.MESH_WORLDMATRIX_ROW0=8,g.MESH_WORLDMATRIX_ROW1=9,g.MESH_WORLDMATRIX_ROW2=10,g.MESH_WORLDMATRIX_ROW3=11,g.MESH_MVPMATRIX_ROW0=12,g.MESH_MVPMATRIX_ROW1=13,g.MESH_MVPMATRIX_ROW2=14,g.MESH_MVPMATRIX_ROW3=15,g._vertexDeclarationMap={};class _{constructor(t=0,e=0){this.x=0,this.y=0,this.x=t,this.y=e}normalize(){var t=this.length;0!=t&&this.scaleBy(1/t)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}set vAngle(t){var e=length;this.x=Math.cos(t)*e,this.y=Math.sin(t)*e}get vAngle(){return Math.atan2(this.y,this.x)}set length(t){var e=this.vAngle;this.x=Math.cos(e)*t,this.y=Math.sin(e)*t}scaleBy(t){this.x*=t,this.y*=t}sub(t){return new _(t.x-this.x,t.y-this.y)}add(t){return new _(t.x+this.x,t.y+this.y)}toString(){return"Vector2D("+String(this.x)+","+String(this.y)+")"}static distance(t,e){var i=t.x-e.x,a=t.y-e.y;return Math.sqrt(i*i+a*a)}subtract(t){return new _(this.x-t.x,this.y-t.y)}}class f{constructor(){this.tureMoveV2d=new _(0,0)}static getInstance(){return this._instance||(this._instance=new f),this._instance}resetSize(){let t=D.SCALE_Z,e=Laya.stage.width/2,i=Laya.stage.height/2,a=D.focus3D;a.x=0+e,a.z=0-i*t,a.x-=this.tureMoveV2d.x,a.z+=this.tureMoveV2d.y*t}}f.SCENE_2D_ROTATION_45=30;class D{static set viewMatrx3D(t){D._viewMatrx3D=t}static get viewMatrx3D(){return D._viewMatrx3D}}D.sceneViewHW=500,D.fileRoot="res/",D.verticalScene=!1,D.effectsLev=2,D.camFar=1e3,D.frameTime=1e3/60,D.MAX_NUMBER=1e7,D.user=0,D.scaleLight=[2],D.useByte=!0,D.fogColor=[0,0,0],D.fogData=[1e3,.003],D.gameAngle=0,D.sceneNumId=0,D.supportBlob=!1,D.SCALE_Z=1/Math.sin(f.SCENE_2D_ROTATION_45*Math.PI/180);class b{constructor(t=0,e=0,i=0,a=1){this.x=0,this.y=0,this.z=0,this.w=1,this.x=t,this.y=e,this.z=i,this.w=a}normalize(){var t=this.length;0!=t&&this.scaleBy(1/t)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}scaleBy(t){this.x*=t,this.y*=t,this.z*=t,this.w*=t}divideScalar(t){0!=t?(this.x=this.x/t,this.y=this.y/t,this.z=this.z/t):(this.x=0,this.y=0,this.z=0)}distanceToSquared(t){return b.distance(this,t)}scaleByW(){this.x*=this.w,this.y*=this.w,this.z*=this.w}add(t){return new b(this.x+t.x,this.y+t.y,this.z+t.z)}subtract(t){return new b(this.x-t.x,this.y-t.y,this.z-t.z)}addByNum(t,e,i,a=0){this.x+=t,this.y+=e,this.z+=i,this.w+=a}setTo(t,e,i){this.x=t,this.y=e,this.z=i}setByte(t){this.x=t.readFloat(),this.y=t.readFloat(),this.z=t.readFloat()}cross(t){return new b(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}clone(){return new b(this.x,this.y,this.z)}static distance(t,e){var i=t.x-e.x,a=t.y-e.y,s=t.z-e.z;return Math.sqrt(i*i+a*a+s*s)}toString(){return"Vector3D("+String(this.x)+","+String(this.y)+","+String(this.z)+","+String(this.w)+")"}}b.X_AXIS=new b(1,0,0),b.Y_AXIS=new b(0,1,0),b.Z_AXIS=new b(0,0,1);class w{}w.LITTLE_ENDIAN="littleEndian",w.BIG_ENDIAN="bigEndian";class A{constructor(t){this.BUFFER_EXT_SIZE=0,this.optcode=0,this.EOF_byte=-1,this.EOF_code_point=-1,this._setArrayBuffer(t||new ArrayBuffer(this.BUFFER_EXT_SIZE)),this.endian=w.BIG_ENDIAN}_setArrayBuffer(t){this.write_position=t.byteLength,this.data=new DataView(t),this._position=0}setdata(t){this._setArrayBuffer(t.buffer)}get buffer(){return this.data.buffer}set buffer(t){this.data=new DataView(t)}get dataView(){return this.data}set dataView(t){this.data=t,this.write_position=t.byteLength}get bufferOffset(){return this.data.byteOffset}getByte(t){return this.data.getUint8(t)}setByte(t,e){this.data.setUint8(t,e)}get position(){return this._position}set position(t){this._position=t,this.write_position=t>this.write_position?t:this.write_position}reset(){this.clear()}get length(){return this.write_position}set length(t){this.validateBuffer(t,!0)}get bytesAvailable(){return this.data.byteLength-this._position}clear(){this._setArrayBuffer(new ArrayBuffer(this.BUFFER_EXT_SIZE))}readBoolean(){return 0!=this.data.getUint8(this.position++)}readByte(){return this.data.getInt8(this.position++)}readBytes(t,e=0,i=0){for(var a=0;a<i;a++)t.data.setUint8(a+e,this.data.getUint8(this.position++))}readDouble(){var t=this.data.getFloat64(this.position,this.endian==w.LITTLE_ENDIAN);return this.position+=A.SIZE_OF_FLOAT64,t}readFloat(){var t=this.data.getFloat32(this.position,this.endian==w.LITTLE_ENDIAN);return this.position+=A.SIZE_OF_FLOAT32,t}readInt(){var t=this.data.getInt32(this.position,this.endian==w.LITTLE_ENDIAN);return this.position+=A.SIZE_OF_INT32,t}getInt(){return this.data.getInt32(this.position,this.endian==w.LITTLE_ENDIAN)}readInt32(){return this.readInt()}readShort(){this.position,this.data.byteLength;var t=this.data.getInt16(this.position,this.endian==w.LITTLE_ENDIAN);return this.position+=A.SIZE_OF_INT16,t}readFloatTwoByte(t){return this.readShort()/t}readFloatOneByte(){return(this.readByte()+128)/256}readUnsignedByte(){return this.data.getUint8(this.position++)}readUint8(){return this.readUnsignedByte()}readInt8(){return this.readByte()}readUnsignedInt(){var t=this.data.getUint32(this.position,this.endian==w.LITTLE_ENDIAN);return this.position+=A.SIZE_OF_UINT32,t}readUint32(){return this.readUnsignedInt()}readUint64(){return this.readDouble()}readUnsignedShort(){var t=this.data.getUint16(this.position,this.endian==w.LITTLE_ENDIAN);return this.position+=A.SIZE_OF_UINT16,t}readUint16(){return this.readUnsignedShort()}readUTF(){var t=this.data.getUint16(this.position,this.endian==w.LITTLE_ENDIAN);return this.position+=A.SIZE_OF_UINT16,t>0?this.readUTFBytes(t):""}readString(){return this.readUTF()}readUTFBytes(t){var e=new Uint8Array(this.buffer,this.bufferOffset+this.position,t);return this.position+=t,this.decodeUTF8(e)}readStringByLen(t){return this.readUTFBytes(t)}writeBoolean(t){this.validateBuffer(A.SIZE_OF_BOOLEAN),this.data.setUint8(this.position++,t?1:0)}writeByte(t){this.validateBuffer(A.SIZE_OF_INT8),this.data.setInt8(this.position++,t)}writeUint8(t){this.writeByte(t)}writeInt8(t){this.writeByte(t)}writeBytes(t,e=0,i=0){var a;if(!(e<0)&&!(i<0)&&(a=0==i?t.length-e:Math.min(t.length-e,i))>0){this.validateBuffer(a);for(var s=new DataView(t.buffer),r=e;r<a+e;r++)this.data.setUint8(this.position++,s.getUint8(r))}}writeDouble(t){this.validateBuffer(A.SIZE_OF_FLOAT64),this.data.setFloat64(this.position,t,this.endian==w.LITTLE_ENDIAN),this.position+=A.SIZE_OF_FLOAT64}writeFloat(t){this.validateBuffer(A.SIZE_OF_FLOAT32),this.data.setFloat32(this.position,t,this.endian==w.LITTLE_ENDIAN),this.position+=A.SIZE_OF_FLOAT32}writeInt(t){this.validateBuffer(A.SIZE_OF_INT32),this.data.setInt32(this.position,t,this.endian==w.LITTLE_ENDIAN),this.position+=A.SIZE_OF_INT32}writeInt32(t){this.writeInt(t)}writeUnsignedShort(t){this.validateBuffer(A.SIZE_OF_INT16),this.data.setInt16(this.position,t,this.endian==w.LITTLE_ENDIAN),this.position+=A.SIZE_OF_INT16}writeUint16(t){this.writeUnsignedShort(t)}writeUint64(t){this.validateBuffer(A.SIZE_OF_FLOAT64),this.data.setFloat64(this.position,t,this.endian==w.LITTLE_ENDIAN),this.position+=A.SIZE_OF_FLOAT64}writeShort(t){this.validateBuffer(A.SIZE_OF_INT16),this.data.setUint16(this.position,t,this.endian==w.LITTLE_ENDIAN),this.position+=A.SIZE_OF_INT16}writeUnsignedInt(t){this.validateBuffer(A.SIZE_OF_UINT32),this.data.setUint32(this.position,t,this.endian==w.LITTLE_ENDIAN),this.position+=A.SIZE_OF_UINT32}writeUint32(t){this.writeUnsignedInt(t)}writeUTF(t){var e=this.encodeUTF8(t),i=e.length;this.validateBuffer(A.SIZE_OF_UINT16+i),this.data.setUint16(this.position,i,this.endian===w.LITTLE_ENDIAN),this.position+=A.SIZE_OF_UINT16,this._writeUint8Array(e,!1)}writeString(t){var e=new A;e.writeUTFBytes(t),this.writeUint16(e.length+1),this.writeBytes(e,0,e.length),this.writeByte(0)}writeStringByLen(t,e){var i=this.position;this.writeUTFBytes(t),this.position=i+e,this.length=this.position+1}readVector3D(t=!1){var e=new b;return e.x=this.readFloat(),e.y=this.readFloat(),e.z=this.readFloat(),t&&(e.w=this.readFloat()),e}writeUTFBytes(t){this._writeUint8Array(this.encodeUTF8(t))}toString(){return"[ByteArray] length:"+this.length+", bytesAvailable:"+this.bytesAvailable}_writeUint8Array(t,e=!0){e&&this.validateBuffer(this.position+t.length);for(var i=0;i<t.length;i++)this.data.setUint8(this.position++,t[i])}validate(t){if(this.data.byteLength>0&&this._position+t<=this.data.byteLength)return!0}validateBuffer(t,e=!1){if(this.write_position=t>this.write_position?t:this.write_position,t+=this._position,this.data.byteLength<t||e){var i=new Uint8Array(new ArrayBuffer(t+this.BUFFER_EXT_SIZE)),a=Math.min(this.data.buffer.byteLength,t+this.BUFFER_EXT_SIZE);i.set(new Uint8Array(this.data.buffer,0,a)),this.buffer=i.buffer}}encodeUTF8(t){for(var e=0,i=this.stringToCodePoints(t),a=[];i.length>e;){var s=i[e++];if(this.inRange(s,55296,57343))this.encoderError(s);else if(this.inRange(s,0,127))a.push(s);else{var r,n;for(this.inRange(s,128,2047)?(r=1,n=192):this.inRange(s,2048,65535)?(r=2,n=224):this.inRange(s,65536,1114111)&&(r=3,n=240),a.push(this.div(s,Math.pow(64,r))+n);r>0;){var h=this.div(s,Math.pow(64,r-1));a.push(128+h%64),r-=1}}}return new Uint8Array(a)}decodeUTF8(t){for(var e,i=0,a="",s=0,r=0,n=0,h=0;t.length>i;){var o=t[i++];if(o===this.EOF_byte)e=0!==r?this.decoderError(!1):this.EOF_code_point;else if(0===r)this.inRange(o,0,127)?e=o:(this.inRange(o,194,223)?(r=1,h=128,s=o-192):this.inRange(o,224,239)?(r=2,h=2048,s=o-224):this.inRange(o,240,244)?(r=3,h=65536,s=o-240):this.decoderError(!1),s*=Math.pow(64,r),e=null);else if(this.inRange(o,128,191))if(n+=1,s+=(o-128)*Math.pow(64,r-n),n!==r)e=null;else{var l=s,c=h;s=0,r=0,n=0,h=0,e=this.inRange(l,c,1114111)&&!this.inRange(l,55296,57343)?l:this.decoderError(!1,o)}else s=0,r=0,n=0,h=0,i--,e=this.decoderError(!1,o);null!==e&&e!==this.EOF_code_point&&(e<=65535?e>0&&(a+=String.fromCharCode(e)):(e-=65536,a+=String.fromCharCode(55296+(e>>10&1023)),a+=String.fromCharCode(56320+(1023&e))))}return a}encoderError(t){}decoderError(t,e){return e||65533}inRange(t,e,i){return e<=t&&t<=i}div(t,e){return Math.floor(t/e)}stringToCodePoints(t){for(var e=[],i=0,a=t.length;i<t.length;){var s=t.charCodeAt(i);if(this.inRange(s,55296,57343))if(this.inRange(s,56320,57343))e.push(65533);else if(i===a-1)e.push(65533);else{var r=t.charCodeAt(i+1);if(this.inRange(r,56320,57343)){var n=1023&s,h=1023&r;i+=1,e.push(65536+(n<<10)+h)}else e.push(65533)}else e.push(s);i+=1}return e}}A.SIZE_OF_BOOLEAN=1,A.SIZE_OF_INT8=1,A.SIZE_OF_INT16=2,A.SIZE_OF_INT32=4,A.SIZE_OF_UINT8=1,A.SIZE_OF_UINT16=2,A.SIZE_OF_UINT32=4,A.SIZE_OF_FLOAT32=4,A.SIZE_OF_FLOAT64=8;class M{static float2int(t){return 0|t}static radian2angle(t){return t/Math.PI*180}static angle2radian(t){return t/180*Math.PI}static getChiNum(t){return M.keyChi[t]}static hexToArgb(t,e=!0,i=null){return i||(i=new b),i.w=e?t>>24&255:0,i.x=t>>16&255,i.y=t>>8&255,i.z=255&t,i}static hexToArgbNum(t,e=!0,i=null){return(i=M.hexToArgb(t,e,i)).scaleBy(1/255),i}static getBaseUrl(){return D.supportBlob?"":"_base"}static strokeFilter(t,e,i,a){for(var s=M.hexToArgb(a),r=t.getImageData(0,0,e,i),n=r.data,h=new Array,o=1;o<e-1;o++)for(var l=0;l<i-1;l++){var c=d(o,l);0==n[c+3]&&u(o,l)&&h.push(c)}for(o=0;o<h.length;o++)n[h[o]]=s.x,n[h[o]+1]=s.y,n[h[o]+2]=s.z,n[h[o]+3]=s.w;function d(t,i){return 4*(i*e+t)}function u(t,e){var i;return i=d(t-1,e),n[i+3]>0||(i=d(t+1,e),n[i+3]>0||(i=d(t,e+1),n[i+3]>0||(i=d(t,e-1),n[i+3]>0)))}t.putImageData(r,0,0)}static trim(t){return M.trimRight(M.trimLeft(t))}static trimLeft(t){if(null==t)return"";var e=new String(" \t\n\r"),i=new String(t);if(-1!=e.indexOf(i.charAt(0))){for(var a=0,s=i.length;a<s&&-1!=e.indexOf(i.charAt(a));)a++;i=i.substring(a,s)}return i}static trimRight(t){if(null==t)return"";var e=new String(" \t\n\r"),i=new String(t);if(-1!=e.indexOf(i.charAt(i.length-1))){for(var a=i.length-1;a>=0&&-1!=e.indexOf(i.charAt(a));)a--;i=i.substring(0,a+1)}return i}static TweenMoveTo(t,e,i){}static getScencdStr(t){var e=Math.floor(t/60%60),i=Math.floor(t%60);return String(e<10?"0":"")+String(e)+":"+String(i<10?"0":"")+String(i)}static random(t){return Math.floor(Math.random()*t)}static randomByItem(t){return t[M.random(t.length)]}static makeArray(t,e){for(var i=0;i<t.length;i++)e.push(t[i])}static unZip(t){var e=new Uint8Array(t);return new Zlib.Inflate(e).decompress().buffer}static getZipByte(t){var e=t.readInt(),i=t.buffer.slice(t.position,t.position+e);t.position+=e;var a=M.unZip(i);return new A(a)}static getUrlParam(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=window.location.search.substr(1).match(e);return null!=i?decodeURI(i[2]):null}static copy2clipboard(t){var e=document.createElement("textarea");e.style.fontSize="12pt",e.style.position="absolute",e.style["z-index"]=-1,e.style.background="transparent",e.style.border="transparent",e.style.color="white",e.setAttribute("readonly",""),document.body.appendChild(e),e.value=t,e.select(),e.setSelectionRange(0,e.value.length);try{document.execCommand("copy")}catch(t){alert("不支持复制")}setTimeout((function(){document.body.removeChild(e)}),1e3)}static getBit(t,e){return Boolean(t>>(31&e)&1)}}M.keyChi=["零","一","二","三","四","五","六","七","八","九","十","十一","十二","十三","十四","十五"];class T{static getTimer(){return Date.now()-T.START_TIME}static getTimerSecond(){return T.getTimer()/1e3}static saveNowTime(){this.lastTime=this.getTimer()}static getUseTime(){return this.getTimer()-this.lastTime}static getZeroTime(t){var e=new Date(1e3*t);return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.getTime()/1e3}static getLocalTime(t){var e=new Date(1e3*t);return e.toLocaleDateString().replace(/\//g,"-")+" "+e.toTimeString().substr(0,5)}static getLocalTime0(t){return new Date(1e3*t).toLocaleDateString().replace(/\//g,"-")}static getLocalTime1(t){var e=new Date(1e3*t);return e.toLocaleDateString().replace(/\//g,"-")+" "+e.toTimeString().substr(0,8)}static getLocalTime2(t){return new Date(1e3*t).toTimeString().substr(0,8)}static getLocalTime6(t){return new Date(1e3*t).toTimeString().substr(0,5)}static getLocalTime3(t){return new Date(1e3*t).toTimeString().substr(3,5)}static getLocalTime4(t){return M.float2int(t/60)+"分"+t%60+"秒"}static getLocalTime5(t){var e=new Date(1e3*t).toTimeString().substr(0,8).split(":");return e[0]+"时"+e[1]+"分"+e[2]+"秒"}static getDiffTime1(t){var e=M.float2int(t/this.dayTime);t-=e*this.dayTime;var i=M.float2int(t/this.HourTime);t-=i*this.HourTime;var a=M.float2int(t/this.MinuteTime);return e+"天"+i+"时"+a+"分"+(t-=a*this.MinuteTime)+"秒"}static getDiffTime2(t){var e=M.float2int(t/this.HourTime);t-=e*this.HourTime;var i=M.float2int(t/this.MinuteTime);return t-=i*this.MinuteTime,this.zeroStr(e)+":"+this.zeroStr(i)+":"+this.zeroStr(t)}static zeroStr(t){return t>9?String(t):"0"+t}static getDelayTimeStr(t){var e=Math.floor(t/3600);return e>24?Math.floor(e/24)+"天前":e>=1?e+"小时前":"刚刚"}static compareTime(t,e){return!1}static init(){T.START_TIME=Date.now()}static addTimeTick(t,e,i=0){var a=new S;a.alltime=t,a.fun=e,a.time=t-i,T.timefunAry.push(a)}static removeTimeTick(t){for(var e=0;e<T.timefunAry.length;e++)if(T.timefunAry[e]&&T.timefunAry[e].fun==t){T.timefunAry[e]=null;break}}static addTimeOut(t,e){if(!this.hasTimeOut(e)){var i=new P;i.alltime=t,i.fun=e,i.time=0,T.outTimeFunAry.push(i)}}static removeTimeOut(t){for(var e=0;e<T.outTimeFunAry.length;e++)if(T.outTimeFunAry[e]&&T.outTimeFunAry[e].fun==t){T.outTimeFunAry[e]=null;break}}static hasTimeOut(t){for(var e=0;e<T.outTimeFunAry.length;e++)if(T.outTimeFunAry[e]&&T.outTimeFunAry[e].fun==t)return!0;return!1}static addFrameTick(t){-1==T.funAry.indexOf(t)&&T.funAry.push(t)}static hasFrameTick(t){return-1!=T.funAry.indexOf(t)}static removeFrameTick(t){var e=T.funAry.indexOf(t);-1!=e&&(T.funAry[e]=null)}static update(){for(var t=T.getTimer()-T.time,e=0;e<T.funAry.length;e++)T.funAry[e]&&T.funAry[e](t);for(e=0;e<T.timefunAry.length;e++)T.timefunAry[e]&&T.timefunAry[e].update(t);for(e=T.outTimeFunAry.length-1;e>=0;e--)T.outTimeFunAry[e]&&T.outTimeFunAry[e].update(t)&&(T.outTimeFunAry[e]=null);for(e=T.funAry.length-1;e>=0;e--)T.funAry[e]||T.funAry.splice(e,1);for(e=T.timefunAry.length-1;e>=0;e--)T.timefunAry[e]||T.timefunAry.splice(e,1);for(e=T.outTimeFunAry.length-1;e>=0;e--)T.outTimeFunAry[e]||T.outTimeFunAry.splice(e,1);T.time=T.getTimer()}}T.funAry=new Array,T.timefunAry=new Array,T.outTimeFunAry=new Array,T.time=0,T.lastTime=0,T.dayTime=86400,T.HourTime=3600,T.MinuteTime=60;class S{constructor(){this.alltime=0,this.time=0}update(t){this.time+=t,this.time>=this.alltime&&(this.fun(),this.time=0)}}class P{constructor(){this.alltime=0,this.time=0}update(t){return this.time+=t,this.time>=this.alltime&&(this.fun(),!0)}}class I{static init(t){}static resetSize(t=0,e=0){}static resetViewMatrx3D(){}static unload(){}}I.needVertical=!0,I.needInputTxt=!1,I.sceneCamScale=1.76;class R{destory(){}}class L extends R{constructor(){super(...arguments),this._useNum=0,this.idleTime=0}get useNum(){return this._useNum}set useNum(t){this._useNum=t,0==this._useNum&&(this.idleTime=0)}clearUseNum(){this._useNum--,this._useNum<=0&&(this.idleTime=L.GCTime)}}L.GCTime=4;class B extends L{constructor(){super(),this.fragment=this.getFragmentShaderString()}encode(){this.vertex=this.getVertexShaderString();var t=D.context3D.renderContext;this.program=t.createProgram(),this.vShader=t.createShader(t.VERTEX_SHADER),this.fShader=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(this.vShader,this.vertex),t.shaderSource(this.fShader,this.fragment),t.compileShader(this.vShader),t.compileShader(this.fShader),t.attachShader(this.program,this.vShader),t.attachShader(this.program,this.fShader),this.binLocation(t),t.linkProgram(this.program),this.localDic=new Object;var e=t.getProgramInfoLog(this.program),i=t.getShaderInfoLog(this.vShader),a=t.getShaderInfoLog(this.fShader);return""==e||""==i&&""==a}getWebGLUniformLocation(t){var e=this.localDic[t];return e||(this.localDic[t]=D.context3D.getLocation(this.program,t),this.localDic[t])}binLocation(t){}getVertexShaderString(){return""}getFragmentShaderString(){return""}destory(){this.vertex=null,this.fragment=null,this.name=null,this.localDic=null,D.context3D.deleteShader(this)}}class C extends B{constructor(){super(),this.name="Material_Anim_shader"}binLocation(t){t.bindAttribLocation(this.program,0,"pos"),t.bindAttribLocation(this.program,1,"v2Uv"),t.bindAttribLocation(this.program,2,"boneID"),t.bindAttribLocation(this.program,3,"boneWeight");var e=this.paramAry[0],i=this.paramAry[1],a=this.paramAry[4],s=this.paramAry[5];e?(t.bindAttribLocation(this.program,4,"normal"),i&&(t.bindAttribLocation(this.program,5,"tangent"),t.bindAttribLocation(this.program,6,"bitangent"))):(a||s)&&t.bindAttribLocation(this.program,4,"normal")}static getMd5M44Str(){return"vec4 qdv(vec4 q,vec3 d, vec3 v ){\nvec3 t = 2.0 * cross(q.xyz, v);\nvec3 f = v + q.w * t + cross(q.xyz, t);\nreturn  vec4(f.x+d.x,f.y+d.y,f.z+d.z,1.0);\n }\nvec4 getQDdata(vec3 vdata){\nvec4 tempnum = qdv(boneQ[int(boneID.x)],boneD[int(boneID.x)],vdata) * boneWeight.x;\ntempnum += qdv(boneQ[int(boneID.y)],boneD[int(boneID.y)],vdata) * boneWeight.y;\ntempnum += qdv(boneQ[int(boneID.z)],boneD[int(boneID.z)],vdata)* boneWeight.z;\ntempnum += qdv(boneQ[int(boneID.w)],boneD[int(boneID.w)],vdata) * boneWeight.w;\ntempnum.x = tempnum.x*-1.0;\nreturn  tempnum;\n }\n"}static getMd5M44NrmStr(){return"vec4 qdvNrm(vec4 q, vec3 v ){\nvec3 t = 2.0 * cross(q.xyz, v);\nvec3 f = v + q.w * t + cross(q.xyz, t);\nreturn  vec4(f.x,f.y,f.z,1.0);\n }\nvec4 getQDdataNrm(vec3 vdata){\nvec4 tempnum = qdvNrm(boneQ[int(boneID.x)],vdata) * boneWeight.x;\ntempnum += qdvNrm(boneQ[int(boneID.y)],vdata) * boneWeight.y;\ntempnum += qdvNrm(boneQ[int(boneID.z)],vdata)* boneWeight.z;\ntempnum += qdvNrm(boneQ[int(boneID.w)],vdata) * boneWeight.w;\ntempnum.x = tempnum.x*-1.0;\ntempnum.xyz = normalize(tempnum.xyz);\nreturn  tempnum;\n }\n"}getVertexShaderString(){var t=this.paramAry[0],e=this.paramAry[1],i=(this.paramAry[2],this.paramAry[3],this.paramAry[4]),a=this.paramAry[5],s=this.paramAry[6],r="attribute vec4 pos;\nattribute vec2 v2Uv;\nattribute vec4 boneID;\nattribute vec4 boneWeight;\nvarying vec2 v0;\nuniform vec4 boneQ[54];\nuniform vec3 boneD[54];\nuniform mat4 vpMatrix3D;\nuniform mat4 posMatrix3D;\n";return i?r+="uniform vec3 sh[9];\nvarying vec3 v2;\n":a?r+="uniform vec3 sunDirect;\nuniform vec3 sunColor;\nuniform vec3 ambientColor;\nvarying vec3 v2;\n":s||(r+="varying vec2 v2;\n"),t?(r+="attribute vec4 normal;\nuniform mat4 rotationMatrix3D;\nvarying vec3 v1;\n",r+=e?"varying mat3 v4;\n":"varying vec3 v4;\n",e&&(r+="attribute vec4 tangent;\nattribute vec4 bitangent;\n")):(i||a)&&(r+="attribute vec4 normal;\nuniform mat4 rotationMatrix3D;\n"),r+=C.getMd5M44Str()+C.getMd5M44NrmStr()+"void main(void){\nv0 = v2Uv;\nvec4 vt0 = getQDdata(vec3(pos.x,pos.y,pos.z));\nvt0.xyz = vt0.xyz*1.0;\nvt0 = posMatrix3D * vt0;\n",t&&(r+="v1 = vec3(vt0.x,vt0.y,vt0.z);\n"),r+="vt0 = vpMatrix3D * vt0;\ngl_Position = vt0;\n",t?r+=e?"vec4 vt2 = getQDdataNrm(vec3(tangent.x,tangent.y,tangent.z));\nvt2 = rotationMatrix3D * vt2;\nvt2.xyz = normalize(vt2.xyz);\nvec4 vt1 = getQDdataNrm(vec3(bitangent.x,bitangent.y,bitangent.z));\nvt1 = rotationMatrix3D * vt1;\nvt1.xyz = normalize(vt1.xyz);\nvt0 = getQDdataNrm(vec3(normal.x,normal.y,normal.z));\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\nv4 = mat3(vec3(vt2.x,vt2.y,vt2.z),vec3(vt1.x,vt1.y,vt1.z),vec3(vt0.x,vt0.y,vt0.z));\n":"vt0 = getQDdataNrm(vec3(normal.x,normal.y,normal.z));\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\nv4 = vec3(vt0.x,vt0.y,vt0.z);\n":(i||a)&&(r+="vt0 = getQDdataNrm(vec3(normal.x,normal.y,normal.z));\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\n"),i?r+="vec3 lpb = sh[0] * 0.28209479177387814;\nlpb += sh[1] * (vt0.y * -0.4886025119029199);\nlpb += sh[2] * (vt0.z * 0.4886025119029199);\nlpb += sh[3] * (vt0.x * -0.4886025119029199);\nlpb += sh[4] * (vt0.x * vt0.y * 1.0925484305920792);\nlpb += sh[5] * (vt0.z * vt0.y * -1.0925484305920792);\nlpb += sh[6] * ((3.0 * vt0.z * vt0.z - 1.0) * 0.31539156525252005);\nlpb += sh[7] * (vt0.z * vt0.x * -1.0925484305920792);\nlpb += sh[8] * ((vt0.x * vt0.x - vt0.y * vt0.y) * 0.5462742152960396);\nv2 = lpb;\n":a?r+="float suncos = dot(vt0.xyz,sunDirect.xyz);\nsuncos = clamp(suncos,0.0,1.0);\nv2 = sunColor * suncos + ambientColor;":s||(r+="v2 = v2Uv;\n"),r+="}"}getFragmentShaderString(){return"uniform sampler2D s_texture1;\nuniform vec4 testconst;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz = testconst.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}"}}C.MATERIAL_ANIM_SHADER="Material_Anim_shader";class F extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position")}getVertexShaderString(){return"attribute vec3 v3Position;uniform mat4 uMMatrix;uniform mat4 uMProjCameraMatrix;uniform vec3 uLightLocation;void main(void){   vec3 A=vec3(0.0,0.1,0.0);   vec3 n=vec3(0.0,1.0,0.0);   vec3 S=uLightLocation;   vec3 V=(uMMatrix*vec4(v3Position,1)).xyz;    vec3 VL=S+(V-S)*(dot(n,(A-S))/dot(n,(V-S)));   gl_Position = uMProjCameraMatrix*vec4(VL,1);}"}getFragmentShaderString(){return"precision mediump float;\nvoid main(){\n   gl_FragColor = vec4(0,0,0,0.5);\n}\n"}static makePlanarShadowShader(){var t=new F;return t.encode(),t}static getInst(){return F.singleton||(F.singleton=F.makePlanarShadowShader()),F.singleton}static setLightPos(t){F.lightPos.x=t.x,F.lightPos.y=t.y,F.lightPos.z=t.z}static getLightPosArry(t){return F.lightPosArray[0]=t.x+F.lightPos.x,F.lightPosArray[1]=t.y+F.lightPos.y,F.lightPosArray[2]=t.z+F.lightPos.z,F.lightPosArray}}F.PLANAR_SHADOW_SHADER="PlanarShadowShader",F.lightPos=new b(3800,-4e3,-1400),F.lightPosArray=new Float32Array([3800,-4e3,-1400]);class z extends C{constructor(){super(),this.name=z.ANIM_PLANAR_SHADOW_SHADER}binLocation(t){t.bindAttribLocation(this.program,0,"pos"),t.bindAttribLocation(this.program,1,"v2Uv"),t.bindAttribLocation(this.program,2,"boneID"),t.bindAttribLocation(this.program,3,"boneWeight")}getVertexShaderString(){return"attribute vec4 pos;\nattribute vec2 v2Uv;\nattribute vec4 boneID;\nattribute vec4 boneWeight;\nuniform vec4 boneQ[54];\nuniform vec3 boneD[54];\nuniform mat4 uMMatrix;uniform mat4 uMProjCameraMatrix;\nuniform vec3 uLightLocation;\n"+C.getMd5M44Str()+"\nvoid main(void){\n   vec4 v3Position = getQDdata(vec3(pos.x,pos.y,pos.z));\n   vec3 A=vec3(0.0,0.1,0.0);\n   vec3 n=vec3(0.0,1.0,0.0);\n   vec3 S=uLightLocation;\n   vec3 V=(uMMatrix*vec4(v3Position.xyz,1)).xyz;\n   vec3 VL=S+(V-S)*(dot(n,(A-S))/dot(n,(V-S)));\n   gl_Position = uMProjCameraMatrix*vec4(VL,1);\n}\n"}getFragmentShaderString(){return"precision mediump float;\nvoid main(){\n   gl_FragColor = vec4(0,0,0,0.5);\n}\n"}}z.ANIM_PLANAR_SHADOW_SHADER="AnimPlanarShadowShader";class E{constructor(t=0,e=0,i=0,a=1){this.x=0,this.y=0,this.z=0,this.w=1,this.x=t,this.y=e,this.z=i,this.w=a}print(){alert(String(this.x)+" "+String(this.y)+" "+String(this.z)+" "+String(this.w))}toEulerAngles(t=null){t||(t=new b);var e=this.x,i=this.y,a=this.z,s=this.w;return t.x=Math.atan2(2*(s*e+i*a),1-2*(e*e+i*i)),t.y=Math.asin(2*(s*i-a*e)),t.z=Math.atan2(2*(s*a+e*i),1-2*(i*i+a*a)),t}toMatrix3D(t=null){t||(t=new V);var e=t.m,i=this.x,a=this.y,s=this.z,r=this.w,n=i+i,h=a+a,o=s+s,l=i*n,c=a*n,d=a*h,u=s*n,m=s*h,p=s*o,y=r*n,x=r*h,v=r*o;return e[0]=1-d-p,e[1]=c+v,e[2]=u-x,e[3]=0,e[4]=c-v,e[5]=1-l-p,e[6]=m+y,e[7]=0,e[8]=u+x,e[9]=m-y,e[10]=1-l-d,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,t}fromAxisAngle(t,e){var i=Math.sin(e/2),a=Math.cos(e/2);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=a,this.normalize()}normalize(t=1){var e=t/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);this.x*=e,this.y*=e,this.z*=e,this.w*=e}fromMatrix(t){var e=[0,0,0,0,0,0,0,0,0];e[0]=t.m[0],e[1]=t.m[1],e[2]=t.m[2],e[3]=t.m[4],e[4]=t.m[5],e[5]=t.m[6],e[6]=t.m[8],e[7]=t.m[9],e[8]=t.m[10];var i,a=e[0]+e[4]+e[8],s=[0,0,0,0];if(a>0)i=Math.sqrt(a+1),s[3]=.5*i,i=.5/i,s[0]=(e[5]-e[7])*i,s[1]=(e[6]-e[2])*i,s[2]=(e[1]-e[3])*i;else{var r=0;e[4]>e[0]&&(r=1),e[8]>e[3*r+r]&&(r=2);var n=(r+1)%3,h=(r+2)%3;i=Math.sqrt(e[3*r+r]-e[3*n+n]-e[3*h+h]+1),s[r]=.5*i,i=.5/i,s[3]=(e[3*n+h]-e[3*h+n])*i,s[n]=(e[3*n+r]+e[3*r+n])*i,s[h]=(e[3*h+r]+e[3*r+h])*i}this.x=s[0],this.y=s[1],this.z=s[2],this.w=s[3]}setMd5W(){this.w=1-(this.x*this.x+this.y*this.y+this.z*this.z),this.w<0?this.w=0:this.w=-Math.sqrt(this.w)}slerp(t,e,i){var a=t.w,s=t.x,r=t.y,n=t.z,h=e.w,o=e.x,l=e.y,c=e.z,d=a*h+s*o+r*l+n*c;if(d<0&&(d=-d,h=-h,o=-o,l=-l,c=-c),d<.95){var u=Math.acos(d),m=1/Math.sin(u),p=Math.sin(u*(1-i))*m,y=Math.sin(u*i)*m;this.w=a*p+h*y,this.x=s*p+o*y,this.y=r*p+l*y,this.z=n*p+c*y}else{this.w=a+i*(h-a),this.x=s+i*(o-s),this.y=r+i*(l-r),this.z=n+i*(c-n);var x=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=x,this.x*=x,this.y*=x,this.z*=x}}}class V{constructor(){this.isIdentity=!0;this.m=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}clone(t=null){return t||(t=new V),t.m[0]=this.m[0],t.m[1]=this.m[1],t.m[2]=this.m[2],t.m[3]=this.m[3],t.m[4]=this.m[4],t.m[5]=this.m[5],t.m[6]=this.m[6],t.m[7]=this.m[7],t.m[8]=this.m[8],t.m[9]=this.m[9],t.m[10]=this.m[10],t.m[11]=this.m[11],t.m[12]=this.m[12],t.m[13]=this.m[13],t.m[14]=this.m[14],t.m[15]=this.m[15],t}get position(){return new b(this.m[12],this.m[13],this.m[14],this.m[15])}copyTo(t){t.m[0]=this.m[0],t.m[1]=this.m[1],t.m[2]=this.m[2],t.m[3]=this.m[3],t.m[4]=this.m[4],t.m[5]=this.m[5],t.m[6]=this.m[6],t.m[7]=this.m[7],t.m[8]=this.m[8],t.m[9]=this.m[9],t.m[10]=this.m[10],t.m[11]=this.m[11],t.m[12]=this.m[12],t.m[13]=this.m[13],t.m[14]=this.m[14],t.m[15]=this.m[15]}identity(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=1,this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=1,this.m[11]=0,this.m[12]=0,this.m[13]=0,this.m[14]=0,this.m[15]=1}invert(){var t=this.m,e=t[0],i=t[1],a=t[2],s=t[3],r=t[4],n=t[5],h=t[6],o=t[7],l=t[8],c=t[9],d=t[10],u=t[11],m=t[12],p=t[13],y=t[14],x=t[15],v=e*n-i*r,g=e*h-a*r,_=e*o-s*r,f=i*h-a*n,D=i*o-s*n,b=a*o-s*h,w=l*p-c*m,A=l*y-d*m,M=l*x-u*m,T=c*y-d*p,S=c*x-u*p,P=d*x-u*y,I=v*P-g*S+_*T+f*M-D*A+b*w;if(!I)return null;I=1/I,this.m[0]=(n*P-h*S+o*T)*I,this.m[1]=(a*S-i*P-s*T)*I,this.m[2]=(p*b-y*D+x*f)*I,this.m[3]=(d*D-c*b-u*f)*I,this.m[4]=(h*M-r*P-o*A)*I,this.m[5]=(e*P-a*M+s*A)*I,this.m[6]=(y*_-m*b-x*g)*I,this.m[7]=(l*b-d*_+u*g)*I,this.m[8]=(r*S-n*M+o*w)*I,this.m[9]=(i*M-e*S-s*w)*I,this.m[10]=(m*D-p*_+x*v)*I,this.m[11]=(c*_-l*D-u*v)*I,this.m[12]=(n*A-r*T-h*w)*I,this.m[13]=(e*T-i*A+a*w)*I,this.m[14]=(p*g-m*f-y*v)*I,this.m[15]=(l*f-c*g+d*v)*I}invertToMatrix(t){var e=this.m,i=e[0],a=e[1],s=e[2],r=e[3],n=e[4],h=e[5],o=e[6],l=e[7],c=e[8],d=e[9],u=e[10],m=e[11],p=e[12],y=e[13],x=e[14],v=e[15],g=i*h-a*n,_=i*o-s*n,f=i*l-r*n,D=a*o-s*h,b=a*l-r*h,w=s*l-r*o,A=c*y-d*p,M=c*x-u*p,T=c*v-m*p,S=d*x-u*y,P=d*v-m*y,I=u*v-m*x,R=g*I-_*P+f*S+D*T-b*M+w*A;if(!R)return null;R=1/R,t.m[0]=(h*I-o*P+l*S)*R,t.m[1]=(s*P-a*I-r*S)*R,t.m[2]=(y*w-x*b+v*D)*R,t.m[3]=(u*b-d*w-m*D)*R,t.m[4]=(o*T-n*I-l*M)*R,t.m[5]=(i*I-s*T+r*M)*R,t.m[6]=(x*f-p*w-v*_)*R,t.m[7]=(c*w-u*f+m*_)*R,t.m[8]=(n*P-h*T+l*A)*R,t.m[9]=(a*T-i*P-r*A)*R,t.m[10]=(p*b-y*f+v*g)*R,t.m[11]=(d*f-c*b-m*g)*R,t.m[12]=(h*M-n*S-o*A)*R,t.m[13]=(i*S-a*M+s*A)*R,t.m[14]=(y*_-p*D-x*g)*R,t.m[15]=(c*D-d*_+u*g)*R}appendTranslation(t,e,i){V.tempM.identity(),V.tempM.prependTranslation(t,e,i),this.append(V.tempM)}prependTranslation(t,e,i){var a=this.m;a[12]=a[0]*t+a[4]*e+a[8]*i+a[12],a[13]=a[1]*t+a[5]*e+a[9]*i+a[13],a[14]=a[2]*t+a[6]*e+a[10]*i+a[14],a[15]=a[3]*t+a[7]*e+a[11]*i+a[15]}transformVector(t){var e=new b;return e.x=this.m[0]*t.x+this.m[4]*t.y+this.m[8]*t.z+this.m[12]*t.w,e.y=this.m[1]*t.x+this.m[5]*t.y+this.m[9]*t.z+this.m[13]*t.w,e.z=this.m[2]*t.x+this.m[6]*t.y+this.m[10]*t.z+this.m[14]*t.w,e.w=this.m[3]*t.x+this.m[7]*t.y+this.m[11]*t.z+this.m[15]*t.w,e}append(t){V.tempM.m[0]=t.m[0],V.tempM.m[1]=t.m[1],V.tempM.m[2]=t.m[2],V.tempM.m[3]=t.m[3],V.tempM.m[4]=t.m[4],V.tempM.m[5]=t.m[5],V.tempM.m[6]=t.m[6],V.tempM.m[7]=t.m[7],V.tempM.m[8]=t.m[8],V.tempM.m[9]=t.m[9],V.tempM.m[10]=t.m[10],V.tempM.m[11]=t.m[11],V.tempM.m[12]=t.m[12],V.tempM.m[13]=t.m[13],V.tempM.m[14]=t.m[14],V.tempM.m[15]=t.m[15],V.tempM.prepend(this),this.m[0]=V.tempM.m[0],this.m[1]=V.tempM.m[1],this.m[2]=V.tempM.m[2],this.m[3]=V.tempM.m[3],this.m[4]=V.tempM.m[4],this.m[5]=V.tempM.m[5],this.m[6]=V.tempM.m[6],this.m[7]=V.tempM.m[7],this.m[8]=V.tempM.m[8],this.m[9]=V.tempM.m[9],this.m[10]=V.tempM.m[10],this.m[11]=V.tempM.m[11],this.m[12]=V.tempM.m[12],this.m[13]=V.tempM.m[13],this.m[14]=V.tempM.m[14],this.m[15]=V.tempM.m[15]}prepend(t){var e=t.m,i=this.m,a=this.m,s=a[0],r=a[1],n=a[2],h=a[3],o=a[4],l=a[5],c=a[6],d=a[7],u=a[8],m=a[9],p=a[10],y=a[11],x=a[12],v=a[13],g=a[14],_=a[15],f=e[0],D=e[1],b=e[2],w=e[3];i[0]=f*s+D*o+b*u+w*x,i[1]=f*r+D*l+b*m+w*v,i[2]=f*n+D*c+b*p+w*g,i[3]=f*h+D*d+b*y+w*_,f=e[4],D=e[5],b=e[6],w=e[7],i[4]=f*s+D*o+b*u+w*x,i[5]=f*r+D*l+b*m+w*v,i[6]=f*n+D*c+b*p+w*g,i[7]=f*h+D*d+b*y+w*_,f=e[8],D=e[9],b=e[10],w=e[11],i[8]=f*s+D*o+b*u+w*x,i[9]=f*r+D*l+b*m+w*v,i[10]=f*n+D*c+b*p+w*g,i[11]=f*h+D*d+b*y+w*_,f=e[12],D=e[13],b=e[14],w=e[15],i[12]=f*s+D*o+b*u+w*x,i[13]=f*r+D*l+b*m+w*v,i[14]=f*n+D*c+b*p+w*g,i[15]=f*h+D*d+b*y+w*_}appendRotation(t,e){V.tempM.identity(),V.tempM.prependRotation(t,e),this.append(V.tempM)}tomat3(){Array.prototype.concat.apply([],arguments);var t=new Float32Array([1,0,0,0,1,0,0,0,1]);return t[0]=this.m[0],t[1]=this.m[1],t[2]=this.m[2],t[3]=this.m[4],t[4]=this.m[5],t[5]=this.m[6],t[6]=this.m[8],t[7]=this.m[9],t[8]=this.m[10],t}getRotaion(t){t[0]=this.m[0],t[1]=this.m[1],t[2]=this.m[2],t[3]=this.m[4],t[4]=this.m[5],t[5]=this.m[6],t[6]=this.m[8],t[7]=this.m[9],t[8]=this.m[10]}identityPostion(){this.m[12]=0,this.m[13]=0,this.m[14]=0}get x(){return this.m[12]}get y(){return this.m[13]}get z(){return this.m[14]}prependRotation(t,e){var i,a,s,r,n,h,o,l,c,d,u,m,p,y,x,v,g,_,f,D,b,w,A,M,T=this.m,S=this.m,P=e.x,I=e.y,R=e.z,L=Math.sqrt(P*P+I*I+R*R);return Math.abs(L)<1e-6?null:(P*=L=1/L,I*=L,R*=L,i=Math.sin(t*Math.PI/180),s=1-(a=Math.cos(t*Math.PI/180)),r=S[0],n=S[1],h=S[2],o=S[3],l=S[4],c=S[5],d=S[6],u=S[7],m=S[8],p=S[9],y=S[10],x=S[11],v=P*P*s+a,g=I*P*s+R*i,_=R*P*s-I*i,f=P*I*s-R*i,D=I*I*s+a,b=R*I*s+P*i,w=P*R*s+I*i,A=I*R*s-P*i,M=R*R*s+a,T[0]=r*v+l*g+m*_,T[1]=n*v+c*g+p*_,T[2]=h*v+d*g+y*_,T[3]=o*v+u*g+x*_,T[4]=r*f+l*D+m*b,T[5]=n*f+c*D+p*b,T[6]=h*f+d*D+y*b,T[7]=o*f+u*D+x*b,T[8]=r*w+l*A+m*M,T[9]=n*w+c*A+p*M,T[10]=h*w+d*A+y*M,T[11]=o*w+u*A+x*M,S!==T&&(T[12]=S[12],T[13]=S[13],T[14]=S[14],T[15]=S[15]),T)}prependScale(t,e,i){var a=this.m,s=this.m;return s[0]=a[0]*t,s[1]=a[1]*t,s[2]=a[2]*t,s[3]=a[3]*t,s[4]=a[4]*e,s[5]=a[5]*e,s[6]=a[6]*e,s[7]=a[7]*e,s[8]=a[8]*i,s[9]=a[9]*i,s[10]=a[10]*i,s[11]=a[11]*i,s[12]=a[12],s[13]=a[13],s[14]=a[14],s[15]=a[15],s}appendScale(t,e,i){V.tempM.identity(),V.tempM.prependScale(t,e,i),this.append(V.tempM)}setClipPlan(t,e){this.m[10]=e/(e-t),this.m[14]=t*e/(t-e)}perspectiveFieldOfViewLH(t,e,i,a){var s=1/Math.tan(t/2),r=s/e,n=this.m;n[0]=r,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=a/(a-i),n[11]=1,n[12]=0,n[13]=0,n[14]=i*a/(i-a),n[15]=0}fromVtoV(t,e){var i=t.cross(e);i.normalize();var a=Math.acos(t.dot(e)),s=new E;s.fromAxisAngle(i,a),s.toMatrix3D(this)}buildLookAtLH(t,e,i){var a=this.m,s=new b;s.x=e.x-t.x,s.y=e.y-t.y,s.z=e.z-t.z,s.normalize();var r=i.cross(s);r.normalize();var n=s.cross(r);a[0]=r.x,a[1]=n.x,a[2]=s.x,a[3]=0,a[4]=r.y,a[5]=n.y,a[6]=s.y,a[7]=0,a[8]=r.z,a[9]=n.z,a[10]=s.z,a[11]=0,a[12]=-r.dot(t),a[13]=-n.dot(t),a[14]=-s.dot(t),a[15]=1}static mul(t,e,i){var a=e[0],s=e[1],r=e[2],n=e[3],h=e[4],o=e[5],l=e[6],c=e[7],d=e[8],u=e[9],m=e[10],p=e[11],y=e[12],x=e[13],v=e[14];e=e[15];var g=i[0],_=i[1],f=i[2],D=i[3];return t[0]=g*a+_*h+f*d+D*y,t[1]=g*s+_*o+f*u+D*x,t[2]=g*r+_*l+f*m+D*v,t[3]=g*n+_*c+f*p+D*e,g=i[4],_=i[5],f=i[6],D=i[7],t[4]=g*a+_*h+f*d+D*y,t[5]=g*s+_*o+f*u+D*x,t[6]=g*r+_*l+f*m+D*v,t[7]=g*n+_*c+f*p+D*e,g=i[8],_=i[9],f=i[10],D=i[11],t[8]=g*a+_*h+f*d+D*y,t[9]=g*s+_*o+f*u+D*x,t[10]=g*r+_*l+f*m+D*v,t[11]=g*n+_*c+f*p+D*e,g=i[12],_=i[13],f=i[14],D=i[15],t[12]=g*a+_*h+f*d+D*y,t[13]=g*s+_*o+f*u+D*x,t[14]=g*r+_*l+f*m+D*v,t[15]=g*n+_*c+f*p+D*e,t}toEulerAngles(t=null){var e=new E;return e.fromMatrix(this),e.toEulerAngles(t)}}V.tempM=new V;class N{constructor(){this._eventsMap=null}addEventListener(t,e,i){this._eventsMap||(this._eventsMap=new Object);var a=this._eventsMap[t];a||(a=this._eventsMap[t]=[]);for(var s={listener:e,thisObject:i},r=0;r<a.length;r++){var n=a[r];if(n.listener==e&&n.thisObject==i)return}a.push(s)}removeEventListener(t,e,i){if(null!=this._eventsMap)for(var a=this._eventsMap[t],s=0;a&&s<a.length;s++){var r=a[s];if(r.listener==e&&r.thisObject==i)return void a.splice(s,1)}}dispatchEvent(t){var e=this._eventsMap;if(!e)return!0;var i=e[t.type];if(!i)return!0;var a=i.length;if(0==a)return!0;t.target=this;for(var s=0;s<a;s++){var r=i[s];r.listener.call(r.thisObject,t)}}}class k extends N{constructor(t=0,e=0,i=0){super(),this._x=t,this._y=e,this._z=i,this._scaleX=1,this._scaleY=1,this._scaleZ=1,this._rotationX=0,this._rotationY=0,this._rotationZ=0,this.posMatrix=new V,this.orgPosMatrix=new V}toStringout(){return"Object3D("+String(this._x)+","+String(this._y)+","+String(this._z)+")"}set x(t){this._x=t,this.updateMatrix()}get x(){return this._x}set y(t){this._y=t,this.updateMatrix()}get y(){return this._y}set z(t){this._z=t,this.updateMatrix()}get z(){return this._z}set scale(t){this._scaleX=this._scaleY=this._scaleZ=t,this.updateMatrix()}set scaleX(t){this._scaleX=t,this.updateMatrix()}get scaleX(){return this._scaleX}set scaleY(t){this._scaleY=t,this.updateMatrix()}get scaleY(){return this._scaleY}set scaleZ(t){this._scaleZ=t,this.updateMatrix()}get scaleZ(){return this._scaleZ}set rotationX(t){this._rotationX=t,this.updateMatrix(),this.updateRotationMatrix()}get rotationX(){return this._rotationX}set rotationY(t){this._rotationY=t,this.updateMatrix(),this.updateRotationMatrix()}get rotationY(){return this._rotationY}set rotationZ(t){this._rotationZ=t,this.updateMatrix(),this.updateRotationMatrix()}get rotationZ(){return this._rotationZ}get px(){return 0}set px(t){}get py(){return 0}set py(t){}get pz(){return 0}set pz(t){}updateMatrix(){this.posMatrix.identity(),this.posMatrix.appendScale(this._scaleX*He.scaleWorld.x,this._scaleY*He.scaleWorld.y,this._scaleZ*He.scaleWorld.z),this.posMatrix.appendRotation(this._rotationX,b.X_AXIS),this.posMatrix.appendRotation(this._rotationY,b.Y_AXIS),this.posMatrix.appendRotation(this._rotationZ,b.Z_AXIS),this.posMatrix.appendTranslation(this._x*He.scaleWorld.x,this._y*He.scaleWorld.y,this._z*He.scaleWorld.z)}getOrgPosMatrix(){return this.orgPosMatrix.identity(),this.orgPosMatrix.appendScale(this._scaleX,this._scaleY,this._scaleZ),this.orgPosMatrix.appendRotation(this._rotationX,b.X_AXIS),this.orgPosMatrix.appendRotation(this._rotationY,b.Y_AXIS),this.orgPosMatrix.appendRotation(this._rotationZ,b.Z_AXIS),this.orgPosMatrix.appendTranslation(this._x,this._y,this._z),this.orgPosMatrix}updateRotationMatrix(){}}class U extends k{constructor(){super(),this.sceneVisible=!0,this._hasDestory=!1,this._onStage=!1}update(){}get onStage(){return this._onStage}addStage(){this._onStage=!0}removeStage(){this._onStage=!1}resize(){}destory(){this.sceneVisible=!1,this.objData&&this.objData.useNum--}}class O{update(t=0){this.target&&this.target.setDynamic(this)}get type(){return this._type}set type(t){this._type=t}setTargetInfo(t,e,i){this.target=t,this.paramName=e,this.type=i,this.target&&this.target.setDynamicOffset(this),this.currentValue=new Array(i)}setCurrentVal(...t){for(var e=0;e<t.length;e++)this.currentValue[e]=t[e]}}class W{destory(){this.textureRes&&this.textureRes.useNum--,this.target=null}get texture(){return this.textureRes?this.textureRes.texture:null}}class j{constructor(){this._dic=new Object,T.addTimeTick(6e4,()=>{this.gc()})}gc(){for(var t in this._dic){var e=this._dic[t];e.useNum<=0&&(e.idleTime++,e.idleTime>=L.GCTime&&(e.destory(),delete this._dic[t]))}}}class G{}G.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",G.encode=function(t){var e,i=new Uint8Array(t),a=i.length,s="";for(e=0;e<a;e+=3)s+=this.chars[i[e]>>2],s+=this.chars[(3&i[e])<<4|i[e+1]>>4],s+=this.chars[(15&i[e+1])<<2|i[e+2]>>6],s+=this.chars[63&i[e+2]];return a%3==2?s=s.substring(0,s.length-1)+"=":a%3==1&&(s=s.substring(0,s.length-2)+"=="),s},G.decode=function(t){var e,i,a,s,r,n=.75*t.length,h=t.length,o=0;"="===t[t.length-1]&&(n--,"="===t[t.length-2]&&n--);var l=new ArrayBuffer(n),c=new Uint8Array(l);for(e=0;e<h;e+=4)i=this.chars.indexOf(t[e]),a=this.chars.indexOf(t[e+1]),s=this.chars.indexOf(t[e+2]),r=this.chars.indexOf(t[e+3]),c[o++]=i<<2|a>>4,c[o++]=(15&a)<<4|s>>2,c[o++]=(3&s)<<6|63&r;return l};class X{constructor(){this._loadThreadList=new Array,this._waitLoadList=new Array;for(var t=0;t<5;t++)this._loadThreadList.push(new Y)}static getInstance(){return this._instance||(this._instance=new X),this._instance}getVersion(t){return this._versions&&this._versions[t]||t}load(t,e,i,a=null,s=null){""!=D.fileRoot&&(t=t.replace(D.fileRoot,""),t=D.fileRoot+this.getVersion(t));for(var r=new Z(t,e,i,a,s),n=0;n<this._loadThreadList.length;n++)if(this._loadThreadList[n].idle)return void this._loadThreadList[n].load(r);this._waitLoadList.push(r)}loadWaitList(){if(!(this._waitLoadList.length<=0))for(var t=0;t<this._loadThreadList.length;t++)if(this._loadThreadList[t].idle)return void this._loadThreadList[t].load(this._waitLoadList.shift())}}X.BYTE_TYPE="BYTE_TYPE",X.IMG_TYPE="IMG_TYPE",X.XML_TYPE="XML_TYPE";class Y{constructor(){this._xhr=new XMLHttpRequest,this._xhr.onreadystatechange=()=>{this._xhr&&4===this._xhr.readyState&&(0===this._xhr.status||200===this._xhr.status?this.loadByteXML():this.loadError())},this._xhr.onprogress=t=>{this._loadInfo.progressFun&&this._loadInfo.progressFun(t.loaded/t.total)},this._xhr.onerror=()=>{this.loadError()},this._img=new Image,this._img.onload=()=>{this.loadImg()},this._img.onerror=()=>{this.loadError()},this.idle=!0}load(t){this._loadInfo=t,this.idle=!1,this._url=t.url,this._loadInfo.type==X.BYTE_TYPE?(this._xhr.open("GET",t.vurl,!0),this._xhr.responseType="arraybuffer",this._xhr.send()):this._loadInfo.type==X.XML_TYPE?(this._xhr.open("GET",t.vurl,!0),this._xhr.responseType="text",this._xhr.send()):this._loadInfo.type==X.IMG_TYPE&&(this._img.url==t.vurl?this.loadImg():(this._img.url=t.vurl,this._img.src=t.vurl))}loadError(){this.idle=!0,this._loadInfo=null,X.getInstance().loadWaitList()}loadByteXML(){this._loadInfo.info?this._loadInfo.fun(this._xhr.response,this._loadInfo.info):this._loadInfo.fun(this._xhr.response),this.idle=!0,this._loadInfo=null,X.getInstance().loadWaitList()}loadByteImg(){this._img.src="data:image/png;base64,"+G.encode(this._xhr.response)}loadImg(){this._loadInfo.info?this._loadInfo.fun(this._img,this._loadInfo.info):this._loadInfo.fun(this._img),this.idle=!0,this._loadInfo=null,X.getInstance().loadWaitList()}}class Z{constructor(t,e,i,a=null,s=null){this.url=t,this.type=e,this.fun=i,this.info=a,this.progressFun=s}get vurl(){return this.url}}class H{constructor(){this._canvas=document.createElement("canvas"),this._canvas.style.zIndex="3",this._canvas.width=200,this._canvas.height=200,this._canvas.style.left=200,this._canvas.style.top=300,this._ctx=this._canvas.getContext("2d"),this._ctx.textBaseline="top"}static getInstance(){return this._instance||(this._instance=new H,H.popClikNameFun=(t,e=0)=>{this.uiClikName(t,e)}),this._instance}static uiClikName(t,e){}getContext2D(t,e,i=!0){return this._canvas.width=t,this._canvas.height=e,this._ctx.clearRect(0,0,t,e),!0,this._ctx.textBaseline="top",this._ctx.textAlign="left",this._ctx}getGrayImageDatabyImg(t){var e=H.getInstance().getContext2D(t.width,t.height,!1);e.drawImage(t,0,0);for(var i,a=e.getImageData(0,0,t.width,t.height),s=0;s<a.data.length;s+=4)i=Math.floor(.3*a.data[s+0])+Math.floor(.59*a.data[s+1])+Math.floor(.11*a.data[s+2]),a.data[s+0]=i,a.data[s+1]=i,a.data[s+2]=i;return a}makeCtxToGray(t,e){for(var i,a=t.getImageData(e.x,e.y,e.width,e.height),s=0;s<a.data.length;s+=4)i=.5*(i=Math.floor(.3*a.data[s+0])+Math.floor(.59*a.data[s+1])+Math.floor(.11*a.data[s+2]))+.5,a.data[s+0]=i,a.data[s+1]=i,a.data[s+2]=i;t.putImageData(a,e.x,e.y)}showCanvas(t=0,e=0){this._canvas.style.left=t,this._canvas.style.top=e,document.getElementById("root").appendChild(this._canvas)}}H.cando=!0;class q extends L{destory(){D.context3D.deleteTexture(this.texture)}}class K extends j{constructor(){super(),this._loadDic=new Object,this._resDic=new Object,this.initDefaultLightMapTexture()}static getInstance(){return this._instance||(this._instance=new K),this._instance}hasTexture(t){return!!this._dic[t]}getTexture(t,e,i=0,a=null,s=0,r=0){if(this._dic[t])return a?e(this._dic[t],a):e(this._dic[t]),void this._dic[t].useNum++;var n=new Q(e,a,t,i,s,r);this._loadDic[t]?this._loadDic[t].push(n):(this._loadDic[t]=new Array,this._loadDic[t].push(n),this._resDic[t]?(this.loadTextureCom(this._resDic[t],n),delete this._resDic[t]):X.getInstance().load(t,X.IMG_TYPE,(t,e)=>{this.loadTextureCom(t,e)},n))}getImageData(t,e){X.getInstance().load(t,X.IMG_TYPE,t=>{var i=H.getInstance().getContext2D(t.width,t.height,!1);i.drawImage(t,0,0,t.width,t.height);var a=i.getImageData(0,0,t.width,t.height);e(a)})}getImgResByurl(t){return this._resDic[t]}addRes(t,e){this._dic[t]||this._resDic[t]||(this._resDic[t]=e)}addImgRes(t,e){this._resDic[t]=e;var i=D.context3D.getTexture(e),a=new q;a.texture=i,a.width=e.width,a.height=e.height,a.useNum++,this._dic[t]=a}getCanvasTexture(t){var e=new q,i=D.context3D.getTexture(t.canvas,0,0);return e.texture=i,e}getImageDataTexture(t){return D.context3D.getTexture(t,0,0)}getTextureRes(t){var e=new q,i=D.context3D.getTexture(t,0,0);return e.texture=i,e}updateTexture(t,e,i,a){D.context3D.updateTexture(t,e,i,a.canvas)}loadTextureCom(t,e){var i=D.context3D.getTexture(t,e.wrap,e.filter,e.mipmap),a=new q;a.texture=i,a.width=t.width,a.height=t.height;for(var s=this._loadDic[e.url],r=0;r<s.length;r++)s[r].info?s[r].fun(a,s[r].info):s[r].fun(a),a.useNum++;delete this._loadDic[e.url],this._dic[e.url]=a}initDefaultLightMapTexture(){var t=document.createElement("canvas"),e=t.getContext("2d");t.width=32,t.height=32,e.fillStyle="rgb(51,51,51)",e.fillRect(0,0,32,32),this.defaultLightMap=D.context3D.getTexture(t)}gc(){super.gc()}}class Q{constructor(t,e,i,a,s,r){this.fun=t,this.info=e,this.url=i,this.wrap=a,this.filter=s,this.mipmap=r}}class J extends R{destory(){for(var t=0;t<this.dynamicTexList.length;t++)this.dynamicTexList[t].destory();this.dynamicTexList=null,this.dynamicConstList=null}update(){if(this.material&&this.dynamicConstList)for(var t=0;t<this.dynamicConstList.length;t++)this.dynamicConstList[t].update()}setData(t,e){this.material=t,this.dynamicConstList=new Array,this.dynamicTexList=new Array;for(var i=t.constList,a=t.texList,s=0;s<e.length;s++){var r=e[s];if(0==r.type){var n=new W;n.paramName=r.name;for(var h=0;h<a.length;h++)if(n.paramName==a[h].paramName){n.target=a[h];break}var o=0;n.target&&(o=n.target.mipmap),o=0,K.getInstance().getTexture(D.fileRoot+r.url,t=>{n.textureRes=t},0,null,0,o),this.dynamicTexList.push(n)}else{var l=r.name,c=null;for(h=0;h<i.length;h++)if(l==i[h].paramName0||l==i[h].paramName1||l==i[h].paramName2||l==i[h].paramName3){c=i[h];break}var d=new O;d.setTargetInfo(c,l,r.type),1==r.type?d.setCurrentVal(r.x):2==r.type?d.setCurrentVal(r.x,r.y):d.setCurrentVal(r.x,r.y,r.z),this.dynamicConstList.push(d)}}}}class $ extends L{constructor(){super(),this.vertices=new Array,this.uvs=new Array,this.indexs=new Array,this.lightuvs=new Array,this.normals=new Array,this.tangents=new Array,this.bitangents=new Array,this.treNum=0,this.compressBuffer=!1,this.hasdispose=!1,this.indexFormat=t.IndexFormat.UInt16,this._bufferState=new e}_setBuffer(t,e){var i=this._bufferState;i.bind(),i.applyVertexBuffer(t),i.applyIndexBuffer(e),i.unBind()}destory(){this.vertices.length=0,this.vertices=null,this.uvs.length=0,this.uvs=null,this.indexs.length=0,this.indexs=null,this.lightuvs.length=0,this.lightuvs=null,this.normals.length=0,this.normals=null,this.tangents.length=0,this.tangents=null,this.bitangents.length=0,this.bitangents=null,this.vertexBuffer&&(D.context3D.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null),this.uvBuffer&&(D.context3D.deleteBuffer(this.uvBuffer),this.uvBuffer=null),this.indexBuffer&&(D.context3D.deleteBuffer(this.indexBuffer),this.indexBuffer=null),this.lightUvBuffer&&(D.context3D.deleteBuffer(this.lightUvBuffer),this.lightUvBuffer=null),this.normalsBuffer&&(D.context3D.deleteBuffer(this.normalsBuffer),this.normalsBuffer=null),this.tangentBuffer&&(D.context3D.deleteBuffer(this.tangentBuffer),this.tangentBuffer=null),this.bitangentBuffer&&(D.context3D.deleteBuffer(this.bitangentBuffer),this.bitangentBuffer=null),this.hasdispose=!0}}class tt{destory(){this.textureRes&&this.textureRes.clearUseNum()}set id(t){this._id=t,this.name="fs"+t}get id(){return this._id}get texture(){return this.textureRes?this.textureRes.texture:null}}tt.LIGHTMAP=1,tt.LTUMAP=2,tt.CUBEMAP=3,tt.HEIGHTMAP=4,tt.REFRACTIONMAP=5;class et{constructor(){this.value=new b,this.offset=0}set id(t){this._id=t,this.name="fc"+t,this.offset=4*t}get id(){return this._id}creat(t){this.vecNum=t,this.vecNum[0+this.offset]=this.value.x,this.vecNum[1+this.offset]=this.value.y,this.vecNum[2+this.offset]=this.value.z,this.vecNum[3+this.offset]=this.value.w}setData(t){this.id=t.id,this.value=new b(t.value.x,t.value.y,t.value.z,t.value.w),this.paramName0=t.paramName0,this.param0Type=t.param0Type,this.param0Index=t.param0Index,this.paramName1=t.paramName1,this.param1Type=t.param1Type,this.param1Index=t.param1Index,this.paramName2=t.paramName2,this.param2Type=t.param2Type,this.param2Index=t.param2Index,this.paramName3=t.paramName3,this.param3Type=t.param3Type,this.param3Index=t.param3Index}setDynamicOffset(t){this.paramName0==t.paramName?t.targetOffset=this.param0Index+this.offset:this.paramName1==t.paramName?t.targetOffset=this.param1Index+this.offset:this.paramName2==t.paramName?t.targetOffset=this.param2Index+this.offset:this.paramName3==t.paramName&&(t.targetOffset=this.param3Index+this.offset)}setDynamicDirect(t,e){this.vecNum.set(t,e)}setDynamic(t){try{this.vecNum.set(t.currentValue,t.targetOffset)}catch(t){}}}class it extends L{constructor(){super(...arguments),this.texList=new Array,this.constList=new Array,this.killNum=0,this.writeZbuffer=!0,this.fogMode=0,this.fcNum=0}update(t){this.updateTime(t),this.updateScene()}updateTime(t){this.hasTime&&(this.fcData[1]=t)}updateCam(t,e,i){if(this.usePbr||1==this.fogMode){var a=4*this.fcIDAry[0];this.fcData[0+a]=t,this.fcData[1+a]=e,this.fcData[2+a]=i}}updateScene(){if(this.sceneNumId!=D.sceneNumId){if(this.sceneNumId=D.sceneNumId,0!=this.fogMode){var t=4*this.fcIDAry[1];this.fcData[0+t]=D.fogColor[0],this.fcData[1+t]=D.fogColor[1],this.fcData[2+t]=D.fogColor[2]}if(this.scaleLightMap){t=4*this.fcIDAry[2];this.fcData[0+t]=D.scaleLight[0]}}}initFcData(){if(this.fcData=new Float32Array(4*this.fcNum),!(this.fcNum<=0)){if(this.sceneNumId=D.sceneNumId,(this.hasTime||this.useKill||0!=this.fogMode)&&(this.useKill&&(this.fcData[0]=this.killNum),0!=this.fogMode&&(this.fcData[2]=D.fogData[0],this.fcData[3]=D.fogData[1])),this.usePbr||1==this.fogMode){var t=4*this.fcIDAry[0];this.fcData[0+t]=D.cam3D.x/100,this.fcData[1+t]=D.cam3D.y/100,this.fcData[2+t]=D.cam3D.z/100}if(0!=this.fogMode){t=4*this.fcIDAry[1];this.fcData[0+t]=D.fogColor[0],this.fcData[1+t]=D.fogColor[1],this.fcData[2+t]=D.fogColor[2]}if(this.scaleLightMap){t=4*this.fcIDAry[2];this.fcData[0+t]=D.scaleLight[0]}}}setCompileData(t){if(t){if(this.shaderStr=t.shaderStr,this.hasTime=t.hasTime,this.timeSpeed=t.timeSpeed,this.blendMode=t.blendMode,this.backCull=t.backCull,this.killNum=t.killNum,this.hasVertexColor=t.hasVertexColor,this.usePbr=t.usePbr,this.useNormal=t.useNormal,this.roughness=t.roughness,this.writeZbuffer=t.writeZbuffer,this.hasFresnel=t.hasFresnel,this.useDynamicIBL=t.useDynamicIBL,this.normalScale=t.normalScale,this.lightProbe=t.lightProbe,this.useKill=t.useKill,this.directLight=t.directLight,this.noLight=t.noLight,this.scaleLightMap=t.scaleLightMap,this.fogMode=t.fogMode,this.hasParticleColor=!1,this.initFcData(),t.texList){var e=t.texList;this.texList=new Array;for(var i=0;i<e.length;i++){var a=new tt;a.id=e[i].id,a.url=e[i].url,a.isDynamic=e[i].isDynamic,a.paramName=e[i].paramName,a.isMain=e[i].isMain,a.isParticleColor=e[i].isParticleColor,a.type=e[i].type,a.wrap=e[i].wrap,a.filter=e[i].filter,a.mipmap=e[i].mipmap,this.texList.push(a),a.isParticleColor&&(this.hasParticleColor=!0)}}if(t.constList)for(e=t.constList,this.constList=new Array,i=0;i<e.length;i++){var s=new et;s.setData(e[i]),s.creat(this.fcData),this.constList.push(s)}}}setByteData(t){var e=t,i=e.readInt();if(this.shaderStr=e.readUTF(),this.hasTime=e.readBoolean(),this.timeSpeed=e.readFloat(),this.blendMode=e.readFloat(),this.backCull=e.readBoolean(),this.killNum=e.readFloat(),this.hasVertexColor=e.readBoolean(),this.usePbr=e.readBoolean(),this.useNormal=e.readBoolean(),this.roughness=e.readFloat(),this.writeZbuffer=e.readBoolean(),this.hasFresnel=e.readBoolean(),this.useDynamicIBL=e.readBoolean(),this.normalScale=e.readFloat(),this.lightProbe=e.readBoolean(),this.useKill=e.readBoolean(),this.directLight=e.readBoolean(),this.noLight=e.readBoolean(),this.scaleLightMap=e.readBoolean(),i>2&&(this.fogMode=e.readInt()),i>=22){this.fcNum=e.readByte();var a=e.readByte();this.fcIDAry=new Array;for(var s=0;s<a;s++)this.fcIDAry.push(e.readByte())}this.hasParticleColor=!1,this.initFcData(),this.readTexList(e),this.readConstLis(e)}readConstLis(t){var e=t.readInt();this.constList=new Array;for(var i=0;i<e;i++){var a=new et;a.id=t.readFloat(),a.value=new b(t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat()),a.paramName0=t.readUTF(),a.param0Type=t.readFloat(),a.param0Index=t.readFloat(),a.paramName1=t.readUTF(),a.param1Type=t.readFloat(),a.param1Index=t.readFloat(),a.paramName2=t.readUTF(),a.param2Type=t.readFloat(),a.param2Index=t.readFloat(),a.paramName3=t.readUTF(),a.param3Type=t.readFloat(),a.param3Index=t.readFloat(),a.creat(this.fcData),this.constList.push(a)}}readTexList(t){var e=t.readInt();this.texList=new Array;for(var i=0;i<e;i++){var a=new tt;a.id=t.readFloat(),a.url=t.readUTF(),a.isDynamic=t.readBoolean(),a.paramName=t.readUTF(),a.isMain=t.readBoolean(),a.isParticleColor=t.readBoolean(),a.type=t.readFloat(),a.wrap=t.readFloat(),a.filter=t.readFloat(),a.mipmap=t.readFloat(),a.isParticleColor&&(this.hasParticleColor=!0),this.texList.push(a)}}destory(){for(var t=0;t<this.texList.length;t++)this.texList[t].destory();this.texList=null,this.constList=null,this.shader&&this.shader.clearUseNum()}}class at extends j{constructor(){super()}static getInstance(){return this._instance||(this._instance=new at),this._instance}getProgram(t){return this._dic[t]?this._dic[t]:(alert("please registe Program=>"+t),null)}registe(t,e){this._dic[t]||(e.encode(),e.useNum=1,e.name=t,this._dic[t]=e)}getMaterialProgram(t,e,i,a=null,s=!1){var r=t+"_"+i.url;if(a){for(var n=0;n<a.length;n++)r+="_"+a[n];r+=s?"true_":"false_"}if(this._dic[r])return this._dic[r].useNum++,this._dic[r];s&&(a=[i.usePbr,i.useNormal,i.hasFresnel,i.useDynamicIBL,i.lightProbe,i.directLight,i.noLight,i.fogMode]);var h=new e;h.paramAry=a,h.fragment=i.shaderStr;h.encode();return h.useNum++,this._dic[r]=h,h}outShader(t){for(var e=t.split("\n"),i=0;i<e.length;i++){e[i],i<e.length-1?("\\n",'"',"+"):'"'}}gc(){super.gc()}}class st extends j{constructor(){super(),this._loadDic=new Object,this._resDic=new Object,this._regDic=new Object}static getInstance(){return this._instance||(this._instance=new st),this._instance}getMaterialByte(t,e,i=null,a=!1,s=null,r=null){if(this._dic[t])return i?e(this._dic[t],i):e(this._dic[t]),void this._dic[t].useNum++;var n=new rt(e,i,t,a,s,r);this._loadDic[t]?this._loadDic[t].push(n):(this._loadDic[t]=new Array,this._loadDic[t].push(n),this._resDic[t]?(this.meshByteMaterialByt(this._resDic[t],n),this._regDic[t]&&(this._dic[t].useNum+=this._regDic[t],delete this._regDic[t]),delete this._resDic[t]):X.getInstance().load(t,X.BYTE_TYPE,(t,e)=>{this.loadMaterialByteCom(t,e)},n))}meshByteMaterialByt(t,e){var i=new it;i.setByteData(t),i.url=e.url,this.loadMaterial(i),e.autoReg&&(i.shader=at.getInstance().getMaterialProgram(e.regName,e.shader3D,i,null,!0),i.program=i.shader.program);for(var a=this._loadDic[e.url],s=0;s<a.length;s++)a[s].info?a[s].fun(i,a[s].info):a[s].fun(i),i.useNum++;delete this._loadDic[e.url],this._dic[e.url]=i}loadMaterialByteCom(t,e){var i=new A(t);this.meshByteMaterialByt(i,e)}addResByte(t,e){this._dic[t]||this._resDic[t]||(this._resDic[t]=e)}registerUrl(t){t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this._dic[t]?this._dic[t].useNum++:this._regDic[t]?this._regDic[t]++:this._regDic[t]}releaseUrl(t){t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this._dic[t]&&this._dic[t].clearUseNum()}loadMaterial(t){for(var e=t.texList,i=0;i<e.length;i++)e[i].isParticleColor||e[i].isDynamic||0!=e[i].type||K.getInstance().getTexture(D.fileRoot+e[i].url,(t,e)=>{e.textureRes=t},e[i].wrap,e[i],e[i].filter,e[i].mipmap)}loadDynamicTexUtil(t){for(var e=t.dynamicTexList,i=0;i<e.length;i++)e[i].isParticleColor?e[i].creatTextureByCurve():K.getInstance().getTexture(D.fileRoot+e[i].url,(t,e)=>{e.textureRes=t},0,e[i],0,1)}gc(){super.gc()}}class rt{constructor(t,e,i,a,s,r){this.fun=t,this.info=e,this.url=i,this.autoReg=a,this.regName=s,this.shader3D=r}}class nt{constructor(t){this.type=t}}nt.COMPLETE="complete";class ht{constructor(){this._canvas=document.createElement("canvas"),this._cxt=this._canvas.getContext("2d"),this._gnt=this._cxt.createLinearGradient(0,0,128,0),this._canvas.style.zIndex="1"}static getInstance(){return this._instance||(this._instance=new ht),this._instance}getImageData(t){for(var e=t.pos.length,i=new b,a=0;a<e;a++)M.hexToArgb(t.color[a],!1,i),this._gnt.addColorStop(t.pos[a]/255,"rgba("+i.x+","+i.y+","+i.z+","+t.alpha[a]+")");return this._cxt.fillStyle=this._gnt,this._cxt.fillRect(0,0,128,2),this._cxt.getImageData(0,0,128,2)}getImageDataByVec(t,e){for(var i,a,s=this._cxt.createImageData(64,1),r=0;r<64;r++)i=4*r,a=4*M.float2int(r/64*e),s.data[i]=t[a],s.data[i+1]=t[a+1],s.data[i+2]=t[a+2],s.data[i+3]=t[a+3];return s}setData(){}}class ot{constructor(){this.valueV3d=[1,1,1,1]}getValue(t){if(!this.valueVec||-1==this.begintFrame)return this.valueV3d;var e=M.float2int(t/D.frameTime-this.begintFrame);return e<0?e=0:e>this.maxFrame-this.begintFrame&&(e=this.maxFrame-this.begintFrame),this.valueVec[e]}setData(t){this.type=t.type,this.maxFrame=t.maxFrame,t.items.length?this.begintFrame=t.items[0].frame:this.begintFrame=-1;for(var e=t.values[0].length,i=new Array,a=0;a<e;a++){var s=new Array;if(1==this.type)s.push(t.values[0][a]);else if(2==this.type)s.push(t.values[0][a],t.values[1][a]);else if(3==this.type)s.push(t.values[0][a],t.values[1][a],t.values[2][a]);else if(4==this.type){var r=t.values[3][a];s.push(t.values[0][a]*r,t.values[1][a]*r,t.values[2][a]*r,r)}i.push(s)}this.valueVec=i}}class lt extends W{constructor(){super()}destory(){super.destory(),this._textureDynamic&&D.context3D.deleteTexture(this._textureDynamic),this.target=null}initCurve(t){this.curve=new ot,this.curve.type=t}get texture(){return this._textureDynamic?this._textureDynamic:this.textureRes?this.textureRes.texture:null}creatTextureByCurve(){var t=0,e=this.curve.valueVec.length-1,i=new Array;for(t=0;t<this.life;t++)if(t<this.curve.begintFrame)i.push(255*this.curve.valueVec[0][0],255*this.curve.valueVec[0][1],255*this.curve.valueVec[0][2],255*this.curve.valueVec[0][3]);else if(t>this.curve.maxFrame)0==this.curve.maxFrame&&this.curve.begintFrame<0?i.push(255,255,255,255):i.push(255*this.curve.valueVec[e][0],255*this.curve.valueVec[e][1],255*this.curve.valueVec[e][2],255*this.curve.valueVec[e][3]);else if(this.curve.begintFrame<0)i.push(255,255,255,255);else{var a=t-this.curve.begintFrame;i.push(255*this.curve.valueVec[a][0],255*this.curve.valueVec[a][1],255*this.curve.valueVec[a][2],255*this.curve.valueVec[a][3])}var s=ht.getInstance().getImageDataByVec(i,this.life);this._textureDynamic=D.context3D.getTexture(s)}get life(){return this._life}set life(t){this._life=t}}class ct extends O{update(t=0){this.currentValue=this.curve.getValue(t),this.target.setDynamic(this)}set type(t){this._type=t,this.curve=new ot,this.curve.type=t}}class dt extends J{constructor(){super()}destory(){this.material.useNum--,this.shader.useNum--,super.destory()}setMaterial(t){this.material=t,this.materialUrl=t.url,this.dynamicTexList=new Array,this.dynamicConstList=new Array,this.setTexList(),this.setConstList()}setLife(t){for(var e=0;e<this.dynamicTexList.length;e++)this.dynamicTexList[e].isParticleColor&&(this.dynamicTexList[e].life=t)}setTexList(){for(var t=this.material.texList,e=0;e<t.length;e++){var i;t[e].isParticleColor?((i=new lt).target=t[e],i.paramName=t[e].paramName,i.initCurve(4),this.dynamicTexList.push(i),i.isParticleColor=!0):t[e].isDynamic&&((i=new lt).target=t[e],i.paramName=t[e].paramName,this.dynamicTexList.push(i))}}setConstList(){for(var t=this.material.constList,e=0;e<t.length;e++){var i,a=t[e];0!=a.param0Type&&((i=new ct).setTargetInfo(a,a.paramName0,a.param0Type),this.dynamicConstList.push(i)),0!=a.param1Type&&((i=new ct).setTargetInfo(a,a.paramName1,a.param1Type),this.dynamicConstList.push(i)),0!=a.param2Type&&((i=new ct).setTargetInfo(a,a.paramName2,a.param2Type),this.dynamicConstList.push(i)),0!=a.param3Type&&((i=new ct).setTargetInfo(a,a.paramName3,a.param3Type),this.dynamicConstList.push(i))}}setTextObj(t){for(var e=0;e<t.length;e++)for(var i=t[e],a=0;a<this.dynamicTexList.length;a++)if(this.dynamicTexList[a].paramName==i.paramName){this.dynamicTexList[a].isParticleColor?this.dynamicTexList[a].curve.setData(i.curve):this.dynamicTexList[a].url=i.url;break}}setConstObj(t){for(var e=0;e<t.length;e++)for(var i=t[e],a=0;a<this.dynamicConstList.length;a++)if(this.dynamicConstList[a].paramName==i.paramName){this.dynamicConstList[a].curve.setData(i.curve);break}}isTexReady(){for(var t=this.dynamicTexList,e=0;e<t.length;e++)if(!t[e].texture)return!1;return!0}}class ut{constructor(){this.dataAry=new Array}destory(){this.dataAry=null}setByteData(t){for(var e=t.readFloat(),i=0;i<e;i++){var a=t.readFloat(),s=this.addKeyFrame(a);s.frameNum=a,s.baseValue=new Array;for(var r=0;r<10;r++)s.baseValue.push(t.readFloat());var n=t.readFloat();if(s.animData=new Array,n>0)for(var h=0;h<n;h++)s.animData.push(this.getByteDataTemp(t))}this.maxFrameNum=this.dataAry[this.dataAry.length-1].frameNum,this.beginTime=this.dataAry[0].frameNum*D.frameTime}addKeyFrame(t){var e=new Object;return e.frameNum=t,this.dataAry.push(e),e}getByteDataTemp(t){var e=new Object,i=t.readInt(),a=t.readInt();e.data=new Array,e.dataByte=new Array;for(var s=0;s<a;s++){var r=new Object;if(r.type=t.readInt(),1==r.type){var n=t.readFloat();e.dataByte.push(n)}if(2==r.type){var h=new b;h.x=t.readFloat(),h.y=t.readFloat(),h.z=t.readFloat(),e.dataByte.push(h)}}return e.type=i,e}}class mt{constructor(){}}class pt{constructor(){this.baseNum=0,this.num=0,this.time=0,this.speed=0,this.aSpeed=0,this.beginTime=0,this.lastTime=0,this.baseTime=0}BaseAnim(){}update(t){this._isDeath||(this.time=t-this.baseTime,this._isActiva?(this.time=this.time-this.beginTime,this.time>this.lastTime&&(this.time=this.lastTime-this.beginTime,this._isDeath=!0),this.coreCalculate()):this.time>=this.beginTime&&(this.time>=this.lastTime?(this.time=this.lastTime-this.beginTime,this.coreCalculate(),this._isDeath=!0):(this.time=this.time-this.beginTime,this.coreCalculate()),this._isActiva=!0))}coreCalculate(){this.num=this.speed*this.time+this.aSpeed*this.time*this.time+this.baseNum}reset(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.num=0}depthReset(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.baseNum=0,this.num=0}set data(t){}get isDeath(){return this._isDeath}set isDeath(t){this._isDeath=t}getAllNum(t){t=Math.min(t,this.lastTime),t-=this.beginTime;var e=this.speed*t+this.aSpeed*t*t;this.baseNum+=e}}class yt extends pt{set data(t){this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=D.MAX_NUMBER:this.lastTime=Number(t[1].value),this.speed=.1*Number(t[2].value),this.aSpeed=.1*Number(t[3].value)}dataByte(t,e){this.beginTime=e[0],-1==e[1]?this.lastTime=D.MAX_NUMBER:this.lastTime=e[1],this.speed=.1*e[2],this.aSpeed=.1*e[3]}}class xt extends pt{set data(t){this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=D.MAX_NUMBER:this.lastTime=Number(t[1].value);var e=String(t[2].value).split("|");this.axis=new b(Number(e[0]),Number(e[1]),Number(e[2])),e=String(t[3].value).split("|"),this.axisPos=new b(100*Number(e[0]),100*Number(e[1]),100*Number(e[2])),this.speed=.1*Number(t[4].value),this.aSpeed=.1*Number(t[5].value)}dataByte(t,e){this.beginTime=Number(e[0]),-1==Number(e[1])?this.lastTime=D.MAX_NUMBER:this.lastTime=Number(e[1]),this.axis=e[2],this.axisPos=e[3],this.speed=.1*e[4],this.aSpeed=.1*e[5]}}class vt extends pt{set data(t){this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=D.MAX_NUMBER:this.lastTime=Number(t[1].value);var e=t[2].value.split("|");this.axis=new b(Number(e[0]),Number(e[1]),Number(e[2])),this.axis.normalize(),this.speed=.1*Number(t[3].value),this.aSpeed=.001*Number(t[4].value)}dataByte(t,e){this.beginTime=e[0],-1==e[1]?this.lastTime=D.MAX_NUMBER:this.lastTime=e[1],this.axis=e[2],this.axis.normalize(),this.speed=.1*e[3],this.aSpeed=.001*e[4]}}class gt extends pt{constructor(){super(),this.num=1}coreCalculate(){this.num=1+this.speed*this.time+this.baseNum,this.num<this.minNum?this.num=this.minNum:this.num>this.maxNum&&(this.num=this.maxNum)}set data(t){this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=D.MAX_NUMBER:this.lastTime=Number(t[1].value),this.speed=.001*Number(t[2].value),this.minNum=.01*Number(t[3].value),this.maxNum=.01*Number(t[4].value)}dataByte(t,e){this.beginTime=e[0],-1==e[1]?this.lastTime=D.MAX_NUMBER:this.lastTime=e[1],this.speed=.001*e[2],this.minNum=.01*e[3],this.maxNum=.01*e[4]}getAllNum(t){t=Math.min(t,this.lastTime),t-=this.beginTime;var e=this.speed*t;this.baseNum+=e,this.baseNum<this.minNum?this.baseNum=this.minNum:e>this.maxNum&&(this.baseNum=this.maxNum)}reset(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.num=1}depthReset(){this._isActiva=!1,this._isDeath=!1,this.time=0,this.baseNum=0,this.num=1}}class _t extends pt{constructor(){super(),this.num=1}update(t){this._isDeath||(this.time=t-this.baseTime,this._isActiva?(this.coreCalculate(),this.time>this.lastTime&&(this._isDeath=!0)):this.time>=this.beginTime&&(this._isActiva=!0))}coreCalculate(){var t=M.float2int(this.time/D.frameTime);t>=this.numAry.length?this.num=this.numAry[this.numAry.length-1]:this.num=this.numAry[t]}reset(){super.reset(),this.num=1}depthReset(){super.depthReset(),this.num=1}set data(t){this.numAry=new Array,this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=D.MAX_NUMBER:this.lastTime=Number(t[1].value),this.beginScale=Number(t[2].value),this.scaleNum=Number(t[3].value),this.scaleAry=new Array;for(var e,i=0,a=4;a<4+2*this.scaleNum;a+=2){var s=new Object;s.value=Number(t[a].value),s.time=Number(t[a+1].value),i+=s.time,s.beginTime=this.beginTime+i,this.scaleAry.push(s)}var r=0,n=1;this.scaleAry.length?(e=(this.scaleAry[this.scaleAry.length-1].beginTime+this.scaleAry[this.scaleAry.length-1].time)/D.frameTime,n=this.scaleAry[0].beginTime,this._currentTarget=this.scaleAry[0]):e=0;var h=0;for(a=0;a<e;a++){var o=D.frameTime*a;o>=this._currentTarget.beginTime&&(this.beginScale=this._currentTarget.value,r=this._currentTarget.beginTime,h==this.scaleAry.length-1?this._currentTarget=this.scaleAry[this.scaleAry.length-1]:(h++,this._currentTarget=this.scaleAry[h]),n=this._currentTarget.time);var l=(o-r)/n*(this._currentTarget.value-this.beginScale)+this.beginScale;this.numAry.push(l)}this._currentTarget=this.scaleAry[0]}dataByte(t,e){this.numAry=new Array,this.beginTime=e[0],-1==e[1]?this.lastTime=D.MAX_NUMBER:this.lastTime=e[1],this.beginScale=e[2],this.scaleNum=e[3],this.scaleAry=new Array;for(var i,a=0,s=4;s<4+2*this.scaleNum;s+=2){var r=new Object;r.value=e[s],r.time=e[s+1],a+=r.time,r.beginTime=this.beginTime+a,this.scaleAry.push(r)}var n=0,h=1;this.scaleAry.length?(i=(this.scaleAry[this.scaleAry.length-1].beginTime+this.scaleAry[this.scaleAry.length-1].time)/D.frameTime,h=this.scaleAry[0].beginTime,this._currentTarget=this.scaleAry[0]):i=0;var o=0;for(s=0;s<i;s++){var l=D.frameTime*s;l>=this._currentTarget.beginTime&&(this.beginScale=this._currentTarget.value,n=this._currentTarget.beginTime,o==this.scaleAry.length-1?this._currentTarget=this.scaleAry[this.scaleAry.length-1]:(o++,this._currentTarget=this.scaleAry[o]),h=this._currentTarget.time);var c=(l-n)/h*(this._currentTarget.value-this.beginScale)+this.beginScale;this.numAry.push(c)}this._currentTarget=this.scaleAry[0]}getAllNum(t){t=Math.min(t,this.lastTime+this.beginTime);var e=this.scaleAry[this.scaleAry.length-1];if(t>=e.beginTime+e.time)this.baseNum=e.value;else{for(var i,a=0;a<this.scaleAry.length;a++)t>this.scaleAry[a].this.beginTime&&(this._currentTarget=this.scaleAry[a],this.beginTime=this._currentTarget.this.beginTime,this.beginScale=this._currentTarget.value,i=a);i++,this._currentTarget=this.scaleAry[i],this.baseNum=(this._currentTarget.value-this.beginScale)/this._currentTarget.this.time*(t-this.beginTime)+this.beginScale}}}class ft extends pt{coreCalculate(){this.num=this.amplitude+this.amplitude*Math.sin(this.speed*this.time)}set data(t){this.beginTime=Number(t[0].value),-1==Number(t[1].value)?this.lastTime=D.MAX_NUMBER:this.lastTime=Number(t[1].value),this.amplitude=Number(t[2].value),this.speed=.01*Number(t[3].value)}dataByte(t,e){this.beginTime=e[0],-1==e[1]?this.lastTime=D.MAX_NUMBER:this.lastTime=e[1],this.amplitude=e[2],this.speed=.01*e[3]}getAllNum(t){this.baseNum=this.amplitude+this.amplitude*Math.sin(this.speed*t)}}class Dt extends N{constructor(){super(),this._time=0,this.targetFlag=-1,this.beginTime=0,this.isByteData=!1,this.targetFlag=-1,this.visible=!1,this.maxFrameNum=0,this._time=0,this._keyFrameAry=new Array}updateMatrix(t,e){this._axisMove&&t.prependTranslation(this._axisMove.axis.x*this._axisMove.num,this._axisMove.axis.y*this._axisMove.num,this._axisMove.axis.z*this._axisMove.num),this._axisRotaion&&t.prependRotation(this._axisRotaion.num,this._axisRotaion.axis),t.prependTranslation(e.data.center.x,e.data.center.y,e.data.center.z),this._scaleChange?t.prependScale(e.data._widthFixed?1:this._scaleChange.num,e.data._heightFixed?1:this._scaleChange.num,e.data._widthFixed?1:this._scaleChange.num):this._scaleNosie?t.prependScale(e.data._widthFixed?1:1+this._scaleNosie.num,e.data._heightFixed?1:1+this._scaleNosie.num,e.data._widthFixed?1:1+this._scaleNosie.num):this._scaleAnim&&t.prependScale(e.data._widthFixed?1:this._scaleAnim.num,e.data._heightFixed?1:this._scaleAnim.num,e.data._widthFixed?1:this._scaleAnim.num),t.prependRotation(e.data.rotationV3d.z,b.Z_AXIS),t.prependRotation(e.data.rotationV3d.y,b.Y_AXIS),t.prependRotation(e.data.rotationV3d.x,b.X_AXIS)}inverAxisRotation(t){this._axisRotaion&&t.prependRotation(-this._axisRotaion.num,this._axisRotaion.axis)}applySelfRotation(t,e){this._selfRotaion&&t.prependRotation(this._selfRotaion.num,e)}addKeyFrame(t){var e=new mt;return e.frameNum=t,this._keyFrameAry.push(e),e}updateTime(t){this._currentKeyFrame&&(this._time=t,this.getTarget(),this._axisRotaion&&this._axisRotaion.update(this._time),this._selfRotaion&&this._selfRotaion.update(this._time),this._axisMove&&this._axisMove.update(this._time),this._scaleChange?this._scaleChange.update(this._time):this._scaleNosie?this._scaleNosie.update(this._time):this._scaleAnim&&this._scaleAnim.update(this._time))}getTarget(){for(var t=-1,e=0;e<this._keyFrameAry.length&&this._keyFrameAry[e].frameNum*D.frameTime<this._time;e++)t=e;t!=this.targetFlag&&(this._currentKeyFrame=this._keyFrameAry[t],this.targetFlag=t,t>=this._keyFrameAry.length-1||!this._currentKeyFrame?(this.visible=!1,this._currentKeyFrame=null):(this.visible=!0,this.enterKeyFrame(this._currentKeyFrame.animData,this._currentKeyFrame.frameNum*D.frameTime,this._currentKeyFrame.baseValue)))}enterKeyFrame(t,e=0,i=null){if(null!=i){for(var a=0;a<10;a++)if(i[a])switch(a){case 1:this._selfRotaion||(this._selfRotaion=new yt),this._selfRotaion.num=this._selfRotaion.baseNum=i[a];break;case 2:this._axisRotaion||(this._axisRotaion=new xt),this._axisRotaion.num=this._axisRotaion.baseNum=i[a];break;case 6:this._scaleChange||(this._scaleChange=new gt),this._scaleChange.num=this._scaleChange.baseNum=i[a];break;case 7:this._scaleAnim||(this._scaleAnim=new _t),this._scaleAnim.num=this._scaleAnim.baseNum=i[a];break;case 8:this._scaleNosie||(this._scaleNosie=new ft),this._scaleNosie.num=this._scaleNosie.baseNum=i[a];break;case 9:this._axisMove||(this._axisMove=new vt),this._axisMove.num=this._axisMove.baseNum=i[a]}this._selfRotaion&&(this._selfRotaion.isDeath=!0),this._axisRotaion&&(this._axisRotaion.isDeath=!0),this._scaleChange&&(this._scaleChange.isDeath=!0),this._scaleAnim&&(this._scaleAnim.isDeath=!0),this._scaleNosie&&(this._scaleNosie.isDeath=!0),this._axisMove&&(this._axisMove.isDeath=!0),t&&this.setBaseTimeByte(t,e,i)}}reset(){this._time=0,this._currentKeyFrame=this._keyFrameAry[0],this.visible=!1,this.targetFlag=-1}setAllByteInfo(t,e){this.isByteData=!0;for(var i=t.readFloat(),a=0;a<i;a++){var s=t.readFloat(),r=this.addKeyFrame(s);r.frameNum=s,r.baseValue=new Array;for(var n=0;n<10;n++)r.baseValue.push(t.readFloat());var h=t.readFloat();if(r.animData=new Array,h>0)for(var o=0;o<h;o++)r.animData.push(this.getByteDataTemp(t))}this.maxFrameNum=this._keyFrameAry[this._keyFrameAry.length-1].frameNum,this.beginTime=this._keyFrameAry[0].frameNum*D.frameTime,this._currentKeyFrame=this._keyFrameAry[0]}setAllDataInfo(t){this.isByteData=!0;for(var e=t.dataAry.length,i=0;i<e;i++){var a=this.addKeyFrame(t.dataAry[i].frameNum);a.baseValue=t.dataAry[i].baseValue,a.animData=t.dataAry[i].animData}this.maxFrameNum=t.maxFrameNum,this.beginTime=t.beginTime,this._currentKeyFrame=this._keyFrameAry[0]}setBaseTimeByte(t,e=0,i=null){for(var a=0;a<t.length;a++)1==t[a].type?(this._selfRotaion?this._selfRotaion.reset():this._selfRotaion=new yt,this._selfRotaion.dataByte(t[a].data,t[a].dataByte),this._selfRotaion.baseTime=e):2==t[a].type?(this._axisRotaion?this._axisRotaion.reset():this._axisRotaion=new xt,this._axisRotaion.dataByte(t[a].data,t[a].dataByte),this._axisRotaion.baseTime=e):6==t[a].type?(this._scaleChange?this._scaleChange.reset():this._scaleChange=new gt,this._scaleChange.dataByte(t[a].data,t[a].dataByte),this._scaleChange.baseTime=e):7==t[a].type?(this._scaleAnim?this._scaleAnim.reset():this._scaleAnim=new _t,this._scaleAnim.dataByte(t[a].data,t[a].dataByte),this._scaleAnim.baseTime=e):8==t[a].type?(this._scaleNosie?this._scaleNosie.reset():this._scaleNosie=new ft,this._scaleNosie.dataByte(t[a].data,t[a].dataByte),this._scaleNosie.baseTime=e):9==t[a].type&&(this._axisMove?this._axisMove.reset():this._axisMove=new vt,this._axisMove.dataByte(t[a].data,t[a].dataByte),this._axisMove.baseTime=e)}getByteDataTemp(t){var e=new Object,i=t.readInt(),a=t.readInt();e.data=new Array,e.dataByte=new Array;for(var s=0;s<a;s++){var r=new Object;if(r.type=t.readInt(),1==r.type){var n=t.readFloat();e.dataByte.push(n)}if(2==r.type){var h=new b;h.x=t.readFloat(),h.y=t.readFloat(),h.z=t.readFloat(),e.dataByte.push(h)}}return e.type=i,e}getMaxFrame(){return this._keyFrameAry[this._keyFrameAry.length-1].frameNum}dispose(){}}class bt{constructor(){this._delayedTime=0,this._width=100,this._height=100,this._originWidthScale=.5,this._originHeightScale=.5,this._eyeDistance=0,this._watchEye=!1,this._isZiZhuan=!1,this.overAllScale=1}destory(){this.objData&&this.objData.destory(),this.materialParam.destory(),this.timelineData.destory(),this.timelineData=null}uploadGpu(){}regShader(){}initVcData(){}creatPartilce(){var t=this.getParticle();t.data=this;var e=new Dt;return e.setAllDataInfo(this.timelineData),t.setTimeLine(e),t.onCreated(),t}getParticle(){return null}setAllByteInfo(t){this.timelineData=new ut,this.timelineData.setByteData(t),this._beginTime=this.timelineData.beginTime,this.version>=15&&(this._delayedTime=t.readFloat()),this._width=t.readFloat(),this._height=t.readFloat(),this._widthFixed=t.readBoolean(),this._heightFixed=t.readBoolean(),this._originWidthScale=t.readFloat(),this._originHeightScale=t.readFloat(),this._eyeDistance=t.readFloat(),this._alphaMode=t.readFloat(),this._uSpeed=t.readFloat(),this._vSpeed=t.readFloat(),this._animLine=t.readFloat(),this._animRow=t.readFloat(),this._animInterval=t.readFloat(),this._renderPriority=t.readFloat(),this._distortion=t.readBoolean(),this._isUV=t.readBoolean(),this._isU=t.readBoolean(),this._isV=t.readBoolean(),this._life=t.readFloat(),this._life=this._life>1e4?D.MAX_NUMBER:this._life,this._watchEye=t.readBoolean(),this._ziZhuanAngly=new b,this._ziZhuanAngly.x=t.readFloat(),this._ziZhuanAngly.y=t.readFloat(),this._ziZhuanAngly.z=t.readFloat(),this._ziZhuanAngly.w=t.readFloat(),this.rotationV3d=new b,this.rotationV3d.x=t.readFloat(),this.rotationV3d.y=t.readFloat(),this.rotationV3d.z=t.readFloat(),this.center=new b,this.center.x=t.readFloat(),this.center.y=t.readFloat(),this.center.z=t.readFloat(),this.center.w=t.readFloat(),this.overAllScale=t.readFloat(),!this._ziZhuanAngly||0==this._ziZhuanAngly.x&&0==this._ziZhuanAngly.y&&0==this._ziZhuanAngly.z||(this._isZiZhuan=!0),this.readMaterialPara(t);var e=t.readUTF();e=(e=e.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this.materialByteUrl=e}set materialByteUrl(t){this._materialUrl!=t&&(this._materialUrl=t,st.getInstance().getMaterialByte(D.fileRoot+t,t=>{this.onMaterialLoad(t)}))}onMaterialLoad(t){this.materialParam=new dt,this.materialParam.setMaterial(t),this.materialParam.setLife(this._life),this.materialParamData&&(this.materialParam.setTextObj(this.materialParamData.texAry),this.materialParam.setConstObj(this.materialParamData.conAry)),st.getInstance().loadDynamicTexUtil(this.materialParam),this.regShader()}readMaterialPara(t){this.materialParamData=new Object;t.readUTF();var e=t.readInt();this.materialParamData.texAry=new Array;for(var i=0;i<e;i++){var a=new Object;a.isParticleColor=t.readBoolean(),a.paramName=t.readUTF(),a.url=t.readUTF(),a.isParticleColor&&(a.curve=new Object,this.readTempCurve(t,a.curve)),this.materialParamData.texAry.push(a)}this.readMaterialParaConAry(t)}readTempCurve(t,e){e.values=new Array;var i=!1;if(this.version>=12){var a=t.readInt();if(a>0)var s=t.readFloat();for(var r=0;r<a;r++){for(var n=t.readInt(),h=new Array,o=0;o<n;o++)h.push(t.readByte()/127*s);e.values.push(h)}i=!0}e.type=t.readFloat(),e.maxFrame=t.readFloat(),e.sideType=t.readBoolean(),e.speedType=t.readBoolean(),e.useColorType=t.readBoolean(),e.items=this.readItems(t),i||this.makeCurveData(e)}readItems(t){for(var e=new Array,i=t.readInt(),a=0;a<i;a++){var s=new Object;s.frame=t.readInt(),s.vec3=t.readVector3D(!0),s.rotation=t.readVector3D(!0),s.rotationLeft=t.readVector3D(!0),e.push(s)}return e}makeCurveData(t){for(var e=t.items,i=new Array,a=new Array,s=new Array,r=new Array,n=0;n<e.length;n++)if(n==e.length-1)i.push(e[n].vec3.x),a.push(e[n].vec3.y),s.push(e[n].vec3.z),r.push(e[n].vec3.w);else{var h=e[n+1].frame-e[n].frame,o=e[n].vec3,l=e[n+1].vec3,c=t.items[n].rotation,d=t.items[n+1].rotationLeft;i=i.concat(this.getBzData(o.x,l.x,c.x,d.x,h)),a=a.concat(this.getBzData(o.y,l.y,c.y,d.y,h)),s=s.concat(this.getBzData(o.z,l.z,c.z,d.z,h)),r=r.concat(this.getBzData(o.w,l.w,c.w,d.w,h))}t.values=new Array,t.values[0]=i,t.values[1]=a,t.values[2]=s,t.values[3]=r}getBzData(t,e,i,a,s){var r=new _(0,10*t),n=new _(s,10*e),h=new V,o=new b;h.identity(),h.appendRotation(-i,b.Z_AXIS),o=h.transformVector(new b(s/2,0,0));var l=new _(s/2,r.y+o.y);h.identity(),h.appendRotation(-a,b.Z_AXIS),o=h.transformVector(new b(-s/2,0,0));for(var c=[r,l,new _(s/2,n.y+o.y),n],d=new Array,u=1;u<3*s;u++)d.push(this.drawbezier(c,u/(3*s)));var m=new Array;for(u=0;u<s;u++)for(var p=0;p<d.length;p++)if(d[p].x>=u){m.push(d[p].y/10);break}return m}drawbezier(t,e){var i=new Array;if(0==t.length)return new _;for(var a in t)i.push(new _(t[a].x,t[a].y));for(;i.length>1;){for(var s=0;s<i.length-1;s++)this.mathmidpoint(i[s],i[s+1],e);i.pop()}return i[0]}mathmidpoint(t,e,i){var a,s;a=t.x+(e.x-t.x)*i,s=t.y+(e.y-t.y)*i,t.x=a,t.y=s}readMaterialParaConAry(t){for(var e=new Array,i=t.readInt(),a=0;a<i;a++){var s=new Object;s.type=t.readFloat(),s.indexID=t.readFloat(),s.paramName=t.readUTF(),s.curve=new Object,this.readTempCurve(t,s.curve),e.push(s)}this.materialParamData.conAry=e}setFloat32Vec(t,e){}setFloat32Mat(t,e){}}class wt extends k{constructor(){super(),this.isInGroup=!1,this.visible=!0,this._rotationMatrix=new V,this.modelMatrix=new V}onCreated(){}setBind(t,e,i,a,s){this.bindVecter3d=t,this.bindMatrix=e,this.bindScale=i,this.invertBindMatrix=a,this.groupMatrix=s}getMulBindList(){return null}updateMatrix(){this.bindMatrix&&(this.modelMatrix.identity(),this.groupMatrix.isIdentity||this.posMatrix.append(this.groupMatrix),this.modelMatrix.append(this.posMatrix),this.modelMatrix.append(this.bindMatrix),this.modelMatrix.appendScale(He.scaleWorld.x,He.scaleWorld.y,He.scaleWorld.z),this.modelMatrix.appendTranslation(this.bindVecter3d.x*He.scaleWorld.x,this.bindVecter3d.y*He.scaleWorld.y,this.bindVecter3d.z*He.scaleWorld.z))}get cantUseEffectsLev(){return!(this.data._renderPriority<=D.effectsLev)}updateTime(t){this.cantUseEffectsLev||this.bindScale&&(this._time=t-this._beginTime,this._time+=this.data._delayedTime,this.timeline.updateTime(t),this.visible=this.timeline.visible,this.posMatrix.identity(),this.posMatrix.prependScale(.1*this._scaleX*this.bindScale.x*this.data.overAllScale,.1*this._scaleY*this.bindScale.y*this.data.overAllScale,.1*this._scaleZ*this.bindScale.z*this.data.overAllScale),this.timeline.updateMatrix(this.posMatrix,this))}reset(){this.timeline.reset(),this.updateTime(0)}clearAllAnim(){}update(){this.cantUseEffectsLev||this.visible&&this.data.materialParam&&this.data.materialParam.isTexReady()&&(0==this.data._alphaMode&&(this.data._alphaMode=-1),D.context3D.setBlendParticleFactors(this.data._alphaMode),D.context3D.cullFaceBack(this.data.materialParam.material.backCull),this.data.materialParam&&D.context3D.setProgram(this.data.materialParam.program),this.updateMatrix(),this.setVc(),this.setVa(),this.resetVa())}setVc(){}pushVc(){D.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData)}setVa(){}resetVa(){}setMaterialVc(){if(this.data.materialParam){for(var t=this.data.materialParam.dynamicConstList,e=this._time%(D.frameTime*this.data._life),i=0;i<t.length;i++)t[i].update(e);this.data.materialParam.material.fcNum<=0||(e*=this.data.materialParam.material.timeSpeed,this.data.materialParam.material.update(e),D.context3D.setVc4fv(this.data.materialParam.shader,"fc",this.data.materialParam.material.fcData))}}setMaterialTexture(){if(this.data.materialParam){for(var t=this.data.materialParam.material.texList,e=0;e<t.length;e++)t[e].isDynamic||D.context3D.setRenderTexture(this.data.materialParam.shader,t[e].name,t[e].texture,t[e].id,!0);var i=this.data.materialParam.dynamicTexList;for(e=0;e<i.length;e++)D.context3D.setRenderTexture(this.data.materialParam.shader,i[e].target.name,i[e].texture,i[e].target.id,!0)}}inverBind(){this.invertBindMatrix.isIdentity||this._rotationMatrix.prepend(this.invertBindMatrix)}resetPos(){}resetMulPos(t){}getVector3DByObject(t){return t?new b(t.x,t.y,t.z,t.w):null}clone(){return null}setAllByteInfo(t,e=0){this.creatData(),this.data.version=e,this.data.setAllByteInfo(t),this.timeline=new Dt,this.timeline.setAllDataInfo(this.data.timelineData),this._beginTime=this.timeline.beginTime}creatData(){this.data=new bt}setTimeLine(t){this.timeline=t,this._beginTime=t.beginTime}destory(){this.timeline=null,this.bindMatrix=null,this.bindVecter3d=null,this.bindScale=null,this.invertBindMatrix=null,this.groupMatrix=null,this._rotationMatrix=null,this.modelMatrix=null,this.groupPos=null,this.groupScale=null,this.groupRotation=null}}class At extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2TexCoord")}getMat4Str(t){return"vcmat["+At.shader_mat4[t]+"]"}getVec4Str(t){return"vcmat["+At.shader_vec4[t][0]+"]["+At.shader_vec4[t][1]+"]"}static getVcSize(){return 5}getVertexShaderString(){return"attribute vec4 v3Position;\nattribute vec2 v2TexCoord;\nuniform mat4 vcmat["+At.getVcSize()+"];\nvarying vec2 v0;\nvoid main(void){\n   v0 = v2TexCoord + vec2("+this.getVec4Str("uvMove")+".xy);\n   gl_Position = "+this.getMat4Str("viewMatrix3D")+"  * "+this.getMat4Str("camMatrix3D")+" * "+this.getMat4Str("posMatrix3D")+" * "+this.getMat4Str("rotationMatrix3D")+" * v3Position;\n}"}getFragmentShaderString(){return" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}"}}At.Display3D_Facet_Shader="Display3DFacetShader",At.shader_mat4={viewMatrix3D:0,camMatrix3D:1,rotationMatrix3D:2,posMatrix3D:3},At.shader_vec4={uvMove:[4,0]};class Mt extends bt{constructor(){super(...arguments),this._isCycle=!1}setAllByteInfo(t){this._maxAnimTime=t.readFloat(),this._isCycle=t.readBoolean(),this._lockx=t.readBoolean(),this._locky=t.readBoolean(),super.setAllByteInfo(t),this.initVcData(),this.uploadGpu()}getParticle(){return new Tt}uploadGpu(){this.objData=new $,this.makeRectangleData(this._width,this._height,this._originWidthScale,this._originHeightScale,this._isUV,this._isU,this._isV,this._animLine,this._animRow)}makeRectangleData(t,e,i=.5,s=.5,r=!1,n=!1,h=!1,o=1,l=1){var c=new Array,d=new Array,u=new Array;if(u.push(new _(0,0)),u.push(new _(0,1/l)),u.push(new _(1/o,1/l)),u.push(new _(1/o,0)),n)for(var m=0;m<u.length;m++)u[m].x=-u[m].x;if(h)for(m=0;m<u.length;m++)u[m].y=-u[m].y;r&&u.push(u.shift());for(m=0;m<u.length;m++)c.push(u[m].x,u[m].y);d.push(-i*t,e-s*e,0),d.push(u[0].x,u[0].y),d.push(t-i*t,e-s*e,0),d.push(u[1].x,u[1].y),d.push(t-i*t,-s*e,0),d.push(u[2].x,u[2].y),d.push(-i*t,-s*e,0),d.push(u[3].x,u[3].y);var f=new Uint16Array([0,1,2,0,2,3]);let D=this.objData;D.stride=20;let b=new Float32Array(d),w=new p(b.byteLength,WebGLRenderingContext.STATIC_DRAW,!1),A=[new v(0,y.Vector3,g.MESH_POSITION0),new v(12,y.Vector2,g.MESH_TEXTURECOORDINATE0)];w.vertexDeclaration=new x(D.stride,A),w.setData(b),D.layaVertexBuffer=w;var M=new a(D.indexFormat,f.length,WebGLRenderingContext.STATIC_DRAW,!1);M.setData(f),D.layaIndexBuffer=M,D._setBuffer(w,M),D.treNum=f.length}initVcData(){this.vcmatData=new Float32Array(16*At.getVcSize())}setFloat32Vec(t,e){var i=At.shader_vec4[t],a=16*i[0]+4*i[1];this.vcmatData.set(e,a)}setFloat32Mat(t,e){var i=16*At.shader_mat4[t];this.vcmatData.set(e,i)}regShader(){this.materialParam.shader=at.getInstance().getMaterialProgram(At.Display3D_Facet_Shader,At,this.materialParam.material),this.materialParam.program=this.materialParam.shader.program}}class Tt extends wt{constructor(){super(),this._lifeVisible=!0,this._resultUvVec=new Array(2)}get facetdata(){return this.data}creatData(){this.data=new Mt}update(){this._lifeVisible&&super.update()}reset(){super.reset(),this._lifeVisible=!0}setVc(){this.updateRotaionMatrix(),this.updateUV(),this.data.vcmatData.set(D.viewMatrx3D.m,0),this.data.vcmatData.set(D.cam3D.cameraMatrix.m,16),this.data.vcmatData.set(this.modelMatrix.m,48),this.data.vcmatData.set(this._rotationMatrix.m,32),this.data.vcmatData.set(this._resultUvVec,64),this.setMaterialVc(),!this.facetdata._isCycle&&this._time/D.frameTime>this.data._life-2&&(this._lifeVisible=!1),D.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData)}setVa(){let t=this.data.objData;t._bufferState.bind(),this.setMaterialTexture(),D.context3D.drawCallL3d(t.treNum)}updateRotaionMatrix(){this._rotationMatrix.identity(),this.data._watchEye&&(this.timeline.inverAxisRotation(this._rotationMatrix),this.facetdata._locky||this.facetdata._lockx||this.inverBind(),this.facetdata._locky||this._rotationMatrix.prependRotation(-D.cam3D.rotationY,b.Y_AXIS),this.facetdata._lockx||this._rotationMatrix.prependRotation(-D.cam3D.rotationX,b.X_AXIS)),this.data._isZiZhuan&&this.timeline.applySelfRotation(this._rotationMatrix,this.data._ziZhuanAngly)}updateUV(){var t=M.float2int(this._time/D.frameTime);t=(t=t>this.facetdata._maxAnimTime?this.facetdata._maxAnimTime:t)/this.data._animInterval%(this.data._animLine*this.data._animRow),this._resultUvVec[0]=M.float2int(t%this.data._animLine)/this.data._animLine+this._time/D.frameTime*this.data._uSpeed,this._resultUvVec[1]=M.float2int(t/this.data._animLine)/this.data._animRow+this._time/D.frameTime*this.data._vSpeed}}class St extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"vPosition"),t.bindAttribLocation(this.program,1,"texcoord"),t.bindAttribLocation(this.program,2,"basePos"),t.bindAttribLocation(this.program,3,"speed"),this.paramAry[3]&&t.bindAttribLocation(this.program,4,"rotation"),this.paramAry[1]&&t.bindAttribLocation(this.program,5,"color")}getMat4Str(t){return"vcmat["+St.shader_mat4[t]+"]"}getVec4Str(t){return"vcmat["+St.shader_vec4[t][0]+"]["+St.shader_vec4[t][1]+"]"}static getVcSize(){return 7}getVertexShaderString(){var t,e,i,a,s,r,n,h,o,l;l="attribute vec4 vPosition;\nattribute vec3 texcoord;\nattribute vec4 basePos;\nattribute vec3 speed;\nuniform mat4 vcmat["+St.getVcSize()+"];\nvarying vec2 v0;\n",t="float ctime = "+this.getVec4Str("time")+".x - basePos.w;\nif ("+this.getVec4Str("time")+".w > 0.0 && ctime >= 0.0) {\n    ctime = fract(ctime / "+this.getVec4Str("time")+".z) * "+this.getVec4Str("time")+".z;\n}\nvec4 pos = vPosition;\n",e="float stime = ctime - "+this.getVec4Str("scale")+".w;\nstime = max(stime,0.0);\nfloat sf = "+this.getVec4Str("scale")+".x * stime;\nif ("+this.getVec4Str("scale")+".y != 0.0 && "+this.getVec4Str("scale")+".z != 0.0) {\n    sf += sin("+this.getVec4Str("scale")+".y * stime) * "+this.getVec4Str("scale")+".z;\n}\nif (sf > "+this.getVec4Str("scaleCtrl")+".z) {\n    sf = "+this.getVec4Str("scaleCtrl")+".z;\n} else if (sf < "+this.getVec4Str("scaleCtrl")+".w) {\n    sf = "+this.getVec4Str("scaleCtrl")+".w;\n}\nvec2 sv2 = vec2("+this.getVec4Str("scaleCtrl")+".x * sf, "+this.getVec4Str("scaleCtrl")+".y * sf);\nsv2 = sv2 + 1.0;\npos.x *= sv2.x;\npos.y *= sv2.y;\n",i="vec3 addPos = speed * ctime;\nvec3 uspeed = vec3(0,0,0);\nif (ctime < 0.0 || ctime >= "+this.getVec4Str("time")+".z) {\n    addPos.y = addPos.y + 100000.0;\n}\n",a="if("+this.getVec4Str("time")+".y != 0.0 && length(speed) != 0.0) {\n    uspeed = vec3(speed.x, speed.y, speed.z);\n    uspeed = normalize(uspeed);\n    uspeed = uspeed * "+this.getVec4Str("time")+".y;\n    uspeed.xyz = uspeed.xyz + "+this.getVec4Str("force")+".xyz;\n} else {\n    uspeed = vec3("+this.getVec4Str("force")+".x, "+this.getVec4Str("force")+".y, "+this.getVec4Str("force")+".z);\n}\naddPos.xyz = addPos.xyz + uspeed.xyz * ctime * ctime;\n",s="uspeed = speed + uspeed * ctime * 2.0;\nuspeed = normalize(uspeed);\nvec4 tempMul = "+this.getMat4Str("rotationMatrix")+" * vec4(uspeed,1.0);\nuspeed.xyz = tempMul.xyz;\nuspeed = normalize(uspeed);\nvec3 cPos = addPos;\ntempMul = "+this.getMat4Str("rotationMatrix")+" * vec4(cPos,1.0);\ncPos.xyz = tempMul.xyz; \ncPos.xyz = "+this.getVec4Str("worldPos")+".xyz + cPos.xyz;\ncPos.xyz = "+this.getVec4Str("camPos")+".xyz - cPos.xyz;\ncPos = normalize(cPos);\ncPos = cross(uspeed, cPos);\ncPos = normalize(cPos);\nuspeed = uspeed * pos.x;\ncPos = cPos * pos.y;\npos.xyz = uspeed.xyz + cPos.xyz;\n",r="pos = "+this.getMat4Str("watheye")+" * pos;\npos.xyz = pos.xyz + basePos.xyz + addPos.xyz;\ngl_Position = "+this.getMat4Str("viewMatrix3D")+" * "+this.getMat4Str("camMatrix3D")+" * "+this.getMat4Str("modelMatrix")+" * pos;\n",n="vec2 uv = vec2(texcoord.x,texcoord.y);\nfloat animframe = floor(ctime / "+this.getVec4Str("animCtrl")+".z);\nanimframe = animframe / "+this.getVec4Str("animCtrl")+".x;\nuv.x += animframe;\nanimframe = floor(animframe);\nuv.y += animframe / "+this.getVec4Str("animCtrl")+".y;\nv0.xy = uv.xy;\n",h="vec2 uv = vec2("+this.getVec4Str("uvCtrl")+".x,"+this.getVec4Str("uvCtrl")+".y);\nuv.xy = uv.xy * ctime + texcoord.xy;\nv0.xy = uv.xy;\n",o="v1 = vec2(ctime/"+this.getVec4Str("time")+".z,1.0);\n";var c=this.paramAry[0],d=this.paramAry[1],u=this.paramAry[2],m=this.paramAry[3],p=this.paramAry[4],y=this.paramAry[5],x=this.paramAry[6],v="",g="";return v+=t,g+=l,p&&(v+=e,g+=""),m&&(v+="float angle = rotation.x + rotation.y * ctime;\nvec4 np = vec4(sin(angle), cos(angle), 0, 0);\nnp.z = np.x * pos.y + np.y * pos.x;\nnp.w = np.y * pos.y - np.x * pos.x;\npos.xy = np.zw;\n",g+="attribute vec2 rotation;\n"),v+=i,y&&(v+=a,g+=""),u&&(v+=s,g+=""),v+=r,1==x?(v+=n,g+=""):2==x?(v+=h,g+=""):v+="v0 = vec2(texcoord.x,texcoord.y);\n",d&&(v+="v2 = color;\n",g+="attribute vec4 color;\nvarying vec4 v2;\n"),c&&(v+=o,g+="varying vec2 v1;\n"),g+"void main(){\n"+v+"}"}getFragmentShaderString(){return" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}"}}St.Display3D_Ball_Shader="Display3DBallShader",St.shader_mat4={viewMatrix3D:0,camMatrix3D:1,modelMatrix:2,watheye:3,rotationMatrix:4},St.shader_vec4={time:[5,0],scale:[5,1],scaleCtrl:[5,2],force:[5,3],worldPos:[6,0],camPos:[6,1],animCtrl:[6,2],uvCtrl:[6,3]};class Pt extends ${}class It extends Pt{destory(){super.destory(),this.basePos&&(this.basePos.length=0,this.basePos=null,this.basePosBuffer&&(D.context3D.deleteBuffer(this.basePosBuffer),this.basePosBuffer=null)),this.beMove&&(this.beMove.length=0,this.beMove=null,this.beMoveBuffer&&(D.context3D.deleteBuffer(this.beMoveBuffer),this.beMoveBuffer=null)),this.randomColor&&(this.randomColor.length=0,this.randomColor=null,this.randomColorBuffer&&(D.context3D.deleteBuffer(this.randomColorBuffer),this.randomColorBuffer=null)),this.baseRotation&&(this.baseRotation.length=0,this.baseRotation=null,this.baseRotationBuffer&&(D.context3D.deleteBuffer(this.baseRotationBuffer),this.baseRotationBuffer=null))}}class Rt extends bt{constructor(){super(...arguments),this._totalNum=1,this._acceleration=.2,this._toscale=0,this._shootAngly=new b(1,0,0),this._shootSpeed=0,this._isRandom=!1,this._isSendRandom=!1,this._isSendAngleRandom=!1,this._paticleMaxScale=1,this._paticleMinScale=1,this._addforce=new b(0,0,0),this._lixinForce=new b(0,0,0),this._waveform=new b(0,0,0,0),this._round=new b,this._is3Dlizi=!1,this._speed=1,this._isLoop=!1,this._basePositon=new b(0,0,0),this._baseRandomAngle=0,this._shapeType=0,this._playSpeed=1,this._beginScale=0}getParticle(){return new Lt}setAllByteInfo(t){this._totalNum=t.readFloat(),this._acceleration=t.readFloat(),this._toscale=t.readFloat(),this._shootSpeed=t.readFloat(),this._isRandom=t.readBoolean(),this._isSendRandom=t.readBoolean(),this._round.x=t.readFloat(),this._round.y=t.readFloat(),this._round.z=t.readFloat(),this._round.w=t.readFloat(),this._is3Dlizi=t.readBoolean(),this._halfCircle=t.readBoolean(),this._shootAngly.x=t.readFloat(),this._shootAngly.y=t.readFloat(),this._shootAngly.z=t.readFloat(),this._shootAngly.w=t.readFloat(),this._shootAngly.normalize(),this._speed=t.readFloat(),this._isLoop=t.readBoolean(),this._isSendAngleRandom=t.readBoolean(),this._waveform.x=t.readFloat(),this._waveform.y=t.readFloat(),this._waveform.z=t.readFloat(),this._waveform.w=t.readFloat(),this._closeSurface=t.readBoolean(),this._isEven=t.readBoolean(),this._paticleMaxScale=t.readFloat(),this._paticleMinScale=t.readFloat(),this._basePositon.x=t.readFloat(),this._basePositon.y=t.readFloat(),this._basePositon.z=t.readFloat(),this._basePositon.w=t.readFloat(),this._baseRandomAngle=t.readFloat(),this._shapeType=t.readFloat(),this._lockX=t.readBoolean(),this._lockY=t.readBoolean(),this._addforce.x=t.readFloat(),this._addforce.y=t.readFloat(),this._addforce.z=t.readFloat(),this._addforce.w=t.readFloat(),this._addforce.scaleByW(),this._lixinForce.x=t.readFloat(),this._lixinForce.y=t.readFloat(),this._lixinForce.z=t.readFloat(),this._lixinForce.w=t.readFloat(),this._islixinAngly=t.readBoolean(),this._particleRandomScale=new b,this._particleRandomScale.x=t.readFloat(),this._particleRandomScale.y=t.readFloat(),this._particleRandomScale.z=t.readFloat(),this._particleRandomScale.w=t.readFloat(),this._playSpeed=t.readFloat(),this.facez=t.readBoolean(),this._beginScale=t.readFloat(),this._widthFixed=t.readBoolean(),this._heightFixed=t.readBoolean(),this.readRandomColor(t),0!=this._acceleration||0!=this._addforce.x||0!=this._addforce.y||0!=this._addforce.z?(this._needAddSpeed=!0,this._addSpeedVec=[this._addforce.x,this._addforce.y,this._addforce.z]):this._needAddSpeed=!1,0!=this._toscale||0!=this._waveform.x||0!=this._waveform.y?(this._needScale=!0,this._scaleVec=[this._toscale,this._waveform.x,this._waveform.y,this._beginScale],this._scaleCtrlVec=[this._widthFixed?0:1,this._heightFixed?0:1,this._paticleMaxScale-1,this._paticleMinScale-1]):this._needScale=!1,super.setAllByteInfo(t),this._timeVec=[0,this._acceleration,this._life,this._isLoop?1:-1],this._is3Dlizi&&(this._wordPosVec=[0,0,0],this._caramPosVec=[0,0,0],this._allRotationMatrix=new V),this.initVcData()}readRandomColor(t){var e=t.readInt(),i=new Object;i.alpha=new Array,i.color=new Array,i.pos=new Array;for(var a=0;a<e;a++)i.alpha.push(t.readFloat()),i.color.push(t.readFloat()),i.pos.push(t.readFloat());this._textureRandomColorInfo=i}get objBallData(){return this.objData}uploadGpu(){this.objData=new It,this.initBaseData(),this.initBasePos(),this.initSpeed(),this.initSelfRotaion(),this._needRandomColor&&this.initBaseColor(),this.pushToGpu()}initBaseData(){for(var t=new Array,e=new Array,i=new Array,a=0;a<this._totalNum;a++)this.makeRectangleData(t,e,this._width,this._height,this._originWidthScale,this._originHeightScale,this._isUV,this._isU,this._isV,this._animLine,this._animRow,a),i.push(0+4*a,1+4*a,2+4*a,0+4*a,2+4*a,3+4*a);this.objBallData.vertices=t,this.objBallData.uvs=e,this.objBallData.indexs=i}makeRectangleData(t,e,i,a,s=.5,r=.5,n=!1,h=!1,o=!1,l=1,c=1,d=0){var u=Math.random()*(this._particleRandomScale.x-this._particleRandomScale.y)+this._particleRandomScale.y;t.push(-s*i*u,(a-r*a)*u,0),t.push((i-s*i)*u,(a-r*a)*u,0),t.push((i-s*i)*u,-r*a*u,0),t.push(-s*i*u,-r*a*u,0);var m=new Array;if(m.push(new _(0,0)),m.push(new _(0,1/c)),m.push(new _(1/l,1/c)),m.push(new _(1/l,0)),h)for(var p=0;p<m.length;p++)m[p].x=-m[p].x;if(o)for(p=0;p<m.length;p++)m[p].y=-m[p].y;n&&m.push(m.shift());for(p=0;p<m.length;p++)e.push(m[p].x,m[p].y,d)}initBasePos(){for(var t=new Array,e=0;e<this._totalNum;e++){var i,a;if(this._isRandom){var s=new b(this._round.x*this._round.w,this._round.y*this._round.w,this._round.z*this._round.w);this._isEven?this._closeSurface?(i=new b(0,0,s.z),(a=new V).appendRotation(360*Math.random(),b.Y_AXIS),(i=a.transformVector(i)).y=s.y*Math.random()*2-s.y):(i=new b(0,0,s.z*Math.random()*2-s.z),(a=new V).appendRotation(360*Math.random(),b.Y_AXIS),(i=a.transformVector(i)).y=s.y*Math.random()*2-s.y):this._closeSurface?(i=new b(0,0,s.z),a=new V,this._halfCircle?a.appendRotation(180*-Math.random(),b.X_AXIS):a.appendRotation(360*Math.random(),b.X_AXIS),a.appendRotation(360*Math.random(),b.Y_AXIS),i=a.transformVector(i)):i=this._halfCircle?new b(s.x*Math.random()*2-s.x,s.y*Math.random(),s.z*Math.random()*2-s.z):new b(s.x*Math.random()*2-s.x,s.y*Math.random()*2-s.y,s.z*Math.random()*2-s.z)}else i=new b;i=i.add(this._basePositon);for(var r=0;r<4;r++)t.push(i.x,i.y,i.z,e*this._shootSpeed)}this.objBallData.basePos=t}initSpeed(){for(var t=new Array,e=0;e<this._totalNum;e++){var i=new b,a=new b;if(0!=this._shootAngly.x||0!=this._shootAngly.y||0!=this._shootAngly.z){var s=Math.tan(this._shootAngly.w*Math.PI/180*Math.random()),r=360*Math.PI/180*Math.random();a=new b(Math.sin(r)*s,Math.cos(r)*s,1);var n=new V;if(n.fromVtoV(new b(0,.0101,.99994),new b(this._shootAngly.x,this._shootAngly.y,this._shootAngly.z)),a=n.transformVector(a),isNaN(a.x))throw new Error("发射锥角，可能有问题，确定是否有取膜");a.normalize(),i=i.add(a)}0==this._lixinForce.x&&0==this._lixinForce.y&&0==this._lixinForce.z||((a=new b(Math.random()>.5?-this._lixinForce.x:this._lixinForce.x,Math.random()>.5?-this._lixinForce.y:this._lixinForce.y,Math.random()>.5?-this._lixinForce.z:this._lixinForce.z)).normalize(),i=i.add(a)),this._islixinAngly&&((a=this._isEven?new b(this.objBallData.basePos[16*e],0,this.objBallData.basePos[16*e+2]):new b(this.objBallData.basePos[16*e],this.objBallData.basePos[16*e+1],this.objBallData.basePos[16*e+2])).normalize(),i=i.add(a)),i.normalize(),this._isSendRandom?i.scaleBy(this._speed*Math.random()):i.scaleBy(this._speed);this._baseRandomAngle,Math.random(),Math.PI;for(var h=0;h<4;h++)t.push(i.x,i.y,i.z)}this.objBallData.beMove=t}initSelfRotaion(){var t=0,e=0;if(0!=this._ziZhuanAngly.x||0!=this._ziZhuanAngly.y||0!=this._ziZhuanAngly.z||0!=this._ziZhuanAngly.w)if(this._is3Dlizi)this._needSelfRotation=!1;else{this._needSelfRotation=!0;for(var i=new Array,a=0;a<this._totalNum;)t=this._ziZhuanAngly.x,1==this._ziZhuanAngly.y&&(t*=Math.random()),e=this._ziZhuanAngly.z,1==this._ziZhuanAngly.w?e*=Math.random():-1==this._ziZhuanAngly.w&&(e*=2*Math.random()-1),i.push(t,e),i.push(t,e),i.push(t,e),i.push(t,e),a++;this.objBallData.baseRotation=i}else this._needSelfRotation=!1}initBaseColor(){for(var t=ht.getInstance().getImageData(this._textureRandomColorInfo).data,e=new Array,i=0;i<this._totalNum;i++){var a=4*M.float2int(128*Math.random()),s=new b(t[a],t[a+1],t[a+2],t[a+3]);s.scaleBy(1/255),e.push(s.x,s.y,s.z,s.w),e.push(s.x,s.y,s.z,s.w),e.push(s.x,s.y,s.z,s.w),e.push(s.x,s.y,s.z,s.w)}this.objBallData.randomColor=e}pushToGpu(){this.compressVertex()}compressVertex(){let t=this.objBallData;var e=t.vertices.length/3,i=13;this._needSelfRotation&&(i+=2),this._needRandomColor&&(t.randomOffset=4*i,i+=4),t.stride=4*i;for(var s=new Array,r=0;r<e;r++){for(var n=0;n<3;n++)s.push(t.vertices[3*r+n]);for(n=0;n<3;n++)s.push(t.uvs[3*r+n]);for(n=0;n<4;n++)s.push(t.basePos[4*r+n]);for(n=0;n<3;n++)s.push(t.beMove[3*r+n]);if(this._needSelfRotation)for(n=0;n<2;n++)s.push(t.baseRotation[2*r+n]);if(this._needRandomColor)for(n=0;n<4;n++)s.push(t.randomColor[4*r+n])}t.treNum=t.indexs.length;let h=new Float32Array(s),o=new p(h.byteLength,WebGLRenderingContext.STATIC_DRAW,!0),l=[new v(0,y.Vector3,g.MESH_POSITION0),new v(12,y.Vector3,g.MESH_TEXTURECOORDINATE0),new v(24,y.Vector4,2),new v(40,y.Vector3,3)];this._needSelfRotation&&l.push(new v(52,y.Vector2,4)),this._needRandomColor&&l.push(new v(t.randomOffset,y.Vector4,5)),o.vertexDeclaration=new x(t.stride,l),o.setData(h);let c=new Uint16Array(this.objBallData.indexs);var d=new a(t.indexFormat,c.length,WebGLRenderingContext.STATIC_DRAW,!1);d.setData(c),t.layaIndexBuffer=d,t._setBuffer(o,d)}setFloat32Vec(t,e){var i=St.shader_vec4[t],a=16*i[0]+4*i[1];this.vcmatData.set(e,a)}setFloat32Mat(t,e){var i=16*St.shader_mat4[t];this.vcmatData.set(e,i)}initVcData(){this.vcmatData=new Float32Array(16*St.getVcSize()),this.setFloat32Vec("time",this._timeVec),this._needAddSpeed&&this.setFloat32Vec("force",this._addSpeedVec),this._needScale&&(this.setFloat32Vec("scale",this._scaleVec),this.setFloat32Vec("scaleCtrl",this._scaleCtrlVec)),1==this._uvType?this.setFloat32Vec("animCtrl",this._animCtrlVec):2==this._uvType&&this.setFloat32Vec("uvCtrl",this._uvCtrlVec)}regShader(){if(this.materialParam){var t=this.getShaderParam();this.materialParam.shader=at.getInstance().getMaterialProgram(St.Display3D_Ball_Shader,St,this.materialParam.material,t),this.materialParam.program=this.materialParam.shader.program}}getShaderParam(){1!=this._animRow||1!=this._animLine?(this._uvType=1,this._animCtrlVec=[this._animLine,this._animRow,this._animInterval]):0!=this._uSpeed||0!=this._vSpeed?(this._uvType=2,this._uvCtrlVec=[this._uSpeed,this._vSpeed]):this._uvType=0;var t=this.materialParam.material.hasParticleColor;return this._needRandomColor=this.materialParam.material.hasVertexColor,this.uploadGpu(),[t?1:0,this._needRandomColor?1:0,this._is3Dlizi?1:0,this._needSelfRotation?1:0,this._needScale?1:0,this._needAddSpeed?1:0,this._uvType]}}class Lt extends wt{constructor(){super()}get balldata(){return this.data}creatData(){this.data=new Rt}setVa(){this.setVaCompress(),this.setMaterialTexture(),D.context3D.drawCallL3d(this.data.objData.treNum)}setVaCompress(){this.balldata.objData._bufferState.bind()}setVc(){this.updateWatchCaramMatrix(),this.balldata.vcmatData.set(D.viewMatrx3D.m,0),this.balldata.vcmatData.set(D.cam3D.cameraMatrix.m,16),this.balldata.vcmatData.set(this.modelMatrix.m,32),this.balldata.vcmatData.set(this._rotationMatrix.m,48),this.balldata._timeVec[0]=this._time/D.frameTime*this.balldata._playSpeed,this.balldata.vcmatData.set(this.balldata._timeVec,80),this.balldata._is3Dlizi&&(this.updateAllRotationMatrix(),this.balldata._wordPosVec[0]=this.bindVecter3d.x,this.balldata._wordPosVec[1]=this.bindVecter3d.y,this.balldata._wordPosVec[2]=this.bindVecter3d.z,this.balldata._caramPosVec[0]=D.cam3D.x,this.balldata._caramPosVec[1]=D.cam3D.y,this.balldata._caramPosVec[2]=D.cam3D.z,this.balldata.vcmatData.set(this.balldata._allRotationMatrix.m,64),this.balldata.vcmatData.set(this.balldata._wordPosVec,96),this.balldata.vcmatData.set(this.balldata._caramPosVec,100)),D.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.balldata.vcmatData),this.setMaterialVc()}updateWatchCaramMatrix(){this._rotationMatrix.identity(),this.balldata.facez?this._rotationMatrix.prependRotation(90,b.X_AXIS):this.balldata._is3Dlizi?(this.timeline.inverAxisRotation(this._rotationMatrix),this.inverBind()):this.balldata._watchEye&&(this.timeline.inverAxisRotation(this._rotationMatrix),this.inverBind(),this._rotationMatrix.prependRotation(-D.cam3D.rotationY,b.Y_AXIS),this._rotationMatrix.prependRotation(-D.cam3D.rotationX,b.X_AXIS))}updateAllRotationMatrix(){this.balldata._allRotationMatrix.identity(),this.balldata._allRotationMatrix.prependScale(this.data.overAllScale*this._scaleX*.1*this.bindScale.x,this.data.overAllScale*this._scaleY*.1*this.bindScale.y,this.data.overAllScale*this._scaleZ*.1*this.bindScale.z),this.timeline.inverAxisRotation(this._rotationMatrix),this.isInGroup&&(this.balldata._allRotationMatrix.appendRotation(this.groupRotation.x,b.X_AXIS),this.balldata._allRotationMatrix.appendRotation(this.groupRotation.y,b.Y_AXIS),this.balldata._allRotationMatrix.appendRotation(this.groupRotation.z,b.Z_AXIS)),this.bindMatrix&&this.balldata._allRotationMatrix.append(this.bindMatrix)}get particleBallData(){return this.data.objData}}class Bt extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2TexCoord"),this.paramAry[0]&&t.bindAttribLocation(this.program,2,"v3Normal")}getMat4Str(t){return"vcmat["+Bt.shader_mat4[t]+"]"}getVec4Str(t){return"vcmat["+Bt.shader_vec4[t][0]+"]["+Bt.shader_vec4[t][1]+"]"}static getVcSize(){return 4}getVertexShaderString(){var t="attribute vec4 v3Position;\nattribute vec2 v2TexCoord;\nuniform mat4 vcmat["+At.getVcSize()+"];\nvarying vec2 v0;\nvarying vec4 v2;\n",e="   vec2 tempv0 = v2TexCoord;\n   tempv0.x -= "+this.getVec4Str("uvMove")+".x;\n",i="   tempv0.xy *= "+this.getVec4Str("isUv")+".xy;\n   if("+this.getVec4Str("isUv")+".z >= 0.0){\n   vec2 tempv1 = tempv0;\n   tempv0.y = tempv1.x;\n   tempv0.x = tempv1.y;}\n   v0 = tempv0;\n",a="   float alpha = tempv0.x/"+this.getVec4Str("uvMove")+".y;\n   alpha = 1.0 - clamp(abs(alpha),0.0,1.0);\n   float kill = -tempv0.x;\n   kill *= tempv0.x - "+this.getVec4Str("uvMove")+".z;\n   v2 = vec4(kill,0.0,0.0,alpha);\n",s="   gl_Position = "+this.getMat4Str("viewMatrix3D")+"  * "+this.getMat4Str("camMatrix3D")+" * "+this.getMat4Str("posMatrix3D")+" * v3Position;\n",r="   vec4 tempPos = "+this.getMat4Str("posMatrix3D")+" * v3Position;\n   vec3 mulPos = vec3(tempPos.x,tempPos.y,tempPos.z);\n   vec3 normals = vec3(v3Normal.x,v3Normal.y,v3Normal.z);\n   mulPos = normalize(vec3("+this.getVec4Str("camPos")+".xyz) - mulPos);\n   mulPos = cross(mulPos, normals);\n   mulPos = normalize(mulPos);\n   mulPos *= v3Normal.w;\n   tempPos.xyz = mulPos.xyz + v3Position.xyz;\n   gl_Position = "+this.getMat4Str("viewMatrix3D")+"  * "+this.getMat4Str("camMatrix3D")+" * "+this.getMat4Str("posMatrix3D")+" * tempPos;\n",n=this.paramAry[0],h=this.paramAry[1],o=this.paramAry[2],l=t;n&&(l+="attribute vec4 v3Normal;\n"),h&&(l+=""),o&&(l+="varying vec2 v1;\n");var c=e+a;return o&&(c+="   v1 = v2TexCoord;\n"),c+=h?i:"   v0 = tempv0;\n",l+"void main(void){\n"+(c+=n?r:s)+"}"}getFragmentShaderString(){return" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}"}}Bt.Display3D_Locus_Shader="Display3DLocusShader",Bt.shader_mat4={viewMatrix3D:0,camMatrix3D:1,posMatrix3D:2},Bt.shader_vec4={uvMove:[3,0],camPos:[3,1],isUv:[3,2]};class Ct extends bt{constructor(){super(...arguments),this._speed=1,this._isLoop=!1}getParticle(){return new Ft}setAllByteInfo(t){this.objData=new $,this._isLoop=t.readBoolean(),this._speed=t.readFloat(),this._density=t.readFloat(),this._isEnd=t.readBoolean(),this._watchEye=t.readBoolean();let e=[new v(0,y.Vector3,g.MESH_POSITION0),new v(12,y.Vector2,g.MESH_TEXTURECOORDINATE0)];this._watchEye&&e.push(new v(20,y.Vector4,2));let i=this._watchEye?36:20,s=new x(i,e);var r=t.getInt();this.objData.stride=s.vertexStride;this.objData.stride=s.vertexStride;var n=i/4,h=new ArrayBuffer(r*i),o=new DataView(h);se.readBytes2ArrayBuffer(t,o,3,0,n,4),se.readBytes2ArrayBuffer(t,o,2,3,n,4),this._watchEye&&se.readBytes2ArrayBuffer(t,o,4,5,n,4);let l=se.readIndexForInt(t);super.setAllByteInfo(t),this.initUV(),this._watchEye&&(this._caramPosVec=[0,0,0]),this._uvVec=[this._isU?-1:1,this._isV?-1:1,this._isUV?1:-1],this.initVcData();let c=new p(h.byteLength,WebGLRenderingContext.STATIC_DRAW,!0);c.vertexDeclaration=s,c.setData(h),this.objData.layaVertexBuffer=c;var d=new a(this.objData.indexFormat,l.length,WebGLRenderingContext.STATIC_DRAW,!1);d.setData(l),this.objData.layaIndexBuffer=d,this.objData._setBuffer(c,d),this.objData.treNum=l.length}initUV(){this._resultUvVec=new Array(3);var t,e=this._life/100,i=0*this._speed/this._density/10;this._isEnd&&(i=Math.min(1,i)),t=this._isLoop?this._life?new b(i%=e+1,e,-e):new b((i%=1)+1,99,-2):this._life?new b(i,e,-1):new b(i,99,-1),this._resultUvVec[0]=t.x,this._resultUvVec[1]=t.y,this._resultUvVec[2]=t.z}uploadGpu(){this.objData.vertexBuffer=D.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=D.context3D.uploadBuff3D(this.objData.uvs),this._watchEye&&(this.objData.normalsBuffer=D.context3D.uploadBuff3D(this.objData.normals)),this.objData.indexBuffer=D.context3D.uploadIndexBuff3D(this.objData.indexs),this.objData.treNum=this.objData.indexs.length}regShader(){if(this.materialParam){var t,e=this._watchEye?1:0,i=0,a=this.materialParam.material.hasParticleColor;this._isU||this._isV||this._isUV?(i=1,this._changUv=!0):this._changUv=!1,t=[e,i,a?1:0],this.materialParam.shader=at.getInstance().getMaterialProgram(Bt.Display3D_Locus_Shader,Bt,this.materialParam.material,t),this.materialParam.program=this.materialParam.shader.program}}initVcData(){this.vcmatData=new Float32Array(16*Bt.getVcSize())}setFloat32Vec(t,e){var i=Bt.shader_vec4[t],a=16*i[0]+4*i[1];this.vcmatData.set(e,a)}setFloat32Mat(t,e){var i=16*Bt.shader_mat4[t];this.vcmatData.set(e,i)}}class Ft extends wt{constructor(){super()}get locusdata(){return this.data}creatData(){this.data=new Ct}setVa(){this.setMaterialTexture();let t=this.data.objData;t._bufferState.bind(),D.context3D.drawCallL3d(t.treNum),t._bufferState.unBind(),D.context3D.setWriteDepth(!1)}setVc(){this.updateUV(),this.data.vcmatData.set(D.viewMatrx3D.m,0),this.data.vcmatData.set(D.cam3D.cameraMatrix.m,16),this.data.vcmatData.set(this.modelMatrix.m,32),this.data.vcmatData.set(this.locusdata._resultUvVec,48),this.data._watchEye&&(this.locusdata._caramPosVec[0]=D.cam3D.x,this.locusdata._caramPosVec[1]=D.cam3D.y,this.locusdata._caramPosVec[2]=D.cam3D.z,this.data.vcmatData.set(this.locusdata._caramPosVec,52)),this.locusdata._changUv&&this.data.setFloat32Vec("isUv",this.locusdata._uvVec),D.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData),this.setMaterialVc()}updateUV(){var t=this._time/D.frameTime,e=this.data._life/100,i=this.locusdata._speed*t/this.locusdata._density/10;this.locusdata._isEnd&&(i=Math.min(1,i)),this.locusdata._isLoop&&(this.locusdata._life?i%=e+1:i%=1),this.locusdata._resultUvVec[0]=i}}class zt extends Rt{getParticle(){return new Et}initBasePos(){for(var t=new Array,e=0;e<this._totalNum;e++){var i,a=3*e;if(this._isRandom){var s=new b(this._round.x*this._round.w,this._round.y*this._round.w,this._round.z*this._round.w);i=new b(this._posAry[a]+Math.random()*s.x,this._posAry[a+1]+Math.random()*s.y,this._posAry[a+2]+Math.random()*s.z)}else i=new b(this._posAry[a],this._posAry[a+1],this._posAry[a+2]);i=i.add(this._basePositon);for(var r=0;r<4;r++)t.push(i.x,i.y,i.z,e*this._shootSpeed)}this.objBallData.basePos=t}initSpeed(){for(var t=new Array,e=0;e<this._totalNum;e++){var i=new b;if(0==this._tangentSpeed)i.addByNum(this._angleAry[3*e],this._angleAry[3*e+1],this._angleAry[3*e+2]);else if(2==this._tangentSpeed)i.setTo(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1);else{var a=new b(this._tangentAry[3*e],this._tangentAry[3*e+1],this._tangentAry[3*e+2]);a.scaleBy(this._tangentSpeed),i=i.add(a)}i.normalize(),this._isSendRandom?i.scaleBy(this._speed*Math.random()):i.scaleBy(this._speed);for(var s=0;s<4;s++)t.push(i.x,i.y,i.z)}this.objBallData.beMove=t}setAllByteInfo(t){this._tangentSpeed=t.readFloat(),this._posAry=JSON.parse(t.readUTF()),this._angleAry=JSON.parse(t.readUTF()),this._tangentAry=JSON.parse(t.readUTF()),super.setAllByteInfo(t),this.uploadGpu()}}class Et extends Lt{constructor(){super()}creatData(){this.data=new zt}}class Vt extends bt{getParticle(){return new Nt}setAllByteInfo(t){let e=this.objData=new $;this._maxAnimTime=t.readFloat();let i=g.getVertexDeclaration("POSITION,UV",!0);var s=t.getInt();let r=e.stride=i.vertexStride;var n=r/4,h=new ArrayBuffer(s*r),o=new DataView(h);se.readBytes2ArrayBuffer(t,o,3,0,n,4),se.readBytes2ArrayBuffer(t,o,2,3,n,4);let l=se.readIndexForInt(t);this.version>=36&&(this._depthMode=t.readInt()),super.setAllByteInfo(t),this.initVcData();let c=new p(h.byteLength,WebGLRenderingContext.STATIC_DRAW,!0);c.vertexDeclaration=i,c.setData(h),e.layaVertexBuffer=c;var d=new a(e.indexFormat,l.length,WebGLRenderingContext.STATIC_DRAW,!1);d.setData(l),e.layaIndexBuffer=d,e._setBuffer(c,d),e.treNum=l.length}initVcData(){this.vcmatData=new Float32Array(16*At.getVcSize())}uploadGpu(){this.objData.vertexBuffer=D.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=D.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=D.context3D.uploadIndexBuff3D(this.objData.indexs),this.objData.treNum=this.objData.indexs.length}regShader(){this.materialParam.shader=at.getInstance().getMaterialProgram(At.Display3D_Facet_Shader,At,this.materialParam.material),this.materialParam.program=this.materialParam.shader.program}setFloat32Vec(t,e){var i=At.shader_vec4[t],a=16*i[0]+4*i[1];this.vcmatData.set(e,a)}setFloat32Mat(t,e){var i=16*At.shader_mat4[t];this.vcmatData.set(e,i)}}class Nt extends wt{constructor(){super(),this._resultUvVec=new Array(2)}get modeldata(){return this.data}creatData(){this.data=new Vt}setVc(){this.updateWatchCaramMatrix(),this.updateUV(),this.data.vcmatData.set(D.viewMatrx3D.m,0),this.data.vcmatData.set(D.cam3D.cameraMatrix.m,16),this.data.vcmatData.set(this.modelMatrix.m,48),this.data.vcmatData.set(this._rotationMatrix.m,32),this.data.vcmatData.set(this._resultUvVec,64),D.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData),this.setMaterialVc()}setVa(){D.context3D.setWriteDepth(1==this.data._depthMode),this.setMaterialTexture();let t=this.data.objData;t._bufferState.bind(),D.context3D.drawCallL3d(t.treNum),t._bufferState.unBind(),D.context3D.setWriteDepth(!1)}updateWatchCaramMatrix(){this._rotationMatrix.identity(),this.data._watchEye&&(this.timeline.inverAxisRotation(this._rotationMatrix),this._rotationMatrix.prependRotation(-D.cam3D.rotationY,b.Y_AXIS),this._rotationMatrix.prependRotation(-D.cam3D.rotationX,b.X_AXIS)),this.data._isZiZhuan&&this.timeline.applySelfRotation(this._rotationMatrix,this.data._ziZhuanAngly)}updateUV(){var t=Math.floor(this._time/D.frameTime/this.data._animInterval);this.data._animLine,this.data._animRow;this._resultUvVec[0]=Math.floor(t%this.data._animLine)/this.data._animLine,this._resultUvVec[1]=Math.floor(t/this.data._animLine)/this.data._animRow,this._resultUvVec[0]+=this._time/D.frameTime*this.data._uSpeed,this._resultUvVec[1]+=this._time/D.frameTime*this.data._vSpeed}}class kt extends Nt{constructor(){super()}update(){this._depthMode&&D.context3D.setDepthTest(!0),super.update(),this._depthMode&&D.context3D.setDepthTest(!1)}}class Ut extends Nt{constructor(){super()}updateUV(){var t=this._time/D.frameTime;t=(t=t>this.modeldata._maxAnimTime?this.modeldata._maxAnimTime:t)/this.data._animInterval%(this.data._animLine*this.data._animRow),this._resultUvVec[0]=M.float2int(t%this.data._animLine)/this.data._animLine+this._time/D.frameTime*this.data._uSpeed,this._resultUvVec[1]=M.float2int(t/this.data._animLine)/this.data._animRow+this._time/D.frameTime*this.data._vSpeed}}class Ot extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"vPosition"),t.bindAttribLocation(this.program,1,"texcoord"),t.bindAttribLocation(this.program,2,"basePos"),t.bindAttribLocation(this.program,3,"speed"),this.paramAry[3]&&t.bindAttribLocation(this.program,4,"rotation"),this.paramAry[1]&&t.bindAttribLocation(this.program,5,"color")}getMat4Str(t){return"vcmat["+St.shader_mat4[t]+"]"}getVec4Str(t){return"vcmat["+St.shader_vec4[t][0]+"]["+St.shader_vec4[t][1]+"]"}static getVcSize(){return 7}getVertexShaderString(){var t,e,i,a,s,r,n,h,o,l;l="attribute vec4 vPosition;\nattribute vec3 texcoord;\nattribute vec4 basePos;\nattribute vec3 speed;\nuniform mat4 vcmat["+St.getVcSize()+"];\nuniform vec3 bindpos[30];\nvarying vec2 v0;\n",t="float ctime = "+this.getVec4Str("time")+".x - basePos.w;\nif ("+this.getVec4Str("time")+".w > 0.0 && ctime >= 0.0) {\n    ctime = fract(ctime / "+this.getVec4Str("time")+".z) * "+this.getVec4Str("time")+".z;\n}\nvec4 pos = vPosition;\n",e="float stime = ctime - "+this.getVec4Str("scale")+".w;\nstime = max(stime,0.0);\nfloat sf = "+this.getVec4Str("scale")+".x * stime;\nif ("+this.getVec4Str("scale")+".y != 0.0 && "+this.getVec4Str("scale")+".z != 0.0) {\n    sf += sin("+this.getVec4Str("scale")+".y * stime) * "+this.getVec4Str("scale")+".z;\n}\nif (sf > "+this.getVec4Str("scaleCtrl")+".z) {\n    sf = "+this.getVec4Str("scaleCtrl")+".z;\n} else if (sf < "+this.getVec4Str("scaleCtrl")+".w) {\n    sf = "+this.getVec4Str("scaleCtrl")+".w;\n}\nvec2 sv2 = vec2("+this.getVec4Str("scaleCtrl")+".x * sf, "+this.getVec4Str("scaleCtrl")+".y * sf);\nsv2 = sv2 + 1.0;\npos.x *= sv2.x;\npos.y *= sv2.y;\n",i="vec3 addPos = speed * ctime;\nvec3 uspeed = vec3(0,0,0);\nif (ctime < 0.0 || ctime >= "+this.getVec4Str("time")+".z) {\n    addPos.y = addPos.y + 100000.0;\n}\n",a="if("+this.getVec4Str("time")+".y != 0.0 && length(speed) != 0.0) {\n    uspeed = vec3(speed.x, speed.y, speed.z);\n    uspeed = normalize(uspeed);\n    uspeed = uspeed * "+this.getVec4Str("time")+".y;\n    uspeed.xyz = uspeed.xyz + "+this.getVec4Str("force")+".xyz;\n} else {\n    uspeed = vec3("+this.getVec4Str("force")+".x, "+this.getVec4Str("force")+".y, "+this.getVec4Str("force")+".z);\n}\naddPos.xyz = addPos.xyz + uspeed.xyz * ctime * ctime;\n",s="uspeed = speed + uspeed * ctime * 2.0;\nuspeed = normalize(uspeed);\nvec4 tempMul = "+this.getMat4Str("rotationMatrix")+" * vec4(uspeed,1.0);\nuspeed.xyz = tempMul.xyz;\nuspeed = normalize(uspeed);\nvec3 cPos = addPos;\ntempMul = "+this.getMat4Str("rotationMatrix")+" * vec4(cPos,1.0);\ncPos.xyz = tempMul.xyz; \ncPos.xyz = "+this.getVec4Str("worldPos")+".xyz + cPos.xyz;\ncPos.xyz = "+this.getVec4Str("camPos")+".xyz - cPos.xyz;\ncPos = normalize(cPos);\ncPos = cross(uspeed, cPos);\ncPos = normalize(cPos);\nuspeed = uspeed * pos.x;\ncPos = cPos * pos.y;\npos.xyz = uspeed.xyz + cPos.xyz;\n",r="pos = "+this.getMat4Str("watheye")+" * pos;\npos.xyz = pos.xyz + basePos.xyz + addPos.xyz;\npos = "+this.getMat4Str("modelMatrix")+" * pos;\npos.xyz = pos.xyz + bindpos[int(texcoord.z)].xyz;\ngl_Position = "+this.getMat4Str("viewMatrix3D")+" * "+this.getMat4Str("camMatrix3D")+" * pos;\n",n="vec2 uv = vec2(texcoord.x,texcoord.y);\nfloat animframe = floor(ctime / "+this.getVec4Str("animCtrl")+".z);\nanimframe = animframe / "+this.getVec4Str("animCtrl")+".x;\nuv.x += animframe;\nanimframe = floor(animframe);\nuv.y += animframe / "+this.getVec4Str("animCtrl")+".y;\nv0.xy = uv.xy;\n",h="vec2 uv = vec2("+this.getVec4Str("uvCtrl")+".x,"+this.getVec4Str("uvCtrl")+".y);\nuv.xy = uv.xy * ctime + texcoord.xy;\nv0.xy = uv.xy;\n",o="v1 = vec2(ctime/"+this.getVec4Str("time")+".z,1.0);\n";var c=this.paramAry[0],d=this.paramAry[1],u=this.paramAry[2],m=this.paramAry[3],p=this.paramAry[4],y=this.paramAry[5],x=this.paramAry[6],v="",g="";return v+=t,g+=l,p&&(v+=e,g+=""),m&&(v+="float angle = rotation.x + rotation.y * ctime;\nvec4 np = vec4(sin(angle), cos(angle), 0, 0);\nnp.z = np.x * pos.y + np.y * pos.x;\nnp.w = np.y * pos.y - np.x * pos.x;\npos.xy = np.zw;\n",g+="attribute vec2 rotation;\n"),v+=i,y&&(v+=a,g+=""),u&&(v+=s,g+=""),v+=r,1==x?(v+=n,g+=""):2==x?(v+=h,g+=""):v+="v0 = vec2(texcoord.x,texcoord.y);\n",d&&(v+="v2 = color;\n",g+="attribute vec4 color;\nvarying vec4 v2;\n"),c&&(v+=o,g+="varying vec2 v1;\n"),g+"void main(){\n"+v+"}"}getFragmentShaderString(){return" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}"}}Ot.Display3D_Follow_Shader="Display3DFollowShader",Ot.shader_mat4={viewMatrix3D:0,camMatrix3D:1,modelMatrix:2,watheye:3,rotationMatrix:4},Ot.shader_vec4={time:[5,0],scale:[5,1],scaleCtrl:[5,2],force:[5,3],worldPos:[6,0],camPos:[6,1],animCtrl:[6,2],uvCtrl:[6,3]};class Wt extends Rt{getParticle(){return new jt}setAllByteInfo(t){super.setAllByteInfo(t),this.uploadGpu()}regShader(){if(this.materialParam){var t=this.getShaderParam();this.materialParam.shader=at.getInstance().getMaterialProgram(Ot.Display3D_Follow_Shader,Ot,this.materialParam.material,t),this.materialParam.program=this.materialParam.shader.program}}}class jt extends Lt{constructor(){super(),this.flag=0}get followdata(){return this.data}creatData(){this.data=new Wt}onCreated(){this.initBingMatrixAry()}setVc(){super.setVc(),this.updateBind(),D.context3D.setVc3fv(this.data.materialParam.shader,"bindpos",this._bindMatrixAry)}initBingMatrixAry(){this._bindMatrixAry=new Float32Array(120),this._bindFlagAry=new Array;for(var t=0;t<this.followdata._totalNum;t++)this._bindFlagAry.push(0)}updateBind(){for(var t=this._time/D.frameTime,e=this.flag;e<this.followdata._totalNum;e++){if((t-e*this.followdata._shootSpeed)/this.followdata._life>=this._bindFlagAry[e]){var i=3*e;this._bindMatrixAry[i]=this.bindVecter3d.x,this._bindMatrixAry[i+1]=this.bindVecter3d.y,this._bindMatrixAry[i+2]=this.bindVecter3d.z,this._bindFlagAry[e]++}}}updateMatrix(){this.bindMatrix&&(this.modelMatrix.identity(),this.groupMatrix.isIdentity||this.posMatrix.append(this.groupMatrix),this.modelMatrix.append(this.posMatrix))}updateAllRotationMatrix(){this.followdata._allRotationMatrix.identity(),this.followdata._allRotationMatrix.prependScale(this.followdata.overAllScale*this._scaleX*.1*this.bindScale.x,this.followdata.overAllScale*this._scaleY*.1*this.bindScale.y,this.followdata.overAllScale*this._scaleZ*.1*this.bindScale.z),this.isInGroup&&(this.followdata._allRotationMatrix.appendRotation(this.groupRotation.x,b.X_AXIS),this.followdata._allRotationMatrix.appendRotation(this.groupRotation.y,b.Y_AXIS),this.followdata._allRotationMatrix.appendRotation(this.groupRotation.z,b.Z_AXIS))}reset(){super.reset();for(var t=0;t<this.followdata._totalNum;t++)this._bindMatrixAry[3*t]=0,this._bindMatrixAry[3*t+1]=0,this._bindMatrixAry[3*t+2]=0,this._bindFlagAry[t]=0}updateWatchCaramMatrix(){this._rotationMatrix.identity(),this.followdata.facez?this._rotationMatrix.prependRotation(90,b.X_AXIS):this.followdata._watchEye&&(this._rotationMatrix.prependRotation(-D.cam3D.rotationY,b.Y_AXIS),this._rotationMatrix.prependRotation(-D.cam3D.rotationX,b.X_AXIS))}}class Gt extends N{constructor(){super(),this._maxTime=1e6,this._rotationX=0,this._rotationY=0,this._rotationZ=0,this.hasMulItem=!1,this.sceneVisible=!0,this.dynamic=!1,this.hasDestory=!1,this._displayAry=new Array,this._time=0,this.bindMatrix=new V,this.invertBindMatrix=new V,this.bindVecter3d=new b,this.bindScale=new b(1,1,1),this.groupMatrix=new V,this.groupRotationMatrix=new V}get displayAry(){return this._displayAry}set displayAry(t){this._displayAry=t}set maxTime(t){this._maxTime=t}set bindTarget(t){this._bindTarget=t,this.invertBindMatrix.isIdentity=!1}set bindSocket(t){this._bindSocket=t}set x(t){this.bindVecter3d.x=t}set y(t){this.bindVecter3d.y=t}set z(t){this.bindVecter3d.z=t}get x(){return this.bindVecter3d.x}get y(){return this.bindVecter3d.y}get z(){return this.bindVecter3d.z}setPos(t,e,i){this.bindVecter3d.setTo(t,e,i);for(var a=0;a<this._displayAry.length;a++)this._displayAry[a].resetPos()}setMulPos(t){for(var e=0;e<this._displayAry.length;e++)this._displayAry[e].resetMulPos(t)}set scaleX(t){this.bindScale.x=t}set scaleY(t){this.bindScale.y=t}set scaleZ(t){this.bindScale.z=t}set rotationX(t){this._rotationX=t,this.applyRotation()}set rotationY(t){this._rotationY=t,this.applyRotation()}set rotationZ(t){this._rotationZ=t,this.applyRotation()}applyRotation(){this.bindMatrix.identity(),this.bindMatrix.appendRotation(this._rotationX,b.X_AXIS),this.bindMatrix.appendRotation(this._rotationY,b.Y_AXIS),this.bindMatrix.appendRotation(this._rotationZ,b.Z_AXIS),this.bindMatrix.copyTo(this.invertBindMatrix),this.invertBindMatrix.invert(),this.invertBindMatrix.isIdentity=!1}setGroup(t,e,i){this._isInGroup=!0,this._groupPos=t,this._groupRotation=e,this._groupScale=i,this.groupMatrix.isIdentity=!1,this.groupMatrix.identity(),this.groupMatrix.appendScale(i.x,i.y,i.z),this.groupMatrix.appendRotation(e.x,b.X_AXIS),this.groupMatrix.appendRotation(e.y,b.Y_AXIS),this.groupMatrix.appendRotation(e.z,b.Z_AXIS),this.groupMatrix.appendTranslation(t.x,t.y,t.z),this.groupRotationMatrix.isIdentity=!1,this.groupRotationMatrix.identity(),this.groupRotationMatrix.prependRotation(e.z,b.Z_AXIS),this.groupRotationMatrix.prependRotation(e.y,b.Y_AXIS),this.groupRotationMatrix.prependRotation(e.x,b.X_AXIS)}setDataByte(t){t.position=0;var e=t.readInt(),i=t.readInt();this._maxTime=0,this._displayAry=new Array;for(var a=0;a<i;a++){var s=t.readInt(),r=this.getDisplay3DById(s);r.setAllByteInfo(t,e),r.setBind(this.bindVecter3d,this.bindMatrix,this.bindScale,this.invertBindMatrix,this.groupMatrix),this._displayAry.push(r),r.timeline.maxFrameNum>this._maxTime&&(this._maxTime=r.timeline.maxFrameNum)}this._maxTime*=D.frameTime}addPrticleItem(t){t.visible=!1,t.setBind(this.bindVecter3d,this.bindMatrix,this.bindScale,this.invertBindMatrix,this.groupMatrix),this._displayAry.push(t)}getDisplay3DById(t){var e=new Object;return e.particleType=t,this.getDisplay3D(e)}updateTime(t){if(this._time+=t,this._displayAry){for(var e=0;e<this._displayAry.length;e++)this._displayAry[e].updateTime(this._time);this.updateBind(),this._time>=this._maxTime&&this.dispatchEvent(new nt(nt.COMPLETE))}}updateBind(){this._bindTarget&&(this._bindTarget.getSocket(this._bindSocket,this.bindMatrix),this.bindVecter3d.setTo(this.bindMatrix.x,this.bindMatrix.y,this.bindMatrix.z),this.bindMatrix.identityPostion(),this.groupRotationMatrix.isIdentity?this.bindMatrix.invertToMatrix(this.invertBindMatrix):(this.bindMatrix.copyTo(this.invertBindMatrix),this.invertBindMatrix.prepend(this.groupRotationMatrix),this.invertBindMatrix.invert()))}reset(){this._time=0;for(var t=0;t<this._displayAry.length;t++)this._displayAry[t].reset()}update(){if(this.sceneVisible&&this._displayAry)for(var t=0;t<this._displayAry.length;t++)this._displayAry[t].update()}updateItem(t){if(!this.sceneVisible)return;if(this.hasDestory)return;let e=this._displayAry[t];e&&e.update()}get size(){return this._displayAry?this._displayAry.length:0}getDisplay3D(t){var e;switch(t.particleType){case 1:e=new Tt;break;case 18:e=new Lt;break;case 3:e=new Ft;break;case 14:e=new Et;break;case 9:e=new kt;break;case 4:e=new Nt;break;case 7:e=new Ut;break;case 8:e=new jt}return e.visible=!1,e}destory(){this.sourceData&&this.sourceData.useNum--;for(var t=0;t<this._displayAry.length;t++)this._displayAry[t].destory();this._displayAry.length=0,this._displayAry=null,this.bindMatrix=null,this.bindVecter3d=null,this.bindScale=null,this.invertBindMatrix=null,this._bindTarget=null,this._bindSocket=null,this._groupPos=null,this._groupRotation=null,this._groupScale=null,this.groupMatrix=null,this.groupRotationMatrix=null,this.hasDestory=!0}}class Xt extends wt{constructor(){super(),this.flag=0,this._caramPosVec=[0,0,0]}get followlocusdata(){return this.data}creatData(){this.data=new Zt}onCreated(){this.initBindMatrixAry()}initBindMatrixAry(){this._bindPosAry=new Array,this._gpuVc=new Float32Array(6*this.followlocusdata._fenduanshu);for(var t=0;t<=this.followlocusdata._fenduanshu;t++)this._bindPosAry.push([0,0,5*t]),this._bindPosAry.push([0,0,1])}setVa(){D.context3D.pushVa(this.data.objData.vertexBuffer)||(D.context3D.setVaOffset(0,3,this.data.objData.stride,0),D.context3D.setVaOffset(1,2,this.data.objData.stride,12)),this.setMaterialTexture(),D.context3D.drawCall(this.data.objData.indexBuffer,this.data.objData.treNum)}setVc(){this.updateMatrix(),this.updateBind(),this.data.vcmatData.set(D.viewMatrx3D.m,0),this.data.vcmatData.set(D.cam3D.cameraMatrix.m,16),this._caramPosVec[0]=D.cam3D.x,this._caramPosVec[1]=D.cam3D.y,this._caramPosVec[2]=D.cam3D.z,this.data.vcmatData.set(this._caramPosVec,32),D.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData),this.setBindPosVc(),this.setMaterialVc()}setBindPosVc(){for(var t=0;t<this._bindPosAry.length;t++)D.context3D.setVc3fv(this.data.materialParam.shader,"bindpos["+t+"]",this._bindPosAry[t])}reset(){this.resetPos(),super.reset()}updateMatrix(){this.modelMatrix.identity(),this.modelMatrix.prepend(this.posMatrix)}resetPos(){for(var t=0;t<this._bindPosAry.length;t+=2)this._bindPosAry[t][0]=this.bindVecter3d.x,this._bindPosAry[t][1]=this.bindVecter3d.y,this._bindPosAry[t][2]=this.bindVecter3d.z;this.flag=T.getTimer()}updateBind(){var t=T.getTimer();if(t-this.flag>=Xt.waitCdTime){var e=this._bindPosAry.pop(),i=this._bindPosAry.pop();i[0]=this.bindVecter3d.x,i[1]=this.bindVecter3d.y,i[2]=this.bindVecter3d.z;var a=this._bindPosAry[0],s=this._bindPosAry[1],r=new b(i[0]-a[0],i[1]-a[1],i[2]-a[2]);r.normalize(),s[0]=r.x,e[0]=r.x,s[1]=r.y,e[1]=r.y,s[2]=r.z,e[2]=r.z,this._bindPosAry.unshift(e),this._bindPosAry.unshift(i),this.flag=t}}}Xt.waitCdTime=35;class Yt extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2TexCoord")}getMat4Str(t){return"vcmat["+Yt.shader_mat4[t]+"]"}getVec4Str(t){return"vcmat["+Yt.shader_vec4[t][0]+"]["+Yt.shader_vec4[t][1]+"]"}static getVcSize(){return 3}getVertexShaderString(){return"attribute vec3 v3Position;\nattribute vec2 v2TexCoord;\nuniform mat4 vcmat["+At.getVcSize()+"];\nuniform vec3 bindpos[30];\nvarying vec2 v0;\n"+"void main(){\n"+("   vec3 cpos = bindpos[int(v3Position.x)];\n   vec3 mulPos = normalize(vec3("+this.getVec4Str("camPos")+".xyz) - cpos);\n   vec3 normals = bindpos[int(v3Position.y)];\n   mulPos = cross(mulPos, normals);\n   mulPos = normalize(mulPos);\n   mulPos *= v3Position.z;\n   cpos += mulPos;\n   gl_Position = "+this.getMat4Str("viewMatrix3D")+"  * "+this.getMat4Str("camMatrix3D")+" * vec4(cpos,1.0);\n")+"v0 = v2TexCoord;\n}"}getFragmentShaderString(){return" precision mediump float;\nuniform sampler2D tex;\nvarying vec2 v0;\nvoid main(void)\n{\nvec4 infoUv = texture2D(tex, v0.xy);\ngl_FragColor = infoUv;\n}"}}Yt.Display3D_FollowLocus_Shader="Display3DFollowLocusShader",Yt.shader_mat4={viewMatrix3D:0,camMatrix3D:1},Yt.shader_vec4={camPos:[2,0]};class Zt extends bt{getParticle(){return new Xt}setAllByteInfo(t){this._fenduanshu=t.readFloat(),super.setAllByteInfo(t),this.uploadGpu(),this.initVcData()}uploadGpu(){this.objData=new $,this.objData.vertices=new Array,this.objData.uvs=new Array,this.objData.indexs=new Array;for(var t=0;t<=this._fenduanshu;t++){var e=new _(t/this._fenduanshu,0),i=new _(t/this._fenduanshu,1);e.scaleBy(.9),i.scaleBy(.9),this._isU&&(e.x=-e.x,i.x=-i.x),this._isV&&(e.y=-e.y,i.y=-i.y);var a=2*t;this.objData.vertices.push(a,a+1,-this._originWidthScale*this._width/100),this._isUV?this.objData.vertices.push(e.y,e.x):this.objData.vertices.push(e.x,e.y),this.objData.vertices.push(a,a+1,(1-this._originWidthScale)*this._width/100),this._isUV?this.objData.vertices.push(i.y,i.x):this.objData.vertices.push(i.x,i.y)}for(t=0;t<this._fenduanshu;t++)this.objData.indexs.push(0+2*t,1+2*t,2+2*t,1+2*t,3+2*t,2+2*t);this.pushToGpu()}pushToGpu(){this.objData.vertexBuffer=D.context3D.uploadBuff3D(this.objData.vertices),this.objData.indexBuffer=D.context3D.uploadIndexBuff3D(this.objData.indexs),this.objData.stride=20,this.objData.treNum=this.objData.indexs.length}initVcData(){this.vcmatData=new Float32Array(16*Yt.getVcSize())}regShader(){if(this.materialParam){new Yt;this.materialParam.shader=at.getInstance().getMaterialProgram(Yt.Display3D_FollowLocus_Shader,Yt,this.materialParam.material),this.materialParam.program=this.materialParam.shader.program}}}class Ht extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"pos"),t.bindAttribLocation(this.program,1,"v2uv"),t.bindAttribLocation(this.program,2,"boneWeight"),t.bindAttribLocation(this.program,3,"boneID")}getMat4Str(t){return"vcmat["+Ht.shader_mat4[t]+"]"}static getVcSize(){return 3}getVertexShaderString(){return"attribute vec3 pos;attribute vec2 v2uv;attribute vec4 boneWeight;attribute vec4 boneID;uniform vec4 boneQ[54];\nuniform vec3 boneD[54];\nuniform mat4 vcmat["+Ht.getVcSize()+"];\nvarying vec2 v0;\n"+C.getMd5M44Str()+"void main(void){v0 = v2uv;\nvec4 vt0 = getQDdata(vec3(pos.x,pos.y,pos.z));\n gl_Position = "+this.getMat4Str("viewMatrix3D")+" * "+this.getMat4Str("camMatrix3D")+" *"+this.getMat4Str("posMatrix3D")+"* vt0;}"}getFragmentShaderString(){return"precision mediump float;\nvarying vec2 v0;\nvoid main(void)\n{\ngl_FragColor = vec4(1.0,0.0,1.0,1.0);\n}"}}Ht.Display3DBoneShader="Display3DBoneShader",Ht.shader_mat4={viewMatrix3D:0,camMatrix3D:1,posMatrix3D:2};class qt extends wt{constructor(){super(),this.skipNum=0}get modeldata(){return this.data}creatData(){this.data=new ee}update(){D.context3D.setWriteDepth(!1),super.update()}setVc(){var t=M.float2int(this._time/D.frameTime/2);this.data.vcmatData.set(D.viewMatrx3D.m,0),this.data.vcmatData.set(D.cam3D.cameraMatrix.m,16),this.data.vcmatData.set(this.modelMatrix.m,32),D.context3D.setVcMatrix4fv(this.data.materialParam.shader,"vcmat",this.data.vcmatData);var e=this.modeldata.animData.boneQPAry[0],i=e[t%e.length];D.context3D.setVc4fv(this.data.materialParam.shader,"boneQ",i.quat),D.context3D.setVc3fv(this.data.materialParam.shader,"boneD",i.pos),this.setMaterialVc()}setVa(){D.context3D.pushVa(this.modeldata.meshData.vertexBuffer)||(D.context3D.setVaOffset(0,3,this.modeldata.meshData.stride,0),D.context3D.setVaOffset(1,2,this.modeldata.meshData.stride,12),D.context3D.setVaOffset(3,4,this.modeldata.meshData.stride,20),D.context3D.setVaOffset(2,4,this.modeldata.meshData.stride,36)),this.setMaterialTexture(),D.context3D.drawCall(this.modeldata.meshData.indexBuffer,this.modeldata.meshData.treNum)}}class Kt extends ${constructor(){super(...arguments),this.boneIDAry=new Array,this.boneWeightAry=new Array,this.boneNewIDAry=new Array,this.particleAry=new Array}getBindPosMatrix(){for(var t=new Array,e=new Array,i=0;i<this.bindPosAry.length;i++){var a=this.bindPosAry[i],s=new E(a[0],a[1],a[2]);s.setMd5W();var r=s.toMatrix3D();r.appendTranslation(a[3],a[4],a[5]),e.push(r.clone()),r.invert(),t.push(r)}this.bindPosMatrixAry=t,this.bindPosInvertMatrixAry=e}destory(){super.destory(),this.materialParam&&(this.materialParam.destory(),this.materialParam=null,this.materialParamData=null),this.boneIDAry.length=0,this.boneWeightAry.length=0,this.boneNewIDAry.length=0,this.boneIDAry=null,this.boneWeightAry=null,this.boneNewIDAry=null,this.boneWeightBuffer&&(D.context3D.deleteBuffer(this.boneWeightBuffer),this.boneWeightBuffer=null),this.boneIdBuffer&&(D.context3D.deleteBuffer(this.boneIdBuffer),this.boneIdBuffer=null),this.material&&this.material.clearUseNum(),this.particleAry.length=0,this.particleAry=null}}class Qt{constructor(t,e){this.url=t,this.socketName=e}}class Jt{constructor(t){this._keys=new Array,this._values=new Array;for(var e=0;t&&e<t.length;e++)this[t[e].key]=t[e].value,this._keys.push(t[e].key),this._values.push(t[e].value)}add(t,e){this[t]=e,this._keys.push(t),this._values.push(e)}has(t){return!!this[t]}remove(t){var e=this._keys.indexOf(t,0);this._keys.splice(e,1),this._values.splice(e,1),delete this[t]}keys(){return this._keys}values(){return this._values}containsKey(t){return void 0!==this[t]}toLookup(){return this}}class $t{}class te{constructor(){this.inLoop=0,this.inter=new Array,this.bounds=new Array,this.nameHeight=0,this.posAry=new Array,this.hasProcess=!1}processMesh(t){this.hasProcess||(this.makeArrBoneQPAry(t),this.hasProcess=!0)}makeArrBoneQPAry(t){this.meshBoneQPAryDic=new Jt([]);for(var e=0;e<t.meshAry.length;e++){for(var i=this.conleMatrixArr(),a=0;a<i.length;a++)for(var s=i[a],r=0;r<s.length;r++)t.meshAry[e].bindPosMatrixAry[r]&&s[r].prepend(t.meshAry[e].bindPosMatrixAry[r]);var n=this.makeFrameDualQuatFloatArray(t,i);this.meshBoneQPAryDic[t.meshAry[e].uid]=n,this.boneQPAry=n}this.matrixAry=i}getBoneQPAryByMesh(t){return this.meshBoneQPAryDic[t.uid]}conleMatrixArr(){for(var t=new Array,e=0;e<this.matrixAry.length;e++){for(var i=this.matrixAry[e],a=new Array,s=0;s<i.length;s++)a.push(i[s].clone());t.push(a)}return t}makeFrameDualQuatFloatArray(t,e){for(var i=new Array,a=new V,s=0;s<t.meshAry.length;s++){for(var r=new Array,n=t.meshAry[s].boneNewIDAry,h=0;h<e.length;h++){var o=e[h],l=new $t;l.quat=new Float32Array(4*n.length),l.pos=new Float32Array(3*n.length);for(var c=0;c<n.length;c++){var d=o[n[c]].clone(a);d.appendScale(-1,1,1);var u=new E;u.fromMatrix(d);var m=d.position;l.quat[4*c+0]=u.x,l.quat[4*c+1]=u.y,l.quat[4*c+2]=u.z,l.quat[4*c+3]=u.w,l.pos[3*c+0]=m.x,l.pos[3*c+1]=m.y,l.pos[3*c+2]=m.z}r.push(l)}i.push(r)}return i}}class ee extends bt{constructor(){super(...arguments),this.objScale=1}getParticle(){return new qt}destory(){super.destory(),this.meshData.destory(),this.animData=null}setAllByteInfo(t){this.meshData=new Kt,this.animData=new te,this.objScale=t.readFloat();var e=t.getInt(),i=new ArrayBuffer(e*=52),a=new DataView(i);se.readBytes2ArrayBuffer(t,a,3,0,13),se.readBytes2ArrayBuffer(t,a,2,3,13),se.readIntForTwoByte(t,this.meshData.indexs),se.readBytes2ArrayBuffer(t,a,4,5,13,2),se.readBytes2ArrayBuffer(t,a,4,9,13,3),this.meshData.stride=52,this.readFrameQua(t),super.setAllByteInfo(t),this.initVcData(),this.meshData.vertexBuffer=D.context3D.uploadBuff3DArrayBuffer(i),this.meshData.indexBuffer=D.context3D.uploadIndexBuff3D(this.meshData.indexs),this.meshData.treNum=this.meshData.indexs.length}initVcData(){this.vcmatData=new Float32Array(16*Ht.getVcSize())}setFloat32Mat(t,e){var i=16*Ht.shader_mat4[t];this.vcmatData.set(e,i)}readFrameQua(t){for(var e=t.readFloat(),i=t.readInt(),a=new Array,s=0;s<i;s++){var r=t.readInt(),n=new $t;n.quat=new Float32Array(4*r),n.pos=new Float32Array(3*r);for(var h=0;h<r;h++)n.quat[4*h+0]=t.readShort()/32767,n.quat[4*h+1]=t.readShort()/32767,n.quat[4*h+2]=t.readShort()/32767,n.quat[4*h+3]=t.readShort()/32767,n.pos[3*h+0]=t.readShort()/32767*e,n.pos[3*h+1]=t.readShort()/32767*e,n.pos[3*h+2]=t.readShort()/32767*e;a.push(n)}this.animData.boneQPAry=new Array,this.animData.boneQPAry.push(a)}uploadGpu(){this.uploadMesh(this.meshData)}uploadMesh(t){t.vertexBuffer=D.context3D.uploadBuff3D(t.vertices),t.uvBuffer=D.context3D.uploadBuff3D(t.uvs),t.boneIdBuffer=D.context3D.uploadBuff3D(t.boneIDAry),t.boneWeightBuffer=D.context3D.uploadBuff3D(t.boneWeightAry),t.indexBuffer=D.context3D.uploadIndexBuff3D(t.indexs),t.treNum=t.indexs.length}regShader(){this.materialParam.shader=at.getInstance().getMaterialProgram(Ht.Display3DBoneShader,Ht,this.materialParam.material),this.materialParam.program=this.materialParam.shader.program}}class ie extends L{destory(){for(var t=0;t<this.dataAry.length;t++)this.dataAry[t].destory()}getCombineParticle(){var t=new Gt;t.maxTime=this.maxTime;for(var e=0;e<this.dataAry.length;e++){var i=this.dataAry[e].creatPartilce();t.addPrticleItem(i)}return t.sourceData=this,this.useNum++,t}setDataByte(t){t.position=0;var e=t.readInt(),i=t.readInt();this.maxTime=0,this.dataAry=new Array;for(var a=0;a<i;a++){var s=t.readInt(),r=this.getParticleDataType(s);r.version=e,r.setAllByteInfo(t),this.dataAry.push(r),r.timelineData.maxFrameNum>this.maxTime&&(this.maxTime=r.timelineData.maxFrameNum)}this.maxTime*=D.frameTime}getParticleDataType(t){var e;switch(t){case 1:e=new Mt;break;case 18:e=new Rt;break;case 3:e=new Ct;break;case 14:e=new zt;break;case 9:case 4:case 7:e=new Vt;break;case 8:e=new Wt;break;case 12:e=new Zt;break;case 13:e=new ee}return e}}class ae extends j{constructor(){super(),this._time=0,this.renderDic=new Object,this._particleList=new Array}static getInstance(){return this._instance||(this._instance=new ae),this._instance}getParticleByte(t){t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt");var e=new Gt,i=t;this._dic[i]&&(e=this._dic[i].getCombineParticle());return e.url=i,e}registerUrl(t){(t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this._dic[t])&&this._dic[t].useNum++}releaseUrl(t){(t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this._dic[t])&&this._dic[t].clearUseNum()}addResByte(t,e){if(!this._dic[t]){var i=new ie;i.setDataByte(e),this._dic[t]=i}}update(){this.updateRenderDic()}setHide(){for(var t=0;t<this._particleList.length;t++)this._particleList[t].dynamic}get particleList(){return this._particleList}updateTime(){for(var t=T.getTimer(),e=t-this._time,i=0;i<this._particleList.length;i++)this._particleList[i].sceneVisible&&this._particleList[i].updateTime(e);this._time=t}addRenderDic(t){var e=t.url;this.renderDic[e]||(this.renderDic[e]=new Array),this.renderDic[e].push(t)}removeRenderDic(t){var e=t.url,i=this.renderDic[e].indexOf(t);-1!=i&&(this.renderDic[e].splice(i,1),0==this.renderDic[e].length&&delete this.renderDic[e])}updateRenderDic(){for(var t in this.renderDic){var e=this.renderDic[t];if(1==e.length)e[0].update();else for(var i=e[0].size,a=0;a<i;a++)for(var s=0;s<e.length;s++)e[s].updateItem(a)}}addParticle(t){-1==this._particleList.lastIndexOf(t)&&(this._particleList.push(t),this.addRenderDic(t))}removeParticle(t){var e=this._particleList.indexOf(t);-1!=e&&(this._particleList.splice(e,1),this.removeRenderDic(t))}gc(){super.gc()}}class se extends L{constructor(){super(...arguments),this.allImgBytes=1e7}read(t=null){this._imgFun=t;var e=this._byte.readInt();e==se.IMG_TYPE?D.supportBlob?this.readImg():this.readImgLow():e==se.OBJS_TYPE?this.readObj(this._byte):e==se.MATERIAL_TYPE?this.readMaterial():e==se.PARTICLE_TYPE?this.readParticle():e==se.ZIP_OBJS_TYPE&&this.readZipObj()}readZipObj(){var t=this._byte.readInt(),e=this._byte.buffer.slice(this._byte.position,this._byte.position+t);this._byte.position+=t;var i=M.unZip(e),a=new A(i);this.readObj(a)}readImg(){this.imgNum=this._byte.readInt(),this.imgLoadNum=0;for(var t=0;t<this.imgNum;t++){var e=D.fileRoot+this._byte.readUTF(),i=this._byte.readInt();if(-1==e.search(".jpng")){var a=this._byte.buffer.slice(this._byte.position,this._byte.position+i);this._byte.position+=i;var s=new Image;s.url=e,s.onload=t=>{this.loadImg(t.target);t.target};e.substr(e.lastIndexOf(".")+1).toLocaleLowerCase();"jpg",console.log(e+"readImgdata:image/jpg;base64,"),s.src="data:image/jpg;base64,"+G.encode(a)}else this.readJpngImg(e)}}readJpngImg(t){var e=this._byte.readInt(),i=this._byte.buffer.slice(this._byte.position,this._byte.position+e);this._byte.position+=e;var a=this._byte.readInt(),s=this._byte.buffer.slice(this._byte.position,this._byte.position+a);this._byte.position+=a;var r=new Image,n=new Image,h=0,o=e=>{if(!(++h<2)){var i=H.getInstance().getContext2D(r.width,r.height);i.drawImage(r,0,0);var a=i.getImageData(0,0,r.width,r.height);i.clearRect(0,0,r.width,r.height),i.drawImage(n,0,0);for(var s=i.getImageData(0,0,r.width,r.height),o=0;o<a.data.length;o+=4){s.data[o];a.data[o+3]=s.data[o]}this.addImg(t.replace(".jpng",".png"),a)}};r.onload=o,n.onload=o,r.src="data:image/png;base64,"+G.encode(i),n.src="data:image/png;base64,"+G.encode(s)}readImgLow(){this.imgNum=this._byte.readInt(),this.imgLoadNum=0;T.getTimer();for(var t=0,e=0;e<this.imgNum;e++){var i=D.fileRoot+this._byte.readUTF();t+=this._byte.readInt();var a=new Image;a.url=i,a.onload=t=>{this.loadImg(t.target)},a.src=i}this.allImgBytes=t}loadImg(t){K.getInstance().addRes(t.url,t),this.countImg()}addImg(t,e){K.getInstance().addRes(t,e),this.countImg()}countImg(){this.imgLoadNum++,this.imgLoadNum==this.imgNum&&(this._imgComplete=!0,this.allResCom())}readObj(t){for(var e=t.readInt(),i=0;i<e;i++){var a=D.fileRoot+t.readUTF(),s=t.readInt(),r=new A;r.length=s,t.readBytes(r,0,s);he.getInstance().loadObjCom(r.buffer,a)}this._imgFun&&this._imgFun()}readMaterial(){for(var t=this._byte.readInt(),e=(T.getTimer(),0);e<t;e++){var i=D.fileRoot+this._byte.readUTF(),a=this._byte.readInt(),s=new A;s.length=a,this._byte.readBytes(s,0,a),st.getInstance().addResByte(i,s)}}readParticle(){for(var t=this._byte.readInt(),e=(T.getTimer(),0);e<t;e++){var i=D.fileRoot+this._byte.readUTF(),a=this._byte.readInt(),s=new A;s.length=a,this._byte.readBytes(s,0,a),ae.getInstance().addResByte(i,s)}}readMaterialInfo(){var t=this._byte.readInt();if(t>0){for(var e=new Array,i=0;i<t;i++){var a=new Object;a.type=this._byte.readInt(),a.name=this._byte.readUTF(),0==a.type&&(a.url=this._byte.readUTF()),1==a.type&&(a.x=this._byte.readFloat()),2==a.type&&(a.x=this._byte.readFloat(),a.y=this._byte.readFloat()),3==a.type&&(a.x=this._byte.readFloat(),a.y=this._byte.readFloat(),a.z=this._byte.readFloat()),e.push(a)}return e}return null}static readFloatTwoByte(t,e){var i=t.readInt();if(i>0){var a=t.readFloat();e.length=0;for(var s=0;s<i;s++)e.push(t.readFloatTwoByte(a))}}static readFloatOneByte(t,e){var i=t.readInt();if(i>0)for(var a=0;a<i;a++)e.push((t.readByte()+128)/256)}static readIntForTwoByte(t,e){for(var i=t.readInt(),a=0;a<i;a++)e.push(t.readShort())}static readIntForOneByte(t,e){for(var i=t.readInt(),a=0;a<i;a++)e.push(t.readByte())}static readBytes2ArrayBuffer(t,e,i,a,s,r=0){var n=t.readInt();if(!(n<=0)){var h;0==r&&(h=t.readFloat());for(var o,l=n/i,c=0;c<l;c++)for(var d=s*c+a,u=0;u<i;u++)0==r?o=t.readFloatTwoByte(h):1==r?o=t.readFloatOneByte():2==r?o=t.readByte():3==r?o=(t.readByte()+128)/255:4==r&&(o=t.readFloat()),e&&e.setFloat32(4*(d+u),o,!0)}}static readMaterialParamData(t){var e=t.readInt();if(e>0){for(var i=new Array,a=0;a<e;a++){var s=new Object;s.name=t.readUTF(),s.type=t.readByte(),0==s.type?s.url=t.readUTF():1==s.type?s.x=t.readFloat():2==s.type?(s.x=t.readFloat(),s.y=t.readFloat()):3==s.type&&(s.x=t.readFloat(),s.y=t.readFloat(),s.z=t.readFloat()),i.push(s)}return i}return null}allResCom(){this._imgFun&&this._imgFun()}static readIntForTwoByteNew(t){for(var e=t.readInt(),i=new Uint16Array(e),a=0;a<e;a++)i[a]=t.readShort();return i}static readIndexForInt(t){for(var e=t.readInt(),i=new Uint16Array(e),a=0;a<e;a++)i[a]=t.readInt();return i}}se.IMG_TYPE=1,se.OBJS_TYPE=2,se.MATERIAL_TYPE=3,se.PARTICLE_TYPE=4,se.SCENE_TYPE=5,se.ZIP_OBJS_TYPE=6,se.PREFAB_TYPE=1,se.SCENE_PARTICLE_TYPE=11;class re extends k{constructor(t=0,e=0,i=0){super()}}class ne{}class he extends j{constructor(){super(),this._loadList=new Object}static getInstance(){return this._instance||(this._instance=new he),this._instance}getObjData(t,e){if(this._dic[t])return e(this._dic[t]),void this._dic[t].useNum++;this._loadList[t]||(this._loadList[t]=new Array,X.getInstance().load(t,X.BYTE_TYPE,e=>{this.loadObjCom(e,t)})),this._loadList[t].push(e)}registerUrl(t){this._dic[t]&&this._dic[t].useNum++}releaseUrl(t){this._dic[t]&&this._dic[t].clearUseNum()}gc(){super.gc()}readFloatNrm(t,e){var i=t.readInt();if(i>0)for(var a=0;a<i;a++)e.push(t.readFloat())}readcollisionItem(t,e){var i=t.readInt();if(i>0){e.collision=new ne,e.collision.collisionItem=new Array;for(var a=0;a<i;a++){var s=JSON.parse(t.readUTF()),r=new re;r.scaleX=s.scale_x,r.scaleY=s.scale_y,r.scaleZ=s.scale_z,r.x=s.x,r.y=s.y,r.z=s.z,r.rotationX=s.rotationX,r.rotationY=s.rotationY,r.rotationZ=s.rotationZ,r.scaleX=this.getFloadNum(r.scaleX),r.scaleY=this.getFloadNum(r.scaleY),r.scaleZ=this.getFloadNum(r.scaleZ),r.rotationX=this.getFloadNum(r.rotationX),r.rotationY=this.getFloadNum(r.rotationY),r.rotationZ=this.getFloadNum(r.rotationZ),r.type=s.type,r.data=s.data,e.collision.collisionItem.push(r)}}}getFloadNum(t){return Math.floor(1e3*t)/1e3}loadObjCom(t,e){if(!this._dic[e]){var i=new $,a=new A(t),s=a.readInt();a.readUTF();s>=20?(this.readObj2OneBuffer(a,i),s>=37&&a.position<a.length&&this.readcollisionItem(a,i)):(se.readFloatTwoByte(a,i.vertices),se.readFloatTwoByte(a,i.uvs),se.readFloatOneByte(a,i.lightuvs),se.readFloatTwoByte(a,i.normals),se.readIntForTwoByte(a,i.indexs),se.readFloatTwoByte(a,i.tangents),se.readFloatTwoByte(a,i.bitangents),i.vertexBuffer=D.context3D.uploadBuff3D(i.vertices),i.uvBuffer=D.context3D.uploadBuff3D(i.uvs),i.lightUvBuffer=D.context3D.uploadBuff3D(i.lightuvs),i.normalsBuffer=D.context3D.uploadBuff3D(i.normals)),i.treNum=i.layaIndexBuffer.indexCount,i.indexBuffer=D.context3D.uploadIndexBuff3D(i.indexs),this._dic[e]=i;var r=this._loadList[e];if(r){for(var n=0;n<r.length;n++)r[n](i);delete this._loadList[e]}return i}}readObj2OneBuffer(t,e){for(var i,s=new Array,r=(s=new Array,0),n=0;n<6;n++){var h=t.readBoolean();if(s.push(h),h)switch(n){case 1:case 2:r+=2;break;default:r+=3}}i=t.readFloat();let o=g.getVertexDeclaration("POSITION,UV",!0),l=o.vertexStride;i*=l,r=l/4;var c=new ArrayBuffer(i),d=new DataView(c),u=s[2]?7:5,m=u+3,y=m+3;se.readBytes2ArrayBuffer(t,d,3,0,r),se.readBytes2ArrayBuffer(t,d,2,3,r),se.readBytes2ArrayBuffer(t,null,2,5,r,1),se.readBytes2ArrayBuffer(t,null,3,u,r),se.readBytes2ArrayBuffer(t,null,3,m,r),se.readBytes2ArrayBuffer(t,null,3,y,r);let x=se.readIntForTwoByteNew(t);e.compressBuffer=!0,e.uvsOffsets=12,e.lightuvsOffsets=20,e.normalsOffsets=4*u,e.tangentsOffsets=4*m,e.bitangentsOffsets=4*y,e.stride=4*r;let v=new p(c.byteLength,WebGLRenderingContext.STATIC_DRAW,!0);v.vertexDeclaration=o,v.setData(c),e.layaVertexBuffer=v;var _=new a(e.indexFormat,x.length,WebGLRenderingContext.STATIC_DRAW,!1);_.setData(x),e.layaIndexBuffer=_,e._setBuffer(v,_)}creatTBNBuffer(t){t.tangentBuffer=D.context3D.uploadBuff3D(t.tangents),t.bitangentBuffer=D.context3D.uploadBuff3D(t.bitangents)}}class oe extends B{constructor(){super(),this.name="Material_shader"}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2CubeTexST");var e=this.paramAry[0],i=this.paramAry[1],a=(this.paramAry[4],this.paramAry[5]),s=this.paramAry[6];a||s||t.bindAttribLocation(this.program,2,"v2lightuv"),e?(t.bindAttribLocation(this.program,3,"v3Normal"),i&&(t.bindAttribLocation(this.program,4,"v3Tangent"),t.bindAttribLocation(this.program,5,"v3Bitangent"))):a&&t.bindAttribLocation(this.program,3,"v3Normal")}getVertexShaderString(){var t=this.paramAry[0],e=this.paramAry[1],i=(this.paramAry[2],this.paramAry[3],this.paramAry[4],this.paramAry[5]),a=this.paramAry[6],s=this.paramAry[7],r="attribute vec3 v3Position;\nattribute vec2 v2CubeTexST;\nvarying vec2 v0;\n";return i?r+="varying vec3 v2;\n":a||(r+="attribute vec2 v2lightuv;\nvarying vec2 v2;\n"),t?(r+="attribute vec3 v3Normal;\nvarying vec3 v1;\n",r+=e?"varying mat3 v4;\n":"varying vec3 v4;\n"):0!=s&&(r+="varying vec3 v1;\n"),e&&(r+="attribute vec3 v3Tangent;\nattribute vec3 v3Bitangent;\n"),i&&(t||(r+="attribute vec3 v3Normal;\n"),r+="uniform vec3 sunDirect;\nuniform vec3 sunColor;\nuniform vec3 ambientColor;\n"),r+="uniform mat4 vpMatrix3D;\nuniform mat4 posMatrix3D;\nuniform mat3 rotationMatrix3D;\n",r+="void main(void){\nv0 = vec2(v2CubeTexST.x, v2CubeTexST.y);\nvec4 vt0= vec4(v3Position, 1.0);\nvt0 = posMatrix3D * vt0;\n",i||a||(r+="v2 = vec2(v2lightuv.x, v2lightuv.y);\n"),(t||0!=s)&&(r+="v1 = vec3(vt0.x,vt0.y,vt0.z);\n"),r+="vt0 = vpMatrix3D * vt0;\n",t&&(r+=e?"v4 = mat3(rotationMatrix3D * v3Tangent,rotationMatrix3D * v3Bitangent, rotationMatrix3D * v3Normal);\n":"v4 = rotationMatrix3D * v3Normal;\n"),i&&(r+=t?"float suncos = dot(v4.xyz,sunDirect.xyz);\n":"vec3 n = rotationMatrix3D * v3Normal;\nfloat suncos = dot(n.xyz,sunDirect.xyz);\n",r+="suncos = clamp(suncos,0.0,1.0);\nv2 = sunColor * suncos + ambientColor;"),r+="gl_Position = vt0;}"}outstr(t){for(var e=t.split(";"),i=0;i<e.length;i++)String(M.trim(e[i]))}getFragmentShaderString(){return"uniform sampler2D s_texture1;\nuniform vec4 testconst;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz = testconst.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}"}}oe.MATERIAL_SHADER="Material_shader";class le extends U{constructor(){super(),this.time=0,this.dynamic=!1,this._rotationMatrix=new V}get aabbVect(){if(!this._aabbVect){var t=this.aabb,e=t.x,i=t.y,a=t.z,s=t.width,r=t.height,n=t.depth;this._aabbVect=new Array,this._aabbVect.push(new b(e,i,a)),this._aabbVect.push(new b(e+s,i,a)),this._aabbVect.push(new b(e,i+r,a)),this._aabbVect.push(new b(e,i,a+n)),this._aabbVect.push(new b(e+s,i+r,a)),this._aabbVect.push(new b(e+s,i,a+n)),this._aabbVect.push(new b(e,i+r,a+n)),this._aabbVect.push(new b(e+s,i+r,a+n))}return this._aabbVect}setObjUrl(t){this.objurl=t,he.getInstance().getObjData(D.fileRoot+t,t=>{this.objData=t,this.material&&(this.objData.tangentBuffer||he.getInstance().creatTBNBuffer(this.objData))})}setPicUrl(t){this.picUrl=t,K.getInstance().getTexture(D.fileRoot+t,t=>{this.baseTexture=t})}setLightMapUrl(t){if(t&&""!=t){var e=D.fileRoot+t;K.getInstance().getTexture(e,t=>{this.lightMapTextureRes=t})}}get lightMapTexture(){return this.lightMapTextureRes,this.lightMapTextureRes.texture}setMaterialUrl(t,e=null){t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),this.materialUrl=D.fileRoot+t,st.getInstance().getMaterialByte(this.materialUrl,t=>{this.material=t,this.material.useNormal&&this.objData&&!this.objData.tangentBuffer&&he.getInstance().creatTBNBuffer(this.objData),(this.material.usePbr||this.material.directLight)&&(this._rotationData=new Float32Array(9),this.updateRotationMatrix()),e&&(this.materialParam=new J,this.materialParam.setData(this.material,e))},null,!0,oe.MATERIAL_SHADER,oe)}get lightProbe(){return this._lightProbe}set lightProbe(t){if(this._lightProbe=t,this._lightProbe&&!this.resultSHVec){this.resultSHVec=new Array;for(var e=[.4444730390920146,-.3834955622240026,-.33124467509627725,.09365654209093091,-.05673310882817577,.2120523322966496,.02945768486978205,-.04965996229802928,-.1136529129285836],i=0;i<9;i++)this.resultSHVec.push(new b(e[i],e[i],e[i]))}}update(){this.dynamic&&!this.sceneVisible||this.updateMaterial()}updateMaterial(){this.material&&this.objData&&(D.context3D.setBlendParticleFactors(this.material.blendMode),D.context3D.cullFaceBack(this.material.backCull),this.updateBind(),D.context3D.setProgram(this.material.program),D.context3D.setWriteDepth(this.material.writeZbuffer),D.context3D.setVcMatrix4fv(this.material.shader,"posMatrix3D",this.posMatrix.m),this.setCam(),this.setMaterialVc(this.material,this.materialParam),this.setMaterialTexture(this.material,this.materialParam),this.setDirectLight(this.material),this.setMaterialVa(),D.context3D.drawCallL3d(this.objData.treNum),this.objData._bufferState.unBind())}renderShadow(){if(this.bindTarget&&this.bindTarget.getIsShadow()){let t=this.material.program,e=this.material.shader;this.material.shader=F.getInst(),this.material.program=F.getInst().program,D.context3D.setProgram(this.material.program),D.context3D.setVcMatrix4fv(this.material.shader,"uMProjCameraMatrix",new Float32Array(D.vpMatrix.m)),this.updateBind(),D.context3D.setVcMatrix4fv(this.material.shader,"uMMatrix",this.posMatrix.m),D.context3D.setVc3fv(this.material.shader,"uLightLocation",F.getLightPosArry(this.posMatrix)),this.setMaterialVa(),D.context3D.drawCallL3d(this.objData.treNum),this.objData._bufferState.unBind(),this.material.shader=e,this.material.program=t}}setMaterialVa(){this.objData.compressBuffer?this.setMaterialVaCompress():this.setMaterialVaIndependent()}setMaterialVaIndependent(){D.context3D.setVa(0,3,this.objData.vertexBuffer),D.context3D.setVa(1,2,this.objData.uvBuffer),this.material.directLight||this.material.noLight||D.context3D.setVa(2,2,this.objData.lightUvBuffer),(this.material.usePbr||this.material.directLight)&&(D.context3D.setVa(3,3,this.objData.normalsBuffer),D.context3D.setVcMatrix3fv(this.material.shader,"rotationMatrix3D",this._rotationData)),this.material.useNormal&&(D.context3D.setVa(4,3,this.objData.tangentBuffer),D.context3D.setVa(5,3,this.objData.bitangentBuffer))}setMaterialVaCompress(){this.objData._bufferState.bind()}setDirectLight(t){t.directLight&&(D.context3D.setVc3fv(t.shader,"ambientColor",D.light.ambientColor),D.context3D.setVc3fv(t.shader,"sunDirect",D.light.sunDirect),D.context3D.setVc3fv(t.shader,"sunColor",D.light.sunColor))}setCam(){D.context3D.setVpMatrix(this.material.shader,D.vpMatrix.m)}setBind(t,e){this.bindTarget=t,this.bindSocket=e,this.bindMatrix=new V}setGroup(t,e,i){this._isInGroup=!0,this._groupPos=t,this._groupRotation=e,this._groupScale=i,this.groupMatrix=new V,this.groupRotationMatrix=new V,this.groupMatrix.isIdentity=!1,this.groupMatrix.identity(),this.groupMatrix.appendScale(i.x,i.y,i.z),this.groupMatrix.appendRotation(e.x,b.X_AXIS),this.groupMatrix.appendRotation(e.y,b.Y_AXIS),this.groupMatrix.appendRotation(e.z,b.Z_AXIS),this.groupMatrix.appendTranslation(t.x,t.y,t.z),this.groupRotationMatrix.isIdentity=!1,this.groupRotationMatrix.identity(),this.groupRotationMatrix.prependRotation(e.z,b.Z_AXIS),this.groupRotationMatrix.prependRotation(e.y,b.Y_AXIS),this.groupRotationMatrix.prependRotation(e.x,b.X_AXIS)}updateBind(){this.bindTarget&&(this.posMatrix.identity(),this.posMatrix.appendScale(this._scaleX*He.scaleWorld.x,this._scaleY*He.scaleWorld.y,this._scaleZ*He.scaleWorld.z),this._isInGroup&&this.posMatrix.append(this.groupMatrix),this.bindTarget.getSocket(this.bindSocket,this.bindMatrix),this._x=this.bindMatrix.x,this._y=this.bindMatrix.y,this._z=this.bindMatrix.z,this.bindMatrix.identityPostion(),this.posMatrix.append(this.bindMatrix),this.posMatrix.appendTranslation(this._x*He.scaleWorld.x,this._y*He.scaleWorld.y,this._z*He.scaleWorld.z),this.bindMatrix.copyTo(this._rotationMatrix),this._rotationMatrix.identityPostion(),this._isInGroup&&this._rotationMatrix.prepend(this.groupRotationMatrix),this.sceneVisible=this.bindTarget.visible)}setBaseMaterialVc(t){var e=0;t.hasTime&&(e=(T.getTimer()-this.time)%1e5*.001),(t.hasTime||t.usePbr||t.useKill)&&D.context3D.setVc4fv(t.shader,"fc0",[1,0,t.killNum,e]),t.scaleLightMap&&D.context3D.setVcFloat(t.shader,"scalelight",D.scaleLight),(t.usePbr||1==t.fogMode)&&this.setCamPos(t),0!=t.fogMode&&(D.context3D.setVc2fv(t.shader,"fogdata",D.fogData),D.context3D.setVc3fv(t.shader,"fogcolor",D.fogColor))}setCamPos(t){t.updateCam(D.cam3D.x/100,D.cam3D.y/100,D.cam3D.z/100)}setMaterialVc(t,e=null){if(!(t.fcNum<=0)){var i=0;t.hasTime&&(i=(T.getTimer()-this.time)%1e5*.001),t.update(i),this.setCamPos(t),e&&e.update(),D.context3D.setVc4fv(t.shader,"fc",t.fcData)}}setMaterialTexture(t,e=null){var i=t.texList;if(i){for(var a=0;a<i.length;a++)if(i[a].type==tt.LIGHTMAP)D.context3D.setRenderTexture(t.shader,i[a].name,this.lightMapTexture,i[a].id);else if(i[a].type==tt.LTUMAP&&D.pubLut)D.context3D.setRenderTexture(t.shader,i[a].name,D.pubLut,i[a].id);else if(i[a].type==tt.CUBEMAP)if(t.useDynamicIBL);else{var s=Math.floor(5*t.roughness);if(D.skyCubeMap){var r=D.skyCubeMap[s];D.context3D.setRenderTextureCube(t.program,i[a].name,r,i[a].id)}}else i[a].texture&&D.context3D.setRenderTexture(t.shader,i[a].name,i[a].texture,i[a].id);if(e)for(a=0;a<e.dynamicTexList.length;a++)e.dynamicTexList[a].target&&D.context3D.setRenderTexture(t.shader,e.dynamicTexList[a].target.name,e.dynamicTexList[a].texture,e.dynamicTexList[a].target.id)}}checkMaterialTexture(t){for(var e=t.texList,i=0;i<e.length;i++)if(e[i].type==tt.LIGHTMAP){if(!this.lightMapTexture)return!1}else if(e[i].type==tt.LTUMAP){if(!D.pubLut)return!1}else if(e[i].type==tt.CUBEMAP){if(t.useDynamicIBL);else if(!D.skyCubeMap)return!1}else if(!e[i].texture)return!1;return!0}updateRotationMatrix(){try{this._rotationMatrix.identity(),this._rotationMatrix.appendRotation(this._rotationX,b.X_AXIS),this._rotationMatrix.appendRotation(this._rotationY,b.Y_AXIS),this._rotationMatrix.appendRotation(this._rotationZ,b.Z_AXIS),this._rotationData&&this._rotationMatrix.getRotaion(this._rotationData)}catch(t){}}setPos(t){this.x=t.x,this.y=t.y+10,this.z=t.z}destory(){super.destory(),this.name=null,this.objurl=null,this.picUrl=null,this.materialUrl=null,this.material&&this.material.useNum--,this.materialParam&&(this.materialParam.destory(),this.materialParam=null),this.lightMapTextureRes&&this.lightMapTextureRes.clearUseNum(),this._rotationMatrix=null,this._rotationData=null,this.bindMatrix=null,this.bindTarget=null,this.bindSocket=null,this._groupPos=null,this._groupRotation=null,this._groupScale=null,this.groupMatrix=null,this.groupRotationMatrix=null}}class ce{constructor(t,e){this.width=t,this.height=e;var i=H.getInstance().getContext2D(this.width,this.height,!1);this.imgData=i.getImageData(0,0,this.width,this.height);for(var a=0;a<this.imgData.data.length;a+=4)this.imgData.data[a+0]=255,this.imgData.data[a+1]=255,this.imgData.data[a+2]=255,this.imgData.data[a+3]=255}getIndexByPos(t,e){return 4*(e*this.width+t)}setRgb(t,e,i){t=Math.round(t),e=Math.round(e);var a=this.getIndexByPos(t,e);this.imgData.data[a+0]=255*i.x,this.imgData.data[a+1]=255*i.y,this.imgData.data[a+2]=255*i.z,this.imgData.data[a+3]=255}getRgb(t,e){t=Math.round(t),e=Math.round(e);var i=new b,a=this.getIndexByPos(t,e);return i.x=this.imgData.data[a+0]/255,i.y=this.imgData.data[a+1]/255,i.z=this.imgData.data[a+2]/255,i.w=1,i}}class de{constructor(t=0,e=0,i=1,a=1){this.x=0,this.y=0,this.width=0,this.height=1,this.x=t,this.y=e,this.width=i,this.height=a}sets(t,e,i,a){this.x=t,this.y=e,this.width=i,this.height=a}setRec(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height}isHitByPoint(t,e){return t>=this.x&&e>=this.y&&t<=this.x+this.width&&e<=this.y+this.height}}class ue extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2TexCoord")}getVertexShaderString(){return"attribute vec3 v3Position;attribute vec2 v2TexCoord;\nuniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec2 v0;\nvoid main(void){ v0 = v2TexCoord;   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"}getFragmentShaderString(){return"precision mediump float;uniform sampler2D idmaptexture;uniform sampler2D infotexture;uniform sampler2D sixtexture;uniform sampler2D lightexture;vec4 qdvNrm(float indx ,vec2 uvpos){vec2 sixuvTx=uvpos; float ccavid= floor(indx*255.0);if (ccavid==0.0) {\n} else  if (ccavid==1.0){\nsixuvTx.x=sixuvTx.x+0.5;} else  if (ccavid==2.0){sixuvTx.y=sixuvTx.y+0.5;}else{sixuvTx.x=sixuvTx.x+0.5;sixuvTx.y=sixuvTx.y+0.5;}; sixuvTx.x=sixuvTx.x+0.001;sixuvTx.y=sixuvTx.y+0.001;vec4 sixUvColor = texture2D(sixtexture, sixuvTx.xy);\nreturn  sixUvColor;\n }\nvarying vec2 v0;void main(void){vec4 idUv = texture2D(idmaptexture, v0.xy);\nvec4 infoUv = texture2D(infotexture, v0.xy);\nvec4 sixUv = texture2D(sixtexture, v0.xy);\nvec4 lightUv = texture2D(lightexture, v0*0.995+0.0025);\nvec2 sixuv=fract(v0*10.0);  sixuv=sixuv*0.498; vec4 tempnumA = qdvNrm(idUv.x,sixuv) * infoUv.x;\nvec4 tempnumB = qdvNrm(idUv.y,sixuv) * infoUv.y;\nvec4 tempnumC = qdvNrm(idUv.z,sixuv) * infoUv.z;\nvec4 tempnumD = tempnumA+tempnumB+tempnumC;\n tempnumD.xyz=tempnumD.xyz*lightUv.xyz*2.0; gl_FragColor = tempnumD;}"}}ue.TerrainDisplay3DShader="TerrainDisplay3DShader";class me{mekeUseTexture(t){var e=new de(0,0,Math.pow(2,Math.ceil(Math.log(t.width)/Math.log(2))),Math.pow(2,Math.ceil(Math.log(t.height)/Math.log(2))));if(e.width!=t.width||e.height!=t.height){for(var i=new ce(e.width,e.height),a=0;a<i.width;a++)for(var s=0;s<i.height;s++){var r=t.getRgb(a/i.width*t.width,s/i.height*t.height);i.setRgb(a,s,r)}return i}return t}calibration(){this.idBitmap=this.mekeUseTexture(this.idBitmap),this.infoBitmap=this.mekeUseTexture(this.infoBitmap)}static meshAllgroundData(t){for(var e=t.readInt(),i=t.readInt(),a=new Array,s=0;s<e;s++)for(var r=0;r<i;r++){var n=t.readInt(),h=t.readInt(),o=t.readInt(),l=t.readInt(),c=new me;c.idBitmap=new ce(o,l),c.infoBitmap=new ce(o,l),c.tx=n,c.ty=h,a.push(c);for(var d=0;d<o;d++)for(var u=0;u<l;u++){var m;switch(t.readByte()){case 0:m=new b(0,1,2);break;case 1:m=new b(0,1,3);break;case 2:m=new b(0,2,3);break;case 3:m=new b(1,2,3);break;default:throw new Error("信息索引没有编入")}c.idBitmap.setRgb(d,u,new b(m.x/255,m.y/255,m.z/255,1));var p=new b;p.x=t.readByte()+128,p.y=t.readByte()+128,p.z=255-p.x-p.y,c.infoBitmap.setRgb(d,u,new b(p.x/255,p.y/255,p.z/255,1))}c.calibration()}for(var y=t.readUTF(),x=0;x<a.length;x++)a[x].sixurl=y;return a}}class pe extends le{constructor(){super(),at.getInstance().registe(ue.TerrainDisplay3DShader,new ue),this.groundShader=at.getInstance().getProgram(ue.TerrainDisplay3DShader)}update(){this.groundShader&&this.baseSixteenRes&&this.idMapPicDataTexture?this.upDataToDraw():super.update()}upDataToDraw(){this.groundShader&&this.baseSixteenRes&&(D.context3D.cullFaceBack(!1),D.context3D.setProgram(this.groundShader.program),D.context3D.setVcMatrix4fv(this.groundShader,"viewMatrix3D",D.viewMatrx3D.m),D.context3D.setVcMatrix4fv(this.groundShader,"camMatrix3D",D.cam3D.cameraMatrix.m),D.context3D.setVcMatrix4fv(this.groundShader,"posMatrix3D",this.posMatrix.m),D.context3D.setVc4fv(this.groundShader,"colorData",[1,0,1,1]),D.context3D.pushVa(this.objData.vertexBuffer)||(D.context3D.setVaOffset(0,3,this.objData.stride,0),D.context3D.setVaOffset(1,2,this.objData.stride,this.objData.uvsOffsets)),D.context3D.setRenderTexture(this.groundShader,"idmaptexture",this.idMapPicDataTexture,0),D.context3D.setRenderTexture(this.groundShader,"infotexture",this.infoMapPicDataTexture,1),D.context3D.setRenderTexture(this.groundShader,"sixtexture",this.baseSixteenRes.texture,2),D.context3D.setRenderTexture(this.groundShader,"lightexture",this.lightMapTexture,3),D.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum))}setGrounDataMesh(t){this.idMapPicDataTexture=D.context3D.getTexture(t.idBitmap.imgData,0,1),this.infoMapPicDataTexture=D.context3D.getTexture(t.infoBitmap.imgData,0,1);var e=t.sixurl;K.getInstance().getTexture(D.fileRoot+e,t=>{this.baseSixteenRes=t})}}class ye{constructor(){this._dic=new Object}static getInstance(){return this._instance||(this._instance=new ye),this._instance}getAnimData(t,e){this._dic[t]?e(this._dic[t]):X.getInstance().load(t,X.BYTE_TYPE,(e,i)=>{i(this.readData(new A(e),t))},e)}getAnimDataImmediate(t){return this._dic[t]}clearAnim(t){delete this._dic[t]}readData(t,e){var i=new Array,a=new Array,s=new te;s.inLoop=t.readInt();for(var r=t.readInt(),n=0;n<r;n++)s.inter.push(t.readInt());r=t.readInt();for(n=0;n<r;n++)s.bounds.push(t.readVector3D());s.nameHeight=t.readInt(),r=t.readInt();for(n=0;n<r;n++){var h=new ve;h.father=t.readInt(),h.changtype=t.readInt(),h.startIndex=t.readInt(),h.tx=t.readFloat(),h.ty=t.readFloat(),h.tz=t.readFloat(),h.qx=t.readFloat(),h.qy=t.readFloat(),h.qz=t.readFloat(),i.push(h)}this.readFrameData(t,a),r=t.readInt();for(n=0;n<r;n++)s.posAry.push(t.readVector3D());return s.matrixAry=this.processFrame(a,i),this._dic[e]=s,s}readFrameData(t,e){for(var i=this.readFrameTypeData(t),a=t.readBoolean(),s=t.readFloat(),r=t.readInt(),n=0;n<r;n++){var h=t.readInt(),o=new Array;e.push(o);for(var l=0;l<h;l++)i[l]?o.push(t.readFloatTwoByte(s)):a?o.push(t.readFloat()):o.push(t.readShort()/32767)}}readFrameTypeData(t){for(var e=new Array,i=t.readInt(),a=0;a<i;a++)e.push(t.readBoolean());return e}processFrame(t,e){for(var i=new Array,a=0;a<t.length;a++)i.push(this.frameToBone(t[a],e));return this.setFrameToMatrix(i)}frameToBone(t,e){for(var i=new Array,a=0;a<e.length;a++){var s=new xe;s.father=e[a].father;var r=0;1&e[a].changtype?(s.tx=t[e[a].startIndex+r],++r):s.tx=e[a].tx,2&e[a].changtype?(s.ty=t[e[a].startIndex+r],++r):s.ty=e[a].ty,4&e[a].changtype?(s.tz=t[e[a].startIndex+r],++r):s.tz=e[a].tz,8&e[a].changtype?(s.qx=t[e[a].startIndex+r],++r):s.qx=e[a].qx,16&e[a].changtype?(s.qy=t[e[a].startIndex+r],++r):s.qy=e[a].qy,32&e[a].changtype?(s.qz=t[e[a].startIndex+r],++r):s.qz=e[a].qz,i.push(s)}return i}setFrameToMatrix(t){for(var e=new Array,i=0;i<t.length;i++){var a=t[i],s=new E,r=new V,n=new Array;e.push(n);for(var h=0;h<a.length;h++){var o=a[h];if((s=new E(o.qx,o.qy,o.qz)).w=this.getW(s.x,s.y,s.z),-1==o.father)(r=s.toMatrix3D()).appendTranslation(o.tx,o.ty,o.tz),r.appendRotation(-90,b.X_AXIS),n.push(r);else{a[o.father];(r=s.toMatrix3D()).appendTranslation(o.tx,o.ty,o.tz),r.append(n[o.father]),n.push(r)}}for(h=0;h<n.length;h++)n[h].appendScale(-1,1,1)}return e}getW(t,e,i){var a=1-(t*t+e*e+i*i);return a=a<0?0:-Math.sqrt(a)}}class xe{}class ve extends xe{clone(){var t=new ve;return t.tx=this.tx,t.ty=this.ty,t.tz=this.tz,t.tw=this.tw,t.qx=this.qx,t.qy=this.qy,t.qz=this.qz,t.qw=this.qw,t.changtype=this.changtype,t.name=this.name,t.father=this.father,t.startIndex=this.startIndex,t.matrix=this.matrix,t}}class ge extends L{constructor(){super(...arguments),this.meshAry=new Array,this.fileScale=1,this.tittleHeight=0,this.hitBox=new _(0,0),this.type=0,this.animDic=new Object,this.ready=!1,this.hasDestory=!1}makeHitBoxItem(){this.hitPosItem=new Array;var t=this.hitBox.x,e=this.hitBox.y,i=new b(-t,0,-t),a=new b(t,0,-t),s=new b(t,0,t),r=new b(-t,0,t);this.hitPosItem.push(i),this.hitPosItem.push(a),this.hitPosItem.push(s),this.hitPosItem.push(r);var n=new b(-t,e,-t),h=new b(t,e,-t),o=new b(t,e,t),l=new b(-t,e,t);this.hitPosItem.push(n),this.hitPosItem.push(h),this.hitPosItem.push(o),this.hitPosItem.push(l)}addMesh(t){t.uid=this.meshAry.length,this.meshAry.push(t)}loadParticle(){}loadMaterial(t=null){for(var e=0;e<this.meshAry.length;e++)this.loadByteMeshDataMaterial(this.meshAry[e],t)}loadByteMeshDataMaterial(t,e=null){var i=D.fileRoot+t.materialUrl;i=(i=i.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),st.getInstance().getMaterialByte(i,i=>{t.material=i,t.materialParamData&&(t.materialParam=new J,t.materialParam.setData(t.material,t.materialParamData)),e&&e(i)},null,!0,C.MATERIAL_ANIM_SHADER,C)}setAction(t,e){this.animUrlAry=new Array;for(var i=0;i<t.length;i++){var a=t[i],s=e+t[i],r=ye.getInstance().getAnimDataImmediate(s);r.processMesh(this),this.animDic[a]=r,this.animUrlAry.push(s)}}destory(){if(this.allParticleDic){for(var t in this.allParticleDic)ae.getInstance().releaseUrl(t);this.allParticleDic=null}for(var e=0;e<this.meshAry.length;e++)this.meshAry[e].destory();if(this.meshAry.length=0,this.meshAry=null,this.boneSocketDic=null,this.animUrlAry){for(e=0;e<this.animUrlAry.length;e++)ye.getInstance().clearAnim(this.animUrlAry[e]);this.animUrlAry.length=0,this.animUrlAry=null}for(var t in this.animDic)delete this.animDic[t];this.animDic=null,this.hasDestory=!0}}class _e{clone(){var t=new _e;return t.name=this.name+_e.cloneIDIndex,t.boneName=this.boneName,t.index=this.index,t.x=this.x,t.y=this.y,t.z=this.z,t.rotationX=this.rotationX,t.rotationY=this.rotationY,t.rotationZ=this.rotationZ,t}}_e.cloneIDIndex=0;class fe extends j{constructor(){super(),this._loadDic=new Object}static getInstance(){return this._instance||(this._instance=new fe),this._instance}getMeshData(t,e,i=1){if(this._dic[t]&&this._dic[t].ready)return e(this._dic[t]),void this._dic[t].useNum++;let a;if(this._loadDic[t])return a=this._loadDic[t],void a.push(e);a=this._loadDic[t]=[],a.push(e),Be.getInstance().loadRoleRes(D.fileRoot+t,t=>{this.roleResCom(t,e)},i)}roleResCom(t,e){var i=t.roleUrl,a=this._dic[i];a.loadMaterial(),a.setAction(t.actionAry,i),a.url=i,t.ambientLightColor&&(a.lightData=[[t.ambientLightColor.x,t.ambientLightColor.y,t.ambientLightColor.z],[t.nrmDircet.x,t.nrmDircet.y,t.nrmDircet.z],[t.sunLigthColor.x,t.sunLigthColor.y,t.sunLigthColor.z]]);var s=this._loadDic[i];console.assert(null!=s,"找不到定义");for(var r=0;r<s.length;r++)s[r](a),a.useNum++;delete this._loadDic[i],a.ready=!0}gc(){super.gc()}readData(t,e,i,a){var s=new ge;s.fileScale=t.readFloat(),s.tittleHeight=a>=19?t.readFloat():50,s.hitBox=new _(20,20),a>=23&&(s.hitBox.x=t.readFloat(),s.hitBox.y=t.readFloat()),s.makeHitBoxItem();for(var r=t.readInt(),n=new Object,h=0;h<r;h++){var o=new Kt;o.bindPosAry=this.readBindPosByte(t),o.getBindPosMatrix(),this.readMesh2OneBuffer(t,o),o.treNum=o.layaIndexBuffer.indexCount,o.materialUrl=t.readUTF(),o.materialParamData=se.readMaterialParamData(t);for(var l=t.readInt(),c=0;c<l;c++){var d=new Qt(t.readUTF(),t.readUTF());o.particleAry.push(d),n[d.url]=!0}s.addMesh(o)}for(var u in n)ae.getInstance().registerUrl(u);if(s.allParticleDic=n,a<35)for(var m=this.readBindPosByte(t),p=0;p<s.meshAry.length;p++)s.meshAry[p].bindPosAry=m,s.meshAry[p].getBindPosMatrix();var y=t.readInt();s.boneSocketDic=new Object;for(c=0;c<y;c++){var x=new _e;x.name=t.readUTF(),x.boneName=t.readUTF(),x.index=t.readInt(),x.x=t.readFloat(),x.y=t.readFloat(),x.z=t.readFloat(),x.rotationX=t.readFloat(),x.rotationY=t.readFloat(),x.rotationZ=t.readFloat(),s.boneSocketDic[x.name]=x}return this._dic[i]=s,s}readBindPosByte(t){for(var e=t.readInt(),i=new Array,a=0;a<e;a++){var s=new Array(t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat());i.push(s)}return i}readMesh2OneBuffer(t,e){for(var i=t.readInt(),s=new Array,r=0,n=0;n<5;n++){var h=t.readBoolean();s.push(h),h&&(r+=1==n?2:3)}r+=8,r=13;let o=g.getVertexDeclaration("POSITION,UV,BLENDINDICES,BLENDWEIGHT",!0);i*=o.vertexStride;var l,c=(l=s[2]?s[4]?14:8:5)+4,d=new ArrayBuffer(i),u=new DataView(d);se.readBytes2ArrayBuffer(t,u,3,0,r),se.readBytes2ArrayBuffer(t,u,2,3,r),se.readBytes2ArrayBuffer(t,null,3,5,r),se.readBytes2ArrayBuffer(t,null,3,8,r),se.readBytes2ArrayBuffer(t,null,3,11,r),se.readBytes2ArrayBuffer(t,u,4,l,r,2),se.readBytes2ArrayBuffer(t,u,4,c,r,1);let m=se.readIntForTwoByteNew(t);se.readIntForTwoByte(t,e.boneNewIDAry),e.compressBuffer=!0,e.uvsOffsets=12,e.normalsOffsets=20,e.tangentsOffsets=32,e.bitangentsOffsets=44,e.boneIDOffsets=4*l,e.boneWeightOffsets=4*c,e.stride=4*r;let y=new p(d.byteLength,WebGLRenderingContext.STATIC_DRAW,!0);y.vertexDeclaration=o,y.setData(d),e.layaVertexBuffer=y;var x=new a(e.indexFormat,m.length,WebGLRenderingContext.STATIC_DRAW,!1);x.setData(m),e.layaIndexBuffer=x,e._setBuffer(y,x)}preLoad(t){this.getMeshData(t,t=>{t.loadMaterial()})}}class De extends se{constructor(){super(),this.actionNum=0,this.actionIndex=0,this.resState="none",this.NONE="none",this.READ_MESH="read_mesh",this.READ_ACTION="read_action",this.READ_IMAGE="read_image",this.READ_IMAGE_LOADING="read_image_loading",this.READ_MATERIAL="read_material",this.READ_PARTICLE="read_particle",this.READ_COMPLETE="read_complete",this.updateTick=()=>{this.updateState()},this.meshBatchNum=1}load(t,e){this._fun=e,X.getInstance().load(t,X.BYTE_TYPE,t=>{this.loadComplete(t)})}updateState(){switch(this.resState){case this.READ_MESH:this.readMesh();break;case this.READ_ACTION:this.readAction();break;case this.READ_IMAGE:this.resState=this.READ_IMAGE_LOADING,this.read();break;case this.READ_MATERIAL:case this.READ_PARTICLE:this.read();break;case this.READ_COMPLETE:T.removeFrameTick(this.updateTick),this._fun&&(this._fun(),this._fun=null)}}loadComplete(t){this._byte=new A(t),this._byte.position=0,this.version=this._byte.readInt(),this.resState=this.READ_MESH,T.addFrameTick(this.updateTick)}readMesh(){this.roleUrl=this._byte.readUTF(),this.version>=16&&(this.ambientLightColor=new b,this.sunLigthColor=new b,this.nrmDircet=new b,this.ambientLightColor.x=this._byte.readFloat(),this.ambientLightColor.y=this._byte.readFloat(),this.ambientLightColor.z=this._byte.readFloat(),this.ambientLightIntensity=this._byte.readFloat(),this.ambientLightColor.scaleBy(this.ambientLightIntensity),this.sunLigthColor.x=this._byte.readFloat(),this.sunLigthColor.y=this._byte.readFloat(),this.sunLigthColor.z=this._byte.readFloat(),this.sunLigthIntensity=this._byte.readFloat(),this.sunLigthColor.scaleBy(this.sunLigthIntensity),this.nrmDircet.x=this._byte.readFloat(),this.nrmDircet.y=this._byte.readFloat(),this.nrmDircet.z=this._byte.readFloat()),fe.getInstance().readData(this._byte,this.meshBatchNum,this.roleUrl,this.version),this.readActions()}readActions(){this.version>=30?this.actionByte=M.getZipByte(this._byte):this.actionByte=this._byte,this.actionAry=new Array,this.actionNum=this.actionByte.readInt(),this.resState=this.READ_ACTION}readAction(){if(this.actionIndex>=this.actionNum)this.resState=this.READ_IMAGE;else{var t=this.actionByte.readUTF();ye.getInstance().readData(this.actionByte,this.roleUrl+t),this.actionAry.push(t),this.actionIndex++}}allResCom(){this.resState=this.READ_MATERIAL,this.actionByte=null,this.actionNum=0,this.actionIndex=0}readMaterial(){super.readMaterial(),this.resState=this.READ_PARTICLE}readParticle(){super.readParticle(),this.resState=this.READ_COMPLETE}}class be{constructor(){this.frame=0}setData(t){this.frame=t.frame,this.url=t.url}}class we{setData(t){this.time=t.time*D.frameTime,this.lasttime=t.lasttime*D.frameTime,this.amp=t.amp}}class Ae extends be{setData(t){super.setData(t),this.hasSocket=t.hasSocket,this.hasSocket?this.socket=t.socket:(this.pos=new b(t.pos.x,t.pos.y,t.pos.z),this.rotation=new b(t.rotation.x,t.rotation.y,t.rotation.z))}}class Me extends be{setData(t){super.setData(t),this.beginType=t.beginType,0==this.beginType?this.beginPos=new b(t.beginPos.x,t.beginPos.y,t.beginPos.z):1==this.beginType&&(this.beginSocket=t.beginSocket),this.speed=t.speed,t.hitSocket&&(this.hitSocket=t.hitSocket),t.endParticle&&(this.endParticleUrl=t.endParticle),this.multype=t.multype}}class Te{setData(t){this.keyAry=new Array,this.action=t.action,this.skillname=t.skillname,this.bloodTime=t.blood,this.types=t.type,this.types==Se.FixEffect?this.keyAry=this.getFixEffect(t.data):this.types!=Se.TrajectoryDynamicTarget&&this.types!=Se.TrajectoryDynamicPoint||(this.keyAry=this.getTrajectoryDynamicTarget(t.data)),t.sound&&(this.sound=new be,this.sound.frame=t.sound.time*D.frameTime,this.sound.url=t.sound.name),t.shock&&(this.shockAry=this.getShockAry(t.shock))}getShockAry(t){for(var e=new Array,i=0;i<t.length;i++){var a=new we;a.setData(t[i]),e.push(a)}return e}getFixEffect(t){for(var e=new Array,i=0;i<t.length;i++){var a=new Ae;a.setData(t[i]),e.push(a)}return e}getTrajectoryDynamicTarget(t){for(var e=new Array,i=0;i<t.length;i++){var a=new Me;a.setData(t[i]),e.push(a)}return e}}Te.defaultBloodTime=250;class Se{}Se.TrajectoryDynamicTarget=1,Se.FixEffect=4,Se.TrajectoryDynamicPoint=3;class Pe extends se{constructor(){super(),this.meshBatchNum=1}load(t,e){this._fun=e,X.getInstance().load(t,X.BYTE_TYPE,t=>{this.loadComplete(t)})}loadComplete(t){this._byte=new A(t),this._byte.position=0,this.version=this._byte.readInt(),this.skillUrl=this._byte.readUTF(),this.read(()=>{this.readNext()})}readNext(){if(this.read(),this.read(),this.version<27)this._byte.readUTF();this.data=this.readData(this._byte),this._fun()}readData(t){for(var e=t.readInt(),i=new Object,a=0;a<e;a++){var s=new Object,r=t.readUTF(),n=t.readUTF();if(s.skillname=r,s.action=n,s.type=t.readFloat(),this.version>=26?(s.blood=t.readInt(),0==s.blood&&(s.blood=Te.defaultBloodTime)):s.blood=Te.defaultBloodTime,this.version>=32){var h=t.readInt();if(h>0){var o=t.readUTF();s.sound={time:h,name:o}}}if(this.version>=33){var l=t.readInt();if(l){for(var c=new Array,d=0;d<l;d++){var u=new Object;u.time=t.readInt(),u.lasttime=t.readInt(),u.amp=t.readFloat(),c.push(u)}s.shock=c}}s.data=new Array;for(var m=t.readInt(),p=0;p<m;p++){var y=new Object;switch(y.url=t.readUTF(),y.frame=t.readFloat(),s.type){case 1:y.beginType=t.readInt(),0==y.beginType?(y.beginPos=new b,y.beginPos.x=t.readFloat(),y.beginPos.y=t.readFloat(),y.beginPos.z=t.readFloat()):1==y.beginType&&(y.beginSocket=t.readUTF()),y.hitSocket=t.readUTF(),y.endParticle=t.readUTF(),y.multype=t.readInt(),y.speed=t.readFloat();break;case 3:y.beginSocket=t.readUTF(),y.beginType=t.readFloat(),y.multype=t.readFloat(),y.speed=t.readFloat();break;case 4:if(this.version>=27){var x=t.readBoolean();y.hasSocket=x,x?y.socket=t.readUTF():(y.pos=this.readV3d(t),y.rotation=this.readV3d(t))}else y.hasSocket=!1,y.pos=this.readV3d(t),y.rotation=this.readV3d(t);break;default:alert("没有类型readData")}s.data.push(y)}i[r]=s}return i}readV3d(t){var e=new b;return e.x=t.readFloat(),e.y=t.readFloat(),e.z=t.readFloat(),e.w=t.readFloat(),e}}class Ie{static getUItittleUrl(t){return"ui/load/tittle/"+t+".png"}static getSkillUrl(t){return!t||t.length,("skill/"+t+M.getBaseUrl()+".txt").replace(".txt","_byte.txt")}static getModelUrl(t){return"model/"+t+M.getBaseUrl()+".txt"}static getModelUIUrl(t){return"model/"+t+M.getBaseUrl()+".txt"}static getMapUrl(t){return"map/"+t+".txt"}static getRoleUrl(t){return"role/"+t+M.getBaseUrl()+".txt"}static getZipMapUrl(t){return"map/"+t+"/"}static Snum(t){return"123"}static getEffectUIUrl(t){return"ui/load/effect/"+t+".png"}static getKeyProById(t){return"cc"}}class Re extends se{load(t,e,i,a){if(this.sceneData)this.isNeedReload()?(e(),i(1),this.applyByteArray()):(e(),i(1),a(this.sceneData));else{this._completeFun=e,this._readDataFun=a,this._progressFun=i;var s=Re.sceneConfigData;s&&s[t]?this.loadZipMap(t,s[t].len):(t=D.fileRoot+Ie.getMapUrl(t),X.getInstance().load(t,X.BYTE_TYPE,t=>{this.loadComplete(t)},null,i))}}loadZipMap(t,e){for(var i=new Array,a=new Array,s=0,r=new Array,n=0;n<e;n++)r[n]=0;var h=t=>{var e=t.response,r=i.indexOf(t);if(a[r]=e,++s==i.length){for(var n=0,h=0;h<a.length;h++)n+=a[h].byteLength;var o=new Uint8Array(n),l=0;for(h=0;h<a.length;h++)o.set(new Uint8Array(a[h]),l),l+=a[h].byteLength;this.loadComplete(o.buffer)}},o=(t,a)=>{var s=i.indexOf(t);r[s]=a;for(var n=0,h=0;h<e;h++)n+=r[h];n/=e,this._progressFun(n)};for(n=0;n<e;n++){var l=new XMLHttpRequest;l.onreadystatechange=t=>{var e=t.target;200==e.status&&4==e.readyState&&h(e)},l.onprogress=t=>{var e=t.target;o(e,t.loaded/t.total)};var c=D.fileRoot+Ie.getZipMapUrl(t)+n+".txt";i.push(l),l.open("GET",c,!0),l.responseType="arraybuffer",l.send()}}isNeedReload(){for(var t=this.sceneData.buildItem,e=0;e<t.length;e++)if(t[e].type==se.PREFAB_TYPE&&t[e].lighturl){var i=D.fileRoot+t[e].lighturl;return!K.getInstance().hasTexture(i)}return L.GCTime-this.idleTime<10}loadComplete(t){this._byte=new A(t),this._completeFun(),this.applyByteArray()}applyByteArray(){this._byte.position=0,this.version=this._byte.readInt(),this.read(()=>{this.readNext()})}readNext(){this.read(),this.read(),this.read(),this.readScene(),this._readDataFun(this.sceneData)}readScene(){this._byte.readInt();this.readAstat(),this.version>=28&&this.readTerrainIdInfoBitmapData(this._byte);var t=this._byte.readInt();this.sceneData=JSON.parse(this._byte.readUTFBytes(t)),this.sceneData.astar=this._astarDataMesh,this.sceneData.terrain=this._terrainDataItem}readTerrainIdInfoBitmapData(t){var e=t.readInt();if(e){var i=e,a=t.buffer.slice(t.position,t.position+i);t.position+=i;var s=M.unZip(a),r=new A(s);this._terrainDataItem=me.meshAllgroundData(r)}}readAstat(){if(this._byte.readBoolean()){var t,e;this._astarDataMesh=new Le,this._astarDataMesh.aPos=new b,this._astarDataMesh.astarItem=new Array,this._astarDataMesh.heightItem=new Array,this._astarDataMesh.jumpItem=new Array,this._astarDataMesh.midu=this._byte.readFloat(),this._astarDataMesh.aPos.x=this._byte.readFloat(),this._astarDataMesh.aPos.y=this._byte.readFloat(),this._astarDataMesh.aPos.z=this._byte.readFloat();var i=this._byte.readInt(),a=this._byte.readInt();if(this._astarDataMesh.width=i,this._astarDataMesh.height=a,this.version<25){for(t=0;t<a;t++){var s=new Array;for(e=0;e<i;e++)s.push(this._byte.readFloat());this._astarDataMesh.astarItem.push(s)}for(t=0;t<a;t++){var r=new Array;for(e=0;e<i;e++)r.push(this._byte.readFloat());this._astarDataMesh.heightItem.push(r)}}else{var n=this._byte.readFloat(),h=this.readAstarFromByte(this._byte),o=this.readAstarFromByte(this._byte),l=0,c=0;for(t=0;t<a;t++){s=new Array;var d=new Array;for(e=0;e<i;e++){var u=h[l++];if(s.push(u),1==u){var m=o[c++];d.push(m)}else d.push(0)}this._astarDataMesh.astarItem.push(s),this._astarDataMesh.jumpItem.push(d)}for(this._astarDataMesh.jumpItem,t=0;t<a;t++){r=new Array;for(e=0;e<i;e++)r.push(this._byte.readShort()/n);this._astarDataMesh.heightItem.push(r)}}}}readAstarFromByte(t){for(var e=t.readUnsignedInt(),i=Math.ceil(e/32),a=new Array,s=0;s<i;s++)for(var r=t.readUnsignedInt(),n=0;n<32;n++){var h=1&r;a.length<e&&a.push(h),r>>=1}return a}}class Le{}class Be extends j{static getInstance(){return this._instance||(this._instance=new Be),this._instance}loadRoleRes(t,e,i){var a=new De;a.meshBatchNum=i,a.load(t,()=>{e(a)})}loadSkillRes(t,e){var i=new Pe;i.load(t,()=>{e(i)})}loadSceneRes(t,e,i,a){var s;return this._dic[t]?s=this._dic[t]:(s=new Re,this._dic[t]=s),s.load(t,e,i,a),this.clearSceneUse(s),s}clearSceneUse(t){for(var e in this._dic){var i=this._dic[e];i.useNum>0&&i!=t&&(i.useNum=0)}t.useNum=1}gc(){for(var t in this._dic){var e=this._dic[t];e.useNum<=0&&(e.idleTime++,e.idleTime>=L.GCTime&&(e.destory(),delete this._dic[t]))}}}class Ce{constructor(t,e,i,a,s,r){this.x=t,this.y=e,this.z=i,this.width=a,this.height=s,this.depth=r}testViewFrustum(t,e){if(this.sun&&1==this.sun.length)this.sun[0].testViewFrustum(t,e);else if(this.testViewFrustumResult(t)&&(this.target&&(this.target.isPerspective&&this.testRay(e)||(this.target.sceneVisible=!0)),this.sun))for(var i=0;i<this.sun.length;i++)this.sun[i].testViewFrustum(t,e)}testViewFrustumResult(t){for(var e=new b(this.x,this.y,this.z),i=new b(this.width,this.height,this.depth),a=!0,s=0;s<t.length;s++){var r=e,n=e.add(i),h=new b;if(t[s].x>0?h.x=n.x:h.x=r.x,t[s].y>0?h.y=n.y:h.y=r.y,t[s].z>0?h.z=n.z:h.z=r.z,t[s].dot(h)+t[s].w<0){a=!1;break}}return a}testRay(t){var e,i,a,s,r,n,h=t.o.x,o=t.o.y,l=t.o.z,c=t.d.x,d=t.d.y,u=t.d.z,m=this.x,p=this.y,y=this.z,x=this.x+this.width,v=this.y+this.height,g=this.z+this.depth,_=1/c;_>=0?(e=(m-h)*_,s=(x-h)*_):(e=(x-h)*_,s=(m-h)*_);var f=1/d;f>=0?(i=(p-o)*f,r=(v-o)*f):(i=(v-o)*f,r=(p-o)*f);var D,b,w=1/u;w>=0?(a=(y-l)*w,n=(g-l)*w):(a=(g-l)*w,n=(y-l)*w),a>(D=e>i?e:i)&&(D=a),n<(b=s<r?s:r)&&(b=n);return D<b&&b>1e-4&&((D>1e-4?D:b)<t.baseT||void 0)}}class Fe{constructor(){this.o=new b,this.d=new b,this.baseT=500}setPos(t,e,i){this.o.x=t,this.o.y=e,this.o.z=i}setTarget(t,e,i){this.d.x=t-this.o.x,this.d.y=e-this.o.y,this.d.z=i-this.o.z,this.d.normalize()}}class ze{constructor(t=0,e=0,i=0){this.setData(t,e,i)}setData(t,e,i){this.x=t,this.y=e,this.radius=i}setPos(t,e){this.x=t,this.y=e}set x(t){this._x=t}get x(){return this._x}set y(t){this._y=t}get y(){return this._y}setRadius(t){this.radius=t}testPoint(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)<this.radius}}class Ee{constructor(){}static getCamView(t,e){var i=new V;i.appendRotation(-e.rotationX,b.X_AXIS),i.appendTranslation(e.x,e.y,e.z);var a=i.transformVector(new b(0,0,-t.distance));return t.x=a.x,t.y=a.y,t.z=a.z,t.rotationX=e.rotationX,t.cameraMatrix.identity(),t.cameraMatrix.prependTranslation(0,0,t.distance),t.cameraMatrix.prependRotation(t.rotationX,b.X_AXIS),t.cameraMatrix.prependTranslation(-e.x,-e.y,-e.z),t.cameraMatrix.setClipPlan(999,1),this.updateVp(),t.cameraMatrix.m}static updateVp(){D.vpMatrix.identity(),D.vpMatrix.prepend(D.viewMatrx3D),D.vpMatrix.prepend(D.cam3D.cameraMatrix)}static GetViewHitBoxDataCopy(t){this.viewBoxVecItem||(this.viewBoxVecItem=new Array,this.viewBoxVecItem.push(new b),this.viewBoxVecItem.push(new b),this.viewBoxVecItem.push(new b),this.viewBoxVecItem.push(new b));var e=t/(D.sceneViewHW/2),i=D.sceneViewHW/2*e,a=D.stageWidth,s=D.stageHeight,r=new V;r.prependRotation(-D.cam3D.rotationY,b.Y_AXIS),r.prependRotation(-D.cam3D.rotationX,b.X_AXIS);var n=D.viewMatrx3D.transformVector(new b(500,0,500)),h=n.x/n.w,o=a/2/h*e*.8,l=s/2/h*e*.8;this.viewBoxVecItem[0]=this.gettempPos(new b(-o,-l,i),r),this.viewBoxVecItem[1]=this.gettempPos(new b(+o,-l,i),r),this.viewBoxVecItem[2]=this.gettempPos(new b(+o,+l,i),r),this.viewBoxVecItem[3]=this.gettempPos(new b(-o,+l,i),r)}static gettempPos(t,e){var i=e.transformVector(t);return i=i.add(new b(D.cam3D.x,D.cam3D.y,D.cam3D.z))}static math_distance(t,e,i,a){return Math.sqrt((a-e)*(a-e)+(i-t)*(i-t))}}class Ve extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v3Color")}getVertexShaderString(){return"attribute vec3 v3Position;attribute vec3 v3Color;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec4 colorData;void main(void){   vec4 vt0= vec4(v3Position, 1.0);   colorData =vec4(v3Color,1) ;   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"}getFragmentShaderString(){return" precision mediump float;\nvarying vec4 colorData;\nvoid main(void)\n{\ngl_FragColor =colorData;\n}"}}Ve.LineShader="LineShader";class Ne extends U{constructor(){super(),this.baseColor=new b(1,0,0),this.objData=new $,this.shader=at.getInstance().getProgram(Ve.LineShader),this.program=this.shader.program,this.makeLineMode(new b(0,0,0),new b(100,0,0),new b),this.makeLineMode(new b(0,0,0),new b(100,0,100),new b),this.makeLineMode(new b(100,0,0),new b(100,0,100),new b),this.upToGpu()}makeLineMode(t,e,i=null){this.lineVecPos&&this.lineIndex||this.clear(),i&&(this.baseColor=i),this.lineVecPos.push(t.x,t.y,t.z),this.lineVecPos.push(e.x,e.y,e.z),this.lineColor.push(this.baseColor.x,this.baseColor.y,this.baseColor.z),this.lineColor.push(this.baseColor.x,this.baseColor.y,this.baseColor.z),this.lineIndex.push(this.lineIndex.length+0,this.lineIndex.length+1)}clear(){this.lineVecPos=new Array,this.lineIndex=new Array,this.lineColor=new Array,this.objData.indexBuffer&&(this.objData.indexBuffer=null)}upToGpu(){this.lineIndex.length&&(this.objData.treNum=this.lineIndex.length,this.objData.vertexBuffer=D.context3D.uploadBuff3D(this.lineVecPos),this.objData.normalsBuffer=D.context3D.uploadBuff3D(this.lineColor),this.objData.indexBuffer=D.context3D.uploadIndexBuff3D(this.lineIndex))}update(){this.objData&&this.objData.indexBuffer&&(D.context3D.setProgram(this.program),D.context3D.setVcMatrix4fv(this.shader,"viewMatrix3D",D.viewMatrx3D.m),D.context3D.setVcMatrix4fv(this.shader,"camMatrix3D",D.cam3D.cameraMatrix.m),D.context3D.setVcMatrix4fv(this.shader,"posMatrix3D",this.posMatrix.m),D.context3D.setVa(0,3,this.objData.vertexBuffer),D.context3D.setVa(1,3,this.objData.normalsBuffer),D.context3D.drawLine(this.objData.indexBuffer,this.objData.treNum))}}class ke{constructor(){this.needUpdata=!1,this.panleAry=new Array}init(t,e){this._circle=new ze(1e4,1e4),this._sceneDic=e,this._rootNode=this.getNode(t),this._ray=new Fe}getNode(t){var e=new Ce(t.x,t.y,t.z,t.width,t.height,t.depth);if(t.data){e.sun||(e.sun=new Array);for(var i=0;i<t.data.length;i++){var a,s=new Ce(t.data[i].x,t.data[i].y,t.data[i].z,t.data[i].width,t.data[i].height,t.data[i].depth);1==t.data[i].type?a="build"+t.data[i].id:11==t.data[i].type?a="particle"+t.data[i].id:14==t.data[i].type&&(a="ground"+t.data[i].id),s.target=this._sceneDic[a],s.target.aabb=s,e.sun.push(s)}}if(t.sun){e.sun||(e.sun=new Array);for(i=0;i<t.sun.length;i++)e.sun.push(this.getNode(t.sun[i]))}return e}setCircle(t,e,i){var a=t-this._circle.x,s=e-this._circle.y;Math.sqrt(a*a+s*s)<10?this.needUpdata=!1:(this._circle.setData(t,e,i),this.needUpdata=!0)}update(){Ee.GetViewHitBoxDataCopy(D.cam3D.distance);var t=new b(D.cam3D.x,D.cam3D.y,D.cam3D.z),e=Ee.viewBoxVecItem;this.panleAry.length=0,this.panleAry.push(this.getPanelByVec(t,e[0],e[1])),this.panleAry.push(this.getPanelByVec(t,e[1],e[2])),this.panleAry.push(this.getPanelByVec(t,e[2],e[3])),this.panleAry.push(this.getPanelByVec(t,e[3],e[0])),this._ray.setPos(D.cam3D.x,D.cam3D.y,D.cam3D.z),this._ray.setTarget(D.focus3D.x,D.focus3D.y,D.focus3D.z),this._ray.baseT=D.cam3D.distance,this._rootNode.testViewFrustum(this.panleAry,this._ray)}getPanelByVec(t,e,i){var a=e.subtract(t),s=i.subtract(t);return(a=a.cross(s)).normalize(),a.w=-a.dot(t),a}updateDraw(){this.capsuleLineSprite?(this.capsuleLineSprite.x=D.focus3D.x,this.capsuleLineSprite.y=D.focus3D.y+50,this.capsuleLineSprite.z=D.focus3D.z,this.capsuleLineSprite.update()):(this.capsuleLineSprite=new Ne,this.capsuleLineSprite.clear(),this.capsuleLineSprite.baseColor=new b(1,0,0,1),this.drawCylinder(this._circle.radius,10),this.capsuleLineSprite.upToGpu())}drawCylinder(t,e){var i,a,s,r=t,n=e;for(s=0;s<12;s++){var h=new b(r,0,0),o=new b(r,+n,0),l=new V;l.appendRotation(30*s,b.Y_AXIS);var c=l.transformVector(h),d=l.transformVector(o);this.capsuleLineSprite.makeLineMode(c,d),this.capsuleLineSprite.makeLineMode(d,new b(0,+n,0)),11==s&&(this.capsuleLineSprite.makeLineMode(c,h),this.capsuleLineSprite.makeLineMode(d,o)),(i||a)&&(this.capsuleLineSprite.makeLineMode(c,i),this.capsuleLineSprite.makeLineMode(d,a)),i=c.clone(),a=d.clone()}}}class Ue{constructor(){}init(){this.capsuleLineSprite=new Ne,He.getInstance().addDisplay(this.capsuleLineSprite)}setCam(){var t=D.cam3D.cameraMatrix.clone();t.append(D.viewMatrx3D);var e=t.m,i=e[0],a=e[1],s=e[2],r=e[3],n=e[4],h=e[5],o=e[6],l=e[7],c=e[8],d=e[9],u=e[10],m=e[11],p=e[12],y=e[13],x=e[14],v=e[15];this.panleAry=new Array;this.getPanle(-c+p,-d+y,-u+x,-m+v),this.getPanle(n+p,h+y,o+x,l+v),this.getPanle(-n+p,-h+y,-o+x,-l+v),this.getPanle(i+p,a+y,s+x,r+v),this.getPanle(-i+p,-a+y,-s+x,-r+v)}getPanle(t,e,i,a){var s=new b(t,e,i,a);return s.normalize(),s}getPanelByVec(t,e,i){var a=e.subtract(t),s=i.subtract(t);return(a=a.cross(s)).normalize(),a.w=-a.dot(t),a}setData(t){this.dataAry=t}setViewFrustum(){this.capsuleLineSprite||this.init(),this.setCam(),this.capsuleLineSprite.clear(),this.capsuleLineSprite.baseColor=new b(0,0,1,1),Ee.GetViewHitBoxDataCopy(D.cam3D.distance);var t=new b(D.cam3D.x,D.cam3D.y,D.cam3D.z),e=Ee.viewBoxVecItem;this.panleAry.push(this.getPanelByVec(t,e[0],e[1])),this.panleAry.push(this.getPanelByVec(t,e[1],e[2])),this.panleAry.push(this.getPanelByVec(t,e[2],e[3])),this.panleAry.push(this.getPanelByVec(t,e[3],e[0]));for(var i=0;i<this.dataAry.length;i++){for(var a=this.dataAry[i],s=new b(a.x,a.y,a.z),r=new b(a.width,a.height,a.depth),n=!1,h=0;h<this.panleAry.length;h++){var o=s,l=s.add(r),c=new b;if(this.panleAry[h].x>0?c.x=l.x:c.x=o.x,this.panleAry[h].y>0?c.y=l.y:c.y=o.y,this.panleAry[h].z>0?c.z=l.z:c.z=o.z,this.panleAry[h].dot(c)+this.panleAry[h].w<0){n=!0;break}}this.capsuleLineSprite.baseColor=n?new b(1,0,0,1):new b(0,0,1,1),this.capsuleLineSprite.makeLineMode(s,new b(s.x+r.x,s.y,s.z)),this.capsuleLineSprite.makeLineMode(s,new b(s.x,s.y,s.z+r.z)),this.capsuleLineSprite.makeLineMode(new b(s.x+r.x,s.y,s.z),new b(s.x+r.x,s.y,s.z+r.z)),this.capsuleLineSprite.makeLineMode(new b(s.x,s.y,s.z+r.z),new b(s.x+r.x,s.y,s.z+r.z)),this.capsuleLineSprite.makeLineMode(new b(s.x,s.y+r.y,s.z),new b(s.x+r.x,s.y+r.y,s.z)),this.capsuleLineSprite.makeLineMode(new b(s.x,s.y+r.y,s.z),new b(s.x,s.y+r.y,s.z+r.z)),this.capsuleLineSprite.makeLineMode(new b(s.x+r.x,s.y+r.y,s.z),new b(s.x+r.x,s.y+r.y,s.z+r.z)),this.capsuleLineSprite.makeLineMode(new b(s.x,s.y+r.y,s.z+r.z),new b(s.x+r.x,s.y+r.y,s.z+r.z)),this.capsuleLineSprite.makeLineMode(new b(s.x,s.y,s.z),new b(s.x,s.y+r.y,s.z)),this.capsuleLineSprite.makeLineMode(new b(s.x+r.x,s.y,s.z),new b(s.x+r.x,s.y+r.y,s.z)),this.capsuleLineSprite.makeLineMode(new b(s.x,s.y,s.z+r.z),new b(s.x,s.y+r.y,s.z+r.z)),this.capsuleLineSprite.makeLineMode(new b(s.x+r.x,s.y,s.z+r.z),new b(s.x+r.x,s.y+r.y,s.z+r.z))}this.capsuleLineSprite.upToGpu()}}class Oe{constructor(){this.a=0,this.b=0,this.c=0,this.d=0}}class We{constructor(){}static _PanelEquationFromThreePt(t,e,i){var a=(e.y-t.y)*(i.z-t.z)-(e.z-t.z)*(i.y-t.y),s=(e.z-t.z)*(i.x-t.x)-(e.x-t.x)*(i.z-t.z),r=(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x),n=0-(a*t.x+s*t.y+r*t.z),h=new Oe;return h.a=a,h.b=s,h.c=r,h.d=n,h}static calPlaneLineIntersectPoint(t,e,i,a){var s=new b,r=t.x,n=t.y,h=t.z,o=e.x,l=e.y,c=e.z,d=i.x-a.x,u=i.y-a.y,m=i.z-a.z,p=a.x,y=a.y,x=a.z,v=d*r+u*n+m*h;if(0==v)return null;var g=((o-p)*r+(l-y)*n+(c-x)*h)/v;return s.x=p+d*g,s.y=y+u*g,s.z=x+m*g,s}}class je{static mathDisplay2Dto3DWorldPos(t,e=300){var i=e/(D.sceneViewHW/2),a=D.sceneViewHW/2*i,s=D.stageWidth,r=D.stageHeight,n=new V;n.prependRotation(-D.cam3D.rotationY,b.Y_AXIS),n.prependRotation(-D.cam3D.rotationX,b.X_AXIS);var h=D.viewMatrx3D.transformVector(new b(500,0,500)),o=h.x/h.w,l=s/2/o*i,c=r/2/o*i,d=t.x/s*l*2,u=t.y/r*c*2;return this.gettempPos(new b(-l+d,+c-u,a),n)}static gettempPos(t,e){var i=e.transformVector(t);return i=i.add(new b(D.cam3D.x,D.cam3D.y,D.cam3D.z))}static math3DWorldtoDisplay2DPos(t){var e=D.cam3D.cameraMatrix.clone();e.append(D.viewMatrx3D.clone());var i=D.stageWidth,a=D.stageHeight,s=e.transformVector(t),r=new _;return r.x=(s.x/s.w+1)*(i/2),r.y=(-s.y/s.w+1)*(a/2),r}static argbToHex(t,e,i,a){return t<<24|e<<16|i<<8|a}static hexToArgb(t){var e=new b;return e.w=t>>24&255,e.x=t>>16&255,e.y=t>>8&255,e.z=255&t,e}static getLineAndPlaneIntersectPoint(t,e,i,a){var s=new b(t.x-e.x,t.y-e.y,t.z-e.z);s.normalize();var r=s.x*a.x+s.y*a.y+s.z*a.z,n=((i.x-t.x)*a.x+(i.y-t.y)*a.y+(i.z-t.z)*a.z)/r,h=new b;return h.setTo(t.x+s.x*n,t.y+s.y*n,t.z+s.z*n),h}static lookAt(t,e){var i=new V;return i.buildLookAtLH(t,e,b.Y_AXIS),i}static getTowPointsAngle2(t,e,i,a){var s=Math.atan2(a-e,i-t);return s<0&&(s+=2*Math.PI),180*s/Math.PI|0}static getTowPointsAngle(t,e){var i=Math.atan2(e.y-t.y,e.x-t.x);return i<0&&(i+=2*Math.PI),180*i/Math.PI}static getDisSquare(t,e,i,a){return Math.sqrt((t-i)*(t-i)+(e-a)*(e-a))}}class Ge{constructor(){}static getGroundPos(t,e){if(!this._plantObjectMath){var i=new b(0,-500,500),a=new b(-500,-500,0),s=new b(500,-500,0);this._plantObjectMath=We._PanelEquationFromThreePt(i,a,s),this._plantnormal=new b(this._plantObjectMath.a,this._plantObjectMath.b,this._plantObjectMath.c),this._plantnormal.normalize(),this._plane_a=new b(i.x,i.y,i.z)}var r=je.mathDisplay2Dto3DWorldPos(new _(t,e),500),n=new b(D.cam3D.x,D.cam3D.y,D.cam3D.z);return We.calPlaneLineIntersectPoint(this._plantnormal,this._plane_a,r,n)}}class Xe{constructor(){}static setData(t){this.navmeshData=t,this.heightItem=this.navmeshData.heightItem,this.jumpItem=this.navmeshData.jumpItem,this.midu=this.navmeshData.midu,this.aPos=new b(this.navmeshData.aPos.x,this.navmeshData.aPos.y,this.navmeshData.aPos.z),this.makeStarGraph(this.navmeshData.astarItem),this.astarWidth=this.heightItem[0].length,this.astarHeight=this.heightItem.length,He.getInstance().fixAstart(new _(this.aPos.x,this.midu*this.astarHeight+this.aPos.z)),this.mathAreaRect(),this.mathMinMapRect()}static set sceneVectList(t){this._sceneVectList=t,this._frist=!0}static getJumpDataByV2d(t,e){return!!(this.jumpItem&&this.jumpItem.length&&this.jumpItem[e]&&1==this.jumpItem[e][t])}static mathMinMapRect(){Xe.navmeshData.midu;var t=Xe.navmeshData.astarItem[0].length,e=Xe.navmeshData.astarItem.length,i=Xe.navmeshData.aPos.x+t*Xe.navmeshData.midu,a=Xe.navmeshData.aPos.z+e*Xe.navmeshData.midu;i=Math.max(Math.abs(Xe.navmeshData.aPos.x),Math.abs(i)),a=Math.max(Math.abs(Xe.navmeshData.aPos.z),Math.abs(a));var s=Math.max(i,a);s+=100,s=Math.round(s);var r=new de;r.x=-s,r.y=-s,r.width=2*s,r.height=2*s,r.x-=1,r.y-=1,r.width+=2,r.height+=2,r.width/=2,r.height/=2,this.minMapRect=r}static mathAreaRect(){this.areaRect=new de,this.areaRect.x=this.aPos.x,this.areaRect.y=this.aPos.z,this.areaRect.width=this.astarWidth*this.midu,this.areaRect.height=this.astarHeight*this.midu}static clear(){this.navmeshData&&(this._bakData=this.navmeshData,this.aPos.setTo(0,0,0),this.navmeshData=null)}static porcessBak(t){t&&this.setData(this._bakData)}static getHeightByPos(t){if(this.heightItem){var e=t.subtract(this.aPos).add(new b(this.midu/2,0,this.midu/2)),i=(this.astarWidth-1)*this.midu,a=(this.astarHeight-1)*this.midu;if(e.x>0&&e.x<=i&&e.z>0&&e.z<=a)return this.getBaseHeightByBitmapdata(e.x/this.midu,e.z/this.midu)}return-500}static getBaseHeightByBitmapdata(t,e){var i=t-M.float2int(t),a=e-M.float2int(e);return(1-i)*(1-a)*this.getBitmapDataHight(M.float2int(t),M.float2int(e))+(1-i)*a*this.getBitmapDataHight(M.float2int(t),Math.ceil(e))+i*(1-a)*this.getBitmapDataHight(Math.ceil(t),M.float2int(e))+i*a*this.getBitmapDataHight(Math.ceil(t),Math.ceil(e))}static getBitmapDataHight(t,e){return this.heightItem[this.heightItem.length-1-e][t]}static findPath(t,e){return null}static Path2dTo3d(t){for(var e=new Array,i=0;i<t.length;i++)e.push(this.getWorldPosByStart2D(t[i]));return e}static getWorldPosByStart2D(t){if(this.navmeshData){var e=new b(t.x*this.midu,3,t.y*this.midu);return e.x=e.x+this.aPos.x+this.midu/2,e.z=this.aPos.z+this.midu*this.astarHeight-e.z-this.midu/2,e}return new b(10*t.x+this.midu/2,0,10*t.y-this.midu/2)}static findPath3D(t,e){if(this.navmeshData){Xe.getPosIsCanMove(e)||(e=this.findNearLinePoint(t,e));var i=this.getGrapIndexByPos(t),a=this.getGrapIndexByPos(e);return this.getJumpDataByV2d(a.x,a.y)?null:this.isGridCanWalk(a)&&i?this.findStraightLine(i,a)?[i,a]:this.findPath2D(i,a):null}return[this.getGrapIndexByPos(t),this.getGrapIndexByPos(e)]}static findStraightLine(t,e){var i=new _(e.x-t.x,e.y-t.y);i.normalize();for(var a=Math.round(_.distance(t,e)),s=new _,r=0;r<a;r++){if(s.x=Math.floor(t.x+r*i.x),s.y=Math.floor(t.y+r*i.y),!this.isGridCanWalk(s))return!1;if(s.x=Math.ceil(t.x+r*i.x),s.y=Math.ceil(t.y+r*i.y),!this.isGridCanWalk(s))return!1;if(s.x=Math.round(t.x+r*i.x),s.y=Math.round(t.y+r*i.y),!this.isGridCanWalk(s))return!1}return!0}static isGridCanWalk(t){return!!t&&(!!this.graphData.grid[t.y]&&(!!this.graphData.grid[t.y][t.x]&&0!=this.graphData.grid[t.y][t.x].weight))}static findPath2D(t,e){return null}static turnLineAstar(t){if(t.length<2)return t;for(var e=[t[0]],i=2;i<t.length;i++)this.findStraightLine(e[e.length-1],t[i])||e.push(t[i-1]);return e.push(t[t.length-1]),t.length!=e.length?this.turnLineAstar(e):e}static simplifyAstar(t){var e=0;if(t.length,t.length>2){var i=new Array;i.push(t[0]);for(var a=2;a<t.length;a++){var s=i[i.length-1],r=t[a-1],n=t[a];Math.atan2(r.y-s.y,r.x-s.x)!=Math.atan2(n.y-s.y,n.x-s.x)||e>126?i.push(r):e++}return i.push(t[t.length-1]),i}return t}static findNearLinePoint(t,e){for(;b.distance(t,e)>5;)if(e=this.moveA2B(e,t,1),Xe.getPosIsCanMove(e))return e;return e}static moveA2B(t,e,i){var a=e.subtract(t);return a.normalize(),a.scaleBy(i),a=a.add(t)}static getPosIsCanMove(t){if(!this.graphData||!this.graphData.grid)return!1;var e=this.getGrapIndexByPos(t);return this.isGridCanWalk(e)}static makeStarGraph(t){}static blockAry(t){for(var e=new Array,i=0;i<t.length;i++)e.push([new _(t[i][0],t[i][1]),new _(t[i][2],t[i][3])]);this.blockList(e)}static blockList(t){this.blockBakData&&this.unblock(),this.blockBakData=new Array;for(var e=0;e<t.length;e++)this.blockPoint(t[e][0],t[e][1])}static blockPoint(t,e){var i=new de;i.y=Math.min(t.x,e.x),i.x=Math.min(t.y,e.y),i.height=Math.abs(t.x-e.x),i.width=Math.abs(t.y-e.y),this.blockRec(i)}static blockRec(t){for(var e=0;e<t.width;e++){for(var i=new Array,a=0;a<t.height;a++){var s=e+t.x,r=a+t.y,n=this.graphData.grid[s][r];i.push({i:s,j:r,w:n.weight}),n.weight=0}this.blockBakData.push(i)}}static unblock(){if(this.blockBakData){for(var t=0;t<this.blockBakData.length;t++)for(var e=0;e<this.blockBakData[t].length;e++){var i=this.blockBakData[t][e];this.graphData.grid[i.i][i.j].weight=i.w}this.blockBakData=null}}static getGrapIndexByPos(t){if(!this.navmeshData)return new _(M.float2int(t.x/this.midu),M.float2int(t.z/this.midu));var e=t.subtract(this.aPos).add(new b(0,0,this.midu/2)),i=this.astarWidth*this.midu,a=this.astarHeight*this.midu;return e.x>0&&e.x<i&&e.z>0&&e.z<a?new _(M.float2int(e.x/this.midu),M.float2int(this.astarHeight-e.z/this.midu)):null}static getScenePos(t,e){var i=Ge.getGroundPos(t,e);return this.getLookAtPos(i)}static getLookAtPos(t){var e=new b(D.cam3D.x,D.cam3D.y,D.cam3D.z),i=t.subtract(e);i.normalize();for(var a,s=0;;){s+=2;var r=i.clone();r.scaleBy(s);var n=e.add(r);if(Xe.getHeightByPos(n)>n.y){a=n;break}if(s>1e3){a=null;break}}return a}}Xe.aPos=new b,Xe.midu=10,Xe.astarWidth=0,Xe.astarHeight=0,Xe._frist=!1,Xe.canwalkItem=[];class Ye{constructor(){this._defaultVec=new Array;for(var t=[.4444730390920146,-.3834955622240026,-.33124467509627725,.09365654209093091,-.05673310882817577,.2120523322966496,.02945768486978205,-.04965996229802928,-.1136529129285836],e=0;e<9;e++)this._defaultVec.push(new b(t[e],t[e],t[e]))}static getInstance(){return this._instance||(this._instance=new Ye),this._instance}setLightProbeData(t){this._dataAry=t}clear(){this._dataAry=null}getData(t){if(!this._dataAry)return this._defaultVec;for(var e=0;e<this._dataAry.length;e++){var i=this._dataAry[e];if(this.testPoint(i,t)){var a=i.postion,s=t.subtract(a);return this.getResultData(i.posItem,M.float2int(s.x/i.betweenNum),M.float2int(s.z/i.betweenNum),M.float2int(s.y/i.betweenNum),i.betweenNum,s)}}return this._defaultVec}testPoint(t,e){var i=(t.cubeVec.x-1)*t.betweenNum,a=(t.cubeVec.y-1)*t.betweenNum,s=(t.cubeVec.z-1)*t.betweenNum,r=e.x-t.postion.x,n=e.y-t.postion.y,h=e.z-t.postion.z;return r>=0&&r<i&&n>=0&&n<a&&h>=0&&h<s}getResultData(t,e,i,a,s,r){var n=new Array;n.push(new Ze(t[e][i][a],r)),n.push(new Ze(t[e+1][i][a],r)),n.push(new Ze(t[e][i+1][a],r)),n.push(new Ze(t[e+1][i+1][a],r)),n.push(new Ze(t[e][i][a+1],r)),n.push(new Ze(t[e+1][i][a+1],r)),n.push(new Ze(t[e][i+1][a+1],r)),n.push(new Ze(t[e+1][i+1][a+1],r));for(var h=0,o=0;o<n.length;o++)h+=n[o].dis;for(o=0;o<n.length;o++)n[o].setBais(h);var l=0;for(o=0;o<n.length;o++)l+=n[o].bais;for(o=0;o<n.length;o++)n[o].bais=n[o].bais/l;var c=new Array;for(o=0;o<9;o++){for(var d=new b,u=0;u<n.length;u++){var m=new b(n[u].vecNum[o].x,n[u].vecNum[o].y,n[u].vecNum[o].z);m.scaleBy(n[u].bais),d=d.add(m)}c.push(d)}return c}}class Ze{constructor(t,e){this.pos=new b(t.x,t.y,t.z),this.vecNum=t.resultSHVec,this.dis=b.distance(this.pos,e)}setBais(t){this.bais=this.dis/t*(this.dis/t),this.bais=1/this.bais}}class He{constructor(){this._ready=!1,this.render=!0,this._displayList=new Array,this._displaySpriteList=new Array,this._displayRoleList=new Array,this._display2DList=new Array,this._sceneParticleList=new Array,this._time=T.getTimer(),this._sceneDic=new Object,this.initScene(),this.viewFrustum=new Ue}static getInstance(){return this._instance||(this._instance=new He),this._instance}get displayList(){return this._displayList}get displayRoleList(){return this._displayRoleList}get displaySpriteList(){return this._displaySpriteList}clearScene(){this._displayRoleList.length=0}clearStaticScene(){for(var t in this._sceneDic){var e=this._sceneDic[t];e instanceof Gt?(ae.getInstance().removeParticle(e),e.destory()):e instanceof le&&(e.removeStage(),e.destory())}this._ready=!1,this._sceneDic=null,this._sceneQuadTree=null,this._displayList.length=0,this._sceneParticleList.length=0,Xe.porcessBak(!1)}testUrl(t){return this._currentUrl==t}loadScene(t,e,i,a){if(this._currentUrl==t)return Xe.porcessBak(!0),this._ready=!0,e(),void a();this.clearStaticScene(),this._ready=!1,Be.getInstance().loadSceneRes(t,e,i,t=>{this.loadSceneConfigCom(t),a()}),this._currentUrl=t}getDisplayByID(t,e){return 0==t?this._sceneDic["build"+e]:1==t?this._sceneDic["particle"+e]:void 0}fixAstart(t){for(var e=0;e<this._displayRoleList.length;e++)this._displayRoleList[e].fixAstartData(t)}loadSceneConfigCom(t){this._sceneDic=new Object;var e=t.groundItem,i=t.buildItem;D.fogColor=[t.fogColor.x/255,t.fogColor.y/255,t.fogColor.z/255];var a=1*t.fogDistance,s=t.fogAttenuation;D.gameAngle=isNaN(t.gameAngle)?0:t.gameAngle,D.focus3D.rotationY=D.gameAngle,D.fogData=[a*s,1/((1-s)*a)],D.sceneNumId++;for(var r=0;e&&r<e.length;r++){var n=this.getGroundSprite(e[r],t.terrain);this.addDisplay(n)}for(var h=0;h<i.length;h++){var o=i[h];if(o.type==se.PREFAB_TYPE){var l=this.getBuildSprite(o);this.addDisplay(l)}else if(o.type==se.SCENE_PARTICLE_TYPE){var c=this.getParticleSprite(o);ae.getInstance().addParticle(c),this._sceneParticleList.push(c)}}D.light.setData(t.SunNrm,t.SunLigth,t.AmbientLight),Ye.getInstance().setLightProbeData(t.lightProbeItem),Xe.setData(t.astar),this._ready=!0,t.quadTreeData?(this._sceneQuadTree=new ke,this._sceneQuadTree.init(t.quadTreeData,this._sceneDic)):this._sceneQuadTree=null}getGroundSprite(t,e){var i=new pe;return i.setObjUrl(t.objsurl),i.setMaterialUrl(t.materialurl,t.materialInfoArr),i.materialInfoArr=t.materialInfoArr,i.setLightMapUrl(t.lighturl),i.scaleX=t.scaleX,i.scaleY=t.scaleY,i.scaleZ=t.scaleZ,i.x=t.x,i.y=t.y,i.z=t.z,i.rotationX=t.rotationX,i.rotationY=t.rotationY,i.rotationZ=t.rotationZ,i.objData.lightuvsOffsets=i.objData.uvsOffsets,e&&i.setGrounDataMesh(e[t.id]),this._sceneDic["ground"+t.id]=i,i}makeCollisioin(t){}set ready(t){this._ready=t}get ready(){return this._ready}getBuildSprite(t){var e=new le;return e.setObjUrl(t.objsurl),e.setMaterialUrl(t.materialurl,t.materialInfoArr),e.materialInfoArr=t.materialInfoArr,e.setLightMapUrl(t.lighturl),e.scaleX=t.scaleX,e.scaleY=t.scaleY,e.scaleZ=t.scaleZ,e.x=t.x,e.y=t.y,e.z=t.z,e.rotationX=t.rotationX,e.rotationY=t.rotationY,e.rotationZ=t.rotationZ,e.isPerspective=t.isPerspective,e.type=0,e.id=t.id,this._sceneDic["build"+t.id]=e,e}getParticleSprite(t){var e;return(e=ae.getInstance().getParticleByte(D.fileRoot+t.url)).scaleX=t.scaleX,e.scaleY=t.scaleY,e.scaleZ=t.scaleZ,e.x=t.x,e.y=t.y,e.z=t.z,e.rotationX=t.rotationX,e.rotationY=t.rotationY,e.rotationZ=t.rotationZ,e.type=0,this._sceneDic["particle"+t.id]=e,e}initScene(){}addDisplay(t){-1==this._displayList.indexOf(t)&&(this._displayList.push(t),t.addStage())}removeDisplay(t){var e=this._displayList.indexOf(t);-1!=e&&this._displayList.splice(e,1),t.removeStage()}addSpriteDisplay(t){if(-1==this._displaySpriteList.indexOf(t)){t.addStage();for(var e=0;e<this._displaySpriteList.length;e++)if(this._displaySpriteList[e].materialUrl==t.materialUrl)return void this._displaySpriteList.splice(e,0,t);this._displaySpriteList.push(t)}}removeSpriteDisplay(t){var e=this._displaySpriteList.indexOf(t);-1!=e&&this._displaySpriteList.splice(e,1),t.removeStage()}addMovieDisplay(t){this._displayRoleList.push(t),t.addStage()}addMovieDisplayTop(t){this._displayRoleList.unshift(t),t.addStage()}removeMovieDisplay(t){var e=this._displayRoleList.indexOf(t);-1!=e&&this._displayRoleList.splice(e,1),t.removeStage()}setParticleVisible(){for(var t=ae.getInstance().particleList,e=0;t&&e<t.length;e++)if(!t[e].dynamic&&t[e].bindVecter3d){var i=b.distance(new b(D.focus3D.x,D.focus3D.y,D.focus3D.z),new b(t[e].x,t[e].y,t[e].z));t[e].sceneVisible=i<1e3}}addDisplay2DList(t){this._display2DList.push(t)}mathCamFar(){for(var t=new b,e=0,i=0;i<this._displayList.length;i++){var a=this._displayList[i];if(a.sceneVisible&&a.aabb){a.posMatrix.clone().append(D.cam3D.cameraMatrix);for(var s=a.aabbVect,r=0;r<s.length;r++)(t=D.cam3D.cameraMatrix.transformVector(s[r])).z>e&&(e=t.z)}}D.camFar=Math.max(500,e+100),I.resetViewMatrx3D()}updateStaticDiplay(){for(var t=0;t<this._displayList.length;t++)this._displayList[t].update()}updateStaticBind(){}updateSpriteDisplay(){for(var t=0;t<this._displaySpriteList.length;t++)this._displaySpriteList[t].update()}renderShadow(){let t=D.context3D.renderContext;t.enable(t.STENCIL_TEST),t.clear(t.STENCIL_BUFFER_BIT),t.stencilMask(65535),t.clearStencil(65535),t.stencilFunc(t.EQUAL,65535,65535),t.stencilOp(t.KEEP,t.KEEP,t.ZERO),t.blendFunc(1,771);for(var e=0;e<this._displayRoleList.length;e++)this._displayRoleList[e].sceneVisible&&this._displayRoleList[e].renderAnimPlanarShadowAll();for(e=0;e<this._displaySpriteList.length;e++)this._displaySpriteList[e].sceneVisible&&this._displaySpriteList[e].renderShadow();t.disable(t.STENCIL_TEST)}updateMovieDisplay(){for(var t=0;t<this._displayRoleList.length;t++)this._displayRoleList[t].update();this._displayRoleList.length&&D.context3D.setVa(1,3,null)}updateMovieFrame(){var t=T.getTimer(),e=t-this._time;this._time=t;for(var i=0;i<this._displayRoleList.length;i++)this._displayRoleList[i].updateFrame(e)}}He.scaleWorld=new b(1,1,1);class qe{constructor(){this._currentDirect=new b}update(t){if(this.time=t,this.hasReached)return this.endTime+=t,void(this.endTime>200&&this.applyArrive());if(this.skillTrajectory.setCurrentPos()&&(this._currentDirect.x=this.currentTargetPos.x-this.currentPos.x,this._currentDirect.y=this.currentTargetPos.y-this.currentPos.y,this._currentDirect.z=this.currentTargetPos.z-this.currentPos.z,this._currentDirect.normalize(),this._currentDirect.scaleBy(this.speed),this.setRotationMatrix(this.currentTargetPos.subtract(this.currentPos)),0==this._currentDirect.length))this.arrive();else{var e=this._currentDirect.length*this.time;if(!this.hasReached){var i=b.distance(this.currentPos,this.currentTargetPos);this.currentPos.x+=this._currentDirect.x*this.time,this.currentPos.y+=this._currentDirect.y*this.time,this.currentPos.z+=this._currentDirect.z*this.time}e>i&&this.arrive()}}setRotationMatrix(t){t.normalize();var e=new b(0,0,1),i=e.cross(t);i.normalize();var a=Math.acos(t.dot(e)),s=new E;s.fromAxisAngle(i,a),s.toMatrix3D(this.rotationMatrix)}arrive(){this.hasReached=!0}applyArrive(){this.endFun(),this.bloodFun&&this.bloodFun()}reset(){this.hasReached=!1,this._currentDirect.setTo(0,0,0),this.endTime=0}add(){}setData(t,e,i,a,s,r){this.skillTrajectory=t,this.currentPos=i,this.rotationMatrix=a,this.currentTargetPos=s,this.endFun=e,this.bloodFun=r}}class Ke extends qe{constructor(){super(...arguments),this.basePos=new b}add(){this.skillTrajectory.setCurrentPos();var t=new b;t.x=this.currentTargetPos.x-this.currentPos.x,t.y=this.currentTargetPos.y-this.currentPos.y,t.z=this.currentTargetPos.z-this.currentPos.z,this.basePos.setTo(this.currentPos.x,this.currentPos.y,this.currentPos.z),this.alltime=t.length/this.speed}update(t){if(this.time=t,this.lastTime+=t,this.hasReached)return this.endTime+=t,void(this.endTime>200&&this.applyArrive());this.skillTrajectory.setCurrentPos();var e=this.lastTime/this.alltime;e>1&&(e=1);var i=this.getOffset(e);if(this._currentDirect.x=this.currentTargetPos.x-this.basePos.x,this._currentDirect.y=this.currentTargetPos.y-this.basePos.y,this._currentDirect.z=this.currentTargetPos.z-this.basePos.z,this._currentDirect.normalize(),this._currentDirect.scaleBy(this.speed),this.setRotationMatrix(this.currentTargetPos.subtract(this.basePos)),0!=this._currentDirect.length){var a=this._currentDirect.length*this.time;if(!this.hasReached){var s=b.distance(this.basePos,this.currentTargetPos);this.basePos.x+=this._currentDirect.x*this.time,this.basePos.y+=this._currentDirect.y*this.time,this.basePos.z+=this._currentDirect.z*this.time,this.setApplyPos(i)}a>s&&this.arrive()}else this.arrive()}setApplyPos(t){this.currentPos.x=this.basePos.x+t.x,this.currentPos.y=this.basePos.y+t.y,this.currentPos.z=this.basePos.z+t.z}getOffset(t){return t=100*Math.sin(t*Math.PI),this._currentDirect.cross(new b(0,1,0)).scaleBy(t),new b}reset(){super.reset(),this.lastTime=0}}class Qe extends Ke{getOffset(t){return t=300*(t-t*t),this._currentDirect.cross(new b(0,-1,0)).scaleBy(t),new b}}class Je{static reg(t,e){this.dic[t]=e}static getNewPath(t){return new(0,this.dic[t])}static init(){this.dic[0]=qe,this.dic[1]=Ke,this.dic[2]=Qe}}Je.dic=new Object;class $e{constructor(){this.time=0}addToRender(){this.particle&&(this.particle.reset(),this.particle.sceneVisible=!0,ae.getInstance().addParticle(this.particle))}setInfo(t){this.time=t.frame*D.frameTime,this.particle=ae.getInstance().getParticleByte(D.fileRoot+t.url)}reset(){this.particle.reset(),ae.getInstance().removeParticle(this.particle)}destory(){this.particle.destory(),this.particle=null,this.removeCallFun=null}}class ti extends $e{constructor(){super(),this._currentPos=new b,this.rotationMatrix=new V,this._socketMaxrix=new V,this._currentTargetPos=new b}getIsShadow(){return!1}update(t){this.path.update(t)}reset(){super.reset(),this.endParticle&&(ae.getInstance().addParticle(this.endParticle),this.endParticle.reset(),this.endParticle.setPos(this._currentTargetPos.x,this._currentTargetPos.y,this._currentTargetPos.z)),this.removeCallFun&&this.removeCallFun(this)}endPlayFun(t=null){ae.getInstance().removeParticle(this.endParticle),this.endParticle.removeEventListener(nt.COMPLETE,this.endPlayFun,this)}setCurrentPos(){if(this.data.hitSocket){var t=this.target;return t&&(t.getSocket(this.data.hitSocket,this._socketMaxrix),this._currentTargetPos.setTo(this._socketMaxrix.position.x,this._socketMaxrix.position.y,this._socketMaxrix.position.z)),!0}return(this._currentTargetPos.x!=this.target.x||this._currentTargetPos.y!=this.target.y||this._currentTargetPos.z!=this.target.z)&&(this._currentTargetPos.setTo(this.target.x,this.target.y,this.target.z),!0)}addToRender(){var t;if(super.addToRender(),0==this.data.beginType){var e=new V;e.appendRotation(this.active.rotationY,b.Y_AXIS),t=e.transformVector(this.data.beginPos),this._currentPos.setTo(this.active.x+t.x,this.active.y+t.y,this.active.z+t.z)}else if(1==this.data.beginType){var i=new V;this.active.getSocket(this.data.beginSocket,i),t=i.position,this._currentPos.setTo(t.x,t.y,t.z)}this.particle.setPos(this._currentPos.x,this._currentPos.y,this._currentPos.z),this.path.add()}getSocket(t,e){e.identity(),e.append(this.rotationMatrix),e.appendTranslation(this._currentPos.x,this._currentPos.y,this._currentPos.z)}getSunType(){return 0}setInfo(t){super.setInfo(t),this.particle.bindTarget=this,this.data=t,this.data.endParticleUrl&&(this.endParticle=ae.getInstance().getParticleByte(D.fileRoot+this.data.endParticleUrl),this.endParticle.addEventListener(nt.COMPLETE,this.endPlayFun,this))}setPlayData(t,e,i,a=0,s=null){this.active=t,this.target=e,this.removeCallFun=i,this._currentPos.setTo(0,0,0),this.rotationMatrix.identity(),this._socketMaxrix.identity(),this._currentTargetPos.setTo(0,0,0),this.path||(this.path=Je.getNewPath(2),this.path.setData(this,()=>{this.reset()},this._currentPos,this.rotationMatrix,this._currentTargetPos,s),this.path.speed=this.data.speed),this.path.reset()}destory(){super.destory(),this.active=null,this.target=null,this.data=null,this._currentPos=null,this.rotationMatrix=null,this._socketMaxrix=null,this._currentTargetPos=null,this.path=null}}class ei extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Pos"),t.bindAttribLocation(this.program,1,"v2uv")}getVertexShaderString(){return"attribute vec3 v3Pos;attribute vec3 v2uv;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform vec4 pos[30];varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(v2uv.x, v2uv.y);   vec3 vt1= vec3(v3Pos.xyz * pos[int(v2uv.z)].w + pos[int(v2uv.z)].xyz);   vec4 vt0= vec4(vt1, 1.0);   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"}getFragmentShaderString(){return" precision mediump float;\nuniform sampler2D s_texture;\nvarying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz *= infoUv.w;\ngl_FragColor = infoUv;\n}"}}ei.Display3DShadowShader="Display3DShadowShader";class ii extends U{constructor(){super(),this.needUpdate=!1,this.locationFloat32=new Float32Array(0),this.shadowList=new Array,this.objData=new $,this.shader=at.getInstance().getProgram(ei.Display3DShadowShader),this.program=this.shader.program,this.posProLocation=D.context3D.getLocation(this.program,"pos")}addShadow(t){this.shadowList.push(t),t.display=this,this.applyObjData()}removeShadow(t){var e=this.shadowList.indexOf(t);-1!=e&&(this.shadowList.splice(e,1),this.applyObjData()),this.shadowList.length}stateChage(){for(var t=0;t<this.shadowList.length&&!this.shadowList[t].visible;t++);t==this.shadowList.length?this.needUpdate=!1:this.needUpdate=!0}hasIdle(){return this.shadowList.length<30}applyObjData(){this.objData.vertices.length=0,this.objData.uvs.length=0,this.objData.indexs.length=0;for(var t=0;t<this.shadowList.length;t++)this.objData.vertices.push(-1,0,1,1,0,1,1,0,-1,-1,0,-1),this.objData.uvs.push(0,0,t,0,1,t,1,1,t,1,0,t),this.objData.indexs.push(4*t,1+4*t,2+4*t,4*t,2+4*t,3+4*t);this.objData.treNum=6*this.shadowList.length,this.objData.vertexBuffer?(D.context3D.uploadBuff3DByBuffer(this.objData.vertexBuffer,this.objData.vertices),D.context3D.uploadBuff3DByBuffer(this.objData.uvBuffer,this.objData.uvs),D.context3D.uploadIndexBuff3DByBuffer(this.objData.indexBuffer,this.objData.indexs)):(this.objData.vertexBuffer=D.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=D.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=D.context3D.uploadIndexBuff3D(this.objData.indexs))}update(){if(this.needUpdate&&0!=this.shadowList.length&&this.objData.treNum){D.context3D.setBlendParticleFactors(0),D.context3D.setProgram(this.program),D.context3D.setVcMatrix4fv(this.shader,"viewMatrix3D",D.viewMatrx3D.m),D.context3D.setVcMatrix4fv(this.shader,"camMatrix3D",D.cam3D.cameraMatrix.m),this.locationFloat32.length!=4*this.shadowList.length&&(this.locationFloat32=new Float32Array(4*this.shadowList.length));for(var t=0;t<this.shadowList.length;t++)this.shadowList[t].visible?(this.locationFloat32[4*t+0]=this.shadowList[t].data[0],this.locationFloat32[4*t+1]=this.shadowList[t].data[1],this.locationFloat32[4*t+2]=this.shadowList[t].data[2],this.locationFloat32[4*t+3]=this.shadowList[t].data[3]):(this.locationFloat32[4*t+0]=0,this.locationFloat32[4*t+1]=1e4,this.locationFloat32[4*t+2]=0,this.locationFloat32[4*t+3]=0);D.context3D.setVc4fvLocation(this.posProLocation,this.locationFloat32),D.context3D.setVa(0,3,this.objData.vertexBuffer),D.context3D.setVa(1,3,this.objData.uvBuffer),D.context3D.setRenderTexture(this.shader,"s_texture",ii.texture,0),D.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum)}}}class ai{constructor(){this._visible=!1,this.data=[0,0,0,5]}set visible(t){this._visible=t,this.display.stateChage()}get visible(){return this._visible}set x(t){this.data[0]=t}get x(){return this.data[0]}set y(t){this.data[1]=t}get y(){return this.data[1]}set z(t){this.data[2]=t}get z(){return this.data[2]}set size(t){this.data[3]=t}get size(){return this.data[3]}}class si{constructor(){this._displayList=new Array,at.getInstance().registe(ei.Display3DShadowShader,new ei)}static getInstance(){return this._instance||(this._instance=new si),this._instance}addShadow(){var t=this.getIdleShadow(),e=new ai;return t.addShadow(e),e}removeShadow(t){t.display.removeShadow(t)}update(){if(this._displayList.length){D.context3D.setWriteDepth(!1);for(var t=0;t<this._displayList.length;t++)this._displayList[t].update();D.context3D.setWriteDepth(!0)}}getIdleShadow(){for(var t=0;t<this._displayList.length;t++)if(this._displayList[t].hasIdle())return this._displayList[t];var e=new ii;return this._displayList.push(e),e}}class ri extends se{load(t,e){this._fun=e,X.getInstance().load(t,X.BYTE_TYPE,t=>{this.loadComplete(t)})}loadComplete(t){this.dataAry=new Array,this._byte=new A(t),this._byte.position=0,this.version=this._byte.readInt(),this.read(()=>{this.readNext()})}readNext(){if(this.read(),this.read(),this.read(),this._byte.readBoolean())for(var t=this._byte.readInt(),e=0;e<t;e++)this.readItem(!0);else this.readItem(!1);this._fun(),this._fun=null,this._byte=null}readItem(t){var e=this._byte.readInt(),i=new ni;i.isGroup=t,t&&(i.x=this._byte.readFloat(),i.y=this._byte.readFloat(),i.z=this._byte.readFloat(),i.scaleX=this._byte.readFloat(),i.scaleY=this._byte.readFloat(),i.scaleZ=this._byte.readFloat(),i.rotationX=this._byte.readFloat(),i.rotationY=this._byte.readFloat(),i.rotationZ=this._byte.readFloat()),e==se.PREFAB_TYPE?(i.objUrl=this._byte.readUTF(),i.materialUrl=this._byte.readUTF(),this.version>=4&&(i.materialInfoArr=this.readMaterialInfo()),i.types=se.PREFAB_TYPE):e==se.SCENE_PARTICLE_TYPE&&(i.particleUrl=this._byte.readUTF(),i.types=se.SCENE_PARTICLE_TYPE),this.dataAry.push(i)}initReg(){this._objDic=new Object,this._materialDic=new Object,this._particleDic=new Object;for(var t=0;t<this.dataAry.length;t++){var e=this.dataAry[t];e.objUrl&&(this._objDic[D.fileRoot+e.objUrl]=!0),e.materialUrl&&(this._materialDic[D.fileRoot+e.materialUrl]=!0),e.particleUrl&&(this._particleDic[D.fileRoot+e.particleUrl]=!0)}for(var i in this._objDic)he.getInstance().registerUrl(i);for(var i in this._materialDic)st.getInstance().registerUrl(i);for(var i in this._particleDic)ae.getInstance().registerUrl(i)}destory(){for(var t in super.destory(),this._objDic)he.getInstance().releaseUrl(t);for(var t in this._materialDic)st.getInstance().releaseUrl(t);for(var t in this._particleDic)ae.getInstance().releaseUrl(t);this.dataAry=null,this._objDic=null,this._particleDic=null,this._materialDic=null}}class ni extends k{}class hi extends j{constructor(){super(...arguments),this._loadDic=new Object}static getInstance(){return this._instance||(this._instance=new hi),this._instance}getGroupData(t,e){if(this._dic[t]){var i=this._dic[t];return i.useNum++,void e(i)}if(this._loadDic[t])this._loadDic[t].push(e);else{this._loadDic[t]=new Array,this._loadDic[t].push(e);var a=new ri;a.load(t,()=>{for(var e=this._loadDic[t],i=0;i<e.length;i++){(0,e[i])(a)}this._dic[t]=a,delete this._loadDic[t],a.initReg()})}}}class oi extends le{constructor(){super(),this._completeState=0,this._defaultAction="idle",this._curentFrame=0,this._actionTime=0,this._fileScale=1,this._hasDestory=!1,this._isSinging=!1,this.meshVisible=!0,this._isLoaded=!1,this._nextScale=1,this.isPauseAnim=!1,this.curActionTime=0,this.isEnableAnimPlanarShadow=!1,this.locationDic=new Object,this._animDic=new Object,this._partDic=new Object,this._partUrl=new Object,this._preLoadActionDic=new Object,this._waitLoadActionDic=new Object,this.showCapsule=!1,this._enablePhysics=!1}get isSinging(){return this._isSinging}set isSinging(t){this._isSinging=t}getIsShadow(){return this.isEnableAnimPlanarShadow}get curentAction(){return this._curentAction}set curentAction(t){this._curentAction=t}fixAstartData(t){}get isLoaded(){return this._isLoaded}setRoleUrl(t){this.clearMesh(),fe.getInstance().getMeshData(t,t=>{this._hasDestory?t.useNum--:(this._skinMesh=t,this.fileScale=t.fileScale,this.onStage&&this.addSkinMeshParticle(),this._animDic=t.animDic,this.onMeshLoaded(),this._isLoaded=!0)})}onMeshLoaded(){this.dispatchEvent(new nt(nt.COMPLETE))}clearMesh(){this._isLoaded=!1,this.removeSkinMeshParticle(),this._skinMesh&&this._skinMesh.useNum--,this._skinMesh=null,this._animDic=new Object}addSkinMeshParticle(){if(this._skinMesh){var t=new Array;this._partDic.mesh=t;var e=this._skinMesh.meshAry;if(e)for(var i=0;i<e.length;i++)for(var a=e[i].particleAry,s=0;s<a.length;s++){var r,n=a[s];(r=ae.getInstance().getParticleByte(D.fileRoot+n.url)).sourceData||console.log("particle.sourceData error"),r.dynamic=!0,r.bindSocket=n.socketName,t.push(r),r.bindTarget=this,ae.getInstance().addParticle(r)}}}removeSkinMeshParticle(){var t=this._partDic.mesh;if(t){for(var e=0;e<t.length;e++)ae.getInstance().removeParticle(t[e]),t[e].destory();this._partDic.mesh=null}}roleResCom(t,e){}setMeshUrl(t,e=1){this._meshUrl=D.fileRoot+t,fe.getInstance().getMeshData(this._meshUrl,t=>{for(var i in this._skinMesh=t,1!=e&&(this._skinMesh.type=1),this._animDic)this.processAnimByMesh(this._animDic[i]);t.loadMaterial(t=>{this.loadMaterialCom(t)}),this.fileScale=t.fileScale},e)}set scale(t){this._nextScale=t,this._scaleX=t*this._fileScale,this._scaleY=t*this._fileScale,this._scaleZ=t*this._fileScale,this.updateMatrix()}get scale(){return this._nextScale}set fileScale(t){this._fileScale=t,this._scaleX=this._nextScale*t,this._scaleY=this._nextScale*t,this._scaleZ=this._nextScale*t,this.updateMatrix()}set shadow(t){t?this._shadow||(this._shadow=si.getInstance().addShadow()):this._shadow&&si.getInstance().removeShadow(this._shadow)}setShadowSize(t){this._shadow&&(this._shadow.size=t)}addStage(){super.addStage(),this.addSkinMeshParticle(),this._shadow&&(this._shadow.visible=!0)}removeStage(){for(var t in super.removeStage(),this._shadow&&si.getInstance().removeShadow(this._shadow),this._partDic)for(var e=this._partDic[t],i=0;i<e.length;i++)e[i]instanceof Gt?ae.getInstance().removeParticle(e[i]):e[i]instanceof le&&He.getInstance().removeSpriteDisplay(e[i])}loadMaterialCom(t){t.lightProbe&&(this.lightProbe=!0)}setCollision(t,e){}applyVisible(){}removePart(t){var e=this._partDic[t];if(e){for(var i=0;i<e.length;i++)e[i]instanceof Gt?(ae.getInstance().removeParticle(e[i]),e[i].destory()):e[i]instanceof le&&(He.getInstance().removeSpriteDisplay(e[i]),e[i].destory());this._partDic[t]=null,this._partUrl[t]=null,delete this._partDic[t],delete this._partUrl[t]}}addPart(t,e,i){if(this._partUrl[t]!=i){this._partUrl[t]&&this.removePart(t),this._partDic[t]||(this._partDic[t]=new Array),this._partUrl[t]=i;var a=this._partDic[t];hi.getInstance().getGroupData(D.fileRoot+i,t=>{this.loadPartRes(e,t,a)})}}loadPartRes(t,e,i){if(!this._hasDestory){for(var a=0;a<e.dataAry.length;a++){var s,r,n,h=e.dataAry[a];if(h.isGroup&&(s=new b(h.x,h.y,h.z),r=new b(h.rotationX,h.rotationY,h.rotationZ),n=new b(h.scaleX,h.scaleY,h.scaleZ)),h.types==se.SCENE_PARTICLE_TYPE){var o=ae.getInstance().getParticleByte(D.fileRoot+h.particleUrl);i.push(o),o.bindTarget=this,o.bindSocket=t,o.dynamic=!0,ae.getInstance().addParticle(o),h.isGroup&&o.setGroup(s,r,n)}else if(h.types==se.PREFAB_TYPE){var l=new le;l.setObjUrl(h.objUrl),l.setMaterialUrl(h.materialUrl,h.materialInfoArr),l.dynamic=!0,i.push(l),l.setBind(this,t),He.getInstance().addSpriteDisplay(l),h.isGroup&&l.setGroup(s,r,n)}}this.applyVisible()}}_getSocket(t,e){if(e.identity(),this._skinMesh){if(!this._skinMesh.boneSocketDic)return console.log("this._skinMesh.boneSocketDic:",this._skinMesh.boneSocketDic,t),void e.append(this.posMatrix);if(this._skinMesh.boneSocketDic[t]){var i,a=this._skinMesh.boneSocketDic[t],s=a.index;i=this.getFrameMatrix(s),e.appendScale(1/this._scaleX,1/this._scaleY,1/this._scaleZ),e.appendRotation(a.rotationX,b.X_AXIS),e.appendRotation(a.rotationY,b.Y_AXIS),e.appendRotation(a.rotationZ,b.Z_AXIS),e.appendTranslation(a.x,a.y,a.z),i&&(e.append(this._skinMesh.meshAry[this._skinMesh.meshAry.length-1].bindPosInvertMatrixAry[s]),e.append(i))}else"none"==t?e.appendTranslation(this._x,this._y,this._z):e.append(this.posMatrix)}else e.append(this.posMatrix)}getSocket(t,e){this._getSocket(t,e),e.append(this.getOrgPosMatrix())}getSocketByScale(t,e){this._getSocket(t,e),e.append(this.posMatrix)}getSunType(){return 0}getFrameMatrix(t){if(this._animDic[this.curentAction]){var e=this._animDic[this.curentAction];return this._curentFrame>=e.matrixAry.length?e.matrixAry[0][t]:e.matrixAry[this._curentFrame][t]}return this._animDic[this._defaultAction]?(e=this._animDic[this._defaultAction]).matrixAry[this._curentFrame][t]:null}addAction(t,e,i=!1){this._preLoadActionDic[t]=e,(t==this._defaultAction||t==this.curentAction||i)&&this.setAnimUrl(t,e)}setAnimUrl(t,e){this._waitLoadActionDic[t]=!0,ye.getInstance().getAnimData(e,e=>{this._animDic[t]=e,this.processAnimByMesh(e),this._waitLoadActionDic[t]=!1})}play(t,e=0,i=!0){if(this.curentAction!=t)return this.curentAction=t,this._completeState=e,this._actionTime=0,this.curActionTime=0,this.updateFrame(0),!!this._animDic.hasOwnProperty(t)||(!this._waitLoadActionDic[t]&&this._preLoadActionDic[t]&&this.setAnimUrl(t,this._preLoadActionDic[t]),!1)}processAnimByMesh(t){if(this._skinMesh&&!t.hasProcess){for(var e=0;e<t.matrixAry.length;e++)for(var i=t.matrixAry[e],a=0;a<i.length;a++)i[a].prepend(this._skinMesh.meshAry[0].bindPosMatrixAry[a]);t.hasProcess=!0}}update(){if(this._skinMesh){if(this.lightProbe&&(this.resultSHVec=Ye.getInstance().getData(new b(this.x,this.y+10,this.z))),this.updateBind(),this.meshVisible)for(var t=0;t<this._skinMesh.meshAry.length;t++)this.updateMaterialMesh(this._skinMesh.meshAry[t]);this.showCapsule&&this.updateShowCapsule()}}get pauseAnim(){return this.isPauseAnim}set pauseAnim(t){this.isPauseAnim=t}get animNormalizerTime(){var t;if(this.curentAction&&this._animDic[this.curentAction])t=this.curentAction;else{if(!this._animDic[this._defaultAction])return-1;t=this._defaultAction}var e=this._animDic[t];return M.float2int(this.curActionTime/(2*D.frameTime))/e.matrixAry.length}updateFrame(t){if(!this.isPauseAnim){var e;if(this._actionTime+=t,this.curActionTime+=t,this.curentAction&&this._animDic[this.curentAction])e=this.curentAction;else{if(!this._animDic[this._defaultAction])return;e=this._defaultAction}var i=this._animDic[e];this._curentFrame=M.float2int(this._actionTime/(2*D.frameTime)),this._curentFrame>=i.matrixAry.length&&(0==this._completeState?(this._actionTime=0,i.inLoop&&(this.curActionTime=0),this._curentFrame=0):1==this._completeState?(this._curentFrame=i.matrixAry.length-1,this.dispatchEvent(new nt(nt.COMPLETE))):2==this._completeState?(this._curentFrame=0,this._completeState=0,this.changeAction(this.curentAction),this.dispatchEvent(new nt(nt.COMPLETE))):this._completeState)}}changeAction(t){this.curentAction=this._defaultAction}destory(){for(var t in super.destory(),this._skinMesh&&this._skinMesh.useNum--,this._partDic)for(var e=this._partDic[t],i=0;i<e.length;i++)(e[i]instanceof Gt||e[i]instanceof le)&&e[i].destory();this._partDic=null,this._hasDestory=!0}updateShowCapsule(){this.capsuleLineSprite?(this.capsuleLineSprite.x=this.x,this.capsuleLineSprite.y=this.y+this._capsule.radius,this.capsuleLineSprite.z=this.z,this.capsuleLineSprite.update()):(this.capsuleLineSprite=new Ne,this.capsuleLineSprite.clear(),this.capsuleLineSprite.baseColor=new b(1,0,0,1),this.drawCylinder(this._capsule.radius,this._capsule.height),this.drawBall(this._capsule.radius),this.capsuleLineSprite.upToGpu())}drawBall(t){var e,i,a,s,r,n,h,o=t;for(r=0;r<=12;r++)for(a=null,s=6;s<12;s++)e=new b(o,0,0),(i=new V).appendRotation(30*s,b.Z_AXIS),e=i.transformVector(e),(n=new V).appendRotation(30*r,b.Y_AXIS),e=n.transformVector(e),a&&this.capsuleLineSprite.makeLineMode(a,e),a=e.clone();for(r=1;r<=4;r++)for((n=new V).appendRotation(-20*r,b.Z_AXIS),h=n.transformVector(new b(o,0,0)),a=null,s=0;s<12;s++)e=h.clone(),(i=new V).appendRotation(30*s,b.Y_AXIS),e=i.transformVector(e),a&&this.capsuleLineSprite.makeLineMode(a,e),11==s&&this.capsuleLineSprite.makeLineMode(h,e),a=e.clone()}drawCylinder(t,e){var i,a,s,r=t,n=e;for(s=0;s<12;s++){var h=new b(r,0,0),o=new b(r,+n,0),l=new V;l.appendRotation(30*s,b.Y_AXIS);var c=l.transformVector(h),d=l.transformVector(o);this.capsuleLineSprite.makeLineMode(c,d),this.capsuleLineSprite.makeLineMode(d,new b(0,+n,0)),11==s&&(this.capsuleLineSprite.makeLineMode(c,h),this.capsuleLineSprite.makeLineMode(d,o)),(i||a)&&(this.capsuleLineSprite.makeLineMode(c,i),this.capsuleLineSprite.makeLineMode(d,a)),i=c.clone(),a=d.clone()}}setVcMatrix(t){D.context3D.setVpMatrix(t.material.shader,D.vpMatrix.m),this.updateMatrix(),D.context3D.setVcMatrix4fv(t.material.shader,"posMatrix3D",this.posMatrix.m)}setVa(t){this.setVaCompress(t)}setVaCompress(t){t._bufferState.bind()}clearVa(){}makeAnimPlanarShadowShader(){var t=new z;return t.encode()||console.log("make anim planar shadow shader failed !"),t}set enableAnimPlaranShadow(t){this.isEnableAnimPlanarShadow=t}renderPlanarShadow(t){D.context3D.setProgram(F.getInst().program),D.context3D.setVcMatrix4fv(F.getInst(),"uMProjCameraMatrix",new Float32Array(D.vpMatrix.m));let e=new V;e.identity(),e.appendScale(this._scaleX*He.scaleWorld.x,this._scaleY*He.scaleWorld.y,this._scaleZ*He.scaleWorld.z),e.appendRotation(-45,b.Y_AXIS),e.appendTranslation(this._x*He.scaleWorld.x,this._y*He.scaleWorld.x,this._z*He.scaleWorld.x),D.context3D.setVcMatrix4fv(F.getInst(),"uMMatrix",e.m),D.context3D.setVc3fv(F.getInst(),"uLightLocation",F.getLightPosArry(this.posMatrix)),this.setVa(t),D.context3D.drawCallL3d(t.treNum),t._bufferState.unBind()}isRenderAnimPlanarShadow(){return!(!this.bindTarget||!this.bindTarget.getIsShadow())||this.isEnableAnimPlanarShadow}renderAnimPlanarShadow(t){if(!this.isRenderAnimPlanarShadow())return;let e=t.material.program,i=t.material.shader;oi.animPlanarShadowShader||(oi.animPlanarShadowShader=this.makeAnimPlanarShadowShader()),t.material.shader=oi.animPlanarShadowShader,t.material.program=oi.animPlanarShadowShader.program,D.context3D.setProgram(t.material.program),D.context3D.cullFaceBack(!1),this.setMeshVc(t),this.setMaterialVc(t.material,t.materialParam),D.context3D.setVcMatrix4fv(oi.animPlanarShadowShader,"uMProjCameraMatrix",new Float32Array(D.vpMatrix.m)),this.updateMatrix(),D.context3D.setVcMatrix4fv(oi.animPlanarShadowShader,"uMMatrix",this.posMatrix.m),D.context3D.setVc3fv(oi.animPlanarShadowShader,"uLightLocation",F.getLightPosArry(this.posMatrix)),this.setVa(t),D.context3D.drawCallL3d(t.treNum),t._bufferState.unBind(),t.material.program=e,t.material.shader=i}updateMaterialMesh(t){t.material&&(D.context3D.setProgram(t.material.program),D.context3D.cullFaceBack(!1),D.context3D.setBlendParticleFactors(t.material.blendMode),this.setVcMatrix(t),this.setMaterialVc(t.material,t.materialParam),this.setMaterialTexture(t.material,t.materialParam),this.setVa(t),this.setDirectLight(t.material),this.setMeshVc(t),D.context3D.drawCallL3d(t.treNum),t._bufferState.unBind())}renderAnimPlanarShadowAll(){if(this.meshVisible&&this._skinMesh&&this._skinMesh.meshAry)for(var t=0;t<this._skinMesh.meshAry.length;t++)this.renderAnimPlanarShadow(this._skinMesh.meshAry[t])}setLightProbeVc(t){if(t.lightProbe)for(var e=0;e<this.resultSHVec.length;e++)D.context3D.setVc3fv(t.shader,"sh["+e+"]",[this.resultSHVec[e].x,this.resultSHVec[e].y,this.resultSHVec[e].z])}setMeshVc(t){var e;if(this._animDic[this.curentAction])e=this._animDic[this.curentAction];else{if(!this._animDic[this._defaultAction])return;e=this._animDic[this._defaultAction]}var i=e.getBoneQPAryByMesh(t)[t.uid][this._curentFrame];i&&(D.context3D.setVc4fv(t.material.shader,"boneQ",i.quat),D.context3D.setVc3fv(t.material.shader,"boneD",i.pos))}setPos(t){super.setPos(t),this._shadow&&(this._shadow.x=t.x,this._shadow.y=t.y+8,this._shadow.z=t.z)}set x(t){this._x=t,this.updateMatrix(),this._shadow&&(this._shadow.x=t),this.changePos()}get x(){return this._x}set y(t){this._y=t,this.updateMatrix(),this._shadow&&(this._shadow.y=t),this.changePos()}get y(){return this._y}set z(t){this._z=t,this.updateMatrix(),this._shadow&&(this._shadow.z=t),this.changePos()}get z(){return this._z}changePos(){}}class li extends $e{addToRender(){super.addToRender(),this.particle.addEventListener(nt.COMPLETE,this.onPlayCom,this)}onPlayCom(t=null){this.particle.removeEventListener(nt.COMPLETE,this.onPlayCom,this),ae.getInstance().removeParticle(this.particle),this.removeCallFun(this)}}class ci{getIsShadow(){return!1}getSocket(t,e){this.bindMatrix.clone(e)}getSunType(){return 1}}class di extends li{setInfo(t){super.setInfo(t);var e=t;this.pos=e.pos,this.rotation=e.rotation,this.hasSocket=e.hasSocket,this.socket=e.socket}addToRender(){if(super.addToRender(),this.outPos)this.particle.x=this.outPos.x,this.particle.y=this.outPos.y,this.particle.z=this.outPos.z,this.particle.rotationX=this.rotation.x,this.particle.rotationY=this.rotation.y+this.active.rotationY,this.particle.rotationZ=this.rotation.z,this.particle.bindTarget=null;else if(this.hasSocket){var t=this.active;this.particle.bindTarget=t,this.particle.bindSocket=this.socket}else{var e=new V;e.appendRotation(this.active.rotationY,b.Y_AXIS);var i=e.transformVector(this.pos);i.x+=this.active.x,i.y+=this.active.y,i.z+=this.active.z;var a=new ci;a.bindMatrix=new V,a.bindMatrix.appendRotation(this.rotation.x,b.X_AXIS),a.bindMatrix.appendRotation(this.rotation.y,b.Y_AXIS),a.bindMatrix.appendRotation(this.rotation.z,b.Z_AXIS),a.bindMatrix.appendRotation(this.active.rotationY,b.Y_AXIS),a.bindMatrix.appendTranslation(i.x,i.y,i.z),this.particle.bindTarget=a}}}class ui extends ti{update(t){this.pathMul.update(t)}getSunType(){return 1}addToRender(){if(this.particle){if(this.particle.reset(),ae.getInstance().addParticle(this.particle),this.currentPosList)for(t=0;t<this.activeList.length;t++)this.currentPosList[t].setTo(this.activeList[t].x,this.activeList[t].y+10,this.activeList[t].z+5),this.currentPosList[t].w=0;else{this.currentPosList=new Array;for(var t=0;t<this.activeList.length;t++)this.currentPosList.push(new b(this.activeList[t].x,this.activeList[t].y+10,this.activeList[t].z+5));this.pathMul.setInitCurrentPos(this.currentPosList)}this.pathMul.add(),this.particle.setMulPos(this.pathMul.resultAry)}}setMulPlayData(t,e,i,a=0){this.activeList=t,this.active=this.activeList[0],this.target=e,this.removeCallFun=i,this._currentPos.setTo(0,0,0),this.rotationMatrix.identity(),this._socketMaxrix.identity(),this._currentTargetPos.setTo(0,0,0),this.pathMul||(this.pathMul=Je.getNewPath(a),this.pathMul.setData(this,()=>{this.reset()},this._currentPos,this.rotationMatrix,this._currentTargetPos),this.pathMul.speed=this.data.speed),this.pathMul.reset()}getMulSocket(t){t&&this.pathMul.applyData(t)}}class mi{constructor(){this.init=!1,this._volume=1,this._skillSoundDic=new Object,this._skillVolume=1}static getInstance(){return this._instance||(this._instance=new mi),this._instance}playSound(){this.initSound(),this.audio.play()}initSound(){this.init||(this.audio=new Audio(D.fileRoot+"sound/sound_3521.mp3"),this.audio.loop=!0,this.audio.volume=this._volume,this.audio.play(),this.init=!0)}stopSound(){this.audio&&this.audio.pause()}setVolume(t){this._volume=t,this._volume>0?this.playSound():this.stopSound(),this.audio&&(this.audio.volume=this._volume)}setSkillVolume(t){for(var e in this._skillVolume=t,this._skillSoundDic)this._skillSoundDic[e].volume=this._skillVolume}playSkillSound(t){if(!(this._skillVolume<=0))if(this._skillSoundDic[t])this._skillSoundDic[t].play();else{var e=new Audio(D.fileRoot+"skill/sound/"+t);e.loop=!1,e.volume=this._skillVolume,e.play(),this._skillSoundDic[t]=e}}}class pi extends L{constructor(){super(),this.isDeath=!0,this.src=!1,this.time=0,this.targetFlag=0,this.targetShockFlag=0,this.needSound=!1,this.hasDestory=!1,this.actionEnd=!1}setData(t,e){this.hasDestory||(this.skillVo=new Te,this.skillVo.setData(t),this.setKeyAry(),this.trajectoryAry=new Array,this._skillData=e)}getBloodTime(){return this.skillVo?this.skillVo.bloodTime:Te.defaultBloodTime}play(){this.skillVo?this.active&&this.active instanceof oi&&this.active.play(this.skillVo.action,this.actionEnd?1:2,!1):this.skillComplete()}setKeyAry(){if(this.keyAry=new Array,this.skillVo.types==Se.FixEffect)for(var t=0;t<this.skillVo.keyAry.length;t++){var e=new di;e.setInfo(this.skillVo.keyAry[t]),e.removeCallFun=t=>{this.removeKey(t)},e.active=this.active,this.keyAry.push(e)}else if(this.skillVo.types==Se.TrajectoryDynamicTarget||this.skillVo.types==Se.TrajectoryDynamicPoint)for(t=0;t<this.skillVo.keyAry.length;t++){var i;(i=1==this.skillVo.keyAry[t].multype?new ui:new ti).setInfo(this.skillVo.keyAry[t]),this.keyAry.push(i)}}removeKey(t){this.completeNum++,this.completeNum==this.keyAry.length&&this.skillComplete()}removeSkillForce(){if(this.keyAry)for(var t=0;t<this.keyAry.length;t++)this.keyAry[t].reset();this.skillComplete(),this.reset()}skillComplete(){xi.getInstance().removeSkill(this),this.isDeath=!0,this.completeFun&&this.completeFun(),this.idleTime=0}reset(){this.time=0,this.completeNum=0,this.active=null,this.completeFun=null,this.targetFlag=0,this.targetShockFlag=0,this.soundPlay=!1,this.needSound=!1}update(t){this.time+=t,this.time>pi.MaxTime&&this.skillComplete(),this.getKeyTarget(),this.getShockTarget(),this.updateTrajector(t)}updateTrajector(t){for(var e=0;e<this.trajectoryAry.length;e++)this.trajectoryAry[e].update(t)}getKeyTarget(){if(this.keyAry){for(var t=this.targetFlag;t<this.keyAry.length&&this.keyAry[t].time<this.time;t++){if(this.keyAry[t].addToRender(),this.skillVo.types==Se.TrajectoryDynamicTarget||this.skillVo.types==Se.TrajectoryDynamicPoint){var e=this.keyAry[t];this.trajectoryAry.push(e)}t++,this.targetFlag=t}this.getSound()}}getShockTarget(){if(this.skillVo.shockAry&&this.needSound)for(var t=this.targetShockFlag;t<this.skillVo.shockAry.length&&this.skillVo.shockAry[t].time<this.time;t++)vi.getInstance().shock(this.skillVo.shockAry[t].lasttime,this.skillVo.shockAry[t].amp),t++,this.targetShockFlag=t}getSound(){this.skillVo.sound&&!this.soundPlay&&this.needSound&&this.skillVo.sound.frame<this.time&&(mi.getInstance().playSkillSound(this.skillVo.sound.url),this.soundPlay=!0)}configFixEffect(t,e=null,i=null){if(this.active=t,this.completeFun=e,this.keyAry)for(var a=0;a<this.keyAry.length;a++)if(this.skillVo.types==Se.FixEffect){var s=this.keyAry[a];s.active=t,i&&i.length?a>i.length-1?s.outPos=i[i.length-1]:s.outPos=i[a]:s.outPos=null}}configTrajectory(t,e,i=null,a=0,s=null){if(this.active=t,this.completeFun=i,this.completeNum=0,this.keyAry)for(var r=0;r<this.keyAry.length;r++){if(this.skillVo.types==Se.TrajectoryDynamicTarget||this.skillVo.types==Se.TrajectoryDynamicPoint)this.keyAry[r].setPlayData(t,e,t=>{this.removeTrajectory(t)},a,0==r?s:null)}}configMulTrajectory(t,e,i,a=null){if(this.active=e,this.completeFun=a,this.completeNum=0,this.keyAry)for(var s=0;s<this.keyAry.length;s++){if(this.skillVo.types==Se.TrajectoryDynamicTarget)this.keyAry[s].setMulPlayData(t,i,t=>{this.removeTrajectory(t)},2)}}removeTrajectory(t){var e=this.trajectoryAry.indexOf(t);-1!=e&&this.trajectoryAry.splice(e,1),this.completeNum++,this.completeNum==this.keyAry.length&&this.skillComplete()}destory(){if(this.skillVo=null,this.name=null,this.keyAry){for(var t=0;t<this.keyAry.length;t++)this.keyAry[t].destory();this.keyAry.length=0,this.keyAry=null}if(this.active=null,this.completeFun=null,this.trajectoryAry){for(t=0;t<this.trajectoryAry.length;t++)this.trajectoryAry[t].destory();this.trajectoryAry.length=0,this.trajectoryAry=null}this._skillData&&this._skillData.useNum--,this._skillData=null,this.hasDestory=!0}}pi.MaxTime=5e3;class yi extends L{constructor(){super(...arguments),this.srcList=new Array}addSrcSkill(t){this.srcList.push(t)}destory(){for(var t=0;t<this.srcList.length;t++)this.srcList[t].destory(),xi.getInstance().gcSkill(this.srcList[t])}testDestory(){for(var t=0;t<this.srcList.length;t++)if(!(this.srcList[t].isDeath&&this.srcList[t].idleTime>=L.GCTime))return!1;return!0}}class xi extends j{constructor(){super(),this._time=0,this._skillDic=new Object,this._loadDic=new Object,this._skillAry=new Array,this._preLoadDic=new Object}static getInstance(){return this._instance||(this._instance=new xi),this._instance}update(){for(var t=T.getTimer(),e=t-this._time,i=0;i<this._skillAry.length;i++)this._skillAry[i].update(e);this._time=t}preLoadSkill(t){this._dic[t]||this._preLoadDic[t]||(Be.getInstance().loadSkillRes(D.fileRoot+t,e=>{var i=new yi;i.data=e.data,i.useNum++,this._dic[t]=i,this.addSrc(t,i)}),this._preLoadDic[t]=!0)}getSkill(t,e,i=null){var a,s,r=t+e,n=this._skillDic[r];if(n)for(var h=0;h<n.length;h++)if((a=n[h]).isDeath&&0==a.useNum)return a.reset(),a.isDeath=!1,a;return(a=new pi).name=e,a.isDeath=!1,this._skillDic[r]||(this._skillDic[r]=new Array),this._skillDic[r].push(a),this._dic[t]?(a.setData(this._dic[t].data[a.name],this._dic[t]),a.key=r,this._dic[t].useNum++,a):this._loadDic[t]?((s=new Object).name=e,s.skill=a,s.callback=i,this._loadDic[t].push(s),a):(this._loadDic[t]=new Array,(s=new Object).name=e,s.skill=a,s.callback=i,this._loadDic[t].push(s),Be.getInstance().loadSkillRes(D.fileRoot+t,e=>{this.loadSkillCom(t,e)}),a)}loadSkillCom(t,e){var i=new yi;i.data=e.data;for(var a=0;a<this._loadDic[t].length;a++){(s=this._loadDic[t][a]).skill.hasDestory||(s.skill.setData(i.data[s.name],i),s.skill.key=t+s.name,i.useNum++)}this._dic[t]=i,this.addSrc(t,i);for(a=0;a<this._loadDic[t].length;a++){var s;(s=this._loadDic[t][a]).callback&&s.callback()}this._loadDic[t].length=0,this._loadDic[t]=null}addSrc(t,e){for(var i in e.data){var a=new pi;a.name=i,a.isDeath=!0,a.src=!0,a.setData(e.data[i],e),e.addSrcSkill(a);var s=t+i;this._skillDic[s]||(this._skillDic[s]=new Array),this._skillDic[s].push(a)}}playSkill(t){this._skillAry.push(t),t.play()}removeSkill(t){var e=this._skillAry.indexOf(t);-1!=e&&this._skillAry.splice(e,1)}gcSkill(t){for(var e in this._skillDic){var i=this._skillDic[e],a=i.indexOf(t);-1!=a&&i.splice(a,1)}}gc(){for(var t in this._dic){var e=this._dic[t];e.useNum<=0&&(e.idleTime++,e.idleTime>=L.GCTime&&e.testDestory()&&(e.destory(),delete this._dic[t]))}for(var t in this._skillDic){for(var i=this._skillDic[t],a=i.length-1;a>=0;a--)i[a].isDeath&&i[a].useNum<=0&&(i[a].idleTime++,i[a].idleTime>=L.GCTime&&(i[a].src||(i[a].destory(),i.splice(a,1))));0==i.length&&delete this._skillDic[t]}}}class vi{constructor(){this.upFun=t=>{this.update(t)}}static getInstance(){return this._instance||(this._instance=new vi),this._instance}update(t){if(this.ctime+=t,this.ctime>this.time)return T.removeFrameTick(this.upFun),void D.cam3D.offset.setTo(0,0,0);var e=(Math.random()-.5)*this.amp,i=(Math.random()-.5)*this.amp,a=(Math.random()-.5)*this.amp;D.cam3D.offset.setTo(e,i,a)}shock(t,e){this.time=t,this.ctime=0,this.amp=e,T.addFrameTick(this.upFun)}}class gi extends He{constructor(){super()}static initConfig(){He._instance=new gi}update(){Ee.getCamView(D.cam3D,D.focus3D),D.context3D._contextSetTest.clear(),isNaN(this._time)&&(this._time=T.getTimer()),this.updateMovieFrame(),this._ready&&(ae.getInstance().updateTime(),xi.getInstance().update(),this.render&&(D.context3D.cullFaceBack(!1),D.context3D.cullFaceBack(!0),D.context3D.cullFaceBack(!0),D.context3D.setWriteDepth(!0),D.context3D.setDepthTest(!0),this.updateStaticDiplay(),this.updateSpriteDisplay(),this.updateMovieDisplay(),D.context3D.setWriteDepth(!1),ae.getInstance().update(),D.context3D.setBlendParticleFactors(0),D.context3D.setWriteDepth(!0)),D.context3D.setDepthTest(!1))}}class _i extends ae{constructor(){super()}getParticleByte(t){t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt");var e=new Gt,i=t;if(ae.getInstance()._dic[i]){var a=ae.getInstance()._dic[i];e=a.getCombineParticle()}else X.getInstance().load(i,X.BYTE_TYPE,t=>{var i=new A(t);e.setDataByte(i)});return e.url=i,e}registerUrl(t){(t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),ae.getInstance()._dic[t])&&ae.getInstance()._dic[t].useNum++}releaseUrl(t){(t=(t=t.replace("_byte.txt",".txt")).replace(".txt","_byte.txt"),ae.getInstance()._dic[t])&&ae.getInstance()._dic[t].clearUseNum()}addResByte(t,e){if(!ae.getInstance()._dic[t]){var i=new ie;i.setDataByte(e),ae.getInstance()._dic[t]=i}}}class fi extends di{constructor(t){super(),this.skill=t}onPlayCom(t=null){this.particle.removeEventListener(nt.COMPLETE,this.onPlayCom,this),this.skill.skillManager.sceneManager.particleManager.removeParticle(this.particle),this.removeCallFun(this)}addToRender(){if(this.particle)if(this.particle.reset(),this.particle.sceneVisible=!0,this.skill.skillManager.sceneManager.particleManager.addParticle(this.particle),this.particle.addEventListener(nt.COMPLETE,this.onPlayCom,this),this.outPos)this.particle.x=this.outPos.x,this.particle.y=this.outPos.y,this.particle.z=this.outPos.z,this.particle.rotationX=this.rotation.x,this.particle.rotationY=this.rotation.y+this.active.rotationY,this.particle.rotationZ=this.rotation.z,this.particle.bindTarget=null;else if(this.hasSocket){var t=this.active;this.particle.bindTarget=t,this.particle.bindSocket=this.socket}else{var e=new V;e.appendRotation(this.active.rotationY,b.Y_AXIS);var i=e.transformVector(this.pos);i.x+=this.active.x,i.y+=this.active.y,i.z+=this.active.z;var a=new ci;a.bindMatrix=new V,a.bindMatrix.appendRotation(this.rotation.x,b.X_AXIS),a.bindMatrix.appendRotation(this.rotation.y,b.Y_AXIS),a.bindMatrix.appendRotation(this.rotation.z,b.Z_AXIS),a.bindMatrix.appendRotation(this.active.rotationY,b.Y_AXIS),a.bindMatrix.appendTranslation(i.x,i.y,i.z),this.particle.bindTarget=a}}}class Di extends ti{reset(){this.particle.reset(),this.skill.skillManager.sceneManager.particleManager.removeParticle(this.particle),this.endParticle&&(this.endParticle.reset(),this.skill.skillManager.sceneManager.particleManager.addParticle(this.endParticle),this.endParticle.setPos(this._currentTargetPos.x,this._currentTargetPos.y,this._currentTargetPos.z)),this.removeCallFun&&this.removeCallFun(this)}addToRender(){if(this.particle){var t;if(this.particle.reset(),this.particle.sceneVisible=!0,this.skill.skillManager.sceneManager.particleManager.addParticle(this.particle),0==this.data.beginType){var e=new V;e.appendRotation(this.active.rotationY,b.Y_AXIS),t=e.transformVector(this.data.beginPos),this._currentPos.setTo(this.active.x+t.x,this.active.y+t.y,this.active.z+t.z)}else if(1==this.data.beginType){var i=new V;this.active.getSocket(this.data.beginSocket,i),t=i.position,this._currentPos.setTo(t.x,t.y,t.z)}this.particle.setPos(this._currentPos.x,this._currentPos.y,this._currentPos.z),this.path.add()}}endPlayFun(t=null){this.skill.skillManager.sceneManager.particleManager.removeParticle(this.endParticle),this.endParticle.removeEventListener(nt.COMPLETE,this.endPlayFun,this)}setInfo(t){this.time=t.frame*D.frameTime,this.particle=this.skill.skillManager.sceneManager.particleManager.getParticleByte(D.fileRoot+t.url),this.particle.bindTarget=this,this.data=t,this.data.endParticleUrl&&(this.endParticle=this.skill.skillManager.sceneManager.particleManager.getParticleByte(D.fileRoot+this.data.endParticleUrl),this.endParticle.addEventListener(nt.COMPLETE,this.endPlayFun,this))}}class bi extends pi{constructor(t=null){super(),this.baseName="OverrideSkill",this.skillManager=t}skillComplete(){this.skillManager.removeSkill(this),this.isDeath=!0,this.completeFun&&this.completeFun(),this.idleTime=0}setData(t,e){this.hasDestory||(this.skillVo=new Te,this.skillVo.setData(t),this.setKeyAry(),this.trajectoryAry=new Array,this._skillData=e)}setKeyAry(){if(this.keyAry=new Array,this.skillVo.types==Se.FixEffect)for(var t=0;t<this.skillVo.keyAry.length;t++){var e=new fi(this);e.setInfo(this.skillVo.keyAry[t]),e.removeCallFun=t=>{this.removeKey(t)},e.active=this.active,this.keyAry.push(e)}else if(this.skillVo.types==Se.TrajectoryDynamicTarget||this.skillVo.types==Se.TrajectoryDynamicPoint)for(t=0;t<this.skillVo.keyAry.length;t++){var i;1==this.skillVo.keyAry[t].multype||((i=new Di).skill=this),i.setInfo(this.skillVo.keyAry[t]),this.keyAry.push(i)}}}class wi extends xi{constructor(t){super(),this.sceneManager=t}addSrc(t,e){for(var i in e.data){var a=new bi(this);a.name=i,a.isDeath=!0,a.src=!0,a.setData(e.data[i],e),e.addSrcSkill(a),xi.getInstance();var s=t+i;xi.getInstance()._skillDic[s]||(xi.getInstance()._skillDic[s]=new Array),xi.getInstance()._skillDic[s].push(a)}}playSkill(t){t.skillManager=this,super.playSkill(t)}getSkill(t,e,i=null){var a,s,r=t+e,n=xi.getInstance()._skillDic[r];if(n)for(var h=0;h<n.length;h++)if((a=n[h]).isDeath&&0==a.useNum)return a.reset(),a.isDeath=!1,a;return(a=new bi(this)).name=e,a.isDeath=!1,xi.getInstance()._skillDic[r]||(xi.getInstance()._skillDic[r]=new Array),xi.getInstance()._skillDic[r].push(a),this._dic[t]?(a.setData(this._dic[t].data[a.name],this._dic[t]),a.key=r,this._dic[t].useNum++,a):xi.getInstance()._loadDic[t]?((s=new Object).name=e,s.skill=a,s.callback=i,xi.getInstance()._loadDic[t].push(s),a):(xi.getInstance()._loadDic[t]=new Array,(s=new Object).name=e,s.skill=a,s.callback=i,xi.getInstance()._loadDic[t].push(s),Be.getInstance().loadSkillRes(D.fileRoot+t,e=>{this.loadSkillCom(t,e)}),a)}loadSkillCom(t,e){var i=new yi;i.data=e.data;for(var a=0;a<xi.getInstance()._loadDic[t].length;a++){(s=xi.getInstance()._loadDic[t][a]).skill.hasDestory||(s.skill.setData(i.data[s.name],i),s.skill.key=t+s.name,i.useNum++)}this._dic[t]=i,this.addSrc(t,i);for(a=0;a<xi.getInstance()._loadDic[t].length;a++){var s;(s=xi.getInstance()._loadDic[t][a]).callback&&s.callback()}xi.getInstance()._loadDic[t].length=0,xi.getInstance()._loadDic[t]=null}}class Ai extends ri{constructor(){super()}readParticle(){for(var t=this._byte.readInt(),e=(T.getTimer(),0);e<t;e++){var i=D.fileRoot+this._byte.readUTF(),a=this._byte.readInt(),s=new A;s.length=a,this._byte.readBytes(s,0,a),this.scene.particleManager.addResByte(i,s)}}}class Mi extends hi{getGroupData(t,e){if(this._dic[t]){var i=this._dic[t];return i.useNum++,void e(i)}if(this._loadDic[t])this._loadDic[t].push(e);else{this._loadDic[t]=new Array,this._loadDic[t].push(e);var a=new Ai;a.scene=this.scene,a.load(t,()=>{for(var e=this._loadDic[t],i=0;i<e.length;i++){(0,e[i])(a)}this._dic[t]=a,delete this._loadDic[t],a.initReg()})}}}class Ti extends gi{constructor(){super(),this.particleManager=new _i,this.skillManager=new wi(this),this.groupDataManager=new Mi,console.log("创建场景=>",Ti.sceneNum++)}static initConfig(){He._instance=new Ti}update(){Ee.getCamView(D.cam3D,D.focus3D),this.upFrame()}addMovieDisplay(t){t._scene=this,this._displayRoleList.push(t),t.addStage()}loadSceneConfigCom(t){var e=D.focus3D.rotationY;super.loadSceneConfigCom(t),D.focus3D.rotationY=e}playLyf(t,e,i=0){this.groupDataManager.scene=this,this.groupDataManager.getGroupData(D.fileRoot+t,t=>{for(var a=0;a<t.dataAry.length;a++){var s=t.dataAry[a];if(s.types==se.SCENE_PARTICLE_TYPE){var r=this.particleManager.getParticleByte(D.fileRoot+s.particleUrl);r.x=e.x,r.y=e.y,r.z=e.z,r.rotationY=i,this.particleManager.addParticle(r),r.addEventListener(nt.COMPLETE,this.onPlayCom,this)}else console.log("播放的不是单纯特效")}})}onPlayCom(t){this.particleManager.removeParticle(t.target)}upFrame(){D.context3D._contextSetTest.clear(),isNaN(this._time)&&(this._time=T.getTimer()),this.updateMovieFrame(),this._ready&&(this.particleManager.updateTime(),this.skillManager.update(),this.render&&(D.context3D.setWriteDepth(!0),D.context3D.setDepthTest(!0),this.updateStaticDiplay(),this.updateSpriteDisplay(),this.updateMovieDisplay(),D.context3D.setWriteDepth(!1),this.particleManager.update(),this.renderShadow()),this.cameraMatrix=D.cam3D.cameraMatrix.clone(),this.viewMatrx3D=D.viewMatrx3D)}}Ti.sceneNum=0;var Si=Laya.WebGLContext;class Pi extends Laya.Sprite{constructor(){super(),this._key=new Laya.SubmitKey,this._layaRenderIndex=-1,this.tscene=new Ti,this.tscene.ready=!0}render(t,e,i){t._curSubmit=Laya.SubmitBase.RENDERBASE,t.addRenderObject(this)}renderSubmit(){return this._layaRenderIndex=-1,Pi.saveLayaWebGLContext(),this.upFrame(),D.context3D.setWriteDepth(!1),D.context3D.setDepthTest(!1),Pi.revertLayaWebGLContext(),1}getRenderType(){return 0}releaseRender(){}upFrame(){}static saveLayaWebGLContext(){let t=D.context3D.renderContext;Si._activeTexture=t.getParameter(t.ACTIVE_TEXTURE)}static revertLayaWebGLContext(){let t=D.context3D.renderContext;Si._useProgram=null,t.activeTexture(Si._activedTextureID),Laya.Buffer._bindedVertexBuffer=null,Laya.Buffer._bindedIndexBuffer=null,Laya.BufferStateBase._curBindedBufferState=null,Laya.Context.set2DRenderConfig()}}class Ii{}class Ri{constructor(){this.setTextureNum=0,this.setProgramNum=0}init(t){this.renderContext=Laya.WebGLContext.mainContext,this._contextSetTest=new Bi}resetSize(t,e){}uploadBuff3D(t){var e=this.renderContext.createBuffer();return this.renderContext.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,e),this.renderContext.bufferData(WebGLRenderingContext.ARRAY_BUFFER,new Float32Array(t),WebGLRenderingContext.STATIC_DRAW),e}uploadBuff3DArrayBuffer(t){var e=this.renderContext.createBuffer();return this.renderContext.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,e),this.renderContext.bufferData(WebGLRenderingContext.ARRAY_BUFFER,t,WebGLRenderingContext.STATIC_DRAW),e}uploadBuff3DByBuffer(t,e){this.renderContext.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,t),this.renderContext.bufferData(WebGLRenderingContext.ARRAY_BUFFER,new Float32Array(e),WebGLRenderingContext.STATIC_DRAW)}uploadIndexBuff3D(t){var e=this.renderContext.createBuffer();return this.renderContext.bindBuffer(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,e),this.renderContext.bufferData(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),WebGLRenderingContext.STATIC_DRAW),e}uploadIndexBuff3DByBuffer(t,e){this.renderContext.bindBuffer(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,t),this.renderContext.bufferData(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),WebGLRenderingContext.STATIC_DRAW)}clearContext(){this.renderContext.depthMask(!0),this.renderContext.clear(WebGLRenderingContext.COLOR_BUFFER_BIT|WebGLRenderingContext.DEPTH_BUFFER_BIT|WebGLRenderingContext.STENCIL_BUFFER_BIT)}updateFBO(t){this.renderContext.bindFramebuffer(WebGLRenderingContext.FRAMEBUFFER,t.frameBuffer),this.renderContext.clearColor(63/255,63/255,63/255,1),this.renderContext.clearDepth(1),this.renderContext.clearStencil(0),this.renderContext.enable(WebGLRenderingContext.DEPTH_TEST),this.renderContext.depthMask(!0),this.renderContext.enable(WebGLRenderingContext.BLEND),this.renderContext.frontFace(WebGLRenderingContext.CW),this.renderContext.clear(WebGLRenderingContext.COLOR_BUFFER_BIT|WebGLRenderingContext.DEPTH_BUFFER_BIT|WebGLRenderingContext.STENCIL_BUFFER_BIT),this.setBlendParticleFactors(0),this.renderContext.disable(WebGLRenderingContext.CULL_FACE)}setDepthTest(t){t?this.renderContext.enable(WebGLRenderingContext.DEPTH_TEST):this.renderContext.disable(WebGLRenderingContext.DEPTH_TEST)}setWriteDepth(t){this._contextSetTest.testZbuffer(t)||this.renderContext.depthMask(t)}setBlendParticleFactors(t){if(!this._contextSetTest.testBlend(t))switch(t){case 0:this.renderContext.blendFunc(WebGLRenderingContext.ONE,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA);break;case 1:this.renderContext.blendFunc(WebGLRenderingContext.ONE,WebGLRenderingContext.ONE);break;case 2:this.renderContext.blendFunc(WebGLRenderingContext.DST_COLOR,WebGLRenderingContext.ZERO);break;case 3:this.renderContext.blendFunc(WebGLRenderingContext.ONE,WebGLRenderingContext.ONE_MINUS_SRC_COLOR);break;case 4:this.renderContext.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE);break;case-1:this.renderContext.blendFunc(WebGLRenderingContext.SRC_ALPHA,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA)}}setProgram(t){this._contextSetTest.testProgram(t)||(this.renderContext.useProgram(t),this.setProgramNum++)}getLocation(t,e){return this.renderContext.getUniformLocation(t,e)}setVcMatrix3fv(t,e,i){this.renderContext.uniformMatrix3fv(t.getWebGLUniformLocation(e),!1,i)}setVcMatrix4fv(t,e,i){this.renderContext.uniformMatrix4fv(t.getWebGLUniformLocation(e),!1,i)}setVpMatrix(t,e){this._contextSetTest.testVp()||this.renderContext.uniformMatrix4fv(t.getWebGLUniformLocation("vpMatrix3D"),!1,e)}setVc4fv(t,e,i){this.renderContext.uniform4fv(t.getWebGLUniformLocation(e),i)}setVc1fv(t,e,i){this.renderContext.uniform1fv(t.getWebGLUniformLocation(e),i)}setVc3fv(t,e,i){this.renderContext.uniform3fv(t.getWebGLUniformLocation(e),i)}setVc2fv(t,e,i){this.renderContext.uniform2fv(t.getWebGLUniformLocation(e),i)}setVcFloat(t,e,i){this.renderContext.uniform1fv(t.getWebGLUniformLocation(e),i)}setuniform3f(t,e,i,a,s){this.renderContext.uniform3f(t.getWebGLUniformLocation(e),i,a,s)}setVcMatrix4fvLocation(t,e){this.renderContext.uniformMatrix4fv(t,!1,e)}setVc2f(t,e,i,a){this.renderContext.uniform2f(t.getWebGLUniformLocation(e),i,a)}setVcMatrix2fvLocation(t,e){this.renderContext.uniformMatrix2fv(t,!1,e)}setVc4fvLocation(t,e){this.renderContext.uniform4fv(t,e)}setVa(t,e,i){this._contextSetTest.testVa(i),this.renderContext.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,i),i&&(this.renderContext.enableVertexAttribArray(t),this.renderContext.vertexAttribPointer(t,e,WebGLRenderingContext.FLOAT,!1,0,0))}pushVa(t){return!!this._contextSetTest.testVa(t)||(this.renderContext.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,t),!1)}setVaOffset(t,e,i,a){this._contextSetTest.enableVaAry[t]||(this.renderContext.enableVertexAttribArray(t),this._contextSetTest.enableVaAry[t]=!0),this.renderContext.vertexAttribPointer(t,e,WebGLRenderingContext.FLOAT,!1,i,a)}clearVa(t){this._contextSetTest.enableVaAry[t]=!1,this.renderContext.disableVertexAttribArray(t)}drawCall(t,e){this.renderContext.bindBuffer(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,t),this.renderContext.drawElements(WebGLRenderingContext.TRIANGLES,e,WebGLRenderingContext.UNSIGNED_SHORT,0),Laya.Stat.renderBatches+=1}drawCallL3d(t){this.renderContext.drawElements(WebGLRenderingContext.TRIANGLES,t,WebGLRenderingContext.UNSIGNED_SHORT,0),Laya.Stat.renderBatches+=1}drawLine(t,e){this.renderContext.bindBuffer(WebGLRenderingContext.ELEMENT_ARRAY_BUFFER,t),this.renderContext.drawElements(WebGLRenderingContext.LINES,e,WebGLRenderingContext.UNSIGNED_SHORT,0)}setRenderTexture(t,e,i,a,s=!0){s&&this._contextSetTest.testTexture(e,i)||(0==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE0):1==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE1):2==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE2):3==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE3):4==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE4):5==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE5):6==a&&this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE6),this.renderContext.bindTexture(WebGLRenderingContext.TEXTURE_2D,i),this.renderContext.uniform1i(t.getWebGLUniformLocation(e),a),this.setTextureNum++)}clearTexture(){}setRenderTextureCube(t,e,i,a){0==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE0):1==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE1):2==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE2):3==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE3):4==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE4):5==a?this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE5):6==a&&this.renderContext.activeTexture(WebGLRenderingContext.TEXTURE6),this.renderContext.bindTexture(WebGLRenderingContext.TEXTURE_CUBE_MAP,i),this.renderContext.uniform1i(this.renderContext.getUniformLocation(t,e),a)}updateTexture(t,e,i,a){this.renderContext.bindTexture(WebGLRenderingContext.TEXTURE_2D,t),this.renderContext.texSubImage2D(WebGLRenderingContext.TEXTURE_2D,0,e,i,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,a)}getTexture(t,e=0,i=0,a=0){var s=new de(0,0,Math.pow(2,Math.ceil(Math.log(t.width)/Math.log(2))),Math.pow(2,Math.ceil(Math.log(t.height)/Math.log(2))));if(s.width!=t.width||s.height!=t.height){var r=H.getInstance().getContext2D(s.width,s.height,!1);return r.drawImage(t,0,0,t.width,t.height,0,0,s.width,s.height),this.getTexture(r.canvas,0,0)}var n=this.renderContext.createTexture();return this.renderContext.bindTexture(WebGLRenderingContext.TEXTURE_2D,n),this.renderContext.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,t),this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.LINEAR),this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.LINEAR),0==e?(this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.REPEAT),this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.REPEAT)):(this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE)),0!=a&&this.renderContext.generateMipmap(WebGLRenderingContext.TEXTURE_2D),n}creatTexture(t,e,i=0){var a=this.renderContext.createTexture();return this.renderContext.bindTexture(WebGLRenderingContext.TEXTURE_2D,a),this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.LINEAR),this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.LINEAR),0==i?(this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.REPEAT),this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.REPEAT)):(this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE)),this.renderContext.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGB,t,e,0,WebGLRenderingContext.RGB,WebGLRenderingContext.UNSIGNED_BYTE,null),a}createFramebuffer(){var t=this.renderContext.createFramebuffer();return this.renderContext.bindFramebuffer(WebGLRenderingContext.FRAMEBUFFER,t),t}deleteBuffer(t){this.renderContext.deleteBuffer(t),this.renderContext.getError()}deleteTexture(t){this.renderContext.deleteTexture(t)}deleteShader(t){this.renderContext.deleteShader(t.vShader),this.renderContext.deleteShader(t.fShader),this.renderContext.deleteProgram(t.program)}cullFaceBack(t){this._contextSetTest.testCull(t)||(t?(this.renderContext.enable(WebGLRenderingContext.CULL_FACE),this.renderContext.cullFace(WebGLRenderingContext.BACK)):this.renderContext.disable(WebGLRenderingContext.CULL_FACE))}getFBO(){var t=Li.fw,e=Li.fh,i=this.renderContext.createFramebuffer();this.renderContext.bindFramebuffer(WebGLRenderingContext.FRAMEBUFFER,i);var a=this.renderContext.createRenderbuffer();this.renderContext.bindRenderbuffer(WebGLRenderingContext.RENDERBUFFER,a),this.renderContext.renderbufferStorage(WebGLRenderingContext.RENDERBUFFER,WebGLRenderingContext.DEPTH_COMPONENT16,t,e),this.renderContext.framebufferRenderbuffer(WebGLRenderingContext.FRAMEBUFFER,WebGLRenderingContext.DEPTH_ATTACHMENT,WebGLRenderingContext.RENDERBUFFER,a);var s=this.renderContext.createTexture();this.renderContext.bindTexture(WebGLRenderingContext.TEXTURE_2D,s),this.renderContext.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,t,e,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,null),this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.LINEAR),this.renderContext.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.LINEAR),this.renderContext.framebufferTexture2D(WebGLRenderingContext.FRAMEBUFFER,WebGLRenderingContext.COLOR_ATTACHMENT0,WebGLRenderingContext.TEXTURE_2D,s,0),this.renderContext.bindTexture(WebGLRenderingContext.TEXTURE_2D,null),this.renderContext.bindRenderbuffer(WebGLRenderingContext.RENDERBUFFER,null),this.renderContext.bindFramebuffer(WebGLRenderingContext.FRAMEBUFFER,null);var r=new Li;return r.frameBuffer=i,r.depthBuffer=a,r.texture=s,r}clearTest(){this._contextSetTest.clear()}}class Li{}Li.fw=512,Li.fh=512;class Bi{constructor(){this.enableVaAry=new Array,this.vaAry=new Array,this._blendType=-1e3,this._cullType=!1,this._zbufferType=!0,this._vpMatrix=!1}testTexture(t,e){return this._textureDic[t]==e||(this._textureDic[t]=e,!1)}testProgram(t){return this._program==t||(this._program=t,this._textureDic=new Object,this._vpMatrix=!1,!1)}testVa(t){return this._vabuffer==t||(this._vabuffer=t,!1)}clear(){this._blendType=-1e3,this._cullType=!1,this._vpMatrix=!1,this._program=null,this._vabuffer=null}testBlend(t){return this._blendType==t||(this._blendType=t,!1)}testCull(t){return this._cullType==t||(this._cullType=t,!1)}testZbuffer(t){return this._zbufferType==t||(this._zbufferType=t,!1)}testVp(){return!!this._vpMatrix||(this._vpMatrix=!0,!1)}}class Ci extends k{constructor(){super(),this._distance=500,this.offset=new b,this.cameraMatrix=new V}get distance(){return this._distance}set distance(t){this._distance=t}}class Fi{constructor(){this.sunDirect=new Array(0,1,0),this.sunColor=new Array(2,0,0),this.ambientColor=new Array(0,0,0)}setData(t,e,i){this.sunDirect[0]=t.x,this.sunDirect[1]=t.y,this.sunDirect[2]=t.z,this.sunColor[0]=e.x,this.sunColor[1]=e.y,this.sunColor[2]=e.z,this.ambientColor[0]=i.x,this.ambientColor[1]=i.y,this.ambientColor[2]=i.z}}class zi extends I{constructor(){super()}static resetSize(t,e){D.stageWidth=t,D.stageHeight=e,D.canvas3D.width=D.stageWidth,D.canvas3D.height=D.stageHeight,D.context3D.resetSize(D.stageWidth,D.stageHeight),I.resetViewMatrx3D()}static init(t){var e=/ipad/i.test(navigator.userAgent),i=/iPhone/i.test(navigator.userAgent),a=/android/i.test(navigator.userAgent);/iindow/i.test(navigator.userAgent),navigator.userAgent.toLowerCase();D.isPc=!(e||i||a),D.vpMatrix=new V,D.canvas3D=t,D.context3D=new Ri,D.context3D.init(t),D.cam3D=new Ci,D.focus3D=new k,D.light=new Fi,T.init(),D.supportBlob=!1}}class Ei extends zi{constructor(){super()}static resetSize(t,e){isNaN(t)&&(t=document.body.clientWidth),isNaN(e)&&(e=document.body.clientHeight),D.stageWidth=t,D.stageHeight=e,D.context3D.resetSize(D.stageWidth,D.stageHeight),I.resetViewMatrx3D(),f.getInstance().resetSize()}static init(t){zi.init(t),D.focus3D.x=0,D.focus3D.y=0,D.focus3D.z=0}static resetViewMatrx3D(){D.viewMatrx3D?D.viewMatrx3D.identity():D.viewMatrx3D=new V;var t=2/D.stageWidth,e=2/D.stageHeight;D.viewMatrx3D.appendScale(t,e,.001)}}class Vi extends zi{constructor(){super()}static initConfig(){I.init=t=>{Ei.init(t)},I.resetSize=(t,e)=>{Ei.resetSize(t,e)},I.resetViewMatrx3D=()=>{Ei.resetViewMatrx3D()}}}class Ni{static initData(){Ni.isConfig||(Vi.initConfig(),I.init(Ii.canvas),I.resetSize(Ii.canvas.width,Ii.canvas.height),Ni.isConfig=!0,He.getInstance().ready=!0,this.sceneItem=new Array)}}Ni.isConfig=!1;class ki{static addEvents(t,e,i){for(var a=0;a<t.length;a++)ki._instance.addEventListener(t[a].type,e,i)}static dispatchEvent(t){ki._instance.dispatchEvent(t)}}ki._instance=new N;class Ui{constructor(){}getName(){throw new Error("process必须复写命名")}receivedModuleEvent(t){}listenModuleEvents(){return null}registerEvents(){var t=this.listenModuleEvents();null!=t&&t.length>0&&ki.addEvents(t,this.receivedModuleEvent,this)}getHanderMap(){return new Object}}class Oi{}Oi.STANAD="stand",Oi.WALK="walk",Oi.DEATH="death",Oi.JUMP="jump",Oi.SIT="sit",Oi.ATTACK_01="attack_01",Oi.ATTACK_02="attack_02",Oi.ATTACK_03="attack_03",Oi.ATTACK_04="attack_04",Oi.ATTACK_05="attack_05",Oi.ATTACK_06="attack_06",Oi.ATTACK_010="attack_010",Oi.ATTACK_020="attack_020",Oi.STAND_MOUNT="stand_mount_01",Oi.WALK_MOUNT="walk_mount_01",Oi.s_attack_01="s_attack_01";class Wi extends oi{constructor(){super(...arguments),this._avatar=-1,this._visible=!0}get visible(){return this._visible}set visible(t){this._visible=t}setAvatar(t){this._avatar!=t&&(this._avatar=t,this.setRoleUrl(this.getSceneCharAvatarUrl(t)))}update(){this.visible&&super.update(),this._shadow&&(this._shadow._visible=this.visible)}getSceneCharAvatarUrl(t){Ie.getRoleUrl(t);return Ie.getRoleUrl(t)}getSceneCharWeaponUrl(t,e=""){return Ie.getModelUrl(String(t+e))}}class ji extends Wi{setData(t,e){if(e>0){var i={}.mountID;this.setAvatar(i)}else if(t>0){i={}.mountID;this.setAvatar(i)}}}class Gi{constructor(t=null,e=null,i=null,a=.1){this.p1=t,this.p2=e,this.p3=i,this.precision=a}setAllPoint(t,e,i){this.p1=t,this.p2=e,this.p3=i}checkPointIn(t){var e=this.getArea(),i=0;return i+=Gi.getAreaByPoints(t,this.p1,this.p2),i+=Gi.getAreaByPoints(t,this.p2,this.p3),(i+=Gi.getAreaByPoints(t,this.p3,this.p1))==e||Math.abs(i-e)<this.precision}getArea(){return Gi.getAreaByPoints(this.p1,this.p2,this.p3)}static getAreaByPoints(t,e,i){var a=t.x-e.x,s=t.y-e.y,r=Math.sqrt(a*a+s*s);a=e.x-i.x,s=e.y-i.y;var n=Math.sqrt(a*a+s*s);a=i.x-t.x,s=i.y-t.y;var h=Math.sqrt(a*a+s*s),o=(r+n+h)/2,l=o*(o-r)*(o-n)*(o-h);return l>0?Math.sqrt(l):0}}Gi.baseTri=new Gi;class Xi extends Wi{constructor(){super(),this.speedTX=.075,this.life=0,this.isMount=!1,this._px=0,this._py=0,this._pz=0,this._pRotationY=0,this._isBoss=!1,this._optimization=!1,this._weaponNum=-1,this._wingID=-1,this.tittleHeight=50,this.toRotationY=0,this._resultVisible=!0,this._showHitBox=!1,this.triIndex=[0,1,2,0,2,3,4,5,6,4,6,7,0,4,5,0,5,1,1,5,6,1,6,2,2,6,7,2,7,3,3,7,4,3,4,0],this.shadow=!0,this.skillitem=new Array}get isDeath(){return!1}get isBoss(){return this._isBoss}set isBoss(t){this._isBoss=t}get px(){return this._px}set px(t){this._px=t,this.isMount?(this.mountChar.x=t,this._shadow&&(this._shadow.x=t)):this.x=t}get py(){return this._py}set py(t){this._py=t,this.isMount?(this.mountChar.y=t,this._shadow&&(this._shadow.y=t)):this.y=t}get pz(){return this._pz}set pz(t){this._pz=t,this.isMount?(this.mountChar.z=t,this._shadow&&(this._shadow.z=t)):this.z=t}set forceRotationY(t){this.pRotationY=t,this.rotationY=t,this.toRotationY=t}get pRotationY(){return this._pRotationY}set pRotationY(t){this._pRotationY=t,this.isMount?this.mountChar.rotationY=t:this.rotationY=t}play(t,e=0,i=!0){return!(!this.isSinging||(e=0,t!=Oi.WALK&&t!=Oi.STANAD))||(this.isMount?(this.mountChar.visible=Boolean(t!=Oi.JUMP),t==Oi.STANAD?super.play(Oi.STAND_MOUNT):t==Oi.WALK?super.play(Oi.WALK_MOUNT):this.mountChar.visible?super.play(Oi.STAND_MOUNT):super.play(Oi.JUMP),this.mountChar.play(t,e,i)):super.play(t,e,i))}getCurrentAction(){return this.isMount?this.mountChar.curentAction:this.curentAction}getSceneCharAvatarUrl(t){if(0==t)throw new Error("衣服为getSceneCharAvatarUrl");return Ie.getRoleUrl(t)}setMount(){}setWeapon(t){this._weaponNum!=t&&(this._weaponNum=t,t<=0&&this.removePart(Xi.WEAPON_PART))}setWeaponByAvatar(t,e=""){}addTestWeapon(){this.addPart("test"+Math.random(),Xi.WEAPON_DEFAULT_SLOT,this.getSceneCharWeaponUrl(Math.random()>.5?5202:5201))}onMeshLoaded(){this._skinMesh&&(this.tittleHeight=this._skinMesh.tittleHeight)}set walkPath(t){0!=t.length&&(this.curentAction!=Oi.STANAD&&this.curentAction!=Oi.STAND_MOUNT||this.play(Oi.WALK),this._walkPath=t,this.setTarget(),this._speedDirect=null)}fixAstartData(t){if(this._walkPath)for(var e=0;e<this._walkPath.length;e++)this._walkPath[e].x+=t.x,this._walkPath[e].z=t.y-this._walkPath[e].z,this._walkPath[e].y=Xe.getHeightByPos(this._walkPath[e]);this.px+=t.x,this.pz=t.y-this.pz,this._astatTopos&&(this._astatTopos.x+=t.x,this._astatTopos.z=t.y-this._astatTopos.z,this.setAstarNrmAndRotation()),this.refreshY()}applyWalk(t){if(t&&2==t.length&&t[0].x==t[1].x&&t[0].y==t[1].y){this._speedDirect=null,this._walkPath=null,this.curentAction==Oi.WALK&&this.play(Oi.STANAD);var e=Xe.getWorldPosByStart2D(t[0]);return this.px=e.x,void(this.pz=e.z)}this.walkPath=Xe.Path2dTo3d(t)}set moveToPos2D(t){this._walkPath=null,this.play(this._defaultAction);var e=Xe.getWorldPosByStart2D(t);this.px=e.x,this.pz=e.z,this.refreshY()}stopToPos(t){var e=Xe.getWorldPosByStart2D(t),i=new Array;i.push(e),this.walkPath=i}moveTile(t,e){this.moveToPos2D=new _(t,e)}refreshY(){this.py=Xe.getHeightByPos(this.getCurrentPos())}refreshHP(){}rotationToNew(t,e=1){var i=t-this.pRotationY;if(0!=i)if(i<1)this.pRotationY=t;else{var a=((t-this.pRotationY)%360+360)%360;a>180?this.pRotationY-=(360-a)/e:this.pRotationY+=a/e}}set speedUseTime(t){this.speedTX=t/10*.01}refreshSpeed(){this.speedUseTime=1}walkAstar(t){var e=Math.min(t,50),i=b.distance(new b(this.px,0,this.pz),this._astatTopos);if(i>5){var a=e*this.speedTX;if(a>i){this.px=this._astatTopos.x,this.pz=this._astatTopos.z;var s=(a-i)/this.speedTX;this.walkAstar(s)}else this.px+=this._astarDirect.x*a,this.pz+=this._astarDirect.z*a}else this.setTarget(),this._walkPath?this.walkAstar(t):(this.px=this._astatTopos.x,this.pz=this._astatTopos.z,this.walkComplete())}walkComplete(){this.walkCompleteBackFun&&this.walkCompleteBackFun()}setTarget(){if(this._walkPath){if(0==this._walkPath.length)return this._walkPath=null,void this.play(Oi.STANAD);this._astatTopos=this._walkPath.shift(),this.setAstarNrmAndRotation()}}setAstarNrmAndRotation(){this._astatTopos&&(this._astarDirect=this._astatTopos.subtract(this.getCurrentPos()),this._astarDirect.y=0,this._astarDirect.normalize(),b.distance(this.getCurrentPos(),this._astatTopos)>10&&(this.toRotationY=this.mathAngle(this._astatTopos.z,this._astatTopos.x,this.pz,this.px)+180))}mathAngle(t,e,i,a){return 180*Math.atan2(a-e,i-t)/Math.PI}setSpeedDirect(t){this.isDeath||(this._speedDirect=t,this.curentAction!=Oi.STANAD&&this.curentAction!=Oi.STAND_MOUNT||this.play(Oi.WALK),this._walkPath=null)}stopMove(){this._speedDirect=null,this._walkPath=null,this.play(Oi.STANAD)}getEndWalkPathPos(){return this._walkPath?this._walkPath[this._walkPath.length-1]:null}watch(t,e=!1){if(t){var i=t.x-this.px,a=t.z-this.pz,s=Math.sqrt(i*i+a*a);i/=s,a/=s;var r=Math.asin(i)/Math.PI*180;a<=0&&(r=180-r),isNaN(r)||(this.forceRotationY=r)}}getCurrentPos(){return new b(this.px,this.py,this.pz)}getAstarPos(){return Xe.getGrapIndexByPos(this.getCurrentPos())}changeAction(t){switch(t){case Oi.ATTACK_01:this.play(Oi.ATTACK_010,2);break;case Oi.ATTACK_02:this.play(Oi.ATTACK_020,2);break;default:super.changeAction(t)}}playSkill(t){this._walkPath=null,xi.getInstance().playSkill(t),this.skillVo=t}msgSpellStop(){this.skillVo&&(this.skillVo.removeSkillForce(),this.changeAction(this._defaultAction),this.skillVo=null),this.isSinging=!1}destory(){this._hasDestory||(super.destory(),this._isBoss,this.skillVo&&(this.skillVo.removeSkillForce(),this.skillVo=null),this._wingDisplay&&this._wingDisplay.destory(),this._hasDestory=!0)}removeStage(){super.removeStage(),this.mountChar&&He.getInstance().removeMovieDisplay(this.mountChar),this._wingDisplay&&He.getInstance().removeMovieDisplay(this._wingDisplay)}addStage(){super.addStage(),this.mountChar&&He.getInstance().addMovieDisplay(this.mountChar),this._wingDisplay&&He.getInstance().addMovieDisplay(this._wingDisplay)}math_distance(t){return Ee.math_distance(this.px,this.pz,t.x,t.z)}set visible(t){this._visible=t,this.applyVisible()}get visible(){return this._visible}set optimization(t){this._optimization=t,this.applyVisible()}get optimization(){return this._optimization}get resultVisible(){return this._resultVisible}applyVisible(){var t=this._visible;if(t=!!this._visible&&!this._optimization,this._partDic&&this._partDic[Xi.WEAPON_PART])for(var e of this._partDic[Xi.WEAPON_PART])e.sceneVisible=t;this._wingDisplay&&(this._wingDisplay.visible=t),this.shadow=t,this._resultVisible=t}update(){if(this._skinMesh&&!this._optimization&&(super.update(),this._showHitBox)){if(!this.lineSprite){at.getInstance().registe(Ve.LineShader,new Ve),this.lineSprite=new Ne,this.lineSprite.clear();for(var t=0;t<this.triIndex.length/3;t++){var e=this._skinMesh.hitPosItem[this.triIndex[3*t+0]],i=this._skinMesh.hitPosItem[this.triIndex[3*t+1]],a=this._skinMesh.hitPosItem[this.triIndex[3*t+2]];this.lineSprite.makeLineMode(e,i),this.lineSprite.makeLineMode(i,a),this.lineSprite.makeLineMode(a,e)}this.lineSprite.upToGpu()}this.lineSprite.posMatrix=this.posMatrix.clone(),this.lineSprite.update()}}mouseClik(t,e){if(D.cam3D.cameraMatrix.transformVector(this.getCurrentPos()).z<D.cam3D.distance/3)return null;var i=je.math3DWorldtoDisplay2DPos(e);if(this._skinMesh){this.hitBox2DItem||(this.hitBox2DItem=new Array),this.hitBox2DItem.length=0;for(var a=0;a<this._skinMesh.hitPosItem.length;a++){var s=this.posMatrix.transformVector(this._skinMesh.hitPosItem[a]);this.hitBox2DItem.push(je.math3DWorldtoDisplay2DPos(s))}for(var r=0;r<this.triIndex.length/3;r++)if(Gi.baseTri.p1=this.hitBox2DItem[this.triIndex[3*r+0]],Gi.baseTri.p2=this.hitBox2DItem[this.triIndex[3*r+1]],Gi.baseTri.p3=this.hitBox2DItem[this.triIndex[3*r+2]],Gi.baseTri.checkPointIn(i))return!0}else if(_.distance(i,je.math3DWorldtoDisplay2DPos(this.posMatrix.position))<20)return!0;return!1}}Xi.WEAPON_PART="weapon",Xi.WEAPON_DEFAULT_SLOT="w_01",Xi.MOUNT_SLOT="mount_01",Xi.WING_SLOT="wing_01",Xi.SEL_PART="select",Xi.QUEST_ICON="questicon",Xi.NONE_SLOT="none",Xi.Defaul_Man_Avatar=2002,Xi.Defaul_WoMan_Avater=2012;class Yi{}Yi.Orange7a2f21="[7a2f21]",Yi.Orange9a683f="[9a683f]",Yi.Orange853d07="[853d07]",Yi.Brown6a4936="[6a4936]",Yi.Brown623424="[623424]",Yi.Brownac8965="[ac8965]",Yi.Reddb4051="[db4051]",Yi.Redd92200="[d92200]",Yi.Redff0000="[ff0000]",Yi.Brownd8d49c="[d8d49c]",Yi.color843b11="[843b11]",Yi.colorb96d49="[b96d49]",Yi.colorcd2000="[cd2000]",Yi.colorfef3d7="[fef3d7]",Yi.color9a683f="[9a683f]",Yi.Brown7a2f21="[7a2f21]",Yi.Brown40120a="[40120a]",Yi.Brown491207="[491207]",Yi.Brown541616="[541616]",Yi.Brown5a2610="[5a2610]",Yi.Browndf9a68="[df9a68]",Yi.Browndb39264="[b39264]",Yi.Brownd662c0d="[662c0d]",Yi.colorefe4c4="[efe4c4]",Yi.color802626="[802626]",Yi.color9f7b4d="[9f7b4d]",Yi.color4b0808="[4b0808]",Yi.color5f5c59="[5f5c59]",Yi.color903713="[903713]",Yi.colorfdf6da="[fdf6da]",Yi.color73301c="[73301c]",Yi.colorffeeb5="[ffeeb5]",Yi.Green98ec2c="   ",Yi.Green56da35="[56da35]",Yi.Green20a200="[20a200]",Yi.Greenadff00="[adff00]",Yi.Green2ca937="[2ca937]",Yi.Green464b11="[464b11]",Yi.Green54db36="[54db36]",Yi.Yellowf7d253="[f7d253]",Yi.Yellowffecc6="[ffecc6]",Yi.Yellowffd500="[ffd500]",Yi.Yellowffe9b4="[ffe9b4]",Yi.Yellowedce7e="[edce7e]",Yi.color4c1c07="[4c1c07]",Yi.Whiteffffff="[ffffff]",Yi.Whitefffce6="[fffce6]",Yi.Whitefff7db="[fff7db]",Yi.White9A683F="[9A683F]",Yi.Black000000="[000000]",Yi.Whitefff4d6="[fff4d6]",Yi.Whiteffeed0="[ffeed0]",Yi.Whiteffeec9="[ffeec9]",Yi.Whiteffe9b4="[ffe9b4]",Yi.Whitefff0b4="[fff0b4]",Yi.Coffeeff9200="[ff9200]",Yi.Coffeefee87b="[fee87b]",Yi.color2daa35="[2daa35]",Yi.color4392ff="[4392ff]",Yi.colorb759ff="[b759ff]",Yi.colorff7200="[ff7200]",Yi.colorce0a00="[ce0a00]",Yi.coloraa874a="[aa874a]",Yi.colorffecc6="[ffecc6]",Yi.colorfde87e="[fde87e]",Yi.colord6e7ff="[d6e7ff]",Yi.colord27262e="[27262e]",Yi.colorffe9b4="[ffe9b4]",Yi.color9c9b9b="[9c9b9b]",Yi.colorfff2d3="[fff2d3]",Yi.color451800="[451800]";class Zi extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"u2Texture")}getVertexShaderString(){return"attribute vec3 v3Position;attribute vec2 u2Texture;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(u2Texture.x, u2Texture.y);   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"}getFragmentShaderString(){return"precision mediump float;\nuniform sampler2D s_texture;\nvarying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ngl_FragColor =infoUv;\n}"}}Zi.BaseDiplay3dShader="BaseDiplay3dShader";class Hi extends se{load(t,e){this._fun=e,X.getInstance().load(t,X.BYTE_TYPE,t=>{this.loadComplete(t)})}loadComplete(t){this._byte=new A(t),this._byte.position=0,this.read(()=>{this.readNexte()})}readNexte(){this.read(),this.read(),this.objUrl=this._byte.readUTF(),this.materialUrl=this._byte.readUTF(),this._byte.readBoolean()&&(this.light=new Fi,this.light.ambientColor[0]=this._byte.readFloat(),this.light.ambientColor[1]=this._byte.readFloat(),this.light.ambientColor[2]=this._byte.readFloat(),this.light.sunColor[0]=this._byte.readFloat(),this.light.sunColor[1]=this._byte.readFloat(),this.light.sunColor[2]=this._byte.readFloat(),this.light.sunDirect[0]=this._byte.readFloat(),this.light.sunDirect[1]=this._byte.readFloat(),this.light.sunDirect[2]=this._byte.readFloat()),this._fun()}}class qi{constructor(){this.drawNum=0,this.fpsStr=""}static update(){}getStr(){return qi.fpsNowNum=Math.min(this.drawNum,600),this.fpsStr="Fps:"+String(qi.fpsNowNum)+"-"+qi.tipStr,this.fpsStr}}qi.addFps=0,qi.fpsNowNum=0,qi.tipStr="";class Ki{constructor(){this.lastTime=0,this.cPos=new _(150,100)}static getInstance(){return this._instance||(this._instance=new Ki),this._instance}init(t,e){this.canvas2D=t,this.loadCav=e,this.fps=new qi,this.canvasUi=this.canvas2D.getContext("2d"),this.loadCtx=this.loadCav.getContext("2d"),T.addFrameTick(()=>{this.upData()})}showLoadInfo(t){}removeShowLoad(){this.loadCav.parentElement&&this.loadCav.parentElement.removeChild(this.loadCav),Ki.showFps=!0}upData(){if(this.fps.drawNum++,!(this.lastTime>=T.getTimer()-1e3))if(this.lastTime=T.getTimer(),Ki.showFps){this.canvasUi.font="40px Helvetica";var t=this.canvasUi.measureText(this.fps.getStr()).width;this.canvas2D.width=t,this.canvas2D.height=30,this.canvasUi.clearRect(50,0,this.canvas2D.width-50,this.canvas2D.height),this.canvasUi.fillStyle="#000000",this.canvasUi.fillRect(50,0,this.canvas2D.width-50,this.canvas2D.height),this.canvasUi.font="30px Helvetica",this.canvasUi.fillStyle="#ffffff",this.canvasUi.textBaseline="top",this.canvasUi.textAlign="left",this.canvasUi.fillText(this.fps.getStr(),50,0),this.fps.drawNum=0}else this.canvasUi.clearRect(0,0,this.canvas2D.width,this.canvas2D.height)}makeXyzLine(){var t=new b(80,0,0),e=new b(0,70,0),i=new b(0,0,80),a=new V;a.appendRotation(D.cam3D.rotationY,b.Y_AXIS),a.appendRotation(D.cam3D.rotationX,b.X_AXIS),t=a.transformVector(t),e=a.transformVector(e),i=a.transformVector(i),this.drawLine(new _(0,0),new _(t.x,-t.y),"#ff0000"),this.drawLine(new _(0,0),new _(e.x,-e.y),"#00ff00"),this.drawLine(new _(0,0),new _(i.x,-i.y),"#0000ff"),this.canvasUi.font="12px Helvetica",this.canvasUi.fillStyle="#ff0000",this.canvasUi.fillText("x",t.x+this.cPos.x,-t.y+this.cPos.y),this.canvasUi.fillStyle="#00ff00",this.canvasUi.fillText("y",e.x+this.cPos.x,-e.y+this.cPos.y),this.canvasUi.fillStyle="#0000ff",this.canvasUi.fillText("z",i.x+this.cPos.x,-i.y+this.cPos.y)}drawLine(t,e,i="red"){this.canvasUi.beginPath(),this.canvasUi.lineWidth=2,this.canvasUi.strokeStyle=i,this.canvasUi.moveTo(t.x+this.cPos.x,t.y+this.cPos.y),this.canvasUi.lineTo(e.x+this.cPos.x,e.y+this.cPos.y),this.canvasUi.stroke()}resetSize(){this.cPos=new _(150,D.stageHeight-100)}}Ki.showFps=!1;class Qi extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2CubeTexST")}getVertexShaderString(){return"attribute vec3 v3Position;attribute vec2 v2CubeTexST;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(v2CubeTexST.x, v2CubeTexST.y);   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"}getFragmentShaderString(){return" precision mediump float;\nuniform sampler2D s_texture;\nuniform vec4 testconst;uniform vec4 testconst2;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\nvec4 test = vec4(0,0,0,1);\ntest.xyz = mix(vec3(1,1,1)*0.5,testconst.xyz,0.5);\ninfoUv.xyz = test.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}"}}Qi.buildShader="BuildShader";class Ji extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v3Normal")}getVertexShaderString(){return"attribute vec3 v3Position;attribute vec3 v3Normal;uniform mat4 viewMatrix3D;uniform mat4 camMatrix3D;uniform mat4 posMatrix3D;varying vec3 vNormal;void main(void){   vNormal = vec3(v3Normal.x, v3Normal.y,v3Normal.z);   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = camMatrix3D * vt0;   vt0 = viewMatrix3D * vt0;   gl_Position = vt0;}"}getFragmentShaderString(){return"precision mediump float;\nuniform samplerCube s_texture;\nvarying vec3 vNormal;\nvoid main(void)\n{\nvec4 infoUv = textureCube(s_texture, vNormal);\ngl_FragColor = infoUv;\n}"}}Ji.Sky_Shader="SkyShader";class $i{}$i.LEFT="left",$i.CENTER="center",$i.RIGHT="right",$i.TOP="top",$i.MIDDLE="middle",$i.BOTTOM="bottom";class ta{}ta.A=65,ta.B=66,ta.C=67,ta.D=68,ta.E=69,ta.F=70,ta.G=71,ta.H=72,ta.I=73,ta.J=74,ta.K=75,ta.L=76,ta.M=77,ta.N=78,ta.O=79,ta.P=80,ta.Q=81,ta.R=82,ta.S=83,ta.T=84,ta.U=85,ta.V=86,ta.W=87,ta.X=88,ta.Y=89,ta.Z=90,ta.Left=37,ta.Up=38,ta.Right=39,ta.Down=40,ta.Delete=46,ta.F1=112,ta.F2=113;class ea extends Xi{setWeaponByAvatar(t,e=""){this.addPart(Xi.WEAPON_PART,Xi.WEAPON_DEFAULT_SLOT,this.getSceneCharWeaponUrl(t,e))}setWingByID(t){this._wingDisplay||(this._wingDisplay=new Wi),this._wingDisplay.setRoleUrl(Ie.getRoleUrl(t)),this._wingDisplay.setBind(this,Xi.WING_SLOT),He.getInstance().addMovieDisplay(this._wingDisplay)}setMountById(t){this.mountChar||(this.mountChar=new ji),this.mountChar.setRoleUrl(Ie.getRoleUrl(t)),this.setBind(this.mountChar,Xi.MOUNT_SLOT),He.getInstance().addMovieDisplay(this.mountChar),this.isMount=!0}}class ia extends Xi{onMeshLoaded(){super.onMeshLoaded(),this.loadFinishFun&&this.loadFinishFun()}changeAction(t){this.curentAction=this._defaultAction,this.changeActionFun&&this.changeActionFun(t)}setWeaponByAvatar(t,e=""){}}class aa extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"u2Texture")}getVertexShaderString(){return"attribute vec3 v3Position;attribute vec2 u2Texture;uniform mat4 vpMatrix3D;uniform mat4 posMatrix3D;varying vec2 v_texCoord;void main(void){   v_texCoord = vec2(u2Texture.x, u2Texture.y);   vec4 vt0= vec4(v3Position, 1.0);   vt0 = posMatrix3D * vt0;   vt0 = vpMatrix3D * vt0;   gl_Position = vt0;}"}getFragmentShaderString(){return"precision mediump float;\nuniform sampler2D s_texture;\nvarying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ngl_FragColor = vec4(gl_FragCoord.z,gl_FragCoord.z,0.1236,1);\n}"}}aa.BaseShadowShader="BaseShadowShader";class sa{constructor(){this.sunRotationX=-90,this.sunRotationY=0,this.sunDistens100=200,this.isNeedMake=!0,this._visible=!0}static getInstance(){return this._instance||(this._instance=new sa),this._instance}getFBO(){Li.fw=1024,Li.fh=1024,this.renderContext=D.context3D.renderContext;var t=D.context3D.renderContext,e=new Li;return e.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,e.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,Li.fw,Li.fh,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),e.frameBuffer=t.createFramebuffer(),e.depthBuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,e.depthBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,Li.fw,Li.fh),e}updateDepthTexture(t){var e=D.context3D.renderContext;e.bindFramebuffer(e.FRAMEBUFFER,t.frameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.texture,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t.depthBuffer)}makeUseShadowView(){D.viewMatrx3D.appendTranslation(1,1,1),D.viewMatrx3D.appendScale(.5,.5,.5),Ee.updateVp(),sa.shadowViewMatx3D=D.vpMatrix.clone()}setShowdowVisible(t){this._visible=t,console.log("开关阴影",this._visible)}updateDepth(t){if(sa.getInstance().sunRotationY=45,t.fbo||(t.fbo=this.getFBO()),this._visible){var e=D.vpMatrix.clone(),i=D.viewMatrx3D.clone();this.updateDepthTexture(t.fbo),this.renderContext.viewport(0,0,Li.fw,Li.fh),this.renderContext.clearColor(1,1,1,1),this.renderContext.clearDepth(1),this.renderContext.enable(c.DEPTH_TEST),this.renderContext.depthMask(!0),this.renderContext.frontFace(c.CW),this.renderContext.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),D.context3D.setWriteDepth(!0),D.context3D.setDepthTest(!0),D.viewMatrx3D.identity(),D.viewMatrx3D.appendScale(.002,.002,1/600),D.cam3D.cameraMatrix.identity(),D.cam3D.cameraMatrix.prependRotation(this.sunRotationX,b.X_AXIS),D.cam3D.cameraMatrix.prependRotation(this.sunRotationY,b.Y_AXIS),D.cam3D.cameraMatrix.prependTranslation(-D.focus3D.x,0,-D.focus3D.z);var a=new b(0,0,-1),s=new V;s.appendRotation(-this.sunRotationX,b.X_AXIS),s.appendRotation(-this.sunRotationY,b.Y_AXIS),(a=s.transformVector(a)).normalize(),t.light.sunDirect[0]=a.x,t.light.sunDirect[1]=a.y,t.light.sunDirect[2]=a.z,Ee.updateVp(),sa.shadowViewMatx3D=D.vpMatrix.clone(),D.context3D.setProgram(null);for(var r=0;r<t.displaySpriteList.length;r++){var n=t.displaySpriteList[r];this.drawTempSprite(n.objData,n.posMatrix)}for(var h=0;h<t.displayList.length;h++){var o=t.displayList[h];if(o&&o.needScanShadow)for(var l=0;l<o.groupItem.length;l++)this.drawTempSprite(o.groupItem[l].objData,o.posMatrix)}var c=D.context3D.renderContext;c.bindFramebuffer(c.FRAMEBUFFER,null),c.bindTexture(c.TEXTURE_2D,null),c.bindRenderbuffer(c.RENDERBUFFER,null),this.makeUseShadowView(),D.context3D.resetSize(D.stageWidth,D.stageHeight),D.vpMatrix=e,D.viewMatrx3D=i}}drawTempSprite(t,e){at.getInstance().registe(aa.BaseShadowShader,new aa);var i=at.getInstance().getProgram(aa.BaseShadowShader);if(!this._uvTextureRes){var a=H.getInstance().getContext2D(128,128,!1);a.fillStyle="rgb(255,0,255)",a.fillRect(0,0,128,128),this._uvTextureRes=K.getInstance().getCanvasTexture(a)}D.context3D.setProgram(i.program),D.context3D.setVcMatrix4fv(i,"vpMatrix3D",D.vpMatrix.m),D.context3D.setVcMatrix4fv(i,"posMatrix3D",e.m);D.context3D.pushVa(t.vertexBuffer);D.context3D.setVaOffset(0,3,t.stride,0),D.context3D.setVaOffset(1,2,t.stride,t.uvsOffsets),D.context3D.setRenderTexture(i,"s_texture",this._uvTextureRes.texture,0),D.context3D.drawCall(t.indexBuffer,t.treNum)}}class ra extends B{constructor(){super()}binLocation(t){t.bindAttribLocation(this.program,0,"v3Position"),t.bindAttribLocation(this.program,1,"v2CubeTexST"),t.bindAttribLocation(this.program,2,"v3Normal")}getVertexShaderString(){return"attribute vec3 v3Position;attribute vec2 v2CubeTexST;varying vec2 v0;varying vec3 v_PositionFromLight;varying vec3 v2;varying float cosTheta;varying float onsunFace;varying vec3 ambientColorF;attribute vec3 v3Normal;uniform vec3 sunDirect;uniform vec3 sunColor;uniform vec3 ambientColor;uniform mat4 vpMatrix3D;uniform mat4 posMatrix3D;uniform mat4 shadowViewMatx3D;uniform mat3 rotationMatrix3D;void main(void){;ambientColorF =ambientColor;v0 = vec2(v2CubeTexST.x, v2CubeTexST.y); vec4 vt0= vec4(v3Position, 1.0);vt0 = posMatrix3D * vt0;vt0 = vpMatrix3D * vt0;   vec4 vt1= vec4(v3Position, 1.0);   vt1 = posMatrix3D * vt1;   vt1 = shadowViewMatx3D * vt1;   v_PositionFromLight = vec3(vt1.x, vt1.y,vt1.z);vec3 n = rotationMatrix3D * v3Normal;float suncos = dot(n.xyz,sunDirect.xyz);onsunFace = suncos;cosTheta =1.0-abs(suncos);suncos = clamp(suncos,0.0,1.0);v2 = sunColor * suncos ;gl_Position = vt0;}"}getFragmentShaderString(){return"precision mediump float;\nuniform sampler2D fs0;\nuniform sampler2D fs1;\nvarying vec2 v0;\nvarying vec3 v_PositionFromLight;\nvarying vec3 v2;varying float cosTheta;varying float onsunFace;varying vec3 ambientColorF;void main(void)\n{\nvec4 ft5 = texture2D(fs1, v_PositionFromLight.xy); float  bias  = 0.01*cosTheta; bias = clamp(bias, 0.003, 0.01); float visibility = (v_PositionFromLight.z > ft5.x + bias) ? 0.9 : 1.0;\nvisibility =onsunFace<0.0?1.0:visibility ; vec4 ft0 = texture2D(fs0, v0); vec4 ft1 = vec4(v2.xyz, 1.0); vec4 ft2 = vec4(1, 1, 1, 1); float isalp = (ft5.z >0.1254) ? 1.0 : 0.2;\ngl_FragColor = vec4((ft1.xyz*visibility+ambientColorF.xyz)*ft0.rgb , 1.0); }"}}ra.DirectShadowDisplay3DShader="DirectShadowDisplay3DShader";t.AnimData=te,t.AnimManager=ye,t.AstarUtil=Xe,t.AxisMove=vt,t.AxisRotaion=xt,t.Base64=G,t.BaseAnim=pt,t.BaseDiplay3dSprite=class extends U{constructor(){super(),this.initData(),this.updateMatrix}initData(){at.getInstance().registe(Zi.BaseDiplay3dShader,new Zi),this.shader=at.getInstance().getProgram(Zi.BaseDiplay3dShader),this.program=this.shader.program,this.objData=new $,this.objData.vertices=new Array,this.objData.vertices.push(0,0,0),this.objData.vertices.push(100,0,0),this.objData.vertices.push(100,0,100),this.objData.uvs=new Array,this.objData.uvs.push(0,0),this.objData.uvs.push(1,0),this.objData.uvs.push(0,1),this.objData.indexs=new Array,this.objData.indexs.push(0,1,2),this.loadTexture(),this.upToGpu()}loadTexture(){var t=H.getInstance().getContext2D(128,128,!1);t.fillStyle="rgb(255,255,255)",t.fillRect(0,0,128,128),this._uvTextureRes=K.getInstance().getCanvasTexture(t)}upToGpu(){this.objData.indexs.length&&(this.objData.treNum=this.objData.indexs.length,this.objData.vertexBuffer=D.context3D.uploadBuff3D(this.objData.vertices),this.objData.uvBuffer=D.context3D.uploadBuff3D(this.objData.uvs),this.objData.indexBuffer=D.context3D.uploadIndexBuff3D(this.objData.indexs))}update(){this.objData&&this.objData.indexBuffer&&this._uvTextureRes&&(D.context3D.setProgram(this.program),D.context3D.setVcMatrix4fv(this.shader,"viewMatrix3D",D.viewMatrx3D.m),D.context3D.setVcMatrix4fv(this.shader,"camMatrix3D",D.cam3D.cameraMatrix.m),D.context3D.setVcMatrix4fv(this.shader,"posMatrix3D",this.posMatrix.m),D.context3D.setVa(0,3,this.objData.vertexBuffer),D.context3D.setVa(1,2,this.objData.uvBuffer),D.context3D.setRenderTexture(this.shader,"s_texture",this._uvTextureRes.texture,0),D.context3D.drawCall(this.objData.indexBuffer,this.objData.treNum))}},t.BaseEvent=nt,t.BaseLaya3dSprite=class extends Pi{constructor(){Ni.isConfig||Ni.initData(),super()}upFrame(){D.context3D.setWriteDepth(!0),D.context3D.setDepthTest(!0),T.update(),D.focus3D.rotationY=0,D.focus3D.rotationX=-f.SCENE_2D_ROTATION_45,D.cam3D.distance=250,f.getInstance().tureMoveV2d=new _(this.x,this.y),f.getInstance().resetSize(),D.context3D.renderContext.clear(WebGLRenderingContext.DEPTH_BUFFER_BIT),Ee.getCamView(D.cam3D,D.focus3D),D.context3D._contextSetTest.clear(),this.tscene.upFrame()}},t.BaseProcessor=class extends Ui{},t.BaseRes=se,t.BitMapData=ce,t.BoneSocketData=_e,t.BufferState=e,t.BuildShader=Qi,t.Calculation=We,t.Camera3D=Ci,t.CanvasPostionModel=f,t.CapsuleVo=class{constructor(t,e){this.radius=t,this.height=e}},t.CharAction=Oi,t.CharModelShow=class{constructor(){this.addModelChar()}addModelChar(){var t=new ea;t.setRoleUrl(Ie.getRoleUrl(50003)),t.setWingByID(901),t.setMountById(4103),t.setWeaponByAvatar(50011),t.play(Oi.STAND_MOUNT),He.getInstance().addMovieDisplay(t)}},t.CharSkillPlayModel=class{constructor(){this.skillFileName="jichu_1",this.charIdstr=50001,this.weaponNum=50011,this.skipId=1,this.skillEffectItem=["skill_01","skill_02","skill_03","m_skill_01","m_skill_02","m_skill_03"],this.initSkillPlay()}initSkillPlay(){M.getUrlParam("id")?(this.makeUrlParam(),this.makeMainChar()):window.location.href="index.html?id="+M.random(10)}makeUrlParam(){this.paramId=Number(M.getUrlParam("id")),isNaN(this.paramId)&&(this.paramId=0),this.paramId=Math.floor(this.paramId),this.paramId=this.paramId%6+1,(this.paramId<=0||this.paramId>6)&&(this.paramId=1),3!=this.paramId&&4!=this.paramId||this.makeAttackChar(),this.skillFileName="jichu_"+Math.ceil(this.paramId/2),this.charIdstr=5e3+this.paramId,this.weaponNum=50010+this.paramId}makeAttackChar(){var t=new Xi;t.z=100,t.setRoleUrl(Ie.getRoleUrl(7001)),He.getInstance().addMovieDisplay(t),this.attackTarget=t,this.attackTarget.x=M.random(50)+30,this.attackTarget.z=M.random(50)+30}makeMainChar(){xi.getInstance().preLoadSkill(Ie.getSkillUrl(this.skillFileName));var t=new ia;t.setRoleUrl(Ie.getRoleUrl(this.charIdstr)),He.getInstance().addMovieDisplay(t),t.setWeaponByAvatar(this.weaponNum),this.mainChar=t,t.changeActionFun=()=>{this.playSkill()},t.loadFinishFun=()=>{Be.getInstance().loadSkillRes(D.fileRoot+Ie.getSkillUrl(this.skillFileName),t=>{xi.getInstance().preLoadSkill(Ie.getSkillUrl(this.skillFileName)),T.addTimeOut(1e3,()=>{this.playSkill()}),console.log(T.getTimer())})}}playSkill(){var t=this.skillEffectItem[this.skipId%this.skillEffectItem.length],e=xi.getInstance().getSkill(Ie.getSkillUrl(this.skillFileName),t);if(e.keyAry){if(this.textPlaySkillFun&&(T.removeTimeTick(this.textPlaySkillFun),this.textPlaySkillFun=null),e&&(e.reset(),e.isDeath=!1),3==this.paramId||4==this.paramId){if("m_skill_01"==t)e.configFixEffect(this.mainChar);else{this.attackTarget.x=M.random(50)+30,this.attackTarget.z=M.random(50)+30;var i=new b(this.attackTarget.x,this.attackTarget.y,this.attackTarget.z),a=new Array;a.push(i),e.configFixEffect(this.mainChar,null,a)}this.mainChar.watch(this.attackTarget,!0)}else e.configFixEffect(this.mainChar);this.mainChar.playSkill(e),this.skipId++}}},t.Circle=ze,t.CollisionVo=re,t.ColorTransition=ht,t.ColorType=Yi,t.CombineParticle=Gt,t.CombineParticleData=ie,t.ConstItem=et,t.Context3D=Ri,t.Curve=ot,t.DefineDatas=d,t.Dictionary=Jt,t.DirectShadowDisplay3DSprite=class extends le{constructor(){super(),this.needScanShadow=!0,this.nrmFlag=0,this.initData()}initData(){at.getInstance().registe(ra.DirectShadowDisplay3DShader,new ra),this.modelShder=at.getInstance().getProgram(ra.DirectShadowDisplay3DShader)}setObjUrl(t){he.getInstance().getObjData(D.fileRoot+t,t=>{this.objData=t})}update(){50==this.y&&console.log("here");for(var t=0;t<this.groupItem.length;t++)this.drawTemp(this.groupItem[t])}drawTemp(t){if(this._scene.fbo&&sa.shadowViewMatx3D){var e=t.objData,i=this.modelShder;if(e&&e.indexBuffer&&this._uvTextureRes){D.context3D.setProgram(i.program),D.context3D.setVc3fv(i,"sunDirect",this._scene.light.sunDirect),D.context3D.setVc3fv(i,"sunColor",this._scene.light.sunColor),D.context3D.setVc3fv(i,"ambientColor",this._scene.light.ambientColor),D.context3D.setVcMatrix4fv(i,"shadowViewMatx3D",sa.shadowViewMatx3D.m),D.context3D.setVcMatrix3fv(i,"rotationMatrix3D",t._rotationData),D.context3D.setVcMatrix4fv(i,"vpMatrix3D",D.vpMatrix.m),D.context3D.setVcMatrix4fv(i,"posMatrix3D",this.posMatrix.m);let a=D.context3D.renderContext;D.context3D.renderContext.bindBuffer(a.ARRAY_BUFFER,e.vertexBuffer),D.context3D.setVaOffset(0,3,e.stride,0),D.context3D.setVaOffset(1,2,e.stride,e.uvsOffsets),D.context3D.setVaOffset(2,3,e.stride,e.normalsOffsets),D.context3D.setRenderTexture(i,"fs0",this._uvTextureRes.texture,0),D.context3D.setRenderTexture(i,"fs1",this._scene.fbo.texture,1),D.context3D.drawCall(e.indexBuffer,e.treNum)}}}updateRotationMatrix(){super.updateRotationMatrix();for(var t=0;this.groupItem&&t<this.groupItem.length;t++){var e=this.groupItem[t];e&&e._rotationData&&e._rotationData&&this._rotationMatrix.getRotaion(e._rotationData)}}setPicUrl(t){K.getInstance().getTexture(D.fileRoot+t,t=>{this._uvTextureRes=t})}setModelById(t){this.groupItem=new Array,hi.getInstance().getGroupData(D.fileRoot+Ie.getModelUrl(t),t=>{for(var e=0;e<t.dataAry.length;e++){var i=t.dataAry[e];if(i.types==se.PREFAB_TYPE){var a=new le;a.setObjUrl(i.objUrl),a._rotationData=new Float32Array(9),this.groupItem.push(a),i.materialInfoArr&&i.materialInfoArr.length?this.setPicUrl(i.materialInfoArr[0].url):console.log("没有指定贴图")}}this.updateRotationMatrix()})}},t.Display3D=U,t.Display3DBallPartilce=Lt,t.Display3DBallShader=St,t.Display3DBonePartilce=qt,t.Display3DFacetParticle=Tt,t.Display3DFacetShader=At,t.Display3DFollowLocusPartilce=Xt,t.Display3DFollowLocusShader=Yt,t.Display3DFollowPartilce=jt,t.Display3DFollowShader=Ot,t.Display3DLocusBallPartilce=Et,t.Display3DLocusPartilce=Ft,t.Display3DLocusShader=Bt,t.Display3DModelObjParticle=kt,t.Display3DModelPartilce=Nt,t.Display3DParticle=wt,t.Display3DShadowShader=ei,t.Display3DSprite=le,t.Display3DUISprite=class extends le{constructor(){super(),this.uiMatrix=new V,this.uiMatrix.prependTranslation(0,0,600),this.uiMatrix.prependRotation(-15,b.X_AXIS),this.uiMatrix.prependRotation(0,b.Y_AXIS),this.uiViewMatrix=new V}loadRes(t){this.modelRes||(this.modelRes=new Hi),this.modelRes.load(D.fileRoot+Ie.getModelUrl(t),()=>{this.loadResComFinish()})}loadResComFinish(){this.setObjUrl(this.modelRes.objUrl),this.setMaterialUrl(this.modelRes.materialUrl)}loadGroup(t){var e=new ri;e.load(D.fileRoot+"model/"+t+".txt",()=>{this.loadPartRes(e)})}loadPartRes(t){for(var e=0;e<t.dataAry.length;e++){var i=t.dataAry[e];i.types==se.SCENE_PARTICLE_TYPE||i.types==se.PREFAB_TYPE&&(this.setObjUrl(i.objUrl),this.setMaterialUrl(i.materialUrl,i.materialInfoArr))}}resize(){this.uiViewMatrix.identity(),this.uiViewMatrix.perspectiveFieldOfViewLH(1,1,500,5e3),this.uiViewMatrix.appendScale(1e3/D.stageWidth,1e3/D.stageHeight,1)}setCam(){D.context3D.setVcMatrix4fv(this.material.shader,"viewMatrix3D",this.uiViewMatrix.m),D.context3D.setVcMatrix4fv(this.material.shader,"camMatrix3D",this.uiMatrix.m)}update(){D.context3D.setWriteDepth(!0),D.context3D.setDepthTest(!0),super.update(),D.context3D.setWriteDepth(!1),D.context3D.setDepthTest(!1)}},t.Display3dModelAnimParticle=Ut,t.Display3dMovie=oi,t.Display3dShadow=ii,t.DynamicBaseConstItem=O,t.DynamicBaseTexItem=W,t.DynamicConstItem=ct,t.DynamicTexItem=lt,t.Engine=I,t.EventDispatcher=N,t.FpsStage=Ki,t.GC=R,t.Groundposition=Ge,t.GroupDataManager=hi,t.GroupRes=ri,t.IndexBuffer3D=a,t.KeyFrame=mt,t.KeyboardType=ta,t.LQuaternion=l,t.LayaInsideSprite=Pi,t.LayaOverride2dEngine=Vi,t.LayaOverride2dParticleManager=_i,t.LayaOverride2dSceneManager=Ti,t.LayaOverride2dSkillManager=wi,t.LayaOverrideGroupDataManager=Mi,t.LayaScene2dInit=Ni,t.LightProbeManager=Ye,t.LightVo=Fi,t.LineDisplayShader=Ve,t.LineDisplaySprite=Ne,t.LoadManager=X,t.Material=it,t.MaterialAnimShader=C,t.MaterialBaseParam=J,t.MaterialBatchAnimShader=class extends B{constructor(){super(),this.name="Material_Batch_Anim_Shader"}binLocation(t){t.bindAttribLocation(this.program,0,"pos"),t.bindAttribLocation(this.program,1,"v2Uv"),t.bindAttribLocation(this.program,2,"boneID"),t.bindAttribLocation(this.program,3,"boneWeight");var e=this.paramAry[0],i=this.paramAry[1],a=this.paramAry[4],s=this.paramAry[5];e?(t.bindAttribLocation(this.program,4,"normal"),i&&(t.bindAttribLocation(this.program,5,"tangent"),t.bindAttribLocation(this.program,6,"bitangent"))):(a||s)&&t.bindAttribLocation(this.program,4,"normal")}getVertexShaderString(){var t=this.paramAry[0],e=this.paramAry[1],i=(this.paramAry[2],this.paramAry[3],this.paramAry[4]),a=this.paramAry[5],s=this.paramAry[6],r="precision mediump float;\nattribute vec4 pos;\nattribute vec3 v2Uv;\nattribute vec4 boneID;\nattribute vec4 boneWeight;\nvarying vec2 v0;\nuniform mat4 bone[19];\nuniform mat4 viewMatrix3D;\nuniform mat4 camMatrix3D;\nuniform mat4 posMatrixAry[6];\n";return i?r+="varying vec3 v2;\n":a?r+="uniform vec3 sunDirect;\nuniform vec3 sunColor;\nuniform vec3 ambientColor;\nvarying vec3 v2;\n":s||(r+="varying vec2 v2;\n"),t?(r+="attribute vec4 normal;\nuniform mat4 rotationMatrix3D;\nvarying vec3 v1;\n",r+=e?"varying mat3 v4;\n":"varying vec3 v4;\n",e&&(r+="attribute vec4 tangent;\nattribute vec4 bitangent;\n")):(i||a)&&(r+="attribute vec4 normal;\nuniform mat4 rotationMatrix3D;\n"),r+="void main(void){\nv0 = vec2(v2Uv.xy);\nvec4 vt0 = bone[int(boneID.x)] * pos * boneWeight.x;\nvt0 += bone[int(boneID.y)] * pos * boneWeight.y;\nvt0 += bone[int(boneID.z)] * pos * boneWeight.z;\nvt0 += bone[int(boneID.w)] * pos * boneWeight.w;\nvt0 = posMatrixAry[int(v2Uv.z)] * vt0;\n",t&&(r+="v1 = vec3(vt0.x,vt0.y,vt0.z);\n"),r+="vt0 = camMatrix3D * vt0;\nvt0 = viewMatrix3D * vt0;\ngl_Position = vt0;\n",t?r+=e?"vec4 vt2 = bone[int(boneID.x)] * tangent * boneWeight.x;\nvt2 += bone[int(boneID.y)] * tangent * boneWeight.y;\nvt2 += bone[int(boneID.z)] * tangent * boneWeight.z;\nvt2 += bone[int(boneID.w)] * tangent * boneWeight.w;\nvt2 = rotationMatrix3D * vt2;\nvt2.xyz = normalize(vt2.xyz);\nvec4 vt1 = bone[int(boneID.x)] * bitangent * boneWeight.x;\nvt1 += bone[int(boneID.y)] * bitangent * boneWeight.y;\nvt1 += bone[int(boneID.z)] * bitangent * boneWeight.z;\nvt1 += bone[int(boneID.w)] * bitangent * boneWeight.w;\nvt1 = rotationMatrix3D * vt1;\nvt1.xyz = normalize(vt1.xyz);\nvt0 = bone[int(boneID.x)] * normal * boneWeight.x;\nvt0 += bone[int(boneID.y)] * normal * boneWeight.y;\nvt0 += bone[int(boneID.z)] * normal * boneWeight.z;\nvt0 += bone[int(boneID.w)] * normal * boneWeight.w;\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\nv4 = mat3(vec3(vt2.x,vt2.y,vt2.z),vec3(vt1.x,vt1.y,vt1.z),vec3(vt0.x,vt0.y,vt0.z));\n":"vt0 = bone[int(boneID.x)] * normal * boneWeight.x;\nvt0 += bone[int(boneID.y)] * normal * boneWeight.y;\nvt0 += bone[int(boneID.z)] * normal * boneWeight.z;\nvt0 += bone[int(boneID.w)] * normal * boneWeight.w;\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\nv4 = vec3(vt0.x,vt0.y,vt0.z);\n":(i||a)&&(r+="vt0 = bone[int(boneID.x)] * normal * boneWeight.x;\nvt0 += bone[int(boneID.y)] * normal * boneWeight.y;\nvt0 += bone[int(boneID.z)] * normal * boneWeight.z;\nvt0 += bone[int(boneID.w)] * normal * boneWeight.w;\nvt0 = rotationMatrix3D * vt0;\nvt0.xyz = normalize(vt0.xyz);\n"),i?r+="vec3 lpb = normalize(vec3(1.0,1.0,-1.0));\nfloat lp = min(0.0,dot(lpb,vec3(vt0.xyz)));\nlp = lp * 2.0 + 0.7;\nv2 = vec3(lp,lp,lp);\n":a?r+="float suncos = dot(vt0.xyz,sunDirect.xyz);\nsuncos = clamp(suncos,0.0,1.0);\nv2 = sunColor * suncos + ambientColor;":s||(r+="v2 = v2Uv;\n"),r+="}"}getFragmentShaderString(){return"uniform sampler2D s_texture1;\nuniform vec4 testconst;varying vec2 v_texCoord;\nvoid main(void)\n{\nvec4 infoUv = texture2D(s_texture, v_texCoord.xy);\ninfoUv.xyz = testconst.xyz * infoUv.xyz;\ngl_FragColor = infoUv;\n}"}},t.MaterialManager=st,t.MaterialParam=dt,t.MaterialShader=oe,t.MathClass=Ee,t.MathUtil=je,t.MathUtils3D=s,t.Matrix3D=V,t.Matrix3x3=o,t.Matrix4x4=c,t.MeshData=Kt,t.MeshDataManager=fe,t.ModelRes=Hi,t.ModelSceneChar=ea,t.ModuleEventManager=ki,t.MountChar=ji,t.ObjData=$,t.ObjDataManager=he,t.Object3D=k,t.Override2dEngine=Ei,t.OverrideEngine=zi,t.OverrideSceneManager=gi,t.OverrideSkill=bi,t.OverrideSkillFixEffect=fi,t.OverrideSkillTrajectory=Di,t.Pan3dByteArray=A,t.ParticleBallData=Rt,t.ParticleBallGpuData=It,t.ParticleBoneData=ee,t.ParticleData=bt,t.ParticleFacetData=Mt,t.ParticleFollowData=Wt,t.ParticleFollowLocusData=Zt,t.ParticleGpuData=Pt,t.ParticleLocusData=Ct,t.ParticleLocusballData=zt,t.ParticleManager=ae,t.ParticleModelData=Vt,t.PathManager=Je,t.PlanarShadowShader=F,t.Processor=Ui,t.ProgramManager=at,t.QuadTreeNode=Ce,t.Quaternion=E,t.Rectangle=de,t.ResCount=L,t.ResGC=j,t.ResManager=Be,t.RoleRes=De,t.RoleResLow=class extends De{},t.ScaleAnim=_t,t.ScaleChange=gt,t.ScaleNoise=ft,t.SceneBaseChar=Wi,t.SceneChar=Xi,t.SceneManager=He,t.SceneQuadTree=ke,t.SceneRes=Re,t.Scene_data=D,t.SelfRotation=yt,t.Shader3D=B,t.ShaderData=m,t.ShaderDefine=class{constructor(t,e){this._index=t,this._value=e}},t.Shadow=ai,t.ShadowManager=si,t.ShadowModel=sa,t.Skill=pi,t.SkillData=yi,t.SkillEffect=li,t.SkillFixEffect=di,t.SkillKey=$e,t.SkillKeyVo=be,t.SkillManager=xi,t.SkillMulPath=class extends qe{constructor(){super(...arguments),this.lastTime=0}setInitCurrentPos(t){this.currentPosAry=t,this.allTimeList=new Array;for(var e=0;e<t.length;e++)this.allTimeList.push(0)}add(){this.skillTrajectory.setCurrentPos(),this.directAry=new Array;for(var t=0,e=0;e<this.currentPosAry.length;e++){var i=new b;i.x=this.currentTargetPos.x-this.currentPosAry[e].x,i.y=this.currentTargetPos.y-this.currentPosAry[e].y,i.z=this.currentTargetPos.z-this.currentPosAry[e].z;var a=i.length;a>t&&(t=a,this.maxV3d=this.currentPosAry[e]),this.allTimeList[e]=a/this.speed,i.normalize(),i.scaleBy(this.speed),this.directAry.push(i)}this.alltime=t/this.speed,this.setAllData()}setAllData(){var t=M.float2int(this.alltime/33)+8;this.resultAry=new Array;for(var e=0;e<this.currentPosAry.length;e++){var i=new Array;this.resultAry.push(i);for(var a=this.directAry[e],s=0;s<6;s++)i.push([this.currentPosAry[e].x,this.currentPosAry[e].y,this.currentPosAry[e].z]);for(var r=0;r<t;r++){this.lastTime=33*r;var n,h,o=this.lastTime/this.allTimeList[e],l=o;if(o>=1?(l=0,n=[this.currentTargetPos.x,this.currentTargetPos.y,this.currentTargetPos.z]):(l-=l*l,l*=250,n=[a.x*this.lastTime+this.currentPosAry[e].x,a.y*this.lastTime+l+this.currentPosAry[e].y,a.z*this.lastTime+this.currentPosAry[e].z]),0==r)h=[0,1,0];else{var c=i[2*r-2];h=[n[0]-c[0],n[1]-c[1],n[2]-c[2]];var d=Math.sqrt(h[0]*h[0]+h[1]*h[1]+h[2]*h[2]);h[0]/=d,h[1]/=d,h[2]/=d}i.push(n,h)}}}update(t){if(this.time=t,this.lastTime+=t,this.hasReached)return this.endTime+=t,void(this.endTime>200&&this.applyArrive());this.skillTrajectory.setCurrentPos();for(var e=0;e<this.currentPosAry.length;e++){var i=this.lastTime/this.allTimeList[e];i-=i*i,i*=250;var a=this.currentPosAry[e];if(this._currentDirect.x=this.currentTargetPos.x-a.x,this._currentDirect.y=this.currentTargetPos.y-a.y,this._currentDirect.z=this.currentTargetPos.z-a.z,this._currentDirect.normalize(),this._currentDirect.scaleBy(this.speed),this.maxV3d==a&&(this.setRotationMatrix(this.currentTargetPos.subtract(a)),0==this._currentDirect.length))return void this.arrive();var s=this._currentDirect.length*this.time;if(!this.hasReached){var r=b.distance(a,this.currentTargetPos);a.x+=this._currentDirect.x*this.time,a.y+=this._currentDirect.y*this.time,a.z+=this._currentDirect.z*this.time,a.w=i}this.maxV3d==a&&s>r&&this.arrive()}this.currentPos.setTo(this.currentPosAry[0].x,this.currentPosAry[0].y+this.currentPosAry[0].w,this.currentPosAry[0].z)}setData(t,e,i,a,s){super.setData(t,e,i,a,s,null),this.skillMul=t}applyData(t){for(var e=0;e<t.length;e++)t[e].setTo(this.currentPosAry[e].x,this.currentPosAry[e].y+this.currentPosAry[e].w,this.currentPosAry[e].z)}reset(){super.reset(),this.lastTime=0}},t.SkillMulTrajectory=ui,t.SkillPath=qe,t.SkillRes=Pe,t.SkillSceneChar=ia,t.SkillSinPath=Ke,t.SkillTrajectory=ti,t.SkillVo=Te,t.SkinMesh=ge,t.SkyShader=Ji,t.SoundManager=mi,t.TerrainDisplay3DShader=ue,t.TerrainDisplay3DSprite=pe,t.TestTriangle=Gi,t.TexItem=tt,t.TextAlign=$i,t.TextureCube=class{},t.TextureManager=K,t.TextureRes=q,t.TimeLine=Dt,t.TimeLineData=ut,t.TimeUtil=T,t.UIManager=H,t.UnitFunction=Ie,t.Util=M,t.Vector2=r,t.Vector2D=_,t.Vector3=h,t.Vector3D=b,t.Vector4=n,t.VertexBuffer3D=p,t.VertexDeclaration=x,t.VertexElement=v,t.VertexElementFormat=y,t.VertexMesh=g,t.ViewFrustum=Ue,t.mainpan3d=Ii}(this.tl3d=this.tl3d||{});